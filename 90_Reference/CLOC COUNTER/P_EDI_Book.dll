USE [mediastore_MSDB06]
GO
/****** Object:  StoredProcedure [dbo].[P_EDI_Book]    Script Date: 2020/05/22 11:41:27 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


--=================================================
-- WEBPOS for BOOKSTORE EnterPrise EDI-System
-- Client SP  forいまじん
---------------------------------------------------
--  処理概要
--    EDI-Systemのテーブルからデータを読み込み
--    各業務処理をする。
--    EDI-Systemはリンクサーバ名、データベース名を
--    wpt_system_masterに設定する。
--    設定したリンクサーバの設定が予め必要。
--
--    本番用	サーバ名：imed01　DB名：bookedi
--    テスト用	サーバ名：imed01　DB名：bookedi_test
--
--    上り：本ＳＰでデーベースからデータ抜き出し
--           →EDI-Systemテーブル
--           →コンバート処理→データ転送
--    下り：データ転送→コンバート処理
--           →EDI-Systemテーブル
--           →本ＳＰでデーベースへの反映処理
---------------------------------------------------
--  WEBPOS設定
--     EDI設定：wpt_book_edi_setting
--     サーバ設定：wpt_system_master
---------------------------------------------------
--  入力  --
--     @edi_type ： 処理タイプ
--                 -> EDIデータ区分＋処理フラグ(U:上り,D:下り)
--          '11U' ： 上り返品処理
--          '12U' ： 上り発注処理
--          '13U' ： 上り定期改正処理
--          '14U' ： 上り売上処理(ヘッダ) 2011/10/27
--          '15U' ： 上り売上処理(明細)
--          '16U' ： 上り在庫変動処理
--          '17U' ： 上り移動処理
--          '18U' ： 上り全在庫処理
--          '47U' ： 上り発注処理(1日複数回送信) 2017/04/13
--          '50U' ： 上りポイント変動処理
--          '51U' ： 上り取引明細処理(トップカルチャー本部連動)
--          '52U' ： 上り取引合計処理(トップカルチャー本部連動)
--          '53U' ： 上り日計情報処理(トップカルチャー本部連動)
--          '54U' ： 上り部門別売上処理(トップカルチャー本部連動)
--          '55U' ： 上りクレジット別売上処理(トップカルチャー本部連動)
--          '60U' ： 上り未登録商品マスタ(エコール)
--          '61U' ： 上り売上データ(エコール)
--          '20D' ： 下り銘柄処理（マスタ処理）
--          '21D' ： 下り返品処理（在庫変動処理）
--          '22D' ： 下り送品処理（マスタ処理＋検品処理）
--          '23D' ： 下り売上処理（売上ＳＰシミュレート）
--          '24D' ： 下り請求処理
--          '25D' ： 下り廃盤処理（マスタ処理）
--          '26D' ： 下りメーカレーベル処理（マスタ処理）
--          '27D' ： 下りジャンル処理（マスタ処理）
--          '28D' ： 下り品種処理（マスタ処理）
--          '29D' ： 下り大分類処理（マスタ処理）
--          '30D' ： 下り中分類処理（マスタ処理）
--          '31D' ： 下り小分類処理（マスタ処理）
--          '32D' ： 下り価格変更処理(ヘッダ、明細)
--          '34D' ： 下り注文書処理(ヘッダ、明細)
--          '36D' ： 下り文具マスタ処理(マスタ)
--          '37D' ： 下りメーカーＪＡＮ移行処理(マスタ処理)
--          '38D' ： 下り基準曲処理(マスタ処理)
--          '39D' ： 下りタイトルデータ(JMD)(マスタ処理）) 
--          '40D' ： 下り商品マスタ(エコール)
--          '41D' ： 下りブランドマスタのクライアント処理
--          '42D' ： 下りメーカーマスタのクライアント処理
--          '43D' ： 下り分類マスタのクライント処理
--          '44D' ： 下り発注データクライアント処理
--          '45D' ： 下り価格改定マスタのクライアント処理
--          '47D' ： 有隣堂 BQからのEDIサーバー取込および発注データコンバート処理
--     @date  ： 処理対象日時
--                 -> 上りのみ指定。
--                      指定日の前日00:00から24時間のデータが対象（デフォルト）
--     @ext_day ： 抽出対象日
--                 -> 対応処理対象日時からの相対日（デフォルト：-1（前日））
--     @ext_time ： 抽出対象開始時間
--                 -> デフォルト：00:00:00
--     @ext_dd ： 抽出対象期間
--                 -> デフォルト：1日
--     @TAIYO  ： 太洋社専用フラグ
--                 -> デフォルト：OFF
--          '0'：OFF  '1'：ON
--     @rv        ： リカバリオプションフラグ
--                 -> デフォルト：OFF
--          '0'：OFF  '1'：ON（リカバリ時は手動で追加）
--  出力  --
--     なし
--  戻り  --
--     @rc ： リターン
---------------------------------------------------
-- Ver 01-00 2005/09/01
--                forいまじん
-- Ver 01-01 2005/09/07
--                基準点更新があった場合メディア更新はしないように修正。
-- Ver 01-02 2005/10/11
--                旧雑誌対応
-- Ver 01-03 2005/10/25
--                上り対象時間を作成時間基準に変更。
-- Ver 02-00 2005/11/21
--                上り一括処理にロジック変更。
-- Ver 02-01 2005/12/12
--                送品データで正味率がない場合、原価金額をセット
--                するように修正。
-- Ver 02-02 2005/12/26
--                送品伝票日が発売日より前だった場合、その日付をマスタ発売日と
--                するように修正
-- Ver 02-03 2005/01/05
--                上り収集時間を２日前に変更
-- Ver 02-04 2006/01/06
--                 分かちなしかなフィールドをセットするように修正。
-- Ver 02-05 2006/01/16
--                 送品原価算出時、四捨五入丸めで算出するように修正。
-- Ver 02-06 2006/01/16
--                 上り処理で赤伝済みの黒伝を対象にしていた不具合を修正。
-- Ver 02-07 2006/03/23
--                 上り返品で、２段JANコードが13桁以外の場合、マスタのCコードを
--                 セットするように修正。
-- Ver 02-08 2006/05/09
--                 下り処理で商品名が切られてしまうことがある不具合を修正。
-- Ver 02-09 2006/05/29
--                 大洋社セット商品を不正に他商品に置き換えるバグ修正。
--                 大洋社セット親商品をマスタ処理対象外にするように修正。
--                 取次ぎ専用コードの送品データの商品コードは、取次ぎコード_
--                 をつけるように修正。
-- Ver 02-10 2006/07/27
--                 下り返品対応。
-- Ver 02-11 2006/08/08
--                 下り返品で雑誌データが不正となる場合がある不具合修正。
-- Ver 02-12 2006/08/18
--                 下り返品で雑誌年が４桁または１桁できた場合も対応するように修正。
-- Ver 02-13 2006/09/06
--                 上り発注で、博文社補充の場合、管理コード1に
--                 レシート番号をセット。
-- Ver 03-00 2006/10/17
--                 トーハン対応。
-- Ver 03-01 2006/10/20
--                 下り返品時、返品種別を強制１桁にするように修正。
-- Ver 03-02 2006/10/23
--                 下り返品時、下り送品時、マスタが存在して、Ｃコードがｎｕｌｌの場合、
--                 商品マスタ更新処理をしないように修正。
--                 下り返品時、トーハンの場合、返品種別'0'は取引処理（在庫変動処理）
--                  をすねように修正。
-- Ver 03-03 2006/10/25
--                 下り処理の順番で、下り返品⇒下り送品を、下り送品⇒下り返品時に修正。
--                 （送品を先に処理し、なるべく早く仕入検収処理を行いたいという要望の為）
-- Ver 03-04 2006/11/27
--                 下り送品時、送品数サインを見ていなかった不具合修正。
-- Ver 03-05 2006/12/07
--                 マスタが事前にあって、Cコードがnullの場合、および雑誌の場合、商品マスタ
--                 の検索が飛ばされていた不具合修正。
-- Ver 03-06 2007/01/17
--                 送品時、マスタが既に存在している場合、自動発注フラグは更新しないように修正。
-- Ver 03-07 2007/01/18
--                 自動発注フラグを更新してしまう不具合を修正。
-- Ver 03-08 2007/02/25
--                 返品時、メディアＩＤの更新で、NULLを更新する場合は、更新しないように修正。
-- Ver 03-09 2007/03/22
--                 太洋社下り返品対応。
-- Ver 03-10 2007/06/21
--                 マスタ処理更新時は自動発注フラグを更新しないように修正。
-- Ver 03-11 2007/06/30
--                 マスタ処理でmedia_idがnullだった場合無条件に更新するように修正。
-- Ver 03-12 2007/07/17
--                 書籍常備発注販売対応。
-- Ver 03-13 2007/08/09
--                 巻名と商品名の最後が同一だったら巻名を足さないように修正。
-- Ver 03-14 2007/10/15
--                 正味率の小数点以下の利率もきちんと計算するように修正。
--                 上り収集終了時間を1分前とする。
--                 上りリカバリ用オプション追加。リカバリ時は上り収集終了時間を開始の１日後とする。
-- Ver 03-15 2007/11/26
--                 発売日のセットは必ず時間を00:00:00にするように修正。
--                 常備マスタ収集で、長期は対象外とするように修正。
-- Ver 03-16 2007/11/29
--                 下り返品処理で最終原価をセットするように修正。
-- Ver 03-17 2007/12/11
--                自動書籍販売発注制御対応
-- Ver 03-18 2008/01/09
--                上り売り上げでグロス商品の場合コードがnullになってた不具合を修正。
-- Ver 03-19 2008/01/11
--                下りカーソルをすべてstaticに変更。
--                上り売り上げでグロス、店舗独自商品を収集しないように修正。
--                下り仕入、返品でライン番号採取が不正だったのを修正。
-- Ver 03-20 2008/01/23
--                ログ追加
-- Ver 03-21 2008/01/24
--                栗田管理対象外コード追加
-- Ver 03-22 2008/01/25
--                行番号採番をダーティリードに変更
-- Ver 03-23 2008/02/01
--                マスタ処理自取次ぎコードをセットするように修正。
-- Ver 03-24 2008/02/19
--                下り処理にedi_idを追加
-- Ver 04-00 2008/02/25
--                定期購読管理対応。
-- Ver 04-01 2008/04/25
--                マスタ処理で雑誌の場合発売日が入っていたら更新しない。
-- Ver 04-02 2008/04/30
--                取引コードがnullの場合更新しないように修正。
-- Ver 04-03 2008/05/02
--                定期予約をするマスタを2週間前までに変更。
-- Ver 04-05 2008/05/28
--                マスタ処理で初回入荷日のセットを0送品で作られたマスタの場合除外する。
-- Ver 04-06 2008/06/02
--                返品処理で基準店更新があったものもメディアを変更していたバグ修正。
-- Ver 04-07 2008/06/25
--                上り発注返品ログ追加。
--                上り集計期間デフォルトを5日前に変更。
-- Ver 04-08 2008/07/04
--                下り送品、返品ではメディアコードを変えないように修正。（サーバ間同期のため）
-- Ver 04-09 2008/07/07
--                定期予約ログを正常登録と異常だけにする。
-- [MEDIASTORE対応]
-- Ver 05-00 2008/11/18
--                WINT,JDR,NRC対応。
-- Ver 05-01 2008/12/08
--                送品マスタ更新時、書籍Cコードがnullだったら更新しないように修正。
-- Ver 05-02 2008/12/16 M.Nakano
--                上り発注が書籍発注(work_type=0202, edi_type=2)のみだったので、DISK発注(work_type=0201, edi_type=3)も対象となるよう修正。
-- Ver 05-03 2009/01/21 M.Nakano
--                下り送品処理でマスタを生成・更新するロジックを変更
--                ※下り銘柄処理も行なう取引先のみ共通商品マスタを更新し、それ以外は店舗別商品マスタを生成するようにした(CD系のみ)。
--                下り送品処理の業務区分をDISK仕入0120と書籍仕入0121に対応
-- Ver 05-04 2009/01/27 M.Nakano
--                下り送品処理で店舗独自マスタを作らないように修正
-- Ver 05-05 2009/02/23
--                下り廃盤対応。
-- Ver 06-00 2009/02/25
--                TMW対応。
-- Ver 06-01 2009/02/27 M.Nakano
--                下り銘柄処理で業務区分決定ロジックの位置がまずかったので修正。
-- Ver 06-02 2009/03/04 M.Nakano
--                cd_genre_cd,cd_hinshu_cdをvarchar(10)に変更。
-- Ver 06-03 2009/03/06 M.Nakano
--                16Uの処理で作成するクエリを修正 tdu_goods_id→t_goods_id
-- Ver 06-04 2009/03/09 M.Nakano
--                16Uの処理で作成するクエリを修正
--                  wpt_edibook_up_urd→wpt_edibook_up_zhd
--                  tg_edi_shop_cd_webpos→t_edi_shop_cd_webpos
--                  tg_edi_shop_name_webpos→t_edi_shop_name_webpos
--                  tg_edi_shop_cd→t_edi_shop_cd
--                  tg_edi_tushin_id→t_edi_tushin_id
--                  tg_trn_date→t_trn_date
-- Ver 06-05 2009/03/10 M.Nakano
--                下りレーベル処理で販売会社名をセットするよう修正
--                また、名称だけが更新されるように修正
-- Ver 06-06 2009/03/12 M.Nakano
--                上り売上処理で抜くデータを書籍・雑誌に限定していたので、EDI区分により書籍系、DISK系をわけるようにした
-- Ver 06-07 2009/03/12 T.Motegi
--                上り在庫処理で、day_totalのjoinをleft outer へ変更。
-- Ver 06-08 2009/03/12 M.Nakano
--                上り在庫処理で抜くデータを、EDI区分により書籍系、DISK系をわけるようにした
-- Ver 06-09 2009/03/23 M.Nakano
--                下り銘柄処理で、CD系だったら、分類IDを更新するよう修正
--                ※cd_genre_cdとcd_hinshu_cdが更新されるケースがあるため(=分類が変更になる)
--                分類の判定をTMW方式に統一
-- Ver 07-01 2009/05/07 M.Nakano
--                ゲームEDI対応
--                下り大分類マスタ、下り中分類マスタ、下り小分類マスタの処理を追加
--                下り銘柄処理を修正
--                下り価格変更処理(ヘッダ、明細)を追加
--                下りメーカーレーベルマスタ処理を修正
--                上り発注処理のゲーム発注対応
--                上り発注処理を修正(イニシャル発注対応)
--                下り注文書処理(ヘッダ、明細)を追加
--                下り銘柄、下り送品、下り返品を以下のようにした
--                 ・取次のEDI区分(maker_supplier_master > mpm_edi_type)を取得
--                 ・商品マスタが既に存在する場合は、以下のようにする。
--                   EDI区分が2(書籍EDI)の場合
--                    →元の商材区分が00,20,21の場合のみ、
--                      商材区分、分類IDを更新する。それ以外はしない。
--                   EDI区分が3(ディスクEDI)の場合
--                    →元の商材区分が00,30,31の場合のみ、
--                      商材区分、分類IDを更新する。それ以外はしない。
--                   EDI区分が4(ゲームEDI)の場合
--                    →元の商材区分が00,40の場合のみ、
--                      商材区分、分類IDを更新する。それ以外はしない。
-- Ver 07-02 2009/07/01 M.Nakano
--                上り全在庫処理(18U)を追加
-- Ver 07-03 2009/09/03 M.Nakano
--                下り価格変更処理のエラー処理を追加
-- Ver 07-04 2009/09/17 M.Nakano
--                下り銘柄処理で、書籍の場合は出版社マスタを生成するようにした。
-- Ver 07-05 2009/12/09 M.Nakano
--                下り銘柄処理で、ゲームの場合はすでにマスタに存在するJANのデータは、JANコードNULLでマスタを生成するよう修正。
-- Ver 07-06 2010/02/03 M.Nakano
--                下り銘柄処理で、CD/DVDの場合はJAN訂正データに対応
--                ※通常マスタ検索(JAN)でマスタがヒットしない
--                   →CD/DVD(type=5)で、かつ、規格番号(e20_cd_kikaku_bango)がセットされていれば、
--                     規格番号でマスタを検索
--                   →マスタがヒットする
--                   →パラメータのJANを訂正後JANとみなす
--                   →既存マスタのJANを訂正元JANとみなす(パラメータのJANと置き換える)
-- Ver 07-07 2010/02/05 M.Nakano
--                Ver.07-06対応で、ゲームマスタのJANが不正に更新されてしまう不具合を修正
-- Ver 07-08 2010/02/24 M.Nakano
--                下り送品処理にメインロケーション設定処理(P_Transaction(_Location))を追加
-- Ver 07-09 2010/03/19 M.Nakano
--                P_PLU戻り値を取得していなかった箇所を修正
-- Ver 07-10 2010/03/26 M.Nakano
--                下り送品処理にメインロケーション設定処理を修正
-- Ver 07-11 2010/04/27 T.Yamakawa
--                上り売上処理のトーハンe-hon対応
--                  →新フォーマット「15C」追加（e-hon会員カード番号追加、フォーマット区分）
-- Ver 07-12 2010/05/28 T.Yamakawa R.Miyoshi
--                TMW上り売上データ明林堂対応
-- Ver 07-13 2010/08/31 R.Miyoshi
--                雑誌銘柄処理にて
--                出版社名がNULL及び空の場合、取引先コードより出版社名をセットするように修正した。
--                出版社コードも同様に対応した。
-- Ver 07-14 2010/09/6 R.Miyoshi
--                上り返品にて本来価格が税込みだった不具合に対応。
-- Ver 07-15 2010/09/24 R.Miyoshi
--                下り返品にて在庫マスタが存在しない場合に税抜きの売価がセットされる不具合を修正した。
-- Ver 07-16 2010/10/08 R.Miyoshi
--                光和EDI対応
-- Ver 07-17 2011/04/12 M.Nakano
--                server_name + '.' + db_name ⇒ '[' + server_name + '].[' + db_name + ']'
-- Ver 07-18 2011/04/27 M.Nakano
--                くまPOS上り売上データの商品コードをtdu_から持ってくるよう修正
-- Ver 07-19 2011/06/01 T.Yamakawa
--                上り発注にて、店舗独自商品の場合に商品コードがセットされない不具合を修正した。
-- Ver 07-20 2011/06/02 T.Yamakawa
--                上り返品にて、店舗独自商品の場合に商品コードがセットされない不具合を修正した。
-- Ver 07-21 2011/07/15 M.Nakano
--                商品マスタ更新時、既存Cコードが0000以外で更新データが0000の場合、更新データを既存データに挿げ替えるようにした。
--                (大阪屋でCコード0000で分類が更新されてしまう件の対応)
-- Ver 08-01 2011/10/27 M.Nakano
-- ・UP_URIAGEにe15_point_add,e15_point_add_signを追加
-- ・UP_URIAGE_HEADER(U14)の処理を追加
-- Ver 08-02 2011/11/02 M.Nakano
-- ・UP_URIAGE_HEADERにe14_uriage_count,e14_uriage_count_signを追加
-- Ver 08-03 2011/11/10 M.Nakano
-- ・UP_POINT追加
-- Ver 08-04 2012/02/10 M.Nakano
-- ・e11_shori_no1,e11_shori_no2 に tso_shori_no1,tso_shori_no2 をセット
-- ・e11_konpo_no に tso_ext_no をセット
-- Ver 08-05 2012/03/07 M.Nakano
-- ・下り送品処理で発売日を更新しないよう修正
-- Ver 08-06 2012/03/28 M.Nakano
-- ・下り返品処理でtod_priceに売価(税込価格)がセットされるよう修正
-- Ver 08-07 2012/05/02 T.Yamakawa
-- ・上り売上処理(UP_URIAGE)でCコードのセットロジックを修正
--   　書籍の場合、2段JANがあればそこのCコード優先
--   　書籍の場合、2段JANがなければ、商品マスタ書誌のCコード優先
--   　なければ、'0000'固定
-- Ver 08-08 2012/05/15 T.Yamakawa
-- ・上り返品処理(UP_HENPIN)で書籍/雑誌の場合に価格はtod_price_defaultをセットするよう修正
-- Ver 08-09 2012/05/15 T.Yamakawa
-- ・下り送品処理(DOWN_SOUIHIN)でディストリビューションコードを追加
-- Ver 08-10 2012/06/07 T.Yamakawa
-- ・下り返品処理(DOWN_HENPIN)　トーハンは入帳区分に関係なく、取引データを作成（在庫変動）させる
-- Ver 08-11 2012/07/10 T.Sudoh
-- ・下り送品処理(DOWN_SOUHIN)に西村書店用の処理を追加。
-- ・インストアコードチェックで西村書店を除外
-- Ver 08-12 2012/07/22 T.Sudoh
-- ・コードチェックで明文図書を除外
-- ・下り送品処理(DOWN_SOUHIN)に明文図書用の処理を追加。
-- ・インストアコードチェックで明文図書を除外
-- Ver 08-13 2012/08/10 T.Sudoh
-- ・下り送品処理(DOWN_SOUHIN)に八木書店用の処理を追加。
-- ・インストアコードチェックで八木書店を除外
-- Ver 08-14 2012/08/27 T.Yamakawa
-- ・上り売上処理(UP_URIAGE)、上り発注処理(UP_HACHU)で、星光堂[SK]の場合のみ親店舗コードにトーハングループCDをセットするよう修正
-- ・下り銘柄処理(DOWN_MEIGARA)で、星光堂[SK]の場合とそれ以外の場合で判定元の項目が異なるので対応
-- Ver 09-01 2012/09/03 T.Yamakawa
-- 【トップカルチャー本部連動対応】
--  ＜上り＞
--		・上り取引明細(UP_MEISAI_URIAGE_TPC)[51U]
--		・上り取引合計(UP_TOTAL_URIAGE_TPC)[52U]
--		・上り日計情報(UP_NIKKEI_URIAGE_TPC)[53U]
--		・上り部門別売上(UP_BUMON_URIAGE_TPC)[54U]
--		・上りクレジット別売上(UP_CREDIT_URIAGE_TPC)[55U]
--  ＜下り＞
--		・下り文具価格マスタ(DOWN_BUNGUKAKAKU_TPC)[36D]
-- Ver 09-02 2012/09/14 T.Yamakawa
-- ・下り返品処理(DOWN_HENPIN)で、取引データの対象業務ＩＤに業務データのＩＤをセットするように修正
-- Ver 09-03 2012/09/20 T.Yamakawa
-- ・下り銘柄処理(DOWN_MEIGARA)にTMWMSP用の処理を追加。
-- ・下り送品処理(DOWN_SOUHIN)にTMWMSP用の処理を追加。
-- ・インストアコードチェックでTMWMSP[TP]を除外
-- ・TMWMSP（通信ID＝TP）で、文具（商品コード区分＝4）の場合、DISK用の分類変換ロジックで判定
-- Ver 09-04 2012/10/26 T.Yamakawa
-- ・トップカルチャー取引明細、取引合計　レシート番号8桁対応
--		・上り取引明細(UP_MEISAI_URIAGE_TPC)[51U]
--		・上り取引合計(UP_TOTAL_URIAGE_TPC)[52U]
-- Ver 09-05 2012/10/30 T.Yamakawa
-- ・トップカルチャー取引明細　売上金額、税区分、単価、本体価格　仕様変更
--		・上り取引明細(UP_MEISAI_URIAGE_TPC)[51U]
-- Ver 09-06 2012/11/13 T.Yamakawa
-- ・下り送品処理(DOWN_SOUHIN)　パラメータ３個数エラー不具合対応
-- Ver 09-07 2012/12/14 T.Yamakawa
-- ・下り送品処理(DOWN_SOUHIN)　正味率を追加
-- Ver 09-08 2012/12/27 T.Yamakawa
-- 【星光堂対応】
--  ＜下り＞
--		・下りメーカーＪＡＮ移行データ(DOWN_MAKER_JAN_IKO)[37D]
--		・下り基準曲データ(DOWN_KIJUN_KYOKU)[38D]
-- Ver 09-09 2013/03/25 Long-DD
-- ・共栄図書に対してgood_codesの変換処理を追加する。
-- Ver 09-10 2013/06/07 T.Yamakawa
-- ・下り送品処理(DOWN_SOUHIN)、仕入先「JDS、NRC」の場合のみ、明細追加の条件を変更（現行の伝票番号＋伝票日に、ディストリビューションコードを追加）
-- Ver 09-11 2013/07/04 E.Satoh
-- ・中央社、売上データ 税込→本体価格 対応
-- Ver 09-12 2013/07/23 T.Yamakawa
-- ・上り定期改正処理(UP_TEIKI)	EDI中間テーブルへのINSERT文の条件に業務区分(0203)を追加。
-- ・上り発注処理(UP_HACHU)		EDI中間テーブルへのINSERT文の条件に業務区分(0201,0202,0204)を追加。
-- Ver 09-13 2013/08/12 T.Yamakawa
-- ・下り銘柄処理(DOWN_MEIGARA)	雑誌の出版社コードがセットされない不具合を修正。     
-- Ver 09-14 2013/08/20 T.Yamakawa
-- ・下り銘柄処理(DOWN_MEIGARA)、下り送品処理(DOWN_SOUHIN)　発売日セットロジック変更【平安堂版】
-- Ver 09-15 2013/08/06 E.Satoh
-- ・上り発注処理(UP_HACHU)     トーハンEDI複数番線対応（明文堂）
-- Ver 09-16 2013/08/12 E.Satoh
-- ・上り発注処理(UP_HACHU)     フロアコード対応
-- Ver 09-17 2013/11/21 T.Yamakawa
-- ・上り在庫変動処理(UP_ZAIKOHENDO_T1)[56U]		トーハンTONETS-V（T1フォーマット）対応
-- ・上り売上処理(UP_URIAGE)[15U]					トーハンTONETS-V（T1フォーマット）対応
-- Ver 09-18 2013/11/25 T.Yamakawa
-- ・ロケーション追加記録処理をコメントアウト
-- ・発売日ロジック修正
-- Ver 09-19 2014/01/08
-- ・下りタイトルデータ( マスタ処理）)
-- Ver 09-20 2014/01/28 T.Yamakawa
-- 【JEUGIA基幹連動】
-- ・上り売上処理(UP_JEUGIA_URIAGE)	[62U]を追加
-- ・上り仕入処理(UP_JEUGIA_SIIRE)	[63U]を追加
-- ・上り移動処理(UP_JEUGIA_IDO)		[64U]を追加
-- ・上り棚卸処理(UP_JEUGIA_TANA)		[65U]を追加
-- Ver 10-01 2013/12/24 
-- ・下り商品マスタ(エコール)
-- Ver 10-02 2014/02/11
-- ・上り売上データ(エコール)
-- Ver 10-02 2014/02/17	T.Yamakawa 
-- ・下り商品／分類マスタ(エコール)
--   MS分類コード／MS分類IDの取得方法を、変換関数(F_Search_Ecole_Media)を利用するように修正
-- Ver 10-03 2014/02/21	M.Tsuruta
-- ・下り商品マスタ(エコール)
--   商品メディアマスタの名称は更新しないように修正
--   商品メディア中分類マスタの名称は更新しないように修正
--   商品メディア中小分類マスタの名称は更新しないように修正
--   商品メディア小分類マスタの名称は更新しないように修正
-- Ver 10-04 2014/02/26 M.Tsuruta
-- ・上り返品にDISK返品の抽出を追加
-- ・上り売上データ（エコール）の中間テーブルの仕入先がセットできない場合は、'0000'をセットするように修正
-- Ver 10-05 2014/02/27	T.Yamakawa 
-- ・下り商品／ブランドマスタ(エコール)の最後に、ブランド名更新処理を追加
-- Ver 10-05 2014/03/17	T.Yamakawa 
-- ・上り売上(TMW)はCD/DVDのみの売上を送信する為、抽出条件「商材区分」を'30'のみに変更
-- Ver 11-01 2014/03/17	Naruki
-- ・上り発注(12U)はエコール処理を追加
-- Ver 10-05 2014/03/31
-- ・下り発注データ(エコール)
-- Ver 10-05 2014/04/14 Masaharu.Tsuruta
-- ・エコール売上データ（上り）   メディア分類からエコール分類コードに変更する処理追加
-- ・エコール未登録マスタ（上り） メディア分類からエコール分類コードに変更する処理追加
-- ・エコール売上データ（上り） e61_ecole_hinban にセットする際、桁数が8桁になるように文字列の先頭にゼロをセット
-- ・エコール発注データ（上り） e12_ecole_hinban にセットする際、桁数が8桁になるように文字列の先頭にゼロをセット
-- ・エコール返品データ（上り） e11_ecole_hinban にセットする際、桁数が8桁になるように文字列の先頭にゼロをセット
-- Ver 10-06 2014/04/15 Masaharu.Tsuruta
-- ・上り返品のDISK返品の条件追加の不具合を修正
-- Ver 10-07 2014/06/11 T.Yamakawa
-- ・上り在庫変動処理(UP_ZAIKOHENDO_T1)[56U]　冊数符号の不具合修正
-- Ver 10-08 2014/07/01	T.Yamakawa 
-- ・下り分類マスタ(エコール)
--   MS分類グループIDは、追加時、もしくは更新時で未セットの場合のみセットするよう修正
-- Ver 10-09 2014/07/03 T.Yamakawa
-- ・上り在庫変動処理(UP_ZAIKO)[16U]　		TONETS在庫変動が設定されている番線は除外する
-- ・上り全在庫変動処理(UP_ZENZAIKO)[18U]		TONETS在庫変動が設定されている番線は除外する
-- Ver 10-10 2014/08/19 T.Yamakawa
-- ・上り売上処理(UP_URIAGE)[15U]　			外商移動店舗へ移動出庫したデータをTONETS売上に含める
-- ・上り在庫変動処理(UP_ZAIKOHENDO_T1)[56U]	外商移動店舗へ移動出庫したデータをTTONETS在庫変動から除外する
--                                             （外商移動店舗の設定は「wpt_tonets_move_shop_setting」に事前に登録しておく）
-- Ver 10-11 2014/06/24 T.Yamakawa
-- ・下り送品処理(DOWN_SOUHIN)[22D]　ソニー対応
-- Ver 10-12 2014/09/09 T.Yamakawa
-- ・下り送品処理(22D)で自動検収処理(P_Auto_Arrival_Book)の呼び出しを追加
-- Ver 10-13 2014/10/31 k.Hotta
-- ・下り送品処理(22D)で標準原価・原価の小数部4桁を有効するように変更（int → money ）
-- ・エコール品番(00009999)且つJANコード（Null）の場合固定JANコード（2099999999998）で処理するように変更
-- 　その際、売価を「0円」に強制的に変更する
-- Ver 10-14 2015/04/06 k.Hotta
-- ・下り商品マスタの下り商品処理(40D)の同一ＪＡＮ対応の為、以下の処理を変更する
-- 　・エコールの場合、下り銘柄処理(20D)で発売日[gds_sales_date],[gds_text_sales_date]の更新は行わないように変更
-- 　・エコールの場合、下り送品処理(22D)で発売日[gds_sales_date],[gds_text_sales_date]の更新は行わないように変更
-- Ver 10-14 2015/02/03 hosaka （テスト2015/07/16）
-- ・下り送品処理(22D)で文具自動検収処理(P_Auto_Arrival_ST)の呼び出しを追加
-- Ver 10-15 2015/08/06
-- ・上り売上データ(エコール) 【UP_URIAGE_DATA】抽出条件の不具合を修正
-- Ver 10-15 2016/08/17
-- ・msfr08のソースに差し替え（＋　デフォルト　@ext_day=-1に変更、抽出対象期間ログ出力）
-- Ver 10-16 2016/08/18
-- ・エコール価格改定　更新日セット抜け対応、コピー条件抜け対応
-- Ver 10-17 2016/08/19
-- ・エコール未登録商品　不具合対応
-- Ver 10-18 2016/08/26 Long-DK
-- ・雑誌の発売日更新について（商品マスタ更新ルールについて）
-- Ver 10-19 2016/09/02
-- ・下りエコール商品（40D）で在庫マスタ更新を明文堂では実施しないために
--　　wpt_book_edi_setting.bes_dw_ekk_flag=1の時に実行するように変更
-- Ver 10-20 2016/09/28 Long-DK
-- ・雑誌の発売日と雑誌の発売日初回入荷更新フラグ更新
-- Ver 10-21 2016/10/06 Long-DK
-- ・下り銘柄処理（20D）価格更新条件を追加する。
-- Ver 10-22 2016/12/05 Long-DK
-- ・MS-221 【EDI修正】エスアイピー（SIP）向け上り売上データの改修
-- Ver 10-23 2017/06/12 Khoa-NDUY
-- ・MS-270 【調査改修依頼】ディスカバー21のマスタ更新について
-- Ver 10-24 2017/12/12 MS#387 （DNPBQ　WEBPOSへの自動発注データ取込 - 47D,47U）
-- Ver 10-25 2018/05/07 MS-439 トーハン上り売上で雑貨商品が送信されない
--	トーハン以外への影響を考慮し、通信区分「TH」のパターン追加
--		共通商品マスタのJANベース、但しNUllの場合は売上明細トランのJANベース　　　　　　　　　　　　　　　　　　　←　雑誌、CD/DVD/文具/その他雑貨
--		共通商品BOOKのISBN、但しNUllの場合は売上明細トランのJANベース（F_Convert_JAN_ISBN()：ISBN変換後の値）　	  ←　書籍
--		参考）	今回対象のデータはフォーマット15Cで、売上/売返、黒伝、セット以外、トラン明細のJANがNULLでないものが対象
--		2018/05/14 wpt_edibook_up_urtへインサートするクエリが対応対象
-- Ver 10-26 2018/05/25 上り在庫変動処理
--		KADOKAWA処理追加
-- Ver 10-27 2018/06/21 MS-470 【EDI】店舗独自商品からの昇格処理の税区分について
--		【東京エコール】下り商品マスタのクライアント処理で商品更新で「gds_tax_type = '0'」を追加
-- Ver 10-28 2018/06/26 MS-437 KADOKAWAデータ送信EDI 
--		KADOKAWA（KK）の18Uの時だけ書籍の出版社を限定する
-- Ver 10-29 2018/07/12 MS-479 【KADOKAWAデータ送信】日々のデータが過去５日ぐらいの累計値になっている？
--		KADOKAWA（KK）の16Uでgdt_trn_dateの抽出条件を変更する。
-- Ver 10-30 2018/09/06 MS-479 【KADOKAWAデータ送信】日々のデータが過去５日ぐらいの累計値になっている？
--		KADOKAWA（KK）の16Uで抽出条件のtrn_trn_dateをtrn_create_dateに変更する。
-- Ver 10-31 2018/10/25 MS-475 【エコール下り処理】価格改定の価格が送品データで上書きされてしまう - Khoa-NDUY
-- ・下り送品処理 - EC取次の商品の価格更新条件変更
-- Ver 11-00 2019/03/14 MS-560 【MSDB06】明文堂自動発注関連
--		自動発注設定解除処理SP(P_auto_hachu_cancel_setting)追加
-- Ver 11-03 2019/07/24 MS-566 【MSDB08】エコールマスタがTMWマスタに上書きされた！？- Khoa-NDUY
--		EDI下り銘柄処理（20D）、JAN訂正処理に商材CDの一致を条件に入れること対応。
--		MS-609 TONETS-V EDI　在庫変動上り（56U）　対象外データの追加
-- Ver 11-04 2020/02/19  MS-771 MSDB06にトーハン文具雑貨店舗管理システム（BZS）用のEDI追加
--		（ETS商品マスタ下り、ETS送品データ下り、MSP商品マスタ下り、MSP納品データ、など）
--		ソースを比較、msdb41の2019/7-2019/11、2012/10/22更新箇所をmsdb06に反映
-- 2020/05/11 MS-771 MSDB06にトーハン文具雑貨店舗管理システム（BZS）用のEDI追加（ETS商品マスタ下り、ETS送品データ下り、MSP商品マスタ下り、MSP納品データ、など）- hung-bq
--=================================================
ALTER PROCEDURE [dbo].[P_EDI_Book]
    @edi_type varchar(10) = null
   ,@date datetime = null
   ,@ext_day int = -5						--2017-02-28 更新
--   ,@ext_day int = -1						--2016-08-17 更新
   ,@ext_time datetime = '00:00:00'
   ,@ext_dd int = 1
   ,@TAIYO char(1) = '0'
   ,@rv char(1) = '0'
AS
--=================================================
-- 開始
--=================================================
SP_MAIN:
  SET NOCOUNT ON

--=============================================
-- なんとなく共通処理
--=============================================

  -- 必要なローカル変数定義
  Declare @tran_ct int           -- トランザクションカウント
  Declare @rc int                  -- リターンコードワーク
  Declare @row int                  -- ワーク
  Declare @err_msg varchar(1000)  -- リターンメッセージワーク
  Declare @log_msg varchar(1000)  -- ログメッセージワーク
  Declare @rs cursor         -- カーソルワーク
  Declare @rs2 cursor         -- カーソルワーク
  Declare @error int   -- エラーコード

  Declare @rowcount int  -- 更新行
  Declare @FETCH_STATUS int -- @@FETCH_STATUSワーク

--=================================================
-- パラメタチェック
--=================================================

  -- 当日、前日をセット
  Declare @a_today datetime
  Declare @a_yesterday datetime
  Declare @a_start_date datetime
  Declare @a_getdate_date datetime

  Declare @a_end_date datetime
  Declare @a_ext_day int
  Declare @a_ext_time datetime
  Declare @a_ext_dd int  -- 抽出期間
  Declare @a_exec_start_time datetime  -- 処理開始時間
  Declare @a_getdate datetime  -- 現在時刻セット用

  -- 共通変数
  Declare @a_edi_id bigint   -- 行特定用
--  Declare @a_timestamp timestamp   -- 行特定用タイムスタンプ
  Declare @a_file_line_no int    -- ファイル行数
  Declare @a_meisai_no int  -- 明細行数
  Declare @a_tushin_id char(2)  -- 取次コード
  Declare @a_goods_code_kubun char(1)
  Declare @a_goods_code varchar(13)
  Declare @a_tax_type char(1)  -- 税区分
  Declare @a_goods_name varchar(100)
  Declare @a_goods_id int        -- 商品ＩＤ
  Declare @a_media_id int        -- メディアＩＤ
  Declare @a_price_type char(1)
  Declare @a_price money
  Declare @a_price_intax money  -- 税込金額2012/03/28
  Declare @a_genka money
  Declare @a_goods_type char(2)
  Declare @a_yyyymm varchar(6)

  Declare @a_denpyo_date varchar(8)
  Declare @a_denpyo_no varchar(10)
  Declare @a_line_no int
  Declare @a_set_kubun char(1)
  Declare @a_jan varchar(13)  -- JANコード
  Declare @a_trn_id int
  Declare @a_supplier_id int  -- 仕入先ＩＤ
  Declare @a_supplier_cd varchar(10) -- 仕入先コード
  Declare @a_trn_id_add int
  -- 2009/01/21
  Declare @a_dw_mst_flag char(1) -- 下り銘柄処理フラグ
  Declare @a_work_type char(4)   -- 業務区分
  -- 2009/03/12
  Declare @a_supplier_edi_type char(1) -- 仕入先EDI区分
  -- 2009/05/12
  Declare @a_genre_cd varchar(10)  -- ジャンルコード
  Declare @a_exist_goods_id int        -- 既存商品ID
  Declare @a_exist_goods_type char(2)  -- 既存商品区分
  Declare @a_exist_goods_media_id int  -- 既存商品分類ID
  -- 2010/02/03
  Declare @a_exist_jan_cd varchar(20)  -- 既存商品JAN
  Declare @a_jan_new varchar(20)    -- 訂正後JAN
  -- 2010/04/27
  Declare @a_tohan_ur_format_type char(1) -- トーハン売上データeBSM拡張フォーマット区分
  -- 2011/07/15
  Declare @a_exist_c_code varchar(20)  -- 既存商品Cコード
  -- 2012/03/28
  Declare @a_tax_rate_type char(1)  -- 税端数処理区分
  -- ▼▼▼ 2013/11/21 add
  Declare @a_tonets_v_up_flag char(1)	-- トーハンTONET=V上り実装フラグ
  Declare @a_tonets_v_dw_flag char(1)	-- トーハンTONET=V下り実装フラグ
  -- ▲▲▲ 2013/11/21 add

  -- ログ
  Set @log_msg =
        'EDIクライアント処理START trn_date='
        + '[' + isnull(cast(@date as varchar),'') + ']'
        + ',edi=[' + isnull(@edi_type,'') + ']'
        + '  ----------------------------------'
  Exec P_LogMsg @log_msg

  -- デフォルトセット
  SELECT 
	 @a_today = isnull(@date,getdate())
	,@a_ext_day = isnull(@ext_day,-5)  -- デフォルトは5日に変更
	,@a_ext_time = isnull(@ext_time,'00:00:00')
	,@a_ext_dd = isnull(@ext_dd,1)
	,@a_getdate_date = convert(datetime,convert(varchar,getdate(),112)) -- 当日の日付のみ

  -- 日付けチェック
  If isdate(@a_today) = 0 Begin
    SELECT @err_msg = '9001,日付けが不正です。'
    GOTO SP_ERR
  End

  -- 対象日指定チェック
  If isnumeric(@a_ext_day) = 0 Begin
    SELECT @err_msg = '9002,抽出対対象日が不正です。'
    GOTO SP_ERR
  End

  -- 対象開始時間指定チェック
  If isdate(@a_ext_time) = 0 Begin
    SELECT @err_msg = '9003,抽出対象開始時間が不正です。'
    GOTO SP_ERR
  End

  -- 対象時間指定チェック
  If isnumeric(@a_ext_dd) = 0 Begin
    SELECT @err_msg = '9004,抽出対象期間が不正です。'
    GOTO SP_ERR
  End


  -- 前日をセット
  SELECT
     @a_yesterday = dateadd( dd , @a_ext_day , @a_today )

  -- 開始日付を前日の指定時間
  -- 終了日付をそこから抽出時間後にセット
  -- 抜き出しはend時間未満なのでこの時間は含まない

  SELECT
     @a_start_date = cast(
        convert(varchar,@a_yesterday,111)  -- yyyy/mm/dd変換
        + ' ' + convert(varchar,@a_ext_time,108)  -- hh:mm:ss変換
        as datetime)
  SELECT
     @a_end_date = dateadd( mi , -1 , getdate()) -- 1分前

  -- リカバリ時は終了時間を1日後に再セット
  If @rv = '1' Begin
    SELECT
       @a_end_date = dateadd( dd , @a_ext_dd , @a_start_date )  -- 抽出期間(1日)後がend
  End


  -- 処理開始時間セット
  SELECT
     @a_exec_start_time = getdate()


  -- ログ				2016-08-17 add
  Set @log_msg =
        'EDIクライアント処理   抽出対象期間'
        + '<=[' + isnull(cast(@a_start_date as varchar),'') + ']'
        + ',>[' + isnull(cast(@a_end_date as varchar),'') + ']'
        + '  ----------------------------------'
  Exec P_LogMsg @log_msg


--=================================================
-- 共通処理
--=================================================

  -- 下り用処理カウンタ
  Declare @count_all int  -- 処理対象
  Declare @count_wa int  -- 警告数
  Declare @count_ng int  -- 異常数
  Declare @count_ok int  -- 正常

  Create Table #count_tbl (
     t_exec_id varchar(10)
    ,t_tushin_id char(2)
    ,t_count_all int
    ,t_count_ok int
    ,t_count_wa int
    ,t_count_ng int
  )

  -- サーバ名・データベース名セット
  Declare @server_name varchar(100)

  Declare @db_name varchar(100)

  SELECT
     @server_name = @@SERVERNAME
    ,@db_name = db_name()

  -- カウンタクリア
  SELECT
      @count_all = 0
     ,@count_wa = 0
     ,@count_ng = 0
     ,@count_ok = 0

  Declare @a_edi_error_msg varchar(200)  -- エラーメッセージ書き込み用
  Declare @a_edi_flag char(1)                  -- EDI処理フラグ書き込み用
  Declare @a_tax_rate decimal(5,2)          -- 税率
  Declare @a_sql varchar(8000)              -- SQL用ワーク
  Declare @a_sql2 varchar(8000)              -- SQL用ワーク

  Declare @edi_server_name varchar(100)        -- ＥＤＩサーバ名
  Declare @edi_db_name varchar(100)              -- ＥＤＩサーバＤＢ名

  -- システム情報読み込み。SPキック
  Exec @rc = P_System_info
	  @bookedi_server_name = @edi_server_name OUTPUT
	 ,@bookedi_db_name = @edi_db_name OUTPUT
	 ,@tax_rate = @a_tax_rate OUTPUT

  -- エラーチェック
  If @rc <> 0 Begin
    SELECT @err_msg = '9005,システム情報読み出しエラー。'
    GOTO SP_ERR
  End
  
  -- 2011/04/12
  -- []で括る
  If LEFT(@edi_server_name, 1) <> '['
     And RIGHT(@edi_server_name, 1) <> ']'
  Begin
    Set @edi_server_name = '[' + @edi_server_name + ']'
  End
  If LEFT(@edi_db_name, 1) <> '['
     And RIGHT(@edi_db_name, 1) <> ']'
  Begin
    Set @edi_db_name = '[' + @edi_db_name + ']'
  End
  

  -- 上り返品処理
  If @edi_type = '11U' Begin
	 GOTO UP_HENPIN
  End

  -- 上り発注処理
  If @edi_type = '12U' Begin
	GOTO UP_HACHU
  End

  -- 上り定期改正処理
  If @edi_type = '13U' Begin
	GOTO UP_TEIKI
  End

  -- 上り売上処理(ヘッダ)
  If @edi_type = '14U' Begin
	GOTO UP_URIAGE_HEADER
  End

  -- 上り売上処理(明細)
  If @edi_type = '15U' Begin
	GOTO UP_URIAGE
  End

  -- 上り在庫処理
  If @edi_type = '16U' Begin
	GOTO UP_ZAIKO
  End

  -- 上り全在庫処理
  If @edi_type = '18U' Begin
	GOTO UP_ZENZAIKO
  End
  
  -- 上り発注処理	-- 2017/04/13 add
  If @edi_type = '47U' Begin
	GOTO UP_HACHU_FUKUSUU
  End

  -- 上りポイント変動処理
  If @edi_type = '50U' Begin
	GOTO UP_POINT
  End

  -- 【トップカルチャー本部連動】上り取引明細処理	-- 2012/09/03 add
  If @edi_type = '51U' Begin
	GOTO UP_MEISAI_URIAGE_TPC
  End

  -- 【トップカルチャー本部連動】上り取引合計処理	-- 2012/09/03 add
  If @edi_type = '52U' Begin
	GOTO UP_TOTAL_URIAGE_TPC
  End

  -- 【トップカルチャー本部連動】上り日計情報処理	-- 2012/09/03 add
  If @edi_type = '53U' Begin
	GOTO UP_NIKKEI_URIAGE_TPC
  End

  -- 【トップカルチャー本部連動】上り部門別売上処理	-- 2012/09/03 add
  If @edi_type = '54U' Begin
	GOTO UP_BUMON_URIAGE_TPC
  End

  -- 【トップカルチャー本部連動】上りクレジット別売上処理	-- 2012/09/03 add
  If @edi_type = '55U' Begin
	GOTO UP_CREDIT_URIAGE_TPC
  End

  -- ▼▼▼ 2013/11/21 add
  -- 上り在庫変動処理（TONETS-V:T1）
  If @edi_type = '56U' Begin
	GOTO UP_ZAIKOHENDO_T1
  End
  -- ▲▲▲ 2013/11/21 add
  
  -- 【上り未登録商品マスタ(エコール)】上り未登録商品マスタのクライアント処理	-- 2014/01/20 add
  If @edi_type = '60U' Begin
	GOTO UP_MITOUROKUSYOUHIN_TPC
  End
  
  -- 【上り売上データ(エコール)】処理 -- 2014/02/11 add
  If @edi_type = '61U' Begin
	GOTO UP_URIAGE_DATA
  End
  
  -- ▼▼▼ 2014/01/28 add
  -- 【JEUGIA基幹連動】上り売上処理
  If @edi_type = '62U' Begin
	GOTO UP_JEUGIA_URIAGE
  End
  -- 【JEUGIA基幹連動】上り仕入処理
  If @edi_type = '63U' Begin
	GOTO UP_JEUGIA_SIIRE
  End
  -- 【JEUGIA基幹連動】上り移動処理
  If @edi_type = '64U' Begin
	GOTO UP_JEUGIA_IDO
  End
  -- 【JEUGIA基幹連動】上り棚卸処理
  If @edi_type = '65U' Begin
	GOTO UP_JEUGIA_TANA
  End
  -- ▲▲▲ 2014/01/28 add



  -- 下り銘柄処理
  If @edi_type = '20D' Begin
	GOTO DOWN_MEIGARA
  End

  -- 下り送品処理
  If @edi_type = '22D' Begin
	GOTO DOWN_SOUHIN
  End

  -- 下り返品処理
  If @edi_type = '21D' Begin
	GOTO DOWN_HENPIN
  End

  -- 下り売上処理
  If @edi_type = '23D' Begin
	GOTO DOWN_URIAGE
  End

  -- 下り請求処理
  If @edi_type = '24D' Begin
	GOTO DOWN_SEIKYU
  End

  -- 下り廃盤処理
  If @edi_type = '25D' Begin
	GOTO DOWN_HAIBAN
  End

  -- 下りメーカレーベル処理
  If @edi_type = '26D' Begin
	GOTO DOWN_LABEL
  End

  -- 下りジャンル処理
  If @edi_type = '27D' Begin
	GOTO DOWN_GENRE
  End

  -- 下り品種処理
  If @edi_type = '28D' Begin
	GOTO DOWN_HINSHU
  End

  -- 下り大分類処理
  If @edi_type = '29D' Begin
	GOTO DOWN_DAIBUNRUI
  End

  -- 下り中分類処理
  If @edi_type = '30D' Begin
	GOTO DOWN_CHUBUNRUI
  End

  -- 下り小分類処理
  If @edi_type = '31D' Begin
	GOTO DOWN_SHOBUNRUI
  End

  -- 下り価格変更(ヘッダ、明細)処理
  If @edi_type = '32D' Begin
	GOTO DOWN_KAKAKUHENKOU
  End

  -- 下り注文書(ヘッダ、明細)処理
  If @edi_type = '34D' Begin
	GOTO DOWN_CHUMON
  End

  -- 【トップカルチャー本部連動】下り文具価格マスタ処理	-- 2012/09/03 add
  If @edi_type = '36D' Begin
	GOTO DOWN_BUNGUKAKAKU_TPC
  End

  -- 【星光堂】下りメーカーＪＡＮ移行データ処理			-- 2012/12/27 add
  If @edi_type = '37D' Begin
	GOTO DOWN_MAKER_JAN_IKO
  End

  -- 【星光堂】下り基準曲データ処理						-- 2012/12/27 add
  If @edi_type = '38D' Begin
	GOTO DOWN_KIJUN_KYOKU
  End
  
  -- 下りタイトルデータ(マスタ処理）)					-- 2013/12/04 add
  If @edi_type = '39D' Begin
	GOTO DOWN_JMD
  End

  -- 【東京エコール】下り商品マスタのクライアント処理	-- 2013/12/24 add	
  If @edi_type = '40D' Begin
	GOTo DOWN_ECOLE_ESH
  End
  
  -- 【東京エコール】下りブランドマスタのクライアント処理		-- 2013/12/26 add
  If @edi_type = '41D' Begin
	GOTO DOWN_GOODS_ARTIST
  End
  
  -- 【東京エコール】下りメーカーマスタのクライアント処理				-- 2013/12/27 add
  If @edi_type = '42D' Begin
	GOTO DOWN_MAKER
  End
  
  -- 【東京エコール】下り分類マスタのクライント処理				-- 2013/12/27 add
  If @edi_type = '43D' Begin
	GOTO DOWN_BUNRUI
  End
  
  -- 【東京エコール】下り発注データクライアント処理					-- 2014/03/31 add
  If @edi_type = '44D' Begin
	--print 'エコール発注下り呼び出し'
	GOTO DOWN_ORDER_DATA
  End
  
  -- 【東京エコール】下り商品定価改正データ処理						-- 2013/12/20 add
  If @edi_type = '45D' Begin
	GOTO DOWN_GOODS_TEIKA_KAISEI
  End
  
  -- 													-- 2017/03/30 add
  If @edi_type = '47D' Begin
	GOTO DOWN_BIG_QUERY
  End
  -- どこにもひっかからない場合不正
  Set @err_msg = '9000,ＥＤＩ処理パラメタが不正です。'
  GOTO SP_ERR


--=================================================
--=================================================
--==  上り
--=================================================
--=================================================

  Declare @a_fran_id int  -- 2009/01/21
  Declare @a_shop_cd int
  Declare @a_shop_name varchar(100)
  Declare @a_book_shop_cd varchar(20)
  Declare @a_tohan_group_cd varchar(20)

  Declare @trn_trn_id int

  Declare @trn_create_date datetime   
  Declare @trn_work_type char  (4)
  Declare @trn_denpyo_type char  (1)
  Declare @trn_trn_date datetime   
  Declare @trn_pos_date datetime   
  Declare @trn_receipt_no int   
  Declare @trn_pos_no int   
  Declare @trn_shop_cd int   
  Declare @trn_shop_name varchar  (50)
  Declare @trn_sousa_shop_cd int  
  Declare @trn_sousa_shop_name varchar  (50)

  Declare @trn_member_id int  
  Declare @trn_member_cd varchar  (20)
  Declare @trn_member_name varchar  (100)
  Declare @trn_member_card_cd varchar  (20)
  Declare @trn_staff_id int  
  Declare @trn_staff_cd varchar  (20)
  Declare @trn_staff_name varchar  (50)
  Declare @trn_app_version varchar  (50)
  Declare @trn_interface_version varchar  (20)
  Declare @trn_exec_time int  

  Declare @tso_trn_id int   
  Declare @tso_trn_type char  (1)
  Declare @tso_supplier_id int  
  Declare @tso_supplier_cd varchar  (10)
  Declare @tso_denpyo varchar  (20)
  Declare @tso_denpyo_sub int  
  Declare @tso_remark_id int  
  Declare @tso_remark_cd char  (2)
  Declare @tso_remark_type char  (1)
  Declare @tso_remark_name varchar  (100)
  Declare @tso_type_cd varchar  (2)
  Declare @tso_z_date datetime  
  Declare @tso_doc_id int  
  Declare @tso_muden_flag char  (1)

  Declare @tod_trn_id int   
  Declare @tod_line_no int   
  Declare @tod_condition_type char  (1)
  Declare @tod_goods_id int  
  Declare @tod_goods_type char  (2)
  Declare @tod_koyu_goods_cd varchar  (20)
  Declare @tod_jan_cd varchar  (20)
  Declare @tod_media_cd varchar  (10)
  Declare @tod_genre_cd varchar  (10)
  Declare @tod_goods_name varchar  (100)
  Declare @tod_price_default money   
  Declare @tod_cost_price_default money   
  Declare @tod_price money   
  Declare @tod_cost_price money   
  Declare @tod_goods_count int   
  Declare @tod_plu_cd varchar  (20)
  Declare @tod_provided_cd varchar  (50)
  Declare @tod_media_id int  
  Declare @tod_plu_addon_cd varchar  (20)
  Declare @tod_tana_cd varchar  (10)

  Declare @tha_trn_id int   
  Declare @tha_trn_type char  (1)

  Declare @tdh_trn_id int   
  Declare @tdh_line_no int   
  Declare @tdh_hachu_type char  (1)
  Declare @tdh_goods_id int  
  Declare @tdh_koyu_goods_id varchar  (20)
  Declare @tdh_jan_cd varchar  (20)
  Declare @tdh_goods_name varchar  (100)
  Declare @tdh_tax_type char  (1)
  Declare @tdh_supplier_id int   
  Declare @tdh_supplier_cd varchar  (10)
  Declare @tdh_price_default money   
  Declare @tdh_cost_price_default money   
  Declare @tdh_price money   
  Declare @tdh_cost_price money   
  Declare @tdh_goods_count int   
  Declare @tdh_goods_yoyaku_count int   
  Declare @tdh_member_order_memo varchar  (100)
  Declare @tdh_book_kanri_cd varchar  (30)
  Declare @tdh_tana_cd varchar  (10)
  Declare @tdh_tel_type char  (1)
  Declare @tdh_back_type char  (1)
  Declare @tdh_goods_type char  (2)   -- 追加

  Declare @tur_trn_id int   
  Declare @tur_trn_type char  (1)
  Declare @tur_kyaku_cd char  (2)
  Declare @tur_kyaku_name varchar  (50)
  Declare @tur_kyaku_count int   
  Declare @tur_kyaku_type char  (1)
  Declare @tur_goods_count int   
  Declare @tur_goods_sum money   
  Declare @tur_subtotal money   
  Declare @tur_deposit money   
  Declare @tur_redemption money   
  Declare @tur_remainder money   
  Declare @tur_finish money   
  Declare @tur_tax_finish money   
  Declare @tur_intax_finish money   
  Declare @tur_extax_count int   

  Declare @tur_extax_sum money   
  Declare @tur_extax_tax_sum money   
  Declare @tur_extax_discount_sum money   
  Declare @tur_intax_count int   
  Declare @tur_intax_sum money   
  Declare @tur_intax_tax_sum money   
  Declare @tur_intax_discount_sum money   
  Declare @tur_notax_count int   
  Declare @tur_notax_sum money   
  Declare @tur_notax_discount_sum money   
  Declare @tur_discount_sum money   
  Declare @tur_unit_discount_sum money   
  Declare @tur_intax_exemption_tax money   
  Declare @tur_tax_exemption_flag char  (1)
  Declare @tur_memo varchar  (50)
  Declare @tur_point_exec_type char  (2)
  Declare @tur_point_add int  
  Declare @tur_point_use int  
  Declare @tur_point_add_tanka money  
  Declare @tur_point_use_tanka money  

  Declare @tdu_trn_id int   
  Declare @tdu_line_no int   
  Declare @tdu_trn_cd char  (1)
  Declare @tdu_line_no_set int   
  Declare @tdu_condition_type char  (1)
  Declare @tdu_goods_id int  
  Declare @tdu_koyu_goods_id varchar  (20)
  Declare @tdu_jan_cd varchar  (20)
  Declare @tdu_media_id int  
  Declare @tdu_media_cd varchar  (10)
  Declare @tdu_genre_cd varchar  (10)
  Declare @tdu_plu_price money   
  Declare @tdu_price money   
  Declare @tdu_selling_count int   
  Declare @tdu_unit_price money   
  Declare @tdu_unit_discount_price money   
  Declare @tdu_selling_price money   
  Declare @tdu_tax_price money   
  Declare @tdu_point_add int   
  Declare @tdu_point_rate decimal (5, 0) 
  Declare @tdu_set_selling_count int   
  Declare @tdu_set_unit_price money   
  Declare @tdu_set_unit_discount_price money   
  Declare @tdu_set_selling_price money   
  Declare @tdu_set_tax_price money   
  Declare @tdu_set_point_add int   
  Declare @tdu_set_point_rate decimal (5, 0) 
  Declare @tdu_goods_type char  (2)
  Declare @tdu_goods_name varchar  (100)
  Declare @tdu_goods_ryaku varchar  (50)
  Declare @tdu_goods_kana varchar  (100)
  Declare @tdu_tax_type char  (1)
  Declare @tdu_tax_rate_type char  (1)
  Declare @tdu_tax_rate decimal (5, 2) 
  Declare @tdu_tax_exemption_flag char  (1)
  Declare @tdu_set_type char  (1)
  Declare @tdu_hisu_flag char  (1)
  Declare @tdu_setprice_flag char  (1)
  Declare @tdu_plu_cd varchar  (20)
  Declare @tdu_plu_addon_cd varchar  (20)
  Declare @tdu_goods_group_id int  
  Declare @tdu_goods_group_cd varchar  (20)
  Declare @tdu_bargain_id int  
  Declare @tdu_bargain_cd varchar  (20)
  Declare @tdu_price_change_flag char  (1)
  Declare @tdu_yoyaku_doc_id int  


  Declare @gds_jan_cd varchar(20)
  Declare @gds_tax_type char(1)
  Declare @gdb_isbn varchar(10)
  Declare @gdb_c_code char(4)
  Declare @gdb_magazinecode_and_gatugo char(7)
  Declare @gdz_magazinecode_and_gatugo char(7)
  Declare @gdz_kihon_magazinecode char(5)

--=================================================
-- 上り返品処理
--=================================================
UP_HENPIN:


  Declare @e11_edi_flag char (1)
  Declare @e11_edi_create_date datetime
  Declare @e11_edi_error_msg varchar (200)
  Declare @e11_server_webpos varchar (100)
  Declare @e11_dbname_webpos varchar (100)
  Declare @e11_shop_cd_webpos varchar (10)
  Declare @e11_shop_name_webpos varchar (100)
  Declare @e11_seq_no char (5)
  Declare @e11_shop_cd_primary varchar (10)
  Declare @e11_shop_cd varchar (10)
  Declare @e11_tushin_id char (2)
  Declare @e11_sbs_denpyo_no varchar (10)
  Declare @e11_sbs_henpin_shubetu varchar (4)
  Declare @e11_denpyo_date char (8)
  Declare @e11_denpyo_time char (6)
  Declare @e11_denpyo_no varchar (10)
  Declare @e11_henpin_kubun char (2)
  Declare @e11_konpo_no varchar (10)
  Declare @e11_henpin_kigen char (8)
  Declare @e11_shori_no1 varchar (20)
  Declare @e11_shori_no2 varchar (20)
  Declare @e11_line_no int 
  Declare @e11_goods_code_kubun char (1)
  Declare @e11_goods_code varchar (20)
  Declare @e11_year char (4)
  Declare @e11_zasshi_code_and_gatugo char (7)
  Declare @e11_c_code char (4)
  Declare @e11_price money 
  Declare @e11_henpin_count int 
  Declare @e11_tax_type char (1)
  Declare @e11_tax_rate decimal(5, 2) 
  Declare @e11_order_biko varchar (50)

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック

  If @rc <> 0 Begin
    Set @err_msg = '9041,返品データ削除不正'
    GOTO SP_ERR
  End


  ------------------------------

  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
            where
               bes_up_hpn_flag =
                  case
                     when @edi_type = '11U' then '1'
                     else bes_up_hpn_flag
                  end
               and
               bes_up_hcu_flag =
                  case
                     when @edi_type = '12U' then '1'
                     else bes_up_hcu_flag
                  end
               and
               bes_up_tka_flag =
                  case
                     when @edi_type = '13U' then '1'
                     else bes_up_tka_flag
                  end
               and
               bes_up_urh_flag =
                  case
                     when @edi_type = '14U' then '1'
                     else bes_up_urh_flag
                  end
               and
               bes_up_urd_flag =
                  case
                     when @edi_type = '15U' then '1'
                     else bes_up_urd_flag
                  end

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	INSERT wbe_edibook_up_control (

		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		)
	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = tod_trn_id
		,e10_edi_line_no = tod_line_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
		,e10_edi_shop_cd = @a_book_shop_cd
		,e10_tohan_group_cd = @a_tohan_group_cd
	       from
		wpv_transaction
		join
		wpt_transaction_inout
		  on
		  trn_trn_id = tso_trn_id
		join
		wpt_transaction_inout_details
		  on
		  trn_trn_id = tod_trn_id
		join
		wpt_maker_supplier_master
		  on
		  tso_supplier_id = mpm_supplier_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  tod_trn_id = e10_edi_trn_id
		  and
		  tod_line_no = e10_edi_line_no
	       where
		trn_shop_cd = @a_shop_cd
		and
--		trn_work_type = '0231'  -- 書籍、雑誌返品
		trn_work_type IN ('0231','0232')  -- 書籍、雑誌返品、DISK返品		-- 2014/04/15 update
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		trn_trn_date >= @a_start_date
		and
		trn_trn_date < @a_end_date
		and
		mpm_bookedi_cd = @a_tushin_id
		and
--		mpm_edi_type = '2'   -- 書籍ＥＤＩシステム
		mpm_edi_type in ( '2', '3' )   -- 書籍ＥＤＩシステム , DISKＥＤＩシステム	-- 2014-04-15 update
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの
		and
		tso_muden_flag = '0'   -- 無伝以外

	  -- エラーチェック
	  If @@ERROR <> 0 Begin
	    Set @err_msg = '9044,返品データ抽出エラー'
	    GOTO SP_ERR
	  End

      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------
      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

      -- データ転送
      SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_hpn ( '
	+ '	 e11_edi_flag '
	+ '	,e11_server_webpos '
	+ '	,e11_dbname_webpos '
	+ '	,e11_shop_cd_webpos '
	+ '	,e11_shop_name_webpos '
	+ '	,e11_shop_cd_primary '
	+ '	,e11_shop_cd '
	+ '	,e11_tushin_id '
	+ '	,e11_sbs_denpyo_no '
	+ '	,e11_sbs_henpin_shubetu '
	+ '	,e11_denpyo_date '
	+ '	,e11_denpyo_time '
	+ '	,e11_denpyo_no '
	+ '	,e11_henpin_kubun '
	+ '	,e11_konpo_no '
	+ '	,e11_henpin_kigen '
	+ '	,e11_shori_no1 '
	+ '	,e11_shori_no2 '
	+ '	,e11_line_no '
	+ '	,e11_goods_code_kubun '
	+ '	,e11_goods_code '
	+ '	,e11_year '
	+ '	,e11_zasshi_code_and_gatugo '
	+ '	,e11_c_code '
	+ '	,e11_price '
	+ '	,e11_henpin_count '
	+ '	,e11_tax_type '
	+ '	,e11_tax_rate '
	+ '	,e11_order_biko '
	+ '	,e11_tohan_group_cd '
	-- 2014/01/23 エコール商品コード追加。
	+ '	,e11_ecole_hinban '
	+ '  )   '
	+ '  SELECT '
	+ '	 e11_edi_flag = ''0'' '          -- 未処理
	+ '	,e11_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e11_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e11_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e11_shop_name_webpos = e10_edi_shop_name_webpos '
	+ '	,e11_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e11_shop_cd = e10_edi_shop_cd '
	+ '	,e11_tushin_id = e10_edi_tushin_id '
	+ '	,e11_sbs_denpyo_no = null '
	+ '	,e11_sbs_henpin_shubetu = null '
	+ '	,e11_denpyo_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e11_denpyo_time = '
	+ '	              right(''00'' + cast(datepart(hh,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(mi,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(ss,trn_trn_date) as varchar), 2) '
	+ '	,e11_denpyo_no = trn_receipt_no '
	+ '	,e11_henpin_kubun = tso_type_cd '
	+ '	,e11_konpo_no = CAST(tso_ext_no AS varchar) '
	+ '	,e11_henpin_kigen = '
	+ '	             case '
	+ '	                when  isdate(tso_z_date) = 1 '
	+ '	                   then '
	+ '	                     convert(char,convert(datetime,tso_z_date),112) '
	+ '	                else null '
	+ '	             end '
	+ '	,e11_shori_no1 = tso_shori_no1 '
	+ '	,e11_shori_no2 = tso_shori_no2 '
	+ '	,e11_line_no = e10_edi_line_no '
	+ '	,e11_goods_code_kubun = '
	+ '	             case '
	+ '	                when tod_goods_type = ''20'' then ''1'' '  -- 書籍
	+ '	                when tod_goods_type = ''21'' then ''2'' '  -- 雑誌
	+ '	                when tod_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+ '	                when tod_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+ '	                else ''0'' '  -- その他
	+ '	             end '
	+ '	,e11_goods_code = '
	+ '	             case '
-- 2011/06/02 update
	--+ '	                when tod_goods_type = ''20'' then gdb_isbn '    -- 書籍
	--+ '	                when tod_goods_type = ''21'' then gds_jan_cd '  -- 雑誌
	--+ '	                when tod_goods_type = ''30'' then gds_jan_cd '  -- CD/DVD
	--+ '	                when tod_goods_type = ''31'' then gds_jan_cd '  -- CD/DVD
	--+ '	                else gds_jan_cd '  -- その他
	+ '	                when tod_goods_type = ''20'' then dbo.F_Convert_JAN_ISBN(plu_jan_cd) '    -- 書籍(plu_isbnは13桁の為、利用不可)
	+ '	                when tod_goods_type = ''21'' then plu_jan_cd '  -- 雑誌
	+ '	                when tod_goods_type = ''30'' then plu_jan_cd '  -- CD/DVD
	+ '	                when tod_goods_type = ''31'' then plu_jan_cd '  -- CD/DVD
	+ '	                else plu_jan_cd '  -- その他
--------------------
	+ '	             end '
	+ '	,e11_year = null '
	+ '	,e11_zasshi_code_and_gatugo = '
	+ '	             case '
-- 2011/06/02 update
	--+ '	                when tod_goods_type = ''20'' then gdb_magazinecode_and_gatugo '  -- 書籍
	--+ '	                when tod_goods_type = ''21'' then gdz_magazinecode_and_gatugo '  -- 雑誌
	+ '	                when tod_goods_type = ''20'' then IsNull(sdb_magazinecode_and_gatugo, gdb_magazinecode_and_gatugo) '  -- 書籍
	+ '	                when tod_goods_type = ''21'' then IsNull(sdz_magazinecode_and_gatugo, gdz_magazinecode_and_gatugo) '  -- 雑誌
--------------------
	+ '	                else null '  -- その他
	+ '	             end '
	+ '	,e11_c_code = '
	+ '	             case '  -- 書籍の場合、2段JANがあればそこのCコード優先
	+ '	                when  rtrim(ltrim(isnull(tod_plu_addon_cd,''''))) <> '''' and tod_goods_type = ''20'' and len(tod_plu_addon_cd) = 13'
	+ '	                  then substring(tod_plu_addon_cd,4,4) '  -- Cコード抜き出し
-- 2011/06/02 update
	--+ '	                else gdb_c_code '
	+ '	                else IsNull(sdb_c_code, gdb_c_code) '
--------------------
	+ '	             end '
	+ '	,e11_price =  ' 
	+'               CASE ' 
	+ '                  WHEN tod_goods_type = ''20'' OR tod_goods_type = ''21'' then '  -- 書籍・雑誌は税抜以外の発生なし（運用上）
-- 2011/06/02 update
	--+ '                    gds_price '
-- 2012/05/15 update
	--+ '                    plu_gds_price '
	+ '                    tod_price_default '
--------------------
	+ '               ELSE tod_price END '
	+ '	,e11_henpin_count = tod_goods_count '
-- 2011/06/02 update
	--+ '	,e11_tax_type = gds_tax_type '
	+ '	,e11_tax_type = plu_tax_type '
--------------------
	+ '	,e11_tax_rate = ' + dbo.F_sql_mod(cast(@e11_tax_rate as varchar(1000)))
	+ '	,e11_order_biko = tod_provided_cd '  -- 取次ぎ常備コード
	+ '	,e11_tohan_group_cd = e10_tohan_group_cd '
	-- 2014/01/23 エコール商品コード追加。
	-- 2014/04/14 頭ゼロでつきで8桁にする
	--+ '	,e11_ecole_hinban = cast(tod_koyu_goods_cd as varchar(20)) '
	+ '	,e11_ecole_hinban = Right( ''00000000'' + cast(tod_koyu_goods_cd as varchar(20) ), 8 ) '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction_inout_details '
	+ '			  on '
	+ '			  e10_edi_trn_id = tod_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = tod_line_no '
	+ '		          join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  tod_trn_id = trn_trn_id '
	+ '			join '
	+ '			wpt_transaction_inout '
	+ '			  on '
	+ '			  trn_trn_id = tso_trn_id '
-- 2011/06/02 add --
	+ '			join '
	+ '			wpv_plu '
	+ '			  on '
	+ '			  plu_shop_cd = trn_shop_cd '
	+ '			  and '
	+ '			  plu_goods_id = tod_goods_id '
--------------------
	+ '			left outer join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  tod_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_book '
	+ '			  on '
	+ '			  tod_goods_id = gdb_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_magazine '
	+ '			  on '
	+ '			  tod_goods_id = gdz_goods_id '
-- 2011/06/02 add --
	+ '			join '
	+ '			wpt_shop_master '
	+ '			  on '
	+ '			  shm_shop_cd = trn_shop_cd '
	+ '			left outer join  '
	+ '			wpt_shop_goods_master  '
	+ '			  on  '
	+ '			  tod_goods_id = sgd_goods_id  '
	+ '			  and  '
	+ '			  ( ( trn_shop_cd = sgd_shop_cd and shm_franchise_id = sgd_franchise_id ) '
	+ '			    or '
	+ '			    ( sgd_shop_cd = 0 and shm_franchise_id = sgd_franchise_id )) '
	+ '			  and  '
	+ '			  sgd_delete_flag = 0 '
	+ '			left outer join  '
	+ '			wpt_shop_goods_master_book  '
	+ '			  on  '
	+ '			  sdb_goods_id = sgd_goods_id  '
	+ '			  and  '
	+ '			  ( ( trn_shop_cd = sdb_shop_cd and shm_franchise_id = sdb_franchise_id ) '
	+ '			    or '
	+ '			    ( sdb_shop_cd = 0 and shm_franchise_id = sdb_franchise_id )) '
	+ '			left outer join  '
	+ '			wpt_shop_goods_master_magazine  '
	+ '			  on  '
	+ '			  sdz_goods_id = sgd_goods_id  '
	+ '			  and  '
	+ '			  ( ( trn_shop_cd = sdz_shop_cd and shm_franchise_id = sdz_franchise_id ) '
	+ '			    or '
	+ '			    ( sdz_shop_cd = 0 and shm_franchise_id = sdz_franchise_id )) '
--------------------
	+ '		    where '
	+ '			e10_edi_flag = ''0'' '  -- 未処理のみ
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '
      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- カウント初期レコードセット

        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		wbe_edibook_up_control 
		join 
		wpt_transaction_inout_details 
		  on 
		  e10_edi_trn_id = tod_trn_id 
		  and 
		  e10_edi_line_no = tod_line_no 
	          join 
		wpt_transaction 
		  on 
		  tod_trn_id = trn_trn_id 
		join 
		wpt_transaction_inout 
		  on 
		  trn_trn_id = tso_trn_id 
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET

            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control 
		join 
		wpt_transaction_inout_details 
		  on 
		  e10_edi_trn_id = tod_trn_id 
		  and 
		  e10_edi_line_no = tod_line_no 
	          join 
		wpt_transaction 
		  on 
		  tod_trn_id = trn_trn_id 
		join 
		wpt_transaction_inout 
		  on 
		  trn_trn_id = tso_trn_id 
	    where 
		e10_edi_flag = '0'  -- 未処理のみ


  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9043,返品ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

UP_HENPIN_END:


--=================================================
-- 上り発注処理
--=================================================
UP_HACHU:

  Declare @e12_edi_flag char (1)
  Declare @e12_edi_timestamp timestamp  
  Declare @e12_edi_create_date datetime 
  Declare @e12_edi_update_date datetime 
  Declare @e12_edi_file_line_no int 
  Declare @e12_edi_meisai_no int 
  Declare @e12_edi_error_msg varchar (200)
  Declare @e12_server_webpos varchar (100)
  Declare @e12_dbname_webpos varchar (100)
  Declare @e12_shop_cd_webpos varchar (10)
  Declare @e12_shop_name_webpos varchar (100)
  Declare @e12_seq_no char (5)
  Declare @e12_shop_cd_primary varchar (10)
  Declare @e12_shop_cd varchar (10)
  Declare @e12_tushin_id char (2)
  Declare @e12_hachu_date char (8)
  Declare @e12_hachu_time char (6)
  Declare @e12_hachu_kubun char (1)
  Declare @e12_goods_code_kubun char (1)
  Declare @e12_goods_code varchar (20)
  Declare @e12_year char (4)
  Declare @e12_hachu_count int 
  Declare @e12_kaiten_count int 
  Declare @e12_hachu_kanri_code1 varchar (20)
  Declare @e12_hachu_kanri_code2 varchar (20)
  Declare @e12_tana varchar (4)
  Declare @e12_dan varchar (4)
  Declare @e12_retu varchar (4)
  Declare @e12_goods_kubun char (2)
  Declare @e12_b_genre varchar (6)  -- 2009/05/18 char(2) → varchar(6)
  Declare @e12_m_genre varchar (6)  -- 2009/05/18 char(2) → varchar(6)
  Declare @e12_s_genre varchar (6)  -- 2009/05/18 char(2) → varchar(6)
  Declare @e12_order_no varchar (20)
  Declare @e12_order_memo varchar (100)
  Declare @e12_order_biko varchar (50)
  Declare @e12_cd_kikaku_bango varchar (15)
  Declare @e12_rest_kubun char (1)

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9051,発注データ削除不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
            where
               bes_up_hpn_flag =
                  case
                     when @edi_type = '11U' then '1'
                     else bes_up_hpn_flag
                  end
               and
               bes_up_hcu_flag =
                  case
                     when @edi_type = '12U' then '1'
                     else bes_up_hcu_flag
                  end
               and
               bes_up_tka_flag =
                  case
                     when @edi_type = '13U' then '1'
                     else bes_up_tka_flag
                  end
               and
               bes_up_urh_flag =
                  case
                     when @edi_type = '14U' then '1'
                     else bes_up_urh_flag
                  end
               and
               bes_up_urd_flag =
                  case
                     when @edi_type = '15U' then '1'
                     else bes_up_urd_flag
                  end

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

--	print @a_start_date
--	print @a_end_date
--	print @a_tushin_id


	-- 発注対象データ抽出
	INSERT wbe_edibook_up_control (
		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		)
	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = tdh_trn_id
		,e10_edi_line_no = tdh_line_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
        -- Ver 09-13 2013/08/06 E.Satoh 複数番線対応 ▼▼▼
	--	,e10_edi_shop_cd = @a_book_shop_cd
        ,e10_edi_shop_cd = CASE WHEN trn_work_type = '0202' THEN    -- 書籍発注時
                ISNULL( ( SELECT dbo.F_Convert_Bansen (             -- 番線（発注先）取得関数
                           @a_tushin_id
                          ,@a_shop_cd
                          ,gdm_media_cd
                          ,gdb_publisher_cd )
                        )
                        ,@a_book_shop_cd        -- EDI_Setting値
                      )
             ELSE
                 @a_book_shop_cd                -- EDI_Setting値
             END 
        -- Ver 09-13 2013/08/06 E.Satoh 複数番線対応 ▲▲▲
		,e10_tohan_group_cd = @a_tohan_group_cd
	       from
		wpv_transaction
		join
		wpt_transaction_hachu
		  on
		  trn_trn_id = tha_trn_id
		join
		wpt_transaction_hachu_details
		  on
		  trn_trn_id = tdh_trn_id
		join
		wpt_maker_supplier_master
		  on
		  tdh_supplier_id = mpm_supplier_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  tdh_trn_id = e10_edi_trn_id
		  and
		  tdh_line_no = e10_edi_line_no
        -- Ver 09-13 2013/08/06 ADD E.Satoh 複数番線対応 ▼▼▼
        LEFT JOIN
            wpt_goods_master WITH(NOLOCK)
            ON gds_goods_id = tdh_goods_id
        LEFT JOIN
            wpt_goods_media_master WITH(NOLOCK)     -- gdm_media_cd 取得のため
            ON gdm_media_id = gds_media_id
        LEFT JOIN 
            wpt_goods_master_book WITH(NOLOCK)      -- gdb_publisher_cd 取得のため
            ON gdb_goods_id = tdh_goods_id
        -- Ver 09-13 2013/08/06 ADD E.Satoh 複数番線対応 ▲▲▲
	       where
		trn_shop_cd = @a_shop_cd
		and
-- ▼▼▼ 2014/04/11 update
--        (trn_work_type = '0202' OR trn_work_type = '0201' OR trn_work_type = '0204') -- 書籍/DISK/GAME発注
        (trn_work_type = '0202' OR trn_work_type = '0201' OR trn_work_type = '0204' OR trn_work_type = '0205') -- 書籍/DISK/GAME/文具発注
-- ▲▲▲ 2014/04/11 update
--		trn_work_type = '0202'  -- 書籍発注
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		trn_trn_date >= @a_start_date
		and
		trn_trn_date < @a_end_date
		and
		mpm_bookedi_cd = @a_tushin_id
		AND
		(mpm_edi_type = '2' OR mpm_edi_type = '3' OR mpm_edi_type = '4')   -- 書籍/DISK/GAMEＥＤＩシステム
--		mpm_edi_type = '2'   -- 書籍ＥＤＩシステム
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの
		and
		tdh_tel_type = '0'   -- 電話発注以外

	  SELECT @rc = @@ERROR,@row=@@rowcount
	  -- エラーチェック
	  If @rc <> 0 Begin
	    Set @err_msg = '9054,発注データ抽出エラー'
	    GOTO SP_ERR
	  End

	  -- ログ
	  Set @log_msg =
	        'E12U      : pg=[' + object_name(@@PROCID) + ']'
	        + ',t=[' + isnull(cast(@a_tushin_id as varchar),'') + ']'
	        + ',s=[' + isnull(cast(@a_shop_cd as varchar),'') + ']'
	        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
	        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
	  Exec P_LogMsg @log_msg

	-- イニシャル発注対象データ抽出
	INSERT wbe_edibook_up_control (
		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		)
	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = tdn_trn_id
		,e10_edi_line_no = tdn_line_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
		,e10_edi_shop_cd = @a_book_shop_cd
		,e10_tohan_group_cd = @a_tohan_group_cd
	       from
		wpv_transaction
		join
		wpt_transaction_initial
		  on
		  trn_trn_id = tin_trn_id
		join
		wpt_transaction_initial_details
		  on
		  trn_trn_id = tdn_trn_id
		join
		wpt_maker_supplier_master
		  on
		  tdn_supplier_id = mpm_supplier_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  tdn_trn_id = e10_edi_trn_id
		  and
		  tdn_line_no = e10_edi_line_no
	       where
		trn_shop_cd = @a_shop_cd
		and
		trn_work_type = '0200'  -- イニシャル発注
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		trn_trn_date >= @a_start_date
		and
		trn_trn_date < @a_end_date
		and
		mpm_bookedi_cd = @a_tushin_id
		and
		mpm_edi_type = '4'   -- GAMEＥＤＩシステム
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの

	  SELECT @rc = @@ERROR,@row=@@rowcount
	  -- エラーチェック
	  If @rc <> 0 Begin
	    Set @err_msg = '9054,イニシャル発注データ抽出エラー'
	    GOTO SP_ERR
	  End

	  -- ログ
	  Set @log_msg =
	        'E12U(Ini) : pg=[' + object_name(@@PROCID) + ']'
	        + ',t=[' + isnull(cast(@a_tushin_id as varchar),'') + ']'
	        + ',s=[' + isnull(cast(@a_shop_cd as varchar),'') + ']'
	        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
	        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
	  Exec P_LogMsg @log_msg
	  
      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------


      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

    -- データ転送
    -- (1)発注データ
      SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_hcu ( '
	+ '	 e12_edi_flag '
	+ '	,e12_server_webpos '
	+ '	,e12_dbname_webpos '
	+ '	,e12_shop_cd_webpos '
	+ '	,e12_shop_name_webpos '
	+ '	,e12_shop_cd_primary '
	+ '	,e12_shop_cd '
	+ '	,e12_tushin_id '
	+ '	,e12_hachu_date '
	+ '	,e12_hachu_time '
	+ '	,e12_hachu_kubun '
	+ '	,e12_goods_code_kubun '
	+ '	,e12_goods_code '
	+ '	,e12_year '
	+ '	,e12_hachu_count '
	+ '	,e12_kaiten_count '
	+ '	,e12_hachu_kanri_code1 '
	+ '	,e12_hachu_kanri_code2 '
	+ '	,e12_tana '
	+ '	,e12_dan '
	+ '	,e12_retu '
	+ '	,e12_goods_kubun '
	+ '	,e12_b_genre '
	+ '	,e12_m_genre '
	+ '	,e12_s_genre '
	+ '	,e12_order_no '
	+ '	,e12_order_memo '
	+ '	,e12_order_biko '
	+ '	,e12_cd_kikaku_bango '
	+ '	,e12_tohan_group_cd '
	+ '	,e12_floor_cd '         -- ADD Ver 09-14 2013/08/12 E.Satoh フロアコード対応
	+ '	,e12_rest_kubun '
	+ '	,e12_distribution_cd '
	+ '	,e12_hachu_denpyo_no '
	+ '	,e12_hachu_line_no '
	+ ' ,e12_ecole_hinban '
	+ '  )   '
	+ '  SELECT '
	+ '	 e12_edi_flag = ''0'' '          -- 未処理
	+ '	,e12_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e12_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e12_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e12_shop_name_webpos = e10_edi_shop_name_webpos '
-- 2012/08/27 update（星光堂の場合、親店舗コードにトーハングループCDをセット）
--	+ '	,e12_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e12_shop_cd_primary = '
	+ '  CASE WHEN e10_edi_tushin_id=''SK'' THEN e10_tohan_group_cd ELSE e10_edi_shop_cd END '
---------------------------------------------------------------------------------
	+ '	,e12_shop_cd = e10_edi_shop_cd '
	+ '	,e12_tushin_id = e10_edi_tushin_id '
	+ '	,e12_hachu_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e12_hachu_time = '
	+ '	              right(''00'' + cast(datepart(hh,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(mi,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(ss,trn_trn_date) as varchar), 2) '
	+ '	,e12_hachu_kubun = tdh_hachu_type '
	+ '	,e12_goods_code_kubun = '
	+ '	             case '
-- 2011/06/01 update
	--+ '	                when gds_goods_type = ''20'' then ''1'' '  -- 書籍
	--+ '	                when gds_goods_type = ''21'' then ''2'' '  -- 雑誌
	--+ '	                when gds_goods_type = ''30'' then ''5'' '  -- CD/DVD
	--+ '	                when gds_goods_type = ''31'' then ''5'' '  -- CD/DVD
	--+ '	                when gds_goods_type = ''40'' then ''G'' '  -- GAME
	+ '	                when plu_goods_type = ''20'' then ''1'' '  -- 書籍
	+ '	                when plu_goods_type = ''21'' then ''2'' '  -- 雑誌
	+ '	                when plu_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+ '	                when plu_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+ '	                when plu_goods_type = ''40'' then ''G'' '  -- GAME
--------------------
	+ '	                else ''0'' '  -- その他
	+ '	             end '
	+ '	,e12_goods_code = '
	+ '	             case '
-- 2011/06/01 update
	--+ '	                when gds_goods_type = ''20'' then gdb_isbn '           -- 書籍
	--+ '	                when gds_goods_type = ''21'' then gds_jan_cd '         -- 雑誌
	--+ '	                when gds_goods_type = ''30'' then gds_jan_cd '         -- CD/DVD
	--+ '	                when gds_goods_type = ''31'' then gds_jan_cd '         -- CD/DVD
	--+ '	                when gds_goods_type = ''40'' '                         -- GAME
	--+ '	                  then cast(gds_koyu_goods_cd as varchar(20)) '
	--+ '	                else gds_jan_cd '  -- その他
	+ '	                when plu_goods_type = ''20'' then dbo.F_Convert_JAN_ISBN(plu_jan_cd) '   -- 書籍(plu_isbnは13桁の為、利用不可)
	+ '	                when plu_goods_type = ''21'' then plu_jan_cd '         -- 雑誌
	+ '	                when plu_goods_type = ''30'' then plu_jan_cd '         -- CD/DVD
	+ '	                when plu_goods_type = ''31'' then plu_jan_cd '         -- CD/DVD
	+ '	                when plu_goods_type = ''40'' '                         -- GAME
	+ '	                  then cast(plu_koyu_goods_cd as varchar(20)) '
	+ '	                else plu_jan_cd '  -- その他
--------------------
	+ '	             end '
	+ '	,e12_year = null '
	+ '	,e12_hachu_count = tdh_goods_count '
	+ '	,e12_kaiten_count = null '
	+ '	,e12_hachu_kanri_code1 = '
	+ '	             case '
	+ '	                when  e10_edi_tushin_id = ''HB'' and tdh_hachu_type = ''2'' ' -- 博文補充の場合レシート番号セット
	+ '	                   then cast(trn_receipt_no as varchar) '
	+ '	                else null '
	+ '	             end '
	+ '	,e12_hachu_kanri_code2 = null '
	+ '	,e12_tana = null '
	+ '	,e12_dan = null '
	+ '	,e12_retu = null '
	+ '	,e12_goods_kubun = null '
	+ '	,e12_b_genre = null '
	+ '	,e12_m_genre = null '
	+ '	,e12_s_genre = null '
	+ '	,e12_order_no = cast(trn_receipt_no as varchar) '
	+ '	,e12_order_memo = '
	+ '		case '
	+ '		  when isnull(tdh_tana_cd,'''') <> '''' then tdh_tana_cd '
	+ '	            else tdh_member_order_memo '
	+ '	          end '
	+ '	,e12_order_biko = tdh_book_kanri_cd '
	+ '	,e12_cd_kikaku_bango = null '
	+ '	,e12_tohan_group_cd = e10_tohan_group_cd '
    -- Ver 09-14 2013/08/12 E.Satoh フロアコード対応
	+ '	,e12_floor_cd = fcc_floor_cd '              -- フロアコード変換テーブル
	+ '	,e12_rest_kubun = tdh_back_type '
	+ '	,e12_distribution_cd = dbo.F_Convert_Sales_Distribution(e10_edi_tushin_id,mlm_sales_cd) '
	+ '	,e12_hachu_denpyo_no = cast(trn_receipt_no as varchar) '
	+ '	,e12_hachu_line_no = tdh_line_no '
	-- 2014/01/10 エコール商品コード追加。
	+ '	,e12_ecole_hinban = RIGHT(''00000000'' + cast(tdh_koyu_goods_id as varchar(20)),8) '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction_hachu_details '
	+ '			  on '
	+ '			  e10_edi_trn_id = tdh_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = tdh_line_no '
	+ '		          join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  tdh_trn_id = trn_trn_id '
	+ '			join '
	+ '			wpt_transaction_hachu '
	+ '			  on '
	+ '			  trn_trn_id = tha_trn_id '
-- 2011/06/01 add --
	+ '			join '
	+ '			wpv_plu '
	+ '			  on '
	+ '			  plu_shop_cd = trn_shop_cd '
	+ '			  and '
	+ '			  plu_goods_id = tdh_goods_id '
--------------------
	+ '			left outer join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  tdh_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_book '
	+ '			  on '
	+ '			  tdh_goods_id = gdb_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_magazine '
	+ '			  on '
	+ '			  tdh_goods_id = gdz_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_disk '
	+ '			  on '
	+ '			  tdh_goods_id = gdd_goods_id '
	+ '			left outer join '
	+ '			wpt_maker_label_master '
	+ '			  on '
	+ '			  gdd_label_cd = mlm_label_cd '
	-- Ver 09-14 2013/08/12 E.Satoh フロアコード対応 ▼▼▼
	+ '			left outer join  '
	+ '			wpt_floor_cd_convert '
	+ '			  on '
	+ '			  fcc_tushin_id = e10_edi_tushin_id '     -- 取次コード
	+ '			  and '
	+ '			  fcc_edi_shop_cd = e10_edi_shop_cd '     -- 番線
	+ '			  and '
	+ '			  fcc_shop_cd = e10_edi_shop_cd_webpos '
	+ '			  and '
	+ '			  fcc_hantei_cd = LEFT(tdh_tana_cd,1) '   -- 変換元判定コード
	-- Ver 09-14 2013/08/12 E.Satoh フロアコード対応 ▲▲▲
	+ '		    where '
	+ '			e10_edi_flag = ''0'' '  -- 未処理のみ
-- ▼▼▼ 2013/07/23 add -- ▼▼▼ 2014/04/11 update

	+ '			and '
--	+ '			(trn_work_type = ''0202'' OR trn_work_type = ''0201'' OR trn_work_type = ''0204'') '  -- 書籍/DISK/GAME発注
	+ '			(trn_work_type = ''0202'' OR trn_work_type = ''0201'' OR trn_work_type = ''0204'' OR trn_work_type = ''0205'') '  -- 書籍/DISK/GAME/文具発注
-- ▲▲▲ 2013/07/23 add -- ▲▲▲ 2014/04/11 update
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '

      Exec (@a_sql)
      SELECT @rc = @@ERROR,@row=@@rowcount
      -- エラーチェック
      If @rc <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- ログ
      Set @log_msg =
        'E12U_SET      : pg=[' + object_name(@@PROCID) + ']'
        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
     Exec P_LogMsg @log_msg

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)

               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_hachu_details 
		  on 
		  e10_edi_trn_id = tdh_trn_id 
		  and 
		  e10_edi_line_no = tdh_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdh_trn_id = trn_trn_id 
		join 
		wpt_transaction_hachu 
		  on 
		  trn_trn_id = tha_trn_id 
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_hachu_details 
		  on 
		  e10_edi_trn_id = tdh_trn_id 
		  and 
		  e10_edi_line_no = tdh_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdh_trn_id = trn_trn_id 
		join 
		wpt_transaction_hachu 
		  on 
		  trn_trn_id = tha_trn_id 
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

    -- (2)イニシャル発注
      SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_hcu ( '
	+ '	 e12_edi_flag '
	+ '	,e12_server_webpos '
	+ '	,e12_dbname_webpos '
	+ '	,e12_shop_cd_webpos '
	+ '	,e12_shop_name_webpos '
	+ '	,e12_shop_cd_primary '
	+ '	,e12_shop_cd '
	+ '	,e12_tushin_id '
	+ '	,e12_hachu_date '
	+ '	,e12_hachu_time '
	+ '	,e12_goods_code_kubun '
	+ '	,e12_goods_code '
	+ '	,e12_hachu_count '
	+ '	,e12_hachu_denpyo_no '
	+ '	,e12_hachu_line_no '
	+ '	,e12_chumon_denpyo_no '
	+ '	,e12_chumon_line_no '
	+ '  )   '
	+ '  SELECT '
	+ '	 e12_edi_flag = ''0'' '          -- 未処理
	+ '	,e12_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e12_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e12_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e12_shop_name_webpos = e10_edi_shop_name_webpos '
	+ '	,e12_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e12_shop_cd = e10_edi_shop_cd '
	+ '	,e12_tushin_id = e10_edi_tushin_id '
	+ '	,e12_hachu_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e12_hachu_time = '
	+ '	              right(''00'' + cast(datepart(hh,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(mi,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(ss,trn_trn_date) as varchar), 2) '
	+ '	,e12_goods_code_kubun = ''G'' '
	+ '	,e12_goods_code = cast(gds_koyu_goods_cd as varchar(20)) '
	+ '	,e12_hachu_count = tdn_hachu_count '
	+ '	,e12_hachu_denpyo_no = cast(trn_receipt_no as varchar) '
	+ '	,e12_hachu_line_no = tdn_line_no '
	+ '	,e12_chumon_denpyo_no = tin_annai_no '
	+ '	,e12_chumon_line_no = tdn_annai_line_no '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction_initial_details '
	+ '			  on '
	+ '			  e10_edi_trn_id = tdn_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = tdn_line_no '
	+ '		          join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  tdn_trn_id = trn_trn_id '
	+ '			join '
	+ '			wpt_transaction_initial '
	+ '			  on '
	+ '			  trn_trn_id = tin_trn_id '
	+ '			left outer join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  tdn_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_disk '
	+ '			  on '
	+ '			  tdn_goods_id = gdd_goods_id '
	+ '			left outer join '
	+ '			wpt_maker_label_master '
	+ '			  on '
	+ '			  gdd_label_cd = mlm_label_cd '
	+ '		    where '
	+ '			e10_edi_flag = ''0'' '  -- 未処理のみ
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '

      Exec (@a_sql)
      SELECT @rc = @@ERROR,@row=@@rowcount
      -- エラーチェック
      If @rc <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- ログ
      Set @log_msg =
        'E12U_SET(Ini) : pg=[' + object_name(@@PROCID) + ']'
        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
     Exec P_LogMsg @log_msg

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)

               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_initial_details 
		  on 
		  e10_edi_trn_id = tdn_trn_id 
		  and 
		  e10_edi_line_no = tdn_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdn_trn_id = trn_trn_id 
		join 
		wpt_transaction_initial 
		  on 
		  trn_trn_id = tin_trn_id 
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_initial_details 
		  on 
		  e10_edi_trn_id = tdn_trn_id 
		  and 
		  e10_edi_line_no = tdn_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdn_trn_id = trn_trn_id 
		join 
		wpt_transaction_initial 
		  on 
		  trn_trn_id = tin_trn_id 
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9053,発注ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_HACHU_END:


--=================================================
-- 上り定期改正処理
--=================================================

UP_TEIKI:

  Declare @e13_edi_flag char (1)

  Declare @e13_edi_timestamp timestamp
  Declare @e13_edi_create_date datetime 
  Declare @e13_edi_update_date datetime 
  Declare @e13_edi_file_line_no int 
  Declare @e13_edi_meisai_no int 
  Declare @e13_edi_error_msg varchar (200)
  Declare @e13_server_webpos varchar (100)
  Declare @e13_dbname_webpos varchar (100)
  Declare @e13_shop_cd_webpos varchar (10)
  Declare @e13_shop_name_webpos varchar (100)
  Declare @e13_seq_no char (5)
  Declare @e13_shop_cd_primary varchar (10)
  Declare @e13_shop_cd varchar (10)
  Declare @e13_tushin_id char (2)
  Declare @e13_teiki_kaisei_date char (8)
  Declare @e13_kihon_zasshi_code char (5)
  Declare @e13_zasshi_code char (5)
  Declare @e13_nen_gatu_gou char (6)
  Declare @e13_request_count int 
  Declare @e13_reserve_count int 

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9061,定改データ削除不正'
    GOTO SP_ERR
  End


  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
            where
               bes_up_hpn_flag =
                  case
                     when @edi_type = '11U' then '1'
                     else bes_up_hpn_flag
                  end
               and
               bes_up_hcu_flag =
                  case
                     when @edi_type = '12U' then '1'
                     else bes_up_hcu_flag
                  end
               and
               bes_up_tka_flag =
                  case
                     when @edi_type = '13U' then '1'
                     else bes_up_tka_flag
                  end
               and
               bes_up_urh_flag =
                  case
                     when @edi_type = '14U' then '1'
                     else bes_up_urh_flag
                  end
               and
               bes_up_urd_flag =
                  case
                     when @edi_type = '15U' then '1'
                     else bes_up_urd_flag
                  end

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	INSERT wbe_edibook_up_control (

		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		)
	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = tdh_trn_id
		,e10_edi_line_no = tdh_line_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
		,e10_edi_shop_cd = @a_book_shop_cd
		,e10_tohan_group_cd = @a_tohan_group_cd
	       from
		wpv_transaction
		join
		wpt_transaction_hachu
		  on
		  trn_trn_id = tha_trn_id
		join
		wpt_transaction_hachu_details
		  on
		  trn_trn_id = tdh_trn_id
		join
		wpt_maker_supplier_master
		  on
		  tdh_supplier_id = mpm_supplier_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  tdh_trn_id = e10_edi_trn_id
		  and
		  tdh_line_no = e10_edi_line_no
	       where
		trn_shop_cd = @a_shop_cd
		and
		trn_work_type = '0203'  -- 定期改正
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		trn_trn_date >= @a_start_date
		and
		trn_trn_date < @a_end_date
		and
		mpm_bookedi_cd = @a_tushin_id
		and
		mpm_edi_type = '2'   -- 書籍ＥＤＩシステム
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの
		and
		tdh_tel_type = '0'   -- 電話発注以外

	  -- エラーチェック
	  If @@ERROR <> 0 Begin
	    Set @err_msg = '9064,定改データ抽出エラー'
	    GOTO SP_ERR
	  End

      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd

              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs


      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

      -- データ転送
      SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_tka ( '
	+ '	 e13_edi_flag '
	+ '	,e13_server_webpos '
	+ '	,e13_dbname_webpos '
	+ '	,e13_shop_cd_webpos '
	+ '	,e13_shop_name_webpos '
	+ '	,e13_shop_cd_primary '
	+ '	,e13_shop_cd '
	+ '	,e13_tushin_id '
	+ '	,e13_teiki_kaisei_date '
	+ '	,e13_kihon_zasshi_code '
	+ '	,e13_zasshi_code '
	+ '	,e13_nen_gatu_gou '
	+ '	,e13_request_count '
	+ '	,e13_reserve_count '
	+ '	,e13_tohan_group_cd '
	+ '  )   '
	+ '  SELECT '
	+ '	 e13_edi_flag = ''0'' '          -- 未処理
	+ '	,e13_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e13_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e13_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e13_shop_name_webpos = e10_edi_shop_name_webpos '
	+ '	,e13_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e13_shop_cd = e10_edi_shop_cd '
	+ '	,e13_tushin_id = e10_edi_tushin_id '
	+ '	,e13_teiki_kaisei_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e13_kihon_zasshi_code = gdz_kihon_magazinecode '
	+ '	,e13_zasshi_code = substring(gdz_magazinecode_and_gatugo,1,5) '
	+ '	,e13_nen_gatu_gou = ' 
	+ '		    substring(cast(datepart(yyyy,getdate()) as varchar),1,3) '
	+ '		    + substring(gds_jan_cd,12,1) '
	+ '	,e13_request_count = tdh_goods_count '
	+ '	,e13_reserve_count = tdh_goods_yoyaku_count '
	+ '	,e13_tohan_group_cd = e10_tohan_group_cd '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction_hachu_details '
	+ '			  on '
	+ '			  e10_edi_trn_id = tdh_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = tdh_line_no '
	+ '		          join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  tdh_trn_id = trn_trn_id '
	+ '			join '
	+ '			wpt_transaction_hachu '
	+ '			  on '
	+ '			  trn_trn_id = tha_trn_id '
	+ '			left outer join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  tdh_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_book '
	+ '			  on '
	+ '			  tdh_goods_id = gdb_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_magazine '
	+ '			  on '
	+ '			  tdh_goods_id = gdz_goods_id '
	+ '		    where '
	+ '			e10_edi_flag = ''0'' '  -- 未処理のみ
-- ▼▼▼ 2013/07/23 add
	+ '			and '
	+ '			trn_work_type = ''0203'' '  -- 定期改正
-- ▲▲▲ 2013/07/23 add
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '

      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_hachu_details
		  on
		  e10_edi_trn_id = tdh_trn_id
		  and
		  e10_edi_line_no = tdh_line_no
	          join

		wpt_transaction
		  on
		  tdh_trn_id = trn_trn_id
		join
		wpt_transaction_hachu
		  on
		  trn_trn_id = tha_trn_id
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_hachu_details
		  on
		  e10_edi_trn_id = tdh_trn_id
		  and
		  e10_edi_line_no = tdh_line_no
	          join
		wpt_transaction
		  on
		  tdh_trn_id = trn_trn_id
		join
		wpt_transaction_hachu
		  on
		  trn_trn_id = tha_trn_id
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9063,定改ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_TEIKI_END:


--=================================================
-- 上り売上処理(ヘッダ)
--=================================================
-- 2011/10/27 M.Nakano
UP_URIAGE_HEADER:

  Declare @e14_edi_flag char (1)
  Declare @e14_edi_timestamp timestamp
  Declare @e14_edi_create_date datetime 
  Declare @e14_edi_update_date datetime 
  Declare @e14_edi_file_line_no int 
  Declare @e14_edi_error_msg varchar (200)
  Declare @e14_server_webpos varchar (100)
  Declare @e14_dbname_webpos varchar (100)
  Declare @e14_shop_cd_webpos varchar (10)
  Declare @e14_shop_name_webpos varchar (100)
  Declare @e14_shop_cd_primary varchar (10)
  Declare @e14_shop_cd varchar (10)
  Declare @e14_tushin_id char (2)

  Declare @e14_pos_no int 
  Declare @e14_receipt_no int 
  Declare @e14_uriage_date char (8)
  Declare @e14_youbi char(1)
  Declare @e14_uriage_time char (6)
  Declare @e14_tenki char(2)
  Declare @e14_kyakusou char (2)
  Declare @e14_nebiki money
  Declare @e14_waribiki money
  Declare @e14_intax money 
  Declare @e14_extax money 
  Declare @e14_tanka_sign char (1)
  Declare @e14_uriage_total money 
  Declare @e14_uriage_total_sign char (1)
  Declare @e14_uriage_flag char (1)
  Declare @e14_stock_flag char (1)
  Declare @e14_kyaku_flag char (1)
  Declare @e14_tohan_group_cd varchar(20)
  Declare @e14_member_cd varchar(20)
  Declare @e14_point_add int
  Declare @e14_point_add_sign char(1)
  Declare @e14_point_use int
  Declare @e14_point_use_sign char(1)
  Declare @e14_uriage_count int
  Declare @e14_uriage_count_sign char(1)

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9071,売上ヘッダデータ削除不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
              ,mpm_edi_type
              ,bes_tohan_ur_format_type
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
               join
               wpt_maker_supplier_master
                 on
                 bes_bookedi_cd = mpm_bookedi_cd
                 and mpm_shop_cd IS NULL
            where
               bes_up_hpn_flag =
                  case
                     when @edi_type = '11U' then '1'
                     else bes_up_hpn_flag
                  end

               and
               bes_up_hcu_flag =
                  case
                     when @edi_type = '12U' then '1'
                     else bes_up_hcu_flag
                  end
               and
               bes_up_tka_flag =
                  case
                     when @edi_type = '13U' then '1'
                     else bes_up_tka_flag
                  end
               and
               bes_up_urh_flag =
                  case
                     when @edi_type = '14U' then '1'
                     else bes_up_urh_flag
                  end
               and
               bes_up_urd_flag =
                  case
                     when @edi_type = '15U' then '1'
                     else bes_up_urd_flag
                  end

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
              ,@a_tohan_ur_format_type

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
	INSERT wbe_edibook_up_control (
		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		,e10_tohan_ur_format_type
		)

	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = trn_trn_id
		,e10_edi_line_no = trn_receipt_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
		,e10_edi_shop_cd = @a_book_shop_cd
		,e10_tohan_group_cd = @a_tohan_group_cd
		,e10_tohan_ur_format_type = @a_tohan_ur_format_type
	       from
		wpv_transaction
		join
		wpt_transaction_uriage
		  on
		  trn_trn_id = tur_trn_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  trn_trn_id = e10_edi_trn_id
		  and
		  trn_receipt_no = e10_edi_line_no
	       where
		trn_shop_cd = @a_shop_cd
		and
		trn_work_type in ( '0000','0001' )  -- 売上、売上返金
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		trn_create_date >= @a_start_date
		and
		trn_create_date < @a_end_date
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの

	  -- エラーチェック
	  If @@ERROR <> 0 Begin
	    Set @err_msg = '9074,売上ヘッダデータ抽出エラー'
	    GOTO SP_ERR
	  End

      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
              ,@a_tohan_ur_format_type
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------

      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

      -- データ転送
		-- 光和ＥＤＩ対応
     SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_urh ( '
	+ '	 e14_edi_flag '
	+ '	,e14_server_webpos '
	+ '	,e14_dbname_webpos '
	+ '	,e14_shop_cd_webpos '
	+ '	,e14_shop_name_webpos '
	+ '	,e14_shop_cd_primary '
	+ '	,e14_shop_cd '
	+ '	,e14_tushin_id '
	+ '	,e14_pos_no '
	+ '	,e14_receipt_no '
	+ '	,e14_uriage_date '
	+ '	,e14_youbi '
	+ '	,e14_uriage_time '
	+ '	,e14_tenki '
	+ '	,e14_kyakusou '
	+ '	,e14_nebiki '
	+ '	,e14_waribiki '
	+ '	,e14_intax '
	+ '	,e14_extax '
	+ '	,e14_tax_sign '
	+ '	,e14_uriage_total '
	+ '	,e14_uriage_total_sign '
	+ '	,e14_uriage_flag '
	+ '	,e14_stock_flag '
	+ '	,e14_kyaku_flag '
	+ '	,e14_tohan_group_cd '
	+ '	,e14_member_cd '
	+ '	,e14_point_add '
	+ '	,e14_point_add_sign '
	+ '	,e14_point_use '
	+ '	,e14_point_use_sign '
	+ '	,e14_uriage_count '
	+ '	,e14_uriage_count_sign '
	+ '  )   '
	+ '  SELECT '
	+ '	 e14_edi_flag = ''0'' '          -- 未処理
	+ '	,e14_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e14_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e14_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e14_shop_name_webpos = e10_edi_shop_name_webpos '
	+ '	,e14_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e14_shop_cd = e10_edi_shop_cd '
	+ '	,e14_tushin_id = e10_edi_tushin_id '
	+ '	,e14_pos_no = trn_pos_no '
	+ '	,e14_receipt_no = trn_receipt_no '
	+ '	,e14_uriage_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e14_youbi = CAST(DATEPART(weekday, trn_trn_date) AS char) '
	+ '	,e14_uriage_time = '
	+ '	              right(''00'' + cast(datepart(hh,trn_pos_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(mi,trn_pos_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(ss,trn_pos_date) as varchar), 2) '
	+ '	,e14_tenki = '''' '
	+ '	,e14_kyakusou = tur_kyaku_cd '
	+ '	,e14_nebiki = ABS(tur_discount_sum) '
	+ '	,e14_waribiki = 0 '
	+ '	,e14_intax = ABS(tur_intax_tax_sum) '
	+ '	,e14_extax = ABS(tur_extax_tax_sum) '
	+ '	,e14_tax_sign = '
	+ '	             case '
	+ '	                when ( trn_work_type = ''0001'' and tur_tax_finish >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0001'' and tur_tax_finish >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_tax_finish < 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_tax_finish < 0 ) '
	+ '	                   then ''-'' '
	+ '	                   else ''+'' '
	+ '	             End '
	+ '	,e14_uriage_total = ABS(tur_goods_sum) '
	+ '	,e14_uriage_total_sign = '
	+ '	             case '
	+ '	                when ( trn_work_type = ''0001'' and tur_goods_sum >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0001'' and tur_goods_sum >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_goods_sum < 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_goods_sum < 0 ) '
	+ '	                   then ''-'' '
	+ '	                   else ''+'' '
	+ '	             End '
	+ '	,e14_uriage_flag = '''' '
	+ '	,e14_stock_flag = '''' '
	+ '	,e14_kyaku_flag = '''' '
	+ '	,e14_tohan_group_cd = e10_tohan_group_cd '
	+ '	,e14_member_cd = trn_member_cd '
	+ '	,e14_point_add = ABS(tur_point_add) '
	+ '	,e14_point_add_sign = '
	+ '	             case '
	+ '	                when ( trn_work_type = ''0001'' and tur_point_add >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0001'' and tur_point_add >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_point_add < 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_point_add < 0 ) '
	+ '	                   then ''-'' '
	+ '	                   else ''+'' '
	+ '	             End '
	+ '	,e14_point_use = ABS(tur_point_use) '
	+ '	,e14_point_use_sign = '
	+ '	             case '
	+ '	                when ( trn_work_type = ''0001'' and tur_point_use >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0001'' and tur_point_use >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_point_use < 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_point_use < 0 ) '
	+ '	                   then ''-'' '
	+ '	                   else ''+'' '
	+ '	             End '
	+ '	,e14_uriage_count = ABS(tur_goods_count) '
	+ '	,e14_uriage_count_sign = '
	+ '	             case '
	+ '	                when ( trn_work_type = ''0001'' and tur_goods_count >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0001'' and tur_goods_count >= 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_goods_count < 0 ) '
	+ '	                        or '
	+ '	                        ( trn_work_type = ''0000'' and tur_goods_count < 0 ) '
	+ '	                   then ''-'' '
	+ '	                   else ''+'' '
	+ '	             End '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  e10_edi_trn_id = trn_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = trn_receipt_no '
	+ '			join '
	+ '			wpt_transaction_uriage '
	+ '			  on '
	+ '			  trn_trn_id = tur_trn_id '
	+ '		    where '
	+ '			e10_edi_flag = ''0'' ' -- 未処理のみ
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '

      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		wbe_edibook_up_control
		join
		wpt_transaction
		  on
		  e10_edi_trn_id = trn_trn_id
		  and
		  e10_edi_line_no = trn_receipt_no
		join
		wpt_transaction_uriage
		  on
		  trn_trn_id = tur_trn_id
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control
		join
		wpt_transaction
		  on
		  e10_edi_trn_id = trn_trn_id
		  and
		  e10_edi_line_no = trn_receipt_no
		join
		wpt_transaction_uriage
		  on
		  trn_trn_id = tur_trn_id
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9073,売上ヘッダログ出力エラー'

    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_URIAGE_HEADER_END:

--=================================================
-- 上り売上処理(明細)
--=================================================
UP_URIAGE:

  Declare @e15_edi_flag char (1)
  Declare @e15_edi_timestamp timestamp
  Declare @e15_edi_create_date datetime 
  Declare @e15_edi_update_date datetime 
  Declare @e15_edi_file_line_no int 
  Declare @e15_edi_error_msg varchar (200)
  Declare @e15_server_webpos varchar (100)
  Declare @e15_dbname_webpos varchar (100)
  Declare @e15_shop_cd_webpos varchar (10)
  Declare @e15_shop_name_webpos varchar (100)
  Declare @e15_shop_cd_primary varchar (10)
  Declare @e15_shop_cd varchar (10)
  Declare @e15_tushin_id char (2)

  Declare @e15_pos_no int 
  Declare @e15_receipt_no int 
  Declare @e15_uriage_date char (8)
  Declare @e15_uriage_time char (6)
  Declare @e15_line_no int 
  Declare @e15_goods_code_kubun char (1)
  Declare @e15_goods_code varchar (20)
  Declare @e15_jan_cd varchar (20)

  Declare @e15_tanka money 
  Declare @e15_tanka_sign char (1)
  Declare @e15_count int 
  Declare @e15_count_sign char (1)
  Declare @e15_waribiki money 
  Declare @e15_nebiki money 
  Declare @e15_tax money 
  Declare @e15_tax_sign char (1)
  Declare @e15_tax_type char (1)
  Declare @e15_baika money 
  Declare @e15_baika_sign char (1)
  Declare @e15_stock_count int 
  Declare @e15_c_code char (4)
  Declare @e15_hontai_kakaku money 
  Declare @e15_point_add int
  Declare @e15_point_add_sign char(1)

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9071,売上データ削除不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
              ,mpm_edi_type
              ,bes_tohan_ur_format_type
			  ,bes_tonets_v_up_flag				-- 2013/11/21 add
			  ,bes_tonets_v_dw_flag				-- 2013/11/21 add
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
               join
               wpt_maker_supplier_master
                 on
                 bes_bookedi_cd = mpm_bookedi_cd
                 and mpm_shop_cd IS NULL
            where
               bes_up_hpn_flag =
                  case
                     when @edi_type = '11U' then '1'
                     else bes_up_hpn_flag
                  end

               and
               bes_up_hcu_flag =
                  case
                     when @edi_type = '12U' then '1'
                     else bes_up_hcu_flag
                  end
               and
               bes_up_tka_flag =
                  case
                     when @edi_type = '13U' then '1'
                     else bes_up_tka_flag
                  end
               and
               bes_up_urh_flag =
                  case
                     when @edi_type = '14U' then '1'
                     else bes_up_urh_flag
                  end
               and
               bes_up_urd_flag =
                  case
                     when @edi_type = '15U' then '1'
                     else bes_up_urd_flag
                  end

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
              ,@a_tohan_ur_format_type
              ,@a_tonets_v_up_flag				-- 2013/11/21 add
              ,@a_tonets_v_dw_flag				-- 2013/11/21 add

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	-- フォーマット区分＝"1"（15B）
	If @a_tohan_ur_format_type = '1' Begin
		
		If @a_tushin_id = 'TM' Begin
			-- TMフォーマット
			INSERT wbe_edibook_up_control (
				 e10_edi_tushin_id
				,e10_edi_trn_id
				,e10_edi_line_no
				,e10_edi_flag
				,e10_edi_create_date
				,e10_edi_shop_cd_webpos
				,e10_edi_shop_name_webpos
				,e10_edi_shop_cd
				,e10_tohan_group_cd
				,e10_tohan_ur_format_type
				,e10_tonets_v_up_flag			-- 2013/11/21 add
				,e10_tonets_v_dw_flag			-- 2013/11/21 add
				)

			    SELECT
				 e10_edi_tushin_id = @a_tushin_id
				,e10_edi_trn_id = tdu_trn_id
				,e10_edi_line_no = tdu_line_no
				,e10_edi_flag = '0'     -- 未処理
				,e10_edi_create_date = getdate()
				,e10_edi_shop_cd_webpos = @a_shop_cd
				,e10_edi_shop_name_webpos = @a_shop_name
				,e10_edi_shop_cd = @a_book_shop_cd
				,e10_tohan_group_cd = @a_tohan_group_cd
				,e10_tohan_ur_format_type = @a_tohan_ur_format_type
                ,e10_tonets_v_up_flag = @a_tonets_v_up_flag			-- 2013/11/21 add
                ,e10_tonets_v_dw_flag = @a_tonets_v_dw_flag			-- 2013/11/21 add
			       from
				wpv_transaction
				join
				wpt_transaction_uriage
				  on
				  trn_trn_id = tur_trn_id
				join
				wpt_transaction_uriage_details
				  on
				  trn_trn_id = tdu_trn_id
				join
				wpt_goods_master 
				  on 
				  tdu_goods_id = gds_goods_id
				left outer join
				wbe_edibook_up_control
				  on
				  @a_tushin_id = e10_edi_tushin_id
				  and
				  tdu_trn_id = e10_edi_trn_id
				  and
				  tdu_line_no = e10_edi_line_no
			       where
				trn_shop_cd = @a_shop_cd
				and
				trn_work_type in ( '0000','0001' )  -- 売上、売上返金
				and
				trn_denpyo_type = '0'  -- 黒伝
				and
				trn_create_date >= @a_start_date
				and
				trn_create_date < convert( datetime , convert(varchar,getdate(),111) ) 
				and
				e10_edi_trn_id is null  -- コピーしていないもの
				and
				e10_edi_line_no is null  -- コピーしていないもの
				and
				tdu_set_type <> '9'  -- セット親以外
			and
				tdu_jan_cd is not null  -- JANコードnull以外
		-- 2009/03/12
		-- 取次のEDI区分により商品を選別
		--		and
		--		tdu_goods_type in ( '20' , '21' )  -- 書籍・雑誌のみ
				and
				((@a_supplier_edi_type = '2' and tdu_goods_type in ('20', '21'))      -- 書籍・雑誌のみ
-- ▼▼▼ 2014/03/17 update（商材区分＝31:文具の為、TMWには送信しないように修正）
--				or (@a_supplier_edi_type = '3' and tdu_goods_type in ('30', '31')))   -- CD・DVDのみ
				or (@a_supplier_edi_type = '3' and tdu_goods_type in ('30')))   -- CD・DVDのみ
-- ▲▲▲ 2014/03/17 update
				and
				gds_jan_cd is not null  -- JANが設定されているもの
				and
				gds_gross_flag = '0'  -- グロス以外
		End
		
		If @a_tushin_id <> 'TM' AND @a_tushin_id <> 'SI' Begin -- 2016/12/05 @a_tushin_id <> 'SI'の条件を追加
			-- 元の集計クエリ
			INSERT wbe_edibook_up_control (
				 e10_edi_tushin_id
				,e10_edi_trn_id
				,e10_edi_line_no
				,e10_edi_flag
				,e10_edi_create_date
				,e10_edi_shop_cd_webpos
				,e10_edi_shop_name_webpos
				,e10_edi_shop_cd
				,e10_tohan_group_cd
				,e10_tohan_ur_format_type
                ,e10_tonets_v_up_flag			-- 2013/11/21 add
                ,e10_tonets_v_dw_flag			-- 2013/11/21 add
				)

			    SELECT
				 e10_edi_tushin_id = @a_tushin_id
				,e10_edi_trn_id = tdu_trn_id
				,e10_edi_line_no = tdu_line_no
				,e10_edi_flag = '0'     -- 未処理
				,e10_edi_create_date = getdate()
				,e10_edi_shop_cd_webpos = @a_shop_cd
				,e10_edi_shop_name_webpos = @a_shop_name
				,e10_edi_shop_cd = @a_book_shop_cd
				,e10_tohan_group_cd = @a_tohan_group_cd
				,e10_tohan_ur_format_type = @a_tohan_ur_format_type
                ,e10_tonets_v_up_flag = @a_tonets_v_up_flag			-- 2013/11/21 add
                ,e10_tonets_v_dw_flag = @a_tonets_v_dw_flag			-- 2013/11/21 add
			       from
				wpv_transaction
				join
				wpt_transaction_uriage
				  on
				  trn_trn_id = tur_trn_id
				join
				wpt_transaction_uriage_details
				  on
				  trn_trn_id = tdu_trn_id
				join
				wpt_goods_master 
				  on 
				  tdu_goods_id = gds_goods_id
				left outer join
				wbe_edibook_up_control
				  on
				  @a_tushin_id = e10_edi_tushin_id
				  and
				  tdu_trn_id = e10_edi_trn_id
				  and
				  tdu_line_no = e10_edi_line_no
			       where
				trn_shop_cd = @a_shop_cd
				and
				trn_work_type in ( '0000','0001' )  -- 売上、売上返金
				and
				trn_denpyo_type = '0'  -- 黒伝
				and
				trn_create_date >= @a_start_date
				and
				trn_create_date < @a_end_date
				and
				e10_edi_trn_id is null  -- コピーしていないもの
				and
				e10_edi_line_no is null  -- コピーしていないもの
				and
				tdu_set_type <> '9'  -- セット親以外
				and
				tdu_jan_cd is not null  -- JANコードnull以外
		-- 2009/03/12
		-- 取次のEDI区分により商品を選別
		--		and
		--		tdu_goods_type in ( '20' , '21' )  -- 書籍・雑誌のみ
				and
				((@a_supplier_edi_type = '2' and tdu_goods_type in ('20', '21'))      -- 書籍・雑誌のみ
				or (@a_supplier_edi_type = '3' and tdu_goods_type in ('30', '31')))   -- CD・DVDのみ
				and
				gds_jan_cd is not null  -- JANが設定されているもの
				and
				gds_gross_flag = '0'  -- グロス以外
		End
		-- 2016/12/05 追加　開始
		If  @a_tushin_id = 'SI' Begin 
			-- 元の集計クエリ
			INSERT wbe_edibook_up_control (
				 e10_edi_tushin_id
				,e10_edi_trn_id
				,e10_edi_line_no
				,e10_edi_flag
				,e10_edi_create_date
				,e10_edi_shop_cd_webpos
				,e10_edi_shop_name_webpos
				,e10_edi_shop_cd
				,e10_tohan_group_cd
				,e10_tohan_ur_format_type
                ,e10_tonets_v_up_flag			-- 2013/11/21 add
                ,e10_tonets_v_dw_flag			-- 2013/11/21 add
				)

			    SELECT
				 e10_edi_tushin_id = @a_tushin_id
				,e10_edi_trn_id = tdu_trn_id
				,e10_edi_line_no = tdu_line_no
				,e10_edi_flag = '0'     -- 未処理
				,e10_edi_create_date = getdate()
				,e10_edi_shop_cd_webpos = @a_shop_cd
				,e10_edi_shop_name_webpos = @a_shop_name
				,e10_edi_shop_cd = @a_book_shop_cd
				,e10_tohan_group_cd = @a_tohan_group_cd
				,e10_tohan_ur_format_type = @a_tohan_ur_format_type
                ,e10_tonets_v_up_flag = @a_tonets_v_up_flag			-- 2013/11/21 add
                ,e10_tonets_v_dw_flag = @a_tonets_v_dw_flag			-- 2013/11/21 add
			       from
				wpv_transaction
				join
				wpt_transaction_uriage
				  on
				  trn_trn_id = tur_trn_id
				join
				wpt_transaction_uriage_details
				  on
				  trn_trn_id = tdu_trn_id
				join
				wpt_goods_master 
				  on 
				  tdu_goods_id = gds_goods_id
				left outer join
				wbe_edibook_up_control
				  on
				  @a_tushin_id = e10_edi_tushin_id
				  and
				  tdu_trn_id = e10_edi_trn_id
				  and
				  tdu_line_no = e10_edi_line_no
			       where
				trn_shop_cd = @a_shop_cd
				and
				trn_work_type in ( '0000','0001' )  -- 売上、売上返金
				and
				trn_denpyo_type = '0'  -- 黒伝
				and
				trn_create_date >= @a_start_date
				and
				trn_create_date < @a_end_date
				and
				e10_edi_trn_id is null  -- コピーしていないもの
				and
				e10_edi_line_no is null  -- コピーしていないもの
				and
				tdu_set_type <> '9'  -- セット親以外
				and
				tdu_jan_cd is not null  -- JANコードnull以外
				and 
				substring(ltrim(rtrim(tdu_jan_cd)),1,1) <> '2'  -- 2016/12/05　追加
		-- 2009/03/12
		-- 取次のEDI区分により商品を選別
		--		and
		--		tdu_goods_type in ( '20' , '21' )  -- 書籍・雑誌のみ
				and
				((@a_supplier_edi_type = '2' and tdu_goods_type in ('20', '21'))      -- 書籍・雑誌のみ
				or (@a_supplier_edi_type = '3' and tdu_goods_type in ('30', '31')))   -- CD・DVDのみ
				--and
				--gds_jan_cd is not null  -- JANが設定されているもの　-- 2016/12/05 削除
				and
				gds_gross_flag = '0'  -- グロス以外
		End
		-- 2016/12/05 追加　終了
-- ▼▼▼ 2014/08/19 add
-- （トーハンTONETS-V上り実装店舗の場合で、あらかじめ設定された店舗への移動出庫データを売上データとして送信する）
		If @a_tushin_id = 'TH' AND @a_tonets_v_up_flag = '1' Begin
			-- 元の集計クエリ
			INSERT wbe_edibook_up_control (
				 e10_edi_tushin_id
				,e10_edi_trn_id
				,e10_edi_line_no
				,e10_edi_flag
				,e10_edi_create_date
				,e10_edi_shop_cd_webpos
				,e10_edi_shop_name_webpos
				,e10_edi_shop_cd
				,e10_tohan_group_cd
				,e10_tohan_ur_format_type
                ,e10_tonets_v_up_flag			-- 2013/11/21 add
                ,e10_tonets_v_dw_flag			-- 2013/11/21 add
				)

			    SELECT
				 e10_edi_tushin_id = @a_tushin_id
				,e10_edi_trn_id = tod_trn_id
				,e10_edi_line_no = tod_line_no
				,e10_edi_flag = '0'     -- 未処理
				,e10_edi_create_date = getdate()
				,e10_edi_shop_cd_webpos = @a_shop_cd
				,e10_edi_shop_name_webpos = @a_shop_name
				,e10_edi_shop_cd = @a_book_shop_cd
				,e10_tohan_group_cd = @a_tohan_group_cd
				,e10_tohan_ur_format_type = @a_tohan_ur_format_type
                ,e10_tonets_v_up_flag = @a_tonets_v_up_flag			-- 2013/11/21 add
                ,e10_tonets_v_dw_flag = @a_tonets_v_dw_flag			-- 2013/11/21 add
			       from
				wpt_transaction WITH(NOLOCK)						-- 移動出庫取消は、売上マイナスとして送信するので、wpv_transactionではなくwpt_transactionとする
				join
				wpt_transaction_inout WITH(NOLOCK)
				  on
				  trn_trn_id = tso_trn_id
				join
				wpt_transaction_inout_details WITH(NOLOCK)
				  on
				  trn_trn_id = tod_trn_id
				join
				wpt_tonets_move_shop_setting WITH(NOLOCK)		-- TONETS売上用移動店舗設定
				  on
				  trn_shop_cd = tms_shop_cd
				  and
				  tso_move_shop_cd = tms_move_shop_cd
				join
				wpt_goods_master WITH(NOLOCK)
				  on 
				  tod_goods_id = gds_goods_id
				left outer join
				wbe_edibook_up_control WITH(NOLOCK)
				  on
				  @a_tushin_id = e10_edi_tushin_id
				  and
				  tod_trn_id = e10_edi_trn_id
				  and
				  tod_line_no = e10_edi_line_no
			       where
				trn_shop_cd = @a_shop_cd
				and
				trn_work_type in ( '0235' )  -- 移動出庫
				and
				trn_create_date >= @a_start_date
				and
				trn_create_date < @a_end_date
				and
				e10_edi_trn_id is null  -- コピーしていないもの
				and
				e10_edi_line_no is null  -- コピーしていないもの
				and
				tod_jan_cd is not null  -- JANコードnull以外
				and
				((@a_supplier_edi_type = '2' and tod_goods_type in ('20', '21'))      -- 書籍・雑誌のみ
				or (@a_supplier_edi_type = '3' and tod_goods_type in ('30', '31')))   -- CD・DVDのみ
				and
				gds_jan_cd is not null  -- JANが設定されているもの
				and
				gds_gross_flag = '0'  -- グロス以外
		End
-- ▲▲▲ 2014/08/19 add

	End

	-- フォーマット区分＝"0"（15C）
	If @a_tohan_ur_format_type = '0' Begin
		INSERT wbe_edibook_up_control (
			 e10_edi_tushin_id
			,e10_edi_trn_id
			,e10_edi_line_no
			,e10_edi_flag
			,e10_edi_create_date
			,e10_edi_shop_cd_webpos
			,e10_edi_shop_name_webpos
			,e10_edi_shop_cd
			,e10_tohan_group_cd
			,e10_tohan_ur_format_type
            ,e10_tonets_v_up_flag			-- 2013/11/21 add
            ,e10_tonets_v_dw_flag			-- 2013/11/21 add
			)

		    SELECT
			 e10_edi_tushin_id = @a_tushin_id
			,e10_edi_trn_id = tdu_trn_id
			,e10_edi_line_no = tdu_line_no
			,e10_edi_flag = '0'     -- 未処理
			,e10_edi_create_date = getdate()
			,e10_edi_shop_cd_webpos = @a_shop_cd
			,e10_edi_shop_name_webpos = @a_shop_name
			,e10_edi_shop_cd = @a_book_shop_cd
			,e10_tohan_group_cd = @a_tohan_group_cd
			,e10_tohan_ur_format_type = @a_tohan_ur_format_type
            ,e10_tonets_v_up_flag = @a_tonets_v_up_flag			-- 2013/11/21 add
            ,e10_tonets_v_dw_flag = @a_tonets_v_dw_flag			-- 2013/11/21 add
		       from
			wpv_transaction WITH(NOLOCK)
			join
			wpt_transaction_uriage WITH(NOLOCK)
			  on
			  trn_trn_id = tur_trn_id
			join
			wpt_transaction_uriage_details WITH(NOLOCK)
			  on
			  trn_trn_id = tdu_trn_id
			join
			wpt_goods_master WITH(NOLOCK)
			  on 
			  tdu_goods_id = gds_goods_id
			left outer join
			wbe_edibook_up_control WITH(NOLOCK)
			  on
			  @a_tushin_id = e10_edi_tushin_id
			  and
			  tdu_trn_id = e10_edi_trn_id
			  and
			  tdu_line_no = e10_edi_line_no
		       where
			trn_shop_cd = @a_shop_cd
			and
			trn_work_type in ( '0000','0001' )  -- 売上、売上返金
			and
			trn_denpyo_type = '0'  -- 黒伝
			and
			trn_create_date >= @a_start_date
			and
			trn_create_date < @a_end_date
			and
			e10_edi_trn_id is null  -- コピーしていないもの
			and
			e10_edi_line_no is null  -- コピーしていないもの
			and
			tdu_set_type <> '9'  -- セット親以外
			and
			tdu_jan_cd is not null  -- JANコードnull以外
--			and
--			( gds_jan_cd is not null)  -- JANが設定されているもの
	End


	  -- エラーチェック
	  If @@ERROR <> 0 Begin
	    Set @err_msg = '9074,売上データ抽出エラー'
	    GOTO SP_ERR
	  End

      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
              ,@a_tohan_ur_format_type
              ,@a_tonets_v_up_flag				-- 2013/08/01 add
              ,@a_tonets_v_dw_flag				-- 2013/08/01 add
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------

      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

    -- データ転送

	-- ◆◆◆　１．TONET-V未実装　店舗のみ　◆◆
     SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_urd ( '
	+ '	 e15_edi_flag '
	+ '	,e15_server_webpos '
	+ '	,e15_dbname_webpos '
	+ '	,e15_shop_cd_webpos '
	+ '	,e15_shop_name_webpos '
	+ '	,e15_shop_cd_primary '
	+ '	,e15_shop_cd '
	+ '	,e15_tushin_id '
	+ '	,e15_pos_no '
	+ '	,e15_receipt_no '
	+ '	,e15_uriage_date '
	+ '	,e15_uriage_time '
	+ '	,e15_line_no '
	+ '	,e15_goods_code_kubun '
	+ '	,e15_goods_code '
	+ '	,e15_jan_cd '
	+ '	,e15_tanka '
	+ '	,e15_tanka_sign '
	+ '	,e15_count '
	+ '	,e15_count_sign '
	+ '	,e15_waribiki '
	+ '	,e15_nebiki '
	+ '	,e15_tax '
	+ '	,e15_tax_sign '
	+ '	,e15_tax_type '
	+ '	,e15_baika '
	+ '	,e15_baika_sign '
	+ '	,e15_stock_count '
	+ '	,e15_c_code '
	+ '	,e15_hontai_kakaku '
	+ '	,e15_tohan_group_cd '
	+ '	,e15_member_cd '
	+ '	,e15_tohan_ebsm_type '
	+ '	,e15_point_add '
	+ '	,e15_point_add_sign '
	+ '  )   '
	+ '  SELECT '
	+ '	 e15_edi_flag = ''0'' '          -- 未処理
	+ '	,e15_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e15_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e15_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e15_shop_name_webpos = e10_edi_shop_name_webpos '
-- 2012/08/27 update（星光堂の場合、親店舗コードにトーハングループCDをセット）
--	+ '	,e15_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e15_shop_cd_primary = '
	+ '  CASE WHEN e10_edi_tushin_id=''SK'' THEN e10_tohan_group_cd ELSE e10_edi_shop_cd END '
---------------------------------------------------------------------------------
	+ '	,e15_shop_cd = e10_edi_shop_cd '
	+ '	,e15_tushin_id = e10_edi_tushin_id '
	+ '	,e15_pos_no = trn_pos_no '
	+ '	,e15_receipt_no = trn_receipt_no '
	+ '	,e15_uriage_date = '
	+ '	 CASE WHEN e10_edi_tushin_id=''TM'' THEN '
	+	' right(''0000'' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) + '
	+	' right(''00'' + cast(datepart(mm,trn_create_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(dd,trn_create_date) as varchar), 2) '
	+ ' ELSE '
	+	' right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+	' right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+	' END  '
	+ '	,e15_uriage_time = '
	+	' right(''00'' + cast(datepart(hh,trn_pos_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(mi,trn_pos_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(ss,trn_pos_date) as varchar), 2) '
	+ '	,e15_line_no = tdu_line_no '
	+ '	,e15_goods_code_kubun = '
	+ ' case '
	+	' when gds_gross_flag = ''1''  then ''6'' '  -- グロス商品-->社内コード
	+	' when tdu_goods_type = ''20'' then ''1'' '  -- 書籍
	+	' when tdu_goods_type = ''21'' then ''2'' '  -- 雑誌
	+	' when tdu_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+	' when tdu_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+	' when tdu_goods_type = ''40'' then ''G'' '  -- ゲーム
	+	' else ''0'' '  -- その他
	+ ' end '
	+ '	,e15_goods_code = '
	-- 2016/12/05 更新
	-- + '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'') THEN '
	+ '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'', ''SI'') THEN '
	+	' case '
	+		' when gds_gross_flag = ''1''  then tdu_jan_cd '  -- グロス商品-->JANコード
	+		' when tdu_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+		' when tdu_goods_type = ''21'' then tdu_jan_cd '  -- 雑誌
	+		' when tdu_goods_type = ''30'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''31'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else tdu_jan_cd '  -- その他
	+		' end '
	-- 2018/05/07 ADD MS-439 Khoa-NDuy - Start
	+ '		  When e10_edi_tushin_id IN (''TH'') THEN '
	+	' case '
	+		' when gds_gross_flag = ''1''  then tdu_jan_cd '  -- グロス商品-->JANコード
	+		' when tdu_goods_type = ''20'' and gds_gross_flag = ''0'' then ISNULL(gdb_isbn, dbo.F_Convert_JAN_ISBN(tdu_jan_cd)) '    -- 書籍
	+		' when tdu_goods_type = ''21'' then tdu_jan_cd '  -- 雑誌
	+		' when tdu_goods_type = ''30'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''31'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else tdu_jan_cd '  -- その他
	+		' end '
	-- 2018/05/07 ADD MS-439 Khoa-NDuy - End
	+	' else '
	+	' case '
	+		' when gds_gross_flag = ''1''  then gds_jan_cd '  -- グロス商品-->JANコード
	+		' when tdu_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+		' when tdu_goods_type = ''21'' then gds_jan_cd '  -- 雑誌
	+		' when tdu_goods_type = ''30'' then gds_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''31'' then gds_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else gds_jan_cd '  -- その他
	+	' end '
	+ ' end '
	+ '	,e15_jan_cd ='
	-- 2016/12/05 更新
	-- + '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'') THEN '
	+ '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'', ''SI'') THEN '
	+ '	 tdu_jan_cd '
	-- 2018/05/07 ADD MS-439 Khoa-NDuy - Start
	+ '		  When e10_edi_tushin_id IN (''TH'') THEN '
	+ '	 ISNULL(gds_jan_cd, tdu_jan_cd) '
	-- 2018/05/07 ADD MS-439 Khoa-NDuy - End
	+ '	 Else '
	+ '	 gds_jan_cd '
	+ '	 End '
	+ '	,e15_tanka = abs(tdu_price) '
	+ '	,e15_tanka_sign = '
	+ '	case '
	+	' when ( trn_work_type = ''0001'' and tdu_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_price < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ '	,e15_count = '
	+	' case '
	+		' when tdu_set_type = ''1'' then abs(tdu_set_selling_count) '
	+		' else abs(tdu_selling_count) '
	+	' end '
	+ '	,e15_count_sign = '
	+ ' case '
	+	' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_selling_count >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_selling_count >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_selling_count < 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_selling_count < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_waribiki = 0 '
	+ ' ,e15_nebiki = '
	+	' case '
	+	' when tdu_set_type = ''1'' then abs(tdu_set_unit_discount_price) '
	+	' else abs(tdu_unit_discount_price) '
	+	' end '
	+ ' ,e15_tax = '
	+ ' case '
	+	' when tdu_set_type = ''1'' then abs(tdu_set_tax_price) '
	+	' else abs(tdu_tax_price) '
	+	' end '
	+ '	,e15_tax_sign = '
	+ ' case '
	+	' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_tax_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_tax_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_tax_price < 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_tax_price < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_tax_type = tdu_tax_type '
	+ ' ,e15_baika = '
	+	 ' case '
	+	' when tdu_set_type = ''1'' then abs(tdu_set_selling_price) '
	+	' else abs(tdu_selling_price) '
	+	' end '
	+ '	,e15_baika_sign = '
	+ ' case '
	+	' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_selling_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_selling_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_selling_price < 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_selling_price < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_stock_count = 0 '
-- 2012/05/02 update
	--+ '	,e15_c_code = gdb_c_code '
	+ ' ,e15_c_code = '
	+	' case '  -- 書籍の場合、2段JANがあればそこのCコード優先
	+		' when  rtrim(ltrim(isnull(tdu_plu_addon_cd,''''))) <> '''' and tdu_goods_type = ''20'' and len(tdu_plu_addon_cd) = 13'
	+		' then substring(tdu_plu_addon_cd,4,4) '  -- Cコード抜き出し
	+		' when  rtrim(ltrim(isnull(gdb_c_code,''''))) <> '''' and tdu_goods_type = ''20'' '
	+			' then gdb_c_code '		-- 商品マスタ書籍のCコード
	+			' else ''0000'' '	-- CコードがNULL、空文字の場合は'0000'固定
	+	' end '
--------------------
-- Ver 09-11 2013/07/04 E.Satoh  -- 中央社、税込→本体価格 対応
--	+ ' ,e15_hontai_kakaku = abs(tdu_price) '
	+ ' ,e15_hontai_kakaku =  '
	+ ' CASE WHEN e10_edi_tushin_id=''CO'' THEN '   -- 中央社は PLU単価		
		+	'  Case tdu_tax_rate_type'
			+	'  When ''0'' Then'  -- 切捨て
				+	'  tdu_price '  								-- 値引単価(税込み)
				+	'  - '
				+	'  Floor( ( tdu_price ) / (100 + tdu_tax_rate) * tdu_tax_rate ) '  -- 消費税
			+	'  When ''1'' Then '  -- 四捨五入
				+	'  tdu_price  '  								-- 値引単価(税込み)
				+	'  - '
				+	'  Cast( Round( (tdu_price ) / (100 + tdu_tax_rate) * tdu_tax_rate ,0) AS Int ) '  -- 消費税
			+	'  When ''2'' Then '  -- 切上げ
				+	'  tdu_price '  								-- 値引単価(税込み)
				+	'  - '
				+	'  Ceiling( ( tdu_price ) / (100 + tdu_tax_rate) * tdu_tax_rate ) '  -- 消費税
			+	'  Else 0 '
		+	'  End '
	+ '  ELSE  '
	+ '   abs(tdu_price) '       -- 中央社 以外
	+ '  END '
-------------------
	+ ' ,e15_tohan_group_cd = e10_tohan_group_cd '
	+ ' ,e15_member_cd = '
	+	' case '
	+		' when tur_ehon_card_number is not null then tur_ehon_card_number '
	+		' else null '
	+	' end '
	+ ' ,e15_tohan_ebsm_type = e10_tohan_ur_format_type '
	+ ' ,e15_point_add = '
	+	' case '
	+		' when tdu_set_type = ''1'' then abs(tdu_set_point_add) '
	+		' else abs(tdu_point_add) '
	+	' end '
	+ ' ,e15_point_add_sign = '
	+	' case '
	+		' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_point_add >= 0 ) '
	+		' or '
	+		' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_point_add >= 0 ) '
	+		' or '
	+		' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_point_add < 0 ) '
	+		' or '
	+		' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_point_add < 0 ) '
	+			' then ''-'' '
	+			' else ''+'' '
	+	' End '
	+ ' from '
	+	' wbe_edibook_up_control '
	+ ' join '
	+	' wpt_transaction_uriage_details '
	+		' on '
	+			' e10_edi_trn_id = tdu_trn_id '
	+			' and '
	+			' e10_edi_line_no = tdu_line_no '
	+ ' join '
	+	' wpt_transaction '
	+		' on '
	+			' tdu_trn_id = trn_trn_id '
	+ ' join '
	+	' wpt_transaction_uriage '
	+		' on '
	+			' trn_trn_id = tur_trn_id '
	+ ' left outer join '
	+	' wpt_goods_master '
	+		' on '
	+			' tdu_goods_id = gds_goods_id '
	+ ' left outer join '
	+	' wpt_goods_master_book '
	+		' on '
	+			' tdu_goods_id = gdb_goods_id '
	+ ' left outer join '
	+	' wpt_goods_master_magazine '
	+		' on '
	+			' tdu_goods_id = gdz_goods_id '
	+ ' where '
	+	' e10_edi_flag = ''0'' ' -- 未処理のみ
	+   ' and e10_tonets_v_up_flag = ''0'' '		-- 2013/11/21 add			0:TONETS-V未実装
	+ ' order by '
	+	' e10_edi_trn_id '
	+	' ,e10_edi_line_no '

      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End



	-- ◆◆◆　２－１．TONET-V実装　店舗のみ　◆◆
	-- EDIサーバ側のTONETS-V用売上テーブル(wpt_edibook_up_urt)に書き込む。
	-- （項目は通常売上データと同じ）
     SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_urt ( '
	+ '	 e15_edi_flag '
	+ '	,e15_server_webpos '
	+ '	,e15_dbname_webpos '
	+ '	,e15_shop_cd_webpos '
	+ '	,e15_shop_name_webpos '
	+ '	,e15_shop_cd_primary '
	+ '	,e15_shop_cd '
	+ '	,e15_tushin_id '
	+ '	,e15_pos_no '
	+ '	,e15_receipt_no '
	+ '	,e15_uriage_date '
	+ '	,e15_uriage_time '
	+ '	,e15_line_no '
	+ '	,e15_goods_code_kubun '
	+ '	,e15_goods_code '
	+ '	,e15_jan_cd '
	+ '	,e15_tanka '
	+ '	,e15_tanka_sign '
	+ '	,e15_count '
	+ '	,e15_count_sign '
	+ '	,e15_waribiki '
	+ '	,e15_nebiki '
	+ '	,e15_tax '
	+ '	,e15_tax_sign '
	+ '	,e15_tax_type '
	+ '	,e15_baika '
	+ '	,e15_baika_sign '
	+ '	,e15_stock_count '
	+ '	,e15_c_code '
	+ '	,e15_hontai_kakaku '
	+ '	,e15_tohan_group_cd '
	+ '	,e15_member_cd '
	+ '	,e15_tohan_ebsm_type '
	+ '	,e15_point_add '
	+ '	,e15_point_add_sign '
	+ '  )   '
	+ '  SELECT '
	+ '	 e15_edi_flag = ''0'' '          -- 未処理
	+ '	,e15_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e15_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e15_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e15_shop_name_webpos = e10_edi_shop_name_webpos '
-- 2012/08/27 update（星光堂の場合、親店舗コードにトーハングループCDをセット）
--	+ '	,e15_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e15_shop_cd_primary = '
	+ '  CASE WHEN e10_edi_tushin_id=''SK'' THEN e10_tohan_group_cd ELSE e10_edi_shop_cd END '
---------------------------------------------------------------------------------
	+ '	,e15_shop_cd = e10_edi_shop_cd '
	+ '	,e15_tushin_id = e10_edi_tushin_id '
	+ '	,e15_pos_no = trn_pos_no '
	+ '	,e15_receipt_no = trn_receipt_no '
	+ '	,e15_uriage_date = '
	+ '	 CASE WHEN e10_edi_tushin_id=''TM'' THEN '
	+	' right(''0000'' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) + '
	+	' right(''00'' + cast(datepart(mm,trn_create_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(dd,trn_create_date) as varchar), 2) '
	+ ' ELSE '
	+	' right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+	' right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+	' END  '
	+ '	,e15_uriage_time = '
	+	' right(''00'' + cast(datepart(hh,trn_pos_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(mi,trn_pos_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(ss,trn_pos_date) as varchar), 2) '
	+ '	,e15_line_no = tdu_line_no '
	+ '	,e15_goods_code_kubun = '
	+ ' case '
	+	' when gds_gross_flag = ''1''  then ''6'' '  -- グロス商品-->社内コード
	+	' when tdu_goods_type = ''20'' then ''1'' '  -- 書籍
	+	' when tdu_goods_type = ''21'' then ''2'' '  -- 雑誌
	+	' when tdu_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+	' when tdu_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+	' when tdu_goods_type = ''40'' then ''G'' '  -- ゲーム
	+	' else ''0'' '  -- その他
	+ ' end '
	+ '	,e15_goods_code = '
	+ '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'') THEN '
	+	' case '
	+		' when gds_gross_flag = ''1''  then tdu_jan_cd '  -- グロス商品-->JANコード
	+		' when tdu_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+		' when tdu_goods_type = ''21'' then tdu_jan_cd '  -- 雑誌
	+		' when tdu_goods_type = ''30'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''31'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else tdu_jan_cd '  -- その他
	+		' end '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - Start
	+ '		  When e10_edi_tushin_id IN (''TH'') THEN '
	+	' case '
	+		' when gds_gross_flag = ''1''  then tdu_jan_cd '  -- グロス商品-->JANコード
	+		' when tdu_goods_type = ''20'' and gds_gross_flag = ''0'' then ISNULL(gdb_isbn, dbo.F_Convert_JAN_ISBN(tdu_jan_cd)) '    -- 書籍
	+		' when tdu_goods_type = ''21'' then tdu_jan_cd '  -- 雑誌
	+		' when tdu_goods_type = ''30'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''31'' then tdu_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else tdu_jan_cd '  -- その他
	+		' end '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - End
	+	' else '
	+	' case '
	+		' when gds_gross_flag = ''1''  then gds_jan_cd '  -- グロス商品-->JANコード
	+		' when tdu_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+		' when tdu_goods_type = ''21'' then gds_jan_cd '  -- 雑誌
	+		' when tdu_goods_type = ''30'' then gds_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''31'' then gds_jan_cd '  -- CD/DVD
	+		' when tdu_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else gds_jan_cd '  -- その他
	+	' end '
	+ ' end '
	+ '	,e15_jan_cd ='
	+ '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'') THEN '
	+ '	 tdu_jan_cd '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - Start
	+ '		  When e10_edi_tushin_id IN (''TH'') THEN '
	+ '	 ISNULL(gds_jan_cd, tdu_jan_cd) '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - End
	+ '	 Else '
	+ '	 gds_jan_cd '
	+ '	 End '
	+ '	,e15_tanka = abs(tdu_price) '
	+ '	,e15_tanka_sign = '
	+ '	case '
	+	' when ( trn_work_type = ''0001'' and tdu_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_price < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ '	,e15_count = '
	+	' case '
	+		' when tdu_set_type = ''1'' then abs(tdu_set_selling_count) '
	+		' else abs(tdu_selling_count) '
	+	' end '
	+ '	,e15_count_sign = '
	+ ' case '
	+	' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_selling_count >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_selling_count >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_selling_count < 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_selling_count < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_waribiki = 0 '
	+ ' ,e15_nebiki = '
	+	' case '
	+	' when tdu_set_type = ''1'' then abs(tdu_set_unit_discount_price) '
	+	' else abs(tdu_unit_discount_price) '
	+	' end '
	+ ' ,e15_tax = '
	+ ' case '
	+	' when tdu_set_type = ''1'' then abs(tdu_set_tax_price) '
	+	' else abs(tdu_tax_price) '
	+	' end '
	+ '	,e15_tax_sign = '
	+ ' case '
	+	' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_tax_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_tax_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_tax_price < 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_tax_price < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_tax_type = tdu_tax_type '
	+ ' ,e15_baika = '
	+	 ' case '
	+	' when tdu_set_type = ''1'' then abs(tdu_set_selling_price) '
	+	' else abs(tdu_selling_price) '
	+	' end '
	+ '	,e15_baika_sign = '
	+ ' case '
	+	' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_selling_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_selling_price >= 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_selling_price < 0 ) '
	+	' or '
	+	' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_selling_price < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_stock_count = 0 '
-- 2012/05/02 update
	--+ '	,e15_c_code = gdb_c_code '
	+ ' ,e15_c_code = '
	+	' case '  -- 書籍の場合、2段JANがあればそこのCコード優先
	+		' when  rtrim(ltrim(isnull(tdu_plu_addon_cd,''''))) <> '''' and tdu_goods_type = ''20'' and len(tdu_plu_addon_cd) = 13'
	+		' then substring(tdu_plu_addon_cd,4,4) '  -- Cコード抜き出し
	+		' when  rtrim(ltrim(isnull(gdb_c_code,''''))) <> '''' and tdu_goods_type = ''20'' '
	+			' then gdb_c_code '		-- 商品マスタ書籍のCコード
	+			' else ''0000'' '	-- CコードがNULL、空文字の場合は'0000'固定
	+	' end '
--------------------
-- Ver 09-11 2013/07/04 E.Satoh  -- 中央社、税込→本体価格 対応
--	+ ' ,e15_hontai_kakaku = abs(tdu_price) '
	+ ' ,e15_hontai_kakaku =  '
	+ ' CASE WHEN e10_edi_tushin_id=''CO'' THEN '   -- 中央社は PLU単価		
		+	'  Case tdu_tax_rate_type'
			+	'  When ''0'' Then'  -- 切捨て
				+	'  tdu_price '  								-- 値引単価(税込み)
				+	'  - '
				+	'  Floor( ( tdu_price ) / (100 + tdu_tax_rate) * tdu_tax_rate ) '  -- 消費税
			+	'  When ''1'' Then '  -- 四捨五入
				+	'  tdu_price  '  								-- 値引単価(税込み)
				+	'  - '
				+	'  Cast( Round( (tdu_price ) / (100 + tdu_tax_rate) * tdu_tax_rate ,0) AS Int ) '  -- 消費税
			+	'  When ''2'' Then '  -- 切上げ
				+	'  tdu_price '  								-- 値引単価(税込み)
				+	'  - '
				+	'  Ceiling( ( tdu_price ) / (100 + tdu_tax_rate) * tdu_tax_rate ) '  -- 消費税
			+	'  Else 0 '
		+	'  End '
	+ '  ELSE  '
	+ '   abs(tdu_price) '       -- 中央社 以外
	+ '  END '
-------------------
	+ ' ,e15_tohan_group_cd = e10_tohan_group_cd '
	+ ' ,e15_member_cd = '
	+	' case '
	+		' when tur_ehon_card_number is not null then tur_ehon_card_number '
	+		' else null '
	+	' end '
	+ ' ,e15_tohan_ebsm_type = e10_tohan_ur_format_type '
	+ ' ,e15_point_add = '
	+	' case '
	+		' when tdu_set_type = ''1'' then abs(tdu_set_point_add) '
	+		' else abs(tdu_point_add) '
	+	' end '
	+ ' ,e15_point_add_sign = '
	+	' case '
	+		' when ( trn_work_type = ''0001'' and tdu_set_type = ''0'' and tdu_point_add >= 0 ) '
	+		' or '
	+		' ( trn_work_type = ''0001'' and tdu_set_type = ''1'' and tdu_set_point_add >= 0 ) '
	+		' or '
	+		' ( trn_work_type = ''0000'' and tdu_set_type = ''0'' and tdu_point_add < 0 ) '
	+		' or '
	+		' ( trn_work_type = ''0000'' and tdu_set_type = ''1'' and tdu_set_point_add < 0 ) '
	+			' then ''-'' '
	+			' else ''+'' '
	+	' End '
	+ ' from '
	+	' wbe_edibook_up_control '
	+ ' join '
	+	' wpt_transaction_uriage_details '
	+		' on '
	+			' e10_edi_trn_id = tdu_trn_id '
	+			' and '
	+			' e10_edi_line_no = tdu_line_no '
	+ ' join '
	+	' wpt_transaction '
	+		' on '
	+			' tdu_trn_id = trn_trn_id '
	+ ' join '
	+	' wpt_transaction_uriage '
	+		' on '
	+			' trn_trn_id = tur_trn_id '
	+ ' left outer join '
	+	' wpt_goods_master '
	+		' on '
	+			' tdu_goods_id = gds_goods_id '
	+ ' left outer join '
	+	' wpt_goods_master_book '
	+		' on '
	+			' tdu_goods_id = gdb_goods_id '
	+ ' left outer join '
	+	' wpt_goods_master_magazine '
	+		' on '
	+			' tdu_goods_id = gdz_goods_id '
	+ ' where '
	+	' e10_edi_flag = ''0'' ' -- 未処理のみ
	+   ' and e10_tonets_v_up_flag = ''1'' '		-- 2013/11/21 add			1:TONETS-V実装
	+ ' order by '
	+	' e10_edi_trn_id '
	+	' ,e10_edi_line_no '


      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

-- ▼▼▼ 2014/08/19 add
	-- ◆◆◆　２－２．TONET-V実装　店舗のみ（移動出庫を売上として作成）　◆◆
	-- EDIサーバ側のTONETS-V用売上テーブル(wpt_edibook_up_urt)に書き込む。
	-- （項目は通常売上データと同じ）
     SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_urt ( '
	+ '	 e15_edi_flag '
	+ '	,e15_server_webpos '
	+ '	,e15_dbname_webpos '
	+ '	,e15_shop_cd_webpos '
	+ '	,e15_shop_name_webpos '
	+ '	,e15_shop_cd_primary '
	+ '	,e15_shop_cd '
	+ '	,e15_tushin_id '
	+ '	,e15_pos_no '
	+ '	,e15_receipt_no '
	+ '	,e15_uriage_date '
	+ '	,e15_uriage_time '
	+ '	,e15_line_no '
	+ '	,e15_goods_code_kubun '
	+ '	,e15_goods_code '
	+ '	,e15_jan_cd '
	+ '	,e15_tanka '
	+ '	,e15_tanka_sign '
	+ '	,e15_count '
	+ '	,e15_count_sign '
	+ '	,e15_waribiki '
	+ '	,e15_nebiki '
	+ '	,e15_tax '
	+ '	,e15_tax_sign '
	+ '	,e15_tax_type '
	+ '	,e15_baika '
	+ '	,e15_baika_sign '
	+ '	,e15_stock_count '
	+ '	,e15_c_code '
	+ '	,e15_hontai_kakaku '
	+ '	,e15_tohan_group_cd '
	+ '	,e15_member_cd '
	+ '	,e15_tohan_ebsm_type '
	+ '	,e15_point_add '
	+ '	,e15_point_add_sign '
	+ '  )   '
	+ '  SELECT '
	+ '	 e15_edi_flag = ''0'' '          -- 未処理
	+ '	,e15_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e15_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e15_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e15_shop_name_webpos = e10_edi_shop_name_webpos '
	+ '	,e15_shop_cd_primary = '
	+ '  CASE WHEN e10_edi_tushin_id=''SK'' THEN e10_tohan_group_cd ELSE e10_edi_shop_cd END '
	+ '	,e15_shop_cd = e10_edi_shop_cd '
	+ '	,e15_tushin_id = e10_edi_tushin_id '
	+ '	,e15_pos_no = trn_pos_no '
	+ '	,e15_receipt_no = trn_receipt_no '
	+ '	,e15_uriage_date = '
	+ '	 CASE WHEN e10_edi_tushin_id=''TM'' THEN '
	+	' right(''0000'' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) + '
	+	' right(''00'' + cast(datepart(mm,trn_create_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(dd,trn_create_date) as varchar), 2) '
	+ ' ELSE '
	+	' right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+	' right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+	' END  '
	+ '	,e15_uriage_time = '
	+	' right(''00'' + cast(datepart(hh,trn_pos_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(mi,trn_pos_date) as varchar), 2 ) + '
	+	' right(''00'' + cast(datepart(ss,trn_pos_date) as varchar), 2) '
	+ '	,e15_line_no = tod_line_no '
	+ '	,e15_goods_code_kubun = '
	+ ' case '
	+	' when gds_gross_flag = ''1''  then ''6'' '  -- グロス商品-->社内コード
	+	' when tod_goods_type = ''20'' then ''1'' '  -- 書籍
	+	' when tod_goods_type = ''21'' then ''2'' '  -- 雑誌
	+	' when tod_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+	' when tod_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+	' when tod_goods_type = ''40'' then ''G'' '  -- ゲーム
	+	' else ''0'' '  -- その他
	+ ' end '
	+ '	,e15_goods_code = '
	+ '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'') THEN '
	+	' case '
	+		' when gds_gross_flag = ''1''  then tod_jan_cd '  -- グロス商品-->JANコード
	+		' when tod_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+		' when tod_goods_type = ''21'' then tod_jan_cd '  -- 雑誌
	+		' when tod_goods_type = ''30'' then tod_jan_cd '  -- CD/DVD
	+		' when tod_goods_type = ''31'' then tod_jan_cd '  -- CD/DVD
	+		' when tod_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else tod_jan_cd '  -- その他
	+		' end '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - Start
	+ '		  When e10_edi_tushin_id IN (''TH'') THEN '
	+	' case '
	+		' when gds_gross_flag = ''1''  then tod_jan_cd '  -- グロス商品-->JANコード
	+		' when tod_goods_type = ''20'' and gds_gross_flag = ''0'' then ISNULL(gdb_isbn, dbo.F_Convert_JAN_ISBN(tod_jan_cd)) '    -- 書籍
	+		' when tod_goods_type = ''21'' then tod_jan_cd '  -- 雑誌
	+		' when tod_goods_type = ''30'' then tod_jan_cd '  -- CD/DVD
	+		' when tod_goods_type = ''31'' then tod_jan_cd '  -- CD/DVD
	+		' when tod_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else tod_jan_cd '  -- その他
	+		' end '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - End
	+	' else '
	+	' case '
	+		' when gds_gross_flag = ''1''  then gds_jan_cd '  -- グロス商品-->JANコード
	+		' when tod_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+		' when tod_goods_type = ''21'' then gds_jan_cd '  -- 雑誌
	+		' when tod_goods_type = ''30'' then gds_jan_cd '  -- CD/DVD
	+		' when tod_goods_type = ''31'' then gds_jan_cd '  -- CD/DVD
	+		' when tod_goods_type = ''40'' then convert( varchar,gds_koyu_goods_cd ) '  -- ゲーム-->ハウスコード
	+		' else gds_jan_cd '  -- その他
	+	' end '
	+ ' end '
	+ '	,e15_jan_cd ='
	+ '	 Case When e10_edi_tushin_id IN (''KW'', ''KP'') THEN '
	+ '	 tod_jan_cd '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - Start
	+ '		  When e10_edi_tushin_id IN (''TH'') THEN '
	+ '	 ISNULL(gds_jan_cd, tod_jan_cd) '
	-- 2018/05/14 ADD MS-439 Khoa-NDuy - End
	+ '	 Else '
	+ '	 gds_jan_cd '
	+ '	 End '
	+ '	,e15_tanka = abs(tod_price) '
	+ '	,e15_tanka_sign = '
	+ '	case '
	+	' when ( trn_denpyo_type = ''1'' and tod_goods_count >= 0 ) '
	+	' or '
	+	' ( trn_denpyo_type = ''0'' and tod_goods_count < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ '	,e15_count = abs(tod_goods_count) '
	+ '	,e15_count_sign = '
	+ ' case '
	+	' when ( trn_denpyo_type = ''1'' and tod_goods_count >= 0 ) '
	+	' or '
	+	' ( trn_denpyo_type = ''0'' and tod_goods_count < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_waribiki = 0 '
	+ ' ,e15_nebiki = 0 '
	+ ' ,e15_tax = ( abs(tod_price) - abs(tod_price_default) ) * abs(tod_goods_count) '
	+ '	,e15_tax_sign = '
	+ ' case '
	+	' when ( trn_denpyo_type = ''1'' and tod_goods_count >= 0 ) '
	+	' or '
	+	' ( trn_denpyo_type = ''0'' and tod_goods_count < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_tax_type = gds_tax_type '
	+ ' ,e15_baika = abs(tod_price_default) * abs(tod_goods_count) '
	+ '	,e15_baika_sign = '
	+ ' case '
	+	' when ( trn_denpyo_type = ''1'' and tod_goods_count >= 0 ) '
	+	' or '
	+	' ( trn_denpyo_type = ''0'' and tod_goods_count < 0 ) '
	+		' then ''-'' '
	+		' else ''+'' '
	+	' End '
	+ ' ,e15_stock_count = 0 '
	+ ' ,e15_c_code = '
	+	' case '
	+		' when  rtrim(ltrim(isnull(gdb_c_code,''''))) <> '''' and tod_goods_type = ''20'' '
	+			' then gdb_c_code '		-- 商品マスタ書籍のCコード
	+			' else ''0000'' '	-- CコードがNULL、空文字の場合は'0000'固定
	+	' end '
	+ ' ,e15_hontai_kakaku = abs(tod_price_default) '
	+ ' ,e15_tohan_group_cd = e10_tohan_group_cd '
	+ ' ,e15_member_cd = null '
	+ ' ,e15_tohan_ebsm_type = e10_tohan_ur_format_type '
	+ ' ,e15_point_add = 0 '
	+ ' ,e15_point_add_sign = ''+'' '
	+ ' from '
	+	' wbe_edibook_up_control WITH(NOLOCK) '
	+ ' join '
	+	' wpt_transaction_inout_details WITH(NOLOCK) '
	+		' on '
	+			' e10_edi_trn_id = tod_trn_id '
	+			' and '
	+			' e10_edi_line_no = tod_line_no '
	+ ' join '
	+	' wpt_transaction WITH(NOLOCK) '
	+		' on '
	+			' tod_trn_id = trn_trn_id '
	+ ' join '
	+	' wpt_transaction_inout WITH(NOLOCK) '
	+		' on '
	+			' trn_trn_id = tso_trn_id '
	+ ' left outer join '
	+	' wpt_goods_master WITH(NOLOCK) '
	+		' on '
	+			' tod_goods_id = gds_goods_id '
	+ ' left outer join '
	+	' wpt_goods_master_book WITH(NOLOCK) '
	+		' on '
	+			' tod_goods_id = gdb_goods_id '
	+ ' left outer join '
	+	' wpt_goods_master_magazine WITH(NOLOCK) '
	+		' on '
	+			' tod_goods_id = gdz_goods_id '
	+ ' where '
	+	' e10_edi_flag = ''0'' ' -- 未処理のみ
	+   ' and e10_tonets_v_up_flag = ''1'' '		-- 2013/11/21 add			1:TONETS-V実装
	+ ' order by '
	+	' e10_edi_trn_id '
	+	' ,e10_edi_line_no '


      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End
-- ▲▲▲ 2014/08/19 add

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_uriage_details
		  on
		  e10_edi_trn_id = tdu_trn_id
		  and
		  e10_edi_line_no = tdu_line_no
	          join
		wpt_transaction
		  on
		  tdu_trn_id = trn_trn_id
		join
		wpt_transaction_uriage
		  on
		  trn_trn_id = tur_trn_id
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_uriage_details
		  on
		  e10_edi_trn_id = tdu_trn_id
		  and
		  e10_edi_line_no = tdu_line_no
	          join
		wpt_transaction
		  on
		  tdu_trn_id = trn_trn_id
		join
		wpt_transaction_uriage
		  on
		  trn_trn_id = tur_trn_id
	    where 
		e10_edi_flag = '0'   -- 未処理のみ
 
-- ▼▼▼ 2014/08/19 add
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_inout_details
		  on
		  e10_edi_trn_id = tod_trn_id
		  and
		  e10_edi_line_no = tod_line_no
	          join
		wpt_transaction
		  on
		  tod_trn_id = trn_trn_id
		join
		wpt_transaction_inout
		  on
		  trn_trn_id = tso_trn_id
	    where 
		e10_edi_flag = '0'   -- 未処理のみ
-- ▲▲▲ 2014/08/19 add

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9073,売上ログ出力エラー'

    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_URIAGE_END:

--=================================================
-- 上り在庫処理
--=================================================
UP_ZAIKO:
  Declare @e16_edi_flag char (1)
  Declare @e16_edi_timestamp timestamp
  Declare @e16_edi_create_date datetime 
  Declare @e16_edi_update_date datetime 
  Declare @e16_edi_file_line_no int 
  Declare @e16_edi_meisai_no int 
  Declare @e16_edi_error_msg varchar (200)
  Declare @e16_server_webpos varchar (100)
  Declare @e16_dbname_webpos varchar (100)
  Declare @e16_shop_cd_webpos varchar (10)
  Declare @e16_shop_name_webpos varchar (100)
  Declare @e16_seq_no char (5)
  Declare @e16_shop_cd_primary varchar (10)
  Declare @e16_shop_cd varchar (10)
  Declare @e16_tushin_id char (2)

  Declare @e16_hendou_date char(8)
  Declare @e16_goods_code_kubun char(1)
  Declare @e16_goods_code varchar(20)
  Declare @e16_jan_cd varchar(20)
  Declare @e16_kisyu_zaiko_count int
  Declare @e16_zaiko_count int
  Declare @e16_tanka money
  Declare @e16_genka_price money
  Declare @e16_uri_sum_count int
  Declare @e16_uri_last_date char(8)
  Declare @e16_shiire_sum_count int
  Declare @e16_shiire_last_date char(8)
  Declare @e16_hpn_sum_count int
  Declare @e16_hpn_last_date char(8)
  Declare @e16_ido_sum_count int
  Declare @e16_ido_last_date char(8)


  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9081,在庫データ削除不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
              ,mpm_edi_type
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
               join
               wpt_maker_supplier_master
                 on
                 bes_bookedi_cd = mpm_bookedi_cd
                 and mpm_shop_cd IS NULL
            where
               bes_up_hpn_flag =
                  case
                     when @edi_type = '11U' then '1'
                     else bes_up_hpn_flag
                  end

               and
               bes_up_hcu_flag =
                  case
                     when @edi_type = '12U' then '1'
                     else bes_up_hcu_flag
                  end
               and
               bes_up_tka_flag =
                  case
                     when @edi_type = '13U' then '1'
                     else bes_up_tka_flag
                  end
               and
               bes_up_urh_flag =
                  case
                     when @edi_type = '14U' then '1'
                     else bes_up_urh_flag
                  end
               and
               bes_up_urd_flag =
                  case
                     when @edi_type = '15U' then '1'
                     else bes_up_urd_flag
                  end
               and
               bes_up_zhd_flag =
                  case
                     when @edi_type = '16U' then '1'
                     else bes_up_zhd_flag
                  end
			-- ▼▼▼ 2014/07/03 add（TONETS在庫変動データを送信する設定は除外する）
			   and
			   IsNull(bes_tonets_v_up_flag,'0') <> '1'
			-- ▲▲▲ 2014/07/03 add

  -- カーソルを開く
  open @rs
  --追加：2018/05/25 - Start
  -- 累計部作成
  -- 対象コード
  Create table #zhd_goods (
	 tg_edi_tushin_id char(2)
	,tg_edi_shop_cd_webpos varchar(10)
	,tg_edi_shop_name_webpos varchar(100)
	,tg_edi_shop_cd varchar(10)
	,tg_shop_cd int
	,tg_goods_id int
	,tg_trn_date varchar(8)
  )

  -- 累計格納データ
	Create table #zhd_total (
		t_edi_tushin_id char(2)
	,t_edi_shop_cd_webpos varchar(10)
	,t_edi_shop_name_webpos varchar(100)
	,t_edi_shop_cd varchar(10)
	,t_shop_cd int
	,t_goods_id int
	,t_trn_date varchar(8)
	,t_uri_sum_count int
	,t_uri_last_date char(8)
	,t_shiire_sum_count int
	,t_shiire_last_date char(8)
	,t_hpn_sum_count int
	,t_hpn_last_date char(8)
	,t_ido_sum_count int
	,t_ido_last_date char(8)
	)
  --追加：2018/05/25 - End

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	INSERT wbe_edibook_up_control (
		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		)

	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = tst_trn_id
		,e10_edi_line_no = tst_line_no + 10000  -- 在庫用に+10000する。
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
		,e10_edi_shop_cd = @a_book_shop_cd
		,e10_tohan_group_cd = @a_tohan_group_cd
	       from
		wpv_transaction
		join
		wpt_transaction_stock
		  on
		  trn_trn_id = tst_trn_id
		join
		wpt_goods_master 
		  on 
		  tst_goods_id = gds_goods_id
		-- ▼▼▼ 2018/06/26 update
		left outer join wpt_goods_master_book with(nolock)
		on gds_goods_id = gdb_goods_id
		-- ▲▲▲
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  tst_trn_id = e10_edi_trn_id
		  and
		  tst_line_no + 10000 = e10_edi_line_no -- 在庫用に+10000する。
	       where
		trn_shop_cd = @a_shop_cd
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		trn_create_date >= @a_start_date
		and
		trn_create_date < @a_end_date
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの
		and
		gds_jan_cd is not null  -- JANコードnull以外
		and
		gds_gross_flag = '0'  -- グロス以外
	    and
	    tst_condition_type = '0'  -- 新品
	    and
	    tst_goods_change_count <> 0  -- 変動したもの
-- 2009/03/12
-- 取次のEDI区分により商品を選別
		and
		(
		-- ▼▼▼ 2018/06/26 update
--		  (@a_supplier_edi_type = '2' AND gds_goods_type IN ('20', '21'))      -- 書籍・雑誌のみ
		  (@a_supplier_edi_type = '2' AND gds_goods_type IN ('20', '21')and @a_tushin_id <> 'KK')      -- 書籍・雑誌のみ
		  or (@a_supplier_edi_type = '2' AND gds_goods_type = '21' and @a_tushin_id = 'KK')      -- 雑誌のみ
		  or (@a_supplier_edi_type = '2' AND gds_goods_type = '20' and @a_tushin_id = 'KK'
		      and gdb_publisher_cd in ( '04','404','7561','7577','8061','8275','8291','8401','8402','87148','88991'))      -- 書籍のみ出版社限定（KADOKAWA指定）
		-- ▲▲▲
-- ▼▼▼ 2014/03/17 update
--		or (@a_supplier_edi_type = '3' and gds_goods_type in ('30', '31')))   -- CD・DVDのみ
		or (@a_supplier_edi_type = '3' and @a_tushin_id <> 'TM' and gds_goods_type in ('30', '31'))
		or (@a_supplier_edi_type = '3' and @a_tushin_id =  'TM' and gds_goods_type in ('30'))
		)   -- CD・DVDのみ
-- ▲▲▲ 2014/03/17 update

	  -- エラーチェック
	  If @@ERROR <> 0 Begin
	    Set @err_msg = '9084,在庫データ抽出エラー'
	    GOTO SP_ERR
	  End
	--削除：2018/05/25 - Start
	--   -- 次へ
 --     fetch next from @rs into
 --              @a_tushin_id
 --             ,@a_book_shop_cd
 --             ,@a_tohan_group_cd
 --             ,@a_shop_cd
 --             ,@a_shop_name
 --             ,@a_supplier_edi_type
 --   End  -- While

	---- カーソルを閉じる
	--close @rs
	---- 開放
	--deallocate @rs
	--削除：2018/05/25 - End

  ------------------------------
  -- 事前集計
  ------------------------------

  -- 累計部作成
  -- 対象コード
  --削除：2018/05/25 - Start
 -- Create table #zhd_goods (
	-- tg_edi_tushin_id char(2)
	--,tg_edi_shop_cd_webpos varchar(10)
	--,tg_edi_shop_name_webpos varchar(100)
	--,tg_edi_shop_cd varchar(10)
	--,tg_shop_cd int
	--,tg_goods_id int
	--,tg_trn_date varchar(8)
 -- )
  --削除：2018/05/25 - End

  INSERT INTO #zhd_goods (
	 tg_edi_tushin_id
	,tg_edi_shop_cd_webpos
	,tg_edi_shop_name_webpos
	,tg_edi_shop_cd
	,tg_shop_cd
	,tg_goods_id
	,tg_trn_date
    )
   SELECT
	 tg_edi_tushin_id = e10_edi_tushin_id
	,tg_edi_shop_cd_webpos = e10_edi_shop_cd_webpos
	,tg_edi_shop_name_webpos = e10_edi_shop_name_webpos
	,tg_edi_shop_cd = e10_edi_shop_cd
	,tg_shop_cd = trn_shop_cd
	,tg_goods_id = tst_goods_id
	--,tg_trn_date = convert(Varchar(8), trn_trn_date, 112)		--UPDATE: 2018/09/06 - コア
	,tg_trn_date = convert(Varchar(8), trn_create_date, 112)	--UPDATE: 2018/09/06 - コア
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_stock
		  on
		  e10_edi_trn_id = tst_trn_id
		  and
		  e10_edi_line_no = tst_line_no + 10000
	          join
		wpt_transaction
		  on
		  tst_trn_id = trn_trn_id
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
		and
		e10_edi_tushin_id = @a_tushin_id
		AND trn_shop_cd = @a_shop_cd
	    group by
	    e10_edi_tushin_id
	  , e10_edi_shop_cd_webpos
	  , e10_edi_shop_name_webpos
	  , e10_edi_shop_cd
	  , trn_shop_cd
	  , tst_goods_id
	  --, convert(Varchar(8), trn_trn_date, 112)	--UPDATE: 2018/09/06 - コア
	  , convert(Varchar(8), trn_create_date, 112)	--UPDATE: 2018/09/06 - コア
	    order by
	    e10_edi_tushin_id
	  , e10_edi_shop_cd_webpos
	  , e10_edi_shop_name_webpos
	  , e10_edi_shop_cd
	  , trn_shop_cd
	  , tst_goods_id
	  --, convert(Varchar(8), trn_trn_date, 112)	--UPDATE: 2018/09/06 - コア
	  , convert(Varchar(8), trn_create_date, 112)	--UPDATE: 2018/09/06 - コア

      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

	-- 累計格納データ
	--削除：2018/05/25 - Start
	--Create table #zhd_total (
	--	t_edi_tushin_id char(2)
	--,t_edi_shop_cd_webpos varchar(10)
	--,t_edi_shop_name_webpos varchar(100)
	--,t_edi_shop_cd varchar(10)
	--,t_shop_cd int
	--,t_goods_id int
	--,t_trn_date varchar(8)
	--,t_uri_sum_count int
	--,t_uri_last_date char(8)
	--,t_shiire_sum_count int
	--,t_shiire_last_date char(8)
	--,t_hpn_sum_count int
	--,t_hpn_last_date char(8)
	--,t_ido_sum_count int
	--,t_ido_last_date char(8)
	--)
	--削除：2018/05/25 - End

	  INSERT INTO #zhd_total (
		 t_edi_tushin_id
		,t_edi_shop_cd_webpos
		,t_edi_shop_name_webpos
		,t_edi_shop_cd
		,t_shop_cd
		,t_goods_id
		,t_trn_date
		,t_uri_sum_count
		,t_uri_last_date
		,t_shiire_sum_count
		,t_shiire_last_date
		,t_hpn_sum_count
		,t_hpn_last_date
		,t_ido_sum_count
		,t_ido_last_date
	  )
	 SELECT
		 t_edi_tushin_id = tg_edi_tushin_id
		,t_edi_shop_cd_webpos = tg_edi_shop_cd_webpos
		,t_edi_shop_name_webpos = tg_edi_shop_name_webpos
		,t_edi_shop_cd = tg_edi_shop_cd
		,t_shop_cd = gdt_shop_cd
		,t_goods_id = gdt_goods_id
		,t_trn_date = tg_trn_date
		,t_uri_sum_count = 
		 isNull(Sum(gdt_goods_count + (gdt_urihen_count * -1)), 0)
		,t_uri_last_date = 
		 isNull(Max(Case when gdt_goods_count <> 0 or gdt_urihen_count <> 0 then convert(Varchar(8), gdt_trn_date, 112) else '00000000' end), '00000000')
		,t_shiire_sum_count = 
		 isNull(Sum(gdt_shiire_count), 0)
		,t_shiire_last_date = 
		 isNull(Max(Case when gdt_shiire_count <> 0 then convert(Varchar(8), gdt_trn_date, 112) else '00000000' end), '00000000')
		,t_hpn_sum_count = 
		 isNull(Sum(gdt_henpin_count), 0)
		,t_hpn_last_date = 
		 isNull(Max(Case when gdt_henpin_count <> 0 then convert(Varchar(8), gdt_trn_date, 112) else '00000000' end), '00000000')
		,t_ido_sum_count = 
		 isNull(Sum(gdt_idounyuko_count + (gdt_idoushuko_count * -1)), 0)
		,t_ido_last_date = 
		 isNull(Max(Case when gdt_idounyuko_count <> 0 or gdt_idoushuko_count <> 0 then convert(Varchar(8), gdt_trn_date, 112) else '00000000' end), '00000000')
			from
			#zhd_goods
			left outer join  -- 2009/3/11 join → left ouetr join
			wpt_goods_day_total
			  on
			  gdt_shop_cd = tg_shop_cd
			  and
			  gdt_goods_id = tg_goods_id
			  and
			  gdt_condition_type = '0' -- 新品
	--追加：2018/05/25 - Start
		WHERE tg_shop_cd = @a_shop_cd
		AND tg_edi_tushin_id = @a_tushin_id
		AND	( 
			  --追加：2018/07/12 - Start
			  --(@a_tushin_id = 'KK' and  gdt_trn_date >= @a_start_date AND gdt_trn_date < @a_end_date) 
			  ( @a_tushin_id = 'KK' and tg_trn_date = Convert(varchar(8), gdt_trn_date, 112) ) 
			  --追加：2018/07/12 - End
			  or (@a_tushin_id <> 'KK' and  1=1)
			)
	--追加：2018/05/25 - End
	   group by
			  tg_edi_tushin_id
			, tg_edi_shop_cd_webpos
			, tg_edi_shop_name_webpos
			, tg_edi_shop_cd
			, gdt_shop_cd
			, gdt_goods_id
			, tg_trn_date

      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End
	  --追加：2018/05/25 - Start
	  -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
    End  -- While

	-- カーソルを閉じる
	close @rs
	-- 開放
	deallocate @rs
	--追加：2018/05/25 - End

  ------------------------------
  -- データ転送
  ------------------------------

      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み


      -- データ転送
      SELECT

	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_zhd ( '
	+ '	 e16_edi_flag '
	+ '	,e16_server_webpos '
	+ '	,e16_dbname_webpos '
	+ '	,e16_shop_cd_webpos '
	+ '	,e16_shop_name_webpos '
	+ '	,e16_shop_cd_primary '
	+ '	,e16_shop_cd '
	+ '	,e16_tushin_id '
	+ '	,e16_hendou_date '
	+ '	,e16_goods_code_kubun '
	+ '	,e16_goods_code '
	+ '	,e16_jan_cd '
	+ '	,e16_kisyu_zaiko_count '
	+ '	,e16_zaiko_count '
	+ '	,e16_tanka '
	+ '	,e16_genka_price '
	+ '	,e16_uri_sum_count '
	+ '	,e16_uri_last_date '
	+ '	,e16_shiire_sum_count '
	+ '	,e16_shiire_last_date '
	+ '	,e16_hpn_sum_count '
	+ '	,e16_hpn_last_date '
	+ '	,e16_ido_sum_count '
	+ '	,e16_ido_last_date '
	+ '  )   '
	+ '  SELECT '
	+ '	 e16_edi_flag = ''0'' '          -- 未処理
	+ '	,e16_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e16_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e16_shop_cd_webpos = t_edi_shop_cd_webpos '
	+ '	,e16_shop_name_webpos = t_edi_shop_name_webpos '
	+ '	,e16_shop_cd_primary = t_edi_shop_cd '
	+ '	,e16_shop_cd = t_edi_shop_cd '
	+ '	,e16_tushin_id = t_edi_tushin_id '
	+ '	,e16_hendou_date = t_trn_date '
	+ '	,e16_goods_code_kubun = '
	+ '	             case '
	+ '	                when gds_goods_type = ''20'' then ''1'' '  -- 書籍
	+ '	                when gds_goods_type = ''21'' then ''2'' '  -- 雑誌
	+ '	                when gds_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+ '	                when gds_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+ '	                else ''0'' '  -- その他
	+ '	             end '
	+ '	,e16_goods_code = '
	+ '	             case '
	+ '	                when gds_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+ '	                when gds_goods_type = ''21'' then gds_jan_cd '  -- 雑誌
	+ '	                when gds_goods_type = ''30'' then gds_jan_cd '  -- CD/DVD
	+ '	                when gds_goods_type = ''31'' then gds_jan_cd '  -- CD/DVD
	+ '	                else gds_jan_cd '  -- その他
	+ '	             end '
	+ '	,e16_jan_cd = gds_jan_cd '
	+ '	,e16_kisyu_zaiko_count = isnull(stv_goods_count,0) '
	+ '	,e16_zaiko_count = stk_goods_count '
	+ '	,e16_tanka = stk_price '
	+ '	,e16_genka_price = stk_cost_price_last '
	+ '	,e16_uri_sum_count = t_uri_sum_count '
	+ '	,e16_uri_last_date = t_uri_last_date '
	+ '	,e16_shiire_sum_count = t_shiire_sum_count '
	+ '	,e16_shiire_last_date = t_shiire_last_date '
	+ '	,e16_hpn_sum_count = t_hpn_sum_count '
	+ '	,e16_hpn_last_date = t_hpn_last_date '
	+ '	,e16_ido_sum_count = t_ido_sum_count '
	+ '	,e16_ido_last_date = t_ido_last_date '
	+ '		    from '
	+ '			#zhd_total '
	+ '			join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  t_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_book '
	+ '			  on '
	+ '			  t_goods_id = gdb_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_magazine '
	+ '			  on '
	+ '			  t_goods_id = gdz_goods_id '
	+ '		    left outer join '
	+ '			wpt_stock_master '
	+ '			  on '
	+ '			  t_goods_id = stk_goods_id '
	+ '			  and t_shop_cd = stk_shop_cd '
	+ '			  and stk_condition_type = ''0'' '
	+ '		    left outer join '
	+ '			wpt_stock_save_master '
	+ '			  on '
	+ '			  t_goods_id = stv_goods_id '
	+ '			  and t_shop_cd = stv_shop_cd '
	+ '			  and stv_condition_type = ''0'' '
	+ '			  and stv_ym = ''' + convert(varchar,dateadd(m,-1,convert(datetime,substring(convert(varchar,@a_start_date,111),1,8) + '01')),111) + ''''
	+ '		    order by '
	+ '			 t_trn_date '
	+ '			,t_shop_cd '
	+ '			,t_goods_id '

      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_stock
		  on
		  e10_edi_trn_id = tst_trn_id
		  and
		  e10_edi_line_no = tst_line_no + 10000
	          join
		wpt_transaction
		  on
		  tst_trn_id = trn_trn_id
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control
		join
		wpt_transaction_stock
		  on
		  e10_edi_trn_id = tst_trn_id
		  and
		  e10_edi_line_no = tst_line_no + 10000
	          join
		wpt_transaction
		  on
		  tst_trn_id = trn_trn_id
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9083,在庫ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_ZAIKO_END:

-- ▼▼▼ 2013/11/21 add
--=================================================
-- 上り在庫変動処理（TONETS-V:T1）
--=================================================
UP_ZAIKOHENDO_T1:
  Declare @e56_edi_flag char (1)
  Declare @e56_edi_timestamp timestamp
  Declare @e56_edi_create_date datetime 
  Declare @e56_edi_update_date datetime 
  Declare @e56_edi_file_line_no int 
  Declare @e56_edi_meisai_no int 
  Declare @e56_edi_error_msg varchar (200)
  Declare @e56_server_webpos varchar (100)
  Declare @e56_dbname_webpos varchar (100)
  Declare @e56_shop_cd_webpos varchar (10)
  Declare @e56_shop_name_webpos varchar (100)
  Declare @e56_seq_no char (5)
  Declare @e56_shop_cd_primary varchar (10)
  Declare @e56_shop_cd varchar (10)
  Declare @e56_tushin_id char (2)

  Declare @e56_update_kubun		char(1)
  Declare @e56_siire_code		char(2)
  Declare @e56_denpyo_no		char(9)
  Declare @e56_denpyo_date		char(8)
  Declare @e56_jan_cd			varchar(20)
  Declare @e56_count_sign		char(1)
  Declare @e56_count			int
  Declare @e56_location1		char(6)
  Declare @e56_location2		char(6)
  Declare @e56_location3		char(6)
  Declare @e56_tohan_group_cd	varchar(20)


  Declare @e56_start_date		datetime
  Declare @e56_end_date			datetime

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9081,在庫変動データ削除不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
		SELECT
			 bes_bookedi_cd
			,bes_book_shop_cd
			,bes_tohan_group_cd
			,shm_shop_cd
			,shm_shop_name
			,mpm_edi_type
		FROM
			wpt_book_edi_setting
		JOIN
			wpt_shop_master
			ON
				bes_shop_cd = shm_shop_cd
		JOIN
			wpt_maker_supplier_master
			ON
				bes_bookedi_cd = mpm_bookedi_cd
				AND
				mpm_shop_cd IS NULL
		WHERE
			bes_bookedi_cd = 'TH'				-- TH:トーハンのみ
			AND
			bes_up_zhd_flag =
				CASE
					WHEN @edi_type in ('56U') THEN '1'		-- 56U起動時のみ
					ELSE bes_up_zhd_flag
				END

  -- カーソルを開く
  Open @rs

  -- @P_INOUT_TMPループ
  Fetch Next From @rs Into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

		--【抽出開始日時】
		--		前回実行日時を抽出
		SELECT
			TOP 1										-- 直近の1件
			@e56_start_date = e10_edi_create_date
		FROM
			wbe_edibook_up_control_tonets_v WITH(NOLOCK)
		WHERE
			e10_edi_shop_cd_webpos = @a_shop_cd
			AND
			e10_edi_tushin_id = @a_tushin_id				-- TH：トーハン
			AND
			e10_edi_trn_id = 0							-- 取引ID：0固定
			AND
			e10_edi_line_no = 0 						-- 行番号：0固定
			AND
			e10_edi_flag = '1'							-- 1:処理済
			AND
			e10_edi_type = @edi_type					-- EDI区分(56U)
		ORDER BY
			e10_edi_create_date DESC								-- IDの降順（直近）
		--		初回時（上り制御に未登録）は、現在日時から5日前の日時をセット
		If IsNull(@e56_start_date,'') = '' Begin
			Set @e56_start_date = @a_start_date
		End

		--【抽出終了日時】
		--		現在日時を変数セット
		Set @e56_end_date = getdate()

		-- 上り制御テーブル追加
		-- ※在庫変動については、取引＋商品別の集計結果を出力するので、現在日時の１件のみ追加

		INSERT wbe_edibook_up_control_tonets_v (
			 e10_edi_tushin_id
			,e10_edi_trn_id
			,e10_edi_line_no
			,e10_edi_flag
			,e10_edi_create_date
			,e10_edi_shop_cd_webpos
			,e10_edi_shop_name_webpos
			,e10_edi_shop_cd
			,e10_tohan_group_cd
			,e10_edi_type
		)
		SELECT
			TOP 1
			 e10_edi_tushin_id = @a_tushin_id			-- TH：トーハン
			,e10_edi_trn_id = 0							-- 取引ID：0固定
			,e10_edi_line_no = 0 						-- 行番号：0固定
			,e10_edi_flag = '0'							-- 0:未処理
			,e10_edi_create_date = @e56_end_date		-- 【抽出終了日時】
			,e10_edi_shop_cd_webpos = @a_shop_cd		-- MS店舗CD
			,e10_edi_shop_name_webpos = @a_shop_name	-- MS店舗名
			,e10_edi_shop_cd = @a_book_shop_cd			-- トーハン書店CD
			,e10_tohan_group_cd = @a_tohan_group_cd		-- トーハングループCD
			,e10_edi_type = @edi_type					-- EDI区分(56U)
		FROM
			wpt_transaction WITH(NOLOCK)
		JOIN
			wpt_transaction_stock WITH(NOLOCK)
			ON
				trn_trn_id = tst_trn_id
		JOIN
			wpt_goods_master WITH(NOLOCK)
			ON 
				tst_goods_id = gds_goods_id
-- ▼▼▼ 2014/08/19 add
		LEFT OUTER JOIN
			wpt_transaction_inout WITH(NOLOCK)
			ON
				trn_trn_id = tso_trn_id
		LEFT OUTER JOIN
			wpt_tonets_move_shop_setting WITH(NOLOCK)
			ON
				trn_shop_cd = tms_shop_cd
				AND
				IsNull(tso_move_shop_cd,'') = tms_move_shop_cd
-- ▲▲▲ 2014/08/19 add
		WHERE
			trn_shop_cd = @a_shop_cd
			AND
			trn_work_type in ( '0210','0214','0215','0230','0231','0234','0235','0240' )
			AND
			trn_create_date >= @e56_start_date			-- 【抽出開始日時】
			AND
			trn_create_date < @e56_end_date				-- 【抽出終了日時】
			AND
			gds_gross_flag = '0'  -- グロス以外
			AND
			tst_condition_type = '0'  -- 新品
			AND
			tst_goods_change_count <> 0  -- 変動したもの
			AND
			-- 変更：2019/07/24 - MS609 - コア - START
			--trn_app_version <> 'P_Tana_Adjust'										-- 棚卸による在庫変動以外を抽出
			trn_app_version NOT IN ('P_Tana_Adjust', 'VJ_recovery_Not_for_56U')			-- 棚卸による在庫変動以外を抽出
			-- 変更：2019/07/24 - MS609 - コア - END
-- ▼▼▼ 2014/08/19 add
			AND
			tms_shop_cd Is Null
-- ▲▲▲ 2014/08/19 add

		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @err_msg = '9084,在庫変動データ抽出エラー'
			GOTO SP_ERR
		End

		  -- 初期値セット
		SELECT
			 @a_edi_error_msg = null         -- エラーメッセージクリア
			,@a_edi_flag = '1'                    -- EDIフラグ実行済み

		-- データ転送
		SELECT
		@a_sql = ''
		+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_tzh ( '
			+ '	 e56_edi_flag '
			+ '	,e56_server_webpos '
			+ '	,e56_dbname_webpos '
			+ '	,e56_shop_cd_webpos '
			+ '	,e56_shop_name_webpos '
			+ '	,e56_shop_cd_primary '
			+ '	,e56_shop_cd '
			+ '	,e56_tushin_id '

			+ '	,e56_update_kubun '
			+ '	,e56_siire_code '
			+ '	,e56_denpyo_no '
			+ '	,e56_denpyo_date '
			+ '	,e56_jan_cd '
			+ '	,e56_count_sign '
			+ '	,e56_count '
			+ '	,e56_tohan_group_cd '
		+ '  )   '
		+ '  SELECT '
			+ '	 e56_edi_flag = ''0'' '          -- 未処理
			+ '	,e56_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e56_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e56_shop_cd_webpos = ' +  dbo.F_sql_mod(cast(@a_shop_cd as varchar(1000)))
			+ '	,e56_shop_name_webpos = ' + dbo.F_sql_mod(cast(@a_shop_name as varchar(1000)))
			+ '	,e56_shop_cd_primary = ' + dbo.F_sql_mod(cast(@a_book_shop_cd as varchar(1000)))		
			+ '	,e56_shop_cd = ' + dbo.F_sql_mod(cast(@a_book_shop_cd as varchar(1000)))	
			+ '	,e56_tushin_id = ' + dbo.F_sql_mod(cast(@a_tushin_id as varchar(1000)))	

			+ '	,e56_update_kubun = '
				+ '	Case trn_work_type '
					+ '	When ''0210'' Then ''1'' '			-- EDI仕入		--> 1:仕入
					+ '	When ''0214'' Then ''1'' '			-- 直接仕入	--> 1:仕入
					+ '	When ''0215'' Then ''6'' '			-- 移動入庫	--> 6:店間移動(受品)
					+ '	When ''0230'' Then ''2'' '			-- 本部返品	--> 2:返品
					+ '	When ''0231'' Then ''2'' '			-- 書籍返品	--> 2:返品
					+ '	When ''0234'' Then ''2'' '			-- 直接返品	--> 2:返品
					+ '	When ''0235'' Then ''5'' '			-- 移動出庫	--> 5:店間移動(総遺品)
					+ '	When ''0240'' Then ''4'' '			-- 在庫操作	--> 4:在庫冊数修正
				+ '	End '
			+ '	,e56_siire_code = ''01'' '					-- 01固定

			+ '	,e56_denpyo_no = trn_trn_id '				-- 取引ID
			+ '	,e56_denpyo_date = Convert(varchar,trn_trn_date,112) '
			+ '	,e56_jan_cd = IsNull(sgd_jan_cd, gds_jan_cd) '
-- ▼▼▼ 2014/06/11 update
			--+ '	,e56_count_sign = '
			--	+ '	Case '
			--		+ '	When Sum(tst_goods_change_count) >= 0 Then ''0'' '	-- 変動数>=0は、0:プラス
			--		+ '	Else ''1'' '										-- 変動数<0は、1:マイナス
			--	+ '	End '
			+ '	,e56_count_sign = '
				+ ' Case trn_work_type '
					-- 0240:在庫操作は赤伝がない為、変動数の値で判断
					+ ' When ''0240'' Then '
						+ '	Case '
							+ '	When Sum(tst_goods_change_count) >= 0 Then ''0'' '	-- 変動数>=0は、0:プラス
							+ '	Else ''1'' '										-- 変動数<0は、1:マイナス
						+ '	End '
					-- 上記以外の業務は、伝票区分で判断
					+ ' Else '
						+ '	Case trn_denpyo_type '
							+ '	When ''0'' Then ''0'' '								-- 伝票区分=0:黒伝は、0:プラス
							+ '	Else ''1'' '										-- 伝票区分=1:赤伝は、1:マイナス
						+ '	End '
				+ '	End '
-- ▲▲▲ 2014/06/11 update
			+ '	,e56_count = Abs(Sum(tst_goods_change_count)) '				-- 変動数を絶対値
			+ '	,e56_tohan_group_cd = ' + dbo.F_sql_mod(cast(@a_tohan_group_cd as varchar(1000)))
		
		+ ' FROM '
			+ ' wpt_transaction WITH(NOLOCK) '
		+ ' JOIN '
			+ ' wpt_transaction_stock WITH(NOLOCK) '
			+ ' ON '
				+ ' trn_trn_id = tst_trn_id '
		+ ' LEFT OUTER JOIN '
			+ ' wpt_transaction_inout WITH(NOLOCK) '
			+ ' ON '
				+ ' trn_trn_id = tso_trn_id '
		+ ' LEFT OUTER JOIN '
			+ ' wpt_maker_supplier_master WITH(NOLOCK) '
			+ ' ON '
				+ ' tso_supplier_id = mpm_supplier_id  '
		+ ' JOIN '
			+ ' wpt_goods_master WITH(NOLOCK) '
			+ ' ON '
				+ ' tst_goods_id = gds_goods_id '
		+ ' JOIN '
			+ ' wpt_shop_master WITH(NOLOCK) '
			+ ' ON '
				+ ' trn_shop_cd = shm_shop_cd '
		+ ' LEFT OUTER JOIN '
			+ ' wpt_shop_goods_master WITH(NOLOCK) '
			+ ' ON '
				+ ' tst_goods_id = sgd_goods_id '
				+ ' AND '
				+ ' sgd_franchise_id = shm_franchise_id '
				+ ' AND '
				+ ' ( sgd_shop_cd = 0 or trn_shop_cd = sgd_shop_cd ) '
				+ ' AND '
				+ ' sgd_delete_flag = ''0'' '
-- ▼▼▼ 2014/08/19 add
		+ ' LEFT OUTER JOIN '
			+ ' wpt_tonets_move_shop_setting WITH(NOLOCK) '
			+ ' ON '
				+ ' trn_shop_cd = tms_shop_cd '
				+ ' AND '
				+ ' IsNull(tso_move_shop_cd,'''') = tms_move_shop_cd '
-- ▲▲▲ 2014/08/19 add
		+ ' WHERE '
			+ ' trn_shop_cd = ' + cast(@a_shop_cd as varchar(1000))
			+ ' AND '
			+ ' trn_work_type in ( ''0210'',''0214'',''0215'',''0230'',''0231'',''0234'',''0235'',''0240'' ) '
			+ ' AND '
			+ ' trn_create_date >= ' + '''' + Convert(varchar,@e56_start_date,111) + ' ' + Convert(varchar,@e56_start_date,114) + '''' + ' '
			+ ' AND '
			+ ' trn_create_date < ' + '''' + Convert(varchar,@e56_end_date,111) + ' ' + Convert(varchar,@e56_end_date,114) + '''' + ' '
			+ ' AND '
			+ ' gds_gross_flag = ''0'' '
			+ ' AND '
			+ ' tst_condition_type = ''0''  '
			+ ' AND '
			+ ' tst_goods_change_count <> 0  '
			+ ' AND '
			+ ' IsNull(mpm_bookedi_cd,'''') <> ''TH'' '			-- トーハン以外
			+ ' AND '
-- 2013/09/04 update（ハンディアップロードで登録されたトランザクションのapp_versionはNULL値の為）
--			+ ' trn_app_version <> ''P_Tana_Adjust'' '			-- 棚卸による在庫変動以外
			-- 変更：2019/07/24 - MS609 - コア - START
			--+ ' IsNull(trn_app_version,'''') <> ''P_Tana_Adjust'' '			-- 棚卸による在庫変動以外
			+ ' IsNull(trn_app_version,'''') NOT IN (''P_Tana_Adjust'', ''VJ_recovery_Not_for_56U'') '			-- 棚卸による在庫変動以外
			-- 変更：2019/07/24 - MS609 - コア - END
-- ▼▼▼ 2014/08/19 add
			+ ' AND '
			+ ' tms_shop_cd Is Null '
-- ▲▲▲ 2014/08/19 add
		+ ' GROUP BY '
			+ ' trn_trn_id '
			+ ' ,trn_shop_cd '
			+ ' ,trn_work_type '
-- ▼▼▼ 2014/06/11 add
			+ ' ,trn_denpyo_type '
-- ▲▲▲ 2014/06/11 add
			+ ' ,CONVERT(varchar,trn_trn_date,112) '
			+ ' ,IsNull(sgd_jan_cd, gds_jan_cd) '
		+ ' ORDER BY '
			+ ' trn_work_type '
			+ ' ,trn_trn_id '

		Exec (@a_sql)
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

	
		-- 次へ
		Fetch next from @rs into
			 @a_tushin_id
			,@a_book_shop_cd
			,@a_tohan_group_cd
			,@a_shop_cd
			,@a_shop_name
			,@a_supplier_edi_type
		End  -- While

		-- カーソルを閉じる
		Close @rs
		-- 開放
		Deallocate @rs
 
      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		wbe_edibook_up_control_tonets_v WITH(NOLOCK)
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
		AND
		e10_edi_type = @edi_type
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control_tonets_v SET
            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control_tonets_v WITH(NOLOCK)
	    where 
		e10_edi_flag = '0'   -- 未処理のみ
		AND
		e10_edi_type = @edi_type

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9083,在庫変動ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_ZAIKOHENDO_T1_END:
-- ▲▲▲ 2013/11/21 add

--=================================================
-- 上り全在庫処理
-- ※up_zhd(e16)にセットする
--=================================================
UP_ZENZAIKO:
  Declare @e18_edi_flag char (1)
  Declare @e18_edi_timestamp timestamp
  Declare @e18_edi_create_date datetime 
  Declare @e18_edi_update_date datetime 
  Declare @e18_edi_file_line_no int 
  Declare @e18_edi_meisai_no int 
  Declare @e18_edi_error_msg varchar (200)
  Declare @e18_server_webpos varchar (100)
  Declare @e18_dbname_webpos varchar (100)
  Declare @e18_shop_cd_webpos varchar (10)
  Declare @e18_shop_name_webpos varchar (100)
  Declare @e18_seq_no char (5)
  Declare @e18_shop_cd_primary varchar (10)
  Declare @e18_shop_cd varchar (10)
  Declare @e18_tushin_id char (2)

  Declare @e18_hendou_date char(8)
  Declare @e18_goods_code_kubun char(1)
  Declare @e18_goods_code varchar(20)
  Declare @e18_jan_cd varchar(20)
  Declare @e18_kisyu_zaiko_count int
  Declare @e18_zaiko_count int
  Declare @e18_tanka money
  Declare @e18_genka_price money
  Declare @e18_uri_sum_count int
  Declare @e18_uri_last_date char(8)
  Declare @e18_shiire_sum_count int
  Declare @e18_shiire_last_date char(8)
  Declare @e18_hpn_sum_count int
  Declare @e18_hpn_last_date char(8)
  Declare @e18_ido_sum_count int
  Declare @e18_ido_last_date char(8)

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9091,全在庫データ削除不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
              ,mpm_edi_type
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
               join
               wpt_maker_supplier_master
                 on
                 bes_bookedi_cd = mpm_bookedi_cd
                 and mpm_shop_cd IS NULL
            where
               bes_up_hpn_flag =
                  case
                     when @edi_type = '11U' then '1'
                     else bes_up_hpn_flag
                  end

               and
               bes_up_hcu_flag =
                  case
                     when @edi_type = '12U' then '1'
                     else bes_up_hcu_flag
                  end
               and
               bes_up_tka_flag =
                  case
                     when @edi_type = '13U' then '1'
                     else bes_up_tka_flag
                  end
               and
               bes_up_urh_flag =
                  case
                     when @edi_type = '14U' then '1'
                     else bes_up_urh_flag
                  end
               and
               bes_up_urd_flag =
                  case
                     when @edi_type = '15U' then '1'
                     else bes_up_urd_flag
                  end
               and
               bes_up_zhd_flag =
                  case
                     when @edi_type = '16U' then '1'
                     else bes_up_zhd_flag
                  end
               and
               bes_up_zzd_flag =
                  case
                     when @edi_type = '18U' then '1'
                     else bes_up_zzd_flag
                  end
			-- ▼▼▼ 2014/07/03 add（TONETS在庫変動データを送信する設定は除外する）
			   and
			   IsNull(bes_tonets_v_up_flag,'0') <> '1'
			-- ▲▲▲ 2014/07/03 add

	-- 全在庫用一時テーブル
	If OBJECT_ID(N'tempdb..#stock_temp', N'U') IS NOT NULL 
		DROP TABLE #stock_temp  -- あれば削除
	CREATE TABLE #stock_temp(
		  t_edi_tushin_id char(2)
		, t_edi_shop_cd_webpos varchar(10)
		, t_edi_shop_name_webpos varchar(100)
		, t_edi_shop_cd varchar(10)
		, t_shop_cd int
		, t_goods_id int
		, t_goods_count int
	)

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type

    -- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

	INSERT #stock_temp(
		  t_edi_tushin_id
		, t_edi_shop_cd_webpos
		, t_edi_shop_name_webpos
		, t_edi_shop_cd
		, t_goods_id
	)
		SELECT
		  t_edi_tushin_id = @a_tushin_id
		, t_edi_shop_cd_webpos = @a_shop_cd
		, t_edi_shop_name_webpos = @a_shop_name
		, t_edi_shop_cd = @a_book_shop_cd
		, t_goods_id = stk_goods_id
		FROM wpt_stock_master
		JOIN wpt_goods_master
		ON stk_goods_id=gds_goods_id
		-- ▼▼▼ 2018/06/26 update
		left outer join wpt_goods_master_book with(nolock)
		on gds_goods_id = gdb_goods_id
		-- ▲▲▲
		WHERE
		  stk_shop_cd=@a_shop_cd
		  AND gds_gross_flag = '0'  -- グロス以外
		  AND gds_jan_cd is not null  -- JANコードnull以外
		  AND stk_condition_type = '0'  -- 新品
		  AND 
		  (
-- ▼▼▼ 2018/06/26 update
--		  (@a_supplier_edi_type = '2' AND gds_goods_type IN ('20', '21'))      -- 書籍・雑誌のみ
		  (@a_supplier_edi_type = '2' AND gds_goods_type IN ('20', '21')and @a_tushin_id <> 'KK')      -- 書籍・雑誌のみ
		  or (@a_supplier_edi_type = '2' AND gds_goods_type = '21' and @a_tushin_id = 'KK')      -- 雑誌のみ
		  or (@a_supplier_edi_type = '2' AND gds_goods_type = '20' and @a_tushin_id = 'KK'
		      and gdb_publisher_cd in ( '04','404','7561','7577','8061','8275','8291','8401','8402','87148','88991'))      -- 書籍のみ出版社限定（KADOKAWA指定）
-- ▲▲▲
-- ▼▼▼ 2014/03/17 update
--		or (@a_supplier_edi_type = '3' and gds_goods_type in ('30', '31')))   -- CD・DVDのみ
		or (@a_supplier_edi_type = '3' and @a_tushin_id <> 'TM' and gds_goods_type in ('30', '31'))
		or (@a_supplier_edi_type = '3' and @a_tushin_id =  'TM' and gds_goods_type in ('30'))
		)   -- CD・DVDのみ
-- ▲▲▲ 2014/03/17 update

      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------
      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

      -- データ転送
      SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_zhd ( '
	+ '	 e16_edi_flag '
	+ '	,e16_server_webpos '
	+ '	,e16_dbname_webpos '
	+ '	,e16_shop_cd_webpos '
	+ '	,e16_shop_name_webpos '
	+ '	,e16_shop_cd_primary '
	+ '	,e16_shop_cd '
	+ '	,e16_tushin_id '
	+ '	,e16_hendou_date '
	+ '	,e16_goods_code_kubun '
	+ '	,e16_goods_code '
	+ '	,e16_jan_cd '
	+ '	,e16_kisyu_zaiko_count '
	+ '	,e16_zaiko_count '
	+ '	,e16_tanka '
	+ '	,e16_genka_price '
	+ '	,e16_uri_sum_count '
	+ '	,e16_uri_last_date '
	+ '	,e16_shiire_sum_count '
	+ '	,e16_shiire_last_date '
	+ '	,e16_hpn_sum_count '
	+ '	,e16_hpn_last_date '
	+ '	,e16_ido_sum_count '
	+ '	,e16_ido_last_date '
	+ '  )   '
	+ '  SELECT '
	+ '	 e16_edi_flag = ''0'' '          -- 未処理
	+ '	,e16_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e16_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e16_shop_cd_webpos = t_edi_shop_cd_webpos '
	+ '	,e16_shop_name_webpos = t_edi_shop_name_webpos '
	+ '	,e16_shop_cd_primary = t_edi_shop_cd '
	+ '	,e16_shop_cd = t_edi_shop_cd '
	+ '	,e16_tushin_id = t_edi_tushin_id '
	+ '	,e16_hendou_date = convert(varchar,GETDATE(),112) '
	+ '	,e16_goods_code_kubun = '
	+ '	             case '
	+ '	                when gds_goods_type = ''20'' then ''1'' '  -- 書籍
	+ '	                when gds_goods_type = ''21'' then ''2'' '  -- 雑誌
	+ '	                when gds_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+ '	                when gds_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+ '	                else ''0'' '  -- その他
	+ '	             end '
	+ '	,e16_goods_code = '
	+ '	             case '
	+ '	                when gds_goods_type = ''20'' and gds_gross_flag = ''0'' then gdb_isbn '    -- 書籍
	+ '	                when gds_goods_type = ''21'' then gds_jan_cd '  -- 雑誌
	+ '	                when gds_goods_type = ''30'' then gds_jan_cd '  -- CD/DVD
	+ '	                when gds_goods_type = ''31'' then gds_jan_cd '  -- CD/DVD
	+ '	                else gds_jan_cd '  -- その他
	+ '	             end '
	+ '	,e16_jan_cd = gds_jan_cd '
	+ '	,e16_kisyu_zaiko_count = isnull(stv_goods_count,0) '
	+ '	,e16_zaiko_count = stk_goods_count '
	+ '	,e16_tanka = stk_price '
	+ '	,e16_genka_price = stk_cost_price_last '
	+ '	,e16_uri_sum_count = 0 '
	+ '	,e16_uri_last_date = ''00000000'' '
	+ '	,e16_shiire_sum_count = 0 '
	+ '	,e16_shiire_last_date = ''00000000'' '
	+ '	,e16_hpn_sum_count = 0 '
	+ '	,e16_hpn_last_date = ''00000000'' '
	+ '	,e16_ido_sum_count = 0 '
	+ '	,e16_ido_last_date = ''00000000'' '
	+ '		    from '
	+ '			#stock_temp '
	+ '			join '
	+ '			wpt_stock_master '
	+ '			  on '
	+ '			  t_goods_id = stk_goods_id '
	+ '			  and t_edi_shop_cd_webpos = stk_shop_cd '
	+ '			  and stk_condition_type = ''0'' '
	+ '			join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  t_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_book '
	+ '			  on '
	+ '			  t_goods_id = gdb_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_magazine '
	+ '			  on '
	+ '			  t_goods_id = gdz_goods_id '
	+ '		    left outer join '
	+ '			wpt_stock_save_master '
	+ '			  on '
	+ '			  t_goods_id = stv_goods_id '
	+ '			  and t_edi_shop_cd_webpos = stv_shop_cd '
	+ '			  and stv_condition_type = ''0'' '
	+ '			  and stv_ym = ''' + convert(varchar,dateadd(m,-1,convert(datetime,substring(convert(varchar,@a_start_date,111),1,8) + '01')),111) + ''''
	+ '		    order by '
	+ '			 t_edi_shop_cd_webpos '
	+ '			,t_goods_id '
	
      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- カウント初期レコードセット

        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = t_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		#stock_temp 
		GROUP BY t_edi_tushin_id
	
	If OBJECT_ID(N'tempdb..#stock_temp', N'U') IS NOT NULL 
		DROP TABLE #stock_temp  -- あれば削除

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9093,全在庫ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

UP_ZENZAIKO_END:

-- 2017/04/13 追加　開始
--=================================================
-- 上り発注処理
--=================================================
UP_HACHU_FUKUSUU:

  Declare @e47_edi_flag char (1)
  Declare @e47_edi_timestamp timestamp  
  Declare @e47_edi_create_date datetime 
  Declare @e47_edi_update_date datetime 
  Declare @e47_edi_file_line_no int 
  Declare @e47_edi_meisai_no int 
  Declare @e47_edi_error_msg varchar (200)
  Declare @e47_server_webpos varchar (100)
  Declare @e47_dbname_webpos varchar (100)
  Declare @e47_shop_cd_webpos varchar (10)
  Declare @e47_shop_name_webpos varchar (100)
  Declare @e47_seq_no char (5)
  Declare @e47_shop_cd_primary varchar (10)
  Declare @e47_shop_cd varchar (10)
  Declare @e47_tushin_id char (2)
  Declare @e47_hachu_date char (8)
  Declare @e47_hachu_time char (6)
  Declare @e47_hachu_kubun char (1)
  Declare @e47_goods_code_kubun char (1)
  Declare @e47_goods_code varchar (20)
  Declare @e47_year char (4)
  Declare @e47_hachu_count int 
  Declare @e47_kaiten_count int 
  Declare @e47_hachu_kanri_code1 varchar (20)
  Declare @e47_hachu_kanri_code2 varchar (20)
  Declare @e47_tana varchar (4)
  Declare @e47_dan varchar (4)
  Declare @e47_retu varchar (4)
  Declare @e47_goods_kubun char (2)
  Declare @e47_b_genre varchar (6)  -- 2009/05/18 char(2) → varchar(6)
  Declare @e47_m_genre varchar (6)  -- 2009/05/18 char(2) → varchar(6)
  Declare @e47_s_genre varchar (6)  -- 2009/05/18 char(2) → varchar(6)
  Declare @e47_order_no varchar (20)
  Declare @e47_order_memo varchar (100)
  Declare @e47_order_biko varchar (50)
  Declare @e47_cd_kikaku_bango varchar (15)
  Declare @e47_rest_kubun char (1)

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9051,発注データ削除不正'
    GOTO SP_ERR
  End
  print @a_start_date
  print @a_end_date
  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
            where
               bes_up_hcu47_flag =
                  case
                     when @edi_type = '47U' then '1'
                     else bes_up_hcu47_flag
                  end

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	-- 発注対象データ抽出
	INSERT wbe_edibook_up_control (
		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		)
	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = tdh_trn_id
		,e10_edi_line_no = tdh_line_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
        -- Ver 09-13 2013/08/06 E.Satoh 複数番線対応 ▼▼▼
        ,e10_edi_shop_cd = CASE WHEN trn_work_type = '0202' THEN    -- 書籍発注時
                ISNULL( ( SELECT dbo.F_Convert_Bansen (             -- 番線（発注先）取得関数
                           @a_tushin_id
                          ,@a_shop_cd
                          ,gdm_media_cd
                          ,gdb_publisher_cd )
                        )
                        ,@a_book_shop_cd        -- EDI_Setting値
                      )
             ELSE
                 @a_book_shop_cd                -- EDI_Setting値
             END 
        -- Ver 09-13 2013/08/06 E.Satoh 複数番線対応 ▲▲▲
		,e10_tohan_group_cd = @a_tohan_group_cd
	       from
		wpv_transaction
		join
		wpt_transaction_hachu
		  on
		  trn_trn_id = tha_trn_id
		join
		wpt_transaction_hachu_details
		  on
		  trn_trn_id = tdh_trn_id
		join
		wpt_maker_supplier_master
		  on
		  tdh_supplier_id = mpm_supplier_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  tdh_trn_id = e10_edi_trn_id
		  and
		  tdh_line_no = e10_edi_line_no
        -- Ver 09-13 2013/08/06 ADD E.Satoh 複数番線対応 ▼▼▼
        LEFT JOIN
            wpt_goods_master WITH(NOLOCK)
            ON gds_goods_id = tdh_goods_id
        LEFT JOIN
            wpt_goods_media_master WITH(NOLOCK)     -- gdm_media_cd 取得のため
            ON gdm_media_id = gds_media_id
        LEFT JOIN 
            wpt_goods_master_book WITH(NOLOCK)      -- gdb_publisher_cd 取得のため
            ON gdb_goods_id = tdh_goods_id
        -- Ver 09-13 2013/08/06 ADD E.Satoh 複数番線対応 ▲▲▲
	       where
		trn_shop_cd = @a_shop_cd
		and
-- ▼▼▼ 2019/08/20 update
--        (trn_work_type = '0202' OR trn_work_type = '0201' OR trn_work_type = '0204') -- 書籍/DISK/GAME発注
        (trn_work_type = '0202' OR trn_work_type = '0201' OR trn_work_type = '0204' OR trn_work_type = '0205') -- 書籍/DISK/GAME/文具発注
-- ▲▲▲ 2019/08/20 update
--		trn_work_type = '0202'  -- 書籍発注
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		-- trn_trn_date >= @a_start_date -- 2017/04/13 更新
		trn_create_date >= @a_start_date
		and
		-- trn_trn_date < @a_end_date -- 2017/04/13 更新
		trn_create_date < @a_end_date
		and
		mpm_bookedi_cd = @a_tushin_id
		and
		(mpm_edi_type = '2' OR mpm_edi_type = '3' OR mpm_edi_type = '4')   -- 書籍/DISK/GAMEＥＤＩシステム
--		mpm_edi_type = '2'   -- 書籍ＥＤＩシステム
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの
		and
		tdh_tel_type = '0'   -- 電話発注以外

	  SELECT @rc = @@ERROR,@row=@@rowcount
	  -- エラーチェック
	  If @rc <> 0 Begin
	    Set @err_msg = '9054,発注データ抽出エラー'
	    GOTO SP_ERR
	  End

	  -- ログ
	  Set @log_msg =
	        'E47U      : pg=[' + object_name(@@PROCID) + ']'	-- 2017/04/13 「47U」に更新する
	        + ',t=[' + isnull(cast(@a_tushin_id as varchar),'') + ']'
	        + ',s=[' + isnull(cast(@a_shop_cd as varchar),'') + ']'
	        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
	        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
	        + ',bs=[' + isnull(cast(@a_book_shop_cd as varchar),'') + ']'
	        + ',st=[' + isnull(cast(@a_start_date as varchar),'') + ']'
	        + ',et=[' + isnull(cast(@a_end_date as varchar),'') + ']'
	  Exec P_LogMsg @log_msg

	-- イニシャル発注対象データ抽出
	INSERT wbe_edibook_up_control (
		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		)
	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = tdn_trn_id
		,e10_edi_line_no = tdn_line_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
		,e10_edi_shop_cd = @a_book_shop_cd
		,e10_tohan_group_cd = @a_tohan_group_cd
	       from
		wpv_transaction
		join
		wpt_transaction_initial
		  on
		  trn_trn_id = tin_trn_id
		join
		wpt_transaction_initial_details
		  on
		  trn_trn_id = tdn_trn_id
		join
		wpt_maker_supplier_master
		  on
		  tdn_supplier_id = mpm_supplier_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  tdn_trn_id = e10_edi_trn_id
		  and
		  tdn_line_no = e10_edi_line_no
	       where
		trn_shop_cd = @a_shop_cd
		and
		trn_work_type = '0200'  -- イニシャル発注
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		-- trn_trn_date >= @a_start_date -- 2017/04/13 更新
		trn_create_date >= @a_start_date
		and
		-- trn_trn_date < @a_end_date -- 2017/04/13 更新
		trn_create_date < @a_end_date
		and
		mpm_bookedi_cd = @a_tushin_id
		and
		mpm_edi_type = '4'   -- GAMEＥＤＩシステム
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの

	  SELECT @rc = @@ERROR,@row=@@rowcount
	  -- エラーチェック
	  If @rc <> 0 Begin
	    Set @err_msg = '9054,イニシャル発注データ抽出エラー'
	    GOTO SP_ERR
	  End

	  -- ログ
	  Set @log_msg =
	        'E47U(Ini) : pg=[' + object_name(@@PROCID) + ']'	-- 2017/04/13 「47U」に更新する
	        + ',t=[' + isnull(cast(@a_tushin_id as varchar),'') + ']'
	        + ',s=[' + isnull(cast(@a_shop_cd as varchar),'') + ']'
	        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
	        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
	  Exec P_LogMsg @log_msg
	  
      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------


      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

    -- データ転送
    -- (1)発注データ
      SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_hcu ( '
	+ '	 e12_edi_flag '
	+ '	,e12_server_webpos '
	+ '	,e12_dbname_webpos '
	+ '	,e12_shop_cd_webpos '
	+ '	,e12_shop_name_webpos '
	+ '	,e12_shop_cd_primary '
	+ '	,e12_shop_cd '
	+ '	,e12_tushin_id '
	+ '	,e12_hachu_date '
	+ '	,e12_hachu_time '
	+ '	,e12_hachu_kubun '
	+ '	,e12_goods_code_kubun '
	+ '	,e12_goods_code '
	+ '	,e12_year '
	+ '	,e12_hachu_count '
	+ '	,e12_kaiten_count '
	+ '	,e12_hachu_kanri_code1 '
	+ '	,e12_hachu_kanri_code2 '
	+ '	,e12_tana '
	+ '	,e12_dan '
	+ '	,e12_retu '
	+ '	,e12_goods_kubun '
	+ '	,e12_b_genre '
	+ '	,e12_m_genre '
	+ '	,e12_s_genre '
	+ '	,e12_order_no '
	+ '	,e12_order_memo '
	+ '	,e12_order_biko '
	+ '	,e12_cd_kikaku_bango '
	+ '	,e12_tohan_group_cd '
	+ '	,e12_floor_cd '         -- ADD Ver 09-14 2013/08/12 E.Satoh フロアコード対応
	+ '	,e12_rest_kubun '
	+ '	,e12_distribution_cd '
	+ '	,e12_hachu_denpyo_no '
	+ '	,e12_hachu_line_no '
	+ '  )   '
	+ '  SELECT '
	+ '	 e12_edi_flag = ''0'' '          -- 未処理
	+ '	,e12_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e12_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e12_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e12_shop_name_webpos = e10_edi_shop_name_webpos '
-- 2012/08/27 update（星光堂の場合、親店舗コードにトーハングループCDをセット）
--	+ '	,e12_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e12_shop_cd_primary = '
	+ '  CASE WHEN e10_edi_tushin_id=''SK'' THEN e10_tohan_group_cd ELSE e10_edi_shop_cd END '
---------------------------------------------------------------------------------
	+ '	,e12_shop_cd = e10_edi_shop_cd '
	+ '	,e12_tushin_id = e10_edi_tushin_id '
	+ '	,e12_hachu_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e12_hachu_time = '
	+ '	              right(''00'' + cast(datepart(hh,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(mi,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(ss,trn_trn_date) as varchar), 2) '
	+ '	,e12_hachu_kubun = tdh_hachu_type '
	+ '	,e12_goods_code_kubun = '
	+ '	             case '
-- 2011/06/01 update
	--+ '	                when gds_goods_type = ''20'' then ''1'' '  -- 書籍
	--+ '	                when gds_goods_type = ''21'' then ''2'' '  -- 雑誌
	--+ '	                when gds_goods_type = ''30'' then ''5'' '  -- CD/DVD
	--+ '	                when gds_goods_type = ''31'' then ''5'' '  -- CD/DVD
	--+ '	                when gds_goods_type = ''40'' then ''G'' '  -- GAME
	+ '	                when plu_goods_type = ''20'' then ''1'' '  -- 書籍
	+ '	                when plu_goods_type = ''21'' then ''2'' '  -- 雑誌
	+ '	                when plu_goods_type = ''30'' then ''5'' '  -- CD/DVD
	+ '	                when plu_goods_type = ''31'' then ''5'' '  -- CD/DVD
	+ '	                when plu_goods_type = ''40'' then ''G'' '  -- GAME
--------------------
	+ '	                else ''0'' '  -- その他
	+ '	             end '
	+ '	,e12_goods_code = '
	+ '	             case '
-- 2011/06/01 update
	--+ '	                when gds_goods_type = ''20'' then gdb_isbn '           -- 書籍
	--+ '	                when gds_goods_type = ''21'' then gds_jan_cd '         -- 雑誌
	--+ '	                when gds_goods_type = ''30'' then gds_jan_cd '         -- CD/DVD
	--+ '	                when gds_goods_type = ''31'' then gds_jan_cd '         -- CD/DVD
	--+ '	                when gds_goods_type = ''40'' '                         -- GAME
	--+ '	                  then cast(gds_koyu_goods_cd as varchar(20)) '
	--+ '	                else gds_jan_cd '  -- その他
	+ '	                when plu_goods_type = ''20'' then dbo.F_Convert_JAN_ISBN(plu_jan_cd) '   -- 書籍(plu_isbnは13桁の為、利用不可)
	+ '	                when plu_goods_type = ''21'' then plu_jan_cd '         -- 雑誌
	+ '	                when plu_goods_type = ''30'' then plu_jan_cd '         -- CD/DVD
	+ '	                when plu_goods_type = ''31'' then plu_jan_cd '         -- CD/DVD
	+ '	                when plu_goods_type = ''40'' '                         -- GAME
	+ '	                  then cast(plu_koyu_goods_cd as varchar(20)) '
	+ '	                else plu_jan_cd '  -- その他
--------------------
	+ '	             end '
	+ '	,e12_year = null '
	+ '	,e12_hachu_count = tdh_goods_count '
	+ '	,e12_kaiten_count = null '
	+ '	,e12_hachu_kanri_code1 = '
	+ '	             case '
	+ '	                when  e10_edi_tushin_id = ''HB'' and tdh_hachu_type = ''2'' ' -- 博文補充の場合レシート番号セット
	+ '	                   then cast(trn_receipt_no as varchar) '
	+ '	                else null '
	+ '	             end '
	+ '	,e12_hachu_kanri_code2 = null '
	+ '	,e12_tana = null '
	+ '	,e12_dan = null '
	+ '	,e12_retu = null '
	+ '	,e12_goods_kubun = null '
	+ '	,e12_b_genre = null '
	+ '	,e12_m_genre = null '
	+ '	,e12_s_genre = null '
	+ '	,e12_order_no = cast(trn_receipt_no as varchar) '
	+ '	,e12_order_memo = '
	+ '		case '
    -- 追加 Ver 09-26 2017/07/12 Khoa(コア) MS-343 【有隣堂対応】日販上り発注　注文メモ　対応 ▼▼▼
	+ '		  when left(tdh_member_order_memo,1) like ''棚'' And SUBSTRING(tdh_member_order_memo,9,1) like ''分'' then tdh_member_order_memo'
	-- 追加 Ver 09-26 2017/07/12 Khoa(コア) MS-343 【有隣堂対応】日販上り発注　注文メモ　対応 ▲▲▲
	+ '		  when isnull(tdh_tana_cd,'''') <> '''' then tdh_tana_cd '
	+ '	            else tdh_member_order_memo '
	+ '	          end '
	+ '	,e12_order_biko = tdh_book_kanri_cd '
	+ '	,e12_cd_kikaku_bango = null '
	+ '	,e12_tohan_group_cd = e10_tohan_group_cd '
    -- Ver 09-14 2013/08/12 E.Satoh フロアコード対応
	+ '	,e12_floor_cd = fcc_floor_cd '              -- フロアコード変換テーブル
	+ '	,e12_rest_kubun = tdh_back_type '
	+ '	,e12_distribution_cd = dbo.F_Convert_Sales_Distribution(e10_edi_tushin_id,mlm_sales_cd) '
	+ '	,e12_hachu_denpyo_no = cast(trn_receipt_no as varchar) '
	+ '	,e12_hachu_line_no = tdh_line_no '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction_hachu_details '
	+ '			  on '
	+ '			  e10_edi_trn_id = tdh_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = tdh_line_no '
	+ '		          join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  tdh_trn_id = trn_trn_id '
	+ '			join '
	+ '			wpt_transaction_hachu '
	+ '			  on '
	+ '			  trn_trn_id = tha_trn_id '
-- 2011/06/01 add --
	+ '			join '
	+ '			wpv_plu '
	+ '			  on '
	+ '			  plu_shop_cd = trn_shop_cd '
	+ '			  and '
	+ '			  plu_goods_id = tdh_goods_id '
--------------------
	+ '			left outer join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  tdh_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_book '
	+ '			  on '
	+ '			  tdh_goods_id = gdb_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_magazine '
	+ '			  on '
	+ '			  tdh_goods_id = gdz_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_disk '
	+ '			  on '
	+ '			  tdh_goods_id = gdd_goods_id '
	+ '			left outer join '
	+ '			wpt_maker_label_master '
	+ '			  on '
	+ '			  gdd_label_cd = mlm_label_cd '
	-- Ver 09-14 2013/08/12 E.Satoh フロアコード対応 ▼▼▼
	+ '			left outer join  '
	+ '			wpt_floor_cd_convert '
	+ '			  on '
	+ '			  fcc_tushin_id = e10_edi_tushin_id '     -- 取次コード
	+ '			  and '
	+ '			  fcc_edi_shop_cd = e10_edi_shop_cd '     -- 番線
	+ '			  and '
	+ '			  fcc_shop_cd = e10_edi_shop_cd_webpos '
	+ '			  and '
	+ '			  fcc_hantei_cd = LEFT(tdh_tana_cd,1) '   -- 変換元判定コード
	-- Ver 09-14 2013/08/12 E.Satoh フロアコード対応 ▲▲▲
	+ '		    where '
	+ '			e10_edi_flag = ''0'' '  -- 未処理のみ
-- ▼▼▼ 2013/07/23 add -- ▼▼▼ 2019/08/20 update

	+ '			and '
--	+ '			(trn_work_type = ''0202'' OR trn_work_type = ''0201'' OR trn_work_type = ''0204'') '  -- 書籍/DISK/GAME発注
	+ '			(trn_work_type = ''0202'' OR trn_work_type = ''0201'' OR trn_work_type = ''0204'' OR trn_work_type = ''0205'') '  -- 書籍/DISK/GAME/文具発注
-- ▲▲▲ 2013/07/23 add -- ▲▲▲ 2019/08/20 update
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '

      Exec (@a_sql)
      SELECT @rc = @@ERROR,@row=@@rowcount
      -- エラーチェック
      If @rc <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- ログ
      Set @log_msg =
        'E47U_SET      : pg=[' + object_name(@@PROCID) + ']'	-- 2017/04/13 「47U」に更新する
        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
     Exec P_LogMsg @log_msg

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)

               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_hachu_details 
		  on 
		  e10_edi_trn_id = tdh_trn_id 
		  and 
		  e10_edi_line_no = tdh_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdh_trn_id = trn_trn_id 
		join 
		wpt_transaction_hachu 
		  on 
		  trn_trn_id = tha_trn_id 
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_hachu_details 
		  on 
		  e10_edi_trn_id = tdh_trn_id 
		  and 
		  e10_edi_line_no = tdh_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdh_trn_id = trn_trn_id 
		join 
		wpt_transaction_hachu 
		  on 
		  trn_trn_id = tha_trn_id 
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

    -- (2)イニシャル発注
      SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_hcu ( '
	+ '	 e12_edi_flag '
	+ '	,e12_server_webpos '
	+ '	,e12_dbname_webpos '
	+ '	,e12_shop_cd_webpos '
	+ '	,e12_shop_name_webpos '
	+ '	,e12_shop_cd_primary '
	+ '	,e12_shop_cd '
	+ '	,e12_tushin_id '
	+ '	,e12_hachu_date '
	+ '	,e12_hachu_time '
	+ '	,e12_goods_code_kubun '
	+ '	,e12_goods_code '
	+ '	,e12_hachu_count '
	+ '	,e12_hachu_denpyo_no '
	+ '	,e12_hachu_line_no '
	+ '	,e12_chumon_denpyo_no '
	+ '	,e12_chumon_line_no '
	+ '  )   '
	+ '  SELECT '
	+ '	 e12_edi_flag = ''0'' '          -- 未処理
	+ '	,e12_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e12_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e12_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e12_shop_name_webpos = e10_edi_shop_name_webpos '
	+ '	,e12_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e12_shop_cd = e10_edi_shop_cd '
	+ '	,e12_tushin_id = e10_edi_tushin_id '
	+ '	,e12_hachu_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e12_hachu_time = '
	+ '	              right(''00'' + cast(datepart(hh,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(mi,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(ss,trn_trn_date) as varchar), 2) '
	+ '	,e12_goods_code_kubun = ''G'' '
	+ '	,e12_goods_code = cast(gds_koyu_goods_cd as varchar(20)) '
	+ '	,e12_hachu_count = tdn_hachu_count '
	+ '	,e12_hachu_denpyo_no = cast(trn_receipt_no as varchar) '
	+ '	,e12_hachu_line_no = tdn_line_no '
	+ '	,e12_chumon_denpyo_no = tin_annai_no '
	+ '	,e12_chumon_line_no = tdn_annai_line_no '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction_initial_details '
	+ '			  on '
	+ '			  e10_edi_trn_id = tdn_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = tdn_line_no '
	+ '		          join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  tdn_trn_id = trn_trn_id '
	+ '			join '
	+ '			wpt_transaction_initial '
	+ '			  on '
	+ '			  trn_trn_id = tin_trn_id '
	+ '			left outer join '
	+ '			wpt_goods_master '
	+ '			  on '
	+ '			  tdn_goods_id = gds_goods_id '
	+ '			left outer join '
	+ '			wpt_goods_master_disk '
	+ '			  on '
	+ '			  tdn_goods_id = gdd_goods_id '
	+ '			left outer join '
	+ '			wpt_maker_label_master '
	+ '			  on '
	+ '			  gdd_label_cd = mlm_label_cd '
	+ '		    where '
	+ '			e10_edi_flag = ''0'' '  -- 未処理のみ
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '

      Exec (@a_sql)
      SELECT @rc = @@ERROR,@row=@@rowcount
      -- エラーチェック
      If @rc <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- ログ
      Set @log_msg =
        'E47U_SET(Ini) : pg=[' + object_name(@@PROCID) + ']'	-- 2017/04/13 「47U」に更新する
        + ',rc=[' + isnull(cast(@rc as varchar),'') + ']'
        + ',row=[' + isnull(cast(@row as varchar),'') + ']'
     Exec P_LogMsg @log_msg

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)

               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_initial_details 
		  on 
		  e10_edi_trn_id = tdn_trn_id 
		  and 
		  e10_edi_line_no = tdn_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdn_trn_id = trn_trn_id 
		join 
		wpt_transaction_initial 
		  on 
		  trn_trn_id = tin_trn_id 
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from 
		wbe_edibook_up_control 
		join 
		wpt_transaction_initial_details 
		  on 
		  e10_edi_trn_id = tdn_trn_id 
		  and 
		  e10_edi_line_no = tdn_line_no 
	          join 
		wpt_transaction 
		  on 
		  tdn_trn_id = trn_trn_id 
		join 
		wpt_transaction_initial 
		  on 
		  trn_trn_id = tin_trn_id 
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9053,発注ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_HACHU_FUKUSUU_END:
-- 2017/04/13 追加　終了

--=================================================
-- 上りポイント変動処理
--=================================================
-- 2011/11/10 M.Nakano
UP_POINT:

  Declare @e50_edi_flag char (1)
  Declare @e50_edi_timestamp timestamp
  Declare @e50_edi_create_date datetime 
  Declare @e50_edi_update_date datetime 
  Declare @e50_edi_file_line_no int 
  Declare @e50_edi_error_msg varchar (200)
  Declare @e50_server_webpos varchar (100)
  Declare @e50_dbname_webpos varchar (100)
  Declare @e50_shop_cd_webpos varchar (10)
  Declare @e50_shop_name_webpos varchar (100)
  Declare @e50_shop_cd_primary varchar (10)
  Declare @e50_shop_cd varchar (10)
  Declare @e50_tushin_id char (2)

  Declare @e50_pos_no int 
  Declare @e50_receipt_no int 
  Declare @e50_trn_date char (8)
  Declare @e50_trn_time char (6)
  Declare @e50_work_type char (4)
  Declare @e50_member_cd varchar(20)
  Declare @e50_point_add int
  Declare @e50_point_add_sign char(1)
  Declare @e50_point_use int
  Declare @e50_point_use_sign char(1)

  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9101,ポイント変動データ削除不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ抽出
  ------------------------------
  Set @rs = cursor static read_only for 
            SELECT
               bes_bookedi_cd
              ,bes_book_shop_cd
              ,bes_tohan_group_cd
              ,shm_shop_cd
              ,shm_shop_name
              ,mpm_edi_type
              ,bes_tohan_ur_format_type
            from
               wpt_book_edi_setting
               join
               wpt_shop_master
                 on
                 bes_shop_cd = shm_shop_cd
               join
               wpt_maker_supplier_master
                 on
                 bes_bookedi_cd = mpm_bookedi_cd
                 and mpm_shop_cd IS NULL
            where
               bes_up_pnt_flag =
                  case
                     when @edi_type = '50U' then '1'
                     else bes_up_pnt_flag
                  end

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
              ,@a_tohan_ur_format_type

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
	INSERT wbe_edibook_up_control (
		 e10_edi_tushin_id
		,e10_edi_trn_id
		,e10_edi_line_no
		,e10_edi_flag
		,e10_edi_create_date
		,e10_edi_shop_cd_webpos
		,e10_edi_shop_name_webpos
		,e10_edi_shop_cd
		,e10_tohan_group_cd
		,e10_tohan_ur_format_type
		)

	    SELECT
		 e10_edi_tushin_id = @a_tushin_id
		,e10_edi_trn_id = trn_trn_id
		,e10_edi_line_no = trn_receipt_no
		,e10_edi_flag = '0'     -- 未処理
		,e10_edi_create_date = getdate()
		,e10_edi_shop_cd_webpos = @a_shop_cd
		,e10_edi_shop_name_webpos = @a_shop_name
		,e10_edi_shop_cd = @a_book_shop_cd
		,e10_tohan_group_cd = @a_tohan_group_cd
		,e10_tohan_ur_format_type = @a_tohan_ur_format_type
	       from
		wpv_transaction
		join
		wpt_transaction_point
		  on
		  trn_trn_id = ttp_trn_id
		left outer join
		wbe_edibook_up_control
		  on
		  @a_tushin_id = e10_edi_tushin_id
		  and
		  trn_trn_id = e10_edi_trn_id
		  and
		  trn_receipt_no = e10_edi_line_no
	       where
		trn_shop_cd = @a_shop_cd
		and
		trn_work_type <> '0013'  -- ポイント更新は除外
		and
		trn_denpyo_type = '0'  -- 黒伝
		and
		trn_create_date >= @a_start_date
		and
		trn_create_date < @a_end_date
		and
		e10_edi_trn_id is null  -- コピーしていないもの
		and
		e10_edi_line_no is null  -- コピーしていないもの

	  -- エラーチェック
	  If @@ERROR <> 0 Begin
	    Set @err_msg = '9104,ポイント変動データ抽出エラー'
	    GOTO SP_ERR
	  End

      -- 次へ
      fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
              ,@a_tohan_ur_format_type
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------

      -- 初期値セット
      SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

      -- データ転送
		-- 光和ＥＤＩ対応
     SELECT
	 @a_sql = ''
	+ '  INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_pnt ( '
	+ '	 e50_edi_flag '
	+ '	,e50_server_webpos '
	+ '	,e50_dbname_webpos '
	+ '	,e50_shop_cd_webpos '
	+ '	,e50_shop_name_webpos '
	+ '	,e50_shop_cd_primary '
	+ '	,e50_shop_cd '
	+ '	,e50_tushin_id '
	+ '	,e50_pos_no '
	+ '	,e50_receipt_no '
	+ '	,e50_staff '
	+ '	,e50_trn_id '
	+ '	,e50_trn_date '
	+ '	,e50_trn_time '
	+ '	,e50_work_type '
	+ '	,e50_member_cd '
	+ '	,e50_point_add '
	+ '	,e50_point_add_sign '
	+ '	,e50_point_use '
	+ '	,e50_point_use_sign '
	+ '  )   '
	+ '  SELECT '
	+ '	 e50_edi_flag = ''0'' '          -- 未処理
	+ '	,e50_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	+ '	,e50_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	+ '	,e50_shop_cd_webpos = e10_edi_shop_cd_webpos '
	+ '	,e50_shop_name_webpos = e10_edi_shop_name_webpos '
	+ '	,e50_shop_cd_primary = e10_edi_shop_cd '
	+ '	,e50_shop_cd = e10_edi_shop_cd '
	+ '	,e50_tushin_id = e10_edi_tushin_id '
	+ '	,e50_pos_no = trn_pos_no '
	+ '	,e50_receipt_no = trn_receipt_no '
	+ '	,e50_staff = trn_staff_cd '
	+ '	,e50_trn_id = trn_trn_id '
	+ '	,e50_trn_date = '
	+ '	              right(''0000'' + cast(datepart(yyyy,trn_trn_date) as varchar), 4 ) + '
	+ '	              right(''00'' + cast(datepart(mm,trn_trn_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(dd,trn_trn_date) as varchar), 2) '
	+ '	,e50_trn_time = '
	+ '	              right(''00'' + cast(datepart(hh,trn_pos_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(mi,trn_pos_date) as varchar), 2 ) + '
	+ '	              right(''00'' + cast(datepart(ss,trn_pos_date) as varchar), 2) '
	+ '	,e50_work_type = trn_work_type '
	+ '	,e50_member_cd = trn_member_cd '
	+ '	,e50_point_add = ABS(ttp_point_add) '
	+ '	,e50_point_add_sign = '
	+ '	             case '
	+ '	                when ttp_point_add < 0 '
	+ '	                   then ''-'' '
	+ '	                   else ''+'' '
	+ '	             End '
	+ '	,e50_point_use = ABS(ttp_point_use) '
	+ '	,e50_point_use_sign = '
	+ '	             case '
	+ '	                when ttp_point_use < 0 '
	+ '	                   then ''-'' '
	+ '	                   else ''+'' '
	+ '	             End '
	+ '		    from '
	+ '			wbe_edibook_up_control '
	+ '			join '
	+ '			wpt_transaction '
	+ '			  on '
	+ '			  e10_edi_trn_id = trn_trn_id '
	+ '			  and '
	+ '			  e10_edi_line_no = trn_receipt_no '
	+ '			join '
	+ '			wpt_transaction_point '
	+ '			  on '
	+ '			  trn_trn_id = ttp_trn_id '
	+ '		    where '
	+ '			e10_edi_flag = ''0'' ' -- 未処理のみ
	+ '		    order by '
	+ '			 e10_edi_trn_id '
	+ '			,e10_edi_line_no '

      Exec (@a_sql)
      -- エラーチェック
      If @@ERROR <> 0 Begin
          Set @a_edi_flag = '3'  -- エラー
      End

      -- カウント初期レコードセット
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = e10_edi_tushin_id
           ,t_count_all = count(*)
           ,t_count_ok =
             Case
               when @a_edi_flag = '1' then count(*)
               else 0
             End
           ,t_count_wa =
             Case
               when @a_edi_flag = '2' then count(*)
               else 0
             End
           ,t_count_ng =
             Case
               when @a_edi_flag = '3' then count(*)
               else 0
             End
	    from
		wbe_edibook_up_control
		join
		wpt_transaction
		  on
		  e10_edi_trn_id = trn_trn_id
		  and
		  e10_edi_line_no = trn_receipt_no
		join
		wpt_transaction_point
		  on
		  trn_trn_id = ttp_trn_id
	    where 
		e10_edi_flag = '0'  -- 未処理のみ
	    group by
		e10_edi_tushin_id

      -- 処理結果記録
      UPDATE wbe_edibook_up_control SET
            e10_edi_flag = @a_edi_flag
	    from
		wbe_edibook_up_control
		join
		wpt_transaction
		  on
		  e10_edi_trn_id = trn_trn_id
		  and
		  e10_edi_line_no = trn_receipt_no
		join
		wpt_transaction_point
		  on
		  trn_trn_id = ttp_trn_id
	    where 
		e10_edi_flag = '0'   -- 未処理のみ

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9103,ポイント変動ログ出力エラー'

    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

UP_POINT_END:


--=================================================
-- 【トップカルチャー本部連動】上り取引明細処理		-- 2012/09/03 add
--=================================================
UP_MEISAI_URIAGE_TPC:


  Declare @e51_edi_flag char (1)
  Declare @e51_edi_timestamp timestamp
  Declare @e51_edi_create_date datetime 
  Declare @e51_edi_update_date datetime 
  Declare @e51_edi_file_line_no int 
  Declare @e51_edi_error_msg varchar (200)
  Declare @e51_server_webpos varchar (100)
  Declare @e51_dbname_webpos varchar (100)
  Declare @e51_shop_cd_webpos varchar (10)
  Declare @e51_shop_name_webpos varchar (100)
  Declare @e51_shop_cd_primary varchar (10)
  Declare @e51_shop_cd varchar (10)
  Declare @e51_tushin_id char (2)

	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9071,取引明細削除不正'
		GOTO SP_ERR
	End

  ------------------------------
  -- データ抽出
  ------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_tpc_flag =
		Case
			When @edi_type = '51U' Then '1'
			Else bes_up_tpc_flag
		End
		
	-- カーソルを開く
	open @rs

	-- @P_INOUT_TMPループ
	fetch next from @rs into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

		-- 元の集計クエリ
		INSERT wbe_edibook_up_control (
			 e10_edi_tushin_id
			,e10_edi_trn_id
			,e10_edi_line_no
			,e10_edi_flag
			,e10_edi_create_date
			,e10_edi_shop_cd_webpos
			,e10_edi_shop_name_webpos
			,e10_edi_shop_cd
			)

		SELECT
			 e10_edi_tushin_id = @a_tushin_id
			,e10_edi_trn_id = tdu_trn_id		-- 取引ID
			,e10_edi_line_no = tdu_line_no		-- レシート番号（取引明細時は行番号をセット）
			,e10_edi_flag = '0'     -- 未処理
			,e10_edi_create_date = getdate()
			,e10_edi_shop_cd_webpos = @a_shop_cd
			,e10_edi_shop_name_webpos = @a_shop_name
			,e10_edi_shop_cd = @a_book_shop_cd
		FROM
			wpt_transaction with(nolock)			-- ※売上、売上返品も送信する為、wpt_transactionを利用
		JOIN
			wpt_transaction_uriage with(nolock)
			ON
				trn_trn_id = tur_trn_id
		JOIN
			wpt_transaction_uriage_details with(nolock)
			ON
				trn_trn_id = tdu_trn_id
		JOIN
			wpt_goods_master with(nolock)
			ON
				tdu_goods_id = gds_goods_id
		JOIN
			wpt_shop_master with(nolock)
			ON
				trn_shop_cd = shm_shop_cd
		LEFT OUTER JOIN
			wpt_shop_goods_master with(nolock)
			ON
				gds_goods_id = sgd_goods_id
				AND
				shm_franchise_id = sgd_franchise_id
				AND
				( sgd_shop_cd = 0 OR shm_shop_cd = sgd_shop_cd )
				AND
				sgd_delete_flag = '0'
		LEFT OUTER JOIN
			wbe_edibook_up_control with(nolock)
			ON
				@a_tushin_id = e10_edi_tushin_id
				and
				tdu_trn_id = e10_edi_trn_id
				and
				tdu_line_no = e10_edi_line_no
		WHERE
			trn_shop_cd = @a_shop_cd
			and
			trn_work_type in ( '0000','0001' )  -- 売上、売上返金
			and
			trn_denpyo_type = '0'  -- 黒伝
			and
			trn_create_date >= @a_start_date
			and
			trn_create_date < @a_end_date
			and
			e10_edi_trn_id is null  -- コピーしていないもの
			and
			e10_edi_line_no is null  -- コピーしていないもの
			and
			tdu_set_type <> '9'  -- セット親以外
			and
			tdu_jan_cd is not null  -- JANコードnull以外
			and
			IsNull(sgd_jan_cd,gds_jan_cd) is not null  -- JANが設定されているもの
			--and
			--((@a_supplier_edi_type = '2' and tdu_goods_type in ('20', '21'))      -- 書籍・雑誌のみ
			--or (@a_supplier_edi_type = '3' and tdu_goods_type in ('30', '31')))   -- CD・DVDのみ
			--and
			--gds_gross_flag = '0'  -- グロス以外


		-- エラーチェック
		If @@ERROR <> 0 Begin
		Set @err_msg = '9074,取引明細抽出エラー'
		GOTO SP_ERR
		End

      -- 次へ
      Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------

	-- 初期値セット
	SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	-- データ転送
	SELECT
	 @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_itm ( '
			+ '	 e51_edi_flag '
			+ '	,e51_server_webpos '
			+ '	,e51_dbname_webpos '
			+ '	,e51_shop_cd_webpos '
			+ '	,e51_shop_name_webpos '
			+ '	,e51_shop_cd_primary '
			+ '	,e51_shop_cd '
			+ '	,e51_tushin_id '

			+ '	,e51_shop_cd_convert '
			+ '	,e51_uriage_date '
			+ '	,e51_pos_no '
			+ '	,e51_eda_no '
			+ '	,e51_receipt_no '

			+ '	,e51_line_no '
			+ '	,e51_item_type '
			+ '	,e51_subitem_type1 '
			+ '	,e51_subitem_type2 '
			+ '	,e51_plu_cd '

			+ '	,e51_bumon_cd '
			+ '	,e51_plu_price '
			+ '	,e51_plu_cost_price '
			+ '	,e51_input_type '
			+ '	,e51_uriage_count '

			+ '	,e51_uriage_price '
			+ '	,e51_tanpin_nebiki_price '
			+ '	,e51_nebiki_price '
			+ '	,e51_anbun_nebiki_price '
			+ '	,e51_tax_type '

			+ '	,e51_price_default '
		+ ' ) '
		+ ' SELECT '
			+ '	 e51_edi_flag = ''0'' '          -- 未処理
			+ '	,e51_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e51_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e51_shop_cd_webpos = e10_edi_shop_cd_webpos '
			+ '	,e51_shop_name_webpos = e10_edi_shop_name_webpos '
			+ '	,e51_shop_cd_primary = e10_edi_shop_cd '
			+ '	,e51_shop_cd = e10_edi_shop_cd '
			+ '	,e51_tushin_id = e10_edi_tushin_id '

			-- 店舗コード（トップカルチャー用）
			+ '	,e51_shop_cd_convert = e10_edi_shop_cd '
			-- 売上日（取引日時の日付[YYYY/MM/DD]）
			+ '	,e51_uriage_date = Convert(varchar,trn_trn_date,111) '
			-- POS番号
			+ ' ,e51_pos_no = trn_pos_no '
			-- 枝番
			+ ' ,e51_eda_no = '''' '				-- ※何をセットするか確認中
			-- レシート番号（取引明細は4桁の為、強制的に下4桁をセット）
			-- 2012/10/26 update（レシート番号8桁対応）
			--+ '	,e51_receipt_no = right(''00000000'' + Convert(varchar,trn_receipt_no),4) '
			+ '	,e51_receipt_no = right(''00000000'' + Convert(varchar,trn_receipt_no),8) '
			-- 行番号
			+ ' ,e51_line_no = tdu_line_no '
			-- アイテムタイプ（01:売上、02:売上返品）
			+ ' ,e51_item_type = '
				+ ' Case trn_work_type '
					+ ' When ''0000'' Then ''01'' '
					+ ' Else ''02'' '
				+ ' End '
			-- サブアイテムタイプ１（01:売上、02:売上返品）
			+ ' ,e51_subitem_type1 = '
				+ ' Case trn_work_type '
					+ ' When ''0000'' Then ''01'' '
					+ ' Else ''02'' '
				+ ' End '
			-- サブアイテムタイプ２（01:通常商品、02:グロス商品）
			+ ' ,e51_subitem_type2 = '
				+ ' Case IsNull(sgd_gross_flag,gds_gross_flag) '
					+ ' When ''0'' Then ''01'' '
					+ ' Else ''02'' '
				+ ' End '
			-- JANコード
			+ ' ,e51_plu_cd = IsNull(tdu_jan_cd,IsNull(sgd_jan_cd,gds_jan_cd)) '

			-- 部門コード（分類コード5桁のうち下4桁）
-- 2012/09/10 update（書籍の場合の分類変換対応）
--			+ ' ,e51_bumon_cd = IsNull(tcb.tcb_bumon_cd, tcb2.tcb_bumon_cd) '
			+ ' ,e51_bumon_cd = '
				+ ' case when tdu_goods_type = ''20'' '
				+ ' 	  then  '
				+ ' 		case '
				+ ' 			when gdb_c_code = ''0034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''0036'' then ''1130'' '
				+ ' 			when gdb_c_code = ''0082'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''01'' then ''1040'' '
				+ ' 			when gdb_c_code = ''0200'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''037'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''038'' then ''1090'' '
				+ ' 			when gdb_c_code = ''1033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''1034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''1036'' then ''1130'' '

				+ ' 			when gdb_c_code = ''1082'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''11'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''200'' then ''1140'' '
				+ ' 			when gdb_c_code = ''2033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''2034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''2036'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''203'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''21'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''21'' then ''1040'' '
				+ ' 			when gdb_c_code = ''2241'' then ''1130'' '

				+ ' 			when Substring(gdb_c_code,1,2) = ''25'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''25'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''26'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' then ''1090'' '
				+ ' 			when gdb_c_code = ''3033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''3034'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''31'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''51'' then ''1040'' '

				+ ' 			when Substring(gdb_c_code,1,2) = ''51'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''55'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' then ''1100'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''65'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' then ''1070'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''75'' then ''1080'' '

				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''85'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' then ''1060'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''91'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,2,1) = ''1'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,2,2) = ''23'' then ''1130'' '

				+ ' 			when Substring(gdb_c_code,2,1) = ''2'' then ''1050'' '
				+ ' 			when Substring(gdb_c_code,2,1) = ''5'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''1'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''25'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''26'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''2'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''3'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''4'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''50'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''52'' then ''1140'' '

				+ ' 			when Substring(gdb_c_code,3,2) = ''54'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''5'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''63'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''6'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''75'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''76'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''77'' then ''1100'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''7'' then ''1120'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''8'' then ''1120'' '

				+ ' 			when Substring(gdb_c_code,3,1) = ''9'' then ''1120'' '
				+ ' 			else ''1990'' '
				+ ' 		end '
				+ ' 	  else IsNull(tcb.tcb_bumon_cd, tcb2.tcb_bumon_cd) '
				+ '   End '
--------------------------------------------------------------
			-- 単価
			+ ' ,e51_plu_price = '
				-- 2012/10/30 update
				--+ ' Case '
				--	+ ' When tdu_plu_price <> 0 Then abs(tdu_plu_price) '
				--	+ ' Else abs(tdu_price) '
				--+ ' End '
				+ ' abs(tdu_price) '
			-- 原価
			+ ' ,e51_plu_cost_price = IsNull(sgd_cost_price,gds_cost_price) '
			-- 入力区分（ゼロ固定）
			+ ' ,e51_input_type = ''0'' '
			-- 買上げ点数（小数点以下第２位までの為、数量×100）
			+ ' ,e51_uriage_count = '
				+ ' Case '
					+ ' When tdu_set_type = ''1'' Then abs(tdu_set_selling_count) * 100 '
					+ ' Else abs(tdu_selling_count) * 100 '
				+ ' End '
			-- 商品合計額（単価×買上げ点数）
			+ ' ,e51_uriage_price = '
				-- 2012/10/30 update
				--+ ' Case '
				--	+ ' When tdu_plu_price <> 0 Then abs(tdu_plu_price) '
				--	+ ' Else abs(tdu_price) '
				--+ ' End '
				--+ ' * '
				--+ ' Case '
				--	+ ' When tdu_set_type = ''1'' Then abs(tdu_set_selling_count) '
				--	+ ' Else abs(tdu_selling_count) '
				--+ ' End '
				+ ' abs(tdu_price) '
				+ ' * '
				+ ' Case '
					+ ' When tdu_set_type = ''1'' Then abs(tdu_set_selling_count) '
					+ ' Else abs(tdu_selling_count) '
				+ ' End '
			-- 単品値引割引額（単品値引合計）
			+ '	,e51_tanpin_nebiki_price = '
				+ ' Case '
					--+ ' When tdu_set_type = ''1'' Then Round( abs(tdu_set_unit_discount_price) / abs(tdu_set_selling_count), 0 ) '
					--+ ' Else Round( abs(tdu_unit_discount_price) / abs(tdu_selling_count), 0 ) '
					+ ' When tdu_set_type = ''1'' Then abs(tdu_set_unit_discount_price) '
					+ ' Else abs(tdu_unit_discount_price) '
				+ ' End '
			-- 値引割引合計額（単品値引合計×買上げ点数）
			+ '	,e51_nebiki_price = '
				+ ' Case '
					+ ' When tdu_set_type = ''1'' Then abs(tdu_set_unit_discount_price) * abs(tdu_selling_count) '
					+ ' Else abs(tdu_unit_discount_price) * abs(tdu_selling_count) '
				+ ' End '
			-- 按分値引割引合計額（小計値引×商品合計額÷取引合計額　　※端数処理：四捨五入）
			+ '	,e51_anbun_nebiki_price = '
				+ ' Case When ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) > 0 Then ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) Else 0 End '
				--+ ' Case When tur_goods_sum <> 0 Then '
				--	+ '	Round( '
				--		-- 売上ヘッダ:合計値引額計
				--		+ '	abs(tur_discount_sum) '
				--		-- ×
				--		+ '	* '
				--		-- 商品合計額
				--		+ ' Case '
				--			+ ' When tdu_plu_price <> 0 Then abs(tdu_plu_price) '
				--			+ ' Else abs(tdu_price) '
				--		+ ' End '
				--		+ ' * '
				--		+ ' Case '
				--			+ ' When tdu_set_type = ''1'' Then abs(tdu_set_selling_count) '
				--			+ ' Else abs(tdu_selling_count) '
				--		+ ' End '
				--		-- ÷
				--		+ ' / '
				--		-- 売上ヘッダ:取引合計額
				--		+ ' abs(tur_goods_sum) '
				--	+ ' ,0 ) '
				--+ ' Else 0 '
				--+ ' End '
			-- 税区分
			+ ' ,e51_tax_type = '
				-- 2012/10/30 update
				--+ ' Case IsNull(sgd_tax_type,gds_tax_type) '
				--	+ ' When ''0'' Then ''01'' '
				--	+ ' When ''1'' Then ''03'' '
				--	+ ' When ''2'' Then ''05'' '
				--+ ' End '
				+ ' Case tdu_tax_type '
					+ ' When ''0'' Then ''01'' '
					+ ' When ''1'' Then ''03'' '
					+ ' When ''2'' Then ''05'' '
				+ ' End '
			-- 本体価格
			+ ' ,e51_price_default = '
				-- 2012/10/30 update
				--+ ' Case IsNull(sgd_price_type,gds_price_type) '
				--	+ ' When ''0'' Then '
				--		+ ' Case '
				--			+ ' When tdu_plu_price <> 0 Then abs(tdu_plu_price) '
				--			+ ' Else abs(tdu_price) '
				--		+ ' End '
				--	+ ' When ''1'' Then '
				--		+ ' Round( Case '
				--			+ ' When tdu_plu_price <> 0 Then abs(tdu_plu_price) / ( 100 + ' + Convert(varchar,@a_tax_rate) + ' ) * 100 '
				--			+ ' Else abs(tdu_price) / ( 1 + ' + Convert(varchar,@a_tax_rate) + ' ) * 100 '
				--		+ ' End, 0 ) '
				--	+ ' When ''2'' Then '
				--		+ ' Case '
				--			+ ' When tdu_plu_price <> 0 Then abs(tdu_plu_price) '
				--			+ ' Else abs(tdu_price) '
				--		+ ' End '
				--+ ' End '
				+ ' Case tdu_tax_type '
					+ ' When ''0'' Then '
						+ ' abs(tdu_price) '
					+ ' When ''1'' Then '
						+ ' abs(tdu_price) '
						+ ' - '
						+ ' FLOOR( abs(tdu_price) * ' + Convert(varchar,@a_tax_rate) + ' / ( 100 + ' + Convert(varchar,@a_tax_rate) + ' ) ) '
					+ ' When ''2'' Then '
						+ ' abs(tdu_price) '
				+ ' End '
	 Set @a_sql2 = ''
		+ ' FROM '
			+ ' wbe_edibook_up_control with(nolock) '
		+ ' JOIN '
			+ ' wpt_transaction_uriage_details with(nolock) '
			+ ' ON '
				+ ' e10_edi_trn_id = tdu_trn_id '
				+ ' AND '
				+ ' e10_edi_line_no = tdu_line_no '
		+ ' JOIN '
			+ ' wpt_transaction with(nolock) '
			+ ' ON '
				+ ' tdu_trn_id = trn_trn_id '
		+ ' JOIN '
			+ ' wpt_transaction_uriage with(nolock) '
			+ ' ON '
				+ ' trn_trn_id = tur_trn_id '
		+ ' JOIN '
			+ ' wpt_goods_master with(nolock) '
			+ ' ON '
				+ ' tdu_goods_id = gds_goods_id '
		+ ' JOIN '
			+ ' wpt_shop_master with(nolock) '
			+ ' ON '
				+ ' trn_shop_cd = shm_shop_cd '
		+ ' LEFT OUTER JOIN '
			+ ' wpt_shop_goods_master with(nolock) '
			+ ' ON '
				+ ' gds_goods_id = sgd_goods_id '
				+ ' AND '
				+ ' shm_franchise_id = sgd_franchise_id '
				+ ' AND '
				+ ' ( sgd_shop_cd = 0 OR shm_shop_cd = sgd_shop_cd ) '
				+ ' AND '
				+ ' sgd_delete_flag = ''0'' '
		+ ' LEFT OUTER JOIN '
			+ ' wbe_topculture_bumon_convert as tcb with(nolock) '
			+ ' ON '
				+ ' tdu_jan_cd = tcb.tcb_jan_cd '
		+ ' LEFT OUTER JOIN '
			+ ' wbe_topculture_bumon_convert as tcb2 with(nolock) '
			+ ' ON '
				+ ' tdu_media_cd = tcb2.tcb_media_cd '
		+ ' LEFT OUTER JOIN '
			+ ' wpt_goods_master_book with(nolock) '
			+ ' ON '
				+ ' gdb_goods_id = tdu_goods_id '
		+ ' WHERE '
			+ ' e10_edi_flag = ''0'' ' -- 未処理のみ
		+ ' ORDER BY '
			+ '  trn_shop_cd '
			+ ' ,Convert(varchar,trn_trn_date,111) '
			+ ' ,trn_pos_no '
			+ ' ,trn_receipt_no '
			+ ' ,tdu_line_no '

	Exec (@a_sql + @a_sql2)
	-- エラーチェック
	If @@ERROR <> 0 Begin
		Set @a_edi_flag = '3'  -- エラー
	End

	-- カウント初期レコードセット
	INSERT INTO #count_tbl (
		t_exec_id
		,t_tushin_id
		,t_count_all
		,t_count_ok
		,t_count_wa
		,t_count_ng
	)
	SELECT
		t_exec_id = substring(@edi_type,1,2)
		,t_tushin_id = e10_edi_tushin_id
		,t_count_all = count(*)
		,t_count_ok =
			Case
				When @a_edi_flag = '1' Then count(*)
				Else 0
			End
		,t_count_wa =
			Case
				When @a_edi_flag = '2' Then count(*)
				Else 0
			End
		,t_count_ng =
			Case
				When @a_edi_flag = '3' Then count(*)
				Else 0
			End
	FROM
		wbe_edibook_up_control
	JOIN
		wpt_transaction_uriage_details
		ON
			e10_edi_trn_id = tdu_trn_id
			AND
			e10_edi_line_no = tdu_line_no
	JOIN
		wpt_transaction
		ON
			tdu_trn_id = trn_trn_id
	JOIN
		wpt_transaction_uriage
		ON
			trn_trn_id = tur_trn_id
	WHERE 
		e10_edi_flag = '0'  -- 未処理のみ
	GROUP BY
		e10_edi_tushin_id

	-- 処理結果記録
	UPDATE
		wbe_edibook_up_control
	SET
		e10_edi_flag = @a_edi_flag
	FROM
		wbe_edibook_up_control
	JOIN
		wpt_transaction_uriage_details
		ON
			e10_edi_trn_id = tdu_trn_id
			AND
			e10_edi_line_no = tdu_line_no
	JOIN
		wpt_transaction
		ON
			tdu_trn_id = trn_trn_id
	JOIN
		wpt_transaction_uriage
		ON
			trn_trn_id = tur_trn_id
	WHERE 
		e10_edi_flag = '0'   -- 未処理のみ

	------------------------------
	-- ログ出力
	------------------------------
	Exec @rc = P_EDI_Book_WriteLog
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
		,@exec_start_time = @a_exec_start_time
	-- エラーチェック
	If @rc <> 0 or @@ERROR <> 0 Begin
		Set @err_msg = '9073,取引明細出力エラー'

		GOTO SP_ERR
	End

	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl


	--終了
	GOTO SP_OK

UP_MEISAI_URIAGE_TPC_END:

--=================================================
-- 【トップカルチャー本部連動】上り取引合計処理		-- 2012/09/03 add
--=================================================
UP_TOTAL_URIAGE_TPC:

  Declare @e52_edi_flag char (1)
  Declare @e52_edi_timestamp timestamp
  Declare @e52_edi_create_date datetime 
  Declare @e52_edi_update_date datetime 
  Declare @e52_edi_file_line_no int 
  Declare @e52_edi_error_msg varchar (200)
  Declare @e52_server_webpos varchar (100)
  Declare @e52_dbname_webpos varchar (100)
  Declare @e52_shop_cd_webpos varchar (10)
  Declare @e52_shop_name_webpos varchar (100)
  Declare @e52_shop_cd_primary varchar (10)
  Declare @e52_shop_cd varchar (10)
  Declare @e52_tushin_id char (2)

	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9071,取引合計削除不正'
		GOTO SP_ERR
	End

  ------------------------------
  -- データ抽出
  ------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_tpc_flag =
		Case
			When @edi_type = '52U' Then '1'
			Else bes_up_tpc_flag
		End
		
	-- カーソルを開く
	open @rs

	-- @P_INOUT_TMPループ
	fetch next from @rs into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

		-- 元の集計クエリ
		INSERT wbe_edibook_up_control (
			 e10_edi_tushin_id
			,e10_edi_trn_id
			,e10_edi_line_no
			,e10_edi_flag
			,e10_edi_create_date
			,e10_edi_shop_cd_webpos
			,e10_edi_shop_name_webpos
			,e10_edi_shop_cd
			)

		SELECT
			 e10_edi_tushin_id = @a_tushin_id
			,e10_edi_trn_id = trn_trn_id			-- 取引ID
--			,e10_edi_line_no = trn_receipt_no		-- レシート番号（取引合計時はレシート番号をセット）
			,e10_edi_line_no = 0					-- 0固定（取引合計時は0をセット）	2012/09/06
			,e10_edi_flag = '0'     -- 未処理
			,e10_edi_create_date = getdate()
			,e10_edi_shop_cd_webpos = @a_shop_cd
			,e10_edi_shop_name_webpos = @a_shop_name
			,e10_edi_shop_cd = @a_book_shop_cd
		FROM
			wpt_transaction with(nolock)			-- ※売上、売上返品も送信する為、wpt_transactionを利用
		JOIN
			wpt_transaction_uriage with(nolock)
			ON
				trn_trn_id = tur_trn_id
		LEFT OUTER JOIN
			wbe_edibook_up_control with(nolock)
			ON
				@a_tushin_id = e10_edi_tushin_id
				and
				trn_trn_id = e10_edi_trn_id
				and
--				trn_receipt_no = e10_edi_line_no
				e10_edi_line_no = 0					-- 0固定（取引合計時は0をセット）	2012/09/06
		WHERE
			trn_shop_cd = @a_shop_cd
			and
			trn_work_type in ( '0000','0001' )  -- 売上、売上返金
			and
			trn_denpyo_type = '0'  -- 黒伝
			and
			trn_create_date >= @a_start_date
			and
			trn_create_date < @a_end_date
			and
			e10_edi_trn_id is null  -- コピーしていないもの
			and
			e10_edi_line_no is null  -- コピーしていないもの

		-- エラーチェック
		If @@ERROR <> 0 Begin
		Set @err_msg = '9074,取引合計抽出エラー'
		GOTO SP_ERR
		End


      -- 次へ
      Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ転送
  ------------------------------

	-- 初期値セット
	SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	-- データ転送
	SELECT
	 @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_ttl ( '
			+ '	 e52_edi_flag '
			+ '	,e52_server_webpos '
			+ '	,e52_dbname_webpos '
			+ '	,e52_shop_cd_webpos '
			+ '	,e52_shop_name_webpos '
			+ '	,e52_shop_cd_primary '
			+ '	,e52_shop_cd '
			+ '	,e52_tushin_id '

			+ '	,e52_shop_cd_convert '
			+ '	,e52_uriage_date '
			+ '	,e52_pos_no '
			+ '	,e52_receipt_no '
			+ '	,e52_kijun_date '
			+ '	,e52_pos_date '
			+ '	,e52_pos_time '
		+ ' ) '
		+ ' SELECT '
			+ '	 e52_edi_flag = ''0'' '          -- 未処理
			+ '	,e52_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e52_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e52_shop_cd_webpos = e10_edi_shop_cd_webpos '
			+ '	,e52_shop_name_webpos = e10_edi_shop_name_webpos '
			+ '	,e52_shop_cd_primary = e10_edi_shop_cd '
			+ '	,e52_shop_cd = e10_edi_shop_cd '
			+ '	,e52_tushin_id = e10_edi_tushin_id '

			-- 店舗コード（トップカルチャー用）
			+ '	,e52_shop_cd_convert = e10_edi_shop_cd '
			-- 売上日（取引日時の日付[YYYY/MM/DD]）
			+ '	,e52_uriage_date = Convert(varchar,trn_trn_date,111) '
			-- POS番号
			+ ' ,e52_pos_no = trn_pos_no '
			-- レシート番号（8桁だが、取引明細の4桁と合わせる為に、強制的に下4桁をセット）
			-- 2012/10/26 update（レシート番号8桁対応）
			--+ '	,e52_receipt_no = right(''00000000'' + Convert(varchar,trn_receipt_no),4) '
			+ '	,e52_receipt_no = right(''00000000'' + Convert(varchar,trn_receipt_no),8) '
			-- 基準日（取引日時の日付[YYYY/MM/DD]）
			+ '	,e52_kijun_date = Convert(varchar,trn_trn_date,111) '
			-- 取引日付（POS日時の日付[YYYY/MM/DD]）
			+ '	,e52_pos_date = Convert(varchar,trn_pos_date,111) '
			-- 取引時刻（POS日時の時刻[HHMMSS00]）
			+ '	,e52_pos_time = Substring(Convert(varchar,trn_pos_date,114),1,2) + Substring(Convert(varchar,trn_pos_date,114),4,2) + Substring(Convert(varchar,trn_pos_date,114),7,2) + ''00'' '
		+ ' FROM '
			+ ' wbe_edibook_up_control with(nolock) '
		+ ' JOIN '
			+ ' wpt_transaction with(nolock) '
			+ ' ON '
				+ ' e10_edi_trn_id = trn_trn_id '
				+ ' AND '
--				+ ' e10_edi_line_no = trn_receipt_no '
				+ ' e10_edi_line_no = 0 '				-- 合計は、0固定
		+ ' JOIN '
			+ ' wpt_transaction_uriage with(nolock) '
			+ ' ON '
				+ ' trn_trn_id = tur_trn_id '
		+ ' WHERE '
			+ ' e10_edi_flag = ''0'' ' -- 未処理のみ
		+ ' ORDER BY '
			+ '  trn_shop_cd '
			+ ' ,Convert(varchar,trn_trn_date,111) '
			+ ' ,trn_pos_no '
			+ ' ,trn_receipt_no '


	Exec (@a_sql)
	-- エラーチェック
	If @@ERROR <> 0 Begin
		Set @a_edi_flag = '3'  -- エラー
	End

	-- カウント初期レコードセット
	INSERT INTO #count_tbl (
		t_exec_id
		,t_tushin_id
		,t_count_all
		,t_count_ok
		,t_count_wa
		,t_count_ng
	)
	SELECT
		t_exec_id = substring(@edi_type,1,2)
		,t_tushin_id = e10_edi_tushin_id
		,t_count_all = count(*)
		,t_count_ok =
			Case
				When @a_edi_flag = '1' Then count(*)
				Else 0
			End
		,t_count_wa =
			Case
				When @a_edi_flag = '2' Then count(*)
				Else 0
			End
		,t_count_ng =
			Case
				When @a_edi_flag = '3' Then count(*)
				Else 0
			End
	FROM
		wbe_edibook_up_control
	JOIN
		wpt_transaction
		ON
			e10_edi_trn_id = trn_trn_id
			AND
--			e10_edi_line_no = trn_receipt_no
			e10_edi_line_no = 0					--　合計は、0固定
	JOIN
		wpt_transaction_uriage
		ON
			trn_trn_id = tur_trn_id
	WHERE 
		e10_edi_flag = '0'  -- 未処理のみ
	GROUP BY
		e10_edi_tushin_id

	-- 処理結果記録
	UPDATE
		wbe_edibook_up_control
	SET
		e10_edi_flag = @a_edi_flag
	FROM
		wbe_edibook_up_control
	JOIN
		wpt_transaction
		ON
			e10_edi_trn_id = trn_trn_id
			AND
--			e10_edi_line_no = trn_receipt_no
			e10_edi_line_no = 0					--　合計は、0固定
	JOIN
		wpt_transaction_uriage
		ON
			trn_trn_id = tur_trn_id
	WHERE 
		e10_edi_flag = '0'   -- 未処理のみ

	------------------------------
	-- ログ出力
	------------------------------
	Exec @rc = P_EDI_Book_WriteLog
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
		,@exec_start_time = @a_exec_start_time
	-- エラーチェック
	If @rc <> 0 or @@ERROR <> 0 Begin
		Set @err_msg = '9073,取引合計出力エラー'

		GOTO SP_ERR
	End

	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl


  --終了
  GOTO SP_OK

UP_TOTAL_URIAGE_TPC_END:

--=================================================
-- 【トップカルチャー本部連動】上り日計情報処理		-- 2012/09/03 add
--=================================================
UP_NIKKEI_URIAGE_TPC:
	Declare @e53_edi_flag char (1)
	Declare @e53_edi_timestamp timestamp
	Declare @e53_edi_create_date datetime 
	Declare @e53_edi_update_date datetime 
	Declare @e53_edi_file_line_no int 
	Declare @e53_edi_meisai_no int 
	Declare @e53_edi_error_msg varchar (200)
	Declare @e53_server_webpos varchar (100)
	Declare @e53_dbname_webpos varchar (100)

	Declare @e53_tushin_id			char(2)
	Declare @e53_shop_cd_webpos		int
	Declare @e53_shop_name_webpos	varchar(100)
	Declare @e53_shop_cd_edi		varchar(10)
	Declare @e53_trn_date			varchar(10)
	Declare @e53_pos_no				int

	Declare @e53_insert_count		int
	Set @e53_insert_count = 0
	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9091,日計情報削除不正'
		GOTO SP_ERR
	End

	-- 一時テーブル
	If OBJECT_ID(N'tempdb..#seisan_temp_nikkei', N'U') IS NOT NULL 
		DROP TABLE #seisan_temp_nikkei  -- あれば削除
	CREATE TABLE #seisan_temp_nikkei(
		  t_tushin_id			char(2)
		, t_shop_cd_webpos		varchar(10)
		, t_shop_name_webpos	varchar(100)
		, t_shop_cd_edi			varchar(10)
		, t_trn_date			varchar(10)
		, t_pos_no				int
	)

	------------------------------
	-- 上り対象店舗を抽出
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_tpc_flag =
		Case
			When @edi_type = '53U' Then '1'
			Else bes_up_tpc_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 精算済みのPOSを取得
		INSERT INTO #seisan_temp_nikkei (
			  t_tushin_id
			, t_shop_cd_webpos
			, t_shop_name_webpos
			, t_shop_cd_edi
			, t_trn_date
			, t_pos_no
		)
		SELECT
			distinct
			 @a_tushin_id
			,@a_shop_cd
			,@a_shop_name
			,@a_book_shop_cd
			,convert(varchar,trn_trn_date,111)
			,trn_pos_no
		FROM 
			wpt_transaction with(nolock)
		-- 上り制御データ
		LEFT OUTER JOIN
			wbe_topculture_control as tct with(nolock)
			on
				trn_shop_cd = tct_shop_cd
				and convert(varchar,trn_trn_date,111) = convert(varchar,tct_trn_date,111)
				and trn_pos_no = tct_pos_no
				and tct_tushin_id = @a_tushin_id
				and tct_edi_type = @edi_type
		-- 上り制御データより処理済みの最終営業日を取得
		LEFT OUTER JOIN
			(
			select tct_shop_cd as t_shop_cd, tct_pos_no as t_pos_no, max(tct_trn_date) as t_trn_date_last
			from wbe_topculture_control with(nolock)
			where tct_tushin_id = @a_tushin_id
			and tct_edi_type = @edi_type
			group by tct_shop_cd, tct_pos_no
			) as trn_last
			on
				trn_shop_cd = trn_last.t_shop_cd
				and trn_pos_no = trn_last.t_pos_no
		WHERE 
			trn_work_type = '0030'-- 精算レコード
			and 
			trn_shop_cd = @a_shop_cd
			and
			-- 処理済みの最終営業日より以降の営業日を対象とする（設定がなければ、2日前とする）
			trn_trn_date >= IsNull( trn_last.t_trn_date_last, Dateadd( day, -2, getdate() ) )
			and
			tct.tct_id Is Null		-- 未処理分（上り制御データに未登録のもの）のみ対象

	-- 次へ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name
    End  -- While

	-- カーソルを閉じる
	Close @rs
	-- 開放
	Deallocate @rs

--select * from #seisan_temp_nikkei
--GOTO SP_OK

	--------------------------------
	-- 店舗、営業日、POS毎にループ
	--------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		 t_tushin_id
		,t_shop_cd_webpos
		,t_shop_name_webpos
		,t_shop_cd_edi
		,t_trn_date
		,t_pos_no
	FROM
		#seisan_temp_nikkei
	ORDER BY
	t_shop_cd_webpos
	,t_trn_date
	,t_pos_no

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
               @e53_tushin_id
              ,@e53_shop_cd_webpos
              ,@e53_shop_name_webpos
              ,@e53_shop_cd_edi
              ,@e53_trn_date
              ,@e53_pos_no

    -- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_krt ( '
			+ '	 e53_edi_flag '
			+ '	,e53_server_webpos '
			+ '	,e53_dbname_webpos '
			+ '	,e53_shop_cd_webpos '
			+ '	,e53_shop_name_webpos '
			+ '	,e53_shop_cd_primary '
			+ '	,e53_shop_cd '
			+ '	,e53_tushin_id '

			+ '	,e53_seq '
			+ '	,e53_shop_cd_convert '
			+ '	,e53_uriage_date '
			+ '	,e53_pos_no '

			+ '	,e53_data_create_date '
			+ '	,e53_staff_cd '
			+ '	,e53_staff_name '
			+ '	,e53_eigyo_start_time '
			+ '	,e53_eigyo_end_time '
			+ '	,e53_kyaku_count '
			+ '	,e53_turi_price '

			+ '	,e53_uriage_price '
			+ '	,e53_total_tax_price '
			+ '	,e53_urihen_price '
			+ '	,e53_urihen_kaisu '
			+ '	,e53_kake_nyukin_price '
			+ '	,e53_update_date '
		+ ' )   '
		+ ' SELECT '
			+ '	 e53_edi_flag = ''0'' '          -- 未処理
			+ '	,e53_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e53_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e53_shop_cd_webpos = ' + Cast(@e53_shop_cd_webpos AS varchar)
			+ '	,e53_shop_name_webpos = ' + '''' + Cast(@e53_shop_name_webpos AS varchar) + ''''
			+ '	,e53_shop_cd_primary = ' + '''' + Cast(@e53_shop_cd_edi AS varchar) + ''''
			+ '	,e53_shop_cd = ' + '''' + Cast(@e53_shop_cd_edi AS varchar) + ''''
			+ '	,e53_tushin_id = ' + '''' + Cast(@e53_tushin_id AS varchar) + ''''

			+ '	,e53_seq = ROW_NUMBER() OVER (ORDER BY main.t_pos_no ASC) '	-- 連番
			+ '	,e53_shop_cd_convert = ' + '''' + Cast(@e53_shop_cd_edi AS varchar) + ''''
			+ '	,e53_uriage_date = main.t_trn_date '
			+ '	,e53_pos_no = main.t_pos_no '
			+ '	,e53_data_create_date = Convert(varchar,getdate(),111) + '' '' + SubString(Convert(varchar,getdate(),114),1,8) '
			+ '	,e53_staff_cd = Max(seisan.t_staff_cd) '
			+ '	,e53_staff_name = Max(seisan.t_staff_name) '
			+ '	,e53_eigyo_start_time = Max(IsNull(regi_open.t_eigyo_start_time,''00:00'')) '
			+ '	,e53_eigyo_end_time = Max(seisan.t_eigyo_end_time) '
			+ '	,e53_kyaku_count = Count(*) '
			+ '	,e53_turi_price = Sum(t_turi_price) '
			+ '	,e53_uriage_price = Sum(t_uriage_price) '
			+ '	,e53_total_tax_price = Sum(t_tax_price) '
			+ '	,e53_urihen_price = Sum(t_urihen_price) '
			+ '	,e53_urihen_kaisu = Sum(case t_work_type when ''0001'' then 1 else 0 end) '
			+ '	,e53_kake_nyukin_price = Max(IsNull(nyukin.t_tender_sum,0)) '
			+ '	,e53_update_date = ''        '' '
		+ ' FROM ( '
			+ ' SELECT '
				+ ' trn_trn_id as t_trn_id '
				+ ' , trn_work_type as t_work_type '
				+ ' , trn_shop_cd as t_shop_cd '
				+ ' , CONVERT ( VARCHAR, trn_trn_date, 111 ) as t_trn_date '
				+ ' , trn_pos_no as t_pos_no '
				-- 売上金額（売上－売上返品）
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then tdu_selling_price '
					+ ' else tdu_selling_price * -1 '
					+ ' end ) as t_uriage_price '
				-- 消費税（売上－売上返品）
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then tdu_tax_price '
					+ ' else tdu_tax_price * -1 '
					+ ' end) as t_tax_price '
				-- 売返金額（売上返品のみ）
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then 0 '
					+ ' else tdu_selling_price '
					+ ' end) as t_urihen_price '
				-- 釣り銭（売上－売上返品）
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then tur_redemption '
					+ ' else tur_redemption * -1 '
					+ ' end) as t_turi_price '
			+ ' FROM '
				+ ' wpt_transaction WITH(NOLOCK) '
			+ ' JOIN '
				+ ' wpt_transaction_uriage WITH(NOLOCK) '
				+ ' ON '
				+	' trn_trn_id = tur_trn_id '
			+ ' JOIN '
				+ ' wpt_transaction_uriage_details WITH(NOLOCK) '
				+ ' ON '
				+	' trn_trn_id = tdu_trn_id '
			+ ' WHERE '
				+ ' trn_work_type In (''0000'',''0001'') '
				+ ' AND '
				+ ' trn_shop_cd = ' + Cast(@e53_shop_cd_webpos AS varchar) + ' '
				+ ' AND '
				+ ' Convert(varchar,trn_trn_date,111) = ' + '''' + Cast(@e53_trn_date AS varchar) + '''' + ' '
				+ ' AND '
				+ ' trn_pos_no = ' + Cast(@e53_pos_no AS varchar) + ' '
			+ ' GROUP BY '
				+ ' trn_trn_id '
				+ ',trn_work_type '
				+ ',trn_shop_cd '
				+ ',convert(varchar,trn_trn_date,111) '
				+ ',trn_pos_no '
		+ ' ) AS main '
		-- 精算情報（担当者コード(4桁)、担当者名、営業終了時間）
		+ ' JOIN ( '
			+ ' SELECT '
				+ ' trn_shop_cd as t_shop_cd '
				+ ',CONVERT ( VARCHAR, trn_trn_date, 111 ) as t_trn_date '
				+ ',trn_pos_no as t_pos_no '
				+ ',IsNull(stm_staff_cd2,'''') as t_staff_cd '
				+ ',trn_staff_name as t_staff_name '
				+ ',SubString(Convert(varchar,trn_pos_date,114),1,5) as t_eigyo_end_time '
			+ ' FROM '
				+ ' wpt_transaction WITH(NOLOCK) '
			+ ' JOIN '
				+ ' wpt_staff_master WITH(NOLOCK) '
				+ ' ON '
					+ ' trn_staff_id = stm_staff_id '
			+ ' WHERE '
				+ ' trn_work_type = ''0030'' '		-- 精算レコード
				+ ' AND '
				+ ' trn_shop_cd = ' + Cast(@e53_shop_cd_webpos AS varchar) + ' '
				+ ' AND '
				+ ' Convert(varchar,trn_trn_date,111) = ' + '''' + Cast(@e53_trn_date AS varchar) + '''' + ' '
				+ ' AND '
				+ ' trn_pos_no = ' + Cast(@e53_pos_no AS varchar) + ' '
		+ ' ) AS seisan '
			+ ' ON '
				+ ' main.t_shop_cd = seisan.t_shop_cd '
				+ ' AND '
				+ ' main.t_trn_date = seisan.t_trn_date '
				+ ' AND '
				+ ' main.t_pos_no = seisan.t_pos_no '
		-- レジ起動情報（営業開始時間）
		+ ' LEFT OUTER JOIN ( '
			+ ' SELECT '
				+ ' log_shop_cd as t_shop_cd '
				+ ',CONVERT ( VARCHAR, log_trn_date, 111 ) as t_trn_date '
				+ ',log_pos_no as t_pos_no '
				+ ',SubString(Convert(varchar,Min(log_pos_date),114),1,5) as t_eigyo_start_time '
			+ ' FROM '
				+ ' wpt_log WITH(NOLOCK) '
			+ ' WHERE '
				+ ' log_work_type = ''0500'' '		-- レジ起動
				+ ' AND '
				+ ' log_shop_cd = ' + Cast(@e53_shop_cd_webpos AS varchar) + ' '
				+ ' AND '
				+ ' Convert(varchar,log_trn_date,111) = ' + '''' + Cast(@e53_trn_date AS varchar) + '''' + ' '
				+ ' AND '
				+ ' log_pos_no = ' + Cast(@e53_pos_no AS varchar) + ' '
			+ ' GROUP BY '
				+ ' log_shop_cd '
				+ ',CONVERT ( VARCHAR, log_trn_date, 111 ) '
				+ ',log_pos_no '
		+ ' ) AS regi_open '
			+ ' ON '
				+ ' main.t_shop_cd = regi_open.t_shop_cd '
				+ ' AND '
				+ ' main.t_trn_date = regi_open.t_trn_date '
				+ ' AND '
				+ ' main.t_pos_no = regi_open.t_pos_no '
		-- 掛入金
		+ ' LEFT OUTER JOIN ( '
			+ ' SELECT '
				+ ' trn_shop_cd as t_shop_cd '
				+ ',CONVERT ( VARCHAR, trn_trn_date, 111 ) as t_trn_date '
				+ ',trn_pos_no as t_pos_no '
				+ ',Sum(tns_tender_sum) as t_tender_sum '
			+ ' FROM '
				+ ' wpt_transaction WITH(NOLOCK) '
			+ ' JOIN '
				+ ' wpt_transaction_nyushukin WITH(NOLOCK) '
				+ ' ON '
					+ ' trn_trn_id = tns_trn_id '
			+ ' WHERE '
				+ ' trn_work_type = ''0020'' '		-- 入金
				+ ' AND '
				+ ' tns_remark_name = ''掛入金'' '
				+ ' AND '
				+ ' trn_shop_cd = ' + Cast(@e53_shop_cd_webpos AS varchar) + ' '
				+ ' AND '
				+ ' Convert(varchar,trn_trn_date,111) = ' + '''' + Cast(@e53_trn_date AS varchar) + '''' + ' '
				+ ' AND '
				+ ' trn_pos_no = ' + Cast(@e53_pos_no AS varchar) + ' '
			+ ' GROUP BY '
				+ ' trn_shop_cd '
				+ ',CONVERT ( VARCHAR, trn_trn_date, 111 ) '
				+ ',trn_pos_no '
		+ ' ) AS nyukin '
			+ ' ON '
				+ ' main.t_shop_cd = nyukin.t_shop_cd '
				+ ' AND '
				+ ' main.t_trn_date = nyukin.t_trn_date '
				+ ' AND '
				+ ' main.t_pos_no = nyukin.t_pos_no '
		+ ' GROUP BY '
			+ ' main.t_shop_cd '
			+ ',main.t_trn_date '
			+ ',main.t_pos_no '
		+ ' ORDER BY '
			+ ' main.t_shop_cd '
			+ ',main.t_trn_date '
			+ ',main.t_pos_no '

--select   @e53_shop_cd_webpos,@e53_shop_cd_edi,@e53_trn_date,@e53_pos_no
--select @a_sql
--goto sp_ok

		Exec (@a_sql)
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

		-- 追加件数カウント
		Set @e53_insert_count = @e53_insert_count + 1

		-- エラーでなければ、上り制御データに追加
		If @a_edi_flag <> '3' Begin
			Insert Into wbe_topculture_control
				( tct_tushin_id, tct_edi_type, tct_shop_cd, tct_trn_date, tct_pos_no )
			Values
				( @e53_tushin_id, @edi_type, @e53_shop_cd_webpos, Convert(datetime,@e53_trn_date), @e53_pos_no )
		End

		-- 次へ
		Fetch Next From @rs Into
			 @e53_tushin_id
			,@e53_shop_cd_webpos
			,@e53_shop_name_webpos
			,@e53_shop_cd_edi
			,@e53_trn_date
			,@e53_pos_no
	End  -- While

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs

	If OBJECT_ID(N'tempdb..#seisan_temp_nikkei', N'U') IS NOT NULL Begin
		DROP TABLE #seisan_temp_nikkei  -- あれば削除
	End

	-- カウント初期レコードセット
	INSERT INTO #count_tbl (
		t_exec_id
		,t_tushin_id
		,t_count_all
		,t_count_ok
		,t_count_wa
		,t_count_ng
	)
	SELECT
		t_exec_id = substring(@edi_type,1,2)
		,t_tushin_id = @e53_tushin_id
		,t_count_all = @e53_insert_count
		,t_count_ok = @e53_insert_count
		,t_count_wa = 0
		,t_count_ng = 0

	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl


  --終了
  GOTO SP_OK

UP_NIKKEI_URIAGE_TPC_END:

--=================================================
-- 【トップカルチャー本部連動】上り部門別売上処理		-- 2012/09/03 add
--=================================================
UP_BUMON_URIAGE_TPC:
	Declare @e54_edi_flag char (1)
	Declare @e54_edi_timestamp timestamp
	Declare @e54_edi_create_date datetime 
	Declare @e54_edi_update_date datetime 
	Declare @e54_edi_file_line_no int 
	Declare @e54_edi_meisai_no int 
	Declare @e54_edi_error_msg varchar (200)
	Declare @e54_server_webpos varchar (100)
	Declare @e54_dbname_webpos varchar (100)

	Declare @e54_tushin_id			char(2)
	Declare @e54_shop_cd_webpos		int
	Declare @e54_shop_name_webpos	varchar(100)
	Declare @e54_shop_cd_edi		varchar(10)
	Declare @e54_trn_date			varchar(10)
	Declare @e54_pos_no				int

	Declare @e54_insert_count		int
	Set @e54_insert_count = 0

	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9091,部門別売上削除不正'
		GOTO SP_ERR
	End

	-- 一時テーブル
	If OBJECT_ID(N'tempdb..#seisan_temp_bumon', N'U') IS NOT NULL 
		DROP TABLE #seisan_temp_bumon  -- あれば削除
	CREATE TABLE #seisan_temp_bumon(
		  t_tushin_id			char(2)
		, t_shop_cd_webpos		varchar(10)
		, t_shop_name_webpos	varchar(100)
		, t_shop_cd_edi			varchar(10)
		, t_trn_date			varchar(10)
		, t_pos_no				int
	)

	------------------------------
	-- 上り対象店舗を抽出
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_tpc_flag =
		Case
			When @edi_type = '54U' Then '1'
			Else bes_up_tpc_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 精算済みのPOSを取得
		INSERT INTO #seisan_temp_bumon (
			  t_tushin_id
			, t_shop_cd_webpos
			, t_shop_name_webpos
			, t_shop_cd_edi
			, t_trn_date
			, t_pos_no
		)
		SELECT
			distinct
			 @a_tushin_id
			,@a_shop_cd
			,@a_shop_name
			,@a_book_shop_cd
			,convert(varchar,trn_trn_date,111)
			,trn_pos_no
		FROM 
			wpt_transaction with(nolock)
		-- 上り制御データ
		LEFT OUTER JOIN
			wbe_topculture_control as tct with(nolock)
			on
				trn_shop_cd = tct_shop_cd
				and convert(varchar,trn_trn_date,111) = convert(varchar,tct_trn_date,111)
				and trn_pos_no = tct_pos_no
				and tct_tushin_id = @a_tushin_id
				and tct_edi_type = @edi_type
		-- 上り制御データより処理済みの最終営業日を取得
		LEFT OUTER JOIN
			(
			select tct_shop_cd as t_shop_cd, tct_pos_no as t_pos_no, max(tct_trn_date) as t_trn_date_last
			from wbe_topculture_control with(nolock)
			where tct_tushin_id = @a_tushin_id
			and tct_edi_type = @edi_type
			group by tct_shop_cd, tct_pos_no
			) as trn_last
			on
				trn_shop_cd = trn_last.t_shop_cd
				and trn_pos_no = trn_last.t_pos_no
		WHERE 
			trn_work_type = '0030'-- 精算レコード
			and 
			trn_shop_cd = @a_shop_cd
			and
			-- 処理済みの最終営業日より以降の営業日を対象とする（設定がなければ、2日前とする）
			trn_trn_date >= IsNull( trn_last.t_trn_date_last, Dateadd( day, -2, getdate() ) )
			and
			tct.tct_id Is Null		-- 未処理分（上り制御データに未登録のもの）のみ対象

	-- 次へ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name
    End  -- While

	-- カーソルを閉じる
	Close @rs
	-- 開放
	Deallocate @rs

--select * from #seisan_temp_bumon
--GOTO SP_OK

	--------------------------------
	-- 店舗、営業日、POS毎にループ
	--------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		 t_tushin_id
		,t_shop_cd_webpos
		,t_shop_name_webpos
		,t_shop_cd_edi
		,t_trn_date
		,t_pos_no
	FROM
		#seisan_temp_bumon
	ORDER BY
	t_shop_cd_webpos
	,t_trn_date
	,t_pos_no

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
               @e54_tushin_id
              ,@e54_shop_cd_webpos
              ,@e54_shop_name_webpos
              ,@e54_shop_cd_edi
              ,@e54_trn_date
              ,@e54_pos_no

    -- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_bmt ( '
			+ '	 e54_edi_flag '
			+ '	,e54_server_webpos '
			+ '	,e54_dbname_webpos '
			+ '	,e54_shop_cd_webpos '
			+ '	,e54_shop_name_webpos '
			+ '	,e54_shop_cd_primary '
			+ '	,e54_shop_cd '
			+ '	,e54_tushin_id '

			+ '	,e54_shop_cd_convert '
			+ '	,e54_seq '
			+ '	,e54_uriage_date '
			+ '	,e54_pos_no '
			+ '	,e54_bumon_cd '
			+ '	,e54_uriage_count '
			+ '	,e54_uriage_kyaku_count '
			+ '	,e54_uriage_price '
			+ '	,e54_nebiki_count '
			+ '	,e54_nebiki_price '
			+ '	,e54_urihen_count '
			+ '	,e54_urihen_price '
		+ ' )   '
		+ ' SELECT '
			+ '	 e54_edi_flag = ''0'' '          -- 未処理
			+ '	,e54_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e54_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e54_shop_cd_webpos = ' + Cast(@e54_shop_cd_webpos AS varchar)
			+ '	,e54_shop_name_webpos = ' + '''' + Cast(@e54_shop_name_webpos AS varchar) + ''''
			+ '	,e54_shop_cd_primary = ' + '''' + Cast(@e54_shop_cd_edi AS varchar) + ''''
			+ '	,e54_shop_cd = ' + '''' + Cast(@e54_shop_cd_edi AS varchar) + ''''
			+ '	,e54_tushin_id = ' + '''' + Cast(@e54_tushin_id AS varchar) + ''''
			+ '	,e54_shop_cd_convert = ' + '''' + Cast(@e54_shop_cd_edi AS varchar) + ''''
			+ '	,e54_seq = ROW_NUMBER() OVER (ORDER BY t_bumon_cd ASC) '	-- 連番
			+ '	,e54_uriage_date = t_trn_date '
			+ '	,e54_pos_no = t_pos_no '
			+ '	,e54_bumon_cd = t_bumon_cd '
			+ '	,e54_uriage_count = Sum(t_uriage_count) '
			+ '	,e54_uriage_kyaku_count = Count(*) '
			+ '	,e54_uriage_price = sum(t_uriage_price) '
			+ '	,e54_nebiki_count = Sum(t_nebiki_count) '
			+ '	,e54_nebiki_price = sum(t_nebiki_price) '
			+ '	,e54_urihen_count = Sum(t_urihen_count) '
			+ '	,e54_urihen_price = sum(t_urihen_price) '
		+ ' FROM ( '
			+ ' SELECT '
				+ ' trn_trn_id as t_trn_id '
				+ ' , trn_shop_cd as t_shop_cd '
				+ ' , CONVERT ( VARCHAR, trn_trn_date, 111 ) as t_trn_date '
				+ ' , trn_pos_no as t_pos_no '
-- 2012/09/10 update（書籍の場合の分類変換対応）
--				+ ' , IsNull(tcb.tcb_bumon_cd, tcb2.tcb_bumon_cd) as t_bumon_cd '
				+ ' , case when tdu_goods_type = ''20'' '
				+ ' 	  then  '
				+ ' 		case '
				+ ' 			when gdb_c_code = ''0034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''0036'' then ''1130'' '
				+ ' 			when gdb_c_code = ''0082'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''01'' then ''1040'' '
				+ ' 			when gdb_c_code = ''0200'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''037'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''038'' then ''1090'' '
				+ ' 			when gdb_c_code = ''1033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''1034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''1036'' then ''1130'' '

				+ ' 			when gdb_c_code = ''1082'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''11'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''200'' then ''1140'' '
				+ ' 			when gdb_c_code = ''2033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''2034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''2036'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''203'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''21'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''21'' then ''1040'' '
				+ ' 			when gdb_c_code = ''2241'' then ''1130'' '

				+ ' 			when Substring(gdb_c_code,1,2) = ''25'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''25'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''26'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' then ''1090'' '
				+ ' 			when gdb_c_code = ''3033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''3034'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''31'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''51'' then ''1040'' '

				+ ' 			when Substring(gdb_c_code,1,2) = ''51'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''55'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' then ''1100'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''65'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' then ''1070'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''75'' then ''1080'' '

				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''85'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' then ''1060'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''91'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,2,1) = ''1'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,2,2) = ''23'' then ''1130'' '

				+ ' 			when Substring(gdb_c_code,2,1) = ''2'' then ''1050'' '
				+ ' 			when Substring(gdb_c_code,2,1) = ''5'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''1'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''25'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''26'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''2'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''3'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''4'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''50'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''52'' then ''1140'' '

				+ ' 			when Substring(gdb_c_code,3,2) = ''54'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''5'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''63'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''6'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''75'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''76'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''77'' then ''1100'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''7'' then ''1120'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''8'' then ''1120'' '

				+ ' 			when Substring(gdb_c_code,3,1) = ''9'' then ''1120'' '
				+ ' 			else ''1990'' '
				+ ' 		end '
				+ ' 	  else IsNull(tcb.tcb_bumon_cd, tcb2.tcb_bumon_cd) '
				+ '   End as t_bumon_cd '
--------------------------------------------------------------
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then tdu_selling_count '
					+ ' else tdu_selling_count * -1 '
					+ ' end) as t_uriage_count '
					+ '  '
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then tdu_selling_price '
					+ ' else tdu_selling_price * -1 '
					+ ' end) as t_uriage_price '			-- 按分後税抜き
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then '
						+ ' case '
							+ ' when tdu_unit_discount_price > 0 then 1 '
							+ ' else case when ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) > 0 then 1 else 0 end '
						+ ' end '
					+ ' else '
						+ ' case '
							+ ' when tdu_unit_discount_price > 0 then -1 '
							+ ' else case when ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) > 0 then -1 else 0 end '
						+ ' end '
					+ ' end) as t_nebiki_count '
				+ ' , sum(case trn_work_type '
					+ ' when ''0000'' then '
						--+ ' case '
						--	+ ' when tdu_unit_discount_price > 0 then tdu_unit_discount_price * tdu_selling_count '
						--	+ ' else case when ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) > 0 then ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) else 0 end '
						--+ ' end '
						+ ' ( tdu_unit_discount_price * tdu_selling_count )'
						+ ' + ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) '
					+ ' else '
						--+ ' case '
							--+ ' when tdu_unit_discount_price > 0 then tdu_unit_discount_price * tdu_selling_count * -1 '
							--+ ' else case when ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) > 0 then ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) * -1 else 0 end '
						--+ ' end '
						+ ' ( ( tdu_unit_discount_price * tdu_selling_count ) '
						+ ' + ( tdu_unit_price - ( tdu_selling_price + tdu_tax_price ) ) ) * -1 '
					+ ' end) as t_nebiki_price '
				+ ' , sum(case trn_work_type '
						+ ' when ''0000'' then 0 '
						+ ' else tdu_selling_count '
					+ ' end) as t_urihen_count '	-- 売返のみ集計
				+ ' , sum(case trn_work_type '
						+ ' when ''0000'' then 0 '
						+ ' else tdu_selling_price '
					+ ' end ) as t_urihen_price '		-- 按分後税抜き
		Set @a_sql2 = ''
			+ ' FROM '
				+ ' wpt_transaction WITH(NOLOCK) '
			+ ' JOIN '
				+ ' wpt_transaction_uriage WITH(NOLOCK) '
				+ ' ON '
				+	' trn_trn_id = tur_trn_id '
			+ ' JOIN '
				+ ' wpt_transaction_uriage_details WITH(NOLOCK) '
				+ ' ON '
				+	' trn_trn_id = tdu_trn_id '
			+ ' LEFT OUTER JOIN '
				+ ' wbe_topculture_bumon_convert as tcb with(nolock) '
				+ ' ON '
					+ ' tdu_jan_cd = tcb.tcb_jan_cd '
			+ ' LEFT OUTER JOIN '
				+ ' wbe_topculture_bumon_convert as tcb2 with(nolock) '
				+ ' ON '
					+ ' tdu_media_cd = tcb2.tcb_media_cd '
			+ ' LEFT OUTER JOIN '
				+ ' wpt_goods_master_book with(nolock) '
				+ ' ON '
					+ ' gdb_goods_id = tdu_goods_id '
			+ ' WHERE '
				+ ' trn_work_type In (''0000'',''0001'') '
				+ ' AND '
				+ ' trn_shop_cd = ' + Cast(@e54_shop_cd_webpos AS varchar) + ' '
				+ ' AND '
				+ ' Convert(varchar,trn_trn_date,111) = ' + '''' + Cast(@e54_trn_date AS varchar) + '''' + ' '
				+ ' AND '
				+ ' trn_pos_no = ' + Cast(@e54_pos_no AS varchar) + ' '
			+ ' GROUP BY '
				+ ' trn_trn_id '
				+ ',trn_shop_cd '
				+ ',convert(varchar,trn_trn_date,111) '
				+ ',trn_pos_no '
--				+ ',IsNull(tcb.tcb_bumon_cd, tcb2.tcb_bumon_cd) '		-- トップカルチャー分類変換データの部門コードで集計
				+ ' , case when tdu_goods_type = ''20'' '
				+ ' 	  then  '
				+ ' 		case '
				+ ' 			when gdb_c_code = ''0034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''0036'' then ''1130'' '
				+ ' 			when gdb_c_code = ''0082'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''01'' then ''1040'' '
				+ ' 			when gdb_c_code = ''0200'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''037'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''038'' then ''1090'' '
				+ ' 			when gdb_c_code = ''1033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''1034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''1036'' then ''1130'' '

				+ ' 			when gdb_c_code = ''1082'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''11'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''200'' then ''1140'' '
				+ ' 			when gdb_c_code = ''2033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''2034'' then ''1130'' '
				+ ' 			when gdb_c_code = ''2036'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,3) = ''203'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''21'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''21'' then ''1040'' '
				+ ' 			when gdb_c_code = ''2241'' then ''1130'' '

				+ ' 			when Substring(gdb_c_code,1,2) = ''25'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''25'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''26'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''2'' then ''1090'' '
				+ ' 			when gdb_c_code = ''3033'' then ''1130'' '
				+ ' 			when gdb_c_code = ''3034'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''31'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''51'' then ''1040'' '

				+ ' 			when Substring(gdb_c_code,1,2) = ''51'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''55'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''5'' then ''1100'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''65'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''6'' then ''1070'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''75'' then ''1080'' '

				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''7'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''85'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' and Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,1,1) = ''8'' then ''1060'' '
				+ ' 			when Substring(gdb_c_code,1,2) = ''91'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,2,1) = ''1'' then ''1040'' '
				+ ' 			when Substring(gdb_c_code,2,2) = ''23'' then ''1130'' '

				+ ' 			when Substring(gdb_c_code,2,1) = ''2'' then ''1050'' '
				+ ' 			when Substring(gdb_c_code,2,1) = ''5'' then ''1080'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''1'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''25'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''26'' then ''1110'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''2'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''3'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''4'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''50'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''52'' then ''1140'' '

				+ ' 			when Substring(gdb_c_code,3,2) = ''54'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''5'' then ''1140'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''63'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''6'' then ''1130'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''75'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''76'' then ''1090'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''77'' then ''1100'' '
				+ ' 			when Substring(gdb_c_code,3,2) = ''79'' then ''1030'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''7'' then ''1120'' '
				+ ' 			when Substring(gdb_c_code,3,1) = ''8'' then ''1120'' '

				+ ' 			when Substring(gdb_c_code,3,1) = ''9'' then ''1120'' '
				+ ' 			else ''1990'' '
				+ ' 		end '
				+ ' 	  else IsNull(tcb.tcb_bumon_cd, tcb2.tcb_bumon_cd) '
				+ '   End '

		+ ' ) AS main '
		+ ' GROUP BY '
			+ ' t_shop_cd '
			+ ',t_trn_date '
			+ ',t_pos_no '
			+ ',t_bumon_cd '
		+ ' ORDER BY '
			+ ' t_shop_cd '
			+ ',t_trn_date '
			+ ',t_pos_no '
			+ ',t_bumon_cd '

--select   @e54_shop_cd_webpos,@e54_shop_cd_edi,@e54_trn_date,@e54_pos_no
--select @a_sql
--goto sp_ok

		Exec (@a_sql + @a_sql2)
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

		-- 追加件数カウント
		Set @e54_insert_count = @e54_insert_count + 1

		-- エラーでなければ、上り制御データに追加
		If @a_edi_flag <> '3' Begin
			Insert Into wbe_topculture_control
				( tct_tushin_id, tct_edi_type, tct_shop_cd, tct_trn_date, tct_pos_no )
			Values
				( @e54_tushin_id, @edi_type, @e54_shop_cd_webpos, Convert(datetime,@e54_trn_date), @e54_pos_no )
		End

		-- 次へ
		Fetch Next From @rs Into
			 @e54_tushin_id
			,@e54_shop_cd_webpos
			,@e54_shop_name_webpos
			,@e54_shop_cd_edi
			,@e54_trn_date
			,@e54_pos_no
	End  -- While

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs

	If OBJECT_ID(N'tempdb..#seisan_temp_bumon', N'U') IS NOT NULL Begin
		DROP TABLE #seisan_temp_bumon  -- あれば削除
	End

	-- カウント初期レコードセット
	INSERT INTO #count_tbl (
		t_exec_id
		,t_tushin_id
		,t_count_all
		,t_count_ok
		,t_count_wa
		,t_count_ng
	)
	SELECT
		t_exec_id = substring(@edi_type,1,2)
		,t_tushin_id = @e54_tushin_id
		,t_count_all = @e54_insert_count
		,t_count_ok = @e54_insert_count
		,t_count_wa = 0
		,t_count_ng = 0

	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl

  --終了
  GOTO SP_OK

UP_BUMON_URIAGE_TPC_END:

--=================================================
-- 【トップカルチャー本部連動】上りクレジット別売上処理		-- 2012/09/03 add
--=================================================
UP_CREDIT_URIAGE_TPC:
	Declare @e55_edi_flag char (1)
	Declare @e55_edi_timestamp timestamp
	Declare @e55_edi_create_date datetime 
	Declare @e55_edi_update_date datetime 
	Declare @e55_edi_file_line_no int 
	Declare @e55_edi_meisai_no int 
	Declare @e55_edi_error_msg varchar (200)
	Declare @e55_server_webpos varchar (100)
	Declare @e55_dbname_webpos varchar (100)

	Declare @e55_tushin_id			char(2)
	Declare @e55_shop_cd_webpos		int
	Declare @e55_shop_name_webpos	varchar(100)
	Declare @e55_shop_cd_edi		varchar(10)
	Declare @e55_trn_date			varchar(10)
	Declare @e55_pos_no				int

	Declare @e55_insert_count		int
	Set @e55_insert_count = 0

	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9091,クレジット別売上削除不正'
		GOTO SP_ERR
	End

	-- 一時テーブル
	If OBJECT_ID(N'tempdb..#seisan_temp', N'U') IS NOT NULL 
		DROP TABLE #seisan_temp  -- あれば削除
	CREATE TABLE #seisan_temp(
		  t_tushin_id			char(2)
		, t_shop_cd_webpos		varchar(10)
		, t_shop_name_webpos	varchar(100)
		, t_shop_cd_edi			varchar(10)
		, t_trn_date			varchar(10)
		, t_pos_no				int
	)

	------------------------------
	-- 上り対象店舗を抽出
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_tpc_flag =
		Case
			When @edi_type = '55U' Then '1'
			Else bes_up_tpc_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 精算済みのPOSを取得
		INSERT INTO #seisan_temp (
			  t_tushin_id
			, t_shop_cd_webpos
			, t_shop_name_webpos
			, t_shop_cd_edi
			, t_trn_date
			, t_pos_no
		)
		SELECT
			distinct
			 @a_tushin_id
			,@a_shop_cd
			,@a_shop_name
			,@a_book_shop_cd
			,convert(varchar,trn_trn_date,111)
			,trn_pos_no
		FROM 
			wpt_transaction with(nolock)
		-- 上り制御データ
		LEFT OUTER JOIN
			wbe_topculture_control as tct with(nolock)
			on
				trn_shop_cd = tct_shop_cd
				and convert(varchar,trn_trn_date,111) = convert(varchar,tct_trn_date,111)
				and trn_pos_no = tct_pos_no
				and tct_tushin_id = @a_tushin_id
				and tct_edi_type = @edi_type
		-- 上り制御データより処理済みの最終営業日を取得
		LEFT OUTER JOIN
			(
			select tct_shop_cd as t_shop_cd, tct_pos_no as t_pos_no, max(tct_trn_date) as t_trn_date_last
			from wbe_topculture_control with(nolock)
			where tct_tushin_id = @a_tushin_id
			and tct_edi_type = @edi_type
			group by tct_shop_cd, tct_pos_no
			) as trn_last
			on
				trn_shop_cd = trn_last.t_shop_cd
				and trn_pos_no = trn_last.t_pos_no
		WHERE 
			trn_work_type = '0030'-- 精算レコード
			and 
			trn_shop_cd = @a_shop_cd
			and
			-- 処理済みの最終営業日より以降の営業日を対象とする
			trn_trn_date >= IsNull( trn_last.t_trn_date_last, Dateadd( day, -2, getdate() ) )
			and
			tct.tct_id Is Null		-- 未処理分（上り制御データに未登録のもの）のみ対象

	-- 次へ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name
    End  -- While

	-- カーソルを閉じる
	Close @rs
	-- 開放
	Deallocate @rs

	--------------------------------
	-- 店舗、営業日、POS毎にループ
	--------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		 t_tushin_id
		,t_shop_cd_webpos
		,t_shop_name_webpos
		,t_shop_cd_edi
		,t_trn_date
		,t_pos_no
	FROM
		#seisan_temp
	ORDER BY
	t_shop_cd_webpos
	,t_trn_date
	,t_pos_no

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
               @e55_tushin_id
              ,@e55_shop_cd_webpos
              ,@e55_shop_name_webpos
              ,@e55_shop_cd_edi
              ,@e55_trn_date
              ,@e55_pos_no

    -- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_crt ( '
			+ '	 e55_edi_flag '
			+ '	,e55_server_webpos '
			+ '	,e55_dbname_webpos '
			+ '	,e55_shop_cd_webpos '
			+ '	,e55_shop_name_webpos '
			+ '	,e55_shop_cd_primary '
			+ '	,e55_shop_cd '
			+ '	,e55_tushin_id '

			+ '	,e55_shop_cd_convert '
			+ '	,e55_seq '
			+ '	,e55_uriage_date '
			+ '	,e55_pos_no '
			+ '	,e55_credit_cd '
			+ '	,e55_credit_detail_cd '
			+ '	,e55_uriage_kyaku_count '
			+ '	,e55_uriage_price '
		+ ' )   '
		+ ' SELECT '
			+ '	 e55_edi_flag = ''0'' '          -- 未処理
			+ '	,e55_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e55_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e55_shop_cd_webpos = ' + Cast(@e55_shop_cd_webpos AS varchar)
			+ '	,e55_shop_name_webpos = ' + '''' + Cast(@e55_shop_name_webpos AS varchar) + ''''
			+ '	,e55_shop_cd_primary = ' + '''' + Cast(@e55_shop_cd_edi AS varchar) + ''''
			+ '	,e55_shop_cd = ' + '''' + Cast(@e55_shop_cd_edi AS varchar) + ''''
			+ '	,e55_tushin_id = ' + '''' + Cast(@e55_tushin_id AS varchar) + ''''

			+ '	,e55_shop_cd_convert = ' + '''' + Cast(@e55_shop_cd_edi AS varchar) + ''''
			+ '	,e55_seq = ROW_NUMBER() OVER (ORDER BY ltrim(rtrim(ten.tcc_convert_data)) ASC) '	-- 連番
			+ '	,e55_uriage_date = convert(varchar,trn_trn_date,111) '
			+ '	,e55_pos_no = trn_pos_no '
			+ '	,e55_credit_cd = LTrim(RTrim(ten.tcc_convert_data)) '
			+ '	,e55_credit_detail_cd = ' + '''' + '    ' + ''''
			+ '	,e55_uriage_kyaku_count = Count(*) '
			+ '	,e55_uriage_price = '
			+ '	 Sum( '
				+ '	 Case trn_work_type '
				+ '	 When ''0000'' Then tte_tender_sum '
				+ '	 When ''0001'' Then tte_tender_sum * -1 '
			+ '	 End) '
		+ ' FROM '
			+ ' wpt_transaction WITH(NOLOCK) '
		+ ' JOIN '
			+ ' wpt_transaction_tender WITH(NOLOCK) '
			+ ' ON '
			+	' trn_trn_id = tte_trn_id '
		+ ' JOIN '
			+ ' wbe_topculture_convert AS ten WITH(NOLOCK) '
			+ ' ON '
			+	' ten.tcc_convert_type = ''1'' '
			+	' AND '
			+	' LTrim(RTrim(ten.tcc_webpos_data)) = tte_tender_cd + tte_tender_detail_cd '
		+ ' WHERE '
			+ ' trn_work_type In (''0000'',''0001'') '
			+ ' AND '
			+ ' trn_shop_cd = ' + Cast(@e55_shop_cd_webpos AS varchar) + ' '
			+ ' AND '
			+ ' Convert(varchar,trn_trn_date,111) = ' + '''' + Cast(@e55_trn_date AS varchar) + '''' + ' '
			+ ' AND '
			+ ' trn_pos_no = ' + Cast(@e55_pos_no AS varchar) + ' '
		+ ' GROUP BY '
			+ ' trn_shop_cd '
			+ ',convert(varchar,trn_trn_date,111) '
			+ ',trn_pos_no '
			+ ',LTrim(RTrim(ten.tcc_convert_data)) '
		+ ' ORDER BY '
			+ ' trn_shop_cd '
			+ ',convert(varchar,trn_trn_date,111) '
			+ ',trn_pos_no '
			+ ',LTrim(RTrim(ten.tcc_convert_data)) '

--select   @e55_shop_cd_webpos,@e55_shop_cd_edi,@e55_trn_date,@e55_pos_no
--select @a_sql

		Exec (@a_sql)

		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

		-- 追加件数カウント
		Set @e55_insert_count = @e55_insert_count + 1

		-- エラーでなければ、上り制御データに追加
		If @a_edi_flag <> '3' Begin
			Insert Into wbe_topculture_control
				( tct_tushin_id, tct_edi_type, tct_shop_cd, tct_trn_date, tct_pos_no )
			Values
				( @e55_tushin_id, @edi_type, @e55_shop_cd_webpos, Convert(datetime,@e55_trn_date), @e55_pos_no )
		End

		-- 次へ
		Fetch Next From @rs Into
			 @e55_tushin_id
			,@e55_shop_cd_webpos
			,@e55_shop_name_webpos
			,@e55_shop_cd_edi
			,@e55_trn_date
			,@e55_pos_no
	End  -- While

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs

	If OBJECT_ID(N'tempdb..#seisan_temp', N'U') IS NOT NULL Begin
		DROP TABLE #seisan_temp  -- あれば削除
	End

	-- カウント初期レコードセット
	INSERT INTO #count_tbl (
		t_exec_id
		,t_tushin_id
		,t_count_all
		,t_count_ok
		,t_count_wa
		,t_count_ng
	)
	SELECT
		t_exec_id = substring(@edi_type,1,2)
		,t_tushin_id = @e55_tushin_id
		,t_count_all = @e55_insert_count
		,t_count_ok = @e55_insert_count
		,t_count_wa = 0
		,t_count_ng = 0

	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl

  --終了
  GOTO SP_OK

UP_CREDIT_URIAGE_TPC_END:

--=================================================
-- 上り未登録商品処理	-- 2014/01/20 add
--=================================================
UP_MITOUROKUSYOUHIN_TPC:
	Declare @e60_tushin_id			char(2)
	Declare @e60_shop_cd_edi		varchar(10)
	Declare @e60_data_date			char(8)
	Declare @e60_jan_cd				varchar(13)
	Declare @e60_media_cd			varchar(10)
	Declare @e60_baika				int
	Declare @e60_filter				varchar(100)
	Declare @e60_shop_cd_webpos		int
	Declare @e60_shop_name_webpos	varchar(100)	-- 2014/03/05 add
	
	Declare @a_jan_cd				varchar(13)
	Declare @a_create_date			datetime
	Declare @a_sgd_media_id			int
	Declare @a_sgd_goods_id			int
	Declare @a_sgd_franchise_id		int
	Declare @a_dgm_media_cd			varchar(10)
	
	Declare @e60_insert_count		int
	Set @e60_insert_count = 0

	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9191,未登録商品マスタ削除不正'
		GOTO SP_ERR
	End

	-- 一時テーブル
	If OBJECT_ID(N'tempdb..#seisan_temp_mitourokusyouhin', N'U') IS NOT NULL 
		DROP TABLE #seisan_temp_mitourokusyouhin  -- あれば削除
	CREATE TABLE #seisan_temp_mitourokusyouhin(
		  t_tushin_id			char(2)
		, t_kbn					char(2)
		, t_data_date			varchar(8)
		, t_shop_cd_webpos		varchar(10)
		, t_shop_name_webpos	varchar(100)	-- 2014/03/05 add
		, t_shop_cd_edi			varchar(10)
		, t_jan_cd				varchar(13)
		, t_media_cd			varchar(20)
		, t_baika				int
		, t_filter				varchar(100)
	)

	-- VJ Comment 78_20140303 add
	Declare @temp_getdate_60u as datetime = getdate()

	------------------------------
	-- 未登録商品マスタを抽出し
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		  bes_bookedi_cd
		, bes_book_shop_cd
		, sgd_jan_cd
		, gds_create_date
		, sgd_media_id
		, gdm_media_cd
		, sgd_goods_id
		, sgd_franchise_id
		, shm_shop_cd
        , shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON bes_shop_cd = shm_shop_cd
	JOIN
		wpt_shop_goods_master
		ON bes_shop_cd = sgd_shop_cd
	JOIN wpt_goods_master
		ON sgd_goods_id = gds_goods_id
	-- 2014/04/14 Masahru.Tsuruta
	-- メディア分類をエコール分類へ変換
	JOIN wpt_goods_media_master
		ON gdm_media_id = sgd_media_id
	JOIN wpt_ecole_edi_kanri_master
		ON gds_create_date > eek_jikkou_date
		AND eek_kaisei_id ='60U'  --20140225 add
	WHERE
		sgd_delete_flag = 0
		AND gds_bookedi_cd IS NULL
		AND	bes_up_eum_flag =
		Case
			When @edi_type = '60U' Then '1'
			Else bes_up_eum_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_jan_cd
		,@a_create_date
		,@a_sgd_media_id
		,@a_dgm_media_cd
		,@a_sgd_goods_id
		,@a_sgd_franchise_id
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 在庫マスタ・売価から税抜き売価を計算してセット
		Declare @stk_price money
		Set @stk_price = 0 -- 2016/08/19 追加
		SELECT
			@stk_price = stk_price
		FROM
			wpt_stock_master
		WHERE
			stk_goods_id = @a_sgd_goods_id
			AND stk_shop_cd = @a_shop_cd -- 2016/08/19 追加
			
		-- システム管理マスタの消費税率を使用して税抜き価格を計算する。
		Declare @sm1_tax_rate decimal
		SELECT
			@sm1_tax_rate = sm1_tax_rate
		FROM
			wpt_system_master
			
		-- システム管理２マスタの消費税計算区分で丸める。
		Declare @tax_rate_type varchar(1000)
		IF EXISTS(SELECT *
				FROM
					wpt_system2_master
				WHERE
					sm2_shop_cd = @a_shop_cd
					AND sm2_system_name = '消費税計算区分')
			BEGIN
				SELECT
					@tax_rate_type = sm2_data_value
				FROM
					wpt_system2_master
				WHERE
					sm2_shop_cd = @a_shop_cd
					AND sm2_system_name = '消費税計算区分'
			END
		ELSE
			BEGIN
				SELECT
					@tax_rate_type = sm2_data_value
				FROM
					wpt_system2_master
				WHERE
					sm2_franchise_id = @a_sgd_franchise_id
					AND sm2_system_name = '消費税計算区分'
			END
			
		-- 消費税額＝在庫マスタ・売価＊消費税率/(１00+消費税率)
		Declare @baika int
		SET @baika = @stk_price * @sm1_tax_rate / (100 + @sm1_tax_rate)
		
		-- 0:切捨 1:四捨五入 2:切上
		IF (@tax_rate_type = '0')
			BEGIN
				SET @baika = @stk_price - cast(@baika as int)
			END
		IF (@tax_rate_type = '1')
			BEGIN
				SET @baika = @stk_price - round(@baika, 0)
			END
		IF (@tax_rate_type = '2')
			BEGIN
				SET @baika = @stk_price - round(@baika + 0.5, 0)
			END

		-- 精算済みのPOSを取得
		INSERT INTO #seisan_temp_mitourokusyouhin (
			  t_tushin_id
			, t_kbn
			, t_data_date
			, t_shop_cd_webpos
			, t_shop_name_webpos	-- 2014/03/05 add
			, t_shop_cd_edi
			, t_jan_cd
			, t_media_cd
			, t_baika
			, t_filter
		)	
		SELECT
			distinct
			 @a_tushin_id
			,'05'
			,convert(char(8), @a_create_date, 112)
			,@a_shop_cd
			,@a_shop_name	-- 2014/03/05 add
			,@a_book_shop_cd
			,@a_jan_cd
			-- 2014/04/14 Masaharu.Tsuruta
			-- メディア分類をエコール分類へ変換
			--,ISNULL(mcb_c_code, '')
			,dbo.F_Search_Ecole_Media( '3', ISNULL( @a_dgm_media_cd, ''), 0 ) 
			,@baika
			,''
		FROM 
			wpt_goods_media_master with(nolock)
		-- 商品メディア変換テーブル
		LEFT OUTER JOIN
			wpt_goods_media_convert_book with(nolock)
			ON	mcb_media_cd = gdm_media_cd
		WHERE 
			gdm_media_id = @a_sgd_media_id

	-- 次へ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_jan_cd
		,@a_create_date
		,@a_sgd_media_id
		,@a_dgm_media_cd
		,@a_sgd_goods_id
		,@a_sgd_franchise_id
		,@a_shop_cd
		,@a_shop_name
    End  -- While

	-- カーソルを閉じる
	Close @rs
	-- 開放
	Deallocate @rs

	-- VJ Comment 73_20140225 add
	--Declare @temp_getdate_60u as datetime = getdate()

	--------------------------------
	-- 店舗、営業日、POS毎にループ
	--------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		 t_tushin_id
		,t_data_date
		,t_shop_cd_webpos
		,t_shop_name_webpos
		,t_shop_cd_edi
		,t_jan_cd
		,t_media_cd
		,t_baika
		,t_filter
	FROM
		#seisan_temp_mitourokusyouhin

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
               @e60_tushin_id
              ,@e60_data_date
              ,@e60_shop_cd_webpos
              ,@e60_shop_name_webpos
              ,@e60_shop_cd_edi
              ,@e60_jan_cd
              ,@e60_media_cd
              ,@e60_baika
              ,@e60_filter

    -- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

--print @edi_server_name
--print @edi_db_name
--print @e60_shop_name_webpos
--print @e60_jan_cd

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eum ( '
			+ '	 e60_edi_flag'
			+ '	,e60_edi_create_date '
			+ '	,e60_edi_update_date '
			+ '	,e60_server_webpos '	-- 2014/03/05 add
			+ '	,e60_dbname_webpos '	-- 2014/03/05 add
			+ '	,e60_shop_cd_webpos '	-- 2014/03/05 add
			+ '	,e60_shop_name_webpos '	-- 2014/03/05 add
			+ '	,e60_shop_cd_primary '
			+ '	,e60_shop_cd '
			+ '	,e60_tushin_id '
			+ '	,e60_data_date '
			+ '	,e60_ecl_shop_cd '
			+ '	,e60_jan_cd '
			+ '	,e60_media_cd '
			+ '	,e60_baika '
		+ ' )   '
		+ ' SELECT '
			+ '	 e60_edi_flag = ''0'' '          -- 未処理
			+ '	,e60_edi_create_date = Convert(varchar,getdate(),111) + '' '' + SubString(Convert(varchar,getdate(),114),1,8) '
			+ '	,e60_edi_update_date = Convert(varchar,getdate(),111) + '' '' + SubString(Convert(varchar,getdate(),114),1,8) '
			+ '	,e60_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))			-- 2014/03/05 add
			+ '	,e60_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))				-- 2014/03/05 add
			+ '	,e60_shop_cd_webpos = ' + '''' + Cast(@e60_shop_cd_webpos AS varchar) + ''''		-- 2014/03/05 add
			+ '	,e60_shop_name_webpos = ' + '''' + Cast(@e60_shop_name_webpos AS varchar) + ''''	-- 2014/03/05 add
			+ '	,e60_shop_cd_primary = ' + '''' + Cast(@e60_shop_cd_edi AS varchar) + ''''
			+ '	,e60_shop_cd = ' + '''' + Cast(@e60_shop_cd_edi AS varchar) + ''''
			+ '	,e60_tushin_id = ' + '''' + Cast(@e60_tushin_id AS varchar) + ''''
			+ '	,e60_data_date = ' + '''' + Cast(@e60_data_date AS char) + ''''
			+ '	,e60_ecl_shop_cd = ' + '''' + Cast(@e60_shop_cd_webpos AS varchar) + ''''
			+ '	,e60_jan_cd = ' + '''' + Cast(@e60_jan_cd AS varchar) + ''''
			+ '	,e60_media_cd = ' + '''' + Cast(@e60_media_cd AS varchar(10)) + ''''
			+ '	,e60_baika = ' + Cast(@e60_baika AS varchar)


		Exec (@a_sql)

		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End


		-- 追加件数カウント
		Set @e60_insert_count = @e60_insert_count + 1
		
		-- 次へ
		Fetch Next From @rs Into
			  @e60_tushin_id
			 ,@e60_data_date
			 ,@e60_shop_cd_webpos
			 ,@e60_shop_name_webpos
			 ,@e60_shop_cd_edi
			 ,@e60_jan_cd
			 ,@e60_media_cd
			 ,@e60_baika
			 ,@e60_filter
	End  -- While

  -- 2014/02/21 add
  --【エコールEDI作成管理マスタ】テーブルのデータを更新する。
  Update wpt_ecole_edi_kanri_master
  --Set eek_jikkou_date = Convert(varchar,getdate(),120)	-- VJ Comment 73_20140225 modify
  Set eek_jikkou_date = Convert(varchar,@temp_getdate_60u,111) + ' ' + SubString(Convert(varchar,@temp_getdate_60u,114),1,8)
  Where eek_kaisei_id = '60U'

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs

	If OBJECT_ID(N'tempdb..#seisan_temp', N'U') IS NOT NULL Begin
		DROP TABLE #seisan_temp  -- あれば削除
	End

	-- カウント初期レコードセット
	INSERT INTO #count_tbl (
		t_exec_id
		,t_tushin_id
		,t_count_all
		,t_count_ok
		,t_count_wa
		,t_count_ng
	)
	SELECT
		t_exec_id = substring(@edi_type,1,2)
		,t_tushin_id = @e60_tushin_id
		,t_count_all = @e60_insert_count
		,t_count_ok = @e60_insert_count
		,t_count_wa = 0
		,t_count_ng = 0
		
	------------------------------
	-- ログ出力
	------------------------------
	Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
		  ,@exec_start_time = @a_exec_start_time
	-- エラーチェック
	If @rc <> 0 or @@ERROR <> 0 Begin
		Set @err_msg = '9192,未登録商品マスタログ出力エラー'
		GOTO SP_ERR
	End

	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl

  --終了
  GOTO SP_OK

UP_MITOUROKUSYOUHIN_TPC_END:

--=================================================
-- 上り売上データ処理	-- 2014/02/11 add
--=================================================
UP_URIAGE_DATA:
	
  Declare @jikko_date datetime
  
  --【エコールEDI作成管理マスタ】テーブルのデータを取得する。
  Select @jikko_date = eek_jikkou_date
  From wpt_ecole_edi_kanri_master
  Where eek_kaisei_id = '61U'
  
  If @@ERROR <> 0 Or @jikko_date IS NULL Begin
	Set @err_msg = '9072,最終実行日付取得エラー'
    GOTO SP_ERR
  End
  	
  ------------------------------
  -- 処理済データ削除
  ------------------------------
  Exec @rc = P_EDI_Book_DataDelete
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9071,売上データ削除不正'
    GOTO SP_ERR
  End
  
  -- 2014/03/03 add
  Declare @temp_getdate_61u as datetime = getdate()
  
  Set @rs = cursor static read_only for 
    SELECT
       bes_bookedi_cd
      ,bes_book_shop_cd
      ,bes_tohan_group_cd
      ,shm_shop_cd
      ,shm_shop_name
      ,mpm_edi_type
      ,bes_tohan_ur_format_type
    from
       wpt_book_edi_setting
       join
       wpt_shop_master
         on
         bes_shop_cd = shm_shop_cd
       join
       wpt_maker_supplier_master
         on
         bes_bookedi_cd = mpm_bookedi_cd
         and mpm_shop_cd IS NULL
    where
--     bes_up_urd_flag = '1'
       bes_up_eur_flag = '1'                    -- 2015/08/06 update
    and                                         -- 2015/08/06 add
       bes_bookedi_cd = 'EC'                    -- 2015/08/06 add
       
       -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @a_tushin_id
              ,@a_book_shop_cd
              ,@a_tohan_group_cd
              ,@a_shop_cd
              ,@a_shop_name
              ,@a_supplier_edi_type
              ,@a_tohan_ur_format_type

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
		
-- 2014-04-15 エコール売上は別コントロール		
--		Insert wbe_edibook_up_control(
		Insert wbe_edibook_up_control_ecole(
			 e10_edi_tushin_id
			,e10_edi_trn_id
			,e10_edi_line_no
			,e10_edi_flag
			,e10_edi_create_date
			,e10_edi_shop_cd_webpos
			,e10_edi_shop_name_webpos
			,e10_edi_shop_cd
			,e10_tohan_group_cd
		) Select
			 e10_edi_tushin_id = @a_tushin_id
			,e10_edi_trn_id = tdu_trn_id
			,e10_edi_line_no = tdu_line_no
			,e10_edi_flag = '0'     -- 未処理
			,e10_edi_create_date = getdate()
			,e10_edi_shop_cd_webpos = @a_shop_cd
			,e10_edi_shop_name_webpos = @a_shop_name
			,e10_edi_shop_cd = @a_book_shop_cd
			,e10_tohan_group_cd = @a_tohan_group_cd
		From
			wpv_transaction
			Join wpt_transaction_uriage On
				trn_trn_id = tur_trn_id
			Join wpt_transaction_uriage_details On
				trn_trn_id = tdu_trn_id
-- 2014-04-15 エコール売上は別コントロール		
--			Left Outer Join wbe_edibook_up_control On
			Left Outer Join wbe_edibook_up_control_ecole On
				e10_edi_tushin_id = @a_tushin_id And
				e10_edi_trn_id = tdu_trn_id And
				e10_edi_line_no = tdu_line_no
		Where
			trn_shop_cd = @a_shop_cd And
			trn_work_type IN ('0000', '0001') And
			trn_denpyo_type = '0' And
			trn_create_date >= @jikko_date And
			trn_create_date < GETDATE() And
			e10_edi_trn_id Is Null And
			e10_edi_line_no Is Null And
			tdu_koyu_goods_id Is Not Null And
			tdu_jan_cd Is Not Null
			
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @err_msg = '9074,売上データ抽出エラー'
			GOTO SP_ERR
		End
		
-- 2014-04-15 エコール売上は別コントロールテーブルに変更		
--		Insert wbe_edibook_up_control(
		Insert wbe_edibook_up_control_ecole(
			 e10_edi_tushin_id
			,e10_edi_trn_id
			,e10_edi_line_no
			,e10_edi_flag
			,e10_edi_create_date
			,e10_edi_shop_cd_webpos
			,e10_edi_shop_name_webpos
			,e10_edi_shop_cd
			,e10_tohan_group_cd
		) Select
			 e10_edi_tushin_id = @a_tushin_id
			,e10_edi_trn_id = tdu_trn_id
			,e10_edi_line_no = tdu_line_no
			,e10_edi_flag = '0'     -- 未処理
			,e10_edi_create_date = getdate()
			,e10_edi_shop_cd_webpos = @a_shop_cd
			,e10_edi_shop_name_webpos = @a_shop_name
			,e10_edi_shop_cd = @a_book_shop_cd
			,e10_tohan_group_cd = @a_tohan_group_cd
		From
			wpv_transaction
			Join wpt_transaction_uriage On
				trn_trn_id = tur_trn_id
			Join wpt_transaction_uriage_details On
				trn_trn_id = tdu_trn_id
-- 2014-04-15 エコール売上は別コントロールテーブルに変更		
--			Left Outer Join wbe_edibook_up_control On
			Left Outer Join wbe_edibook_up_control_ecole On
				e10_edi_tushin_id = @a_tushin_id And
				e10_edi_trn_id = tdu_trn_id And
				e10_edi_line_no = tdu_line_no
		Where
			trn_shop_cd = @a_shop_cd And
			trn_work_type IN ('0000', '0001') And
			trn_denpyo_type = '0' And
			trn_create_date >= @jikko_date And
			trn_create_date < GETDATE() And
			e10_edi_trn_id Is Null And
			e10_edi_line_no Is Null And
			tdu_koyu_goods_id Is Null And
			tdu_jan_cd Is Null And
			tdu_media_cd Is Not Null
			
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @err_msg = '9074,売上データ抽出エラー'
			GOTO SP_ERR
		End	
		
		-- 次へ
		fetch next from @rs into
			 @a_tushin_id
			,@a_book_shop_cd
			,@a_tohan_group_cd
			,@a_shop_cd
			,@a_shop_name
			,@a_supplier_edi_type
			,@a_tohan_ur_format_type
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs
  
  ------------------------------
  -- データ転送
  ------------------------------
  
  -- 初期値セット
  SELECT
	 @a_edi_error_msg = null         -- エラーメッセージクリア
	,@a_edi_flag = '1'                    -- EDIフラグ実行済み
 
 -- 2014/02/25 Modify
 -- Select
	--@a_sql = ''
	--		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur ( '
	--		+ '		 e61_edi_flag '
	--		+ '		,e61_edi_create_date '
	--		+ '		,e61_edi_update_date '
	--		+ '		,e61_edi_file_line_no '
	--		+ '		,e61_edi_meisai_no '
	--		+ '		,e61_edi_error_msg '
	--		+ '		,e61_server_webpos '
	--		+ '		,e61_dbname_webpos '
	--		+ '		,e61_shop_cd_webpos '
	--		+ '		,e61_shop_name_webpos '
	--		+ '		,e61_seq_no '
	--		+ '		,e61_shop_cd_primary '
	--		+ '		,e61_shop_cd '
	--		+ '		,e61_tushin_id '
	--		+ '		,e61_data_date '
	--		+ '		,e61_ecl_shop_cd '
	--		+ '		,e61_ecole_hinban '
	--		+ '		,e61_jan_cd '
	--		+ '		,e61_ecl_bunrui_cd '
	--		+ '		,e61_usr_bunrui_cd '
	--		+ '		,e61_usr_bunrui_name '
	--		+ '		,e61_siire_cd '
	--		+ '		,e61_siire_name '
	--		+ '		,e61_data_kbn '
	--		+ '		,e61_uriage_su '
	--		+ '		,e61_baika_tanka '
	--		+ '		,e61_uriage_kin '
	--		+ '	) SELECT ' 
	--		+ '		 e61_edi_flag = ''0'' '
	--		+ '		,e61_edi_create_date = getdate() '	-- 2014/02/26 modify
	--		+ '		,e61_edi_update_date = getdate() '	-- 2014/02/26 modify
	--		--+ '		,e61_edi_create_date = ' + @temp_getdate
	--		--+ '		,e61_edi_update_date = ' + @temp_getdate
	--		+ '		,e61_edi_file_line_no = tdu_line_no '
	--		+ '		,e61_edi_meisai_no = tdu_line_no '
	--		+ '		,e61_edi_error_msg = NULL '
	--		+ '		,e61_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	--		+ '		,e61_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	--		+ '		,e61_shop_cd_webpos = e10_edi_shop_cd_webpos '
	--		+ '		,e61_shop_name_webpos = e10_edi_shop_name_webpos '
	--		+ '		,e61_seq_no = NULL '
	--		+ '		,e61_shop_cd_primary = '
	--		+ '			CASE WHEN e10_edi_tushin_id=''SK'' THEN e10_tohan_group_cd ELSE e10_edi_shop_cd END '
	--		+ '		,e61_shop_cd = e10_edi_shop_cd '
	--		+ '		,e61_tushin_id = e10_edi_tushin_id '
	--		+ '		,e61_data_date = '
	--		+ '			right(''0000'' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) + '
	--		+ '			right(''00'' + cast(datepart(mm,trn_create_date) as varchar), 2 ) + '
	--		+ '			right(''00'' + cast(datepart(dd,trn_create_date) as varchar), 2) '
	--		+ '		,e61_ecl_shop_cd = trn_shop_cd '
	--		+ '		,e61_ecole_hinban = tdu_koyu_goods_id '
	--		+ '		,e61_jan_cd = tdu_jan_cd '
	--		+ '		,e61_ecl_bunrui_cd = tdu_media_cd '
	--		+ '		,e61_usr_bunrui_cd = NULL '
	--		+ '		,e61_usr_bunrui_name = NULL '
	--		--+ '		,e61_siire_cd = mpm_supplier_cd '		-- 2014/02/22 modify
	--		--+ '		,e61_siire_name = mpm_supplier_name '	-- 2014/02/22 modify
	--		+ '		,e61_siire_cd = ISNULL(mpm_supplier_cd, ''0000000000'') '
	--		+ '		,e61_siire_name = ISNULL(mpm_supplier_name, '''') '
	--		+ '		,e61_data_kbn = ''0'' '
	--		+ '		,e61_uriage_su = tdu_selling_count '
	--		+ '		,e61_baika_tanka = tdu_price '
	--		+ '		,e61_uriage_kin = tdu_selling_price '
	--		+ '	FROM '
	--		+ '		wbe_edibook_up_control '
	--		+ '		JOIN wpt_transaction_uriage_details ON '
	--		+ '			e10_edi_trn_id = tdu_trn_id AND '
	--		+ '			e10_edi_line_no = tdu_line_no '
	--		+ '		JOIN wpt_transaction_uriage ON '
	--		+ '			tdu_trn_id = tur_trn_id '
	--		+ '		JOIN wpt_transaction ON '
	--		+ '			trn_trn_id = tdu_trn_id '
	--		+ '		LEFT OUTER JOIN wpt_goods_master_disk ON '
	--		+ '			gdd_goods_id = tdu_goods_id '
	--		+ '		LEFT OUTER JOIN wpt_maker_label_master ON '
	--		+ '			mlm_label_cd = gdd_label_cd '
	--		+ '		LEFT OUTER JOIN wpt_maker_sales_setting ON '
	--		+ '			mss_sales_cd = mlm_sales_cd AND '
	--		+ '			mss_shop_cd = e10_edi_shop_cd_webpos '
	--		+ '		LEFT OUTER JOIN wpt_maker_supplier_master ON '
	--		+ '			mpm_supplier_id = mss_supplier1_id '
	--		+ '	WHERE '
	--		+ '		e10_edi_flag = ''0'' AND '
	--		+ '		tdu_koyu_goods_id IS NOT NULL AND '
	--		+ '		tdu_jan_cd IS NOT NULL '
	--		+ ' ORDER BY '
	--		+ '		 e10_edi_trn_id '
	--		+ '		,e10_edi_line_no '

 -- Exec (@a_sql)
 -- -- エラーチェック
 -- If @@ERROR <> 0 Begin
	--Set @a_edi_flag = '3'  -- エラー
 -- End
  
 -- Select
	--@a_sql = ''
	--		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur ( '
	--		+ '		 e61_edi_flag '
	--		+ '		,e61_edi_create_date '
	--		+ '		,e61_edi_update_date '
	--		+ '		,e61_edi_file_line_no '
	--		+ '		,e61_edi_meisai_no '
	--		+ '		,e61_edi_error_msg '
	--		+ '		,e61_server_webpos '
	--		+ '		,e61_dbname_webpos '
	--		+ '		,e61_shop_cd_webpos '
	--		+ '		,e61_shop_name_webpos '
	--		+ '		,e61_seq_no '
	--		+ '		,e61_shop_cd_primary '
	--		+ '		,e61_shop_cd '
	--		+ '		,e61_tushin_id '
	--		+ '		,e61_data_date '
	--		+ '		,e61_ecl_shop_cd '
	--		+ '		,e61_ecole_hinban '
	--		+ '		,e61_jan_cd '
	--		+ '		,e61_ecl_bunrui_cd '
	--		+ '		,e61_usr_bunrui_cd '
	--		+ '		,e61_usr_bunrui_name '
	--		+ '		,e61_siire_cd '
	--		+ '		,e61_siire_name '
	--		+ '		,e61_data_kbn '
	--		+ '		,e61_uriage_su '
	--		+ '		,e61_baika_tanka '
	--		+ '		,e61_uriage_kin '
	--		+ '	) SELECT ' 
	--		+ '		 e61_edi_flag = ''0'' '
	--		+ '		,e61_edi_create_date = getdate() '	-- 2014/02/26 modify
	--		+ '		,e61_edi_update_date = getdate() '	-- 2014/02/26 modify
	--		--+ '		,e61_edi_create_date = ' + @temp_getdate
	--		--+ '		,e61_edi_update_date = ' + @temp_getdate
	--		+ '		,e61_edi_file_line_no = tdu_line_no '
	--		+ '		,e61_edi_meisai_no = tdu_line_no '
	--		+ '		,e61_edi_error_msg = NULL '
	--		+ '		,e61_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
	--		+ '		,e61_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
	--		+ '		,e61_shop_cd_webpos = e10_edi_shop_cd_webpos '
	--		+ '		,e61_shop_name_webpos = e10_edi_shop_name_webpos '
	--		+ '		,e61_seq_no = NULL '
	--		+ '		,e61_shop_cd_primary = '
	--		+ '			CASE WHEN e10_edi_tushin_id=''SK'' THEN e10_tohan_group_cd ELSE e10_edi_shop_cd END '
	--		+ '		,e61_shop_cd = e10_edi_shop_cd '
	--		+ '		,e61_tushin_id = e10_edi_tushin_id '
	--		+ '		,e61_data_date = '
	--		+ '			right(''0000'' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) + '
	--		+ '			right(''00'' + cast(datepart(mm,trn_create_date) as varchar), 2 ) + '
	--		+ '			right(''00'' + cast(datepart(dd,trn_create_date) as varchar), 2) '
	--		+ '		,e61_ecl_shop_cd = trn_shop_cd '
	--		+ '		,e61_ecole_hinban = tdu_koyu_goods_id '
	--		+ '		,e61_jan_cd = tdu_jan_cd '
	--		+ '		,e61_ecl_bunrui_cd = NULL '
	--		+ '		,e61_usr_bunrui_cd = NULL '
	--		+ '		,e61_usr_bunrui_name = NULL '
	--		+ '		,e61_siire_cd = NULL '
	--		+ '		,e61_siire_name = NULL '
	--		+ '		,e61_data_kbn = ''0'' '
	--		+ '		,e61_uriage_su = tdu_selling_count '
	--		+ '		,e61_baika_tanka = tdu_price '
	--		+ '		,e61_uriage_kin = tdu_selling_price '
	--		+ '	FROM '
	--		+ '		wbe_edibook_up_control '
	--		+ '		JOIN wpt_transaction_uriage_details ON '
	--		+ '			e10_edi_trn_id = tdu_trn_id AND '
	--		+ '			e10_edi_line_no = tdu_line_no '
	--		+ '		JOIN wpt_transaction_uriage ON '
	--		+ '			tdu_trn_id = tur_trn_id '
	--		+ '		JOIN wpt_transaction ON '
	--		+ '			trn_trn_id = tdu_trn_id '
	--		+ '	WHERE '
	--		+ '		e10_edi_flag = ''0'' AND '
	--		+ '		tdu_koyu_goods_id IS NULL AND '
	--		+ '		tdu_jan_cd IS NULL AND '
	--		+ '		tdu_media_cd IS NOT NULL'
	--		+ ' ORDER BY '
	--		+ '		 e10_edi_trn_id '
	--		+ '		,e10_edi_line_no '
 -- Exec (@a_sql)
 -- -- エラーチェック
 -- If @@ERROR <> 0 Begin
	--Set @a_edi_flag = '3'  -- エラー
 -- End
 
  -- 2014/03/03 delete
  --Declare @temp_getdate_61u as datetime = getdate()
  
  Declare @e61_shop_cd_webpos as varchar(10) = ''
  Declare @e61_shop_name_webpos as varchar(100) = ''
  Declare @e61_shop_cd_primary as varchar(10) = ''
  Declare @e61_shop_cd as varchar(20) = ''
  Declare @e61_tushin_id as varchar(2) = ''
  Declare @e61_data_date as varchar(8) = ''
  Declare @e61_ecl_shop_cd as varchar(10) = ''
  Declare @e61_ecole_hinban as varchar(20) = ''
  Declare @e61_jan_cd as varchar(13) = ''
  Declare @e61_ecl_bunrui_cd as varchar(10) = ''
  Declare @e61_siire_cd as varchar(10) = ''
  Declare @e61_siire_name as varchar(100) = ''
  Declare @e61_uriage_su as int = 0
  Declare @e61_baika_tanka as int = 0
  Declare @e61_uriage_kin as money = 0
  
  Declare @e61_ecl_shop_cd_prev as varchar(10) = ''
  Declare @e61_ecole_hinban_prev as varchar(20) = ''
  Declare @e61_shop_cd_webpos_prev as varchar(10) = ''
  Declare @e61_shop_name_webpos_prev as varchar(100) = ''
  Declare @e61_shop_cd_primary_prev as varchar(10) = ''
  Declare @e61_shop_cd_prev as varchar(20) = ''
  Declare @e61_tushin_id_prev as varchar(2) = ''
  Declare @e61_data_date_prev as varchar(8) = ''
  Declare @e61_jan_cd_prev as varchar(13) = ''
  Declare @e61_ecl_bunrui_cd_prev as varchar(10) = ''
  Declare @e61_siire_cd_prev as varchar(10) = ''
  Declare @e61_siire_name_prev as varchar(100) = ''
  Declare @e61_uriage_su_total as int = 0
  Declare @e61_baika_tanka_first as int = 0
  Declare @e61_uriage_kin_total as money = 0
  -- 2014/03/10 add
  Declare @e61_edi_trn_id as int = 0
  Declare @e61_trn_work_type as char(4) = ''
  Declare @e61_data_kbn_prev as char(1) = ''
  
  Declare @iCount as int = 0
  
  Set @rs = cursor static read_only for 
    SELECT
		 e61_shop_cd_webpos = ISNULL(e10_edi_shop_cd_webpos, '')
		,e61_shop_name_webpos = ISNULL(e10_edi_shop_name_webpos, '')
		,e61_shop_cd_primary =
			CASE WHEN e10_edi_tushin_id='SK' THEN e10_tohan_group_cd ELSE ISNULL(e10_edi_shop_cd, '') END
		,e61_shop_cd = ISNULL(e10_edi_shop_cd, '')
		,e61_tushin_id = ISNULL(e10_edi_tushin_id, '')
		,e61_data_date =
			right('0000' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) +
			right('00' + cast(datepart(mm,trn_create_date) as varchar), 2 ) +
			right('00' + cast(datepart(dd,trn_create_date) as varchar), 2)
		,e61_ecl_shop_cd = ISNULL(trn_shop_cd, '')
		--2014-04-14 M.Tsuruta
		-- 頭ゼロをつけて8桁にする
		--,e61_ecole_hinban = ISNULL(tdu_koyu_goods_id, '' ) 
		,e61_ecole_hinban = Right( '00000000' + ISNULL(tdu_koyu_goods_id, '' ) , 8 )
		,e61_jan_cd = ISNULL(tdu_jan_cd, '')
		-- 2014/04/14 メディア分類からエコール分類へ変更 Masaharu.Tsuruta
		--,e61_ecl_bunrui_cd = ISNULL(tdu_media_cd, '')
		,e61_ecl_bunrui_cd = dbo.F_Search_Ecole_Media('3', ISNULL(tdu_media_cd, ''), 0 ) 
        --2014/02/26 M.Tsuruta
		--,e61_siire_cd = ISNULL(mpm_supplier_cd,'0000000000')
		,e61_siire_cd = ISNULL(mpm_supplier_cd,'0000')
		,e61_siire_name = ISNULL(mpm_supplier_name,'')
		,e61_uriage_su = ISNULL(tdu_selling_count, 0)
		,e61_baika_tanka = ISNULL(tdu_price, 0)
		,e61_uriage_kin = ISNULL(tdu_selling_price, 0)
		,e61_edi_trn_id = e10_edi_trn_id	-- 2014/03/10 add
	FROM
-- 2014-04-15 エコール売上は別コントロールテーブルに変更		
--		wbe_edibook_up_control
		wbe_edibook_up_control_ecole
		JOIN wpt_transaction_uriage_details ON
			e10_edi_trn_id = tdu_trn_id AND
			e10_edi_line_no = tdu_line_no
		JOIN wpt_transaction_uriage ON
			tdu_trn_id = tur_trn_id
		JOIN wpt_transaction ON
			trn_trn_id = tdu_trn_id
		LEFT OUTER JOIN wpt_goods_master_disk ON
			gdd_goods_id = tdu_goods_id
		LEFT OUTER JOIN wpt_maker_label_master ON
			mlm_label_cd = gdd_label_cd
		LEFT OUTER JOIN wpt_maker_sales_setting ON
			mss_sales_cd = mlm_sales_cd AND
			mss_shop_cd = e10_edi_shop_cd_webpos
		LEFT OUTER JOIN wpt_maker_supplier_master ON
			mpm_supplier_id = mss_supplier1_id
	WHERE
		e10_edi_flag ='0' AND
		tdu_koyu_goods_id IS NOT NULL AND
		tdu_jan_cd IS NOT NULL
	ORDER BY
		 trn_shop_cd
		-- 2015/08/06 add
		,right('0000' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) +
		 right('00' + cast(datepart(mm,trn_create_date) as varchar), 2 ) +
		 right('00' + cast(datepart(dd,trn_create_date) as varchar), 2)
		-- 2015/08/06 add
		,tdu_koyu_goods_id
		,e10_edi_trn_id
		,e10_edi_line_no
       
       -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @e61_shop_cd_webpos
              ,@e61_shop_name_webpos
              ,@e61_shop_cd_primary
              ,@e61_shop_cd
              ,@e61_tushin_id
              ,@e61_data_date
              ,@e61_ecl_shop_cd
              ,@e61_ecole_hinban
              ,@e61_jan_cd
              ,@e61_ecl_bunrui_cd
              ,@e61_siire_cd
              ,@e61_siire_name
              ,@e61_uriage_su
              ,@e61_baika_tanka
              ,@e61_uriage_kin
              ,@e61_edi_trn_id

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
		If @e61_ecl_shop_cd_prev = '' Begin
			Set @e61_ecl_shop_cd_prev		= @e61_ecl_shop_cd
			Set @e61_shop_cd_webpos_prev	= @e61_shop_cd_webpos
			Set @e61_shop_name_webpos_prev	= @e61_shop_name_webpos
			Set @e61_shop_cd_primary_prev	= @e61_shop_cd_primary
			Set @e61_shop_cd_prev			= @e61_shop_cd
			Set @e61_tushin_id_prev			= @e61_tushin_id
			Set @e61_data_date_prev			= @e61_data_date
			Set @e61_jan_cd_prev			= @e61_jan_cd
			Set @e61_ecl_bunrui_cd_prev		= @e61_ecl_bunrui_cd
			Set @e61_siire_cd_prev			= @e61_siire_cd
			Set @e61_siire_name_prev		= @e61_siire_name
			Set @e61_baika_tanka_first		= @e61_baika_tanka
			Set @e61_ecole_hinban_prev		= @e61_ecole_hinban
		End
--		If @e61_ecl_shop_cd <> @e61_ecl_shop_cd_prev Or @e61_ecole_hinban <> @e61_ecole_hinban_prev Begin
		If @e61_ecl_shop_cd <> @e61_ecl_shop_cd_prev Or @e61_data_date <> @e61_data_date_prev Or @e61_ecole_hinban <> @e61_ecole_hinban_prev Begin	-- 2015/08/06 update
			Select
				@a_sql = ''
						+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur ( '
						+ '		 e61_edi_flag '
						+ '		,e61_edi_create_date '
						+ '		,e61_edi_update_date '
						+ '		,e61_edi_file_line_no '
						+ '		,e61_edi_meisai_no '
						+ '		,e61_edi_error_msg '
						+ '		,e61_server_webpos '
						+ '		,e61_dbname_webpos '
						+ '		,e61_shop_cd_webpos '
						+ '		,e61_shop_name_webpos '
						+ '		,e61_seq_no '
						+ '		,e61_shop_cd_primary '
						+ '		,e61_shop_cd '
						+ '		,e61_tushin_id '
						+ '		,e61_data_date '
						+ '		,e61_ecl_shop_cd '
						+ '		,e61_ecole_hinban '
						+ '		,e61_jan_cd '
						+ '		,e61_ecl_bunrui_cd '
						+ '		,e61_usr_bunrui_cd '
						+ '		,e61_usr_bunrui_name '
						+ '		,e61_siire_cd '
						+ '		,e61_siire_name '
						+ '		,e61_data_kbn '
						+ '		,e61_uriage_su '
						+ '		,e61_baika_tanka '
						+ '		,e61_uriage_kin '
						+ '	) VALUES ( ' 
						+ '		 0'
						+ '		,getdate() '
						+ '		,getdate() '
						+ '		,1 '
						+ '		,1 '
						+ '		,NULL '
						+ '		,' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
						+ '		,' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
						+ '		,''' + @e61_shop_cd_webpos_prev + ''''
						+ '		,''' + @e61_shop_name_webpos_prev + ''''
						+ '		,NULL '
						+ '		,''' + @e61_shop_cd_primary_prev + ''''
						+ '		,''' + @e61_shop_cd_prev + ''''
						+ '		,''' + @e61_tushin_id_prev + ''''
						+ '		,''' + @e61_data_date_prev + ''''
						+ '		,''' + @e61_ecl_shop_cd_prev + ''''
						+ '		,''' + @e61_ecole_hinban_prev + ''''
						+ '		,''' + @e61_jan_cd_prev + ''''
						+ '		,''' + @e61_ecl_bunrui_cd_prev + ''''
						+ '		,NULL '
						+ '		,NULL '
						+ '		,''' + @e61_siire_cd_prev + ''''
						+ '		,''' + @e61_siire_name_prev + ''''
						--+ '		,''0'' '						-- 2014/03/10 delete
						+ '		,''' + @e61_data_kbn_prev + ''''	-- 2014/03/10 add
						-- 2014-03-11 符号はなしでセットするように修正
						--+ '		,' + cast(@e61_uriage_su_total as varchar(1000))
						+ '		,' + cast( abs( @e61_uriage_su_total ) as varchar(1000)) 
						+ '		,' + cast(@e61_baika_tanka_first as varchar(1000))
						-- 2014-03-11 符号はなしでセットするように修正
						--+ '		,' + cast(@e61_uriage_kin_total as varchar(1000))
						+ '		,' + cast( abs( @e61_uriage_kin_total ) as varchar(1000))
						+ ')'
			Exec (@a_sql)
			-- エラーチェック
			If @@ERROR <> 0 Begin
				Set @a_edi_flag = '3'  -- エラー
			End
			Set @e61_ecl_shop_cd_prev		= @e61_ecl_shop_cd
			Set @e61_ecole_hinban_prev		= @e61_ecole_hinban
			Set @e61_shop_cd_webpos_prev	= @e61_shop_cd_webpos
			Set @e61_shop_name_webpos_prev	= @e61_shop_name_webpos
			Set @e61_shop_cd_primary_prev	= @e61_shop_cd_primary
			Set @e61_shop_cd_prev			= @e61_shop_cd
			Set @e61_tushin_id_prev			= @e61_tushin_id
			Set @e61_data_date_prev			= @e61_data_date
			Set @e61_jan_cd_prev			= @e61_jan_cd
			Set @e61_ecl_bunrui_cd_prev		= @e61_ecl_bunrui_cd
			Set @e61_siire_cd_prev			= @e61_siire_cd
			Set @e61_siire_name_prev		= @e61_siire_name
			
			Set @e61_uriage_su_total		= 0
			Set @e61_baika_tanka_first		= @e61_baika_tanka
			Set @e61_uriage_kin_total		= 0
		End
		
		Set @iCount = @iCount + 1
		-- 2014/03/10 add
		Set @e61_trn_work_type = ''
		Select @e61_trn_work_type = ISNULL(trn_work_type, '0000')
		From wpv_transaction
		Where trn_shop_cd = @e61_shop_cd_webpos And
			trn_denpyo_type = '0' And
			trn_create_date >= @jikko_date And
			trn_create_date < GETDATE() And
			trn_trn_id = @e61_edi_trn_id

		If @e61_trn_work_type = '0001' Begin
			Set @e61_uriage_su = (-1) * @e61_uriage_su
			Set @e61_uriage_kin = (-1) * @e61_uriage_kin
		End
		
		Set @e61_uriage_su_total = @e61_uriage_su_total + @e61_uriage_su
		Set @e61_uriage_kin_total = @e61_uriage_kin_total + @e61_uriage_kin
		
		-- 2014/03/10 add
--		If @e61_uriage_su_total < 0 Begin
		If @e61_uriage_kin_total < 0 Begin			-- 2015/08/06 update
			Set @e61_data_kbn_prev = '1'
		End
		Else Begin
			Set @e61_data_kbn_prev = '0'
		End
		
		-- 次へ
		fetch next from @rs into
			   @e61_shop_cd_webpos
              ,@e61_shop_name_webpos
              ,@e61_shop_cd_primary
              ,@e61_shop_cd
              ,@e61_tushin_id
              ,@e61_data_date
              ,@e61_ecl_shop_cd
              ,@e61_ecole_hinban
              ,@e61_jan_cd
              ,@e61_ecl_bunrui_cd
              ,@e61_siire_cd
              ,@e61_siire_name
              ,@e61_uriage_su
              ,@e61_baika_tanka
              ,@e61_uriage_kin
              ,@e61_edi_trn_id
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs
  
  If @iCount > 0 Begin
	Select
		@a_sql = ''
				+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur ( '
				+ '		 e61_edi_flag '
				+ '		,e61_edi_create_date '
				+ '		,e61_edi_update_date '
				+ '		,e61_edi_file_line_no '
				+ '		,e61_edi_meisai_no '
				+ '		,e61_edi_error_msg '
				+ '		,e61_server_webpos '
				+ '		,e61_dbname_webpos '
				+ '		,e61_shop_cd_webpos '
				+ '		,e61_shop_name_webpos '
				+ '		,e61_seq_no '
				+ '		,e61_shop_cd_primary '
				+ '		,e61_shop_cd '
				+ '		,e61_tushin_id '
				+ '		,e61_data_date '
				+ '		,e61_ecl_shop_cd '
				+ '		,e61_ecole_hinban '
				+ '		,e61_jan_cd '
				+ '		,e61_ecl_bunrui_cd '
				+ '		,e61_usr_bunrui_cd '
				+ '		,e61_usr_bunrui_name '
				+ '		,e61_siire_cd '
				+ '		,e61_siire_name '
				+ '		,e61_data_kbn '
				+ '		,e61_uriage_su '
				+ '		,e61_baika_tanka '
				+ '		,e61_uriage_kin '
				+ '	) VALUES ( ' 
				+ '		 0'
				+ '		,getdate() '
				+ '		,getdate() '
				+ '		,1 '
				+ '		,1 '
				+ '		,NULL '
				+ '		,' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
				+ '		,' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
				+ '		,''' + @e61_shop_cd_webpos_prev + ''''
				+ '		,''' + @e61_shop_name_webpos_prev + ''''
				+ '		,NULL '
				+ '		,''' + @e61_shop_cd_primary_prev + ''''
				+ '		,''' + @e61_shop_cd_prev + ''''
				+ '		,''' + @e61_tushin_id_prev + ''''
				+ '		,''' + @e61_data_date_prev + ''''
				+ '		,''' + @e61_ecl_shop_cd_prev + ''''
				+ '		,''' + @e61_ecole_hinban_prev + ''''
				+ '		,''' + @e61_jan_cd_prev + ''''
				+ '		,''' + @e61_ecl_bunrui_cd_prev + ''''
				+ '		,NULL '
				+ '		,NULL '
				+ '		,''' + @e61_siire_cd_prev + ''''
				+ '		,''' + @e61_siire_name_prev + ''''
				--+ '		,''0'' '						-- 2014/03/10 delete
				+ '		,''' + @e61_data_kbn_prev + ''''	-- 2014/03/10 add
				-- 2014-03-11 符号はなしでセットするように修正
				--+ '		,' + cast(@e61_uriage_su_total as varchar(1000))
				+ '		,' + cast( abs( @e61_uriage_su_total ) as varchar(1000))  
				+ '		,' + cast(@e61_baika_tanka_first as varchar(1000))
				-- 2014-03-11 符号はなしでセットするように修正
				--+ '		,' + cast(@e61_uriage_kin_total as varchar(1000))
				+ '		,' + cast( abs( @e61_uriage_kin_total ) as varchar(1000)) 
				+ ')'
	  Exec (@a_sql)
	  -- エラーチェック
	  If @@ERROR <> 0 Begin
		Set @a_edi_flag = '3'  -- エラー
	  End
  End
  
  Set @iCount = 0
  Set @e61_ecl_shop_cd_prev			= ''
  Set @e61_ecole_hinban_prev		= ''
  Set @e61_shop_cd_webpos_prev		= ''
  Set @e61_shop_name_webpos_prev	= ''
  Set @e61_shop_cd_primary_prev		= ''
  Set @e61_shop_cd_prev				= ''
  Set @e61_tushin_id_prev			= ''
  Set @e61_data_date_prev			= ''
  Set @e61_jan_cd_prev				= ''
  Set @e61_ecl_bunrui_cd_prev		= ''
  Set @e61_siire_cd_prev			= ''
  Set @e61_siire_name_prev			= ''
  -- 2014/03/10 add
  Set @e61_edi_trn_id				= ''
  Set @e61_data_kbn_prev			= ''
  
  Set @rs = cursor static read_only for 
    SELECT
		 e61_shop_cd_webpos = ISNULL(e10_edi_shop_cd_webpos, '')
		,e61_shop_name_webpos = ISNULL(e10_edi_shop_name_webpos, '')
		,e61_shop_cd_primary =
			CASE WHEN e10_edi_tushin_id='SK' THEN ISNULL(e10_tohan_group_cd, '') ELSE ISNULL(e10_edi_shop_cd, '') END
		,e61_shop_cd = ISNULL(e10_edi_shop_cd, '')
		,e61_tushin_id = ISNULL(e10_edi_tushin_id, '')
		,e61_data_date =
			right('0000' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) +
			right('00' + cast(datepart(mm,trn_create_date) as varchar), 2 ) +
			right('00' + cast(datepart(dd,trn_create_date) as varchar), 2)
		,e61_ecl_shop_cd = ISNULL(trn_shop_cd, '')
		-- 2014-04-14 M.Tsuruta 
		-- 頭ゼロで8桁にする
		--,e61_ecole_hinban = ISNULL(tdu_koyu_goods_id, '')
		,e61_ecole_hinban = Right( '00000000' + ISNULL(tdu_koyu_goods_id, ''), 8 )
		,e61_uriage_su = ISNULL(tdu_selling_count, 0)
		,e61_baika_tanka = ISNULL(tdu_price, 0)
		,e61_uriage_kin = ISNULL(tdu_selling_price, 0)
		,e61_edi_trn_id = e10_edi_trn_id	-- 2014/03/10 add
	FROM
-- 2014-04-15 エコール売上は別コントロールテーブルに変更		
--		wbe_edibook_up_control
		wbe_edibook_up_control_ecole
		JOIN wpt_transaction_uriage_details ON
			e10_edi_trn_id = tdu_trn_id AND
			e10_edi_line_no = tdu_line_no
		JOIN wpt_transaction_uriage ON
			tdu_trn_id = tur_trn_id
		JOIN wpt_transaction ON
			trn_trn_id = tdu_trn_id
	WHERE
		e10_edi_flag = '0' AND
		tdu_koyu_goods_id IS NULL AND
		tdu_jan_cd IS NULL AND
		tdu_media_cd IS NOT NULL
	ORDER BY
		 trn_shop_cd
		-- 2015/08/06 add
		,right('0000' + cast(datepart(yyyy,trn_create_date) as varchar), 4 ) +
		 right('00' + cast(datepart(mm,trn_create_date) as varchar), 2 ) +
		 right('00' + cast(datepart(dd,trn_create_date) as varchar), 2)
		-- 2015/08/06 add
		,tdu_koyu_goods_id
		,e10_edi_trn_id
		,e10_edi_line_no
       
       -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
               @e61_shop_cd_webpos
              ,@e61_shop_name_webpos
              ,@e61_shop_cd_primary
              ,@e61_shop_cd
              ,@e61_tushin_id
              ,@e61_data_date
              ,@e61_ecl_shop_cd
              ,@e61_ecole_hinban
              ,@e61_uriage_su
              ,@e61_baika_tanka
              ,@e61_uriage_kin
              ,@e61_edi_trn_id

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
		If @e61_ecl_shop_cd_prev = '' Begin
			Set @e61_ecl_shop_cd_prev		= @e61_ecl_shop_cd
			Set @e61_shop_cd_webpos_prev	= @e61_shop_cd_webpos
			Set @e61_shop_name_webpos_prev	= @e61_shop_name_webpos
			Set @e61_shop_cd_primary_prev	= @e61_shop_cd_primary
			Set @e61_shop_cd_prev			= @e61_shop_cd
			Set @e61_tushin_id_prev			= @e61_tushin_id
			Set @e61_data_date_prev			= @e61_data_date
			Set @e61_jan_cd_prev			= @e61_jan_cd
			Set @e61_ecl_bunrui_cd_prev		= @e61_ecl_bunrui_cd
			Set @e61_siire_cd_prev			= @e61_siire_cd
			Set @e61_siire_name_prev		= @e61_siire_name
			Set @e61_baika_tanka_first		= @e61_baika_tanka
		End
--		If @e61_ecl_shop_cd <> @e61_ecl_shop_cd_prev Begin
		If @e61_ecl_shop_cd <> @e61_ecl_shop_cd_prev Or @e61_data_date <> @e61_data_date_prev Begin	-- 2015/08/06 update
			Select
				@a_sql = ''
						+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur ( '
						+ '		 e61_edi_flag '
						+ '		,e61_edi_create_date '
						+ '		,e61_edi_update_date '
						+ '		,e61_edi_file_line_no '
						+ '		,e61_edi_meisai_no '
						+ '		,e61_edi_error_msg '
						+ '		,e61_server_webpos '
						+ '		,e61_dbname_webpos '
						+ '		,e61_shop_cd_webpos '
						+ '		,e61_shop_name_webpos '
						+ '		,e61_seq_no '
						+ '		,e61_shop_cd_primary '
						+ '		,e61_shop_cd '
						+ '		,e61_tushin_id '
						+ '		,e61_data_date '
						+ '		,e61_ecl_shop_cd '
						+ '		,e61_ecole_hinban '
						+ '		,e61_jan_cd '
						+ '		,e61_ecl_bunrui_cd '
						+ '		,e61_usr_bunrui_cd '
						+ '		,e61_usr_bunrui_name '
						+ '		,e61_siire_cd '
						+ '		,e61_siire_name '
						+ '		,e61_data_kbn '
						+ '		,e61_uriage_su '
						+ '		,e61_baika_tanka '
						+ '		,e61_uriage_kin '
						+ '	) VALUES ( ' 
						+ '		 0'
						+ '		,getdate() '
						+ '		,getdate() '
						+ '		,1 '
						+ '		,1 '
						+ '		,NULL '
						+ '		,' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
						+ '		,' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
						+ '		,''' + @e61_shop_cd_webpos_prev + ''''
						+ '		,''' + @e61_shop_name_webpos_prev + ''''
						+ '		,NULL '
						+ '		,''' + @e61_shop_cd_primary_prev + ''''
						+ '		,''' + @e61_shop_cd_prev + ''''
						+ '		,''' + @e61_tushin_id_prev + ''''
						+ '		,''' + @e61_data_date_prev + ''''
						+ '		,''' + @e61_ecl_shop_cd_prev + ''''
						+ '		,''' + @e61_ecole_hinban_prev + ''''
						+ '		,NULL'
						+ '		,NULL'
						+ '		,NULL '
						+ '		,NULL '
						+ '		,''' + @e61_siire_cd_prev + ''''
						+ '		,''' + @e61_siire_name_prev + ''''
						--+ '		,''0'' '						-- 2014/03/10 delete
						+ '		,''' + @e61_data_kbn_prev + ''''	-- 2014/03/10 add
						-- 2014-03-11 符号はなしでセットするように修正
						--+ '		,' + cast(@e61_uriage_su_total as varchar(1000))
						+ '		,' + cast( abs( @e61_uriage_su_total ) as varchar(1000)) 
						+ '		,' + cast(@e61_baika_tanka_first as varchar(1000))
						-- 2014-03-11 符号はなしでセットするように修正
						--+ '		,' + cast(@e61_uriage_kin_total as varchar(1000))
						+ '		,' + cast( abs( @e61_uriage_kin_total ) as varchar(1000)) 
						+ ')'
			  Exec (@a_sql)
			  -- エラーチェック
			  If @@ERROR <> 0 Begin
				Set @a_edi_flag = '3'  -- エラー
			  End
			
			Set @e61_ecl_shop_cd_prev		= @e61_ecl_shop_cd
			Set @e61_ecole_hinban_prev		= @e61_ecole_hinban
			Set @e61_shop_cd_webpos_prev	= @e61_shop_cd_webpos
			Set @e61_shop_name_webpos_prev	= @e61_shop_name_webpos
			Set @e61_shop_cd_primary_prev	= @e61_shop_cd_primary
			Set @e61_shop_cd_prev			= @e61_shop_cd
			Set @e61_tushin_id_prev			= @e61_tushin_id
			Set @e61_data_date_prev			= @e61_data_date
			Set @e61_jan_cd_prev			= @e61_jan_cd
			Set @e61_ecl_bunrui_cd_prev		= @e61_ecl_bunrui_cd
			Set @e61_siire_cd_prev			= @e61_siire_cd
			Set @e61_siire_name_prev		= @e61_siire_name
			
			Set @e61_uriage_su_total		= 0
			Set @e61_baika_tanka_first		= @e61_baika_tanka
			Set @e61_uriage_kin_total		= 0
		End
		
		Set @iCount = @iCount + 1
		-- 2014/03/10 add
		Set @e61_trn_work_type = ''
		Select @e61_trn_work_type = ISNULL(trn_work_type, '0000')
		From wpv_transaction
		Where trn_shop_cd = @e61_shop_cd_webpos And
			trn_denpyo_type = '0' And
			trn_create_date >= @jikko_date And
			trn_create_date < GETDATE() And
			trn_trn_id = @e61_edi_trn_id
		If @e61_trn_work_type = '0001' Begin
			Set @e61_uriage_su = (-1) * @e61_uriage_su
			Set @e61_uriage_kin = (-1) * @e61_uriage_kin
		End
		
		Set @e61_uriage_su_total = @e61_uriage_su_total + @e61_uriage_su
		Set @e61_uriage_kin_total = @e61_uriage_kin_total + @e61_uriage_kin
		
		-- 2014/03/10 add
--		If @e61_uriage_su_total < 0 Begin
		If @e61_uriage_kin_total < 0 Begin		-- 2015/08/06 update
			Set @e61_data_kbn_prev = '1'
		End
		Else Begin
			Set @e61_data_kbn_prev = '0'
		End
		
		-- 次へ
		fetch next from @rs into
			   @e61_shop_cd_webpos
              ,@e61_shop_name_webpos
              ,@e61_shop_cd_primary
              ,@e61_shop_cd
              ,@e61_tushin_id
              ,@e61_data_date
              ,@e61_ecl_shop_cd
              ,@e61_ecole_hinban
              ,@e61_uriage_su
              ,@e61_baika_tanka
              ,@e61_uriage_kin
              ,@e61_edi_trn_id
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  If @iCount > 0 Begin
	Select
		@a_sql = ''
				+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur ( '
				+ '		 e61_edi_flag '
				+ '		,e61_edi_create_date '
				+ '		,e61_edi_update_date '
				+ '		,e61_edi_file_line_no '
				+ '		,e61_edi_meisai_no '
				+ '		,e61_edi_error_msg '
				+ '		,e61_server_webpos '
				+ '		,e61_dbname_webpos '
				+ '		,e61_shop_cd_webpos '
				+ '		,e61_shop_name_webpos '
				+ '		,e61_seq_no '
				+ '		,e61_shop_cd_primary '
				+ '		,e61_shop_cd '
				+ '		,e61_tushin_id '
				+ '		,e61_data_date '
				+ '		,e61_ecl_shop_cd '
				+ '		,e61_ecole_hinban '
				+ '		,e61_jan_cd '
				+ '		,e61_ecl_bunrui_cd '
				+ '		,e61_usr_bunrui_cd '
				+ '		,e61_usr_bunrui_name '
				+ '		,e61_siire_cd '
				+ '		,e61_siire_name '
				+ '		,e61_data_kbn '
				+ '		,e61_uriage_su '
				+ '		,e61_baika_tanka '
				+ '		,e61_uriage_kin '
				+ '	) VALUES ( ' 
				+ '		 0'
				+ '		,getdate() '
				+ '		,getdate() '
				+ '		,1 '
				+ '		,1 '
				+ '		,NULL '
				+ '		,' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
				+ '		,' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
				+ '		,''' + @e61_shop_cd_webpos_prev + ''''
				+ '		,''' + @e61_shop_name_webpos_prev + ''''
				+ '		,NULL '
				+ '		,''' + @e61_shop_cd_primary_prev + ''''
				+ '		,''' + @e61_shop_cd_prev + ''''
				+ '		,''' + @e61_tushin_id_prev + ''''
				+ '		,''' + @e61_data_date_prev + ''''
				+ '		,''' + @e61_ecl_shop_cd_prev + ''''
				+ '		,''' + @e61_ecole_hinban_prev + ''''
				+ '		,NULL'
				+ '		,NULL'
				+ '		,NULL '
				+ '		,NULL '
				+ '		,''' + @e61_siire_cd_prev + ''''
				+ '		,''' + @e61_siire_name_prev + ''''
				--+ '		,''0'' '						-- 2014/03/10 delete
				+ '		,''' + @e61_data_kbn_prev + ''''	-- 2014/03/10 add
				-- 2014-03-11 符号はなしでセットするように修正
				--+ '		,' + cast(@e61_uriage_su_total as varchar(1000))
				+ '		,' + cast( abs( @e61_uriage_su_total ) as varchar(1000)) 
				+ '		,' + cast(@e61_baika_tanka_first as varchar(1000))
				-- 2014-03-11 符号はなしでセットするように修正
				--+ '		,' + cast(@e61_uriage_kin_total as varchar(1000))
				+ '		,' + cast( abs( @e61_uriage_kin_total ) as varchar(1000)) 
				+ ')'
	  Exec (@a_sql)
	  -- エラーチェック
	  If @@ERROR <> 0 Begin
		Set @a_edi_flag = '3'  -- エラー
	  End
  End
  
  -- 2014/02/22 add
  --【エコールEDI作成管理マスタ】テーブルのデータを更新する。
  Update wpt_ecole_edi_kanri_master
  --Set eek_jikkou_date = Convert(varchar,getdate(),120)	-- 2014/02/25 modify
  Set eek_jikkou_date = Convert(varchar,@temp_getdate_61u,111) + ' ' + SubString(Convert(varchar,@temp_getdate_61u,114),1,8)
  Where eek_kaisei_id = '61U'
  
  -- 2014/02/25 Delete
 -- -- 売上数と売上金額を更新する。
 -- Select
	--@a_sql = ''
	--	+ ' UPDATE ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur'
	--	+ '	SET	 OriTb.e61_uriage_su = TempTb.e61_uriage_su_total '
	--	+ '		,OriTb.e61_uriage_kin = TempTb.e61_uriage_kin_total '
	--	+ ' FROM ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur AS OriTb'
	--	+ '	INNER JOIN	(SELECT '
	--	+ '					e61_ecl_shop_cd '
	--	+ '					,e61_ecole_hinban '
	--	+ '					,SUM(e61_uriage_su) AS e61_uriage_su_total '
	--	+ '					,SUM(e61_uriage_kin) AS e61_uriage_kin_total '
	--	+ '				FROM ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_eur '
	--	+ '				WHERE '
	--	+ '					e61_edi_flag = ''0'' '
	--	+ '				GROUP BY '
	--	+ '					e61_ecl_shop_cd '
	--	+ '					,e61_ecole_hinban) TempTb '
	--	+ ' ON '
	--	+ '		OriTb.e61_edi_flag = ''0'' AND '
	--	+ '		OriTb.e61_ecl_shop_cd = TempTb.e61_ecl_shop_cd AND '
	--	+ '		OriTb.e61_ecole_hinban = TempTb.e61_ecole_hinban'

 -- Exec (@a_sql)
 -- -- エラーチェック
 -- If @@ERROR <> 0 Begin
	--Set @a_edi_flag = '3'  -- エラー
 -- End
  
  -- カウント初期レコードセット
  INSERT INTO #count_tbl (
	 t_exec_id
	,t_tushin_id
	,t_count_all
	,t_count_ok
	,t_count_wa
	,t_count_ng
  )
  SELECT
	 t_exec_id = substring(@edi_type,1,2)
	,t_tushin_id = e10_edi_tushin_id
	,t_count_all = count(*)
	,t_count_ok =
		Case
			when @a_edi_flag = '1' then count(*)
			else 0
		End
	,t_count_wa =
		Case
			when @a_edi_flag = '2' then count(*)
			else 0
		End
	,t_count_ng =
		Case
			when @a_edi_flag = '3' then count(*)
			else 0
		End
  FROM
-- 2014-04-15 エコール売上は別コントロールテーブルに変更		
--	wbe_edibook_up_control
	wbe_edibook_up_control_ecole
	join wpt_transaction_uriage_details on
		e10_edi_trn_id = tdu_trn_id and
		e10_edi_line_no = tdu_line_no
    join wpt_transaction on
		tdu_trn_id = trn_trn_id
	join wpt_transaction_uriage on
		trn_trn_id = tur_trn_id
  WHERE
	e10_edi_flag = '0'  -- 未処理のみ
  Group By
	e10_edi_tushin_id
	
  -- 処理結果記録
-- 2014-04-15 エコール売上は別コントロールテーブルに変更		
--  UPDATE wbe_edibook_up_control 
  UPDATE wbe_edibook_up_control_ecole 
  SET e10_edi_flag = @a_edi_flag
  FROM
-- 2014-04-15 エコール売上は別コントロールテーブルに変更		
--	wbe_edibook_up_control
	wbe_edibook_up_control_ecole
	join wpt_transaction_uriage_details on
		e10_edi_trn_id = tdu_trn_id and
		e10_edi_line_no = tdu_line_no
	join wpt_transaction on
		tdu_trn_id = trn_trn_id
	join wpt_transaction_uriage on
		trn_trn_id = tur_trn_id
  where 
	e10_edi_flag = '0'   -- 未処理のみ

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9073,売上ログ出力エラー'

    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     t_tushin_id as tushin_id
    ,t_count_all as count_all
    ,t_count_ok as count_ok
    ,t_count_wa as count_wa
    ,t_count_ng as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK
  
UP_URIAGE_DATA_END:


-- ▼▼▼ 2014/01/28 add
--=================================================
-- 【JEUGIA基幹連動】上り売上処理
--=================================================
UP_JEUGIA_URIAGE:
	Declare @e62_edi_flag char (1)
	Declare @e62_edi_timestamp timestamp
	Declare @e62_edi_create_date datetime 
	Declare @e62_edi_update_date datetime 
	Declare @e62_edi_file_line_no int 
	Declare @e62_edi_meisai_no int 
	Declare @e62_edi_error_msg varchar (200)
	Declare @e62_server_webpos varchar (100)
	Declare @e62_dbname_webpos varchar (100)

	Declare @e62_tushin_id			char(2)
	Declare @e62_shop_cd_webpos		int
	Declare @e62_shop_name_webpos	varchar(100)
	Declare @e62_shop_cd_edi		varchar(10)
	Declare @e62_trn_date			varchar(10)
	Declare @e62_pos_no				int

	Declare @e62_insert_count		int
	Set @e62_insert_count = 0

	Declare @e62_zenkai_dateteme	datetime
	Declare @e62_konkai_dateteme	datetime
	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9091,JEUGIA売上削除不正'
		GOTO SP_ERR
	End

	------------------------------
	-- 上り対象店舗を抽出
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_jga_flag =
		Case
			When @edi_type = '62U' Then '1'
			Else bes_up_jga_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 前回処理時間を取得
		select
			top 1
			@e62_zenkai_dateteme = tct_trn_date
		from
			wbe_topculture_control with(nolock)
		where
			tct_tushin_id = @a_tushin_id
			and
			tct_edi_type = @edi_type
			and
			tct_shop_cd = @a_shop_cd
		order by
			tct_id desc
		-- 初回（前回処理時間がない場合）は、現在日時の2日前とする
		If @e62_zenkai_dateteme is null Begin
			Set @e62_zenkai_dateteme = Dateadd(day,-2,getdate())
		End
		-- 今回処理日時をセット
		Set @e62_konkai_dateteme = getdate()

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_jur ( '
			+ '	 e62_edi_flag '
			+ '	,e62_server_webpos '
			+ '	,e62_dbname_webpos '
			+ '	,e62_shop_cd_webpos '
			+ '	,e62_shop_name_webpos '
			+ '	,e62_shop_cd_primary '
			+ '	,e62_shop_cd '
			+ '	,e62_tushin_id '

			+ '	,e62_sikibetu_cd '
			+ '	,e62_denpyo_type '
			+ '	,e62_seq_no '
			+ '	,e62_denpyo_date '
			+ '	,e62_denpyo_no '
			+ '	,e62_line_no '
			+ '	,e62_goods_code '

			+ '	,e62_uriage_count_sign '
			+ '	,e62_uriage_count '
			+ '	,e62_urihen_count_sign '
			+ '	,e62_urihen_count '
			+ '	,e62_uriage_total_count_sign '
			+ '	,e62_uriage_total_count '

			+ '	,e62_uriage_price_sign '
			+ '	,e62_uriage_price '
			+ '	,e62_urihen_price_sign '
			+ '	,e62_urihen_price '
			+ '	,e62_uriage_sum_price_sign '
			+ '	,e62_uriage_sum_price '

			+ '	,e62_nebiki_price_sign '
			+ '	,e62_nebiki_price '
			+ '	,e62_uriage_total_price_sign '
			+ '	,e62_uriage_total_price '

		+ ' )   '
		+ ' SELECT '
			+ '	 e62_edi_flag = ''0'' '          -- 未処理
			+ '	,e62_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e62_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e62_shop_cd_webpos = ' + Cast(@a_shop_cd AS varchar)
			+ '	,e62_shop_name_webpos = ' + '''' + Cast(@a_shop_name AS varchar) + ''''
			+ '	,e62_shop_cd_primary = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e62_shop_cd = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e62_tushin_id = ' + '''' + Cast(@a_tushin_id AS varchar) + ''''

			+ '	,e62_sikibetu_cd = ' + '''' + 'UR' + ''''
			+ '	,e62_denpyo_type = ' + '''' + '11' + ''''
			+ '	,e62_seq_no = Right(''000000000'' + Convert(varchar,t_trn_id), 9) '
			+ '	,e62_denpyo_date = Convert(varchar,t_create_date,112) '
			+ '	,e62_denpyo_no = Right(''0000000000'' + Convert(varchar,t_receipt_no), 10) '
			+ '	,e62_line_no = Right(''000'' + Convert(varchar,t_line_no), 3) '
			+ '	,e62_goods_code = Case When IsNull(jmc_jeugia_media_cd,'''') = '''' Then ''41000'' Else jmc_jeugia_media_cd End '

			+ '	,e62_uriage_count_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e62_uriage_count = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then t_selling_count '
					+ ' else 0 '
				+ ' end '
			+ '	,e62_urihen_count_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e62_urihen_count = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then 0 '
					+ ' else t_selling_count '
				+ ' end '
			+ '	,e62_uriage_total_count_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e62_uriage_total_count = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then t_selling_count '
					+ ' else t_selling_count '
				+ ' end '

			+ '	,e62_uriage_price_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e62_uriage_price = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then '
						+ ' '
							+ ' t_saisyu_baika_notax '
							+ ' + ( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax )))  '
							+ ' - floor( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax ))) / (100 + t_tax_rate) * t_tax_rate ) ) '
						+ ' '
					+ ' else 0 '
				+ ' end '

			+ '	,e62_urihen_price_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e62_urihen_price = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then 0 '
					+ ' else '
						+ ' '
							+ ' t_saisyu_baika_notax '
							+ ' + ( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax )))  '
							+ ' - floor( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax ))) / (100 + t_tax_rate) * t_tax_rate ) ) '
						+ ' '
				+ ' end '

			+ '	,e62_uriage_sum_price_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e62_uriage_sum_price = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then '
						+ ' '
							+ ' t_saisyu_baika_notax '
							+ ' + ( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax )))  '
							+ ' - floor( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax ))) / (100 + t_tax_rate) * t_tax_rate ) ) '
						+ ' '
					+ ' else '
						+ ' '
							+ ' t_saisyu_baika_notax '
							+ ' + ( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax )))  '
							+ ' - floor( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax ))) / (100 + t_tax_rate) * t_tax_rate ) ) '
						+ ' '
				+ ' end '
-- ▼▼▼ 2014/02/12 update
--			+ '	,e62_nebiki_price_sign = ''-'' '
			+ '	,e62_nebiki_price_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''-'' '
					+ ' else ''+'' '
				+ ' end '
-- ▲▲▲ 2014/02/12 update
			+ '	,e62_nebiki_price = '
				+ '	(t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax ))) '
				+ ' - floor( (t_tanpin_nebiki_intax + (t_nebikimae_intax - ( t_saisyu_baika_notax + t_saisyu_baika_tax ))) / (100 + t_tax_rate) * t_tax_rate ) '
				+ ' '
			+ '	,e62_uriage_total_price_sign = '
				+ ' case '
					+ ' when t_work_type = ''0000'' then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e62_uriage_total_price = t_saisyu_baika_notax '

			+ ' from ( '

				+ ' select '
					+ ' trn_trn_id as t_trn_id '
					+ ',trn_create_date as t_create_date '
					+ ',trn_receipt_no as t_receipt_no '
					+ ',trn_work_type as t_work_type '
					+ ',tdu_line_no as t_line_no '
					+ ',tdu_media_cd as t_media_cd '
					+ ',tdu_selling_count as t_selling_count '
					+ ',tdu_tax_rate as t_tax_rate '
					+ ',case tdu_tax_type '
			-- 0:外税の場合
						+ '	when ''0'' then '
							+ '	tdu_unit_price + '
							+ '	case tdu_tax_rate_type '
								+ '	when ''0'' then Floor( tdu_unit_price * (tdu_tax_rate / 100) ) '
								+ '	when ''1'' then Cast( Round( tdu_unit_price * (tdu_tax_rate / 100), 0 ) AS Int ) '
								+ '	when ''2'' then Ceiling( tdu_unit_price * (tdu_tax_rate / 100) ) '
							+ '	end '
			-- 1:内税の場合
						+ '	when ''1'' then '
							+ '	tdu_unit_price '
			-- 2:非課税の場合
						+ '	when ''2'' then '
							+ '	tdu_unit_price '
					+ '	end t_nebikimae_intax '
					+ '	,tdu_unit_discount_price as  t_tanpin_nebiki_intax '
					+ '	,tdu_selling_price + tdu_tax_price	as t_saisyu_baika_intax '
					+ '	,tdu_selling_price					as t_saisyu_baika_notax '
					+ '	,tdu_tax_price						as t_saisyu_baika_tax '

				+ '	from wpt_transaction with(nolock) '
				+ '	join wpt_transaction_uriage with(nolock) '
					+ '	on trn_trn_id = tur_trn_id '
				+ '	join wpt_transaction_uriage_details with(nolock) '
					+ '	on trn_trn_id = tdu_trn_id '
				+ '	where trn_shop_cd = ' + Cast(@a_shop_cd AS varchar) + ' '
					+ '	and trn_create_date >= ' + '''' + Convert(varchar,@e62_zenkai_dateteme,111) + ' ' + Convert(varchar,@e62_zenkai_dateteme,114) + ''''
					+ '	and trn_create_date < ' + '''' + Convert(varchar,@e62_konkai_dateteme,111) + ' ' + Convert(varchar,@e62_konkai_dateteme,114) + ''''
				+ '	) as main '
-- JEUGIA商品コード変換
			+ '	left outer join wpt_jeugia_media_convert with(nolock) '
				+ '	on jmc_media_cd = t_media_cd '
			--+ '	group by '
			--	+ '	t_trn_id '
			--	+ '	,t_create_date '
			--	+ '	,t_receipt_no '
			--	+ '	,t_work_type '
			--	+ '	,Case When IsNull(jmc_jeugia_media_cd,'''') = '''' Then ''41000'' Else jmc_jeugia_media_cd End '
			+ '	order by '
				+ '	t_trn_id '
				+ '	,t_create_date '
				+ '	,t_receipt_no '
				+ '	,t_line_no '
				+ '	,t_work_type '
				+ '	,Case When IsNull(jmc_jeugia_media_cd,'''') = '''' Then ''41000'' Else jmc_jeugia_media_cd End '

--select @a_shop_cd		,@e62_zenkai_dateteme
--select @a_sql
--goto sp_ok

		Exec (@a_sql)
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

		-- 追加件数カウント
		Set @e62_insert_count = @e62_insert_count + 1

		-- エラーでなければ、上り制御データに追加
		If @a_edi_flag <> '3' Begin
			Insert Into wbe_topculture_control
				( tct_tushin_id, tct_edi_type, tct_shop_cd, tct_trn_date, tct_pos_no )
			Values
				( @a_tushin_id, @edi_type, @a_shop_cd, @e62_konkai_dateteme, 0 )
		End

		-- カウント初期レコードセット
		INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
		)
		SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @a_tushin_id
			,t_count_all = @e62_insert_count
			,t_count_ok = @e62_insert_count
			,t_count_wa = 0
			,t_count_ng = 0

		-- 次へ
		Fetch Next From @rs Into
			 @a_tushin_id
			,@a_book_shop_cd
			,@a_shop_cd
			,@a_shop_name
	End  -- While

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs


	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl


  --終了
  GOTO SP_OK

UP_JEUGIA_URIAGE_END:

--=================================================
-- 【JEUGIA基幹連動】上り仕入処理
--=================================================
UP_JEUGIA_SIIRE:
	Declare @e63_edi_flag char (1)
	Declare @e63_edi_timestamp timestamp
	Declare @e63_edi_create_date datetime 
	Declare @e63_edi_update_date datetime 
	Declare @e63_edi_file_line_no int 
	Declare @e63_edi_meisai_no int 
	Declare @e63_edi_error_msg varchar (200)
	Declare @e63_server_webpos varchar (100)
	Declare @e63_dbname_webpos varchar (100)

	Declare @e63_tushin_id			char(2)
	Declare @e63_shop_cd_webpos		int
	Declare @e63_shop_name_webpos	varchar(100)
	Declare @e63_shop_cd_edi		varchar(10)
	Declare @e63_trn_date			varchar(10)
	Declare @e63_pos_no				int

	Declare @e63_insert_count		int
	Set @e63_insert_count = 0

	Declare @e63_zenkai_dateteme	datetime
	Declare @e63_konkai_dateteme	datetime
	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9091,JEUGIA仕入削除不正'
		GOTO SP_ERR
	End

	------------------------------
	-- 上り対象店舗を抽出
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_jga_flag =
		Case
			When @edi_type = '63U' Then '1'
			Else bes_up_jga_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 前回処理時間を取得
		select
			top 1
			@e63_zenkai_dateteme = tct_trn_date
		from
			wbe_topculture_control with(nolock)
		where
			tct_tushin_id = @a_tushin_id
			and
			tct_edi_type = @edi_type
			and
			tct_shop_cd = @a_shop_cd
		order by
			tct_id desc
		-- 初回（前回処理時間がない場合）は、現在日時の2日前とする
		If @e63_zenkai_dateteme is null Begin
			Set @e63_zenkai_dateteme = Dateadd(day,-2,getdate())
		End
		-- 今回処理日時をセット
		Set @e63_konkai_dateteme = getdate()

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_jsr ( '
			+ '	 e63_edi_flag '
			+ '	,e63_server_webpos '
			+ '	,e63_dbname_webpos '
			+ '	,e63_shop_cd_webpos '
			+ '	,e63_shop_name_webpos '
			+ '	,e63_shop_cd_primary '
			+ '	,e63_shop_cd '
			+ '	,e63_tushin_id '

			+ '	,e63_sikibetu_cd '
			+ '	,e63_denpyo_type '
			+ '	,e63_seq_no '
			+ '	,e63_denpyo_date '
			+ '	,e63_denpyo_no '

			+ '	,e63_kensyu_date '
			+ '	,e63_siire_cd '
			+ '	,e63_goods_code '

			+ '	,e63_siire_count_sign '
			+ '	,e63_siire_count '
			+ '	,e63_henpin_count_sign '
			+ '	,e63_henpin_count '
			+ '	,e63_siire_total_count_sign '
			+ '	,e63_siire_total_count '

			+ '	,e63_siire_price_sign '
			+ '	,e63_siire_price '
			+ '	,e63_henpin_price_sign '
			+ '	,e63_henpin_price '
			+ '	,e63_siire_total_price_sign '
			+ '	,e63_siire_total_price '

			+ '	,e63_siire_cost_price_sign '
			+ '	,e63_siire_cost_price '
			+ '	,e63_henpin_cost_price_sign '
			+ '	,e63_henpin_cost_price '
			+ '	,e63_siire_total_cost_price_sign '
			+ '	,e63_siire_total_cost_price '

			+ '	,e63_price '
			+ '	,e63_cost_price '

		+ ' )   '
		+ ' SELECT '
			+ '	 e63_edi_flag = ''0'' '          -- 未処理
			+ '	,e63_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e63_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e63_shop_cd_webpos = ' + Cast(@a_shop_cd AS varchar)
			+ '	,e63_shop_name_webpos = ' + '''' + Cast(@a_shop_name AS varchar) + ''''
			+ '	,e63_shop_cd_primary = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e63_shop_cd = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e63_tushin_id = ' + '''' + Cast(@a_tushin_id AS varchar) + ''''

			+ '	,e63_sikibetu_cd = ' + '''' + 'SI' + ''''
			+ '	,e63_denpyo_type = Case When trn_work_type in (''0210'') Then ''22'' Else ''24'' End '
			+ '	,e63_seq_no = Right(''000000000'' + Convert(varchar,trn_trn_id), 9) '
			+ '	,e63_denpyo_date = Convert(varchar,tso_denpyo_date,112) '
			+ '	,e63_denpyo_no = Right(''00000000'' + Convert(varchar,trn_receipt_no), 8) '

			+ '	,e63_kensyu_date = Convert(varchar,trn_create_date,112) '
			+ '	,e63_siire_cd = Case When trn_work_type in (''0210'',''0214'') Then wcm_jeugia_siire_cd Else jhc_jeugia_henpin_cd End '
			+ '	,e63_goods_code = Case When IsNull(jmc_jeugia_media_cd,'''') = '''' Then ''41000'' Else jmc_jeugia_media_cd End '

			+ '	,e63_siire_count_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0210'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' ''+'' '
				+ ' end '
			+ '	,e63_siire_count = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0210'') Then tod_goods_count '
						+ ' Else 0 '
					+ ' End '
				+ ' '
			+ '	,e63_henpin_count_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0232'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
					+ ' else '
						+ ' ''+'' '
				+ ' end '
			+ '	,e63_henpin_count = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0232'') Then tod_goods_count '
						+ ' Else 0 '
					+ ' End '
				+ ' '
			+ '	,e63_siire_total_count_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0210'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
				+ ' end '
			+ '	,e63_siire_total_count = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0210'') Then tod_goods_count '
						+ ' Else tod_goods_count '
					+ ' End '
				+ ' '

			+ '	,e63_siire_price_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0210'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' ''+'' '
				+ ' end '
			+ '	,e63_siire_price = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0210'') Then tod_price_default * tod_goods_count '
						+ ' Else 0 '
					+ ' End '
				+ ' '
			+ '	,e63_henpin_price_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0232'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
					+ ' else '
						+ ' ''+'' '
				+ ' end '
			+ '	,e63_henpin_price = '
				+  '  '
					+ ' Case '
						+ ' When trn_work_type in (''0232'') Then tod_price_default * tod_goods_count '
						+ ' Else 0 '
					+ ' End '
				+ ' '
			+ '	,e63_siire_total_price_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0210'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
				+ ' end '
			+ '	,e63_siire_total_price = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0210'') Then tod_price_default * tod_goods_count '
						+ ' Else tod_price_default * tod_goods_count '
					+ ' End '
				+ ' '

			+ '	,e63_siire_cost_price_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0210'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' ''+'' '
				+ ' end '
			+ '	,e63_siire_cost_price = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0210'') Then tod_cost_price * tod_goods_count '
						+ ' Else 0 '
					+ ' End '
				+ ' '
			+ '	,e63_henpin_cost_price_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0232'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
					+ ' else '
						+ ' ''+'' '
				+ ' end '
			+ '	,e63_henpin_cost_price = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0232'') Then tod_cost_price * tod_goods_count '
						+ ' Else 0 '
					+ ' End '
				+ ' '
			+ '	,e63_siire_total_cost_price_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0210'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
				+ ' end '
			+ '	,e63_siire_total_cost_price = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0210'') Then tod_cost_price * tod_goods_count '
						+ ' Else tod_cost_price * tod_goods_count '
					+ ' End '
				+ ' '

			+ '	,e63_price = '
				+ ' '
-- ▼▼▼ 2014/02/12 update
--					+ ' tod_price_default '
					+ ' case '
						+ ' when tod_price_default > 0 then tod_price_default '
						+ ' else '
							+ ' case '
								+ ' when plu_price_type = ''1'' then plu_gds_price - (plu_gds_price / ( 100 + sm1_tax_rate ) * sm1_tax_rate ) '
								+ ' else plu_gds_price '
							+ ' end '
					+ ' end '
-- ▲▲▲ 2014/02/12 update
				+ ' '
			+ '	,e63_cost_price = '
				+ ' '
					+ ' tod_cost_price '
				+ ' '

		+ ' from wpt_transaction with(nolock) '
		+ ' join wpt_transaction_inout with(nolock) '
			+ ' on trn_trn_id = tso_trn_id '
		+ ' join wpt_transaction_inout_details with(nolock) '
			+ ' on trn_trn_id = tod_trn_id '

		+ ' left outer join wpt_goods_master_disk with(nolock) '
			+ ' on tod_goods_id = gdd_goods_id '
		+ ' left outer join wpt_shop_goods_master with(nolock) '
			+ ' on tod_goods_id = sgd_goods_id '
			+ ' and (sgd_shop_cd = trn_shop_cd or sgd_shop_cd = 0) '
			+ ' and sgd_delete_flag = ''0'' '
		+ ' left outer join wpt_shop_goods_master_disk with(nolock) '
			+ ' on sgd_goods_id = sdd_goods_id '
			+ ' and sgd_franchise_id = sdd_franchise_id '
			+ ' and sgd_shop_cd = sdd_shop_cd '
		+ ' left outer join wpt_maker_label_master with(nolock) '
			+ ' on mlm_label_cd = isnull(sdd_label_cd,gdd_label_cd) '
-- JEUGIA商品コード変換
		+ ' left join wpt_jeugia_media_convert with(nolock) '
			+ ' on jmc_media_cd = tod_media_cd '
-- 入庫データ
		+ ' left outer join wpt_document_nyuko with(nolock) '
			+ ' on tso_doc_id = dnk_doc_id '
-- JEUGIA仕入先コード変換
		+ ' left join wpt_wint_company_master with(nolock) '
			+ ' on wcm_company_cd = substring(isnull(dnk_dist_cd,''''),2,2) '
-- JEUGIA返品先コード変換
		+ ' left join wpt_jeugia_henpin_convert with(nolock) '
			+ ' on jhc_sales_cd = isnull(mlm_sales_cd,'''') '
-- ▼▼▼ 2014/02/12 add
		+ ' join wpv_plu with(nolock) '
			+ ' on plu_shop_cd = trn_shop_cd '
			+ ' and plu_goods_id = tod_goods_id '
		+ ' join wpt_system_master with(nolock) '
			+ ' on 1 = 1 '
-- ▲▲▲ 2014/02/12 add
		+ ' where '
			+ ' trn_work_type in (''0210'',''0232'') '
			+ ' and trn_shop_cd = ' + Cast(@a_shop_cd AS varchar) + ' '
			+ ' and trn_create_date >= ' + '''' + Convert(varchar,@e63_zenkai_dateteme,111) + ' ' + Convert(varchar,@e63_zenkai_dateteme,114) + ''''
			+ ' and trn_create_date < ' + '''' + Convert(varchar,@e63_konkai_dateteme,111) + ' ' + Convert(varchar,@e63_konkai_dateteme,114) + ''''
		-- 2014/02/12 add
			+ ' and tod_goods_count <> 0 '

		+ ' order by '
			+ '  trn_work_type '
			+ ' ,trn_trn_id '
			+ ' ,trn_denpyo_type '
			+ ' ,trn_create_date '
			+ ' ,trn_receipt_no '
			+ ' ,tso_denpyo_date '
			+ ' ,tso_denpyo '
			+ ' ,tod_line_no '
			+ ' ,jmc_jeugia_media_cd '

--select @a_shop_cd		,@e63_zenkai_dateteme
--select @a_sql
--goto sp_ok

		Exec (@a_sql)
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

		-- 追加件数カウント
		Set @e63_insert_count = @e63_insert_count + 1

		-- エラーでなければ、上り制御データに追加
		If @a_edi_flag <> '3' Begin
			Insert Into wbe_topculture_control
				( tct_tushin_id, tct_edi_type, tct_shop_cd, tct_trn_date, tct_pos_no )
			Values
				( @a_tushin_id, @edi_type, @a_shop_cd, @e63_konkai_dateteme, 0 )
		End

		-- カウント初期レコードセット
		INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
		)
		SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @a_tushin_id
			,t_count_all = @e63_insert_count
			,t_count_ok = @e63_insert_count
			,t_count_wa = 0
			,t_count_ng = 0

		-- 次へ
		Fetch Next From @rs Into
			 @a_tushin_id
			,@a_book_shop_cd
			,@a_shop_cd
			,@a_shop_name
	End  -- While

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs


	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl


  --終了
  GOTO SP_OK

UP_JEUGIA_SIIRE_END:

--=================================================
-- 【JEUGIA基幹連動】上り移動処理
--  ※移動出庫データのみ抽出
--=================================================
UP_JEUGIA_IDO:
	Declare @e64_edi_flag char (1)
	Declare @e64_edi_timestamp timestamp
	Declare @e64_edi_create_date datetime 
	Declare @e64_edi_update_date datetime 
	Declare @e64_edi_file_line_no int 
	Declare @e64_edi_meisai_no int 
	Declare @e64_edi_error_msg varchar (200)
	Declare @e64_server_webpos varchar (100)
	Declare @e64_dbname_webpos varchar (100)

	Declare @e64_tushin_id			char(2)
	Declare @e64_shop_cd_webpos		int
	Declare @e64_shop_name_webpos	varchar(100)
	Declare @e64_shop_cd_edi		varchar(10)
	Declare @e64_trn_date			varchar(10)
	Declare @e64_pos_no				int

	Declare @e64_insert_count		int
	Set @e64_insert_count = 0

	Declare @e64_zenkai_dateteme	datetime
	Declare @e64_konkai_dateteme	datetime
	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9091,JEUGIA移動削除不正'
		GOTO SP_ERR
	End

	------------------------------
	-- 上り対象店舗を抽出
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_jga_flag =
		Case
			When @edi_type = '64U' Then '1'
			Else bes_up_jga_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 前回処理時間を取得
		select
			top 1
			@e64_zenkai_dateteme = tct_trn_date
		from
			wbe_topculture_control with(nolock)
		where
			tct_tushin_id = @a_tushin_id
			and
			tct_edi_type = @edi_type
			and
			tct_shop_cd = @a_shop_cd
		order by
			tct_id desc
		-- 初回（前回処理時間がない場合）は、現在日時の2日前とする
		If @e64_zenkai_dateteme is null Begin
			Set @e64_zenkai_dateteme = Dateadd(day,-2,getdate())
		End
		-- 今回処理日時をセット
		Set @e64_konkai_dateteme = getdate()

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_jid ( '
			+ '	 e64_edi_flag '
			+ '	,e64_server_webpos '
			+ '	,e64_dbname_webpos '
			+ '	,e64_shop_cd_webpos '
			+ '	,e64_shop_name_webpos '
			+ '	,e64_shop_cd_primary '
			+ '	,e64_shop_cd '
			+ '	,e64_tushin_id '

			+ '	,e64_sikibetu_cd '
			+ '	,e64_denpyo_type '
			+ '	,e64_seq_no '
			+ '	,e64_denpyo_date '

			+ '	,e64_ido_moto_shop_cd '
			+ '	,e64_ido_ato_shop_cd '
			+ '	,e64_goods_code '

			+ '	,e64_ido_count_sign '
			+ '	,e64_ido_count '
			+ '	,e64_ido_price '
			+ '	,e64_ido_total_price_sign '
			+ '	,e64_ido_total_price '

		+ ' )   '
		+ ' SELECT '
			+ '	 e64_edi_flag = ''0'' '          -- 未処理
			+ '	,e64_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e64_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e64_shop_cd_webpos = ' + Cast(@a_shop_cd AS varchar)
			+ '	,e64_shop_name_webpos = ' + '''' + Cast(@a_shop_name AS varchar) + ''''
			+ '	,e64_shop_cd_primary = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e64_shop_cd = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e64_tushin_id = ' + '''' + Cast(@a_tushin_id AS varchar) + ''''

			+ '	,e64_sikibetu_cd = ' + '''' + 'ID' + ''''
			+ '	,e64_denpyo_type = Case When trn_work_type in (''0235'') Then ''31'' Else ''32'' End '
			+ '	,e64_seq_no = Right(''000000000'' + Convert(varchar,trn_trn_id), 9) '
			+ '	,e64_denpyo_date = Convert(varchar,trn_create_date,112) '

			+ '	,e64_ido_moto_shop_cd = Cast(trn_shop.jsc_jeugia_shop_cd AS varchar) '
			+ '	,e64_ido_ato_shop_cd = Cast(move_shop.jsc_jeugia_shop_cd AS varchar) '
			+ '	,e64_goods_code = Case When IsNull(jmc_jeugia_media_cd,'''') = '''' Then ''41000'' Else jmc_jeugia_media_cd End '

			+ '	,e64_ido_count_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0215'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
				+ ' end '
			+ '	,e64_ido_count = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0215'') Then tod_goods_count '
						+ ' Else tod_goods_count '
					+ ' End '
				+ ' '
			+ '	,e64_ido_price = '
				+  ' '
					+ ' tod_price_default '
				+ ' '
			+ '	,e64_ido_total_price_sign = '
				+ ' case '
					+ ' when trn_work_type in (''0215'') then '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''+'' '
							+ ' Else ''-'' '
						+ ' End '
					+ ' else '
						+ ' Case '
							+ ' When trn_denpyo_type = ''0'' Then ''-'' '
							+ ' Else ''+'' '
						+ ' End '
				+ ' end '
			+ '	,e64_ido_total_price = '
				+  ' '
					+ ' Case '
						+ ' When trn_work_type in (''0215'') Then tod_price_default * tod_goods_count '
						+ ' Else tod_price_default * tod_goods_count '
					+ ' End '
				+ ' '

		+ ' from wpt_transaction with(nolock) '
		+ ' join wpt_transaction_inout with(nolock) '
			+ ' on trn_trn_id = tso_trn_id '
		+ ' join wpt_transaction_inout_details with(nolock) '
			+ ' on trn_trn_id = tod_trn_id '
-- JEUGIA商品コード変換
		+ ' left join wpt_jeugia_media_convert with(nolock) '
			+ ' on jmc_media_cd = tod_media_cd '
-- JEUGIA店舗コード変換「移動出庫元店舗」
		+ ' left join wpt_jeugia_shop_convert as trn_shop with(nolock) '
			+ ' on trn_shop.jsc_shop_cd = trn_shop_cd '
-- JEUGIA店舗コード変換「移動出庫先店舗」
		+ ' left join wpt_jeugia_shop_convert as move_shop with(nolock) '
			+ ' on move_shop.jsc_shop_cd = tso_move_shop_cd '
		+ ' where '
			+ ' trn_work_type in (''0235'') '
			+ ' and trn_shop_cd = ' + Cast(@a_shop_cd AS varchar) + ' '
			+ ' and trn_create_date >= ' + '''' + Convert(varchar,@e64_zenkai_dateteme,111) + ' ' + Convert(varchar,@e64_zenkai_dateteme,114) + ''''
			+ ' and trn_create_date < ' + '''' + Convert(varchar,@e64_konkai_dateteme,111) + ' ' + Convert(varchar,@e64_konkai_dateteme,114) + ''''
		-- 2014/02/12 add
			+ ' and tod_goods_count <> 0 '

		+ ' order by '
			+ '  trn_work_type '
			+ ' ,trn_trn_id '
			+ ' ,trn_denpyo_type '
			+ ' ,trn_create_date '
			+ ' ,trn_receipt_no '
			+ ' ,tso_denpyo_date '
			+ ' ,tso_denpyo '
			+ ' ,jmc_jeugia_media_cd '

--select @a_shop_cd		,@e64_zenkai_dateteme
--select @a_sql
--goto sp_ok

		Exec (@a_sql)
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

		-- 追加件数カウント
		Set @e64_insert_count = @e64_insert_count + 1

		-- エラーでなければ、上り制御データに追加
		If @a_edi_flag <> '3' Begin
			Insert Into wbe_topculture_control
				( tct_tushin_id, tct_edi_type, tct_shop_cd, tct_trn_date, tct_pos_no )
			Values
				( @a_tushin_id, @edi_type, @a_shop_cd, @e64_konkai_dateteme, 0 )
		End

		-- カウント初期レコードセット
		INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
		)
		SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @a_tushin_id
			,t_count_all = @e64_insert_count
			,t_count_ok = @e64_insert_count
			,t_count_wa = 0
			,t_count_ng = 0

		-- 次へ
		Fetch Next From @rs Into
			 @a_tushin_id
			,@a_book_shop_cd
			,@a_shop_cd
			,@a_shop_name
	End  -- While

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs


	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl


  --終了
  GOTO SP_OK

UP_JEUGIA_IDO_END:

--=================================================
-- 【JEUGIA基幹連動】上り棚卸処理
--=================================================
UP_JEUGIA_TANA:
	Declare @e65_edi_flag char (1)
	Declare @e65_edi_timestamp timestamp
	Declare @e65_edi_create_date datetime 
	Declare @e65_edi_update_date datetime 
	Declare @e65_edi_file_line_no int 
	Declare @e65_edi_meisai_no int 
	Declare @e65_edi_error_msg varchar (200)
	Declare @e65_server_webpos varchar (100)
	Declare @e65_dbname_webpos varchar (100)

	Declare @e65_tushin_id			char(2)
	Declare @e65_shop_cd_webpos		int
	Declare @e65_shop_name_webpos	varchar(100)
	Declare @e65_shop_cd_edi		varchar(10)
	Declare @e65_trn_date			varchar(10)
	Declare @e65_pos_no				int

	Declare @e65_insert_count		int
	Set @e65_insert_count = 0

	Declare @e65_zenkai_dateteme	datetime
	Declare @e65_konkai_dateteme	datetime
	------------------------------
	-- 処理済データ削除
	------------------------------
	Exec @rc = P_EDI_Book_DataDelete
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 Begin
		Set @err_msg = '9091,JEUGIA棚卸削除不正'
		GOTO SP_ERR
	End

	------------------------------
	-- 上り対象店舗を抽出
	------------------------------
	Set @rs = cursor static read_only for 
	SELECT
		bes_bookedi_cd
		,bes_book_shop_cd
		,shm_shop_cd
		,shm_shop_name
	FROM
		wpt_book_edi_setting
	JOIN
		wpt_shop_master
		ON
			bes_shop_cd = shm_shop_cd
	WHERE
		bes_up_jga_flag =
		Case
			When @edi_type = '65U' Then '1'
			Else bes_up_jga_flag
		End

	-- カーソルを開く
	Open @rs

	-- @P_INOUT_TMPループ
	Fetch Next From @rs Into
		 @a_tushin_id
		,@a_book_shop_cd
		,@a_shop_cd
		,@a_shop_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin

		-- 前回処理時間を取得
		select
			top 1
			@e65_zenkai_dateteme = tct_trn_date
		from
			wbe_topculture_control with(nolock)
		where
			tct_tushin_id = @a_tushin_id
			and
			tct_edi_type = @edi_type
			and
			tct_shop_cd = @a_shop_cd
		order by
			tct_id desc
		-- 初回（前回処理時間がない場合）は、現在日時の2日前とする
		If @e65_zenkai_dateteme is null Begin
			Set @e65_zenkai_dateteme = Dateadd(day,-2,getdate())
		End
		-- 今回処理日時をセット
		Set @e65_konkai_dateteme = getdate()

		-- 初期値セット
		Set @a_edi_flag = '0'

		Set @a_sql = ''
		+ ' INSERT INTO ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_up_jtn ( '
			+ '	 e65_edi_flag '
			+ '	,e65_server_webpos '
			+ '	,e65_dbname_webpos '
			+ '	,e65_shop_cd_webpos '
			+ '	,e65_shop_name_webpos '
			+ '	,e65_shop_cd_primary '
			+ '	,e65_shop_cd '
			+ '	,e65_tushin_id '

			+ '	,e65_sikibetu_cd '
			+ '	,e65_denpyo_type '
			+ '	,e65_seq_no '

			+ '	,e65_goods_code '

			+ '	,e65_tana_count_sign '
			+ '	,e65_tana_count '
			+ '	,e65_tana_price '
			+ '	,e65_tana_total_price_sign '
			+ '	,e65_tana_total_price '

		+ ' )   '
		+ ' SELECT '
			+ '	 e65_edi_flag = ''0'' '          -- 未処理
			+ '	,e65_server_webpos = ' + dbo.F_sql_mod(cast(@server_name as varchar(1000)))
			+ '	,e65_dbname_webpos = ' + dbo.F_sql_mod(cast(@db_name as varchar(1000)))
			+ '	,e65_shop_cd_webpos = ' + Cast(@a_shop_cd AS varchar)
			+ '	,e65_shop_name_webpos = ' + '''' + Cast(@a_shop_name AS varchar) + ''''
			+ '	,e65_shop_cd_primary = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e65_shop_cd = ' + '''' + Cast(@a_book_shop_cd AS varchar) + ''''
			+ '	,e65_tushin_id = ' + '''' + Cast(@a_tushin_id AS varchar) + ''''

			+ '	,e65_sikibetu_cd = ' + '''' + 'TA' + ''''
			+ '	,e65_denpyo_type = ''30'' '
			+ '	,e65_seq_no = Right(''000000000'' + Convert(varchar,doc_doc_id), 9) '

			+ '	,e65_goods_code = Case When IsNull(jmc_jeugia_media_cd,'''') = '''' Then ''41000'' Else jmc_jeugia_media_cd End '

			+ '	,e65_tana_count_sign = '
				+ ' case '
					+ ' when dte_tana_count >= 0 then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e65_tana_count = '
				+  ' '
					+ ' dte_tana_count '
				+ ' '
			+ '	,e65_tana_price = '
				+  ' '
					+ ' plu_gds_price '
				+ ' '
			+ '	,e65_tana_total_price_sign = '
				+ ' case '
					+ ' when dte_tana_count >= 0 then ''+'' '
					+ ' else ''-'' '
				+ ' end '
			+ '	,e65_tana_total_price = '
				+  ' '
					+ ' plu_gds_price * dte_tana_count '
				+ ' '

		+ ' from wpt_document with(nolock) '
		+ ' join wpt_document_tana_end with(nolock) '
			+ ' on doc_doc_id = dte_doc_id '
		+ ' join wpv_plu with(nolock) '
			+ ' on plu_goods_id = dte_goods_id '
			+ ' and plu_shop_cd = doc_shop_cd '
-- JEUGIA商品コード変換
		+ ' left join wpt_jeugia_media_convert with(nolock) '
			+ ' on jmc_media_cd = plu_media_cd '

		+ ' where '
			+ ' doc_work_type in (''0301'') '
			+ ' and doc_shop_cd = ' + Cast(@a_shop_cd AS varchar) + ' '
			+ ' and doc_create_date >= ' + '''' + Convert(varchar,@e65_zenkai_dateteme,111) + ' ' + Convert(varchar,@e65_zenkai_dateteme,114) + ''''
			+ ' and doc_create_date < ' + '''' + Convert(varchar,@e65_konkai_dateteme,111) + ' ' + Convert(varchar,@e65_konkai_dateteme,114) + ''''

		+ ' order by '
			+ '  doc_work_type '
			+ ' ,doc_doc_id '
			+ ' ,jmc_jeugia_media_cd '

--select @a_shop_cd		,@e65_zenkai_dateteme
--select @a_sql
--goto sp_ok

		Exec (@a_sql)
		-- エラーチェック
		If @@ERROR <> 0 Begin
			Set @a_edi_flag = '3'  -- エラー
		End

		-- 追加件数カウント
		Set @e65_insert_count = @e65_insert_count + 1

		-- エラーでなければ、上り制御データに追加
		If @a_edi_flag <> '3' Begin
			Insert Into wbe_topculture_control
				( tct_tushin_id, tct_edi_type, tct_shop_cd, tct_trn_date, tct_pos_no )
			Values
				( @a_tushin_id, @edi_type, @a_shop_cd, @e65_konkai_dateteme, 0 )
		End

		-- カウント初期レコードセット
		INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
		)
		SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @a_tushin_id
			,t_count_all = @e65_insert_count
			,t_count_ok = @e65_insert_count
			,t_count_wa = 0
			,t_count_ng = 0

		-- 次へ
		Fetch Next From @rs Into
			 @a_tushin_id
			,@a_book_shop_cd
			,@a_shop_cd
			,@a_shop_name
	End  -- While

  -- カーソルを閉じる
  Close @rs
  -- 開放
  Deallocate @rs


	-- カウントを返す
	SELECT
		t_tushin_id as tushin_id
		,t_count_all as count_all
		,t_count_ok as count_ok
		,t_count_wa as count_wa
		,t_count_ng as count_ng
	FROM
		#count_tbl


  --終了
  GOTO SP_OK

UP_JEUGIA_TANA_END:

-- ▲▲▲ 2014/01/28 add



--=================================================
--=================================================
--==  下り
--=================================================
--=================================================

  Declare @P01 varchar(8000)
  Declare @P02 varchar(8000)
  Declare @P03 varchar(MAX) -- 2019/08/26 8000からMAXに変更
  Declare @P04 varchar(8000)
  Declare @P05 varchar(8000)
  Declare @P06 varchar(8000)
  

  Declare @a_check_dummy int -- カウントダミー用
  Declare @a_zasshi_year char(1)   -- 雑誌コード作成用年1桁

--=================================================
-- 下り銘柄処理（マスタ処理）
--=================================================
DOWN_MEIGARA:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9001,銘柄サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_mst ('
	+ '	 e20_edi_flag'
	+ '	,e20_edi_timestamp'
	+ '	,e20_edi_id'
	+ '	,e20_edi_create_date'
	+ '	,e20_edi_update_date'
	+ '	,e20_edi_file_line_no'
	+ '	,e20_edi_file_line_no2'
	+ '	,e20_edi_file_line_no3'
	+ '	,e20_edi_file_line_no4'
	+ '	,e20_edi_error_msg'
	+ '	,e20_server_webpos'
	+ '	,e20_dbname_webpos'
	+ '	,e20_shop_cd_webpos'
	+ '	,e20_shop_name_webpos'
	+ '	,e20_seq_no'
	+ '	,e20_shop_cd_primary'
	+ '	,e20_shop_cd'
	+ '	,e20_tushin_id'
	+ '	,e20_goods_code_kubun'
	+ '	,e20_goods_code'
	+ '	,e20_goods_name'
	+ '	,e20_goods_name_kana'
	+ '	,e20_goods_subname'
	+ '	,e20_goods_subname_kana'
	+ '	,e20_writer_name'
	+ '	,e20_writer_kana'
	+ '	,e20_series_name'
	+ '	,e20_series_kana'
	+ '	,e20_c_code'
	+ '	,e20_torihiki_code'
	+ '	,e20_volume_name'
	+ '	,e20_volume'
	+ '	,e20_hangata'
	+ '	,e20_hannumber'
	+ '	,e20_publisher_name'
	+ '	,e20_publisher_kana'
	+ '	,e20_price'
	+ '	,e20_tax_type'
	+ '	,e20_tax_rate'
	+ '	,e20_shinkan_kubun'
	+ '	,e20_shun_kubun'
	+ '	,e20_shupan_date'
	+ '	,e20_juuhan_yotei_date'
	+ '	,e20_zepan_date'
	+ '	,e20_magazinecode_and_gatugo'
	+ '	,e20_magazine_year'
	+ '	,e20_set_kubun'
	+ '	,e20_pagenumber_name'
	+ '	,e20_pagenumber'
	+ '	,e20_tate'
	+ '	,e20_yoko'
	+ '	,e20_atusa'
	+ '	,e20_series_no_name'
	+ '	,e20_series_no'
	+ '	,e20_publisher_type'
	+ '	,e20_toritugi_stock_date'
	+ '	,e20_toritugi_stock'
	+ '	,e20_publisher_stock_date'
	+ '	,e20_publisher_stock'
	+ '	,e20_publisher_district'
	+ '	,e20_comment'
	+ '	,e20_comment_kana'
	+ '	,e20_contents_introduction'
	+ '	,e20_cd_kikaku_bango'
	+ '	,e20_cd_genre_cd'
	+ '	,e20_cd_hinshu_cd'
	+ '	,e20_cd_genka'
	+ '	,e20_kaikiri_kubun'
	+ '	,e20_teiban_kubun'
	+ '	,e20_joubi_kubun'
	+ '	,e20_hitubi_kubun'
	+ '	,e20_kihontosyo_kubun'
	+ '	,e20_b_genre'
	+ '	,e20_m_genre'
	+ '	,e20_s_genre'
	+ '	,e20_tohan_ac_cd'
	+ '	,e20_cd_label_cd'
	+ '	,e20_cd_sales_cd'
	+ '	,e20_magazinecode_and_hatubaibi'
	+ '	,e20_order_end_date'
	+ '	,e20_0souhin_flag'
	+ '	,e20_game_jan_cd'
	+ '	,e20_game_hatsubaibi_text'
	+ '	,e20_lot' -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
	+ '	,e20_ec_goods_cd' -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
	+ '      )'
	+ '      SELECT'
	+ '	 M.e20_edi_flag'
	+ '	,M.e20_edi_timestamp'
	+ '	,M.e20_edi_id'
	+ '	,M.e20_edi_create_date'
	+ '	,M.e20_edi_update_date'
	+ '	,M.e20_edi_file_line_no'
	+ '	,M.e20_edi_file_line_no2'
	+ '	,M.e20_edi_file_line_no3'
	+ '	,M.e20_edi_file_line_no4'
	+ '	,M.e20_edi_error_msg'
	+ '	,M.e20_server_webpos'
	+ '	,M.e20_dbname_webpos'
	+ '	,M.e20_shop_cd_webpos'
	+ '	,M.e20_shop_name_webpos'
	+ '	,M.e20_seq_no'
	+ '	,M.e20_shop_cd_primary'
	+ '	,M.e20_shop_cd'
	+ '	,M.e20_tushin_id'
	+ '	,M.e20_goods_code_kubun'
	+ '	,M.e20_goods_code'
	+ '	,M.e20_goods_name'
	+ '	,M.e20_goods_name_kana'
	+ '	,M.e20_goods_subname'
	+ '	,M.e20_goods_subname_kana'
	+ '	,M.e20_writer_name'
	+ '	,M.e20_writer_kana'
	+ '	,M.e20_series_name'
	+ '	,M.e20_series_kana'
	+ '	,M.e20_c_code'
	+ '	,M.e20_torihiki_code'
	+ '	,M.e20_volume_name'
	+ '	,M.e20_volume'
	+ '	,M.e20_hangata'
	+ '	,M.e20_hannumber'
	+ '	,M.e20_publisher_name'
	+ '	,M.e20_publisher_kana'
	+ '	,M.e20_price'
	+ '	,M.e20_tax_type'
	+ '	,M.e20_tax_rate'
	+ '	,M.e20_shinkan_kubun'
	+ '	,M.e20_shun_kubun'
	+ '	,M.e20_shupan_date'
	+ '	,M.e20_juuhan_yotei_date'
	+ '	,M.e20_zepan_date'
	+ '	,M.e20_magazinecode_and_gatugo'
	+ '	,M.e20_magazine_year'
	+ '	,M.e20_set_kubun'
	+ '	,M.e20_pagenumber_name'
	+ '	,M.e20_pagenumber'
	+ '	,M.e20_tate'
	+ '	,M.e20_yoko'
	+ '	,M.e20_atusa'
	+ '	,M.e20_series_no_name'
	+ '	,M.e20_series_no'
	+ '	,M.e20_publisher_type'
	+ '	,M.e20_toritugi_stock_date'
	+ '	,M.e20_toritugi_stock'
	+ '	,M.e20_publisher_stock_date'
	+ '	,M.e20_publisher_stock'
	+ '	,M.e20_publisher_district'
	+ '	,M.e20_comment'
	+ '	,M.e20_comment_kana'
	+ '	,M.e20_contents_introduction'
	+ '	,M.e20_cd_kikaku_bango'
	+ '	,M.e20_cd_genre_cd'
	+ '	,M.e20_cd_hinshu_cd'
	+ '	,M.e20_cd_genka'
	+ '	,M.e20_kaikiri_kubun'
	+ '	,M.e20_teiban_kubun'
	+ '	,M.e20_joubi_kubun'
	+ '	,M.e20_hitubi_kubun'
	+ '	,M.e20_kihontosyo_kubun'
	+ '	,M.e20_b_genre'
	+ '	,M.e20_m_genre'
	+ '	,M.e20_s_genre'
	+ '	,M.e20_tohan_ac_cd'
	+ '	,M.e20_cd_label_cd'
	+ '	,M.e20_cd_sales_cd'
	+ '	,M.e20_magazinecode_and_hatubaibi'
	+ '	,M.e20_order_end_date'
	+ '	,M.e20_0souhin_flag'
	+ '	,M.e20_game_jan_cd'
	+ '	,M.e20_game_hatsubaibi_text'
	+ '	,M.e20_lot' -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
	+ '	,M.e20_ec_goods_cd' -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_mst as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_mst as C'
	+ '                on M.e20_edi_id = C.e20_edi_id'
	+ '            where'
	+ '              C.e20_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e20_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e20_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e20_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9001,銘柄データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e20_tushin_id char (2)
  Declare @e20_goods_code_kubun char (1)
  Declare @e20_goods_code varchar (20)
  Declare @e20_goods_name varchar (100)
  Declare @e20_goods_name_kana varchar (100)
  Declare @e20_goods_subname varchar (100)
  Declare @e20_goods_subname_kana varchar (100)
  Declare @e20_writer_name varchar (100)
  Declare @e20_writer_kana varchar (100)
  Declare @e20_series_name varchar (100)
  Declare @e20_series_kana varchar (100)
  Declare @e20_c_code char (4)
  Declare @e20_torihiki_code char (4)
  Declare @e20_volume_name varchar (100)
  Declare @e20_volume int
  Declare @e20_hangata varchar (50)
  Declare @e20_hannumber varchar (50)
  Declare @e20_publisher_name varchar (100)
  Declare @e20_publisher_kana varchar (100)
  Declare @e20_price money
  Declare @e20_tax_type char (1)
  Declare @e20_tax_rate decimal(5, 2)
  Declare @e20_shinkan_kubun char (1)
  Declare @e20_shun_kubun char (1)
  Declare @e20_shupan_date char (8)
  Declare @e20_juuhan_yotei_date char (8)
  Declare @e20_zepan_date char (8)
  Declare @e20_magazinecode_and_gatugo char (7)
  Declare @e20_magazine_year char (1)
  Declare @e20_set_kubun char (1)
  Declare @e20_pagenumber_name varchar (100)
  Declare @e20_pagenumber int
  Declare @e20_tate int
  Declare @e20_yoko int
  Declare @e20_atusa int
  Declare @e20_series_no_name varchar (100)
  Declare @e20_series_no int
  Declare @e20_publisher_type varchar (10)
  Declare @e20_toritugi_stock_date char (8)
  Declare @e20_toritugi_stock varchar (10)
  Declare @e20_publisher_stock_date char (8)
  Declare @e20_publisher_stock varchar (10)
  Declare @e20_publisher_district varchar (100)
  Declare @e20_comment varchar (100)
  Declare @e20_comment_kana varchar (100)
  Declare @e20_contents_introduction varchar (100)
  Declare @e20_cd_kikaku_bango varchar (15)
  Declare @e20_cd_genre_cd varchar (10)
  Declare @e20_cd_hinshu_cd varchar (10)
  Declare @e20_cd_genka money
  Declare @e20_kaikiri_kubun char (1)
  Declare @e20_teiban_kubun char (1)
  Declare @e20_joubi_kubun char (1)
  Declare @e20_hitubi_kubun char (1)
  Declare @e20_kihontosyo_kubun char (1)
  Declare @e20_b_genre varchar (6)  -- 2009/05/08 char(2) → varchar(6)
  Declare @e20_m_genre varchar (6)  -- 2009/05/08 char(2) → varchar(6)
  Declare @e20_s_genre varchar (6)  -- 2009/05/08 char(2) → varchar(6)
  Declare @e20_tohan_ac_cd varchar (10)
  Declare @e20_cd_label_cd varchar (10)
  Declare @e20_cd_sales_cd varchar (10)
  Declare @e20_magazinecode_and_hatubaibi char (9)
  Declare @e20_order_end_date char (8)
  Declare @e20_0souhin_flag char (1)
  Declare @e20_game_jan_cd varchar (20)              -- 2009/05/08add
  Declare @e20_game_hatsubaibi_text varchar (10)     -- 2009/05/08add
  Declare @e20_lot int -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
  Declare @e20_ec_goods_cd varchar (20) -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）

  Declare @e20_mst_update_flag char (1)   -- 20070621add

  Declare @a_teiki_all_count int
  Declare @a_teiki_all2_count int
  Declare @a_teiki_ok_count int
  Declare @a_teiki_ng_count int
  Declare @a_teiki_skip_count int
  Declare @a_teiki_err_msg varchar(8000)

--  SET ROWCOUNT 10000

  -- 一時テーブル読み込み
  Set @rs = cursor static for
       SELECT
	 e20_edi_id
	,e20_tushin_id
	,e20_goods_code_kubun
	,e20_goods_code
	,e20_tax_type
	,e20_tushin_id   -- ここから下は面倒なので全フィールド
	,e20_goods_code_kubun
	,e20_goods_code
	,e20_goods_name
	,e20_goods_name_kana
	,e20_goods_subname
	,e20_goods_subname_kana
	,e20_writer_name
	,e20_writer_kana
	,e20_series_name
	,e20_series_kana
	,e20_c_code
	,e20_torihiki_code
	,e20_volume_name
	,e20_volume
	,e20_hangata
	,e20_hannumber
	,e20_publisher_name
	,e20_publisher_kana
	,e20_price
	,e20_tax_type
	,e20_tax_rate
	,e20_shinkan_kubun
	,e20_shun_kubun
	,e20_shupan_date
	,e20_juuhan_yotei_date
	,e20_zepan_date
	,e20_magazinecode_and_gatugo
	,e20_magazine_year
	,e20_set_kubun
	,e20_pagenumber_name
	,e20_pagenumber
	,e20_tate
	,e20_yoko
	,e20_atusa
	,e20_series_no_name
	,e20_series_no
	,e20_publisher_type
	,e20_toritugi_stock_date
	,e20_toritugi_stock
	,e20_publisher_stock_date
	,e20_publisher_stock
	,e20_publisher_district
	,e20_comment
	,e20_comment_kana
	,e20_contents_introduction
	,e20_cd_kikaku_bango
	,e20_cd_genre_cd
	,e20_cd_hinshu_cd
	,e20_cd_genka
	,e20_kaikiri_kubun
	,e20_teiban_kubun
	,e20_joubi_kubun
	,e20_hitubi_kubun
	,e20_kihontosyo_kubun
	,e20_b_genre
	,e20_m_genre
	,e20_s_genre
	,e20_tohan_ac_cd
--	,right('__' + e20_cd_label_cd,2) + isnull(e20_cd_sales_cd,'')
	,e20_cd_label_cd
	,e20_cd_sales_cd
	,e20_magazinecode_and_hatubaibi
	,e20_order_end_date
	,e20_0souhin_flag
	,e20_game_jan_cd
	,e20_game_hatsubaibi_text
	,e20_lot
	,e20_ec_goods_cd
            from
              wbe_edibook_dw_mst
            where
              e20_edi_flag = '0'  -- 未処理
            order by
              e20_edi_file_line_no
             ,e20_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@a_tax_type
	,@e20_tushin_id  -- ここから下は面倒なので全フィールド
	,@e20_goods_code_kubun
	,@e20_goods_code
	,@e20_goods_name
	,@e20_goods_name_kana
	,@e20_goods_subname
	,@e20_goods_subname_kana
	,@e20_writer_name
	,@e20_writer_kana
	,@e20_series_name
	,@e20_series_kana
	,@e20_c_code
	,@e20_torihiki_code

	,@e20_volume_name
	,@e20_volume
	,@e20_hangata
	,@e20_hannumber
	,@e20_publisher_name
	,@e20_publisher_kana
	,@e20_price
	,@e20_tax_type
	,@e20_tax_rate
	,@e20_shinkan_kubun
	,@e20_shun_kubun
	,@e20_shupan_date
	,@e20_juuhan_yotei_date
	,@e20_zepan_date
	,@e20_magazinecode_and_gatugo
	,@e20_magazine_year
	,@e20_set_kubun
	,@e20_pagenumber_name
	,@e20_pagenumber
	,@e20_tate
	,@e20_yoko
	,@e20_atusa
	,@e20_series_no_name
	,@e20_series_no
	,@e20_publisher_type
	,@e20_toritugi_stock_date
	,@e20_toritugi_stock
	,@e20_publisher_stock_date
	,@e20_publisher_stock
	,@e20_publisher_district
	,@e20_comment
	,@e20_comment_kana
	,@e20_contents_introduction
	,@e20_cd_kikaku_bango
	,@e20_cd_genre_cd
	,@e20_cd_hinshu_cd
	,@e20_cd_genka
	,@e20_kaikiri_kubun
	,@e20_teiban_kubun
	,@e20_joubi_kubun
	,@e20_hitubi_kubun
	,@e20_kihontosyo_kubun
	,@e20_b_genre
	,@e20_m_genre
	,@e20_s_genre
	,@e20_tohan_ac_cd
	,@e20_cd_label_cd
	,@e20_cd_sales_cd
	,@e20_magazinecode_and_hatubaibi
	,@e20_order_end_date
	,@e20_0souhin_flag
	,@e20_game_jan_cd
	,@e20_game_hatsubaibi_text
	,@e20_lot -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
	,@e20_ec_goods_cd -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

--print '--'
--print '01:' + convert(varchar,getdate(),114)

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み
       ,@a_goods_id = null
       ,@a_jan = null
       ,@a_jan_new = null

      -- 取引先コード、EDI区分セット
      SELECT
          @a_supplier_id = mpm_supplier_id
        , @a_supplier_cd = mpm_supplier_cd
        , @a_supplier_edi_type = mpm_edi_type
      from
        wpt_maker_supplier_master
      where
        mpm_bookedi_cd = @a_tushin_id

      -- コードチェック
      If @a_goods_code is null or rtrim(ltrim(@a_goods_code)) = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '商品コードなし'
               + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 書籍チェック
      If @a_goods_code_kubun = '1' and
         len(@a_goods_code) <> 10 Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '書籍コード(ISBN)不正'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 雑誌チェック(新・旧)
      If @a_goods_code_kubun in ( '2', '8' ) and
         len(@a_goods_code) <> 7 and

         len(@a_goods_code) <> 5 Begin 
          -- エラー記録
          SELECT

             @a_edi_error_msg = '雑誌コード+月号(7桁)or基本誌コード(5桁)不正'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 対象外コードチェック（商品コード0の場合）
      If isnumeric(@a_goods_code) = 1 and 
         ( cast(ltrim(rtrim(@a_goods_code)) as bigint) = 0 ) Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '対象外コード'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 栗田対象外コードチェック
      If ltrim(rtrim(@a_goods_code)) = '999999999'
         or ltrim(rtrim(@a_goods_code)) = '9999999999' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '栗田対象外コード'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 大洋社セット商品コードチェック
      If Not ( @e20_set_kubun = '0' or @e20_set_kubun = '2' )
           and @a_goods_code_kubun = '2'
           and @a_tushin_id = 'TY'  Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '大洋社対象外コード'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
                 + ',セット区分=[' + isnull(@e20_set_kubun,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 社内コードチェック
      If @a_goods_code_kubun = '6' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '対象外コード'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      --2012/09/20
      -- インストアコードチェック（TMWMSP除外）
      --If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
	  -- and len(ltrim(rtrim(@a_goods_code))) = 13 Begin
      If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
         and len(ltrim(rtrim(@a_goods_code))) = 13 and ( @a_tushin_id <> 'TP' ) and ( @a_tushin_id <> 'TS' ) Begin -- 2019/08/27 @a_tushin_id <> 'TS'の条件追加
          -- エラー記録
          SELECT
             @a_edi_error_msg = '対象外コード(インストア)'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 税区分チェック
      If @a_tax_type is null or rtrim(ltrim(@a_tax_type)) = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '税区分なし'
                 + ' 税区分=[' + isnull(@a_tax_type,'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- 2009/05/08
      -- CD/DVDの場合はレーベルコードを以下のように変換
      --If @a_goods_code_kubun = '5' 
      --   Set @e20_cd_label_cd = right('__' + @e20_cd_label_cd,2) + isnull(@e20_cd_sales_cd,'')
      -- 2012/09/06 update（星光堂以外の場合のみ、既存のlabel_cdを変換する。星光堂はそのままのlabel_cdを使う）
	  If @a_tushin_id <> 'SK' AND @a_tushin_id <> 'TS' BEGIN -- 2019/07/31 THNNFS-31「AND @a_tushin_id <> 'TS'」追加
		If @a_goods_code_kubun IN ('5', '4') Begin	-- 2012/10/22 update
		  Set @e20_cd_label_cd = right('__' + @e20_cd_label_cd,2) + isnull(@e20_cd_sales_cd,'')
	    End
	  End


      -- レーベルコードチェック
      If @a_goods_code_kubun in ('5', 'G', '4') and isnull(@e20_cd_label_cd,'') = '' Begin	-- 2012/10/22 update
          -- エラー記録
          SELECT
             @a_edi_error_msg = 'レーベルコードなし'
                 + ' レーベルコード=[' + isnull(@e20_cd_label_cd,'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST	   
	  End

      -- 販売元コードチェック
      If @a_goods_code_kubun in ('5', 'G', '4') and isnull(@e20_cd_sales_cd,'') = '' Begin	-- 2012/10/22 update
          -- エラー記録
          SELECT
             @a_edi_error_msg = '販売元コードなし'
                 + ' 販売元コード=[' + isnull(@e20_cd_sales_cd,'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST	   
	  End

      -- 2009/05/12
      -- ゲームの場合、大分類が1以外はNG
      If @a_goods_code_kubun = 'G' and isnull(@e20_b_genre,'') <> '1' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '取込対象外のゲーム商品'
                 + ' 大分類コード=[' + isnull(@e20_b_genre,'') + ']'
                 + ' 商品コード=[' + isnull(@e20_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST	   
	  End

      -- 雑誌コード作成用年４桁セット
      SELECT
          @a_zasshi_year = 
                case   -- 雑誌年号があればそれを優先。なれりば出版日
                   when isnull(@e20_magazine_year,'') <> ''
                      then @e20_magazine_year
                   when isnull(substring(@e20_shupan_date,1,4),'') <> ''
                      then substring(@e20_shupan_date,4,1)
                   when substring(@e20_shupan_date,1,4) = '0000'

                      then substring(convert(varchar,getdate(),111),4,1)
                   else  substring(convert(varchar,getdate(),111),4,1)
                End

      -- JAN生成
      SELECT
          @a_jan =
            case
              when @a_goods_code_kubun = '1' then dbo.F_Create_BookJAN(@a_goods_code)
              when @a_goods_code_kubun = '2' 
                       and len(@a_goods_code) = 7 then dbo.F_Create_ZasshiJAN(@a_goods_code,@a_zasshi_year)
              when @a_goods_code_kubun = '2' 
                       and len(@a_goods_code) = 5 then dbo.F_Create_ZasshiJAN(@a_goods_code
                                                               + substring(@e20_shupan_date,5,2)
                                                              ,@a_zasshi_year)
              when @a_goods_code_kubun = '8'  -- 旧
                       and len(@a_goods_code) = 7 then dbo.F_Create_OldZasshiJAN(@a_goods_code,@e20_price)
              when @a_goods_code_kubun = '8'
                       and len(@a_goods_code) = 5 then dbo.F_Create_OldZasshiJAN(@a_goods_code
                                                               + substring(@e20_shupan_date,5,2)
                                                              ,@e20_price)
              else @a_goods_code
            End
         
      If isnull(@a_jan,'') = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = 'JAN生成エラー'
                + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
                + ',エラーコード=[' + isnull(@a_jan,'') + ']'
            ,@a_edi_flag = '3'  -- エラー

          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
      End

      -- データセット
      SELECT
	 @a_goods_name = 
		cast(@e20_goods_name as varchar(100))
		  +
		case  -- 巻数を後ろに足す。
		  when  isnull(@e20_volume_name,'') = '' then ''
		  when  right(isnull(@e20_goods_name,''),len(@e20_volume_name)) = @e20_volume_name then ''  -- 最後が同じなら足さない。
		  else '　' + cast(@e20_volume_name as varchar)
		end
	,@a_tax_type = isnull(@e20_tax_type,'0')  -- デフォルト外税
	,@a_price_type = '0'  -- 税抜固定
	,@a_price = cast(isnull(@e20_price,0) as int)
	,@a_goods_type = 
		case
		   when @a_goods_code_kubun = '1' then '20'
		   when @a_goods_code_kubun = '2' then '21'
		   when @a_goods_code_kubun = '5' then '30'  -- CD/DVD
		   when @a_goods_code_kubun = 'G' then '40'  -- GAME
		   when @a_goods_code_kubun = '4' then '31'  -- 文具	2012/10/05 
		   else '00'
		End
	,@a_media_id = 
		case
		   when @a_goods_code_kubun = '1' then
		     dbo.F_Search_Book_Media(@e20_c_code,dbo.F_Convert_ISBN_Publisher(@e20_goods_code))
		   when @a_goods_code_kubun = '2' then 
		     dbo.F_Search_Book_Media(substring(@e20_goods_code,1,1),null)
		   -- WINT分類判定を作り直したら、TMW方式に統一する。
--		   when @a_goods_code_kubun = '5' and @a_tushin_id = 'TM' then -- TMWはジャンル品種で判定
--		     dbo.F_Search_DISK_Media(@e20_cd_genre_cd,@e20_cd_hinshu_cd)
--		   when @a_goods_code_kubun = '5' then 
--		     dbo.F_Search_DISK_Media(@e20_m_genre,@e20_s_genre)
		   -- 2009/03/23 TMW方式に統一
-- 2012/08/27 update（星光堂[SK]の場合とそれ以外の場合で判定元の項目が異なる）
--		   when @a_goods_code_kubun = '5' then -- ジャンル品種で判定
--		     dbo.F_Search_DISK_Media(@e20_cd_genre_cd,@e20_cd_hinshu_cd)
		   when @a_goods_code_kubun = '5' AND @e20_tushin_id <> 'SK' then -- ジャンル品種で判定
		     dbo.F_Search_DISK_Media(@e20_cd_genre_cd,@e20_cd_hinshu_cd)
		   when @a_goods_code_kubun = '5' AND @e20_tushin_id = 'SK' then -- ジャンル品種で判定
		     dbo.F_Search_DISK_Media(@e20_s_genre,SubString(@e20_cd_hinshu_cd,3,4))
		   -- 2012/09/20 add　　TMWMSP（通信ID＝TP）で、文具（商品コード区分＝4）の場合、DISK用の分類変換ロジックで判定
		--▼▼▼ 更新：2020/02/19 - コア - MS-771 - START
		   --when @a_goods_code_kubun = '4' and @a_tushin_id = 'TP' then
		   --dbo.F_Search_DISK_Media(@e20_cd_genre_cd,@e20_cd_hinshu_cd)
		   -- TP/TSの下りデータが来る場合は常に分類「84210」(文具)に変換する
		   -- 2020/05/20 MS-771 修正 START
		   -- when @a_tushin_id IN ('TP', 'TS') then
		   --	   (SELECT TOP 1 gdm_media_id FROM wpt_goods_media_master WHERE gdm_media_cd = '84210')
		   when @a_tushin_id IN ('TP', 'TS')  then
				case 
				    when @e20_cd_hinshu_cd in ('352000') Then
		   				(SELECT TOP 1 gdm_media_id FROM wpt_goods_media_master WHERE gdm_media_cd = '80000')
					else
					    (SELECT TOP 1 gdm_media_id FROM wpt_goods_media_master WHERE gdm_media_cd = '84210')
					End
			-- 2020/05/20 MS-771 修正 END
		--▲▲▲ 更新：2020/02/19 - コア - MS-771 - END
		   else null
		End
	,@a_genre_cd = null -- 2009/05/12
	
    -- 2009/05/08
    -- ゲームの場合はここでメディアIDを取得
    -- 2009/05/12
    -- ジャンルも取得
    If @a_goods_code_kubun = 'G' Begin
       -- ゲーム用メディア作成処理
       -- メディアIDを返す
       Exec @rc = P_Game_Media_Create 
           @b_genre  = @e20_b_genre
          ,@m_genre  = @e20_m_genre
          ,@s_genre  = @e20_s_genre 
          ,@sp       = '1'  -- SP起動
          ,@media_id = @a_media_id OUTPUT
          ,@err_msg  = @a_edi_error_msg OUTPUT
       -- エラーチェック
       If @rc <> 0 or @a_media_id is null Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '分類マスタ生成エラー'
                + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
                + ',大分類=[' + isnull(@e20_b_genre,'') + ']'
                + ',中分類=[' + isnull(@e20_m_genre,'') + ']'
                + ',小分類=[' + isnull(@e20_s_genre,'') + ']'
                + ',エラー内容=[' + @a_edi_error_msg + ']'
            ,@a_edi_flag = '3'  -- エラー
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
       End
       
       -- ゲーム用ジャンル作成処理
       -- ジャンルCDを返す
       Exec @rc = P_Game_Genre_Create 
           @s_genre  = @e20_s_genre 
          ,@sp       = '1'  -- SP起動
          ,@genre_cd = @a_genre_cd OUTPUT
          ,@err_msg  = @a_edi_error_msg OUTPUT
       -- エラーチェック
       If @rc <> 0 or @a_media_id is null Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = 'ジャンルマスタ生成エラー'
                + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
                + ',小分類=[' + isnull(@e20_s_genre,'') + ']'
                + ',エラー内容=[' + @a_edi_error_msg + ']'
            ,@a_edi_flag = '3'  -- エラー
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
       End
    End

    -- 2009/05/12
    -- P_PLUで商品存在チェックを行なう
    SET @e20_mst_update_flag = '0'
    SET @a_exist_goods_id = null
    SET @a_exist_goods_type = null
    SET @a_exist_goods_media_id = null
    SET @a_exist_jan_cd = null
    -- ゲームとそれ以外
    If @a_goods_code_kubun = 'G' Begin
      -- ゲームはJANが設定されている場合のみ検索
      Set @rc = 0
      If isnull(@e20_game_jan_cd, '') <> ''
        Exec @rc = P_PLU
               @plu_cd = @e20_game_jan_cd
              ,@plu_type = '0'
              ,@sp = '1'
              ,@gds_goods_id = @a_exist_goods_id OUTPUT
              ,@gds_goods_type = @a_exist_goods_type OUTPUT
              ,@gds_media_id = @a_exist_goods_media_id OUTPUT
    End
    Else Begin
      -- それ以外はJANで検索
      Exec @rc = P_PLU
             @plu_cd = @a_jan
            ,@plu_type = '0'
            ,@sp = '1'
            ,@gds_goods_id = @a_exist_goods_id OUTPUT
            ,@gds_goods_type = @a_exist_goods_type OUTPUT
    End
    -- エラーチェック
    If @rc <> 0 Begin
       -- エラー記録
       SELECT
          @a_edi_error_msg = '商品マスタ検索エラー'
             + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
             + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
             + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
         ,@a_edi_flag = '3'  -- エラー
       -- ループ終了まで飛ばす
       GOTO LOOP_END_MST
    End

    -- 2010/02/03 JAN訂正対応
    -- CD/DVDは、JAN訂正データかどうかチェック
    If @a_exist_goods_id is null and isnull(@e20_cd_kikaku_bango, '') <> ''
       and @a_goods_code_kubun IN ('5') Begin	-- 2012/10/22 update -- 2019/08/15 @a_goods_code_kubun = '4'の場合削除。
        -- 規格番号で検索
        Exec @rc = P_PLU
               @plu_cd = @e20_cd_kikaku_bango
              ,@plu_type = '4'  -- 規番
              ,@sp = '1'
              ,@gds_goods_id = @a_exist_goods_id OUTPUT
              ,@gds_goods_type = @a_exist_goods_type OUTPUT
              ,@gds_jan_cd = @a_exist_jan_cd OUTPUT
        -- エラーチェック
        If @rc <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = 'DISK商品マスタ検索エラー'
                 + ' 商品コード=[' + isnull(@e20_cd_kikaku_bango,'') + ']'
                 + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
                 + ',エラーコード=[' + isnull(@rc,'') + ']'
             ,@a_edi_flag = '3'  -- エラー
           -- ループ終了まで飛ばす
           GOTO LOOP_END_MST
        End
        -- ここで、マスタが存在する場合は、JAN訂正データとみなす。
        -- ・パラメータのJANを訂正後JANとする。
        -- ・既存JANをパラメータのJANに置き換える。
        If @a_exist_goods_id is not null 
			AND @a_exist_goods_type <> '31'	-- 追加:2019/07/24 - ECの文具を除く- MS-566 - コア
		Begin
			Set @a_jan_new = @a_jan
			Set @a_jan = @a_exist_jan_cd
        End
    End

	 -- 2019/08/15 THNNFS-16 既存のレコードの通信区分が「TS」の場合は更新しない Begin
	 IF @e20_tushin_id = 'TP' BEGIN
		IF EXISTS (SELECT TOP 1 gds_goods_id
					FROM wpt_goods_master
					WHERE gds_goods_id = @a_exist_goods_id AND gds_bookedi_cd = 'TS') BEGIN
		   -- エラー記録
           SELECT
              @a_edi_error_msg = 'TSの商品マスタ更新対象外です。'
             ,@a_edi_flag = '2'  -- エラー
           -- ループ終了まで飛ばす
           GOTO LOOP_END_MST
		END
	 End
	 -- 2019/08/15 THNNFS-16 既存のレコードの通信区分が「TS」の場合は更新しない End

       -- 商品マスタが既にある場合フラグセット
       -- 20070621 update
--       SET @e20_mst_update_flag = '0'
--       If Exists ( select top 1 *
-- 			 from wpt_goods_master
-- 			 where gds_jan_cd = @a_jan ) Begin
       If @a_exist_goods_id is not null Begin
           SET @e20_mst_update_flag = '1'   -- 20070621 add
       End

  -- 2009/12/09
  -- ゲームで、商品が存在する場合は警告扱いとし、JAN=NULLのマスタを生成する。
  If @a_goods_code_kubun = 'G' And @e20_mst_update_flag = '1' Begin
       -- エラー記録
       SELECT
          @a_edi_error_msg = 'JANコード重複'
             + ' JANコード=[' + isnull(@e20_game_jan_cd,'') + ']'
         ,@a_edi_flag = '2'  -- 警告
       -- JANをNULLに
       SET @e20_game_jan_cd = NULL
  End
  
  -- 2011/07/15 M.Nakano
  -- 書籍で商品が存在する場合は、既存データのCコードを取得
  If @e20_mst_update_flag = '1' And @a_exist_goods_type = '20' Begin
    SELECT
      @a_exist_c_code = gdb_c_code
    FROM wpt_goods_master_book
    WHERE gdb_goods_id = @a_exist_goods_id
    
    -- 既存が0000以外で更新が0000の場合は、更新データを既存と挿げ替える
    If @a_exist_c_code <> '0000' And @e20_c_code = '0000'
    Begin
      -- Cコード、分類再設定
      SELECT
        @e20_c_code = @a_exist_c_code
      , @a_media_id = dbo.F_Search_Book_Media(@a_exist_c_code,dbo.F_Convert_ISBN_Publisher(@e20_goods_code))
    End
  End

   -- 2009/05/12
   -- データがゲーム以外で、元々ある商品がゲームの場合は、マスタ更新しない
   If @a_goods_code_kubun <> 'G' And @a_exist_goods_type = '40'
     GOTO LOOP_END_MST_UPDATE
   -- 
   -- データがゲームで、元々ある商品が書籍、雑誌の場合は、マスタ更新しない
   If @a_goods_code_kubun = 'G' And @a_exist_goods_type in ('20', '21')
     GOTO LOOP_END_MST_UPDATE

      -- 2009/06/01
      -- マスタがある場合、商材区分と分類IDは仕入先のEDI区分により更新内容が変化する。
      If @a_exist_goods_id is not null Begin
        SELECT
            @a_goods_type = 
              case
                when @a_supplier_edi_type = '2' then -- 書籍EDIの場合
                  case
                    when @a_exist_goods_type in ('00', '20', '21') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                when @a_supplier_edi_type = '3' then -- ディスクEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '30', '31') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                when @a_supplier_edi_type = '4' then -- ゲームEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '40') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                else @a_goods_type
              end
          , @a_media_id = 
              case
                when @a_supplier_edi_type = '2' then -- 書籍EDIの場合
                  case
                    when @a_exist_goods_type in ('00', '20', '21') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                when @a_supplier_edi_type = '3' then -- ディスクEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '30', '31') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                when @a_supplier_edi_type = '4' then -- ゲームEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '40') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                else @a_media_id
              end
      End

      -- 商品マスタ作成処理  -- データがあればＩＤ取得もかねる
      Declare @a_param_plu_cd varchar(20)
      Declare @a_param_plu_type char(1)
      Declare @a_param_plu_addon_cd varchar(20)
      -- デフォ値
      SELECT
          @a_param_plu_cd = @a_jan
        , @a_param_plu_type = '0'
        , @a_param_plu_addon_cd = null
      -- ゲームでJANが付いていれば、plu_cdにゲームJANをセット
      If @a_goods_code_kubun = 'G' and isnull(@e20_game_jan_cd, '') <> ''
        Set @a_param_plu_cd = @e20_game_jan_cd
      -- ゲームでJANが付いていなければ、plu_typeにハウスコードの区分をセット
      If @a_goods_code_kubun = 'G' and isnull(@e20_game_jan_cd, '') = ''
        Set @a_param_plu_type = '2'
      -- ゲームだったら、@plu_addon_cdにハウスコードをセット
      If @a_goods_code_kubun = 'G'
        Set @a_param_plu_addon_cd = @a_goods_code
      --
	  -- 2020/05/11 MS-771  追加　Start
	  If @a_tushin_id in ('TP','TS') And
			Exists(SELECT gds_goods_id FROM wpt_goods_master WHERE gds_jan_cd = @a_param_plu_cd) Begin
		 Set @a_price = NULL
	  End
	  -- 2020/05/11 MS-771  追加　End
      -- 作成

      Exec @rc = P_Goods_Create 
           @goods_type   = @a_goods_type
          ,@plu_cd       = @a_param_plu_cd
          ,@plu_type     = @a_param_plu_type
          ,@goods_name   = @a_goods_name
          ,@tax_type     = @a_tax_type
          ,@price        = @a_price
          ,@price_type   = @a_price_type
          ,@plu_addon_cd = @a_param_plu_addon_cd
          ,@sp           = '1'  -- SP起動
          ,@update_price	= '1'  -- 2016/10/06 価格更新条件を追加する。
          ,@goods_id     = @a_goods_id OUTPUT
       -- エラーチェック
       If @rc <> 0 or @a_goods_id is null Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '商品マスタ生成エラー'
                + ' 商品コード=[' + isnull(@a_jan,'') + ']'
                + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
                + ',商品ＩＤ=[' + cast(isnull(@a_goods_id,'') AS varchar(20)) + ']'
                + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
            ,@a_edi_flag = '3'  -- エラー
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MST
       END
		-- 2009/09/17
		-- 書籍の場合は出版社マスタを作成。
		Declare @a_publisher_cd varchar(10)
		If @a_goods_code_kubun = '1' Begin
			SET @a_publisher_cd = ISNULL(dbo.F_Convert_ISBN_Publisher(@e20_goods_code), '')
			If @a_publisher_cd <> ''
				And Not Exists(select top 1 * from wpt_maker_publisher_master
					where mpb_publisher_cd = @a_publisher_cd) Begin
				INSERT INTO wpt_maker_publisher_master (
					mpb_publisher_cd
					,mpb_update_memo
					,mpb_publisher_name
					,mpb_publisher_kana
					,mpb_torihiki_cd
					,mpb_hachu_type
				)SELECT
					mpb_publisher_cd = @a_publisher_cd
					,mpb_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
					,mpb_publisher_name = @e20_publisher_name
					,mpb_publisher_kana = @e20_publisher_kana
					,mpb_torihiki_cd = @e20_torihiki_code
					,mpb_hachu_type = '1'  -- 自動発注ON
			End
		End

       -- CD/DVD/GAMEの場合は事前にlabel,salesマスタを作成。
       If @a_goods_code_kubun in ('5', 'G', '4') AND @a_tushin_id <> 'TS' Begin	-- 2012/10/22 update, 2019/07/31 THNNFS-31 mediastore_EDI開発（新規フォーマット）
		 -- 販売元マスタ更新
	     If Not Exists(select top 1 * from wpt_maker_sales_master
					where msm_sales_cd = @e20_cd_sales_cd ) Begin
	       INSERT INTO wpt_maker_sales_master (
			 msm_sales_cd
			,msm_update_memo
			) SELECT
			 msm_sales_cd = @e20_cd_sales_cd
			,msm_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
         End

		 -- レーベルマスタ更新
	     If Not Exists(select top 1 * from wpt_maker_label_master
					where mlm_label_cd = @e20_cd_label_cd ) Begin
	       INSERT INTO wpt_maker_label_master (
			 mlm_label_cd
			,mlm_update_memo
			,mlm_sales_cd
			) SELECT
			 mlm_label_cd = @e20_cd_label_cd
			,mlm_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,mlm_sales_cd = @e20_cd_sales_cd
         End Else Begin
	       If Not Exists(select top 1 * from wpt_maker_label_master
					  where mlm_label_cd = @e20_cd_label_cd
						and mlm_sales_cd = @e20_cd_sales_cd ) Begin
			UPDATE wpt_maker_label_master SET
			   mlm_update_date = getdate()
			  ,mlm_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
			  ,mlm_sales_cd = @e20_cd_sales_cd
			  where
			  mlm_label_cd = @e20_cd_label_cd
		   End
		 End
	   End
	   -- 2019/07/31 THNNFS-31 mediastore_EDI開発（新規フォーマット）Begin
	   IF @a_tushin_id = 'TS' BEGIN
	     SET @e20_cd_sales_cd = 'ETS_' + @e20_cd_sales_cd
		 SET @e20_cd_label_cd = 'ETS_' + @e20_cd_label_cd
		 -- 販売元マスタ更新
	     If Not Exists(select top 1 * from wpt_maker_sales_master
					where msm_sales_cd = @e20_cd_sales_cd ) Begin
	       INSERT INTO wpt_maker_sales_master (
			 msm_sales_cd
			,msm_update_memo
            ,msm_sales_name
			) SELECT
			 msm_sales_cd = @e20_cd_sales_cd
			,msm_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,msm_sales_name = @e20_writer_name
		 END ELSE BEGIN
		   UPDATE wpt_maker_sales_master SET
		      msm_sales_name = @e20_writer_name
		     ,msm_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
			 ,msm_update_date = getdate()
			 where
			  msm_sales_cd = @e20_cd_sales_cd
             END
		 -- レーベルマスタ更新
	     If Not Exists(select top 1 * from wpt_maker_label_master
					where mlm_label_cd = @e20_cd_label_cd ) BEGIN
	       INSERT INTO wpt_maker_label_master (
			 mlm_label_cd
			,mlm_update_memo
			,mlm_sales_cd
            ,mlm_label_name 
			) SELECT
			mlm_label_cd = @e20_cd_label_cd
			,mlm_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,mlm_sales_cd =  @e20_cd_sales_cd
			,mlm_label_name = @e20_writer_name
         End Else BEGIN
		   If Not Exists(select top 1 * from wpt_maker_label_master
					  where mlm_label_cd = @e20_cd_label_cd
						and mlm_sales_cd = @e20_cd_sales_cd ) BEGIN
			UPDATE wpt_maker_label_master SET
			   mlm_update_date = getdate()
			  ,mlm_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
			  ,mlm_sales_cd = @e20_cd_sales_cd
			  ,mlm_label_name = @e20_writer_name
			  where
			  mlm_label_cd = @e20_cd_label_cd
		   END
		 END
	   END -- 2020/05/20 MS-771 追加
	   -- 2019/07/31 THNNFS-31 mediastore_EDI開発（新規フォーマット）End

       -- マスタUPDATE
       --追加：20170612 - MS270 - Start
		IF @a_tushin_id <> 'D2' AND (SELECT top 1 gds_bookedi_cd FROM wpt_goods_master WHERE gds_goods_id = @a_goods_id) = 'D2' BEGIN
			GOTO LOOP_END_MST_UPDATE
		END
       --追加：20170612 - MS270 - End

     UPDATE wpt_goods_master SET
	 gds_update_date = getdate()
	,gds_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
	,gds_goods_name =
		case
		  when isnull(@a_goods_name,'') <> '' then @a_goods_name
		  else gds_goods_name
		end
	,gds_goods_ryaku = cast(@a_goods_name as varchar(50))
	,gds_goods_kana = 
		cast(@e20_goods_name_kana as varchar(100))
		  +
		case  -- 巻数を後ろに足す。
		  when  isnull(@e20_volume,0) = 0 then ''
		  when  len(@e20_volume) <> datalength(@e20_volume) then ''  -- 2バイト文字があったら無視
		  else ' ' + cast(@e20_volume as varchar)
		end
	,gds_goods_kana2 = 
		replace(
		cast(@e20_goods_name_kana as varchar(100))
		  +
		case  -- 巻数を後ろに足す。
		  when  isnull(@e20_volume,0) = 0 then ''
		  when  len(@e20_volume) <> datalength(@e20_volume) then ''  -- 2バイト文字があったら無視
		  else ' ' + cast(@e20_volume as varchar)
		end
		,' ','')   -- スペースをカット

	,gds_sales_date = 
		case   
	           -- ▼▼▼ 2015/04/06 add
		   WHEN @e20_tushin_id = 'EC' THEN gds_sales_date
        	   -- ▲▲▲ 2015/04/06 add
       -- ▼▼▼ 2013/08/20 add
		   -- when @a_goods_code_kubun = '1' and @e20_shupan_date = '0000' then gds_sales_date		-- 書誌で出版年月＝「0000」の場合は、更新しない。(2013/02/19 update)
		   when @e20_shupan_date = '0000' then gds_sales_date --「0000」が2000/1/1で解釈されるのであれば、すべての商材で更新しません。-- 2016/09/28 update
		   -- ▲▲▲ 2013/08/20 add
		   -- ▼▼▼ 2016/09/28 add
		   -- 雑誌で現状の発売日+9年　＜=　システム日付　AND　現状の発売日+9年　＜=　e20_shupan_date　の場合は更新
		   when @a_goods_code_kubun = '2' 
			   and DATEADD(YEAR, 9, gds_sales_date) <= @a_getdate_date
			   and DATEADD(YEAR, 9, gds_sales_date) <= dbo.F_Convert_TextDate_Date(@e20_shupan_date,@a_getdate_date)
			   then dbo.F_Convert_TextDate_Date(@e20_shupan_date,@a_getdate_date)
		   -- ▲▲▲ 2016/09/28 add      
		   when gds_sales_date is not null and gds_sales_update_flag = '1' then gds_sales_date  -- 送品で更新されていたら更新しない。
		   -- when @a_goods_code_kubun = '2' and gds_sales_date is not null then gds_sales_date -- 雑誌は既にセットされていたら更新しない。-- 2016/08/26 削除
		   -- when @a_goods_code_kubun = '2' and isnull(@e20_0souhin_flag,'0') = '1' then gds_sales_date  -- 0送品のマスタも対象外。	   -- 2016/08/26 削除
		   else isnull(dbo.F_Convert_TextDate_Date(@e20_shupan_date,@a_getdate_date),gds_sales_date)
		end 
	,gds_text_sales_date = 
		case 
	           -- ▼▼▼ 2015/04/06 add
		   WHEN @e20_tushin_id = 'EC' THEN gds_text_sales_date
        	   -- ▲▲▲ 2015/04/06 add
		   -- ▼▼▼ 2013/08/20 add
		   -- when @a_goods_code_kubun = '1' and @e20_shupan_date = '0000' then gds_text_sales_date		-- 書誌で出版年月＝「0000」の場合は、更新しない。(2013/02/19 update)
		   when @e20_shupan_date = '0000' then gds_text_sales_date		-- 「0000」が2000/1/1で解釈されるのであれば、すべての商材で更新しません。-- 2016/09/28 update
		   -- ▲▲▲ 2013/08/20 add
		   -- ▼▼▼ 2016/09/28 add
		   -- 雑誌で現状の発売日+9年　＜=　システム日付　AND　現状の発売日+9年　＜=　e20_shupan_date　の場合は更新
		   when @a_goods_code_kubun = '2' 
			   and DATEADD(YEAR, 9, gds_sales_date) <= @a_getdate_date
			   and DATEADD(YEAR, 9, gds_sales_date) <= dbo.F_Convert_TextDate_Date(@e20_shupan_date,@a_getdate_date)
			   then isnull(@e20_shupan_date,gds_text_sales_date)
		   -- ▲▲▲ 2016/09/28 add
		   when gds_text_sales_date is not null and gds_sales_update_flag = '1' then gds_text_sales_date  -- 送品で更新されていたら更新しない。		
		   -- when @a_goods_code_kubun = '2' and gds_text_sales_date is not null then gds_text_sales_date  -- 雑誌は既にセットされていたら更新しない。-- 2016/08/26 削除
		   -- when @a_goods_code_kubun = '2' and isnull(@e20_0souhin_flag,'0') = '1' then gds_text_sales_date  -- 0送品のマスタも対象外。			  -- 2016/08/26 削除
		   when @a_goods_code_kubun = 'G' then @e20_game_hatsubaibi_text  -- 2009/05/08 ゲーム用
		   else isnull(@e20_shupan_date,gds_text_sales_date)
		end
  -- ▼▼▼ 2016/09/28 add	
	-- 雑誌で現状の発売日+9年　＜=　システム日付　AND　現状の発売日+9年　＜=　e20_shupan_date　の場合は0に戻す
	-- 上記以外は更新しない
	,gds_sales_update_flag = 
		case
			when @a_goods_code_kubun = '2' 
			   and DATEADD(YEAR, 9, gds_sales_date) <= @a_getdate_date
			   and DATEADD(YEAR, 9, gds_sales_date) <= dbo.F_Convert_TextDate_Date(@e20_shupan_date,@a_getdate_date)
			   then '0'
			else
				gds_sales_update_flag
		end
	-- ▲▲▲ 2016/09/28 add     
	,gds_media_id = 
	  case
	    when @a_goods_code_kubun in ('5', 'G', '4') then  -- 2009/05/08 CD/GAME系だったら、分類IDを更新する	-- 2012/10/22 update
	      case 
	        when @a_media_id is not null then @a_media_id
	        else gds_media_id
	      end
	    else
		  case   -- 基準点更新の無いもののみ変更
		     when gds_media_id is null then @a_media_id
		     when gds_tana_media_update_flag = '0' and @a_media_id is not null then @a_media_id
		     else gds_media_id
		  End
	  end
	,gds_auto_hachu_flag = 
		   case
           -- 2019/07/31 THNNFS-31 mediastore_EDI開発（新規フォーマット） Begin
           -- 2019/09/11 THNNFS-132「TS」「TP」は1固定
		   when @a_tushin_id in ('TS','TP')
			 then '1'
		   -- 2019/07/31 THNNFS-31 mediastore_EDI開発（新規フォーマット） End
		   -- 新規のみ更新 20070621 update
		   when @e20_mst_update_flag = '0'
			 then isnull(mpb_hachu_type,'0')
		   else gds_auto_hachu_flag
		End
	,gds_bookedi_cd = @a_tushin_id  -- 20080201 add
	,gds_teiki_create_date =	-- 20080319 add
		case
		   when @a_tushin_id = 'NP'
			 and gds_teiki_create_date is null
			 and isnull(@e20_0souhin_flag,'0') = '0'  -- 0送品以外で作られたマスタが対象。
			 -- and gds_create_date > dateadd(mm,-1,getdate()) -- 最近できたもの
			 then getdate() 
		   else gds_teiki_create_date
		End
	,gds_jan_cd = 		-- 2009/05/08 add
		case 
			when @a_goods_code_kubun = 'G' And gds_jan_cd is null And isnull(@e20_game_jan_cd, '') <> ''
			  then @e20_game_jan_cd
			else isnull(@a_jan_new, gds_jan_cd) -- 2010/02/05
--			else isnull(isnull(@a_jan_new, @a_jan), gds_jan_cd) -- 2010/02/03
		end
	,gds_genre_cd = @a_genre_cd
	from
	  wpt_goods_master
            left outer join
	  wpt_goods_master_book
              on
              gds_goods_id = gdb_goods_id
            left outer join
	  wpt_maker_publisher_master
              on
              gdb_publisher_cd = mpb_publisher_cd
	where
	  gds_goods_id = @a_goods_id

       -- 書籍
       If @a_goods_code_kubun = '1' Begin
         -- マスタUPDATE
         UPDATE wpt_goods_master_book SET
	 gdb_goods_sub_name = @e20_goods_subname
	,gdb_goods_sub_kana = @e20_goods_subname_kana
	,gdb_writer_name = @e20_writer_name
	,gdb_writer_kana = @e20_writer_kana
	,gdb_series_name = @e20_series_name
	,gdb_series_kana = @e20_series_kana
	,gdb_c_code = isnull(@e20_c_code,'0000')
	,gdb_torihiki_cd = isnull(@e20_torihiki_code,gdb_torihiki_cd)
	,gdb_volume_name = @e20_volume_name
	,gdb_volume = @e20_volume
	,gdb_hangata = @e20_hangata
	,gdb_hannumber = @e20_hannumber
	,gdb_publisher_name = @e20_publisher_name

	,gdb_publisher_kana = @e20_publisher_kana
	,gdb_shinkan_type = @e20_shinkan_kubun
	,gdb_magazinecode_and_gatugo = @e20_magazinecode_and_gatugo
	,gdb_pagenumber_name = @e20_pagenumber_name
	,gdb_pagenumber = @e20_pagenumber
	,gdb_tate = @e20_tate
	,gdb_yoko = @e20_yoko
	,gdb_atusa = @e20_atusa

	,gdb_series_no_name = @e20_series_no_name
	,gdb_series_no = @e20_series_no
	,gdb_publish_type_name = @e20_publisher_type
	,gdb_publisher_district = @e20_publisher_district
	,gdb_comment = @e20_comment
	,gdb_comment_kana = @e20_comment_kana
	,gdb_contents_introduction = @e20_contents_introduction
	,gdb_kaikiri_type = @e20_kaikiri_kubun
	,gdb_teiban_type = @e20_teiban_kubun
	,gdb_joubi_type = @e20_joubi_kubun
	,gdb_hitubi_type = @e20_hitubi_kubun
	,gdb_kihontosyo_type = @e20_kihontosyo_kubun
	from
	  wpt_goods_master_book
	where
	  gdb_goods_id = @a_goods_id
      End

			-- 雑誌
			-- 出版社コードから出版社名引き当て更新する。
			If @a_goods_code_kubun = '2' Begin
				Declare @t_publisher_cd varchar(10)
				-- マスタUPDATE
				If @e20_publisher_name is null OR @e20_publisher_name = '' Begin 
					Set @e20_publisher_name = (SELECT top 1 mpb_publisher_name  FROM 
									wpt_maker_publisher_master
											Where
							mpb_torihiki_cd = @e20_torihiki_code );
					-- ▼▼▼ 2013/08/12 delete
					--Set @t_publisher_cd = (SELECT top 1 mpb_publisher_cd  FROM 
					--				wpt_maker_publisher_master
					--						Where
					--		mpb_torihiki_cd = @e20_torihiki_code );
					-- ▲▲▲ 2013/08/12 delete
				End
				-- ▼▼▼ 2013/08/12 add
				Set @t_publisher_cd = (SELECT top 1 mpb_publisher_cd  FROM 
								wpt_maker_publisher_master
										Where
									mpb_torihiki_cd = @e20_torihiki_code );
				-- ▲▲▲ 2013/08/12 add
				-- マスタUPDATE
				UPDATE wpt_goods_master_magazine SET
					gdz_series_name = @e20_series_name
					,gdz_series_kana = @e20_series_kana
					,gdz_torihiki_cd = isnull(@e20_torihiki_code,gdz_torihiki_cd)
					,gdz_hangata = @e20_hangata
					,gdz_hannumber = @e20_hannumber
					,gdz_publisher_cd = isnull(@t_publisher_cd,gdz_publisher_cd)
					,gdz_publisher_name = isnull(@e20_publisher_name,gdz_publisher_name)
					,gdz_publisher_kana = @e20_publisher_kana
				from
					wpt_goods_master_magazine
				where
					gdz_goods_id = @a_goods_id
					
			End

       -- ＣＤ・ＤＶＤ / GAME
       If @a_goods_code_kubun in ('5', 'G', '4') Begin	-- 2012/10/22 update
         -- マスタUPDATE
         UPDATE wpt_goods_master_disk SET
			 gdd_standard_number = @e20_cd_kikaku_bango
			,gdd_maker_name = null
			,gdd_artist_cd = null
			,gdd_artist_name = @e20_writer_name
			,gdd_artist_kana = @e20_writer_kana
			,gdd_label_cd = @e20_cd_label_cd
			,gdd_cd_genre_cd = @e20_cd_genre_cd
		--	,gdd_cd_hinshu_cd = substring(@e20_cd_hinshu_cd,1,2)
			,gdd_cd_hinshu_cd = @e20_cd_hinshu_cd
			,gdd_b_genre = @e20_b_genre
			,gdd_m_genre = @e20_m_genre
			,gdd_s_genre = @e20_s_genre
			from
			  wpt_goods_master_disk
			where
			  gdd_goods_id = @a_goods_id
		End
        If @@ERROR <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = 'マスタ更新エラー'
                  + ' cd=[' + isnull(@a_jan,'') + ']'
             ,@a_edi_flag = '3'  -- エラー
        End
	   -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）Begin
	   If @a_tushin_id = 'TP' Begin
         -- マスタUPDATE
         UPDATE wpt_goods_master_disk SET
			gdd_lot = @e20_lot
			from
			  wpt_goods_master_disk
			where
			  gdd_goods_id = @a_goods_id
       End

       If @@ERROR <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = 'マスタ更新エラー'
                  + ' cd=[' + isnull(@a_jan,'') + ']'
             ,@a_edi_flag = '3'  -- エラー
       End
	   -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）End

	   -- 2019/07/31 THNNFS-31 mediastore_EDI開発（新規フォーマット）Begin
	   If @a_tushin_id = 'TS' Begin
         -- マスタUPDATE
         UPDATE wpt_goods_master_disk SET
			gdd_lot = @e20_lot
		   ,gdd_ec_goods_cd = @e20_ec_goods_cd
		   ,gdd_regular_type = 0
			from
			  wpt_goods_master_disk
			where
			  gdd_goods_id = @a_goods_id
       End

       If @@ERROR <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = 'マスタ更新エラー'
                  + ' cd=[' + isnull(@a_jan,'') + ']'
             ,@a_edi_flag = '3'  -- エラー
       End
	   -- 2019/07/31 THNNFS-31 mediastore_EDI開発（新規フォーマット）End
	  
    LOOP_END_MST_UPDATE:  -- 商品マスタ更新処理終了


      -----------------------
      -- 定期購読自動予約
      -----------------------
      -- 最近新規登録された雑誌マスタが対象。
      If Not Exists ( SELECT top 1 *
			from
			  wpt_goods_master
			  join
			  wpt_goods_master_magazine
			    on
			    gds_goods_id = gdz_goods_id 
			where
			  gds_goods_id = @a_goods_id
			  and
			  gds_teiki_create_date > dateadd(ww,-2,getdate()) ) Begin
	GOTO LOOP_END_MST
      End
	
      -- 予約
      Exec @rc = P_Magazine_Yoyaku @goods_id = @a_goods_id
		,@sp = '1'
		,@all_count = @a_teiki_all_count OUTPUT
		,@all2_count = @a_teiki_all2_count OUTPUT
		,@ok_count = @a_teiki_ok_count OUTPUT
		,@ng_count = @a_teiki_ng_count OUTPUT
		,@skip_count = @a_teiki_skip_count OUTPUT
		,@err_msg  = @a_teiki_err_msg OUTPUT

      -- ログ 異常と登録分だけだす。正常はださない。
      If @rc <> 0 or isnull(@a_teiki_err_msg,'') <> '' or @a_teiki_all_count <> 0 Begin
        Set @log_msg =
             '定期予約 '
	+ ' id=[' +isnull(convert(varchar,@a_goods_id),'') + ']'
	+ ',jan=[' +isnull(convert(varchar,@a_jan),'') + ']'
	+ ',rc=[' +isnull(convert(varchar,@rc),'') + ']'
	+ ',all=[' +isnull(convert(varchar,@a_teiki_all_count),'') + ']'
	+ ',all2=[' +isnull(convert(varchar,@a_teiki_all2_count),'') + ']'
	+ ',ok=[' +isnull(convert(varchar,@a_teiki_ok_count),'') + ']'
	+ ',ng=[' +isnull(convert(varchar,@a_teiki_ng_count),'') + ']'
	+ ',sk=[' +isnull(convert(varchar,@a_teiki_skip_count),'') + ']'
	+ ',err=[' +isnull(convert(varchar(200),@a_teiki_err_msg),'') + ']'
        Exec P_LogMsg @log_msg
      End
      

      -- ループ終了ラベル
      LOOP_END_MST:

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_mst SET
            e20_edi_flag = @a_edi_flag
           ,e20_edi_error_msg = @a_edi_error_msg
           ,e20_edi_update_date = @a_getdate
         where
            e20_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@a_tax_type
	,@e20_tushin_id  -- ここから下は面倒なので全フィールド
	,@e20_goods_code_kubun
	,@e20_goods_code
	,@e20_goods_name
	,@e20_goods_name_kana
	,@e20_goods_subname
	,@e20_goods_subname_kana
	,@e20_writer_name
	,@e20_writer_kana
	,@e20_series_name
	,@e20_series_kana
	,@e20_c_code
	,@e20_torihiki_code
	,@e20_volume_name
	,@e20_volume
	,@e20_hangata
	,@e20_hannumber
	,@e20_publisher_name
	,@e20_publisher_kana
	,@e20_price
	,@e20_tax_type
	,@e20_tax_rate
	,@e20_shinkan_kubun
	,@e20_shun_kubun
	,@e20_shupan_date
	,@e20_juuhan_yotei_date
	,@e20_zepan_date
	,@e20_magazinecode_and_gatugo
	,@e20_magazine_year
	,@e20_set_kubun
	,@e20_pagenumber_name
	,@e20_pagenumber
	,@e20_tate
	,@e20_yoko
	,@e20_atusa
	,@e20_series_no_name
	,@e20_series_no
	,@e20_publisher_type
	,@e20_toritugi_stock_date
	,@e20_toritugi_stock
	,@e20_publisher_stock_date
	,@e20_publisher_stock
	,@e20_publisher_district
	,@e20_comment
	,@e20_comment_kana
	,@e20_contents_introduction
	,@e20_cd_kikaku_bango
	,@e20_cd_genre_cd
	,@e20_cd_hinshu_cd
	,@e20_cd_genka
	,@e20_kaikiri_kubun
	,@e20_teiban_kubun
	,@e20_joubi_kubun
	,@e20_hitubi_kubun
	,@e20_kihontosyo_kubun
	,@e20_b_genre
	,@e20_m_genre
	,@e20_s_genre
	,@e20_tohan_ac_cd
	,@e20_cd_label_cd
	,@e20_cd_sales_cd
	,@e20_magazinecode_and_hatubaibi
	,@e20_order_end_date
	,@e20_0souhin_flag
	,@e20_game_jan_cd
	,@e20_game_hatsubaibi_text
	,@e20_lot -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
	,@e20_ec_goods_cd -- 2019/07/23 THNNFS-16 mediastore_EDI開発（既存改修：MSP/AVSS）
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9002,銘柄データ同期エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9003,銘柄ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK


DOWN_MEIGARA_END:


--=================================================
-- 下り送品処理
--=================================================
DOWN_SOUHIN:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9010,送品サーバ情報セット不正'
    GOTO SP_ERR
  End

	-- ▼▼▼ 2013/06/07 add
		-- 仕入先「JDS」の仕入先IDを取得
		Declare @jds_suppiler_id int
		SELECT
			@jds_suppiler_id = mpm_supplier_id
		FROM
			wpt_maker_supplier_master WITH(NOLOCK)
		WHERE
			mpm_bookedi_cd = 'JD'
		-- 仕入先「NRC」の仕入先IDを取得
		Declare @nrc_suppiler_id int
		SELECT
			@nrc_suppiler_id = mpm_supplier_id
		FROM
			wpt_maker_supplier_master WITH(NOLOCK)
		WHERE
			mpm_bookedi_cd = 'NR'
	-- ▲▲▲ 2013/06/07 add
	-- ▼▼▼ 2014/06/24 add
		-- 仕入先「ソニー」の仕入先IDを取得
		Declare @sony_suppiler_id int
		SELECT
			@sony_suppiler_id = mpm_supplier_id
		FROM
			wpt_maker_supplier_master WITH(NOLOCK)
		WHERE
			mpm_bookedi_cd = 'SO'
	-- ▲▲▲ 2014/06/24 add

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_shn ('
	+ '	 e22_edi_flag'
	+ '	,e22_edi_timestamp'
	+ '	,e22_edi_id'
	+ '	,e22_edi_create_date'
	+ '	,e22_edi_update_date'
	+ '	,e22_edi_file_line_no'
	+ '	,e22_edi_meisai_no'
	+ '	,e22_edi_error_msg'
	+ '	,e22_server_webpos'
	+ '	,e22_dbname_webpos'
	+ '	,e22_shop_cd_webpos'
	+ '	,e22_shop_name_webpos'
	+ '	,e22_seq_no'
	+ '	,e22_shop_cd_primary'
	+ '	,e22_shop_cd'
	+ '	,e22_tushin_id'
	+ '	,e22_goods_shubetu'
	+ '	,e22_denpyo_date'
	+ '	,e22_nyuka_date'
	+ '	,e22_denpyo_no'
	+ '	,e22_line_no'
	+ '	,e22_goods_code_kubun'
	+ '	,e22_goods_code'
	+ '	,e22_zasshi_code_gou'
	+ '	,e22_zasshi_year'
	+ '	,e22_c_code'
	+ '	,e22_extax_price'
	+ '	,e22_intax_price'
	+ '	,e22_shoumi_rate'
	+ '	,e22_genka_price'
	+ '	,e22_goods_count'
	+ '	,e22_goods_count_sign'
	+ '	,e22_tax_type'
	+ '	,e22_tax_rate'
	+ '	,e22_kaikiri_kubun'
	+ '	,e22_souhin_jouken'
	+ '	,e22_set_kubun'
	+ '	,e22_set_goods_code_kubun'
	+ '	,e22_set_goods_code'
	+ '	,e22_set_goods_count'
	+ '	,e22_set_goods_count_sgin'
	+ '	,e22_shinkan_kubun'
	+ '	,e22_hatubai_date'
	+ '	,e22_seikyu_date'
	+ '	,e22_henpin_kigen_date'
	+ '	,e22_haihon_count'
	+ '	,e22_ketusoku'
	+ '	,e22_ketusoku_count'
	+ '	,e22_hasuu_count'
	+ '	,e22_jyuuryou'
	+ '	,e22_sokutou_count'
	+ '	,e22_sokuton'
	+ '	,e22_cd_kikaku_bango'
	+ '	,e22_cd_hinshu_cd'
	+ '	,e22_hachu_shop_cd'
	+ '	,e22_hachu_denpyo_no'
	+ '	,e22_hachu_line_no'
	+ '	,e22_dist_code'			-- 2012/05/15 add
	+ '	,e22_ecole_hinban'		-- 2014/01/10 add
	+ '	,e22_bikou'				-- 2014/10/31 add (ecole_goods_name)
	+ '	)'
	+ '	SELECT'
	+ '	 M.e22_edi_flag'
	+ '	,M.e22_edi_timestamp'
	+ '	,M.e22_edi_id'
	+ '	,M.e22_edi_create_date'
	+ '	,M.e22_edi_update_date'
	+ '	,M.e22_edi_file_line_no'
	+ '	,M.e22_edi_meisai_no'
	+ '	,M.e22_edi_error_msg'
	+ '	,M.e22_server_webpos'
	+ '	,M.e22_dbname_webpos'
	+ '	,M.e22_shop_cd_webpos'
	+ '	,M.e22_shop_name_webpos'
	+ '	,M.e22_seq_no'
	+ '	,M.e22_shop_cd_primary'
	+ '	,M.e22_shop_cd'
	+ '	,M.e22_tushin_id'
	+ '	,M.e22_goods_shubetu'
	+ '	,M.e22_denpyo_date'
	+ '	,M.e22_nyuka_date'
	+ '	,M.e22_denpyo_no'
	+ '	,M.e22_line_no'
	+ '	,M.e22_goods_code_kubun'
	+ '	,M.e22_goods_code'
	+ '	,M.e22_zasshi_code_gou'
	+ '	,M.e22_zasshi_year'
	+ '	,M.e22_c_code'
	+ '	,M.e22_extax_price'
	+ '	,M.e22_intax_price'
	+ '	,M.e22_shoumi_rate'
	+ '	,M.e22_genka_price'
	+ '	,M.e22_goods_count'
	+ '	,M.e22_goods_count_sign'
	+ '	,M.e22_tax_type'
	+ '	,M.e22_tax_rate'
	+ '	,M.e22_kaikiri_kubun'
	+ '	,M.e22_souhin_jouken'
	+ '	,M.e22_set_kubun'
	+ '	,M.e22_set_goods_code_kubun'
	+ '	,M.e22_set_goods_code'
	+ '	,M.e22_set_goods_count'
	+ '	,M.e22_set_goods_count_sgin'
	+ '	,M.e22_shinkan_kubun'
	+ '	,M.e22_hatubai_date'
	+ '	,M.e22_seikyu_date'
	+ '	,M.e22_henpin_kigen_date'
	+ '	,M.e22_haihon_count'
	+ '	,M.e22_ketusoku'
	+ '	,M.e22_ketusoku_count'
	+ '	,M.e22_hasuu_count'
	+ '	,M.e22_jyuuryou'
	+ '	,M.e22_sokutou_count'
	+ '	,M.e22_sokuton'
	+ '	,M.e22_cd_kikaku_bango'
	+ '	,M.e22_cd_hinshu_cd'
	+ '	,M.e22_hachu_shop_cd'
	+ '	,M.e22_hachu_denpyo_no'
	+ '	,M.e22_hachu_line_no'
	+ '	,M.e22_dist_code'			-- 2012/05/15 add
	+ '	,M.e22_ecole_hinban'		-- 2014/01/10 add
	+ '	,M.e22_bikou'				-- 2014/10/31 add (ecole_goods_name)
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_shn as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_shn as C'
	+ '                on M.e22_edi_id = C.e22_edi_id'
	+ '            where'
	+ '              C.e22_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e22_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e22_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e22_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9011,送品データ取得エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e22_tushin_id char (2)
  Declare @e22_goods_shubetu char (2)
  Declare @e22_denpyo_date char (8)
  Declare @e22_nyuka_date char (8)
  Declare @e22_denpyo_no varchar (100)
  Declare @e22_line_no int 
  Declare @e22_goods_code_kubun char (1)
  Declare @e22_goods_code varchar (20)
  Declare @e22_zasshi_code_gou char (7)
  Declare @e22_zasshi_year char (1)
  Declare @e22_c_code char (4)
  Declare @e22_extax_price money 
  Declare @e22_intax_price money 
  Declare @e22_shoumi_rate char (3)
  Declare @e22_genka_price money 
  Declare @e22_goods_count int 
  Declare @e22_goods_count_sign char (1)
  Declare @e22_tax_type char (1)
  Declare @e22_tax_rate decimal(5, 2)
  Declare @e22_kaikiri_kubun char (1)
  Declare @e22_souhin_jouken char (1)
  Declare @e22_set_kubun char (1)
  Declare @e22_set_goods_code_kubun char (1)
  Declare @e22_set_goods_code varchar (20)
  Declare @e22_set_goods_count int 
  Declare @e22_set_goods_count_sgin char (1)
  Declare @e22_shinkan_kubun char (1)
  Declare @e22_hatubai_date char (8)
  Declare @e22_seikyu_date char (8)
  Declare @e22_henpin_kigen_date char (8)
  Declare @e22_haihon_count int 
  Declare @e22_ketusoku int 
  Declare @e22_ketusoku_count int 
  Declare @e22_hasuu_count int 
  Declare @e22_jyuuryou int 
  Declare @e22_sokutou_count int 
  Declare @e22_sokuton int 
  Declare @e22_cd_kikaku_bango varchar (15)
  Declare @e22_cd_hinshu_cd varchar (10)
  -- GAMEの発注情報は、業務入庫にはセットしない(未対応)
  Declare @e22_hachu_shop_cd varchar (10)
  Declare @e22_hachu_denpyo_no varchar (10)
  Declare @e22_hachu_line_no int 
  Declare @e22_dist_code varchar(3)		-- 2012/05/15 add 
  Declare @e22_ecole_hinban varchar(20)	-- 2014/01/10 add
  Declare @e22_bikou varchar(100)		-- 2014/10/31 add (ecole_goods_name)

  Declare @e22_mst_update_flag char (1)   -- 20070117add
  Declare @a_seikyu_date datetime
  
  -- 2010/02/24
  Declare @tmp_shop_cd int
  Declare @a_doc_id int
  Declare @a_log_id int
  Declare @a_tana_cd varchar(10)
  SELECT
     @tmp_shop_cd = null
    ,@a_doc_id = null
    ,@a_log_id = null
    ,@a_tana_cd = null


  -- 一時テーブル読み込み
  Set @rs = cursor static for
      SELECT
	 e22_edi_id
	,e22_edi_file_line_no
	,e22_edi_meisai_no
	,e22_tushin_id
	,e22_goods_code_kubun
	,e22_goods_code
	,e22_tax_type
	,e22_shop_cd_webpos as e22_shop_cd_webpos_order
	,e22_denpyo_date as e22_denpyo_date_order
	,e22_denpyo_no as e22_denpyo_no_order
	,e22_line_no as e22_line_no_order
	,e22_set_kubun
	,e22_tushin_id  -- ここから下は面倒なので全フィールド
	,e22_goods_shubetu
	,e22_denpyo_date
	,e22_nyuka_date
	,e22_denpyo_no
	,e22_line_no
	,e22_goods_code_kubun
	,e22_goods_code
	,e22_zasshi_code_gou
	,e22_zasshi_year
	,e22_c_code
	,e22_extax_price
	,e22_intax_price
	,e22_shoumi_rate
	,e22_genka_price
	,e22_goods_count
	,e22_goods_count_sign
	,e22_tax_type
	,e22_tax_rate
	,e22_kaikiri_kubun
	,e22_souhin_jouken
	,e22_set_kubun
	,e22_set_goods_code_kubun
	,e22_set_goods_code
	,e22_set_goods_count
	,e22_set_goods_count_sgin
	,e22_shinkan_kubun
	,e22_hatubai_date
	,e22_seikyu_date
	,e22_henpin_kigen_date
	,e22_haihon_count
	,e22_ketusoku
	,e22_ketusoku_count
	,e22_hasuu_count
	,e22_jyuuryou
	,e22_sokutou_count
	,e22_sokuton
	,e22_cd_kikaku_bango
	,e22_cd_hinshu_cd
	,e22_hachu_shop_cd
	,e22_hachu_denpyo_no
	,e22_hachu_line_no
	,e22_dist_code			-- 2012/05/15 add
	,e22_ecole_hinban		-- 2014/01/10 add
	,e22_bikou				-- 2014/10/31 add (ecole_goods_name)
            from
              wbe_edibook_dw_shn
            where
              e22_edi_flag = '0'  -- 未処理
            order by
               e22_shop_cd_webpos_order
              ,e22_denpyo_date_order
              ,e22_denpyo_no_order
              ,e22_line_no_order


  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_file_line_no
	,@a_meisai_no
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@a_tax_type
	,@a_shop_cd
	,@a_denpyo_date
	,@a_denpyo_no
	,@a_line_no
	,@a_set_kubun
	,@e22_tushin_id  -- ここから下は面倒なので全フィールド
	,@e22_goods_shubetu
	,@e22_denpyo_date
	,@e22_nyuka_date
	,@e22_denpyo_no
	,@e22_line_no
	,@e22_goods_code_kubun
	,@e22_goods_code
	,@e22_zasshi_code_gou
	,@e22_zasshi_year
	,@e22_c_code
	,@e22_extax_price
	,@e22_intax_price
	,@e22_shoumi_rate
	,@e22_genka_price
	,@e22_goods_count
	,@e22_goods_count_sign
	,@e22_tax_type
	,@e22_tax_rate
	,@e22_kaikiri_kubun
	,@e22_souhin_jouken
	,@e22_set_kubun
	,@e22_set_goods_code_kubun
	,@e22_set_goods_code
	,@e22_set_goods_count
	,@e22_set_goods_count_sgin
	,@e22_shinkan_kubun
	,@e22_hatubai_date
	,@e22_seikyu_date
	,@e22_henpin_kigen_date
	,@e22_haihon_count
	,@e22_ketusoku
	,@e22_ketusoku_count
	,@e22_hasuu_count
	,@e22_jyuuryou
	,@e22_sokutou_count
	,@e22_sokuton
	,@e22_cd_kikaku_bango
	,@e22_cd_hinshu_cd
	,@e22_hachu_shop_cd
	,@e22_hachu_denpyo_no
	,@e22_hachu_line_no
	,@e22_dist_code			-- 2012/05/15 add
	,@e22_ecole_hinban		-- 2014/01/10 add
	,@e22_bikou				-- 2014/10/31 add (ecole_goods_name)

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin


      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み
       ,@a_goods_id = null
       ,@a_jan = null
       ,@a_price = null
       ,@a_genka = null
       -- 2009/02/27 業務区分セットをここに移動
       ,@a_work_type = 
           case
              --when @a_goods_code_kubun in ('5', 'G') then '0120'  -- DISK仕入 2009/05/15 GAME対応
              when @a_goods_code_kubun in ('4','5', 'G') then '0120'  -- 文具仕入れ　2014/3/5追加 DISK仕入 2009/05/15 GAME対応
              else '0121'  -- 書籍仕入
           End

      -- 取引先コード、EDI区分セット
      SELECT
          @a_supplier_id = mpm_supplier_id
        , @a_supplier_cd = mpm_supplier_cd
        , @a_supplier_edi_type = mpm_edi_type
      from
        wpt_maker_supplier_master
      where
        mpm_bookedi_cd = @a_tushin_id

     -- 2009/01/21
     -- この取引先から銘柄データを受信しているか
     SELECT
       @a_dw_mst_flag = bes_dw_mst_flag
       from
           wpt_book_edi_setting
       where
           bes_bookedi_cd = @a_tushin_id
           and bes_shop_cd = @a_shop_cd
     -- フランチャイズID取得
     SELECT
       @a_fran_id = shm_franchise_id
       from
           wpt_shop_master
       where
           shm_shop_cd = @a_shop_cd

-- ▼▼▼ 2014/10/31 add
      --エコール（インストアコード）設定（諸口）
      If @a_tushin_id = 'EC' and @e22_ecole_hinban = '00009999'  Begin
          SET @a_goods_code = '2099999999998'
      End
-- ▲▲▲ 2014/10/31 add

      -- コードチェック
      --2012/07/22
      --明文図書は[Null]['']を認める
      If ( @a_goods_code is null or rtrim(ltrim(@a_goods_code)) = '' ) And @a_tushin_id <> 'MB' Begin
      --If @a_goods_code is null or rtrim(ltrim(@a_goods_code)) = '' Begin
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- セット商品チェック
      If Not ( @a_set_kubun = '0' or @a_set_kubun = '2' ) Begin
          SET @a_goods_code = @a_tushin_id + '_SET_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- 書籍チェック
      If @a_goods_code_kubun = '1' and
         len(@a_goods_code) <> 10 Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- 雑誌チェック(新・旧)
      If @a_goods_code_kubun in ( '2', '8' ) and
         len(@a_goods_code) <> 7 and
         len(@a_goods_code) <> 5 Begin 
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- 対象外コードチェック（商品コード0の場合）
      If isnumeric(@a_goods_code) = 1 and 
         ( cast(ltrim(rtrim(@a_goods_code)) as bigint) = 0 ) Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- 太洋社支社コードチェック
      -- 雑誌で4文字以下
      If @a_goods_code_kubun = '2' and
           len(@a_goods_code) <= 4 Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- 栗田対象外コードチェック
      If ltrim(rtrim(@a_goods_code)) = '999999999'
         or ltrim(rtrim(@a_goods_code)) = '9999999999' Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

--      -- 社内コードチェック
--      If @a_goods_code_kubun = '6' Begin
--          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
--          -- 送品マスタ処理終了まで飛ばす
--          GOTO LOOP_END_SHN_MST
--      End
--
--      --2012/07/10
--      --西村書店コードチェック
--      If @a_tushin_id = 'NS' and @a_goods_code_kubun = '6' and @a_goods_code = '2013' Begin
--          SET @a_goods_code = '2002000005236'
--      End
--      Else Begin
--          -- 社内コードチェック
--          If @a_goods_code_kubun = '6' Begin
--              SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
--              -- 送品マスタ処理終了まで飛ばす
--              GOTO LOOP_END_SHN_MST
--          End
--      End
--
--      -- インストアコードチェック
--     If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
--		 and len(ltrim(rtrim(@a_goods_code))) = 13 Begin
--          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
--          -- 送品マスタ処理終了まで飛ばす
--          GOTO LOOP_END_SHN_MST
--      End
--
--    --2012/07/10
--     -- インストアコードチェック（西村書店除外）
--      If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
--         and len(ltrim(rtrim(@a_goods_code))) = 13 and @a_tushin_id <> 'NS' Begin
--          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
--          -- 送品マスタ処理終了まで飛ばす
--         GOTO LOOP_END_SHN_MST
--      End

      --2012/07/10
      --西村書店コードチェック
      If @a_tushin_id = 'NS' and @a_goods_code_kubun = '6' and @a_goods_code = '2013' Begin
          SET @a_goods_code = '2002000005236'
      End
      --2012/07/22
      --明文図書コードチェック
      Else If @a_tushin_id = 'MB' and @e22_goods_shubetu = '1' and @a_goods_code_kubun = '6' Begin
          SET @a_goods_code = '2002000004642'
      End
      --2012/08/10
      --八木書店コードチェック
      Else If @a_tushin_id = 'YG' and @a_goods_code_kubun = '6' and @a_goods_code = '91' Begin
          SET @a_goods_code = '2002000005236'
      End
      --2013/03/25
      --共栄図書コードチェック
      Else If @a_tushin_id= 'KY' and @a_goods_code_kubun = '6' and @a_goods_code = '7777777718' Begin
          SET @a_goods_code = '2002000004642'
      End
      Else If @a_tushin_id = 'KY' and @a_goods_code_kubun = '6' and @a_goods_code = '7777777726' Begin
          SET @a_goods_code = '2022000003386'
      End
      Else If @a_tushin_id = 'KY' and @a_goods_code_kubun = '6' and @a_goods_code = '7777777734' Begin
          SET @a_goods_code = '2002000005236'
      End
      -- 社内コードチェック
      ELSE If @a_goods_code_kubun = '6' Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      --2012/07/10
      -- インストアコードチェック（西村書店除外）
      --2012/07/22
      -- インストアコードチェック（明文図書除外）
      --2012/08/10
      -- インストアコードチェック（八木書店除外）
      --2012/09/20
      -- インストアコードチェック（TMWMSP除外）
      --2013/03/25
      -- インストアコードチェック（共栄図書除外）
      --2014/10/31
      -- インストアコードチェック（エコール諸口除外）
      If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
         and len(ltrim(rtrim(@a_goods_code))) = 13 and (@a_tushin_id <> 'NS' and @a_tushin_id <> 'MB' and @a_tushin_id <> 'YG' and @a_tushin_id <> 'TP'  and @a_tushin_id <> 'KY'  and @a_tushin_id <> 'EC') Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- 税区分チェック
      If @a_tax_type is null or rtrim(ltrim(@a_tax_type)) = '' Begin
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      ----------------------------
      -- マスタ作成処理
      ----------------------------
    -- 2009/05/08
    -- GAMEは商品マスタ有りき
    If @a_goods_code_kubun = 'G' Begin
      Exec @rc = P_PLU
                  @plu_cd = @a_goods_code
                 ,@plu_type = '1'
                 ,@shop_cd = @a_shop_cd
                 ,@sp = '1'
                 ,@gds_goods_id = @a_goods_id OUTPUT
                 ,@gds_jan_cd = @a_jan OUTPUT
                 ,@gds_media_id = @a_media_id OUTPUT
      If @rc <> 0 or @a_goods_id is null 
        -- 送品マスタ処理終了まで飛ばす
        GOTO LOOP_END_SHN_MST
    End
    Else Begin
      -- 雑誌コード作成用年４桁セット
      SELECT
          @a_zasshi_year = 
                case   -- 雑誌年号があればそれを優先。なれりば出版日
                   when isnull(@e22_zasshi_year,'') <> ''
                      then @e22_zasshi_year
                   when isnull(substring(@e22_hatubai_date,1,4),'') <> ''
                      then substring(@e22_hatubai_date,4,1)
                   when substring(@e22_hatubai_date,1,4) = '0000'
                      then substring(convert(varchar,getdate(),111),4,1)
                   else  substring(convert(varchar,getdate(),111),4,1)
                End

      -- JAN生成
      SELECT
          @a_jan =
            case
              when @a_goods_code_kubun = '1' then dbo.F_Create_BookJAN(@a_goods_code)
              when @a_goods_code_kubun = '2' 
                       and len(@a_goods_code) = 7 then dbo.F_Create_ZasshiJAN(@a_goods_code,@a_zasshi_year)
              when @a_goods_code_kubun = '2' 
                       and len(@a_goods_code) = 5 then dbo.F_Create_ZasshiJAN(@a_goods_code
                                                               + substring(@e22_hatubai_date,5,2)
                                                              ,@a_zasshi_year)
              when @a_goods_code_kubun = '8'  -- 旧
                       and len(@a_goods_code) = 7 then dbo.F_Create_OldZasshiJAN(@a_goods_code,@e22_extax_price)
              when @a_goods_code_kubun = '8'
                       and len(@a_goods_code) = 5 then dbo.F_Create_OldZasshiJAN(@a_goods_code
                                                               + substring(@e22_hatubai_date,5,2)
                                                              ,@e22_extax_price)

              else @a_goods_code
            End

      If isnull(@a_jan,'') = '' Begin
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_SHN_MST
      End

      -- 2009/06/01
      -- P_PLUで商品存在チェックを行なう
      SET @e22_mst_update_flag = '0'
      SET @a_exist_goods_id = null
      SET @a_exist_goods_type = null
      SET @a_exist_goods_media_id = null
      -- 2010/03/19 M.Nakano
	  -- 取次がエコールの場合は、エコール品番で検索
      -- ▼▼▼ 2015/04/06 update
	  -- 取次がエコールの場合でも、ＪＡＮコードで検索
          Exec @rc = P_PLU
               @plu_cd = @a_jan
              ,@plu_type = '0'
              ,@sp = '1'
              ,@gds_goods_id = @a_exist_goods_id OUTPUT
              ,@gds_goods_type = @a_exist_goods_type OUTPUT
              ,@gds_media_id = @a_exist_goods_media_id OUTPUT
	  -- IF ( @e22_tushin_id = 'EC' ) BEGIN
	  -- 	  Exec @rc = P_PLU
	  -- 			 @plu_cd = @e22_ecole_hinban
	  -- 			,@plu_type = '1'
	  -- 			,@sp = '1'
	  -- 			,@gds_goods_id = @a_exist_goods_id OUTPUT
	  -- 			,@gds_goods_type = @a_exist_goods_type OUTPUT
	  -- 			,@gds_media_id = @a_exist_goods_media_id OUTPUT
	  -- END ELSE BEGIN
	  -- 	  Exec @rc = P_PLU
	  -- 			 @plu_cd = @a_jan
	  -- 			,@plu_type = '0'
	  -- 			,@sp = '1'
	  -- 			,@gds_goods_id = @a_exist_goods_id OUTPUT
	  -- 			,@gds_goods_type = @a_exist_goods_type OUTPUT
	  -- 			,@gds_media_id = @a_exist_goods_media_id OUTPUT
	  -- END
      -- ▲▲▲ 2015/04/06 update
	  
      -- エラーチェック
      If @rc <> 0 Begin
         -- エラー記録
         SELECT
            @a_edi_error_msg = '商品マスタ検索エラー'
               + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
               + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
               + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
           ,@a_edi_flag = '3'  -- エラー
         -- ループ終了まで飛ばす
         GOTO LOOP_END_SHN_MST
      End
      
      -- 商品マスタがる場合はフラグセット。
      -- 20070118 update
--      SET @e22_mst_update_flag = '0'
--      If Exists ( select top 1 *
--                  from wpt_goods_master
--                  where gds_jan_cd = @a_jan ) Begin
      -- 2009/06/01
      If @a_exist_goods_id is not null Begin
        SET @e22_mst_update_flag = '1'   -- 20070117 add
      End
   
      -- 2011/07/15 M.Nakano
      -- 書籍で商品が存在する場合は、既存データのCコードを取得
      If @e22_mst_update_flag = '1' And @a_exist_goods_type = '20' Begin
        SELECT
          @a_exist_c_code = gdb_c_code
        FROM wpt_goods_master_book
        WHERE gdb_goods_id = @a_exist_goods_id
        
        -- 既存が0000以外で更新が0000の場合は、更新データを既存と挿げ替える
        If @a_exist_c_code <> '0000' And @e20_c_code = '0000'
        Begin
          -- Cコード設定
          SELECT
            @e22_c_code = @a_exist_c_code
        End
      End
     
      -- データセット
      SELECT
        @a_tax_type = isnull(@e22_tax_type,'0')  -- デフォルト外税
      , @a_price_type = '0'  -- 税抜固定
      , @a_price = isnull(cast(@e22_extax_price as int),0)
      , @a_goods_type = 
          case
            when @a_goods_code_kubun = '1' then '20'
            when @a_goods_code_kubun = '2' then '21'
            when @a_goods_code_kubun = '5' then '30'  -- 2009/01/22 CD対応
            when @a_goods_code_kubun = '4' then '31'  -- 2014/3/5 文具対応
            else '00'
          end
      , @a_media_id = 
          case
            when @a_goods_code_kubun = '1' then
              dbo.F_Search_Book_Media(isnull(@e22_c_code,'0000'),dbo.F_Convert_ISBN_Publisher(@e22_goods_code))
            when @a_goods_code_kubun = '2' then 
              dbo.F_Search_Book_Media(substring(@e22_goods_code,1,1),null)
            else null
          end

      -- 2009/06/01
      -- マスタがある場合、商材区分と分類IDは仕入先のEDI区分により更新内容が変化する。
      If @a_exist_goods_id is not null Begin
        SELECT
            @a_goods_type = 
              case
                when @a_supplier_edi_type = '2' then -- 書籍EDIの場合
                  case
                    when @a_exist_goods_type in ('00', '20', '21') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                when @a_supplier_edi_type = '3' then -- ディスクEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '30', '31') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                when @a_supplier_edi_type = '4' then -- ゲームEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '40') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                else @a_goods_type
              end
          , @a_media_id = 
              case
                when @a_supplier_edi_type = '2' then -- 書籍EDIの場合
                  case
                    when @a_exist_goods_type in ('00', '20', '21') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                when @a_supplier_edi_type = '3' then -- ディスクEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '30', '31') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                when @a_supplier_edi_type = '4' then -- ゲームEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '40') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                else @a_media_id
              end
      End

      -- 2009/01/21
      -- 下り銘柄処理対象の取引先であれば、共通商品マスタを生成・更新
      If @a_dw_mst_flag = '1' Begin

        -- 商品マスタ作成処理  -- データがあればＩＤ取得もかねる
		-- ADD: 2018/10/25 - IF条件 - コア - Start
		If @e22_mst_update_flag = '1' AND @a_tushin_id = 'EC' Begin
			Exec @rc = P_Goods_Create
				 @goods_type = @a_goods_type
				,@plu_cd     = @a_jan
				,@plu_type   = '0' 
				,@tax_type   = @a_tax_type
				,@sp         = '1'  -- SP起動
				,@goods_id   = @a_goods_id OUTPUT
		End
		-- ADD: 2018/10/25 - IF条件 - コア - End
		Else
			Begin
				Exec @rc = P_Goods_Create
				 @goods_type = @a_goods_type
				,@plu_cd     = @a_jan
				,@plu_type   = '0' 
	--            ,@goods_name = @a_goods_name
				,@tax_type   = @a_tax_type
				,@price      = @a_price
				,@price_type = @a_price_type
				,@sp         = '1'  -- SP起動
				,@goods_id   = @a_goods_id OUTPUT
			End
        

         -- エラーチェック
         If @rc <> 0 or @a_goods_id is null Begin
            -- 送品マスタ処理終了まで飛ばす
            GOTO LOOP_END_SHN_MST
         End

         -- マスタUPDATE
         UPDATE wpt_goods_master SET
           gds_update_date = getdate()
          ,gds_update_memo = object_name(@@PROCID) + '[shn]' + '[' + isnull(@a_tushin_id,'') +  ']'
          ,gds_media_id = 
            case   -- 新規で、基準点更新の無いもののみ変更→基準点更新の無いもののみ変更
             when @a_goods_code_kubun = '1' and isnull(@e22_c_code,'0000')='0000' and gds_media_id is not null then gds_media_id  --20081208
             when gds_tana_media_update_flag = '0' and @a_media_id is not null then isnull(@a_media_id,gds_media_id)
             else gds_media_id
            End
          ,gds_auto_hachu_flag = 
            case   -- 新規のみ更新 20070117 update
             when @e22_mst_update_flag = '0' then isnull(mpb_hachu_type,'0')
             else gds_auto_hachu_flag
            End
/* 2012/03/07 送品データでの発売日更新を止める
          ,gds_sales_date = 
            case   -- 古い日付を発売日とする。
             when @a_goods_code_kubun = '1' and gds_sales_update_flag = '0' -- 書籍は伝票日で無条件更新。
               and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
             when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
             when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
             else gds_sales_date
            End
          ,gds_sales_update_flag = 
            case   -- 古い日付を発売日とする。
             when @a_goods_code_kubun = '1' and gds_sales_update_flag = '0' -- 書籍は伝票日で無条件更新。
               and isnull(@e22_goods_count,0) > 0 then '1'   -- フラグON
             when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then '1'   -- フラグON
             when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then '1'   -- フラグON
             else gds_sales_update_flag
            End
*/
		   -- ▼▼▼ 2013/08/20 add
          ,gds_sales_date = 
            case   -- 古い日付を発売日とする。
--             when @a_goods_code_kubun = '1' and gds_sales_update_flag = '0' -- 書籍は伝票日で無条件更新。
--			        and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)  
             -- ▼▼▼ 2015/04/06 add
             WHEN @e22_tushin_id = 'EC' THEN gds_sales_date
             -- ▲▲▲ 2015/04/06 add
             when @a_goods_code_kubun = '1' and gds_sales_update_flag = '0' -- 書籍は初回入荷で、登録済みの発売年月と、入荷年月が同時の場合に入荷年月を更新		2012/08/27 add
					and Year(gds_sales_date) = Year(dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date))
			        and Month(gds_sales_date) = Month(dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date))
			        and isnull(@e22_goods_count,0) > 0 
                  then dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
		     when gds_sales_date is null		-- 発売日未セットは伝票日で無条件更新	2011/11/30 add
			   and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
 		   -- ▼▼▼ 2013/11/26 update
--            when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
--               and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
--             when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
--               and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
            when @a_goods_code_kubun = '1' and gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
             when @a_goods_code_kubun = '1' and gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
		   -- ▲▲▲ 2013/11/26 update
             else gds_sales_date
            End
          ,gds_sales_update_flag = 
            case   -- 古い日付を発売日とする。
             -- ▼▼▼ 2015/04/06 add
	     WHEN @e22_tushin_id = 'EC' THEN gds_sales_update_flag
             -- ▲▲▲ 2015/04/06 add
             when @a_goods_code_kubun = '1' and gds_sales_update_flag = '0' -- 書籍は伝票日で無条件更新。
               and isnull(@e22_goods_count,0) > 0 then '1'   -- フラグON
		     when gds_sales_date is null		-- 発売日未セットは伝票日で無条件更新	2011/11/30 add
			   and isnull(@e22_goods_count,0) > 0 then '1'   -- フラグON
             when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_denpyo_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then '1'   -- フラグON
             when gds_sales_date > dbo.F_Convert_TextDate_Date(@e22_hatubai_date,@a_getdate_date)
               and isnull(@e22_goods_count,0) > 0 then '1'   -- フラグON
             else gds_sales_update_flag
            End
		   -- ▲▲▲ 2013/08/20 add
          ,gds_bookedi_cd = @a_tushin_id  -- 20080201 add
         from
            wpt_goods_master
          left outer join
            wpt_goods_master_book
          on gds_goods_id = gdb_goods_id
          left outer join
            wpt_maker_publisher_master
          on gdb_publisher_cd = mpb_publisher_cd
         where
          gds_goods_id = @a_goods_id
  
         -- 書籍
         If @a_goods_code_kubun = '1' Begin
           -- マスタUPDATE
           UPDATE wpt_goods_master_book SET
             gdb_c_code = 
               case   -- 書籍でC_Codeがなかったら更新しない。
                 when @a_goods_code_kubun = '1' and isnull(@e22_c_code,'0000')='0000' and gdb_c_code is not null then gdb_c_code  --20081208
                 else isnull(@e22_c_code,'0000')
               End
            ,gdb_publisher_cd = dbo.F_Convert_ISBN_Publisher(gdb_isbn)
            ,gdb_magazinecode_and_gatugo = @e22_zasshi_code_gou
           from
             wpt_goods_master_book
           where
             gdb_goods_id = @a_goods_id
         End
      End
      Else Begin
        -- 2009/02/09
        -- 下り銘柄処理のない取引先の場合
        -- 商品ID取得
        SELECT
          @a_goods_id = gds_goods_id
        from
          wpt_goods_master
        where 
          gds_jan_cd = @a_jan

      End
    End
-- 2009/01/27
-- 店舗独自マスタは作らなくてもよくなった。
/*
   Else Begin
   -- 下り銘柄処理のない取引先の場合は、店舗独自マスタを作る。
   -- ※CD系のみ
     If @e22_goods_code_kubun = '5' Begin

        -- 商品マスタがない場合は店舗独自マスタ生成
        -- ※共通もグループ共通も店舗独自もない場合
        If Not Exists ( select top 1 *
              from wpt_shop_goods_master
              where sgd_jan_cd = @a_jan
                and sgd_franchise_id = @a_fran_id 
                and (sgd_shop_cd = 0 or sgd_shop_cd = @a_shop_cd) ) And @e22_mst_update_flag = '0' Begin
  
            -- 商品マスタ作成処理  -- データがあればＩＤ取得もかねる
            Exec @rc = P_Goods_Create
                 @goods_type = @a_goods_type
                ,@plu_cd     = @a_jan
                ,@plu_type   = '0' 
                ,@tax_type   = @a_tax_type
                ,@price      = @a_price
                ,@price_type = @a_price_type
                ,@shop_cd    = @a_shop_cd
                ,@sp         = '1'  -- SP起動
                ,@goods_id   = @a_goods_id OUTPUT
      
            -- エラーチェック
            If @rc <> 0 or @a_goods_id is null Begin
                -- 送品マスタ処理終了まで飛ばす
                GOTO LOOP_END_SHN_MST
            End
           
            -- 共通商品マスタ更新
            UPDATE wpt_goods_master SET
              gds_update_date = getdate()
              ,gds_update_memo = object_name(@@PROCID) + '[shn]' + '[' + isnull(@a_tushin_id,'') +  ']'
            
            -- 店舗独自CDマスタ更新
            UPDATE wpt_shop_goods_master_disk set
                 sdd_standard_number = @e22_cd_kikaku_bango
                ,sdd_cd_hinshu_cd = @e22_cd_hinshu_cd
              from
                wpt_shop_goods_master_disk
              where
                 sdd_goods_id = @a_goods_id
                 and sdd_franchise_id = @a_fran_id
                 and sdd_shop_cd = @a_shop_cd
        End

     End
   End
*/   
      LOOP_END_SHN_MST:

      ----------------------------
      -- 送品処理
      ----------------------------

      -- ラインＮｏ再採番
      SELECT
	@a_line_no = isnull(max(ddn_line_no),0) + 1
            from
               wpt_document with(nolock)
	     join
               wpt_document_nyuko with(nolock)
	       on
	       doc_doc_id = dnk_doc_id
	     join
               wpt_document_nyuko_details with(nolock)
	       on
	       dnk_doc_id = ddn_doc_id
            where
               doc_work_type = @a_work_type  -- 2009/02/09
--               doc_work_type = '0121'
	     and
               doc_shop_cd = @a_shop_cd
               and
               isnull(dnk_supplier_id,0) = isnull(@a_supplier_id,0)
               and
               isnull(dnk_denpyo,'') = isnull(@a_denpyo_no,'')
               and
               dnk_denpyo_date = @a_denpyo_date
               and
               ddn_line_no_eda = 0
			-- ▼▼▼ 2013/06/07 add
				-- 仕入先「JDS、NRC」はディストリビューションコードまでチェック、以外は伝票番号＋伝票日付でチェック
				and
				IsNull(dnk_dist_cd,'') =
					case
	-- ▼▼▼ 2014/06/24 update
	--			when dnk_supplier_id = @jds_suppiler_id Or dnk_supplier_id = @nrc_suppiler_id then isnull(@e22_dist_code,'')
				when dnk_supplier_id = @jds_suppiler_id Or dnk_supplier_id = @nrc_suppiler_id Or dnk_supplier_id = @sony_suppiler_id then isnull(@e22_dist_code,'')
	-- ▲▲▲ 2014/06/24 update
						else IsNull(dnk_dist_cd,'')
					end
			-- ▲▲▲ 2013/06/07 add

      -- 原価セット(四捨五入まるめ)
-- ▼▼▼ 2014/10/31 delete
--    SELECT
--	@a_genka = 
--		round(
--	           case
--	             when @e22_genka_price is not null then @e22_genka_price
--	             when isnull(@e22_shoumi_rate,'999') = '999' then isnull(@a_price,0)
--	             when isnumeric(@e22_shoumi_rate) = 1 then isnull(@a_price,0) * ( cast(@e22_shoumi_rate as money) / 10 ) / 100
--	             else isnull(@a_price,0)
--		 end
--		,0)
-- ▲▲▲ 2014/10/31 delete

-- ▼▼▼ 2014/10/31 add
	IF ( @e22_tushin_id = 'EC' ) BEGIN		-- エコールの場合、原価を四捨五入でまるめない
		SELECT
			@a_genka = 
				case
					when @e22_genka_price is not null then @e22_genka_price
					when isnull(@e22_shoumi_rate,'999') = '999' then isnull(@a_price,0)
					when isnumeric(@e22_shoumi_rate) = 1 then isnull(@a_price,0) * ( cast(@e22_shoumi_rate as money) / 10 ) / 100
					else isnull(@a_price,0)
				end
	END
	ELSE BEGIN
		SELECT
			@a_genka = 
			round(
				case
					when @e22_genka_price is not null then @e22_genka_price
					when isnull(@e22_shoumi_rate,'999') = '999' then isnull(@a_price,0)
					when isnumeric(@e22_shoumi_rate) = 1 then isnull(@a_price,0) * ( cast(@e22_shoumi_rate as money) / 10 ) / 100
					else isnull(@a_price,0)
				end
			,0)
	END
-- ▲▲▲ 2014/10/31 add

      SELECT
	 @P01 = ''
		+ '0002.0001'     -- パラメタ受け渡しバージョン
		+ ',' + object_name(@@PROCID) + '_' + @edi_type     -- アプリケーションバージョン
		+ ',' + cast(@a_shop_cd as varchar)                        -- 店舗コード
--		+ ',0121'                                                            -- 業務区分
		+ ',' + @a_work_type                                                 -- 2009/01/22
		+ ',0'                                                                 -- 伝票区分
		+ ',0'                                                                 -- POS番号
		+ ',' + convert(varchar,
			case
		           when isdate(@a_denpyo_date) = 1 then cast(@a_denpyo_date as datetime)
		           else 0
		         end
		         ,120)                                                        -- 取引日
		+ ',' + convert(varchar,getdate(),120)                    -- ＰＯＳ取引日時
		+ ','                                                                  -- レシート番号
		+ ','                                                                  -- 担当ＩＤ
		+ ','                                                                  -- 担当コード
		+ ','                                                                  -- 会員ＩＤ
		+ ','                                                                  -- 会員コード
		+ ','                                                                  -- 会員カードコード
		+ ',' + cast(@a_shop_cd as varchar)                       -- 操作店舗コード
		+ ','                                                                  -- 紐付け元取引ＩＤ
		+ ','                                                                  -- 紐付け元業務区分
		+ ','                                                                  -- 追加処理用取引ＩＤ
		+ ',0'                                                                -- 再登録フラグ
	,@P02 = ''
		+ '0'                                                                -- 取引区分
		+ ',' + isnull(cast(@a_supplier_id as varchar),'')        -- 仕入先ID
		+ ',' + isnull(@a_supplier_cd,'')                              -- 仕入先コード 
		+ ','                                                                 -- 出庫元店舗コード
		+ ',' + isnull(@a_denpyo_no,'')                               -- 伝票番号
		+ ',' + convert(varchar,
			case
		           when isdate(@a_denpyo_date) = 1 then cast(@a_denpyo_date as datetime)
		           else 0
		         end
		         ,120)                                                       -- 伝票日付
		+ ',0'                                                                -- 伝票区分
		+ ',0'                                                                -- 梱包分けフラグ
		+ ',' + isnull(@a_tushin_id,'')                                  -- 書籍ＥＤＩコード
		+ ',' + isnull(@e22_dist_code,'')                         -- ディストリビューションコード	-- 2012/05/15 add
	,@P03 = ''
		+ cast(isnull(@a_line_no,1) as varchar)                   -- 明細番号
		+ ',0'                                                                -- 明細番号 枝番
		+ ',0'                                                                -- 明細区分 
		+ ',0'                                                                -- 新中区分
		+ ',' + isnull(cast(@a_goods_id as varchar),'')           -- 商品ID
		+ ','                                                                  -- 商品コード
		+ ',' + isnull(@a_jan,'')                                          -- JAN
		+ ','                                                                  -- 商品名

-- ▼▼▼ 2014/10/31 add
			  + CASE
					WHEN @e22_tushin_id = 'EC' and @e22_ecole_hinban = '00009999' 
					THEN isnull(@e22_bikou,'')							-- ecole_goods_name
					ELSE ''
				END
-- ▲▲▲ 2014/10/31 add

		+ ',' + isnull(@a_tax_type,'')                                   -- 税区分

-- ▼▼▼ 2014/10/31 add
--		+ ',' + isnull(cast(@a_price as varchar),'0')              -- 標準売価 -- 2014/10/31 delete
		+ ',' + CASE
					WHEN @e22_tushin_id = 'EC' and @e22_ecole_hinban = '00009999' 
					THEN '0'
					ELSE isnull(cast(@a_price as varchar),'0')
				END
-- ▲▲▲ 2014/10/31 add

-- ▼▼▼ 2014/10/31 add
			                                                             -- 標準原価
--		+ ',' + isnull(cast(cast(@a_genka as int) as varchar),'0')		 -- 2014/10/31 delete
		+ ',' + CASE
					WHEN @e22_tushin_id = 'EC' 
					THEN isnull(cast(cast(@a_genka as money) as varchar),'0')
					ELSE isnull(cast(cast(@a_genka as int) as varchar),'0')
				END
-- ▲▲▲ 2014/10/31 add

-- ▼▼▼ 2014/10/31 add
--		+ ',' + isnull(cast(@a_price as varchar),'0')              -- 売価 -- 2014/10/31 delete
		+ ',' + CASE
					WHEN @e22_tushin_id = 'EC' and @e22_ecole_hinban = '00009999' 
					THEN '0'
					ELSE isnull(cast(@a_price as varchar),'0')
				END
-- ▲▲▲ 2014/10/31 add

-- ▼▼▼ 2014/10/31 add
--		+ ',' + isnull(cast(cast(@a_genka as int) as varchar),'0')		 -- 2014/10/31 delete
			                                                             -- 原価
		+ ',' + CASE
					WHEN @e22_tushin_id = 'EC' 
					THEN isnull(cast(cast(@a_genka as money) as varchar),'0')
					ELSE isnull(cast(cast(@a_genka as int) as varchar),'0')
				END
-- ▲▲▲ 2014/10/31 add

		+ ',' + cast(
			case
		           when @e22_goods_count_sign = '-' then isnull(@e22_goods_count,0) * -1
		           else isnull(@e22_goods_count,0)
		         end
		        as varchar)					 -- 送品数
		+ ','                                                                  -- 倉庫コード
		+ ',' + isnull(@e22_souhin_jouken,'')                       -- 送品条件
		+ ',' + isnull(@a_goods_code,'')                               -- 送品元商品コード
-- 2012/12/14 add 正味率
		+ ',' + 
			Case
				When isnumeric(@e22_shoumi_rate) = 1
					Then cast(
							cast(@e22_shoumi_rate as decimal(5,2)) / 10
						as varchar)
					Else ''
			End

      -- SPキック
      Exec @rc = P_Transaction
	 @P01 = @P01
	,@P02 = @P02
	,@P03 = @P03
	,@SP  = '1'
	,@err_msg = @err_msg OUTPUT
	,@out_doc_id = @a_doc_id OUTPUT  -- 2010/02/24

      -- エラーチェック
      If @rc <> 0 Begin
        -- エラー記録
        SELECT
           @a_edi_error_msg = '処理ＳＰエラー'
               + ',m=[' + isnull(@err_msg,'') + ']'
               + ',@P01=[' + isnull(@P01,'') + ']'
               + ',@P02=[' + isnull(@P02,'') + ']'
               + ',@P03=[' + isnull(@P03,'') + ']'
          ,@a_edi_flag = '3'  -- エラー
      End

	----------------------------
	-- ロケーション設定処理
	----------------------------
	GOODS_LOCATION_SET:
	If @a_goods_id is not null Begin
		Set @a_tana_cd = null -- 2010/03/26
		-- 対象商品にロケーション設定がない場合のみ
		If Exists(
			SELECT lcs_tana_cd
			FROM wpt_location_setting
			WHERE lcs_franchise_id=@a_fran_id
					AND lcs_shop_cd=@a_shop_cd
					AND lcs_goods_id=@a_goods_id
			) Begin
			-- 設定があるのでスキップ
			GOTO GOODS_LOCATION_SET_END
		End
		-- メディア→ロケーション設定がある場合のみ
		SELECT @a_tana_cd=lmc_tana_cd
		FROM wpt_location_media_convert
		WHERE lmc_shop_cd=@a_shop_cd
				AND lmc_media_cd=(SELECT gdm_media_cd
					FROM wpt_goods_media_master
					WHERE gdm_media_id=(SELECT gds_media_id FROM wpt_goods_master WHERE gds_goods_id=@a_goods_id))
		
		If @a_tana_cd is null Begin
			-- 設定がないのでスキップ
			GOTO GOODS_LOCATION_SET_END
		End
		
		-- ロケーション追加処理(メイン)
		INSERT INTO wpt_location_setting
			(lcs_franchise_id, lcs_shop_cd, lcs_goods_id, lcs_tana_cd, lcs_tana_type, lcs_update_memo)
		VALUES(@a_fran_id, @a_shop_cd, @a_goods_id, @a_tana_cd, '1', object_name(@@PROCID) + '[shn]' + '[' + isnull(@a_tushin_id,'') +  ']')
		
-- ▼▼▼ 2013/11/26 delete
--		-- ロケーション追加記録
--		SELECT
--		@P01 = ''
--			+ '0002.0001'     -- パラメタ受け渡しバージョン
--			+ ',' + object_name(@@PROCID) + '_' + @edi_type   -- アプリケーションバージョン
--			+ ',' + cast(@a_shop_cd as varchar)               -- 店舗コード
--			+ ',0540'                                         -- 業務区分
--			+ ',0'                                            -- 伝票区分
--			+ ',0'                                            -- POS番号
--			+ ',' + convert(varchar,
--						case
--							when isdate(@a_denpyo_date) = 1 then cast(@a_denpyo_date as datetime)
--							else 0
--						end
--					,120)                                     -- 取引日
--			+ ',' + convert(varchar,getdate(),120)            -- ＰＯＳ取引日時
--			+ ','                                             -- レシート番号
--			+ ','                                             -- 担当ＩＤ
--			+ ','                                             -- 担当コード
--			+ ','                                             -- 会員ＩＤ
--			+ ','                                             -- 会員コード
--			+ ','                                             -- 会員カードコード
--			+ ',' + cast(@a_shop_cd as varchar)               -- 操作店舗コード
--			+ ','                                             -- 紐付け元取引ＩＤ
--			+ ','                                             -- 紐付け元業務区分
--			+ ',' + isnull(cast(@a_log_id as varchar), '')    -- 追加処理用取引ＩＤ
--			+ ',0'                                                                -- 再登録フラグ
--		,@P02 = ''
--			+ '1'                                             -- ログ区分(1:lEDI)
--			+ ',' + isnull(cast(@a_doc_id as varchar),'')     -- 入庫業務ID
--		,@P03 = ''
---- 2012/11/13 update（パラメータ３個数エラー不具合対応）
----			+ ',' + isnull(cast(@a_goods_id as varchar), '')  -- 商品ID
--			+ '' + isnull(cast(@a_goods_id as varchar), '')  -- 商品ID
--			+ ',' + isnull(@a_tana_cd,'')                     -- 棚コード
--		    + ','                                             -- 棚コード変更前

--		-- SPキック
--		Exec @rc = P_Transaction
--					 @P01 = @P01
--					,@P02 = @P02
--					,@P03 = @P03
--					,@SP  = '1'
--					,@err_msg = @err_msg OUTPUT
--					,@out_log_id = @a_log_id OUTPUT
-- ▲▲▲ 2013/11/26 delete

		-- 店舗コードが変ったら、明細追加用のログIDをリセットする
		If @a_shop_cd <> @tmp_shop_cd Begin
			SELECT
				 @tmp_shop_cd = @a_shop_cd
				,@a_log_id = null
		End
-- ▼▼▼ 2013/11/26 delete
		---- エラーチェック
		--If @rc <> 0 Begin
		--	-- エラー記録
		--	SELECT
		--		@a_edi_error_msg = '処理ＳＰエラー'
		--			+ ',m=[' + isnull(@err_msg,'') + ']'
		--			+ ',@P01=[' + isnull(@P01,'') + ']'
		--			+ ',@P02=[' + isnull(@P02,'') + ']'
		--			+ ',@P03=[' + isnull(@P03,'') + ']'
		--		,@a_edi_flag = '2'  -- 警告
		--End
-- ▲▲▲ 2013/11/26 delete
	End
	GOODS_LOCATION_SET_END:

      ----------------------------
      -- 送品常備リスト作成
      ----------------------------
      -- 常備・長期のみ
      If @a_goods_id is not null and @e22_souhin_jouken in ('3','5') Begin
--      If @a_goods_id is not null and @e22_souhin_jouken = '5' Begin

        Set @a_seikyu_date = null
        -- 請求日セット
        If isdate(@e22_seikyu_date) = 1 Begin
          Set @a_seikyu_date = convert(datetime,@e22_seikyu_date)
        End

        -- なければ返品期限をセット
        If @a_seikyu_date is null
           and isdate(@e22_henpin_kigen_date) = 1 Begin

          Set @a_seikyu_date = convert(datetime,@e22_henpin_kigen_date)
        End

        -- 請求日があれば

        If @a_seikyu_date is not null Begin

          -- レコードチェック
          If Not Exists(select top 1 *
		from
		  wpt_book_joubi_master
		  join
		  wpt_goods_master
		    on
		    bjm_goods_id = gds_goods_id
		where
		  bjm_goods_id = @a_goods_id
		  and
		  bjm_shop_cd = @a_shop_cd
		  and
		  bjm_bookedi_cd = @a_tushin_id
		  and
		  bjm_souhin_jouken = @e22_souhin_jouken ) Begin

	  -- insert
	  INSERT INTO wpt_book_joubi_master (
		 bjm_goods_id
		,bjm_shop_cd
		,bjm_bookedi_cd
		,bjm_souhin_jouken
		,bjm_seikyu_date
		,bjm_end_flag
		,bjm_denpyo_date
		,bjm_denpyo_no
		,bjm_line_no
		,bjm_jan_cd
		)
		SELECT
		 bjm_goods_id = @a_goods_id
		,bjm_shop_cd = @a_shop_cd
		,bjm_bookedi_cd = @a_tushin_id
		,bjm_souhin_jouken = @e22_souhin_jouken
		,bjm_seikyu_date = @a_seikyu_date
		,bjm_end_flag = '0'
		,bjm_denpyo_date = @a_denpyo_date
		,bjm_denpyo_no = @a_denpyo_no
		,bjm_line_no = @a_line_no
		,bjm_jan_cd = @a_jan

	End Else Begin
	  -- update
            -- 請求日が新しいものだけ更新
	  UPDATE wpt_book_joubi_master SET
		 bjm_seikyu_date =
			case
			 when @a_seikyu_date > bjm_seikyu_date then @a_seikyu_date
			 else bjm_seikyu_date
			End
		,bjm_end_flag =
			case
			 when @a_seikyu_date > bjm_seikyu_date then '0'
			 else bjm_end_flag
			End
		,bjm_update_date = 
			case
			 when @a_seikyu_date > bjm_seikyu_date then getdate()
			 else bjm_update_date
			End
		,bjm_denpyo_date = 

			case
			 when @a_seikyu_date > bjm_seikyu_date then @a_denpyo_date
			 else bjm_denpyo_date
			End
		,bjm_denpyo_no = 
			case
			 when @a_seikyu_date > bjm_seikyu_date then @a_denpyo_no
			 else bjm_denpyo_no
			End
		,bjm_line_no = 
			case
			 when @a_seikyu_date > bjm_seikyu_date then @a_line_no
			 else bjm_line_no
			End
		,bjm_jan_cd = 
			case
			 when @a_seikyu_date > bjm_seikyu_date then @a_jan
			 else bjm_jan_cd
			End
		where
		 bjm_goods_id = @a_goods_id
		 and
		 bjm_shop_cd = @a_shop_cd
		 and
		 bjm_bookedi_cd = @a_tushin_id
		 and

		 bjm_souhin_jouken = @e22_souhin_jouken
          End
        End
      End

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_shn SET
            e22_edi_flag = @a_edi_flag
           ,e22_edi_error_msg = @a_edi_error_msg
           ,e22_edi_update_date = @a_getdate
         where
            e22_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id


      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_file_line_no
	,@a_meisai_no
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@a_tax_type
	,@a_shop_cd
	,@a_denpyo_date
	,@a_denpyo_no
	,@a_line_no
	,@a_set_kubun

	,@e22_tushin_id  -- ここから下は面倒なので全フィールド
	,@e22_goods_shubetu
	,@e22_denpyo_date
	,@e22_nyuka_date
	,@e22_denpyo_no
	,@e22_line_no
	,@e22_goods_code_kubun
	,@e22_goods_code
	,@e22_zasshi_code_gou
	,@e22_zasshi_year
	,@e22_c_code
	,@e22_extax_price
	,@e22_intax_price
	,@e22_shoumi_rate
	,@e22_genka_price
	,@e22_goods_count
	,@e22_goods_count_sign
	,@e22_tax_type
	,@e22_tax_rate
	,@e22_kaikiri_kubun
	,@e22_souhin_jouken
	,@e22_set_kubun
	,@e22_set_goods_code_kubun
	,@e22_set_goods_code
	,@e22_set_goods_count
	,@e22_set_goods_count_sgin
	,@e22_shinkan_kubun
	,@e22_hatubai_date
	,@e22_seikyu_date
	,@e22_henpin_kigen_date
	,@e22_haihon_count
	,@e22_ketusoku
	,@e22_ketusoku_count
	,@e22_hasuu_count
	,@e22_jyuuryou
	,@e22_sokutou_count
	,@e22_sokuton
	,@e22_cd_kikaku_bango
	,@e22_cd_hinshu_cd
	,@e22_hachu_shop_cd
	,@e22_hachu_denpyo_no
	,@e22_hachu_line_no
	,@e22_dist_code				-- 2012/05/15 add
	,@e22_ecole_hinban			-- 2014/01/10 add
	,@e22_bikou					-- 2014/10/31 add (ecole_goods_name)
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs


  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9012,送品データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- 自動検収処理	-- 2014/09/09 add
  ------------------------------
  Exec P_Auto_Arrival_Book

  ------------------------------
  -- 自動検収処理	-- 	2015/02/03 add
  ------------------------------
  Exec P_Auto_Arrival_ST

  ------------------------------------
  -- 自動発注設定解除処理	--追加：2019/03/14 - MS-560
  ------------------------------------
  --EXEC P_auto_hachu_cancel_setting	--

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9013,送品ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_SOUHIN_END:



--=================================================
-- 下り返品処理
--=================================================
DOWN_HENPIN:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9020,返品サーバ情報セット不正'
    GOTO SP_ERR
  End


  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_hpn ('
	+ '	 e21_edi_flag'
	+ '	,e21_edi_timestamp'
	+ '	,e21_edi_id'
	+ '	,e21_edi_create_date'
	+ '	,e21_edi_update_date'
	+ '	,e21_edi_file_line_no'
	+ '	,e21_edi_meisai_no'
	+ '	,e21_edi_error_msg'
	+ '	,e21_server_webpos'
	+ '	,e21_dbname_webpos'
	+ '	,e21_shop_cd_webpos'
	+ '	,e21_shop_name_webpos'
	+ '	,e21_seq_no'
	+ '	,e21_shop_cd_primary'
	+ '	,e21_shop_cd'
	+ '	,e21_tushin_id'
	+ '	,e21_sbs_denpyo_no'
	+ '	,e21_sbs_henpin_shubetu'
	+ '	,e21_denpyo_date'
	+ '	,e21_denpyo_no'
	+ '	,e21_henpin_kubun'
	+ '	,e21_konpo_no'
	+ '	,e21_henpin_kigen'
	+ '	,e21_shori_no1'
	+ '	,e21_shori_no2'
	+ '	,e21_line_no'
	+ '	,e21_goods_code_kubun'
	+ '	,e21_goods_code'
	+ '	,e21_year'
	+ '	,e21_c_code'
	+ '	,e21_price'
	+ '	,e21_henpin_count'
	+ '	,e21_tax_type'
	+ '	,e21_tax_rate'
	+ '	)'
	+ '	SELECT'
	+ '	 M.e21_edi_flag'
	+ '	,M.e21_edi_timestamp'
	+ '	,M.e21_edi_id'
	+ '	,M.e21_edi_create_date'
	+ '	,M.e21_edi_update_date'
	+ '	,M.e21_edi_file_line_no'
	+ '	,M.e21_edi_meisai_no'
	+ '	,M.e21_edi_error_msg'
	+ '	,M.e21_server_webpos'
	+ '	,M.e21_dbname_webpos'
	+ '	,M.e21_shop_cd_webpos'
	+ '	,M.e21_shop_name_webpos'
	+ '	,M.e21_seq_no'
	+ '	,M.e21_shop_cd_primary'
	+ '	,M.e21_shop_cd'
	+ '	,M.e21_tushin_id'
	+ '	,M.e21_sbs_denpyo_no'
	+ '	,M.e21_sbs_henpin_shubetu'
	+ '	,M.e21_denpyo_date'
	+ '	,M.e21_denpyo_no'
	+ '	,M.e21_henpin_kubun'
	+ '	,M.e21_konpo_no'
	+ '	,M.e21_henpin_kigen'
	+ '	,M.e21_shori_no1'
	+ '	,M.e21_shori_no2'
	+ '	,M.e21_line_no'
	+ '	,M.e21_goods_code_kubun'
	+ '	,M.e21_goods_code'
	+ '	,M.e21_year'
	+ '	,M.e21_c_code'
	+ '	,M.e21_price'
	+ '	,M.e21_henpin_count'
	+ '	,M.e21_tax_type'
	+ '	,M.e21_tax_rate'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_hpn as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_hpn as C'
	+ '                on M.e21_edi_id = C.e21_edi_id'
	+ '            where'
	+ '              C.e21_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e21_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e21_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e21_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9021,返品データ取得エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e21_tushin_id char (2)
  Declare @e21_sbs_denpyo_no varchar (10)
  Declare @e21_sbs_henpin_shubetu varchar (4)
  Declare @e21_denpyo_date char (8)
  Declare @e21_denpyo_no varchar (10)
  Declare @e21_henpin_kubun char (2)
  Declare @e21_konpo_no varchar (10)
  Declare @e21_henpin_kigen char (8)
  Declare @e21_shori_no1 varchar (20)
  Declare @e21_shori_no2 varchar (20)
  Declare @e21_line_no int 
  Declare @e21_goods_code_kubun char (1)
  Declare @e21_goods_code varchar (20)
  Declare @e21_year char (4)
  Declare @e21_c_code char (4)
  Declare @e21_price money 
  Declare @e21_henpin_count int 
  Declare @e21_tax_type char (1)
  Declare @e21_tax_rate decimal(5, 2)

  Declare @e21_mst_update_flag char (1)   -- 20070117add

  Declare @e21_doc_id int		-- 2012/09/14 add

  -- 一時テーブル読み込み
  Set @rs = cursor static for
      SELECT
	 e21_edi_id
	,e21_edi_file_line_no

	,e21_edi_meisai_no
	,e21_tushin_id
	,e21_goods_code_kubun
	,e21_goods_code
	,e21_tax_type
	,e21_shop_cd_webpos as e21_shop_cd_webpos_order
	,e21_denpyo_date as e21_denpyo_date_order
	,e21_denpyo_no as e21_denpyo_no_order
	,e21_line_no as e21_line_no_order
	,e21_tushin_id  -- ここから下は面倒なので全フィールド
	,e21_sbs_denpyo_no
	,e21_sbs_henpin_shubetu
	,e21_denpyo_date
	,e21_denpyo_no
	,e21_henpin_kubun
	,e21_konpo_no
	,e21_henpin_kigen
	,e21_shori_no1
	,e21_shori_no2
	,e21_line_no
	,e21_goods_code_kubun
	,e21_goods_code
	,e21_year
	,e21_c_code
	,e21_price
	,e21_henpin_count
	,e21_tax_type
	,e21_tax_rate
            from
              wbe_edibook_dw_hpn
            where
              e21_edi_flag = '0'  -- 未処理
            order by
               e21_shop_cd_webpos_order
              ,e21_denpyo_date_order
              ,e21_denpyo_no_order
              ,e21_line_no_order

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_file_line_no
	,@a_meisai_no
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@a_tax_type
	,@a_shop_cd
	,@a_denpyo_date
	,@a_denpyo_no
	,@a_line_no
	,@e21_tushin_id  -- ここから下は面倒なので全フィールド
	,@e21_sbs_denpyo_no
	,@e21_sbs_henpin_shubetu
	,@e21_denpyo_date
	,@e21_denpyo_no
	,@e21_henpin_kubun
	,@e21_konpo_no
	,@e21_henpin_kigen
	,@e21_shori_no1
	,@e21_shori_no2
	,@e21_line_no
	,@e21_goods_code_kubun
	,@e21_goods_code
	,@e21_year
	,@e21_c_code
	,@e21_price
	,@e21_henpin_count
	,@e21_tax_type
	,@e21_tax_rate


    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み
       ,@a_goods_id = null
       ,@a_jan = null
       ,@a_price = null
       ,@a_genka = null
       ,@a_price_intax = null  -- 2012/03/28


      -- 取引先コード、EDI区分セット
      SELECT
          @a_supplier_id = mpm_supplier_id
        , @a_supplier_cd = mpm_supplier_cd
        , @a_supplier_edi_type = mpm_edi_type
      from
        wpt_maker_supplier_master
      where
        mpm_bookedi_cd = @a_tushin_id

     -- 2009/06/01
     -- この取引先から銘柄データを受信しているか
     SELECT
       @a_dw_mst_flag = bes_dw_mst_flag
       from
           wpt_book_edi_setting
       where
           bes_bookedi_cd = @a_tushin_id
           and bes_shop_cd = @a_shop_cd
     -- フランチャイズID取得
     SELECT
       @a_fran_id = shm_franchise_id
       from
           wpt_shop_master
       where
           shm_shop_cd = @a_shop_cd

      -- コードチェック
      If @a_goods_code is null or rtrim(ltrim(@a_goods_code)) = '' Begin
          -- 返品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 書籍チェック
      If @a_goods_code_kubun = '1' and
         len(@a_goods_code) <> 10 Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 雑誌チェック(新・旧)
      If @a_goods_code_kubun in ( '2', '8' ) and
         len(@a_goods_code) <> 7 and
         len(@a_goods_code) <> 5 Begin 
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 対象外コードチェック（商品コード0の場合）
      If isnumeric(@a_goods_code) = 1 and 
         ( cast(ltrim(rtrim(@a_goods_code)) as bigint) = 0 ) Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 太洋社支社コードチェック
      -- 雑誌で4文字以下
      If @a_goods_code_kubun = '2' and
           len(@a_goods_code) <= 4 Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 栗田対象外コードチェック
      If ltrim(rtrim(@a_goods_code)) = '999999999'
         or ltrim(rtrim(@a_goods_code)) = '9999999999' Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 社内コードチェック
      If @a_goods_code_kubun = '6' Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- インストアコードチェック
      If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
	     and len(ltrim(rtrim(@a_goods_code))) = 13 Begin
          SET @a_goods_code = @a_tushin_id + '_' + @a_goods_code    -- 怪しいコードは先頭に取り次ぎコードを付ける。
          -- 送品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 税区分チェック
      If @a_tax_type is null or rtrim(ltrim(@a_tax_type)) = '' Begin
          -- 返品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

     -- 2012/03/28
     -- 税端数処理区分取得
     Exec @rc = P_POSAP_Info
                  @shop_cd = @a_shop_cd
                , @sm2_tax_rate_type = @a_tax_rate_type OUTPUT
                , @sp = '1'

      ----------------------------
      -- マスタ作成処理
      ----------------------------
    -- 2009/06/01
    -- GAMEは商品マスタ有りき
    If @a_goods_code_kubun = 'G' Begin
      Exec @rc = P_PLU
                  @plu_cd = @a_goods_code
                 ,@plu_type = '1'
                 ,@shop_cd = @a_shop_cd
                 ,@sp = '1'
                 ,@gds_goods_id = @a_goods_id OUTPUT
                 ,@gds_jan_cd = @a_jan OUTPUT
                 ,@gds_media_id = @a_media_id OUTPUT
      If @rc <> 0 or @a_goods_id is null 
        -- 送品マスタ処理終了まで飛ばす
        GOTO LOOP_END_HPN_MST
    End
    Else Begin
      -- 雑誌コード作成用年４桁セット
      SELECT
          @a_zasshi_year = 
                case   -- 雑誌年号があればそれを優先。なれりば出版日
                   when isnull(@e21_year,'') <> '' and isnull(@e21_year,'') <> '0' and len(@e21_year) = 1
                      then @e21_year
                   when isnull(@e21_year,'') <> '' and isnull(@e21_year,'') <> '0' and len(@e21_year) = 4
                      then substring(@e21_year,4,1)
                   else  substring(convert(varchar,getdate(),111),4,1)
                End

      -- JAN生成
      SELECT
          @a_jan =
            case
              when @a_goods_code_kubun = '1' then dbo.F_Create_BookJAN(@a_goods_code)
              when @a_goods_code_kubun = '2' 
                       and len(@a_goods_code) = 7 then dbo.F_Create_ZasshiJAN(@a_goods_code,@a_zasshi_year)
              when @a_goods_code_kubun = '2' 
                       and len(@a_goods_code) = 5 then dbo.F_Create_ZasshiJAN(@a_goods_code
                                                               + substring(convert(varchar,getdate(),111),6,2)
                                                              ,@a_zasshi_year)

              when @a_goods_code_kubun = '8'  -- 旧
                       and len(@a_goods_code) = 7 then dbo.F_Create_OldZasshiJAN(@a_goods_code,@e21_price)
              when @a_goods_code_kubun = '8'
                       and len(@a_goods_code) = 5 then dbo.F_Create_OldZasshiJAN(@a_goods_code
                                                               + substring(convert(varchar,getdate(),111),6,2)
                                                              ,@e21_price)
              else @a_goods_code
            End
         
      If isnull(@a_jan,'') = '' Begin
          -- 返品マスタ処理終了まで飛ばす
          GOTO LOOP_END_HPN_MST
      End

      -- 2009/06/01
      -- P_PLUで商品存在チェックを行なう
      SET @e21_mst_update_flag = '0'
      SET @a_exist_goods_id = null
      SET @a_exist_goods_type = null
      SET @a_exist_goods_media_id = null
      Exec @rc = P_PLU
             @plu_cd = @a_jan
            ,@plu_type = '0'
            ,@sp = '1'
            ,@gds_goods_id = @a_exist_goods_id OUTPUT
            ,@gds_goods_type = @a_exist_goods_type OUTPUT
            ,@gds_media_id = @a_exist_goods_media_id OUTPUT
      -- エラーチェック
      If @rc <> 0 Begin
         -- エラー記録
         SELECT
            @a_edi_error_msg = '商品マスタ検索エラー'
               + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
               + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
               + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
           ,@a_edi_flag = '3'  -- エラー
         -- ループ終了まで飛ばす
         GOTO LOOP_END_HPN_MST
      End

      -- 商品マスタがる場合はフラグセット。
      -- 20070118 update
--      SET @e21_mst_update_flag = '0'
--      If Exists ( select top 1 *
--                  from wpt_goods_master
--                  where gds_jan_cd = @a_jan ) Begin
      -- 2009/06/01
      If @a_exist_goods_id is not null Begin
          SET @e21_mst_update_flag = '1'   -- 20070117 add
      End
   
      -- 2011/07/15 M.Nakano
      -- 書籍で商品が存在する場合は、既存データのCコードを取得
      If @e21_mst_update_flag = '1' And @a_exist_goods_type = '20' Begin
        SELECT
          @a_exist_c_code = gdb_c_code
        FROM wpt_goods_master_book
        WHERE gdb_goods_id = @a_exist_goods_id
        
        -- 既存が0000以外で更新が0000の場合は、更新データを既存と挿げ替える
        If @a_exist_c_code <> '0000' And @e20_c_code = '0000'
        Begin
          -- Cコード設定
          SELECT
            @e21_c_code = @a_exist_c_code
        End
      End

      -- データセット
      SELECT
        @a_tax_type = isnull(@e21_tax_type,'0')  -- デフォルト外税
      , @a_price_type = '0'  -- 税抜固定
      , @a_price = isnull(cast(@e21_price as int),0)
      , @a_goods_type = 
          case
            when @a_goods_code_kubun = '1' then '20'
            when @a_goods_code_kubun = '2' then '21'
            when @a_goods_code_kubun = '5' then '30'  -- 2009/01/22 CD対応
            else '00'
          End
      , @a_media_id = 
          case
            when @a_goods_code_kubun = '1' then
              dbo.F_Search_Book_Media(isnull(@e21_c_code,'0000'),dbo.F_Convert_ISBN_Publisher(@e21_goods_code))
            when @a_goods_code_kubun = '2' then 
              dbo.F_Search_Book_Media(substring(@e21_goods_code,1,1),null)
            else null
          end

      -- 2009/06/01
      -- マスタがある場合、商材区分と分類IDは仕入先のEDI区分により更新内容が変化する。
      If @a_exist_goods_id is not null Begin
        SELECT
            @a_goods_type = 
              case
                when @a_supplier_edi_type = '2' then -- 書籍EDIの場合
                  case
                    when @a_exist_goods_type in ('00', '20', '21') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                when @a_supplier_edi_type = '3' then -- ディスクEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '30', '31') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                when @a_supplier_edi_type = '4' then -- ゲームEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '40') then @a_goods_type
                    else @a_exist_goods_type  -- ↑以外は商材区分を更新しない
                  end
                else @a_goods_type
              end
          , @a_media_id = 
              case
                when @a_supplier_edi_type = '2' then -- 書籍EDIの場合
                  case
                    when @a_exist_goods_type in ('00', '20', '21') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                when @a_supplier_edi_type = '3' then -- ディスクEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '30', '31') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                when @a_supplier_edi_type = '4' then -- ゲームEDIの場合
                  case
                    when @a_exist_goods_type in ('00', '40') then @a_media_id
                    else @a_exist_goods_media_id  -- ↑以外は分類IDを更新しない
                  end
                else @a_media_id
              end
      End

      -- 2009/06/01
      -- 下り銘柄処理対象の取引先であれば、共通商品マスタを生成・更新
      If @a_dw_mst_flag = '1' Begin

        -- 商品マスタ作成処理  -- データがあればＩＤ取得もかねる
        Exec @rc = P_Goods_Create 
             @goods_type = @a_goods_type
            ,@plu_cd     = @a_jan
            ,@plu_type   = '0' 
--            ,@goods_name = @a_goods_name
            ,@tax_type   = @a_tax_type
            ,@price      = @a_price
            ,@price_type = @a_price_type
            ,@sp         = '1'  -- SP起動
            ,@goods_id   = @a_goods_id OUTPUT

         -- エラーチェック
         If @rc <> 0 or @a_goods_id is null Begin
            -- 返品マスタ処理終了まで飛ばす
            GOTO LOOP_END_HPN_MST
         End

         -- マスタUPDATE
         UPDATE wpt_goods_master SET
           gds_update_date = getdate()
          ,gds_update_memo = object_name(@@PROCID) + '[hpn]' + '[' + isnull(@a_tushin_id,'') +  ']'
          ,gds_media_id = 					-- 20080602 update
            case   -- 新規で基準点更新の無いもののみ変更→基準点更新の無いもののみ変更
             when @a_goods_code_kubun = '1' and isnull(@e21_c_code,'0000')='0000' and gds_media_id is not null then gds_media_id  --20081208
             when gds_tana_media_update_flag = '0' and @a_media_id is not null then isnull(@a_media_id,gds_media_id)
             else gds_media_id
            End
         from
           wpt_goods_master
          left outer join
            wpt_maker_supplier_master
          on
            mpm_bookedi_cd = @a_tushin_id
         where
           gds_goods_id = @a_goods_id

         -- 書籍
         If @a_goods_code_kubun = '1' Begin
           -- マスタUPDATE
           UPDATE wpt_goods_master_book SET
             gdb_c_code = 
               case   -- 書籍でC_Codeがなかったら更新しない。
                 when @a_goods_code_kubun = '1' and isnull(@e21_c_code,'0000')='0000' and gdb_c_code is not null then gdb_c_code  --20081208
                 else isnull(@e21_c_code,'0000')
               End
            ,gdb_publisher_cd = dbo.F_Convert_ISBN_Publisher(gdb_isbn)
           from
             wpt_goods_master_book
           where
             gdb_goods_id = @a_goods_id
         End
      End
      Else Begin
        -- 2009/02/09
        -- 下り銘柄処理のない取引先の場合
        -- 商品ID取得
        SELECT
          @a_goods_id = gds_goods_id
        from
          wpt_goods_master
        where 
          gds_jan_cd = @a_jan
      End
    End

       -- 原価セット
       SELECT
         @a_genka = stk_cost_price_last
       from
         wpt_stock_master
       where
         stk_shop_cd = @a_shop_cd
         and
         stk_goods_id = @a_goods_id
         and
         stk_condition_type = '0'

      -- 2012/03/28
      -- 売価セット
      -- e21_priceには税抜価格が入っているのが前提
      SELECT
        @a_price_intax = CASE WHEN @a_tax_rate_type = '0' THEN  FLOOR(@a_price + @a_price * (@a_tax_rate / 100)) -- 切捨
                              WHEN @a_tax_rate_type = '2' THEN  CEILING(@a_price + @a_price * (@a_tax_rate / 100)) -- 切上
                         ELSE ROUND(@a_price + @a_price * (@a_tax_rate / 100), 0) END -- 四捨五入

      -- 返品マスタ処理終了ラベル
      LOOP_END_HPN_MST:

      ----------------------------
      -- 返品処理（業務）
      ----------------------------
      -- 変数クリア
      Set @a_line_no = null

      -- ラインＮｏ再採番
      SELECT
	@a_line_no = isnull(max(dds_line_no),0) + 1
            from
               wpt_document with(nolock)
	     join
               wpt_document_shuko with(nolock)
	       on
	       doc_doc_id = dsk_doc_id
	     join
               wpt_document_shuko_details with(nolock)
	       on
	       dsk_doc_id = dds_doc_id
            where
               doc_work_type = '0133'
	     and
               doc_shop_cd = @a_shop_cd
	     and
               dsk_supplier_id = @a_supplier_id
               and
               dsk_denpyo = @a_denpyo_no
               and
               dsk_denpyo_date = @a_denpyo_date
               and
               dds_line_no_eda = 0
							 
							 
			-- 下り返品にて売価が税抜きになる為、PLUより売価をセットする
			--Exec @rc = P_PLU
			--			@plu_cd = @a_jan
			--			,@plu_type = '0'
			--			,@shop_cd = @a_shop_cd
			--			,@sp = '1'
			--			,@stk_price = @a_price OUTPUT
			---- エラーチェック
			--If @rc <> 0 Begin
			--	
			--End
							
							
	SELECT
	 @P01 = ''
		+ '0002.0001'     -- パラメタ受け渡しバージョン
		+ ',' + object_name(@@PROCID) + '_' + @edi_type     -- アプリケーションバージョン
		+ ',' + cast(@a_shop_cd as varchar)                       -- 店舗コード
		+ ',0133'                                                            -- 業務区分
		+ ',0'                                                                 -- 伝票区分
		+ ',0'                                                                 -- POS番号
		+ ',' + convert(varchar,
			case
		           when isdate(@a_denpyo_date) = 1 then cast(@a_denpyo_date as datetime)
		           else 0
		         end
		         ,120)                                                        -- 取引日
		+ ',' + convert(varchar,getdate(),120)                    -- ＰＯＳ取引日時
		+ ','                                                                  -- レシート番号
		+ ','                                                                  -- 担当ＩＤ
		+ ','                                                                  -- 担当コード
		+ ','                                                                  -- 会員ＩＤ
		+ ','                                                                  -- 会員コード
		+ ','                                                                  -- 会員カードコード
		+ ',' + cast(@a_shop_cd as varchar)                       -- 操作店舗コード
		+ ','                                                                  -- 紐付け元取引ＩＤ
		+ ','                                                                  -- 紐付け元業務区分
		+ ','                                                                  -- 追加処理用取引ＩＤ
		+ ',0'                                                                -- 再登録フラグ
	,@P02 = ''
		+ '0'                                                                -- 取引区分
		+ ',' + isnull(cast(@a_supplier_id as varchar),'')        -- 仕入先ID
		+ ',' + isnull(@a_supplier_cd,'')                              -- 仕入先コード 
		+ ','                                                                 -- 出庫元店舗コード
		+ ',' + isnull(@a_denpyo_no,'')                               -- 伝票番号
		+ ',' + convert(varchar,
			case
		           when isdate(@a_denpyo_date) = 1 then cast(@a_denpyo_date as datetime)
		           else 0
		         end
		         ,120)                                                       -- 伝票日付
		+ ',0'                                                                -- 伝票区分
		+ ',0'                                                                -- 梱包分けフラグ
		+ ',' + isnull(@a_tushin_id,'')                                  -- 書籍ＥＤＩコード
	,@P03 = ''
		+ cast(isnull(@a_line_no,1) as varchar)                   -- 明細番号
		+ ',0'                                                                -- 明細番号 枝番

		+ ',' + isnull(cast(@e21_sbs_henpin_shubetu as char(1)),'')     -- 明細区分 
		+ ',0'                                                                -- 新中区分
		+ ',' + isnull(cast(@a_goods_id as varchar),'')           -- 商品ID
		+ ',' + isnull(@a_goods_code,'')                              -- 商品コード
		+ ',' + isnull(@a_jan,'')                                          -- JAN
		+ ','                                                                  -- 商品名
		+ ',' + isnull(@a_tax_type,'')                                   -- 税区分
		+ ',' + isnull(cast(@a_price as varchar),'0')              -- 標準売価
		+ ',' + isnull(cast(cast(@a_genka as int) as varchar),'0')	-- 標準原価
		+ ',' + isnull(cast(@a_price_intax as varchar),'0')              -- 売価 2012/03/28 @a_price -> @a_price_intax
		+ ',' + isnull(cast(cast(@a_genka as int) as varchar),'0')	-- 原価
		+ ',' + cast(isnull(@e21_henpin_count,0) as varchar) -- 返品数
		+ ','                                                                  -- 倉庫コード
		+ ',' + isnull(@a_goods_code,'')                               -- 送品元商品コード

      -- SPキック
      Exec @rc = P_Transaction
	 @P01 = @P01
	,@P02 = @P02
	,@P03 = @P03
	,@SP  = '1'
	,@err_msg = @err_msg OUTPUT
	,@out_doc_id = @e21_doc_id OUTPUT  -- 2012/09/14 add

      -- エラーチェック
      If @rc <> 0 Begin
        -- エラー記録
        SELECT
           @a_edi_error_msg = '処理（業務）ＳＰエラー'
               + ',m=[' + isnull(@err_msg,'') + ']'
               + ',@P01=[' + isnull(@P01,'') + ']'
               + ',@P02=[' + isnull(@P02,'') + ']'
               + ',@P03=[' + isnull(@P03,'') + ']'
          ,@a_edi_flag = '3'  -- エラー
      End

      ----------------------------
      -- 返品処理（取引）
      ----------------------------
      If @a_edi_flag <> '1'
         or isnull(cast(@a_goods_id as varchar),'') = ''
         or ( ltrim(rtrim(isnull(@e21_sbs_henpin_shubetu,''))) <> '' and @a_tushin_id = 'NP' ) 
         or ( ltrim(rtrim(isnull(@e21_sbs_henpin_shubetu,''))) <> '' and @a_tushin_id = 'TY' ) 
-- 2012/06/07 update （トーハンは入帳区分に関係なく、在庫変動させる）
--         or ( ltrim(rtrim(isnull(@e21_sbs_henpin_shubetu,''))) <> '0' and @a_tushin_id = 'TH' ) Begin
         Begin

	GOTO LOOP_END_HPN_EXEC
      End

      -- 変数クリア
      Set @a_line_no = null
      Set @a_trn_id_add = null


      -- ラインＮｏ再採番
      SELECT
	 @a_line_no = isnull(max(tod_line_no),0) + 1
	,@a_trn_id_add = trn_trn_id
            from
               wpv_transaction
	     join
	     wpt_transaction_inout
	       on trn_trn_id=tso_trn_id
	     join
	     wpt_transaction_inout_details
	       on trn_trn_id=tod_trn_id
	  where
	     trn_work_type = '0231'
	     and
               trn_shop_cd = @a_shop_cd
	     and
               tso_supplier_id = @a_supplier_id
               and
               tso_denpyo = @a_denpyo_no
               and
               tso_denpyo_date = @a_denpyo_date
	  group by
	     trn_trn_id

      SELECT
	 @P01 = ''
		+ '0002.0001'     -- パラメタ受け渡しバージョン
		+ ',' + object_name(@@PROCID) + '_' + @edi_type     -- アプリケーションバージョン
		+ ',' + cast(@a_shop_cd as varchar)                       -- 店舗コード
		+ ',0231'                                                            -- 業務区分
		+ ',0'                                                                 -- 伝票区分
		+ ',0'                                                                 -- POS番号
		+ ',' + convert(varchar,
			case
		           when isdate(@a_denpyo_date) = 1 then cast(@a_denpyo_date as datetime)
		           else 0
		         end
		         ,120)                                                        -- 取引日
		+ ',' + convert(varchar,getdate(),120)                    -- ＰＯＳ取引日時
		+ ','                                                                  -- レシート番号
		+ ','                                                                  -- 担当ＩＤ
		+ ','                                                                  -- 担当コード
		+ ','                                                                  -- 会員ＩＤ
		+ ','                                                                  -- 会員コード
		+ ','                                                                  -- 会員カードコード
		+ ',' + cast(@a_shop_cd as varchar)                       -- 操作店舗コード
		+ ','                                                                  -- 紐付け元取引ＩＤ
		+ ','                                                                  -- 紐付け元業務区分
		+ ',' + isnull(cast(@a_trn_id_add as varchar),'')         -- 追加処理用取引ＩＤ
		+ ',0'                                                                -- 再登録フラグ

	,@P02 = ''
		+ '2'                                                                -- 取引区分 ( 2:返品下りデータ )
		+ ',' + isnull(cast(@a_supplier_id as varchar),'')        -- 仕入先ID
		+ ',' + isnull(@a_supplier_cd,'')                              -- 仕入先コード 
		+ ',' + isnull(@a_denpyo_no,'')                               -- 伝票番号
		+ ',0'                                                                -- 伝票番号枝番
		+ ',' + convert(varchar,
			case
		           when isdate(@a_denpyo_date) = 1 then cast(@a_denpyo_date as datetime)
		           else 0
		         end
		         ,120)                                                       -- 伝票日付
		+ ','                                                                  -- 摘要ＩＤ
		+ ','                                                                  -- 摘要コード
		+ ','                                                                  -- 摘要区分
		+ ','                                                                  -- 摘要名
		+ ','                                                                  -- 返品種別
		+ ','                                                                  -- 精算日付
-- 2012/09/14 update
--		+ ','                                                                  -- 対象業務ＩＤ
		+ ',' + isnull(cast(@e21_doc_id as varchar),'')                        -- 対象業務ＩＤ
---------------------------
		+ ',1'                                                                -- 無伝フラグ
		+ ','                                                                  -- 移動店舗コード
		+ ',0'                                                                -- 箱番
	,@P03 = ''
		+ cast(isnull(@a_line_no,1) as varchar)                   -- 明細番号
		+ ',0'                                                                -- 新中区分
		+ ',' + isnull(cast(@a_goods_id as varchar),'')           -- 商品ID
		+ ',' + isnull(@a_goods_type,'')                               -- 商材コード
		+ ','                                                                  -- 固有商品コード
		+ ',' + isnull(@a_jan,'')                                          -- JAN
		+ ','                                                                  -- メディアコード
		+ ','                                                                  -- ジャンルコード
		+ ','                                                                  -- 商品名
		+ ',' + isnull(cast(@a_price as varchar),'0')              -- 標準売価
		+ ',' + isnull(cast(cast(@a_genka as int) as varchar),'0')	-- 標準原価
		+ ',' + isnull(cast(@a_price_intax as varchar),'0')              -- 売価 2012/03/28 @a_price -> @a_price_intax
		+ ',' + isnull(cast(cast(@a_genka as int) as varchar),'0')	-- 原価
		+ ',' + cast(isnull(@e21_henpin_count,0) as varchar) -- 返品数
		+ ',' + isnull(@a_jan,'')                                          -- ＰＬＵコード
		+ ','                                                                  -- 常備コード
		+ ','                                                                  -- メディアＩＤ
		+ ','                                                                  -- PLUアドオンコード
		+ ','                                                                  -- ロケーションコード

      -- SPキック
      Exec @rc = P_Transaction
	 @P01 = @P01
	,@P02 = @P02
	,@P03 = @P03
	,@SP  = '1'
	,@err_msg = @err_msg OUTPUT

      -- エラーチェック
      If @rc <> 0 Begin
        -- エラー記録
        SELECT
           @a_edi_error_msg = '処理（取引）ＳＰエラー'
               + ',m=[' + isnull(@err_msg,'') + ']'
               + ',@P01=[' + isnull(@P01,'') + ']'
               + ',@P02=[' + isnull(@P02,'') + ']'
               + ',@P03=[' + isnull(@P03,'') + ']'
          ,@a_edi_flag = '3'  -- エラー
      End

      -- 返品処理終了ラベル
      LOOP_END_HPN_EXEC:

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_hpn SET
            e21_edi_flag = @a_edi_flag
           ,e21_edi_error_msg = @a_edi_error_msg
           ,e21_edi_update_date = @a_getdate
         where
            e21_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End

        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id



      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_file_line_no
	,@a_meisai_no
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@a_tax_type
	,@a_shop_cd
	,@a_denpyo_date
	,@a_denpyo_no
	,@a_line_no
	,@e21_tushin_id  -- ここから下は面倒なので全フィールド
	,@e21_sbs_denpyo_no
	,@e21_sbs_henpin_shubetu
	,@e21_denpyo_date
	,@e21_denpyo_no
	,@e21_henpin_kubun
	,@e21_konpo_no
	,@e21_henpin_kigen
	,@e21_shori_no1
	,@e21_shori_no2
	,@e21_line_no
	,@e21_goods_code_kubun
	,@e21_goods_code
	,@e21_year
	,@e21_c_code
	,@e21_price
	,@e21_henpin_count
	,@e21_tax_type
	,@e21_tax_rate
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs


  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9022,返品データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9023,返品ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_HENPIN_END:


--=================================================
-- 下り売上処理
--=================================================
DOWN_URIAGE:

------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9040,売上サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_urd ('
	+ '  e23_edi_flag'
	+ ' ,e23_edi_timestamp'
	+ ' ,e23_edi_id'
	+ ' ,e23_edi_create_date'
	+ ' ,e23_edi_update_date'
	+ ' ,e23_edi_file_line_no'
	+ ' ,e23_edi_error_msg'
	+ ' ,e23_server_webpos'
	+ ' ,e23_dbname_webpos'
	+ ' ,e23_shop_cd_webpos'
	+ ' ,e23_shop_name_webpos'
	+ ' ,e23_shop_cd_primary'
	+ ' ,e23_shop_cd'
	+ ' ,e23_tushin_id'
	+ ' ,e23_pos_no'
	+ ' ,e23_receipt_no'
	+ ' ,e23_uriage_date'
	+ ' ,e23_uriage_time'
	+ ' ,e23_line_no'
	+ ' ,e23_goods_code_kubun'
	+ ' ,e23_goods_code'
	+ ' ,e23_zasshi_year'
	+ ' ,e23_jan_cd'
	+ ' ,e23_tanka'
	+ ' ,e23_tanka_sign'
	+ ' ,e23_count'
	+ ' ,e23_count_sign'
	+ ' ,e23_waribiki'
	+ ' ,e23_nebiki'
	+ ' ,e23_tax'
	+ ' ,e23_tax_sign'
	+ ' ,e23_tax_type'
	+ ' ,e23_tax_rate'
	+ ' ,e23_tax_rate_kubun'
	+ ' ,e23_baika'
	+ ' ,e23_baika_sign'
	+ ' ,e23_stock_count'
	+ ' ,e23_c_code'
	+ ' ,e23_goods_name'
	+ ' ,e23_goods_name_kana'
	+ ' ,e23_goods_subname'
	+ ' ,e23_goods_subname_kana'
	+ ' ,e23_writer_name'
	+ ' ,e23_writer_kana'
	+ ' ,e23_series_name'
	+ ' ,e23_series_kana'
	+ '	)'
	+ '	SELECT'
	+ '	 M.e23_edi_flag'
	+ '	,M.e23_edi_timestamp'
	+ '	,M.e23_edi_id'
	+ '	,M.e23_edi_create_date'
	+ '	,M.e23_edi_update_date'
	+ '	,M.e23_edi_file_line_no'
	+ '	,M.e23_edi_error_msg'
	+ '	,M.e23_server_webpos'
	+ '	,M.e23_dbname_webpos'
	+ '	,M.e23_shop_cd_webpos'
	+ '	,M.e23_shop_name_webpos'
	+ '	,M.e23_shop_cd_primary'
	+ '	,M.e23_shop_cd'
	+ '	,M.e23_tushin_id'
	+ '	,M.e23_pos_no'
	+ '	,M.e23_receipt_no'
	+ '	,M.e23_uriage_date'
	+ '	,M.e23_uriage_time'
	+ '	,M.e23_line_no'
	+ '	,M.e23_goods_code_kubun'
	+ '	,M.e23_goods_code'
	+ '	,M.e23_zasshi_year'
	+ '	,M.e23_jan_cd'
	+ '	,M.e23_tanka'
	+ '	,M.e23_tanka_sign'
	+ '	,M.e23_count'
	+ '	,M.e23_count_sign'
	+ '	,M.e23_waribiki'
	+ '	,M.e23_nebiki'
	+ '	,M.e23_tax'
	+ '	,M.e23_tax_sign'
	+ '	,M.e23_tax_type'
	+ '	,M.e23_tax_rate'
	+ '	,M.e23_tax_rate_kubun'
	+ '	,M.e23_baika'
	+ '	,M.e23_baika_sign'
	+ '	,M.e23_stock_count'
	+ '	,M.e23_c_code'
	+ '	,M.e23_goods_name'
	+ '	,M.e23_goods_name_kana'
	+ '	,M.e23_goods_subname'
	+ '	,M.e23_goods_subname_kana'
	+ '	,M.e23_writer_name'
	+ '	,M.e23_writer_kana'
	+ '	,M.e23_series_name'
	+ '	,M.e23_series_kana'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_urd as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_urd as C'
	+ '                on M.e23_edi_timestamp = C.e23_edi_timestamp'
	+ '            where'
	+ '              C.e23_edi_timestamp is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e23_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e23_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e23_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9041,売上データ取得エラー'
    GOTO SP_ERR
  End

	------------------------------
	-- データ読み込み
	------------------------------
	Declare @e23_pos_no int
	Declare @e23_receipt_no int
	Declare @e23_goods_code_kubun char (1)
	Declare @e23_goods_code varchar (20)
	Declare @e23_c_code char (4)
	Declare @e23_henpin_count int 
	Declare @e23_tax_rate decimal(5, 2)
	Declare @e23_tanka money
	Declare @e23_tanka_sign char (1)
	Declare @e23_count int
	Declare @e23_plus_minus_shori int	--追加: 2019/11/28 - コア - THNNFS-159
	Declare @e23_tax_type char (1)
	Declare @e23_uriage_date varchar (8)
	Declare @e23_uriage_time varchar (8)
	Declare @e23_shop_cd_webpos varchar (10)
	Declare @a_plu_addon_cd varchar (20)
	-- 消費税率情報取得
	Declare @a_tax_price money
	Declare @a_cal_tax_price money
	Declare @a_unit_price money
	Declare @a_media_cd varchar(10)	-- メディアコード

	Declare @a_intax_count int      -- 内税品対象個数
	Declare @a_intax_sum money      -- 内税品対象額
	Declare @a_intax_tax_sum money  -- 内税額
	Declare @a_notax_count int		-- 非課税品対象個数
	Declare @a_notax_sum int		-- 非課税品対象額

	Declare @e23_count_sum int

	Declare @a_unit_price_receipt money
	Declare @a_intax_count_receipt int      -- 内税品対象個数
	Declare @a_intax_sum_receipt money      -- 内税品対象額
	Declare @a_intax_tax_sum_receipt money  -- 内税額
	Declare @a_notax_count_receipt int		-- 非課税品対象個数
	Declare @a_notax_sum_receipt int		-- 非課税品対象額
	Declare @a_edi_id_checkinput_ok varchar(100)
	DECLARE @a_count_checkinput_ok int
	DECLARE @a_e23_out_trn_id int
	DECLARE @a_e23_stk_goods_id int
	DECLARE @a_e23_sgd_goods_id int
	Declare @Work_P03 varchar(8000) -- 2019/08/26 P03の桁 > 8000の場合に対応
  -- 一時テーブル読み込み
  Set @rs2 = cursor static for
    SELECT
	 e23_shop_cd
	,e23_uriage_date
	,e23_uriage_time
	,e23_receipt_no
	,e23_pos_no
   FROM
     wbe_edibook_dw_urd
   WHERE
     e23_edi_flag = '0'  -- 未処理
   GROUP BY 
     e23_shop_cd
	,e23_uriage_date
	,e23_uriage_time
	,e23_receipt_no
	,e23_pos_no
   ORDER BY
     e23_shop_cd
	,e23_uriage_date
	,e23_uriage_time
	,e23_receipt_no
	,e23_pos_no

  -- カーソルを開く
  open @rs2
  -- @P_INOUT_TMPループ
  fetch next from @rs2 INTO
    @a_shop_cd
   ,@e23_uriage_date
   ,@e23_uriage_time
   ,@e23_receipt_no
   ,@e23_pos_no

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 BEGIN
	  SET @a_unit_price_receipt = 0 
	  SET @a_intax_count_receipt = 0    -- 内税品対象個数
	  SET @a_intax_sum_receipt = 0      -- 内税品対象額
	  SET @a_intax_tax_sum_receipt = 0  -- 内税額
	  SET @a_notax_count_receipt = 0 	-- 非課税品対象個数
	  SET @a_notax_sum_receipt = 0 		-- 非課税品対象額
	  SET @a_line_no = 0
	  SET @e23_count_sum = 0
	  SET @a_edi_id_checkinput_ok = ''
	  SET @a_count_checkinput_ok = 0
	  SET @P03 = ''
	  SET @e23_plus_minus_shori = 1		-- 売上→→プラス		--追加: 2019/11/28 - コア - THNNFS-159
	  -- 一時テーブル読み込み
	  Set @rs = cursor static for
		SELECT
		 e23_edi_id
		,e23_tushin_id	-- ここから下は面倒なので全フィールド
		,e23_pos_no
		,e23_receipt_no
		,e23_goods_code_kubun
		,e23_goods_code
		,e23_shop_cd_webpos
		,e23_c_code
		,e23_uriage_date
		,e23_uriage_time
		,e23_jan_cd
		,e23_tanka
		,e23_tanka_sign
		,e23_count
		,e23_tax_type
	   FROM
		 wbe_edibook_dw_urd
	   WHERE
		   e23_edi_flag = '0'  -- 未処理
	   AND e23_shop_cd = @a_shop_cd
       AND e23_receipt_no = @e23_receipt_no
       AND e23_pos_no = @e23_pos_no
       AND e23_uriage_date = @e23_uriage_date
       AND e23_uriage_time = @e23_uriage_time
	   ORDER BY
		 e23_shop_cd_webpos
		,e23_edi_file_line_no

	  -- カーソルを開く
	  open @rs

	  -- @P_INOUT_TMPループ
	  fetch next from @rs into
		@a_edi_id
		,@a_tushin_id
		,@e23_pos_no
		,@e23_receipt_no
		,@a_goods_code_kubun
		,@a_goods_code
		,@e23_shop_cd_webpos
		,@e23_c_code
		,@e23_uriage_date
		,@e23_uriage_time
		,@a_jan
		,@e23_tanka
		,@e23_tanka_sign
		,@e23_count
		,@e23_tax_type

		-- レコードがなくなるまで
		While @@FETCH_STATUS = 0 BEGIN
		  SET @a_line_no = @a_line_no + 1
		  -- 初期値セット
		  SELECT
			@a_edi_error_msg = null         -- エラーメッセージクリア
		   ,@a_edi_flag = '1'               -- EDIフラグ実行済み
		   ,@a_goods_id = null
		   ,@a_tax_type = '0'				-- 税抜
		-- 店舗コードチェック
		If ISNULL(@e23_shop_cd_webpos, '') = ''
		Begin   
			SET @a_edi_error_msg = '[店舗コード]が空です。'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		--2018/07/07　4桁未満の店舗コードも存在するためコメントアウト
		--If LEN(@e23_shop_cd_webpos) <> 4
		--Begin   
		--	SET @a_edi_error_msg = '[店舗コード]の桁数が4ﾊﾞｲﾄでありません。'
		--	SET @a_edi_flag = '3'  -- エラー
		--	-- 売上マスタ処理終了まで飛ばす
		--	GOTO LOOP_URIAGE_END
		--End
	
		-- 売上日付チェック
		If ISNULL(@e23_uriage_date, '') = ''
		Begin   
			SET @a_edi_error_msg = '[売上日付]が空です。'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		If ISDATE(@e23_uriage_date) = 0
		Begin   
			SET @a_edi_error_msg = '[売上日付]日付型でありません。'
			+ ' 売上日付=[' + isnull(@e23_uriage_date,'') + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
	
		-- 売上時間チェック
		If ISNULL(@e23_uriage_time, '') = ''
		Begin   
			SET @a_edi_error_msg = '[売上時間]が空です。'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End

		SET @e23_uriage_time = STUFF(STUFF(@e23_uriage_time,5,0,':'),3,0,':')
		If ISDATE(@e23_uriage_date + ' ' + @e23_uriage_time) = 0
		Begin   
			SET @a_edi_error_msg = '[売上時間]日付型でありません。'
								+ ' 売上時間=[' + isnull(@e23_uriage_time,'') + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
	
		-- JANコードチェック
		If ISNULL(@a_jan, '') = ''
		Begin   
			SET @a_edi_error_msg = '[JANコード]が空です。'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		If LEN(@a_jan) < 8
		Begin   
			SET @a_edi_error_msg = '[JANコード]桁数が8ﾊﾞｲﾄ未満です。'
			+ ' JANコード=[' + isnull(@a_jan,'') + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		If LEN(@a_jan) > 13
		Begin   
			SET @a_edi_error_msg = '[JANコード]桁数が13ﾊﾞｲﾄを超えています。'
			+ ' JANコード=[' + isnull(@a_jan,'') + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		If ISNUMERIC(@a_jan) = 0
		Begin   
			SET @a_edi_error_msg = '[JANコード]数値でありません。'
			+ ' JANコード=[' + isnull(@a_jan,'') + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
	
		-- 売上数チェック
		If ISNULL(@e23_count, '') = ''
		Begin   
			SET @a_edi_error_msg = '[売上数]が空です。]'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		If ISNUMERIC(@e23_count) = 0
		Begin   
			SET @a_edi_error_msg = '[売上数]数値でありません。'
			+ ' 売上数=[' + isnull(@e23_count,'') + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		SET @e23_count = ABS(@e23_count)
		If @e23_count < -9999 OR 9999 < @e23_count  
		Begin   
			SET @a_edi_error_msg = '[売上数]の範囲が不正です。'
			+ ' 売上数=[' + CAST(isnull(@e23_count,'')AS VARCHAR(10)) + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
	
		--販売時単価チェック
		If ISNULL(@e23_tanka, '') = ''
		Begin   
			SET @a_edi_error_msg = '[販売時単価]が空です。'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		If ISNUMERIC(@e23_tanka) = 0
		Begin   
			SET @a_edi_error_msg = '[販売時単価]数値でありません。'
			+ ' 販売時単価=[' + isnull(@e23_tanka,'') + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		SET @e23_tanka = ABS(@e23_tanka)
		If @e23_tanka < -9999999 OR 9999999 < @e23_tanka  
		Begin   
			SET @a_edi_error_msg = '[販売時単価]の範囲が不正です。'
			+ ' 販売時単価=[' + CAST(isnull(@e23_tanka,'')AS VARCHAR(15)) + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End
		-------------------------------
		-- 金額
		-------------------------------
		-- 範囲
		If (@e23_tanka*@e23_count) < -9999999 OR 9999999 < (@e23_tanka*@e23_count)
		Begin   
			SET @a_edi_error_msg = '[金額]の範囲が不正です。'
			+ ' 金額=[' + CAST(isnull(@e23_tanka*@e23_count,'')AS VARCHAR(15)) + ']'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		End

		----------------------------
		-- パラメタ作成処理
		----------------------------

		-- システム情報：自動発注フラグ
		Exec P_POSAP_Info
		@shop_cd            = @e23_shop_cd_webpos
		,@sp                ='1'
		,@sm1_tax_rate      = @a_tax_rate OUTPUT
		,@sm2_tax_rate_type = @a_tax_rate_type OUTPUT
	
		--業務区分
		--修正： 2019/11/28 - コア - THNNFS-159 - START
		--IF @e23_tanka_sign = '+'
		--BEGIN
		--	SET @a_work_type = '0000'
		--END
		--ELSE
		--BEGIN
		--	SET @a_work_type = '0001'
		--END
		SET @a_work_type = '0000'
		IF @e23_tanka_sign <> '+' BEGIN
			SET @e23_plus_minus_shori = -1		--売返→→マイナス
		END
		--修正： 2019/11/28 - コア - THNNFS-159 - END

		SET @a_e23_stk_goods_id = NULL
		SET @a_e23_sgd_goods_id = NULL
		-- 在庫マスタ、店舗独自商品マスタのどちらにも存在しない商品の売上明細は取り込まない、
        -- エラーとして中間テーブルにエラーメッセージ「在庫マスタまたは店舗独自商品マスタなし」をセット
		SELECT @a_e23_stk_goods_id = stk_goods_id
			  ,@a_e23_sgd_goods_id = sgd_goods_id
		FROM wpt_goods_master
		LEFT JOIN wpt_stock_master 
			ON gds_goods_id = stk_goods_id
			AND stk_shop_cd = @e23_shop_cd_webpos
			AND stk_condition_type = '0'
		LEFT OUTER JOIN
		wpt_shop_goods_master
			ON gds_goods_id = sgd_goods_id
			AND  sgd_franchise_id = (SELECT shm_franchise_id FROM wpt_shop_master WHERE shm_shop_cd = @e23_shop_cd_webpos)
			AND ( sgd_shop_cd = 0 OR sgd_shop_cd = @e23_shop_cd_webpos)
			AND sgd_delete_flag = '0'
		--WHERE gds_jan_cd = @a_jan						--修正： 2019/11/28 - コア - THNNFS-159
		WHERE ISNULL(sgd_jan_cd, gds_jan_cd) = @a_jan	--修正： 2019/11/28 - コア - THNNFS-159

		IF @a_e23_stk_goods_id IS NULL AND  @a_e23_sgd_goods_id IS NULL BEGIN
			-- 商品存在チェック  
			SET @a_edi_error_msg = '[在庫マスタまたは店舗独自商品マスタなし]'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		END

		-- 商品情報取得、PLU処理実行
		EXEC P_PLU
			@plu_cd          = @a_jan
			,@plu_type       = '0'
			,@shop_cd        = @e23_shop_cd_webpos
			,@sp             = '1'
			,@gds_goods_id   = @a_goods_id OUTPUT
			,@gds_goods_type = @a_goods_type OUTPUT
			,@gdm_media_cd   = @a_media_cd OUTPUT
			-- ,@gds_goods_name = @a_goods_name OUTPUT -- 2019/08/26 削除
			,@trm_tax_rate   = @a_tax_rate OUTPUT

		-- 2019/08/26 
		IF @a_goods_id IS NULL BEGIN
			-- 商品存在チェック  
			SET @a_edi_error_msg = '[商品マスタなし]'
			SET @a_edi_flag = '3'  -- エラー
			-- 売上マスタ処理終了まで飛ばす
			GOTO LOOP_URIAGE_END
		END
		-- 2019/08/26

		-- 税区分
		SET @a_tax_type = Case @e23_tax_type
							When '2' Then @e23_tax_type
							Else '0'
						   End
		SET @a_cal_tax_price = Case @a_tax_type
								When '2' Then 0 -- 非課税
								Else 
									CASE @a_tax_rate_type
									  when '0' then   -- 切り捨て
										floor(@e23_tanka * ( @a_tax_rate / 100 ) )
									  when '1' then   -- 四捨五入
										round(@e23_tanka * ( @a_tax_rate / 100 ) , 0 )
									  when '2' then   -- 切り上げ
										ceiling(@e23_tanka * ( @a_tax_rate / 100 ) )
									End
							 End 
		SET @a_tax_price = @a_cal_tax_price * @e23_count
		SET @a_price = Case @a_tax_type
						When '2' Then @e23_tanka -- 非課税
						Else @e23_tanka + @a_cal_tax_price
					End 

		SET @a_unit_price = @a_price * @e23_count
		SET @a_unit_price_receipt = @a_unit_price_receipt + @a_unit_price -- 同一レシートで1トラン、複数明細でp_transactionを実行
		SET @e23_count_sum = @e23_count_sum + @e23_count -- 同一レシートで1トラン、複数明細でp_transactionを実行
		-- 非課税品対象個数
		SET @a_notax_count = Case @a_tax_type
							When '2' then @e23_count
							Else 0
						  END
		SET @a_notax_count_receipt = @a_notax_count_receipt + @a_notax_count -- 同一レシートで1トラン、複数明細でp_transactionを実行
		-- 非課税品対象額
		SET @a_notax_sum = Case @a_tax_type
						  When '2' then @a_unit_price
						  Else 0
						END
		SET @a_notax_sum_receipt = @a_notax_sum_receipt + @a_notax_sum -- 同一レシートで1トラン、複数明細でp_transactionを実行
		-- 内税品対象個数
		SET @a_intax_count = Case @a_tax_type
							When '2' then 0
							Else @e23_count
						  END
		SET @a_intax_count_receipt = @a_intax_count_receipt + @a_intax_count-- 同一レシートで1トラン、複数明細でp_transactionを実行

		-- 内税品対象額
		SET @a_intax_sum = Case @a_tax_type
							When '2' then 0
							Else @a_unit_price
						  END
		SET @a_intax_sum_receipt = @a_intax_sum_receipt + @a_intax_sum -- 同一レシートで1トラン、複数明細でp_transactionを実行
		-- 内税額
		SET @a_intax_tax_sum = Case @a_tax_type
								When '2' then 0
								Else @a_tax_price
							  END
		SET @a_intax_tax_sum_receipt = @a_intax_tax_sum_receipt + @a_intax_tax_sum -- 同一レシートで1トラン、複数明細でp_transactionを実行

		
		-- SET @a_plu_addon_cd = ISNULL(dbo.F_Create_Book2ndJAN( @e23_c_code, @e23_tanka ), '') -- 2019/08/26 削除
	
		-- 2019/09/11 THNNFS-131 mediastore　ASP＞CSVダウンロード＞レシートデータ出力 売上単価(税抜） 売上単価（税込）の値が不正
	    SET @e23_tax_type = CASE @e23_tax_type 
								WHEN '0' THEN '1'
								WHEN '1' THEN '1'
								WHEN '2' THEN @e23_tax_type
							END
		-- @P03パラメータにセートする。

		SET @a_goods_name = REPLACE( @a_goods_name, ',', '　' ) 
		SET @a_goods_name = REPLACE( @a_goods_name, '、', '　' ) 

		IF @P03 <> '' BEGIN
			SET @P03 = @P03 + ','
		END
		SET @Work_P03 = '' -- 2019/08/26 P03の桁 > 8000の場合に対応
		SELECT @Work_P03 = '' -- 2019/08/26　P03の桁 > 8000の場合に対応
			+ convert(varchar, @a_line_no)                    								-- 明細番号
			+ ',0'                                                                          -- 明細区分     
			+ ',0'                                                                          -- 親明細番号
			+ ',' + convert(varchar, ISNULL(@a_goods_id, ''))                               -- 商品ＩＤ
			+ ',' + ISNULL(@a_goods_type, '')                                               -- 商材区分（商品区分）
			+ ',' + ISNULL(@a_goods_name, '')												-- 商品名
			+ ',0'                                                                          -- 商品区分
			+ ',' + ISNULL(@e23_tax_type, '0')                                              -- 税区分
			+ ',' + convert(varchar, @a_price)                                              -- PLU単価
			+ ',' + convert(varchar, @a_price)                                              -- 単価
			+ ',0'                                                                          -- 単品値引額
			--+ ',' + convert(varchar, @e23_count)                                          -- 売上個数		--修正： 2019/11/28 - コア - THNNFS-159
			+ ',' + convert(varchar, @e23_count * @e23_plus_minus_shori)                    -- 売上個数		--修正： 2019/11/28 - コア - THNNFS-159
			+ ',' + convert(varchar, @a_unit_price)                                         -- 売価（按分前）
			--+ ',' + convert(varchar, @e23_tanka * @e23_count)      			            -- 売価（按分後・税抜き）		--修正： 2019/11/28 - コア - THNNFS-159
			+ ',' + convert(varchar, @e23_tanka * @e23_count * @e23_plus_minus_shori)      	-- 売価（按分後・税抜き）		--修正： 2019/11/28 - コア - THNNFS-159
			+ ',' + convert(varchar, @a_tax_price)                                          -- 税額（按分後）
			+ ',0'		                                                                    -- 加算ポイント
			+ ',0'                                                                          -- ポイント率
			+ ',' + @a_jan                                                                  -- PLUコード
			-- + ',' + @a_plu_addon_cd                                                      -- PLUアドオンコード -- 2019/08/26 削除
			+ ',' + ISNULL(@a_plu_addon_cd,'')                                              -- PLUアドオンコード
			+ ',' + @a_tax_rate_type                                                        -- 税計算区分
			+ ',' + convert(varchar, @a_tax_rate)                                           -- 税率
			+ ',0'                                                                          -- 免税フラグ
			+ ',0'                                                                          -- セット種別
			+ ',0'                                                                          -- セット内最必須フラグ
			+ ',0'                                                                          -- セット価格対象フラグ
			+ ','                                                                           -- 単価変更フラグ
			+ ','                                                                           -- 特売商品群ＩＤ
			+ ','                                                                           -- 特売ＩＤ
			+ ',' + ISNULL(@a_media_cd, '')                                                 -- メディアコード
			+ ',' 																			-- 予約業務ＩＤ
		  
		  SET @P03 = @P03 + @Work_P03 -- 2019/08/26　P03の桁 > 8000の場合に対応 	

		  IF @a_edi_id_checkinput_ok <> '' BEGIN
			SET @a_edi_id_checkinput_ok = @a_edi_id_checkinput_ok + ','
		  END
		  SET @a_edi_id_checkinput_ok = @a_edi_id_checkinput_ok + cast(@a_edi_id AS varchar(10))
		  -- 返品処理終了ラベル
		  LOOP_URIAGE_END:

		  -- 処理結果記録
		  Set @a_getdate = getdate()
		  UPDATE wbe_edibook_dw_urd SET
				e23_edi_flag = @a_edi_flag
			   ,e23_edi_error_msg = @a_edi_error_msg
			   ,e23_edi_update_date = @a_getdate
			 where
				e23_edi_id = @a_edi_id

		  -- カウント初期レコードセット
		  If Not Exists(SELECT top 1 *
						from #count_tbl
						where
						  t_exec_id = substring(@edi_type,1,2)
						  and
						  t_tushin_id = @a_tushin_id ) Begin
			INSERT INTO #count_tbl (
				t_exec_id
			   ,t_tushin_id
			   ,t_count_all
			   ,t_count_ok
			   ,t_count_wa
			   ,t_count_ng
			  )
			  SELECT
				t_exec_id = substring(@edi_type,1,2)
			   ,t_tushin_id = @a_tushin_id
			   ,t_count_all = 0
			   ,t_count_ok = 0
			   ,t_count_wa = 0
			   ,t_count_ng = 0
		  End

		  -- 処理カウント更新
		  UPDATE #count_tbl SET
			 t_count_all = t_count_all + 1
			,t_count_ok = -- 正常
				 Case
				   when @a_edi_flag = '1' then t_count_ok + 1
				   else t_count_ok
				 End
			,t_count_wa = -- 警告
				 Case
				   when @a_edi_flag = '2' then t_count_wa + 1
				   else t_count_wa
				 End
			,t_count_ng = -- エラー
				 Case
				   when @a_edi_flag = '3' then t_count_ng + 1
				   else t_count_ng
				 End
			where
			   t_exec_id = substring(@edi_type,1,2)
			   and
			   t_tushin_id = @a_tushin_id

		  -- 次へ
		  fetch next from @rs into
		 @a_edi_id
		,@a_tushin_id
		,@e23_pos_no
		,@e23_receipt_no
		,@a_goods_code_kubun
		,@a_goods_code
		,@e23_shop_cd_webpos
		,@e23_c_code
		,@e23_uriage_date
		,@e23_uriage_time
		,@a_jan
		,@e23_tanka
		,@e23_tanka_sign
		,@e23_count
		,@e23_tax_type
		End  -- While
	  -- カーソルを閉じる
	  close @rs
	  -- 開放
	  deallocate @rs

      SET @P01 = ''
      	+ '0002.0002'                                                                   -- パラメタ受け渡しバージョン
      	+ ',' + object_name(@@PROCID) + '_' + @edi_type                                 -- アプリケーションバージョン
      	+ ',' + cast(@e23_shop_cd_webpos as varchar(10))                                -- 店舗コード
      	+ ',' + @a_work_type                                                            -- 業務区分
      	+ ',0'                                                                          -- 伝票区分
      	+ ',' + cast(@e23_pos_no as varchar(11))										-- POS番号
      	+ ',' + convert(varchar, @e23_uriage_date + ' ' + @e23_uriage_time ,120)		-- 取引日
      	+ ',' + convert(varchar, @e23_uriage_date + ' ' + @e23_uriage_time ,120)        -- ＰＯＳ取引日時
      	+ ',' + cast(@e23_receipt_no as varchar(11))									-- レシート番号	--変更
      	+ ','																			-- 担当ＩＤ		
      	+ ','                                                                           -- 担当コード	
      	+ ','                                                                           -- 会員ＩＤ
      	+ ','                                                                           -- 会員コード
      	+ ','                                                                           -- 会員カードコード
      	+ ',' + cast(@e23_shop_cd_webpos as varchar(10))                                -- 操作店舗コード
      	+ ','                                                                           -- 紐付け元取引ＩＤ
      	+ ','                                                                           -- 紐付け元業務区分
      	+ ',' 														                    -- 追加処理用取引ＩＤ
      	+ ',0'                                                                          -- 再登録フラグ
      
	  	--修正： 2019/11/28 - コア - THNNFS-159 - START
		IF @e23_tanka_sign <> '+' BEGIN
			SET @a_notax_count_receipt = @a_notax_count_receipt * @e23_plus_minus_shori
			SET @a_intax_count_receipt = @a_intax_count_receipt * @e23_plus_minus_shori
			SET @e23_count_sum = @e23_count_sum * @e23_plus_minus_shori
		END
	  	--修正： 2019/11/28 - コア - THNNFS-159 - END
      -- @P02パラメータにセートする。
      SET @P02 = ''
      	+ '0'                                                                           -- 取引区分								
      	+ ',' 															                -- 客層コード
      	+ ',1' 														                    -- 客数
      	+ ',' + convert(varchar, @e23_count_sum)										-- 取引合計個数
      	+ ',' + convert(varchar, @a_unit_price_receipt)                                 -- 取引合計額
      	+ ',' + convert(varchar, @a_unit_price_receipt)							        -- 小計
      	+ ',' + convert(varchar, @a_unit_price_receipt)                                 -- 預かり金
      	+ ',0'                                                                          -- お釣り
      	+ ',0'                                                                          -- 外税品対象個数
      	+ ',0'                                                                          -- 外税品対象額
      	+ ',0'                                                                          -- 外税額
      	+ ',0'                                                                          -- 外税品対象値引き額
      	+ ',' + convert(varchar, @a_intax_count_receipt)                                -- 内税品対象個数
      	+ ',' + convert(varchar, @a_intax_sum_receipt)                                  -- 内税品対象額
      	+ ',' + convert(varchar, @a_intax_tax_sum_receipt)                              -- 内税額
      	+ ',0'                                                                          -- 内税品対象値引き額
      	+ ',' + convert(varchar, @a_notax_count_receipt)                                -- 非課税品対象個数
      	+ ',' + convert(varchar, @a_notax_sum_receipt)                                  -- 非課税品対象額
      	+ ',0'                                                                          -- 非課税品対象値引き額
      	+ ',0'                                                                          -- 小計値引額合計
      	+ ',0'                                                                          -- 単品値引額合計
      	+ ',0'                                                                          -- ポイント処理区分
      	+ ',0'                                                                          -- 取引前ポイント
      	+ ',0'                                                                          -- 使用ポイント
      	+ ',0'                                                                          -- 使用ポイント単価
      	+ ',0'                                                                          -- 加算ポイント
      	+ ',0'                                                                          -- 加算ポイント単価
      	+ ',0'                                                                          -- 外税額支払分
      	+ ',' + convert(varchar, @a_intax_tax_sum_receipt)		                        -- 内税額支払分
      	+ ',0'                                                                          -- 内税品対象免税額
      	+ ',0'                                                                          -- 免税フラグ
      	+ ',0'                                                                          -- 残額
      	+ ','                                                                           -- メモ
      	+ ',0'                                                                          -- 特記事項
      
      -- @P04パラメータにセートする。
      SET @P04 = ''
      	+ '00'																            -- 支払コード
      	+ ',00'																            -- 支払明細コード
      	+ ','																            -- クレジットナンバー
      	+ ','																            -- 認証Ｎｏ．
      	+ ','																            -- 認証時刻
      	+ ','																            -- 認証方法
      	+ ',' + convert(varchar, @a_unit_price_receipt)								    -- 設定額
      	+ ',' + convert(varchar, @a_unit_price_receipt)								    -- 適応額
      	+ ','																            -- 雑収入
      	+ ','																            -- 雑損
      	+ ','																            -- 単位あたり金額
      	+ ','																            -- 単位あたり数量
      
      -- @P05パラメータにセートする。追加：2018/06/22
      SET @P05 = ''
      	+ '00'																            -- 値引コード
      	+ ',00'																            -- 値引明細コード
      	+ ',0'																            -- 金額
      	+ ',0'																            -- 単位あたり金額
      	+ ',1'																            -- 単位あたり数量
      IF @P03 <> '' BEGIN
	    --SPキック
	    Exec @rc = P_transaction
		@P01 = @P01
	   ,@P02 = @P02
	   ,@P03 = @P03
	   ,@P04 = @P04
	   ,@P05 = @P05
	   ,@SP  = '1'
	   ,@err_msg = @err_msg OUTPUT
	   ,@out_trn_id = @a_e23_out_trn_id OUTPUT
		-- エラーチェック
		If @rc <> 0 Begin
		  -- エラー記録
		  SELECT
			@a_edi_error_msg = '処理（取引）ＳＰエラー'
				+ ',m=[' + isnull(@err_msg,'') + ']'
				+ ',@P01=[' + isnull(@P01,'') + ']'
				+ ',@P02=[' + isnull(@P02,'') + ']'
				+ ',@P03=[' + isnull(@P03,'') + ']'
			,@a_edi_flag = '3'  -- エラー

			UPDATE wbe_edibook_dw_urd SET
					e23_edi_flag = @a_edi_flag
				   ,e23_edi_error_msg = @a_edi_error_msg
				   ,e23_edi_update_date = @a_getdate
				 where
					e23_edi_id IN (SELECT cast(dataValue as int) FROM dbo.wapi_fnSplit ( @a_edi_id_checkinput_ok , ',' ))

			SELECT @a_count_checkinput_ok = (SELECT count(*) FROM dbo.wapi_fnSplit ( @a_edi_id_checkinput_ok , ',' ))

			UPDATE #count_tbl SET
			  t_count_ok = t_count_ok - @a_count_checkinput_ok
			 ,t_count_ng = t_count_ng + @a_count_checkinput_ok

		 END ELSE BEGIN
			DECLARE @a_tdu_hontai money
			SET @a_tdu_hontai = 0
			-- 売上データ取り込み時・トランザクションデータへの原価セット
			UPDATE wpt_transaction_uriage_details
				SET @a_tdu_hontai = tdu_hontai = 
				CASE 
				WHEN ISNULL(stk_price, 0) <> 0 THEN 
					CASE tdu_tax_rate_type
						when '0' then   -- 切り捨て
						stk_price - floor(stk_price / (100 + tdu_tax_rate) * tdu_tax_rate)
						when '1' then   -- 四捨五入
						stk_price - round(stk_price / (100 + tdu_tax_rate) * tdu_tax_rate, 0)
						when '2' then   -- 切り上げ
						stk_price - ceiling(stk_price / (100 + tdu_tax_rate) * tdu_tax_rate)
					END
				WHEN ISNULL(sgd_price, 0) <> 0 AND ISNULL(stk_price, 0) = 0 THEN
					CASE sgd_price_type
						WHEN '1' THEN
							CASE tdu_tax_rate_type
								when '0' then   -- 切り捨て
								sgd_price - floor(sgd_price / (100 + tdu_tax_rate) * tdu_tax_rate)
								when '1' then   -- 四捨五入
								sgd_price - round(sgd_price / (100 + tdu_tax_rate) * tdu_tax_rate, 0)
								when '2' then   -- 切り上げ
								sgd_price - ceiling(sgd_price / (100 + tdu_tax_rate) * tdu_tax_rate)
							END
						ELSE sgd_price
					END
				WHEN ISNULL(gds_price, 0) <> 0 AND ISNULL(stk_price, 0) = 0 AND ISNULL(sgd_price, 0) = 0 THEN
					CASE gds_price_type
						WHEN '1' THEN
							CASE tdu_tax_rate_type
								when '0' then   -- 切り捨て
								gds_price - floor(gds_price / (100 + tdu_tax_rate) * tdu_tax_rate)
								when '1' then   -- 四捨五入
								gds_price - round(gds_price / (100 + tdu_tax_rate) * tdu_tax_rate, 0)
								when '2' then   -- 切り上げ
								gds_price - ceiling(gds_price / (100 + tdu_tax_rate) * tdu_tax_rate)
							END
						ELSE gds_price
					END
				END
				* @e23_plus_minus_shori	--追加： 2019/11/28 - コア - THNNFS-159
				,tdu_gentanka = 
					CASE
					WHEN shm_shomi_type = 'D' AND gdd_shomi_flag = '1' THEN 
						--修正：2019/11/07 - コア - THNNFS-118 No.7 - START
						round(@a_tdu_hontai * shm_shomi_rate2 / 100, 0 )	-- 四捨五入
						--CASE tdu_tax_rate_type
							--when '0' then   -- 切り捨て
							--floor(@a_tdu_hontai * shm_shomi_rate2 / 100)
							--when '1' then   -- 四捨五入
							--round(@a_tdu_hontai * shm_shomi_rate2 / 100, 0 )
							--when '2' then   -- 切り上げ
							--ceiling(@a_tdu_hontai * shm_shomi_rate2 / 100)
						--END
					ELSE
						round(@a_tdu_hontai * shm_shomi_rate1 / 100, 0 )	-- 四捨五入
						--CASE tdu_tax_rate_type
							--when '0' then   -- 切り捨て
							--floor(@a_tdu_hontai * shm_shomi_rate1 / 100)
							--when '1' then   -- 四捨五入
							--round(@a_tdu_hontai * shm_shomi_rate1 / 100, 0 )
							--when '2' then   -- 切り上げ
							--ceiling(@a_tdu_hontai * shm_shomi_rate1 / 100)
						--END
						--修正：2019/11/07 - コア - THNNFS-118 No.7 - END
					END
			FROM wpt_transaction
			JOIN wpt_transaction_uriage_details
				ON trn_trn_id = tdu_trn_id
			JOIN wpt_goods_master_disk
				ON tdu_goods_id = gdd_goods_id
			JOIN wpt_shop_master
				ON trn_shop_cd = shm_shop_cd
			LEFT JOIN wpt_stock_master
				ON tdu_goods_id = stk_goods_id
				AND stk_shop_cd = @e23_shop_cd_webpos
				AND stk_condition_type = 0
			LEFT JOIN wpt_shop_goods_master
				ON tdu_goods_id = sgd_goods_id
				AND sgd_shop_cd = trn_shop_cd
				AND sgd_franchise_id = shm_franchise_id
			LEFT JOIN wpt_goods_master
				ON tdu_goods_id = gds_goods_id
			WHERE trn_trn_id = @a_e23_out_trn_id
		 END
	END

  -- 次へ
  fetch next from @rs2 INTO
    @a_shop_cd
   ,@e23_uriage_date
   ,@e23_uriage_time
   ,@e23_receipt_no
   ,@e23_pos_no
  End  -- While
  
  -- カーソルを閉じる
  close @rs2
  -- 開放
  deallocate @rs2

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9042,売上データ同期エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9043,売上ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_URIAGE_END:


--=================================================
-- 下り請求処理
--=================================================
DOWN_SEIKYU:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック

  If @rc <> 0 Begin
    Set @err_msg = '9030,請求サーバ情報セット不正'
    GOTO SP_ERR
  End


  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_sku ('
	+ '	 e24_edi_flag'
	+ '	,e24_edi_timestamp'
	+ '	,e24_edi_id'
	+ '	,e24_edi_create_date'
	+ '	,e24_edi_update_date'
	+ '	,e24_edi_file_line_no'
	+ '	,e24_edi_error_msg'
	+ '	,e24_server_webpos'
	+ '	,e24_dbname_webpos'
	+ '	,e24_shop_cd_webpos'
	+ '	,e24_shop_name_webpos'
	+ '	,e24_seq_no'
	+ '	,e24_shop_cd_primary'
	+ '	,e24_shop_cd'
	+ '	,e24_tushin_id'
	+ '	,e24_seikyu_date'
	+ '	,e24_goods_shubetu'
	+ '	,e24_denpyo_date'
	+ '	,e24_denpyo_no'
	+ '	,e24_shoumi_price'
	+ '	,e24_shoumi_sign'
	+ '	,e24_teika_price'
	+ '	,e24_teika_sign'
	+ '	,e24_goods_count'
	+ '	,e24_goods_count_sign'
	+ '	,e24_sime_date'
	+ '	,e24_tax_type'
	+ '	,e24_tax_rate'
	+ '	,e24_hensou_kubun'
	+ '	)'
	+ '	SELECT'
	+ '	 M.e24_edi_flag'
	+ '	,M.e24_edi_timestamp'
	+ '	,M.e24_edi_id'
	+ '	,M.e24_edi_create_date'
	+ '	,M.e24_edi_update_date'
	+ '	,M.e24_edi_file_line_no'
	+ '	,M.e24_edi_error_msg'
	+ '	,M.e24_server_webpos'
	+ '	,M.e24_dbname_webpos'
	+ '	,M.e24_shop_cd_webpos'
	+ '	,M.e24_shop_name_webpos'
	+ '	,M.e24_seq_no'
	+ '	,M.e24_shop_cd_primary'
	+ '	,M.e24_shop_cd'
	+ '	,M.e24_tushin_id'
	+ '	,M.e24_seikyu_date'
	+ '	,M.e24_goods_shubetu'
	+ '	,M.e24_denpyo_date'
	+ '	,M.e24_denpyo_no'
	+ '	,M.e24_shoumi_price'
	+ '	,M.e24_shoumi_sign'
	+ '	,M.e24_teika_price'
	+ '	,M.e24_teika_sign'
	+ '	,M.e24_goods_count'
	+ '	,M.e24_goods_count_sign'
	+ '	,M.e24_sime_date'
	+ '	,M.e24_tax_type'
	+ '	,M.e24_tax_rate'
	+ '	,M.e24_hensou_kubun'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_sku as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_sku as C'
	+ '                on M.e24_edi_id = C.e24_edi_id'
	+ '            where'
	+ '              C.e24_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e24_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e24_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e24_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9031,請求データ取得エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e24_tushin_id char (2)
  Declare @e24_seikyu_date char (8)
  Declare @e24_goods_shubetu char (2)
  Declare @e24_denpyo_date char (8)
  Declare @e24_denpyo_no varchar (10)
  Declare @e24_shoumi_price money 
  Declare @e24_shoumi_sign char (1)
  Declare @e24_teika_price money 
  Declare @e24_teika_sign char (1)
  Declare @e24_goods_count int 
  Declare @e24_goods_count_sign char (1)
  Declare @e24_sime_date char (8)
  Declare @e24_tax_type char (1)
  Declare @e24_tax_rate decimal(5, 2)
  Declare @e24_hensou_kubun char (2)


  -- 一時テーブル読み込み
  Set @rs = cursor static for
       SELECT
	 e24_edi_id
	,e24_edi_file_line_no
	,e24_tushin_id
	,e24_shop_cd_webpos as e24_shop_cd_webpos_order
	,e24_denpyo_date as e24_denpyo_date_order
	,e24_denpyo_no as e24_denpyo_no_order
	,e24_tushin_id  -- ここから下は面倒なので全フィールド
	,e24_seikyu_date
	,e24_goods_shubetu
	,e24_denpyo_date
	,e24_denpyo_no
	,e24_shoumi_price
	,e24_shoumi_sign
	,e24_teika_price
	,e24_teika_sign
	,e24_goods_count
	,e24_goods_count_sign
	,e24_sime_date
	,e24_tax_type
	,e24_tax_rate
	,e24_hensou_kubun
            from
              wbe_edibook_dw_sku
            where
              e24_edi_flag = '0'  -- 未処理
            order by
               e24_shop_cd_webpos_order
              ,e24_denpyo_date_order
              ,e24_denpyo_no_order

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_file_line_no
	,@a_tushin_id
	,@a_shop_cd
	,@a_denpyo_date
	,@a_denpyo_no
	,@e24_tushin_id  -- ここから下は面倒なので全フィールド
	,@e24_seikyu_date
	,@e24_goods_shubetu
	,@e24_denpyo_date
	,@e24_denpyo_no
	,@e24_shoumi_price
	,@e24_shoumi_sign
	,@e24_teika_price
	,@e24_teika_sign
	,@e24_goods_count
	,@e24_goods_count_sign
	,@e24_sime_date
	,@e24_tax_type
	,@e24_tax_rate
	,@e24_hensou_kubun

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み

      -- データそのままインサートのみ
      INSERT wpt_book_edi_seikyu_data (
	 bei_shop_cd
	,bei_tushin_id
	,bei_seikyu_date
	,bei_goods_shubetu
	,bei_denpyo_date
	,bei_denpyo_no
	,bei_shoumi_price
	,bei_shoumi_sign
	,bei_teika_price
	,bei_teika_sign
	,bei_goods_count
	,bei_goods_count_sign
	,bei_sime_date
	,bei_tax_type
	,bei_tax_rate
	,bei_hensou_kubun
	)
        SELECT
	 bei_shop_cd = @a_shop_cd
	,bei_tushin_id = @a_tushin_id
	,bei_seikyu_date = @e24_seikyu_date
	,bei_goods_shubetu = @e24_goods_shubetu
	,bei_denpyo_date = @a_denpyo_date
	,bei_denpyo_no = @a_denpyo_no
	,bei_shoumi_price = @e24_shoumi_price
	,bei_shoumi_sign = @e24_shoumi_sign
	,bei_teika_price = @e24_teika_price
	,bei_teika_sign = @e24_teika_sign
	,bei_goods_count = @e24_goods_count
	,bei_goods_count_sign = @e24_goods_count_sign
	,bei_sime_date = @e24_sime_date
	,bei_tax_type = @e24_tax_type
	,bei_tax_rate = @e24_tax_rate
	,bei_hensou_kubun = @e24_hensou_kubun

      -- エラーチェック
      If @rc <> 0 Begin
        -- エラー記録
        SELECT
           @a_edi_error_msg = '請求挿入エラー'
               + ' den=[' + isnull(@a_denpyo_date,'') + ']'
               + ',den_no=[' + isnull(@a_denpyo_no,'') + ']'
          ,@a_edi_flag = '3'  -- エラー
      End



      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_sku SET
            e24_edi_flag = @a_edi_flag
           ,e24_edi_error_msg = @a_edi_error_msg
           ,e24_edi_update_date = @a_getdate
         where
            e24_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id



      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_file_line_no
	,@a_tushin_id
	,@a_shop_cd
	,@a_denpyo_date
	,@a_denpyo_no
	,@e24_tushin_id  -- ここから下は面倒なので全フィールド
	,@e24_seikyu_date
	,@e24_goods_shubetu
	,@e24_denpyo_date
	,@e24_denpyo_no
	,@e24_shoumi_price
	,@e24_shoumi_sign
	,@e24_teika_price
	,@e24_teika_sign
	,@e24_goods_count
	,@e24_goods_count_sign
	,@e24_sime_date
	,@e24_tax_type
	,@e24_tax_rate
	,@e24_hensou_kubun
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs


  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9032,請求データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9033,請求ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK


DOWN_SEIKYU_END:

--=================================================
-- 下り廃盤処理
--=================================================
DOWN_HAIBAN:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9040,銘柄サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_hbn ('
	+ '	 e25_edi_flag'
	+ '	,e25_edi_timestamp'
	+ '	,e25_edi_id'
	+ '	,e25_edi_create_date'
	+ '	,e25_edi_update_date'
	+ '	,e25_edi_file_line_no'
	+ '	,e25_edi_meisai_no'
	+ '	,e25_edi_error_msg'
	+ '	,e25_server_webpos'
	+ '	,e25_dbname_webpos'
	+ '	,e25_shop_cd_webpos'
	+ '	,e25_shop_name_webpos'
	+ '	,e25_seq_no'
	+ '	,e25_shop_cd_primary'
	+ '	,e25_shop_cd'
	+ '	,e25_tushin_id'
	+ '	,e25_goods_code_kubun'
	+ '	,e25_goods_code'
	+ '	,e25_haiban_date'
	+ '	,e25_cd_kikaku_bango'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e25_edi_flag'
	+ '	,M.e25_edi_timestamp'
	+ '	,M.e25_edi_id'
	+ '	,M.e25_edi_create_date'
	+ '	,M.e25_edi_update_date'
	+ '	,M.e25_edi_file_line_no'
	+ '	,M.e25_edi_meisai_no'
	+ '	,M.e25_edi_error_msg'
	+ '	,M.e25_server_webpos'
	+ '	,M.e25_dbname_webpos'
	+ '	,M.e25_shop_cd_webpos'
	+ '	,M.e25_shop_name_webpos'
	+ '	,M.e25_seq_no'
	+ '	,M.e25_shop_cd_primary'
	+ '	,M.e25_shop_cd'
	+ '	,M.e25_tushin_id'
	+ '	,M.e25_goods_code_kubun'
	+ '	,M.e25_goods_code'
	+ '	,M.e25_haiban_date'
	+ '	,M.e25_cd_kikaku_bango'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_hbn as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_hbn as C'
	+ '                on M.e25_edi_id = C.e25_edi_id'
	+ '            where'
	+ '              C.e25_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e25_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e25_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e25_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9041,廃盤データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e25_tushin_id char (2)
  Declare @e25_goods_code_kubun char (1)
  Declare @e25_goods_code varchar (20)
  Declare @e25_haiban_date char (8)
  Declare @e25_cd_kikaku_bango varchar (15)

  Declare @e25_mst_supdate_flag char(1)

--  SET ROWCOUNT 10000

  -- 一時テーブル読み込み
  Set @rs = cursor static for
       SELECT
	 e25_edi_id
	,e25_tushin_id
	,e25_goods_code_kubun
	,e25_goods_code
	,e25_haiban_date
	,e25_cd_kikaku_bango
            from
              wbe_edibook_dw_hbn
            where
              e25_edi_flag = '0'  -- 未処理
            order by
              e25_edi_file_line_no
             ,e25_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@e25_haiban_date
	,@e25_cd_kikaku_bango

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み
       ,@a_goods_id = null
       ,@a_jan = null

      -- コードチェック
      If @a_goods_code is null or rtrim(ltrim(@a_goods_code)) = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '商品コードなし'
               + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- 書籍チェック
      If @a_goods_code_kubun = '1' and
         len(@a_goods_code) <> 10 Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '書籍コード(ISBN)不正'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- 雑誌チェック(新・旧)
      If @a_goods_code_kubun in ( '2', '8' ) Begin 
          -- エラー記録
          SELECT
             @a_edi_error_msg = '雑誌コード対象外'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- 対象外コードチェック（商品コード0の場合）
      If isnumeric(@a_goods_code) = 1 and 
         ( cast(ltrim(rtrim(@a_goods_code)) as bigint) = 0 ) Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '対象外コード'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- 栗田対象外コードチェック
      If ltrim(rtrim(@a_goods_code)) = '999999999'
         or ltrim(rtrim(@a_goods_code)) = '9999999999' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '栗田対象外コード'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- 社内コードチェック
      If @a_goods_code_kubun = '6' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '対象外コード'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- インストアコードチェック
      If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
	     and len(ltrim(rtrim(@a_goods_code))) = 13 Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '対象外コード(インストア)'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- JAN生成
      SELECT
          @a_jan =
            case
              when @a_goods_code_kubun = '1' then dbo.F_Create_BookJAN(@a_goods_code)
              else @a_goods_code
            End
         
      If isnull(@a_jan,'') = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = 'JAN生成エラー'
                + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
                + ',エラーコード=[' + isnull(@a_jan,'') + ']'
            ,@a_edi_flag = '3'  -- エラー


          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

      -- 商品マスタが既にある場合フラグセット
      SET @e25_mst_supdate_flag = '0'
	  SET @a_goods_id = null
      If Exists ( select top 1 *
			 from wpt_goods_master
			 where gds_jan_cd = @a_jan ) Begin
		Select
		   @a_goods_id = gds_goods_id
		  ,@e25_mst_supdate_flag = '1'	
		 from wpt_goods_master
			 where gds_jan_cd = @a_jan
          
      End

      -- マスタなしは飛ばし
      If @e25_mst_supdate_flag = '0' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '象外マスタなし'
                 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
                 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
            ,@a_edi_flag = '2'  -- 警告

          -- ループ終了まで飛ばす
          GOTO LOOP_END_HBN
      End

       -- マスタUPDATE
       UPDATE wpt_goods_master SET
	 gds_update_date = getdate()
	,gds_update_memo = object_name(@@PROCID) + '[hbn]' + '[' + isnull(@a_tushin_id,'') +  ']'
	,gds_product_stop_flag = '1'
	,gds_product_stop_date = isnull(dbo.F_Convert_TextDate_Date(@e25_haiban_date,@a_getdate_date),gds_product_stop_date)
	from
	  wpt_goods_master
	where
	  gds_goods_id = @a_goods_id

       -- ＣＤ・ＤＶＤ
       If @a_goods_code_kubun = '5' Begin
         -- マスタUPDATE
         UPDATE wpt_goods_master_disk SET
	 gdd_lifecycle_type = '9' -- 廃盤
	from
	  wpt_goods_master_disk
	where
	  gdd_goods_id = @a_goods_id
      End

      If @@ERROR <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = 'マスタ更新エラー'
                  + ' cd=[' + isnull(@a_jan,'') + ']'
             ,@a_edi_flag = '3'  -- エラー
      End

      -- ループ終了ラベル
      LOOP_END_HBN:

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_hbn SET
            e25_edi_flag = @a_edi_flag
           ,e25_edi_error_msg = @a_edi_error_msg
           ,e25_edi_update_date = @a_getdate
         where
            e25_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@a_goods_code_kubun
	,@a_goods_code
	,@e25_haiban_date
	,@e25_cd_kikaku_bango
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9042,廃盤データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9043,廃盤ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK


DOWN_HAIBAN_END:

--=================================================
-- 下りメーカレーベル処理
--=================================================
DOWN_LABEL:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9050,メーカレーベルサーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_mlm ('
	+ '	 e26_edi_flag'
	+ '	,e26_edi_timestamp'
	+ '	,e26_edi_id'
	+ '	,e26_edi_create_date'
	+ '	,e26_edi_update_date'
	+ '	,e26_edi_file_line_no'
	+ '	,e26_edi_meisai_no'
	+ '	,e26_edi_error_msg'
	+ '	,e26_server_webpos'
	+ '	,e26_dbname_webpos'
	+ '	,e26_shop_cd_webpos'
	+ '	,e26_shop_name_webpos'
	+ '	,e26_seq_no'
	+ '	,e26_shop_cd_primary'
	+ '	,e26_shop_cd'
	+ '	,e26_tushin_id'
	+ '	,e26_label_cd'
	+ '	,e26_sales_cd'
	+ '	,e26_label_name'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e26_edi_flag'
	+ '	,M.e26_edi_timestamp'
	+ '	,M.e26_edi_id'
	+ '	,M.e26_edi_create_date'
	+ '	,M.e26_edi_update_date'
	+ '	,M.e26_edi_file_line_no'
	+ '	,M.e26_edi_meisai_no'
	+ '	,M.e26_edi_error_msg'
	+ '	,M.e26_server_webpos'
	+ '	,M.e26_dbname_webpos'
	+ '	,M.e26_shop_cd_webpos'
	+ '	,M.e26_shop_name_webpos'
	+ '	,M.e26_seq_no'
	+ '	,M.e26_shop_cd_primary'
	+ '	,M.e26_shop_cd'
	+ '	,M.e26_tushin_id'
	+ '	,M.e26_label_cd'
	+ '	,M.e26_sales_cd'
	+ '	,M.e26_label_name'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_mlm as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_mlm as C'
	+ '                on M.e26_edi_id = C.e26_edi_id'
	+ '            where'
	+ '              C.e26_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e26_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e26_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e26_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9051,メーカレーベルデータ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e26_tushin_id char (2)
  Declare @e26_label_cd varchar(10)
  Declare @e26_sales_cd varchar(10)
  Declare @e26_label_name varchar(100)

--  SET ROWCOUNT 10000

  -- 一時テーブル読み込み
  Set @rs = cursor static for
       SELECT
	 e26_edi_id
	,e26_tushin_id
	,case 
	   when e26_tushin_id = 'WU' then e26_label_cd  -- 2009/05/12 ウィズアスの場合はそのままセット
	   else right('__' + e26_label_cd,2) + isnull(e26_sales_cd,'')
	 end
	,e26_sales_cd
	,e26_label_name
            from
              wbe_edibook_dw_mlm
            where
              e26_edi_flag = '0'  -- 未処理
            order by
              e26_edi_file_line_no
             ,e26_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e26_label_cd
	,@e26_sales_cd
	,@e26_label_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	  -- 販売元マスタ更新
      SELECT @rc = 0
	  If Not Exists(select top 1 * from wpt_maker_sales_master
					where msm_sales_cd = @e26_sales_cd ) Begin
	       INSERT INTO wpt_maker_sales_master (
			 msm_sales_cd
			,msm_update_memo
			,msm_sales_name
			) SELECT
			 msm_sales_cd = @e26_sales_cd
			,msm_update_memo = object_name(@@PROCID) + '[mlm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,msm_sales_name = @e26_label_name
           SELECT @rc = @@ERROR
      End Else Begin
	       UPDATE wpt_maker_sales_master SET
			 msm_update_date = getdate()
			,msm_update_memo = object_name(@@PROCID) + '[mlm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,msm_sales_name = @e26_label_name
			  where
			  msm_sales_cd = @e26_sales_cd
           SELECT @rc = @@ERROR
      End

      -- エラーチェック
      If @rc <> 0 Begin 
          -- エラー記録
          SELECT
             @a_edi_error_msg = '販売元マスタ更新エラー'
                 + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MLM
      End

	  -- レーベルマスタ更新
      SELECT @rc = 0
	  If Not Exists(select top 1 * from wpt_maker_label_master
					where mlm_label_cd = @e26_label_cd ) Begin
	       INSERT INTO wpt_maker_label_master (
			 mlm_label_cd
			,mlm_update_memo
			,mlm_sales_cd
			,mlm_label_name
			) SELECT
			 mlm_label_cd = @e26_label_cd
			,mlm_update_memo = object_name(@@PROCID) + '[mlm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,mlm_sales_cd = @e26_sales_cd
			,mlm_label_name = @e26_label_name
           SELECT @rc = @@ERROR
      End Else Begin
	     If Not Exists(select top 1 * from wpt_maker_label_master
					  where mlm_label_cd = @e26_label_cd
						and mlm_sales_cd = @e26_sales_cd ) Begin
			UPDATE wpt_maker_label_master SET
			   mlm_update_date = getdate()
			  ,mlm_update_memo = object_name(@@PROCID) + '[mlm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			  ,mlm_sales_cd = @e26_sales_cd
			  ,mlm_label_name = @e26_label_name
			  where
			  mlm_label_cd = @e26_label_cd
            SELECT @rc = @@ERROR
	     End Else Begin
	         UPDATE wpt_maker_label_master SET
			   mlm_update_date = getdate()
			  ,mlm_update_memo = object_name(@@PROCID) + '[mlm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			  ,mlm_label_name = @e26_label_name
			    where
			    mlm_label_cd = @e26_label_cd
             SELECT @rc = @@ERROR
	     End
	  End

      -- エラーチェック
      If @rc <> 0 Begin 
          -- エラー記録
          SELECT
             @a_edi_error_msg = 'レーベルマスタ更新エラー'
                 + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_MLM
      End

	LOOP_END_MLM:

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_mlm SET
            e26_edi_flag = @a_edi_flag
           ,e26_edi_error_msg = @a_edi_error_msg
           ,e26_edi_update_date = @a_getdate
         where
            e26_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e26_label_cd
	,@e26_sales_cd
	,@e26_label_name
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9052,メーカレーベルデータ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9053,メーカレーベルログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK


DOWN_LABEL_END:


--=================================================
-- 下りジャンル処理
--=================================================
DOWN_GENRE:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9060,ジャンルサーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_glm ('
	+ '	 e27_edi_flag'
	+ '	,e27_edi_timestamp'
	+ '	,e27_edi_id'
	+ '	,e27_edi_create_date'
	+ '	,e27_edi_update_date'
	+ '	,e27_edi_file_line_no'
	+ '	,e27_edi_meisai_no'
	+ '	,e27_edi_error_msg'
	+ '	,e27_server_webpos'
	+ '	,e27_dbname_webpos'
	+ '	,e27_shop_cd_webpos'
	+ '	,e27_shop_name_webpos'
	+ '	,e27_seq_no'
	+ '	,e27_shop_cd_primary'
	+ '	,e27_shop_cd'
	+ '	,e27_tushin_id'
	+ '	,e27_cd_genre_cd'
	+ '	,e27_cd_genre_name'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e27_edi_flag'
	+ '	,M.e27_edi_timestamp'
	+ '	,M.e27_edi_id'
	+ '	,M.e27_edi_create_date'
	+ '	,M.e27_edi_update_date'
	+ '	,M.e27_edi_file_line_no'
	+ '	,M.e27_edi_meisai_no'
	+ '	,M.e27_edi_error_msg'
	+ '	,M.e27_server_webpos'
	+ '	,M.e27_dbname_webpos'
	+ '	,M.e27_shop_cd_webpos'
	+ '	,M.e27_shop_name_webpos'
	+ '	,M.e27_seq_no'
	+ '	,M.e27_shop_cd_primary'
	+ '	,M.e27_shop_cd'
	+ '	,M.e27_tushin_id'
	+ '	,M.e27_cd_genre_cd'
	+ '	,M.e27_cd_genre_name'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_glm as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_glm as C'
	+ '                on M.e27_edi_id = C.e27_edi_id'
	+ '            where'
	+ '              C.e27_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e27_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e27_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e27_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9061,ジャンルデータ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e27_cd_genre_cd varchar(10)
  Declare @e27_cd_genre_name varchar(100)

--  SET ROWCOUNT 10000

  Set @rs = cursor static for
       SELECT
	 e27_edi_id
	,e27_tushin_id
	,e27_cd_genre_cd
	,e27_cd_genre_name
            from
              wbe_edibook_dw_glm
            where
              e27_edi_flag = '0'  -- 未処理
            order by
              e27_edi_file_line_no
             ,e27_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e27_cd_genre_cd
	,@e27_cd_genre_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	  -----------------------------------
      -- 処理実装なし。フラグのみ更新。--
	  -----------------------------------

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_glm SET
            e27_edi_flag = @a_edi_flag
           ,e27_edi_error_msg = @a_edi_error_msg
           ,e27_edi_update_date = @a_getdate
         where
            e27_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e27_cd_genre_cd
	,@e27_cd_genre_name
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9062,ジャンルデータ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9063,ジャンルログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_GENRE_END:


--=================================================
-- 下り品種処理
--=================================================
DOWN_HINSHU:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9070,品種サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_hsm ('
	+ '	 e28_edi_flag'
	+ '	,e28_edi_timestamp'
	+ '	,e28_edi_id'
	+ '	,e28_edi_create_date'
	+ '	,e28_edi_update_date'
	+ '	,e28_edi_file_line_no'
	+ '	,e28_edi_meisai_no'
	+ '	,e28_edi_error_msg'
	+ '	,e28_server_webpos'
	+ '	,e28_dbname_webpos'
	+ '	,e28_shop_cd_webpos'
	+ '	,e28_shop_name_webpos'
	+ '	,e28_seq_no'
	+ '	,e28_shop_cd_primary'
	+ '	,e28_shop_cd'
	+ '	,e28_tushin_id'
	+ '	,e28_cd_hinshu_cd'
	+ '	,e28_cd_hinshu_name'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e28_edi_flag'
	+ '	,M.e28_edi_timestamp'
	+ '	,M.e28_edi_id'
	+ '	,M.e28_edi_create_date'
	+ '	,M.e28_edi_update_date'
	+ '	,M.e28_edi_file_line_no'
	+ '	,M.e28_edi_meisai_no'
	+ '	,M.e28_edi_error_msg'
	+ '	,M.e28_server_webpos'
	+ '	,M.e28_dbname_webpos'
	+ '	,M.e28_shop_cd_webpos'
	+ '	,M.e28_shop_name_webpos'
	+ '	,M.e28_seq_no'
	+ '	,M.e28_shop_cd_primary'
	+ '	,M.e28_shop_cd'
	+ '	,M.e28_tushin_id'
	+ '	,M.e28_cd_hinshu_cd'
	+ '	,M.e28_cd_hinshu_name'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_hsm as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_hsm as C'
	+ '                on M.e28_edi_id = C.e28_edi_id'
	+ '            where'
	+ '              C.e28_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e28_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e28_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e28_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9071,品種データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e28_cd_hinshu_cd varchar(10)
  Declare @e28_cd_hinshu_name varchar(100)

--  SET ROWCOUNT 10000

  Set @rs = cursor static for
       SELECT
	 e28_edi_id
	,e28_tushin_id
	,e28_cd_hinshu_cd
	,e28_cd_hinshu_name
            from
              wbe_edibook_dw_hsm
            where
              e28_edi_flag = '0'  -- 未処理
            order by
              e28_edi_file_line_no
             ,e28_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e28_cd_hinshu_cd
	,@e28_cd_hinshu_name

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	  -----------------------------------
      -- 処理実装なし。フラグのみ更新。--
	  -----------------------------------

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_hsm SET
            e28_edi_flag = @a_edi_flag
           ,e28_edi_error_msg = @a_edi_error_msg
           ,e28_edi_update_date = @a_getdate
         where
            e28_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e28_cd_hinshu_cd
	,@e28_cd_hinshu_name
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9072,品種データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9073,品種ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_HINSHU_END:


--=================================================
-- 下り大分類処理
--=================================================
DOWN_DAIBUNRUI:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9080,大分類サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_dbm ('
	+ '	 e29_edi_flag'
	+ '	,e29_edi_timestamp'
	+ '	,e29_edi_id'
	+ '	,e29_edi_create_date'
	+ '	,e29_edi_update_date'
	+ '	,e29_edi_file_line_no'
	+ '	,e29_edi_meisai_no'
	+ '	,e29_edi_error_msg'
	+ '	,e29_server_webpos'
	+ '	,e29_dbname_webpos'
	+ '	,e29_shop_cd_webpos'
	+ '	,e29_shop_name_webpos'
	+ '	,e29_seq_no'
	+ '	,e29_shop_cd_primary'
	+ '	,e29_shop_cd'
	+ '	,e29_tushin_id'
	+ '	,e29_b_genre_cd'
	+ '	,e29_b_genre_name'
	+ '	,e29_b_genre_ryaku'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e29_edi_flag'
	+ '	,M.e29_edi_timestamp'
	+ '	,M.e29_edi_id'
	+ '	,M.e29_edi_create_date'
	+ '	,M.e29_edi_update_date'
	+ '	,M.e29_edi_file_line_no'
	+ '	,M.e29_edi_meisai_no'
	+ '	,M.e29_edi_error_msg'
	+ '	,M.e29_server_webpos'
	+ '	,M.e29_dbname_webpos'
	+ '	,M.e29_shop_cd_webpos'
	+ '	,M.e29_shop_name_webpos'
	+ '	,M.e29_seq_no'
	+ '	,M.e29_shop_cd_primary'
	+ '	,M.e29_shop_cd'
	+ '	,M.e29_tushin_id'
	+ '	,M.e29_b_genre_cd'
	+ '	,M.e29_b_genre_name'
	+ '	,M.e29_b_genre_ryaku'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_dbm as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_dbm as C'
	+ '                on M.e29_edi_id = C.e29_edi_id'
	+ '            where'
	+ '              C.e29_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e29_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e29_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e29_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9081,大分類データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e29_b_genre_cd varchar(6)
  Declare @e29_b_genre_name varchar(20)
  Declare @e29_b_genre_ryaku varchar(6)

--  SET ROWCOUNT 10000

  Set @rs = cursor static for
       SELECT
	 e29_edi_id
	,e29_tushin_id
	,e29_b_genre_cd
	,e29_b_genre_name
	,e29_b_genre_ryaku
            from
              wbe_edibook_dw_dbm
            where
              e29_edi_flag = '0'  -- 未処理
            order by
              e29_edi_file_line_no
             ,e29_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e29_b_genre_cd
	,@e29_b_genre_name
	,@e29_b_genre_ryaku

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	  -- 大分類マスタ更新
      SELECT @rc = 0
	  If Not Exists(select top 1 * from wpt_goods_class1_master
					where gc1_class1_cd = @e29_b_genre_cd ) Begin
	       INSERT INTO wpt_goods_class1_master (
			 gc1_class1_cd
			,gc1_update_memo
			,gc1_class1_name
			,gc1_class1_ryaku
			) SELECT
			 gc1_class1_cd = @e29_b_genre_cd
			,gc1_update_memo = object_name(@@PROCID) + '[dbm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,gc1_class1_name = @e29_b_genre_name
			,gc1_class1_ryaku = @e29_b_genre_ryaku
           SELECT @rc = @@ERROR
      End Else Begin
	       UPDATE wpt_goods_class1_master SET
			 gc1_update_date = getdate()
			,gc1_update_memo = object_name(@@PROCID) + '[dbm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,gc1_class1_name = @e29_b_genre_name
			,gc1_class1_ryaku = @e29_b_genre_ryaku
			  where
			  gc1_class1_cd = @e29_b_genre_cd
           SELECT @rc = @@ERROR
      End

      -- エラーチェック
      If @rc <> 0 Begin 
          -- エラー記録
          SELECT
             @a_edi_error_msg = '大分類マスタ更新エラー'
                 + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_DBM
      End

	LOOP_END_DBM:

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_dbm SET
            e29_edi_flag = @a_edi_flag
           ,e29_edi_error_msg = @a_edi_error_msg
           ,e29_edi_update_date = @a_getdate
         where
            e29_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e29_b_genre_cd
	,@e29_b_genre_name
	,@e29_b_genre_ryaku
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9082,大分類データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9083,大分類ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_DAIBUNRUI_END:


--=================================================
-- 下り中分類処理
--=================================================
DOWN_CHUBUNRUI:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9090,中分類サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_cbm ('
	+ '	 e30_edi_flag'
	+ '	,e30_edi_timestamp'
	+ '	,e30_edi_id'
	+ '	,e30_edi_create_date'
	+ '	,e30_edi_update_date'
	+ '	,e30_edi_file_line_no'
	+ '	,e30_edi_meisai_no'
	+ '	,e30_edi_error_msg'
	+ '	,e30_server_webpos'
	+ '	,e30_dbname_webpos'
	+ '	,e30_shop_cd_webpos'
	+ '	,e30_shop_name_webpos'
	+ '	,e30_seq_no'
	+ '	,e30_shop_cd_primary'
	+ '	,e30_shop_cd'
	+ '	,e30_tushin_id'
	+ '	,e30_m_genre_cd'
	+ '	,e30_m_genre_name'
	+ '	,e30_m_genre_ryaku'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e30_edi_flag'
	+ '	,M.e30_edi_timestamp'
	+ '	,M.e30_edi_id'
	+ '	,M.e30_edi_create_date'
	+ '	,M.e30_edi_update_date'
	+ '	,M.e30_edi_file_line_no'
	+ '	,M.e30_edi_meisai_no'
	+ '	,M.e30_edi_error_msg'
	+ '	,M.e30_server_webpos'
	+ '	,M.e30_dbname_webpos'
	+ '	,M.e30_shop_cd_webpos'
	+ '	,M.e30_shop_name_webpos'
	+ '	,M.e30_seq_no'
	+ '	,M.e30_shop_cd_primary'
	+ '	,M.e30_shop_cd'
	+ '	,M.e30_tushin_id'
	+ '	,M.e30_m_genre_cd'
	+ '	,M.e30_m_genre_name'
	+ '	,M.e30_m_genre_ryaku'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_cbm as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_cbm as C'
	+ '                on M.e30_edi_id = C.e30_edi_id'
	+ '            where'
	+ '              C.e30_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e30_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e30_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e30_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9091,中分類データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e30_m_genre_cd varchar(6)
  Declare @e30_m_genre_name varchar(20)
  Declare @e30_m_genre_ryaku varchar(6)

--  SET ROWCOUNT 10000

  Set @rs = cursor static for
       SELECT
	 e30_edi_id
	,e30_tushin_id
	,e30_m_genre_cd
	,e30_m_genre_name
	,e30_m_genre_ryaku
            from
              wbe_edibook_dw_cbm
            where
              e30_edi_flag = '0'  -- 未処理
            order by
              e30_edi_file_line_no
             ,e30_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e30_m_genre_cd
	,@e30_m_genre_name
	,@e30_m_genre_ryaku

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	  -- 中分類マスタ更新
      SELECT @rc = 0
	  If Not Exists(select top 1 * from wpt_goods_class2_master
					where gc2_class2_cd = @e30_m_genre_cd ) Begin
	       INSERT INTO wpt_goods_class2_master (
			 gc2_class2_cd
			,gc2_update_memo
			,gc2_class2_name
			,gc2_class2_ryaku
			) SELECT
			 gc2_class2_cd = @e30_m_genre_cd
			,gc2_update_memo = object_name(@@PROCID) + '[cbm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,gc2_class2_name = @e30_m_genre_name
			,gc2_class2_ryaku = @e30_m_genre_ryaku
           SELECT @rc = @@ERROR
      End Else Begin
	       UPDATE wpt_goods_class2_master SET
			 gc2_update_date = getdate()
			,gc2_update_memo = object_name(@@PROCID) + '[cbm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,gc2_class2_name = @e30_m_genre_name
			,gc2_class2_ryaku = @e30_m_genre_ryaku
			  where
			  gc2_class2_cd = @e30_m_genre_cd
           SELECT @rc = @@ERROR
      End

      -- エラーチェック
      If @rc <> 0 Begin 
          -- エラー記録
          SELECT
             @a_edi_error_msg = '中分類マスタ更新エラー'
                 + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_CBM
      End

	LOOP_END_CBM:

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_cbm SET
            e30_edi_flag = @a_edi_flag
           ,e30_edi_error_msg = @a_edi_error_msg
           ,e30_edi_update_date = @a_getdate
         where
            e30_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e30_m_genre_cd
	,@e30_m_genre_name
	,@e30_m_genre_ryaku
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9092,中分類データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9093,中分類ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_CHUBUNRUI_END:


--=================================================
-- 下り小分類処理
--=================================================
DOWN_SHOBUNRUI:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9100,小分類サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_sbm ('
	+ '	 e31_edi_flag'
	+ '	,e31_edi_timestamp'
	+ '	,e31_edi_id'
	+ '	,e31_edi_create_date'
	+ '	,e31_edi_update_date'
	+ '	,e31_edi_file_line_no'
	+ '	,e31_edi_meisai_no'
	+ '	,e31_edi_error_msg'
	+ '	,e31_server_webpos'
	+ '	,e31_dbname_webpos'
	+ '	,e31_shop_cd_webpos'
	+ '	,e31_shop_name_webpos'
	+ '	,e31_seq_no'
	+ '	,e31_shop_cd_primary'
	+ '	,e31_shop_cd'
	+ '	,e31_tushin_id'
	+ '	,e31_s_genre_cd'
	+ '	,e31_s_genre_name'
	+ '	,e31_s_genre_ryaku'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e31_edi_flag'
	+ '	,M.e31_edi_timestamp'
	+ '	,M.e31_edi_id'
	+ '	,M.e31_edi_create_date'
	+ '	,M.e31_edi_update_date'
	+ '	,M.e31_edi_file_line_no'
	+ '	,M.e31_edi_meisai_no'
	+ '	,M.e31_edi_error_msg'
	+ '	,M.e31_server_webpos'
	+ '	,M.e31_dbname_webpos'
	+ '	,M.e31_shop_cd_webpos'
	+ '	,M.e31_shop_name_webpos'
	+ '	,M.e31_seq_no'
	+ '	,M.e31_shop_cd_primary'
	+ '	,M.e31_shop_cd'
	+ '	,M.e31_tushin_id'
	+ '	,M.e31_s_genre_cd'
	+ '	,M.e31_s_genre_name'
	+ '	,M.e31_s_genre_ryaku'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_sbm as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_sbm as C'
	+ '                on M.e31_edi_id = C.e31_edi_id'
	+ '            where'
	+ '              C.e31_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e31_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e31_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e31_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9101,小分類データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e31_s_genre_cd varchar(6)
  Declare @e31_s_genre_name varchar(20)
  Declare @e31_s_genre_ryaku varchar(6)

--  SET ROWCOUNT 10000

  Set @rs = cursor static for
       SELECT
	 e31_edi_id
	,e31_tushin_id
	,e31_s_genre_cd
	,e31_s_genre_name
	,e31_s_genre_ryaku
            from
              wbe_edibook_dw_sbm
            where
              e31_edi_flag = '0'  -- 未処理
            order by
              e31_edi_file_line_no
             ,e31_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e31_s_genre_cd
	,@e31_s_genre_name
	,@e31_s_genre_ryaku

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

      -- 初期値セット
      SELECT
        @a_edi_error_msg = null         -- エラーメッセージクリア
       ,@a_edi_flag = '1'                    -- EDIフラグ実行済み

	  -- 小分類マスタ更新
      SELECT @rc = 0
	  If Not Exists(select top 1 * from wpt_goods_class3_master
					where gc3_class3_cd = @e31_s_genre_cd ) Begin
	       INSERT INTO wpt_goods_class3_master (
			 gc3_class3_cd
			,gc3_update_memo
			,gc3_class3_name
			,gc3_class3_ryaku
			) SELECT
			 gc3_class3_cd = @e31_s_genre_cd
			,gc3_update_memo = object_name(@@PROCID) + '[sbm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,gc3_class3_name = @e31_s_genre_name
			,gc3_class3_ryaku = @e31_s_genre_ryaku
           SELECT @rc = @@ERROR
      End Else Begin
	       UPDATE wpt_goods_class3_master SET
			 gc3_update_date = getdate()
			,gc3_update_memo = object_name(@@PROCID) + '[sbm]' + '[' + isnull(@a_tushin_id,'') +  ']'
			,gc3_class3_name = @e31_s_genre_name
			,gc3_class3_ryaku = @e31_s_genre_ryaku
			  where
			  gc3_class3_cd = @e31_s_genre_cd
           SELECT @rc = @@ERROR
      End

      -- エラーチェック
      If @rc <> 0 Begin 
          -- エラー記録
          SELECT
             @a_edi_error_msg = '小分類マスタ更新エラー'
                 + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
            ,@a_edi_flag = '2'  -- 警告
          -- ループ終了まで飛ばす
          GOTO LOOP_END_SBM
      End

	LOOP_END_SBM:

      -- 処理結果記録
      Set @a_getdate = getdate()
      UPDATE wbe_edibook_dw_sbm SET
            e31_edi_flag = @a_edi_flag
           ,e31_edi_error_msg = @a_edi_error_msg
           ,e31_edi_update_date = @a_getdate
         where
            e31_edi_id = @a_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tushin_id

      -- 次へ
      fetch next from @rs into
	 @a_edi_id
	,@a_tushin_id
	,@e31_s_genre_cd
	,@e31_s_genre_name
	,@e31_s_genre_ryaku
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9102,小分類データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9103,小分類ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_SHOBUNRUI_END:


--=================================================
-- 下り価格変更処理
--=================================================
--  価格変更処理は一度にヘッダ(32D)、明細(33D)の両方を処理する。
-- 
DOWN_KAKAKUHENKOU:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  -- ヘッダと明細の両方を処理
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = '32D' -- ヘッダ
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9110,価格変更ヘッダサーバ情報セット不正'
    GOTO SP_ERR
  End
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = '33D' -- 明細
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9120,価格変更明細サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  -- ヘッダ
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_khh ('
	+ '	 e32_edi_flag'
	+ '	,e32_edi_timestamp'
	+ '	,e32_edi_id'
	+ '	,e32_edi_create_date'
	+ '	,e32_edi_update_date'
	+ '	,e32_edi_file_line_no'
	+ '	,e32_edi_meisai_no'
	+ '	,e32_edi_error_msg'
	+ '	,e32_server_webpos'
	+ '	,e32_dbname_webpos'
	+ '	,e32_shop_cd_webpos'
	+ '	,e32_shop_name_webpos'
	+ '	,e32_seq_no'
	+ '	,e32_shop_cd_primary'
	+ '	,e32_shop_cd'
	+ '	,e32_tushin_id'
	+ '	,e32_kakaku_data_kubun'
	+ '	,e32_kakaku_code'
	+ '	,e32_kakaku_name'
	+ '	,e32_kakaku_change_date'
	+ '	,e32_b_genre'
	+ '	,e32_m_genre'
	+ '	,e32_kakaku_comment'
	+ '	)'
	+ '	SELECT'
	+ '	 M.e32_edi_flag'
	+ '	,M.e32_edi_timestamp'
	+ '	,M.e32_edi_id'
	+ '	,M.e32_edi_create_date'
	+ '	,M.e32_edi_update_date'
	+ '	,M.e32_edi_file_line_no'
	+ '	,M.e32_edi_meisai_no'
	+ '	,M.e32_edi_error_msg'
	+ '	,M.e32_server_webpos'
	+ '	,M.e32_dbname_webpos'
	+ '	,M.e32_shop_cd_webpos'
	+ '	,M.e32_shop_name_webpos'
	+ '	,M.e32_seq_no'
	+ '	,M.e32_shop_cd_primary'
	+ '	,M.e32_shop_cd'
	+ '	,M.e32_tushin_id'
	+ '	,M.e32_kakaku_data_kubun'
	+ '	,M.e32_kakaku_code'
	+ '	,M.e32_kakaku_name'
	+ '	,M.e32_kakaku_change_date'
	+ '	,M.e32_b_genre'
	+ '	,M.e32_m_genre'
	+ '	,M.e32_kakaku_comment'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_khh as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_khh as C'
	+ '                on M.e32_edi_id = C.e32_edi_id'
	+ '            where'
	+ '              C.e32_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e32_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e32_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e32_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9111,価格変更ヘッダデータ取得エラー'
    GOTO SP_ERR
  End
  --
  -- 明細
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_khd ('
	+ '	 e33_edi_flag'
	+ '	,e33_edi_timestamp'
	+ '	,e33_edi_id'
	+ '	,e33_edi_create_date'
	+ '	,e33_edi_update_date'
	+ '	,e33_edi_file_line_no'
	+ '	,e33_edi_meisai_no'
	+ '	,e33_edi_error_msg'
	+ '	,e33_server_webpos'
	+ '	,e33_dbname_webpos'
	+ '	,e33_shop_cd_webpos'
	+ '	,e33_shop_name_webpos'
	+ '	,e33_seq_no'
	+ '	,e33_shop_cd_primary'
	+ '	,e33_shop_cd'
	+ '	,e33_tushin_id'
	+ '	,e33_kakaku_data_kubun'
	+ '	,e33_kakaku_code'
	+ '	,e33_goods_code_kubun'
	+ '	,e33_goods_code'
	+ '	,e33_kakaku_rank_code'
	+ '	,e33_hanbai_price'
	+ '	,e33_kaitori_price'
	+ '	,e33_shiire_price'
	+ '	,e33_kakaku_touroku_date'
	+ '	)'
	+ '	SELECT'
	+ '	 M.e33_edi_flag'
	+ '	,M.e33_edi_timestamp'
	+ '	,M.e33_edi_id'
	+ '	,M.e33_edi_create_date'
	+ '	,M.e33_edi_update_date'
	+ '	,M.e33_edi_file_line_no'
	+ '	,M.e33_edi_meisai_no'
	+ '	,M.e33_edi_error_msg'
	+ '	,M.e33_server_webpos'
	+ '	,M.e33_dbname_webpos'
	+ '	,M.e33_shop_cd_webpos'
	+ '	,M.e33_shop_name_webpos'
	+ '	,M.e33_seq_no'
	+ '	,M.e33_shop_cd_primary'
	+ '	,M.e33_shop_cd'
	+ '	,M.e33_tushin_id'
	+ '	,M.e33_kakaku_data_kubun'
	+ '	,M.e33_kakaku_code'
	+ '	,M.e33_goods_code_kubun'
	+ '	,M.e33_goods_code'
	+ '	,M.e33_kakaku_rank_code'
	+ '	,M.e33_hanbai_price'
	+ '	,M.e33_kaitori_price'
	+ '	,M.e33_shiire_price'
	+ '	,M.e33_kakaku_touroku_date'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_khd as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_khd as C'
	+ '                on M.e33_edi_id = C.e33_edi_id'
	+ '            where'
	+ '              C.e33_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e33_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e33_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e33_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9121,価格変更明細データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- エラー用一時テーブル作成
  ------------------------------
  -- あれば削除
  If OBJECT_ID(N'tempdb..#TempErrKakakuHenkou', N'U') IS NOT NULL 
    DROP TABLE #TempErrKakakuHenkou
  --
  CREATE TABLE #TempErrKakakuHenkou(
      t_err_edi_id  bigint        -- 価格変更明細のID
  )
  ------------------------------
  -- マージ用一時テーブル作成
  ------------------------------
  -- あれば削除
  If OBJECT_ID(N'tempdb..#TempKakakuHenkou', N'U') IS NOT NULL 
    DROP TABLE #TempKakakuHenkou
  --
  CREATE TABLE #TempKakakuHenkou(
      t_exec_flag               char(1)       -- 処理フラグ
    , t_err_msg                 varchar(200)  -- エラーフラグ
    , t_tushin_id               char(2)       -- 取次先コード
    , t_khh_edi_id              bigint        -- ヘッダ 中間ID
    , t_khh_shop_cd             int           -- ヘッダ 店舗コード
    , t_khh_kakaku_data_kubun   char(1)       -- ヘッダ 価格変更データ区分
    , t_khh_kakaku_code         int           -- ヘッダ 価格変更コード
    , t_khh_kakaku_name         varchar(40)   -- ヘッダ 価格変更名称
    , t_khh_kakaku_change_date  datetime      -- ヘッダ 価格変更予定日
    , t_khh_kakaku_comment      varchar(200)  -- ヘッダ 価格変更コメント
    , t_khd_edi_id              bigint        -- 明細 中間ID
    , t_khd_shop_cd             int           -- 明細 店舗コード
    , t_khd_kakaku_data_kubun   char(1)       -- 明細 価格変更データ区分
    , t_khd_kakaku_code         int           -- 明細 価格変更コード
    , t_khd_goods_code_kubun    char(1)       -- 明細 商品コード区分
    , t_khd_goods_code          int           -- 明細 商品コード(ハウスコード)
    , t_khd_goods_id            int           -- 明細 内部商品ID
    , t_khd_kakaku_rank_code    char(1)       -- 明細 価格管理ランクコード(1:New, 2:Used)
    , t_khd_hanbai_price        money         -- 明細 販売単価(税抜)
    , t_khd_kaitori_price       money         -- 明細 買取単価(税込)
    , t_khd_shiire_price        money         -- 明細 仕入単価(税抜(？)) ※今のところ、こない
    , t_khd_kakaku_touroku_date datetime      -- 明細 価格登録日付
  )
  --
  -- 一時テーブルに明細データを投入
  INSERT INTO #TempKakakuHenkou(
        t_exec_flag
      , t_tushin_id
      , t_khd_edi_id
      , t_khd_shop_cd
      , t_khd_kakaku_data_kubun
      , t_khd_kakaku_code
      , t_khd_goods_code_kubun
      , t_khd_goods_code
      , t_khd_goods_id
      , t_khd_kakaku_rank_code
      , t_khd_hanbai_price
      , t_khd_kaitori_price
      , t_khd_shiire_price
      , t_khd_kakaku_touroku_date
  )SELECT
        '0'
      , e33_tushin_id
      , e33_edi_id
      , e33_shop_cd_webpos
      , e33_kakaku_data_kubun
      , e33_kakaku_code
      , e33_goods_code_kubun
      , e33_goods_code
      , gds_goods_id
      , e33_kakaku_rank_code
      , e33_hanbai_price
      , e33_kaitori_price
      , e33_shiire_price
      , e33_kakaku_touroku_date
  FROM wbe_edibook_dw_khd
  LEFT OUTER JOIN wpt_goods_master
  ON e33_goods_code=gds_koyu_goods_cd
  WHERE e33_edi_flag = '0'
  --
  -- 一時テーブルにヘッダデータを投入
  UPDATE #TempKakakuHenkou
  SET
      t_khh_edi_id = khh.e32_edi_id
    , t_khh_shop_cd = khh.e32_shop_cd_webpos
    , t_khh_kakaku_data_kubun = khh.e32_kakaku_data_kubun
    , t_khh_kakaku_code = khh.e32_kakaku_code
    , t_khh_kakaku_name = khh.e32_kakaku_name
    , t_khh_kakaku_change_date = khh.e32_kakaku_change_date
    , t_khh_kakaku_comment = khh.e32_kakaku_comment
  FROM wbe_edibook_dw_khh AS khh
  JOIN #TempKakakuHenkou AS Tmp
  ON khh.e32_shop_cd_webpos=Tmp.t_khd_shop_cd
    AND khh.e32_kakaku_data_kubun=Tmp.t_khd_kakaku_data_kubun
    AND khh.e32_kakaku_code=Tmp.t_khd_kakaku_code
    AND khh.e32_tushin_id=Tmp.t_tushin_id
  WHERE khh.e32_edi_flag = '0'
  --
  -- エラーチェック
  -- (1)ヘッダがないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '価格変更ヘッダ情報がありません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khh_edi_id IS NULL
  --
  -- (2)変更予定日がないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '価格変更実施予定日が指定されていません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khh_kakaku_change_date IS NULL
  --
  -- (3)価格表コードがないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '価格表コードが指定されていません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khd_kakaku_code IS NULL
  --
  -- (4)商品マスタにないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '商品が存在しません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khd_goods_id IS NULL
  --
  -- (5)新品で販売価格がないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '販売価格(新品)が指定されていません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khd_kakaku_rank_code = '1' -- 新品
        AND t_khd_hanbai_price IS NULL
  --
  -- (6)中古で販売価格、買取価格がないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '販売・買取価格(中古)が指定されていません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khd_kakaku_rank_code = '2' -- 中古
        AND t_khd_hanbai_price IS NULL
        AND t_khd_kaitori_price IS NULL
  --
  -- (7)中古で販売価格がないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '販売価格(中古)が指定されていません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khd_kakaku_rank_code = '2' -- 中古
        AND t_khd_hanbai_price IS NULL
  --
  -- (8)中古で買取価格がないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '買取価格(中古)が指定されていません。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khd_kakaku_rank_code = '2' -- 中古
        AND t_khd_kaitori_price IS NULL
  --
  -- (9)区分は新品でも中古でもないものはエラー
  UPDATE #TempKakakuHenkou
  SET
      t_exec_flag = '2'
    , t_err_msg = '新中区分[' + t_khd_kakaku_rank_code + ']が不正です。'
  FROM #TempKakakuHenkou
  WHERE t_exec_flag = '0'
        AND t_khd_kakaku_rank_code <> '1' -- 新品
        AND t_khd_kakaku_rank_code <> '2' -- 中古
  
  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @a_tmp_exec_flag       char(1)
  Declare @a_tmp_err_msg         varchar(200)
  Declare @a_tmp_tushin_id       char(2)
  Declare @a_meisai_edi_id       bigint
  Declare @a_kakaku_data_kubun   char(1)
  Declare @a_kakaku_code         int
  Declare @a_kakaku_name         varchar(40)
  Declare @a_kakaku_change_date  datetime
  Declare @a_kakaku_comment      varchar(200)
  Declare @a_kakaku_shop_cd      int
  Declare @a_kakaku_goods_cd     varchar(20)
  Declare @a_kakaku_goods_id     int
  Declare @a_kakaku_rank_code    char(1)
  Declare @a_hanbai_price        money
  Declare @a_kaitori_price       money
  Declare @a_shiire_price        money  -- 未使用
  
  Declare @a_kakaku_shop_cd_goods        int  -- 商品マスタ価格更新用
  
  --
  -- 商品マスタ価格更新用店舗コードを取得
  --
  SELECT TOP 1
    @a_kakaku_shop_cd_goods = t_khh_shop_cd
  FROM #TempKakakuHenkou
  ORDER BY t_khh_shop_cd

  --
  -- 価格更新テーブルにデータ投入
  --
  --   新品の場合は販売価格をセット
  --   中古の場合は販売価格と買取価格をセット
  --   ※仕入価格は項目にあるが、データが来ないのでセットしない。
  --
  -- 一時テーブル読み込み
  Set @rs = cursor static for
      SELECT
          t_exec_flag
        , t_err_msg
        , t_tushin_id
        , t_khd_edi_id
        , t_khh_kakaku_data_kubun
        , t_khh_kakaku_code
        , t_khh_kakaku_name
        , t_khh_kakaku_change_date
        , t_khh_kakaku_comment
        , t_khd_shop_cd
        , t_khd_goods_code
        , t_khd_goods_id
        , t_khd_kakaku_rank_code
        , t_khd_hanbai_price
        , t_khd_kaitori_price
        , t_khd_shiire_price
      FROM #TempKakakuHenkou
      ORDER BY 
        t_khd_shop_cd ASC, t_khh_edi_id ASC, t_khd_edi_id ASC

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
        @a_tmp_exec_flag
      , @a_tmp_err_msg
      , @a_tmp_tushin_id 
      , @a_meisai_edi_id
      , @a_kakaku_data_kubun
      , @a_kakaku_code
      , @a_kakaku_name
      , @a_kakaku_change_date
      , @a_kakaku_comment
      , @a_kakaku_shop_cd
      , @a_kakaku_goods_cd
      , @a_kakaku_goods_id
      , @a_kakaku_rank_code
      , @a_hanbai_price
      , @a_kaitori_price
      , @a_shiire_price

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
      -- 初期値セット
      Set @a_edi_flag = '1'
      
      --
      -- 1)在庫更新用
      --
      If @a_kakaku_rank_code = '1' Begin
        -- 新品
        INSERT INTO wpt_stock_price_update_master(
            spu_update_memo
          , spu_shop_cd
          , spu_goods_id
          , spu_koyu_goods_cd
          , spu_condition_type
          , spu_price_type
          , spu_price
          , spu_change_yotei_date
          , spu_price_list_cd
          , spu_price_list_name
          , spu_status_type
          , spu_status_memo
        )VALUES(
            object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
          , @a_kakaku_shop_cd
          , @a_kakaku_goods_id
          , @a_kakaku_goods_cd
          , '0' -- 新品
          , '0' -- 販売価格
          , @a_hanbai_price
          , @a_kakaku_change_date
          , @a_kakaku_code
          , @a_kakaku_name
          , @a_tmp_exec_flag
          , @a_tmp_err_msg
        )
      End
      Else Begin
        If @a_kakaku_rank_code = '2' Begin
          -- 中古(販売価格)
          INSERT INTO wpt_stock_price_update_master(
              spu_update_memo
            , spu_shop_cd
            , spu_goods_id
            , spu_koyu_goods_cd
            , spu_condition_type
            , spu_price_type
            , spu_price
            , spu_change_yotei_date
            , spu_price_list_cd
            , spu_price_list_name
            , spu_status_type
            , spu_status_memo
          )VALUES(
              object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
            , @a_kakaku_shop_cd
            , @a_kakaku_goods_id
            , @a_kakaku_goods_cd
            , '1' -- 中古
            , '0' -- 販売価格
            , @a_hanbai_price
            , @a_kakaku_change_date
            , @a_kakaku_code
            , @a_kakaku_name
            , @a_tmp_exec_flag
            , @a_tmp_err_msg
          )
          -- 中古(買取価格)
          INSERT INTO wpt_stock_price_update_master(
              spu_update_memo
            , spu_shop_cd
            , spu_goods_id
            , spu_koyu_goods_cd
            , spu_condition_type
            , spu_price_type
            , spu_price
            , spu_change_yotei_date
            , spu_price_list_cd
            , spu_price_list_name
            , spu_status_type
            , spu_status_memo
          )VALUES(
              object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
            , @a_kakaku_shop_cd
            , @a_kakaku_goods_id
            , @a_kakaku_goods_cd
            , '1' -- 中古
            , '1' -- 買取価格
            , @a_kaitori_price
            , @a_kakaku_change_date
            , @a_kakaku_code
            , @a_kakaku_name
            , @a_tmp_exec_flag
            , @a_tmp_err_msg
          )
        End
        Else Begin
          -- 新中区分不正
          INSERT INTO wpt_stock_price_update_master(
              spu_update_memo
            , spu_shop_cd
            , spu_goods_id
            , spu_koyu_goods_cd
            , spu_condition_type
            , spu_price_type
            , spu_price
            , spu_change_yotei_date
            , spu_price_list_cd
            , spu_price_list_name
            , spu_status_type
            , spu_status_memo
          )VALUES(
              object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
            , @a_kakaku_shop_cd
            , @a_kakaku_goods_id
            , @a_kakaku_goods_cd
            , '9' -- 不正
            , '0' -- 販売価格
            , @a_hanbai_price
            , @a_kakaku_change_date
            , @a_kakaku_code
            , @a_kakaku_name
            , @a_tmp_exec_flag
            , @a_tmp_err_msg
          )
        End
      End
      -- エラーチェック
      Set @rc = @@ERROR
      If @rc <> 0 Begin
        -- エラー用テーブルに明細IDをセット
        INSERT INTO #TempErrKakakuHenkou VALUES(@a_meisai_edi_id)
        -- 処理件数用変数にエラーをセット
        Set @a_edi_flag = '3'
        -- 価格変更データ投入終了
        GOTO LOOP_END_KAKAKU_HENKO
      End

      --
      -- 2)商品マスタ更新用
      --
      -- 商品マスタ価格変更用店舗コードだったら、商品マスタ価格更新用にデータ投入
      If @a_kakaku_shop_cd = @a_kakaku_shop_cd_goods Begin
        If @a_kakaku_rank_code = '1' Begin
          -- 新品
          INSERT INTO wpt_goods_price_update_master(
              gpu_update_memo
            , gpu_goods_id
            , gpu_koyu_goods_cd
            , gpu_condition_type
            , gpu_price_type
            , gpu_price
            , gpu_change_yotei_date
            , gpu_price_list_cd
            , gpu_price_list_name
            , gpu_status_type
            , gpu_status_memo
          )VALUES(
              object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
            , @a_kakaku_goods_id
            , @a_kakaku_goods_cd
            , '0' -- 新品
            , '0' -- 販売価格
            , @a_hanbai_price
            , @a_kakaku_change_date
            , @a_kakaku_code
            , @a_kakaku_name
            , @a_tmp_exec_flag
            , @a_tmp_err_msg
          )
        End
        Else Begin
          If @a_kakaku_rank_code = '2' Begin
            -- 中古(販売価格)
            INSERT INTO wpt_goods_price_update_master(
                gpu_update_memo
              , gpu_goods_id
              , gpu_koyu_goods_cd
              , gpu_condition_type
              , gpu_price_type
              , gpu_price
              , gpu_change_yotei_date
              , gpu_price_list_cd
              , gpu_price_list_name
              , gpu_status_type
              , gpu_status_memo
            )VALUES(
                object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
              , @a_kakaku_goods_id
              , @a_kakaku_goods_cd
              , '1' -- 中古
              , '0' -- 販売価格
              , @a_hanbai_price
              , @a_kakaku_change_date
              , @a_kakaku_code
              , @a_kakaku_name
              , @a_tmp_exec_flag
              , @a_tmp_err_msg
            )
            -- 中古(買取価格)
            INSERT INTO wpt_goods_price_update_master(
                gpu_update_memo
              , gpu_goods_id
              , gpu_koyu_goods_cd
              , gpu_condition_type
              , gpu_price_type
              , gpu_price
              , gpu_change_yotei_date
              , gpu_price_list_cd
              , gpu_price_list_name
              , gpu_status_type
              , gpu_status_memo
            )VALUES(
                object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
              , @a_kakaku_goods_id
              , @a_kakaku_goods_cd
              , '1' -- 中古
              , '1' -- 買取価格
              , @a_kaitori_price
              , @a_kakaku_change_date
              , @a_kakaku_code
              , @a_kakaku_name
              , @a_tmp_exec_flag
              , @a_tmp_err_msg
            )
          End
          Else Begin
            -- 新中区分不正
            INSERT INTO wpt_goods_price_update_master(
                gpu_update_memo
              , gpu_goods_id
              , gpu_koyu_goods_cd
              , gpu_condition_type
              , gpu_price_type
              , gpu_price
              , gpu_change_yotei_date
              , gpu_price_list_cd
              , gpu_price_list_name
              , gpu_status_type
              , gpu_status_memo
            )VALUES(
                object_name(@@PROCID) + '[khh][' + @a_tmp_tushin_id + ']'
              , @a_kakaku_goods_id
              , @a_kakaku_goods_cd
              , '9' -- 不正
              , '0' -- 販売価格
              , @a_hanbai_price
              , @a_kakaku_change_date
              , @a_kakaku_code
              , @a_kakaku_name
              , @a_tmp_exec_flag
              , @a_tmp_err_msg
            )
          End
        End

        -- エラーチェック
        Set @rc = @@ERROR
        If @rc <> 0 Begin
          -- エラー用テーブルに明細IDをセット
          INSERT INTO #TempErrKakakuHenkou VALUES(@a_meisai_edi_id)
          -- 処理件数用変数にエラーをセット
          Set @a_edi_flag = '3'
          -- 価格変更データ投入終了
          GOTO LOOP_END_KAKAKU_HENKO
        End
      End

      LOOP_END_KAKAKU_HENKO:
      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @a_tmp_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @a_tmp_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @a_tmp_tushin_id

      -- 次へ
      fetch next from @rs into
          @a_tmp_exec_flag
        , @a_tmp_err_msg
        , @a_tmp_tushin_id 
        , @a_meisai_edi_id
        , @a_kakaku_data_kubun
        , @a_kakaku_code
        , @a_kakaku_name
        , @a_kakaku_change_date
        , @a_kakaku_comment
        , @a_kakaku_shop_cd
        , @a_kakaku_goods_cd
        , @a_kakaku_goods_id
        , @a_kakaku_rank_code
        , @a_hanbai_price
        , @a_kaitori_price
        , @a_shiire_price
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  -- 処理結果記録
  Set @a_getdate = getdate()
  --
  -- ※価格変更ヘッダは全て正常終了扱いとする。
  UPDATE wbe_edibook_dw_khh SET
             e32_edi_flag = '1'  -- 正常終了
           , e32_edi_update_date = @a_getdate
  --
  -- ※価格変更明細
  UPDATE wbe_edibook_dw_khd SET
             e33_edi_flag = 
               case 
                 when t_err_edi_id is null then '1'  -- 正常終了
                 else '3' -- 異常終了
               end
           , e33_edi_error_msg = 
               case 
                 when t_err_edi_id is null then null  -- 正常終了
                 else '価格更新マスタを生成できませんでした。' -- 異常終了
               end
           , e33_edi_update_date = @a_getdate
  FROM wbe_edibook_dw_khd
  LEFT OUTER JOIN #TempErrKakakuHenkou
  ON e33_edi_id=t_err_edi_id

  ------------------------------
  -- 一時テーブル削除
  ------------------------------
  -- エラー用
  If OBJECT_ID(N'tempdb..#TempErrKakakuHenkou', N'U') IS NOT NULL 
    DROP TABLE #TempErrKakakuHenkou
  -- マージ用
  If OBJECT_ID(N'tempdb..#TempKakakuHenkou', N'U') IS NOT NULL 
    DROP TABLE #TempKakakuHenkou

  ------------------------------
  -- データ同期
  ------------------------------
  -- ヘッダと明細の両方を処理
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = '32D' -- ヘッダ
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9112,価格変更ヘッダデータ同期エラー'
    GOTO SP_ERR
  End
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = '33D' -- 明細
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9122,価格変更明細データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  -- ヘッダと明細の両方を処理
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = '32D' -- ヘッダ
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9113,価格変更ヘッダログ出力エラー'
    GOTO SP_ERR
  End
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = '33D' -- 明細
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9123,価格変更明細ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_KAKAKUHENKOU_END:


--=================================================
-- 下り注文書
--=================================================
--  注文書処理は一度にヘッダ(34D)、明細(35D)の両方を処理する。
-- 
DOWN_CHUMON:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = '34D' -- ヘッダ
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9130,注文書ヘッダサーバ情報セット不正'
    GOTO SP_ERR
  End
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = '35D' -- 明細
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9140,注文書明細サーバ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  -- ヘッダ
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_cmh ('
	+ '	 e34_edi_flag'
	+ '	,e34_edi_timestamp'
	+ '	,e34_edi_id'
	+ '	,e34_edi_create_date'
	+ '	,e34_edi_update_date'
	+ '	,e34_edi_file_line_no'
	+ '	,e34_edi_meisai_no'
	+ '	,e34_edi_error_msg'
	+ '	,e34_server_webpos'
	+ '	,e34_dbname_webpos'
	+ '	,e34_shop_cd_webpos'
	+ '	,e34_shop_name_webpos'
	+ '	,e34_seq_no'
	+ '	,e34_shop_cd_primary'
	+ '	,e34_shop_cd'
	+ '	,e34_tushin_id'
	+ '	,e34_annai_kubun'
	+ '	,e34_chumon_denpyo_no'
	+ '	,e34_chumon_title'
	+ '	,e34_chumon_comment'
	+ '	,e34_chumon_shimekiri_date'
	+ '	)'
	+ '	SELECT'
	+ '	 M.e34_edi_flag'
	+ '	,M.e34_edi_timestamp'
	+ '	,M.e34_edi_id'
	+ '	,M.e34_edi_create_date'
	+ '	,M.e34_edi_update_date'
	+ '	,M.e34_edi_file_line_no'
	+ '	,M.e34_edi_meisai_no'
	+ '	,M.e34_edi_error_msg'
	+ '	,M.e34_server_webpos'
	+ '	,M.e34_dbname_webpos'
	+ '	,M.e34_shop_cd_webpos'
	+ '	,M.e34_shop_name_webpos'
	+ '	,M.e34_seq_no'
	+ '	,M.e34_shop_cd_primary'
	+ '	,M.e34_shop_cd'
	+ '	,M.e34_tushin_id'
	+ '	,M.e34_annai_kubun'
	+ '	,M.e34_chumon_denpyo_no'
	+ '	,M.e34_chumon_title'
	+ '	,M.e34_chumon_comment'
	+ '	,M.e34_chumon_shimekiri_date'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_cmh as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_cmh as C'
	+ '                on M.e34_edi_id = C.e34_edi_id'
	+ '            where'
	+ '              C.e34_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e34_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e34_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e34_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9131,注文書ヘッダデータ取得エラー'
    GOTO SP_ERR
  End
  --
  -- 明細
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_cmd ('
	+ '	 e35_edi_flag'
	+ '	,e35_edi_timestamp'
	+ '	,e35_edi_id'
	+ '	,e35_edi_create_date'
	+ '	,e35_edi_update_date'
	+ '	,e35_edi_file_line_no'
	+ '	,e35_edi_meisai_no'
	+ '	,e35_edi_error_msg'
	+ '	,e35_server_webpos'
	+ '	,e35_dbname_webpos'
	+ '	,e35_shop_cd_webpos'
	+ '	,e35_shop_name_webpos'
	+ '	,e35_seq_no'
	+ '	,e35_shop_cd_primary'
	+ '	,e35_shop_cd'
	+ '	,e35_tushin_id'
	+ '	,e35_annai_kubun'
	+ '	,e35_chumon_denpyo_no'
	+ '	,e35_chumon_line_no'
	+ '	,e35_goods_code_kubun'
	+ '	,e35_goods_code'
	+ '	,e35_kakaku_rank_code'
	+ '	,e35_price'
	+ '	,e35_goods_count'
	+ '	,e35_hachu_unit'
	+ '	,e35_hachu_limit'
	+ '	)'
	+ '	SELECT'
	+ '	 M.e35_edi_flag'
	+ '	,M.e35_edi_timestamp'
	+ '	,M.e35_edi_id'
	+ '	,M.e35_edi_create_date'
	+ '	,M.e35_edi_update_date'
	+ '	,M.e35_edi_file_line_no'
	+ '	,M.e35_edi_meisai_no'
	+ '	,M.e35_edi_error_msg'
	+ '	,M.e35_server_webpos'
	+ '	,M.e35_dbname_webpos'
	+ '	,M.e35_shop_cd_webpos'
	+ '	,M.e35_shop_name_webpos'
	+ '	,M.e35_seq_no'
	+ '	,M.e35_shop_cd_primary'
	+ '	,M.e35_shop_cd'
	+ '	,M.e35_tushin_id'
	+ '	,M.e35_annai_kubun'
	+ '	,M.e35_chumon_denpyo_no'
	+ '	,M.e35_chumon_line_no'
	+ '	,M.e35_goods_code_kubun'
	+ '	,M.e35_goods_code'
	+ '	,M.e35_kakaku_rank_code'
	+ '	,M.e35_price'
	+ '	,M.e35_goods_count'
	+ '	,M.e35_hachu_unit'
	+ '	,M.e35_hachu_limit'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_cmd as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_cmd as C'
	+ '                on M.e35_edi_id = C.e35_edi_id'
	+ '            where'
	+ '              C.e35_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e35_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e35_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e35_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9141,注文書明細データ取得エラー'
    GOTO SP_ERR
  End
  
  -- 変数定義
  Declare @a_temp_count               int
  Declare @a_temp_line_no             int
  -- ヘッダ
  Declare @e34_edi_id                 bigint
  Declare @e34_shop_cd_webpos         varchar(10)
  Declare @e34_shop_cd                varchar(10)
  Declare @e34_tushin_id              char(2)
  Declare @e34_annai_kubun            char(1)
  Declare @e34_chumon_denpyo_no       varchar(10)
  Declare @e34_chumon_title           varchar(40)
  Declare @e34_chumon_comment         varchar(200)
  Declare @e34_chumon_shimekiri_date  datetime
  -- 明細
  Declare @e35_edi_id                 bigint
  Declare @e35_shop_cd_webpos         varchar(10)
  Declare @e35_shop_cd                varchar(10)
  Declare @e35_tushin_id              char(2)
  Declare @e35_annai_kubun            char(1)
  Declare @e35_chumon_denpyo_no       varchar(10)
  Declare @e35_chumon_line_no         int
  Declare @e35_goods_code_kubun       char(1)
  Declare @e35_goods_code             varchar(20)
  Declare @e35_kakaku_rank_code       char(1)
  Declare @e35_price                  money
  Declare @e35_goods_count            int
  Declare @e35_hachu_unit             int
  Declare @e35_hachu_limit            int
  -- P03一時テーブル用
  Declare @p03_goods_id               int
  Declare @p03_koyu_goods_cd          varchar(20)
  Declare @p03_jan_cd                 varchar(20)
  Declare @p03_goods_name             varchar(100)
  Declare @p03_standard_number        varchar(20)
  Declare @p03_media_id               int
  Declare @p03_media_cd               varchar(10)
  Declare @p03_sales_price            money
  Declare @p03_default_price          money

  -- 処理日時
  Set @a_getdate = getdate()
  
  -- ヘッダがない明細はエラーにする
  UPDATE wbe_edibook_dw_cmd
  SET
      e35_edi_flag = '3'
    , e35_edi_error_msg = 'ヘッダなしエラー'
    , e35_edi_update_date = @a_getdate
  FROM wbe_edibook_dw_cmd
  LEFT OUTER JOIN wbe_edibook_dw_cmh
  ON 
    e35_tushin_id=e34_tushin_id
    AND e35_shop_cd=e34_shop_cd
    AND e35_annai_kubun=e34_annai_kubun
    AND e35_chumon_denpyo_no=e34_chumon_denpyo_no
  WHERE
    e34_edi_id IS NULL

  ------------------------------
  -- 明細用一時テーブル作成
  ------------------------------
  -- あれば削除
  If OBJECT_ID(N'tempdb..#TempChumonMeisai', N'U') IS NOT NULL 
    DROP TABLE #TempChumonMeisai
  --
  CREATE TABLE #TempChumonMeisai(
     t_e35_edi_id             bigint
   , t_e35_shop_cd_webpos     varchar(10)
   , t_e35_shop_cd            varchar(10)
   , t_e35_tushin_id          char(2)
   , t_e35_annai_kubun        char(1)
   , t_e35_chumon_denpyo_no   varchar(10)
   , t_e35_chumon_line_no     int
   , t_e35_goods_code_kubun   char(1)
   , t_e35_goods_code         varchar(20)
   , t_e35_kakaku_rank_code   char(1)
   , t_e35_price              money
   , t_e35_goods_count        int
   , t_e35_hachu_unit         int
   , t_e35_hachu_limit        int
   -- ここからP03用
   , t_p03_line_no             int            -- 行番号
   , t_p03_goods_id            int            -- 商品ＩＤ
   , t_p03_koyu_goods_cd       varchar(20)    -- 固有商品コード
   , t_p03_jan_cd              varchar(20)    -- JANコード
   , t_p03_goods_name          varchar(100)   -- 商品名称
   , t_p03_standard_number     varchar(20)    -- 規格番号
   , t_p03_media_id            int            -- メディアID
   , t_p03_media_cd            varchar(10)    -- メディアコード
   , t_p03_sales_price         money          -- 売価単価
   , t_p03_default_price       money          -- 定価
  )  
  
  ------------------------------
  -- 明細用一時テーブルにデータセット
  ------------------------------
  Set @a_temp_line_no = 0
  Set @rs = cursor static for
      SELECT
         e35_edi_id
       , e35_shop_cd_webpos
       , e35_shop_cd
       , e35_tushin_id
       , e35_annai_kubun
       , e35_chumon_denpyo_no
       , e35_chumon_line_no
       , e35_goods_code_kubun
       , e35_goods_code
       , e35_kakaku_rank_code
       , e35_price
       , e35_goods_count
       , e35_hachu_unit
       , e35_hachu_limit
      FROM
        wbe_edibook_dw_cmd
      WHERE
        e35_edi_flag = '0'  -- 未処理
      ORDER BY
          e35_tushin_id
        , e35_shop_cd
        , e35_annai_kubun
        , e35_chumon_denpyo_no
        , e35_chumon_line_no
  -- カーソルを開く
  open @rs
  -- ループ
  fetch next from @rs into
      @e35_edi_id
    , @e35_shop_cd_webpos
    , @e35_shop_cd
    , @e35_tushin_id
    , @e35_annai_kubun
    , @e35_chumon_denpyo_no
    , @e35_chumon_line_no
    , @e35_goods_code_kubun
    , @e35_goods_code
    , @e35_kakaku_rank_code
    , @e35_price
    , @e35_goods_count
    , @e35_hachu_unit
    , @e35_hachu_limit
    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
      -- 初期値セット
      SELECT
         @a_edi_error_msg = null
       , @a_edi_flag = '1'                    -- EDIフラグ実行済み
      -- 商品存在チェックしつつ、明細用一時テーブルにセット
      Set @p03_goods_id = null
      Exec P_PLU
              @plu_cd = @e35_goods_code
            , @shop_cd = @e35_shop_cd_webpos
            , @sp = '1'
            , @gds_goods_id = @p03_goods_id OUTPUT
            , @gds_koyu_goods_cd = @p03_koyu_goods_cd OUTPUT
            , @gds_jan_cd = @p03_jan_cd OUTPUT
            , @gds_goods_name = @p03_goods_name OUTPUT
            , @gds_price_default = @p03_default_price OUTPUT
            , @gdd_standard_number = @p03_standard_number OUTPUT
            , @gds_media_id = @p03_media_id OUTPUT
            , @gdm_media_cd = @p03_media_cd OUTPUT
            , @stk_price = @p03_sales_price OUTPUT
      -- 商品なければエラー扱い
      If @p03_goods_id is null Begin
        Select @a_edi_flag = '3'
             , @a_edi_error_msg = '商品なしエラー'
        GOTO LOOP_END_CHUMON_MEISAI_TEMP
      End
      
      -- 行番号更新
      Set @a_temp_line_no = @a_temp_line_no + 1
      -- 明細用一時テーブルにデータ投入
      INSERT INTO #TempChumonMeisai
      VALUES(
          @e35_edi_id
        , @e35_shop_cd_webpos
        , @e35_shop_cd
        , @e35_tushin_id
        , @e35_annai_kubun
        , @e35_chumon_denpyo_no
        , @e35_chumon_line_no
        , @e35_goods_code_kubun
        , @e35_goods_code
        , @e35_kakaku_rank_code
        , @e35_price
        , ISNULL(@e35_goods_count, 0)
        , @e35_hachu_unit
        , @e35_hachu_limit
        , @a_temp_line_no
        , @p03_goods_id
        , @p03_koyu_goods_cd
        , @p03_jan_cd
        , @p03_goods_name
        , @p03_standard_number
        , @p03_media_id
        , @p03_media_cd
        , @p03_sales_price
        , @p03_default_price
      )
      -- エラーチェック
      If @@ERROR <> 0 Begin
        Select @a_edi_flag = '3'
             , @a_edi_error_msg = '一時テーブルデータセットエラー'
        GOTO LOOP_END_CHUMON_MEISAI_TEMP
      End

      LOOP_END_CHUMON_MEISAI_TEMP:
       -- エラーだった場合は以下の処理
      If @a_edi_flag = '3' Begin
        -- カウント初期レコードセット
        If Not Exists(SELECT top 1 *
                      from #count_tbl
                      where
                        t_exec_id = substring(@edi_type,1,2)
                        and
                        t_tushin_id = @e35_tushin_id ) Begin
          INSERT INTO #count_tbl (
              t_exec_id
             ,t_tushin_id
             ,t_count_all
             ,t_count_ok
             ,t_count_wa
             ,t_count_ng
            )
            SELECT
              t_exec_id = substring(@edi_type,1,2)
             ,t_tushin_id = @e35_tushin_id
             ,t_count_all = 0
             ,t_count_ok = 0
             ,t_count_wa = 0
             ,t_count_ng = 0
        End
        -- 処理カウント更新
        UPDATE #count_tbl SET
           t_count_all = t_count_all + 1
          ,t_count_ng = -- エラー
               Case
                 when @a_edi_flag = '3' then t_count_ng + 1
                 else t_count_ng
               End
          where
             t_exec_id = substring(@edi_type,1,2)
             and
             t_tushin_id = @e35_tushin_id

        -- 明細のフラグを更新
        UPDATE wbe_edibook_dw_cmd SET
             e35_edi_flag = @a_edi_flag -- 異常終了
           , e35_edi_error_msg = @a_edi_error_msg
           , e35_edi_update_date = @a_getdate
        FROM wbe_edibook_dw_cmd
        WHERE e35_edi_id=@e35_edi_id
      End

      -- 次へ
      fetch next from @rs into
          @e35_edi_id
        , @e35_shop_cd_webpos
        , @e35_shop_cd
        , @e35_tushin_id
        , @e35_annai_kubun
        , @e35_chumon_denpyo_no
        , @e35_chumon_line_no
        , @e35_goods_code_kubun
        , @e35_goods_code
        , @e35_kakaku_rank_code
        , @e35_price
        , @e35_goods_count
        , @e35_hachu_unit
        , @e35_hachu_limit
    -- While
    End
  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs


  ------------------------------
  -- P03用一時テーブル作成
  ------------------------------
  -- あれば削除
  If OBJECT_ID(N'tempdb..##param3_temp', N'U') IS NOT NULL 
    DROP TABLE ##param3_temp
  --
  CREATE TABLE ##param3_temp(
      t_line_no             varchar(20)    -- 明細番号
    , t_goods_id            int            -- 商品ＩＤ
    , t_koyu_goods_cd       varchar(20)    -- 固有商品コード
    , t_jan_cd              varchar(20)    -- JANコード
    , t_goods_name          varchar(100)   -- 商品名称
    , t_hachu_no            varchar(20)    -- 発注番号
    , t_condition_type      char(1)        -- 商品区分
    , t_standard_number     varchar(20)    -- 規格番号
    , t_label_cd            varchar(10)    -- 発売元コード
    , t_sales_cd            varchar(10)    -- 販売元コード
    , t_media_cd            varchar(10)    -- メディアコード
    , t_delivery_unit_price money          -- 納品単価
    , t_sales_price         money          -- 売価単価
    , t_default_price       money          -- 定価
    , t_hachu_count         int            -- 発注実績数
    , t_distribution_count  int            -- 配布予定数
    , t_comment             varchar(200)   -- コメント
    , t_order_stop_flag     char(1)        -- 発注不可フラグ
    , t_delivery_price      money          -- 納品価格
    , t_maker_kana          varchar(50)    -- メーカー名カナ
    , t_artist_name         varchar(100)   -- アーチスト名
    , t_set_count           int            -- セット数
    , t_hinshu_kana         varchar(100)   -- 品種名カナ
    , t_genre_kana          varchar(100)   -- ジャンル名カナ
    , t_info_type1          varchar(2)     -- 情報区分１
    , t_info_type2          varchar(2)     -- 情報区分２
    , t_info_type3          varchar(2)     -- 情報区分３
    , t_info_type4          varchar(2)     -- 情報区分４
    , t_info_type5          varchar(2)     -- 情報区分５
    , t_past_goods_code1    varchar(20)    -- 過去商品コード１
    , t_past_goods_code2    varchar(20)    -- 過去商品コード２
    , t_past_goods_code3    varchar(20)    -- 過去商品コード３
    , t_supplier_cd         varchar(10)    -- 発注先コード
    , t_supplier_id         int            -- 発注先ID
    , t_media_id            int            -- メディアID
    , t_annai_line_no       int            -- 注文書行番号
  )
  
  ------------------------------
  -- 一時テーブル読み込み(ヘッダ)
  ------------------------------
  Set @rs = cursor static for
      SELECT
         e34_edi_id
       , e34_shop_cd_webpos
       , e34_shop_cd
       , e34_tushin_id
       , e34_annai_kubun
       , e34_chumon_denpyo_no
       , e34_chumon_title
       , e34_chumon_comment
       , e34_chumon_shimekiri_date
      FROM
        wbe_edibook_dw_cmh
      WHERE
        e34_edi_flag = '0'  -- 未処理
      ORDER BY
          e34_tushin_id
        , e34_shop_cd
        , e34_annai_kubun
        , e34_chumon_denpyo_no

  -- カーソルを開く
  open @rs

  -- ヘッダループ
  fetch next from @rs into
     @e34_edi_id
   , @e34_shop_cd_webpos
   , @e34_shop_cd
   , @e34_tushin_id
   , @e34_annai_kubun
   , @e34_chumon_denpyo_no
   , @e34_chumon_title
   , @e34_chumon_comment
   , @e34_chumon_shimekiri_date

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
      -- 初期値セット
      SELECT
         @a_edi_error_msg = null
       , @a_edi_flag = '1'                    -- EDIフラグ実行済み

      -- 取引先コードセット
      SELECT
          @a_supplier_id = mpm_supplier_id
        , @a_supplier_cd = mpm_supplier_cd
      FROM wpt_maker_supplier_master
      WHERE
        mpm_bookedi_cd = @e34_tushin_id
      ------------------------------
      -- 明細一時テーブルの値をP03用一時テーブルにセット
      ------------------------------
      -- セット対象数取得
      SELECT 
        @a_temp_count = COUNT(t_e35_edi_id)
      FROM #TempChumonMeisai
      WHERE
        t_e35_tushin_id=@e34_tushin_id
        AND t_e35_shop_cd=@e34_shop_cd
        AND t_e35_annai_kubun=@e34_annai_kubun
        AND t_e35_chumon_denpyo_no=@e34_chumon_denpyo_no
      -- 明細がなかったらエラー
      If @a_temp_count = 0 Begin
        Select @a_edi_flag = '3'
             , @a_edi_error_msg = '明細なしエラー'
        GOTO LOOP_END_CHUMON_EXEC
      End
      -- P03テーブルのデータを削除してからINSERT
      DELETE FROM ##param3_temp
      INSERT INTO ##param3_temp
      SELECT 
          t_p03_line_no           -- 明細番号
        , t_p03_goods_id          -- 商品ＩＤ
        , t_p03_koyu_goods_cd     -- 固有商品コード
        , t_p03_jan_cd            -- JANコード
        , t_p03_goods_name        -- 商品名称
        , null                    -- 発注番号
        , '0'                     -- 商品区分(新品固定)
        , t_p03_standard_number   -- 規格番号
        , null                    -- 発売元コード
        , null                    -- 販売元コード
        , t_p03_media_cd          -- メディアコード
        , 0                       -- 納品単価
        , t_p03_sales_price       -- 売価単価
        , t_p03_default_price     -- 定価
        , t_e35_goods_count       -- 発注実績数
        , 0                       -- 配布予定数
        , null                    -- コメント
        , '0'                     -- 発注不可フラグ
        , 0                       -- 納品価格
        , null                    -- メーカー名カナ
        , null                    -- アーチスト名
        , null                    -- セット数
        , null                    -- 品種名カナ
        , null                    -- ジャンル名カナ
        , '0'                     -- 情報区分１
        , '0'                     -- 情報区分２
        , '0'                     -- 情報区分３
        , '0'                     -- 情報区分４
        , '0'                     -- 情報区分５
        , null                    -- 過去商品コード１
        , null                    -- 過去商品コード２
        , null                    -- 過去商品コード３
        , @a_supplier_cd          -- 発注先コード
        , @a_supplier_id          -- 発注先ID
        , t_p03_media_id          -- メディアID
        , t_e35_chumon_line_no    -- 注文書行番号
      FROM #TempChumonMeisai
      WHERE
        t_e35_tushin_id=@e34_tushin_id
        AND t_e35_shop_cd=@e34_shop_cd
        AND t_e35_annai_kubun=@e34_annai_kubun
        AND t_e35_chumon_denpyo_no=@e34_chumon_denpyo_no
      ORDER BY
        t_p03_line_no
      -- エラーチェック
      If @@ERROR <> 0 Begin
        Select @a_edi_flag = '3'
             , @a_edi_error_msg = 'P03用一時テーブルデータセットエラー'
        GOTO LOOP_END_CHUMON_EXEC
      End

      -- P_Tran用パラメータ作成
      SELECT
        @P01 = ''
             + '0002.0001'  -- パラメタ受け渡しバージョン
             + ',' + object_name(@@PROCID) + '_' + @edi_type  -- アプリケーションバージョン
             + ',' + CAST(@e34_shop_cd_webpos as varchar)  -- 店舗コード
             + ',0100'  -- 業務区分(イニシャル発注提案)
             + ',0'     -- 伝票区分
             + ',0'     -- POS番号
             + ',' + CONVERT(varchar,getdate(),120)  -- 取引日時
             + ',' + CONVERT(varchar,getdate(),120)  -- ＰＯＳ取引日時
             + ','      -- レシート番号
             + ','      -- 担当ＩＤ
             + ','      -- 担当コード
             + ','      -- 会員ＩＤ
             + ','      -- 会員コード
             + ','      -- 会員カードコード
             + ',' + CAST(@e34_shop_cd_webpos as varchar)  -- 操作店舗コード
             + ','      -- 紐付け元取引ＩＤ
             + ','      -- 紐付け元業務区分
             + ','      -- 追加処理用取引ＩＤ
             + ',0'     -- 再登録フラグ
      , @P02 = ''
             + ''  + @e34_annai_kubun  -- 取引区分
             + ',' + CONVERT(varchar,getdate(),111)  -- 案内日
             + ',' + @e34_chumon_denpyo_no  -- 案内番号
             + ',' + CAST(@e34_chumon_denpyo_no AS varchar)  -- グループコード
             + ',' + @e34_chumon_title  -- グループ名称
             + ','      -- 一次締切日
             + ',' + CONVERT(varchar,@e34_chumon_shimekiri_date,111)  -- 最終締切日
             + ','      -- 最小チラシ期間
             + ','      -- 最大チラシ期間
             + ','      -- 取扱区分
      ,@P03 = '0'       -- ダミー
      -- SPキック
      Exec @rc = P_Transaction
                     @P01 = @P01
                   , @P02 = @P02
                   , @P03 = @P03
                   , @details_parms = '0'
                   , @details_name = '##param3_temp'
                   , @SP  = '1'
                   , @err_msg = @err_msg OUTPUT
      -- エラーチェック
      If @rc <> 0 Begin
        -- エラー記録
        SELECT
           @a_edi_error_msg = '処理ＳＰエラー'
               + ',m=[' + isnull(@err_msg,'') + ']'
               + ',@P01=[' + isnull(@P01,'') + ']'
               + ',@P02=[' + isnull(@P02,'') + ']'
               + ',@P03=[' + isnull(@P03,'') + ']'
          ,@a_edi_flag = '3'  -- エラー
      End

      LOOP_END_CHUMON_EXEC:
      -- 処理結果記録
      -- ヘッダ
      UPDATE wbe_edibook_dw_cmh SET
          e34_edi_flag = @a_edi_flag
        , e34_edi_error_msg = @a_edi_error_msg
        , e34_edi_update_date = @a_getdate
         where
            e34_edi_id = @e34_edi_id
      -- 明細
      UPDATE wbe_edibook_dw_cmd
      SET
          e35_edi_flag = @a_edi_flag
        , e35_edi_error_msg = @a_edi_error_msg
        , e35_edi_update_date = @a_getdate
      FROM wbe_edibook_dw_cmd
      JOIN #TempChumonMeisai
      ON e35_edi_id = t_e35_edi_id
      WHERE
        t_e35_tushin_id=@e34_tushin_id
        AND t_e35_shop_cd=@e34_shop_cd
        AND t_e35_annai_kubun=@e34_annai_kubun
        AND t_e35_chumon_denpyo_no=@e34_chumon_denpyo_no

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @e34_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @e34_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + @a_temp_count
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + @a_temp_count
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + @a_temp_count
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + @a_temp_count
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @e34_tushin_id

      -- 次へ
      fetch next from @rs into
          @e34_edi_id
        , @e34_shop_cd_webpos
        , @e34_shop_cd
        , @e34_tushin_id
        , @e34_annai_kubun
        , @e34_chumon_denpyo_no
        , @e34_chumon_title
        , @e34_chumon_comment
        , @e34_chumon_shimekiri_date
    -- While
    End
  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  DOWN_CHUMON_LAST_STEP:
  ------------------------------
  -- P03用一時テーブル削除
  ------------------------------
  If OBJECT_ID(N'tempdb..##param3_temp', N'U') IS NOT NULL 
    DROP TABLE ##param3_temp

  ------------------------------
  -- 明細用一時テーブル削除
  ------------------------------
  If OBJECT_ID(N'tempdb..#TempChumonMeisai', N'U') IS NOT NULL 
    DROP TABLE #TempChumonMeisai

  ------------------------------
  -- データ同期
  ------------------------------
  -- ヘッダと明細の両方を処理
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = '34D' -- ヘッダ
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9132,注文書ヘッダデータ同期エラー'
    GOTO SP_ERR
  End
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = '35D' -- 明細
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9142,注文書明細データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  -- ヘッダと明細の両方を処理
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = '34D' -- ヘッダ
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9133,注文書ヘッダログ出力エラー'
    GOTO SP_ERR
  End
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = '35D' -- 明細
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9143,注文書明細ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_CHUMON_END:


--=================================================
-- 【トップカルチャー本部連動】下り文具価格マスタ処理		-- 2012/09/03 add
--=================================================
DOWN_BUNGUKAKAKU_TPC:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9001,文具価格マスタ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_bgm ('
	+ '	 e36_edi_flag'
	+ '	,e36_edi_timestamp'
	+ '	,e36_edi_id'
	+ '	,e36_edi_create_date'
	+ '	,e36_edi_update_date'
	+ '	,e36_edi_file_line_no'
	+ '	,e36_edi_meisai_no'
	+ '	,e36_edi_error_msg'
	+ '	,e36_server_webpos'
	+ '	,e36_dbname_webpos'
	+ '	,e36_shop_cd_webpos'
	+ '	,e36_shop_name_webpos'
	+ '	,e36_shop_cd_primary'
	+ '	,e36_shop_cd'
	+ '	,e36_tushin_id'

	+ '	,e36_plu_cd'
	+ '	,e36_bumon_cd'
	+ '	,e36_class_cd'
	+ '	,e36_type'
	+ '	,e36_goods_name'
	+ '	,e36_goods_name_kana'
	+ '	,e36_goods_name_print'
	+ '	,e36_price'
	+ '	,e36_cost_price'
	+ '	,e36_campaign_price'
	+ '	,e36_campaign_start_date'
	+ '	,e36_campaign_end_date'
	+ '	,e36_tax_type'
	+ '	,e36_point_input_type'
	+ '	,e36_nebiki_type'
	+ '	,e36_zero_price_type'
	+ '	,e36_mm_cd'
	+ '	,e36_set_count'
	+ '	,e36_anbun_type'
	+ '	,e36_customer_type'
	+ '	,e36_goods_cd'
	+ '	,e36_update_date'
	+ '	,e36_update_time'
	+ '	,e36_preset_cd'
	+ '	,e36_order_no'
	+ '	,e36_start_date'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e36_edi_flag'
	+ '	,M.e36_edi_timestamp'
	+ '	,M.e36_edi_id'
	+ '	,M.e36_edi_create_date'
	+ '	,M.e36_edi_update_date'
	+ '	,M.e36_edi_file_line_no'
	+ '	,M.e36_edi_meisai_no'
	+ '	,M.e36_edi_error_msg'
	+ '	,M.e36_server_webpos'
	+ '	,M.e36_dbname_webpos'
	+ '	,M.e36_shop_cd_webpos'
	+ '	,M.e36_shop_name_webpos'
	+ '	,M.e36_shop_cd_primary'
	+ '	,M.e36_shop_cd'
	+ '	,M.e36_tushin_id'

	+ '	,M.e36_plu_cd'
	+ '	,M.e36_bumon_cd'
	+ '	,M.e36_class_cd'
	+ '	,M.e36_type'
	+ '	,M.e36_goods_name'
	+ '	,M.e36_goods_name_kana'
	+ '	,M.e36_goods_name_print'
	+ '	,M.e36_price'
	+ '	,M.e36_cost_price'
	+ '	,M.e36_campaign_price'
	+ '	,M.e36_campaign_start_date'
	+ '	,M.e36_campaign_end_date'
	+ '	,M.e36_tax_type'
	+ '	,M.e36_point_input_type'
	+ '	,M.e36_nebiki_type'
	+ '	,M.e36_zero_price_type'
	+ '	,M.e36_mm_cd'
	+ '	,M.e36_set_count'
	+ '	,M.e36_anbun_type'
	+ '	,M.e36_customer_type'
	+ '	,M.e36_goods_cd'
	+ '	,M.e36_update_date'
	+ '	,M.e36_update_time'
	+ '	,M.e36_preset_cd'
	+ '	,M.e36_order_no'
	+ '	,M.e36_start_date'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_bgm as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_bgm as C'
	+ '                on M.e36_edi_id = C.e36_edi_id'
	+ '            where'
	+ '              C.e36_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e36_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e36_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e36_dbname_webpos = ''' + @db_name + ''''
	+ '            order by '
	+ '              M.e36_edi_id'  -- ID順に取り込む
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9001,文具価格マスタ取得エラー'
    GOTO SP_ERR
  End


  ------------------------------------------
  -- トップカルチャー部門CD変換データ作成
  ------------------------------------------
	-- INSERT
	INSERT INTO
		wbe_topculture_bumon_convert
	(
		 tcb_jan_cd
		,tcb_bumon_cd
	)
	SELECT
		 e36_plu_cd
		,Max(e36_bumon_cd)
	FROM
		wbe_edibook_dw_bgm WITH(NOLOCK)
	LEFT OUTER JOIN
		wbe_topculture_bumon_convert WITH(NOLOCK)
		ON
			e36_plu_cd = tcb_jan_cd
	WHERE
		e36_edi_flag = '0'  -- 未処理
		AND
		tcb_jan_cd Is Null	-- 追加されていないもの
	GROUP BY
		e36_plu_cd

	-- UPDATE
	UPDATE
		wbe_topculture_bumon_convert
	SET
		tcb_bumon_cd = e36_bumon_cd
	FROM
		wbe_edibook_dw_bgm WITH(NOLOCK)
	JOIN
		wbe_topculture_bumon_convert WITH(NOLOCK)
		ON
			e36_plu_cd = tcb_jan_cd
	WHERE
		e36_edi_flag = '0'  -- 未処理
		AND
		tcb_bumon_cd <> e36_bumon_cd	-- 部門コードが異なるもの


  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e36_tushin_id char (2)
  Declare @e36_bumon_cd varchar(4) 
  Declare @e36_goods_name varchar(16) 
  Declare @e36_goods_name_kana varchar(16) 
  Declare @e36_goods_name_print varchar(16) 
  Declare @e36_price varchar(8) 
  Declare @e36_cost_price varchar(8) 
  Declare @e36_tax_type char(2)
  Declare @e36_anbun_type char(1)

  Declare @e36_mst_update_flag char (1)
  Declare @e36_stk_update_flag char (1)

  Declare @a_cost_price int

  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		 e36_edi_id
		,e36_shop_cd_webpos
		,e36_tushin_id
		,e36_plu_cd
		,e36_bumon_cd
		,e36_goods_name
		,e36_goods_name_kana
		,e36_goods_name_print
		,e36_price
		,e36_cost_price
		,e36_tax_type
		,e36_anbun_type
	from
		wbe_edibook_dw_bgm
	where
		e36_edi_flag = '0'  -- 未処理
	order by
		 e36_edi_id
		,e36_edi_file_line_no
		,e36_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_shop_cd
	,@a_tushin_id
	,@a_goods_code
	,@e36_bumon_cd
	,@e36_goods_name
	,@e36_goods_name_kana
	,@e36_goods_name_print
	,@e36_price
	,@e36_cost_price
	,@e36_tax_type
	,@e36_anbun_type

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	-- 初期値セット
	SELECT
		@a_edi_error_msg = null         -- エラーメッセージクリア
		,@a_edi_flag = '1'                    -- EDIフラグ実行済み
		,@a_goods_id = null
		,@a_jan = null
		,@a_jan_new = null

	-- コードチェック
	If @a_goods_code is null or rtrim(ltrim(@a_goods_code)) = '' Begin
		-- エラー記録
		SELECT
			@a_edi_error_msg = '商品コードなし'
			+ ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
			,@a_edi_flag = '2'  -- 警告
		-- ループ終了まで飛ばす
		GOTO LOOP_END_BUNGUKAKAKU_TPC
	End

	-- 対象外コードチェック（商品コード0の場合）
	If isnumeric(@a_goods_code) = 1 and 
		( cast(ltrim(rtrim(@a_goods_code)) as bigint) = 0 ) Begin
		-- エラー記録
		SELECT
			@a_edi_error_msg = '対象外コード'
			 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
			,@a_edi_flag = '2'  -- 警告
		-- ループ終了まで飛ばす
		GOTO LOOP_END_BUNGUKAKAKU_TPC
	End

/*
	-- インストアコードチェック
	If substring(ltrim(rtrim(@a_goods_code)),1,1) = '2'
		and len(ltrim(rtrim(@a_goods_code))) = 13 Begin
		-- エラー記録
		SELECT
			@a_edi_error_msg = '対象外コード(インストア)'
			 + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
			 + ',取次=[' + isnull(@a_tushin_id,'') + ']'
			,@a_edi_flag = '2'  -- 警告
		-- ループ終了まで飛ばす
		GOTO LOOP_END_BUNGUKAKAKU_TPC
	End
*/

	-- 税区分チェック
	If @e36_tax_type is null or rtrim(ltrim(@e36_tax_type)) = '' Begin
		-- エラー記録
		SELECT
			@a_edi_error_msg = '税区分なし'
			 + ' 税区分=[' + isnull(@e36_tax_type,'') + ']'
			,@a_edi_flag = '2'  -- 警告
		-- ループ終了まで飛ばす
		GOTO LOOP_END_BUNGUKAKAKU_TPC
	End

	-- JAN生成
	SELECT @a_jan = @a_goods_code

	If isnull(@a_jan,'') = '' Begin
		-- エラー記録
		SELECT
			@a_edi_error_msg = 'JAN生成エラー'
			+ ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
			+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
			+ ',エラーコード=[' + isnull(@a_jan,'') + ']'
			,@a_edi_flag = '3'  -- エラー
		-- ループ終了まで飛ばす
		GOTO LOOP_END_BUNGUKAKAKU_TPC
	End

	-- データセット
	SELECT
		 @a_goods_name = 
			cast(LTrim(RTrim(@e36_goods_name)) as varchar(100))
		,@a_tax_type = 
			case @e36_tax_type
				when '01' then '0'	-- 外税
				when '03' then '1'	-- 内税
				when '05' then '2'	-- 非課税
			end
		,@a_price = cast(isnull(@e36_price,0) as int)
		,@a_cost_price = cast(isnull(@e36_cost_price,0) as int)
		,@a_price_type = @a_tax_type
		,@a_goods_type = '00'		-- 商材区分は、00:一般商品　固定
		,@a_media_id = dbo.F_Search_Bungu_Media(@e36_bumon_cd)

	-- P_PLUで商品存在チェックを行なう
	SET @e36_mst_update_flag = '0'
	SET @e36_stk_update_flag = '0'
	SET @a_exist_goods_id = null
	SET @a_exist_goods_type = null
	SET @a_exist_goods_media_id = null
	SET @a_exist_jan_cd = null

    -- JANで検索
    Exec @rc = P_PLU
           @plu_cd = @a_jan
          ,@plu_type = '0'
          ,@sp = '1'
          ,@gds_goods_id = @a_exist_goods_id OUTPUT
          ,@gds_goods_type = @a_exist_goods_type OUTPUT

    -- エラーチェック
    If @rc <> 0 Begin
       -- エラー記録
       SELECT
          @a_edi_error_msg = '商品マスタ検索エラー'
             + ' 商品コード=[' + isnull(@a_goods_code,'') + ']'
             + ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
             + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
         ,@a_edi_flag = '3'  -- エラー
       -- ループ終了まで飛ばす
       GOTO LOOP_END_MST
    End

    -- 商品マスタが既にある場合フラグセット
	If @a_exist_goods_id is not null Begin
		SET @e36_mst_update_flag = '1'   -- 20070621 add
    End

	-- 商品マスタ作成処理  -- データがあればＩＤ取得もかねる
	Declare @a_tpc_plu_cd varchar(20)
	Declare @a_tpc_plu_type char(1)
	Declare @a_tpc_plu_addon_cd varchar(20)
	-- デフォ値
	SELECT
		@a_tpc_plu_cd = @a_jan
		, @a_tpc_plu_type = '0'
		, @a_tpc_plu_addon_cd = null

	-- 作成
	Exec @rc = P_Goods_Create 
		@goods_type   = @a_goods_type
		,@plu_cd       = @a_tpc_plu_cd
		,@plu_type     = @a_tpc_plu_type
		,@goods_name   = @a_goods_name
		,@tax_type     = @a_tax_type
		,@price        = @a_price
		,@price_type   = @a_price_type
		,@plu_addon_cd = @a_tpc_plu_addon_cd
		,@sp           = '1'  -- SP起動
		,@goods_id     = @a_goods_id OUTPUT
	-- エラーチェック
	If @rc <> 0 or @a_goods_id is null Begin
		-- エラー記録
		SELECT
			@a_edi_error_msg = '商品マスタ生成エラー'
			+ ' 商品コード=[' + isnull(@a_jan,'') + ']'
			+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
			+ ',商品ＩＤ=[' + cast(isnull(@a_goods_id,'') AS varchar(20)) + ']'
            + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
			,@a_edi_flag = '3'  -- エラー
		-- ループ終了まで飛ばす
		GOTO LOOP_END_BUNGUKAKAKU_TPC
	End

	-- マスタUPDATE
	UPDATE wpt_goods_master SET
		 gds_update_date = getdate()
		,gds_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
		,gds_goods_name =
			case
			when isnull(@a_goods_name,'') <> '' then @a_goods_name
			else gds_goods_name
			end
		,gds_goods_ryaku = cast(@a_goods_name as varchar(50))
		,gds_media_id = @a_media_id
		,gds_auto_hachu_flag = '0'
		,gds_bookedi_cd = @a_tushin_id
		,gds_tax_type = @a_tax_type
		,gds_price_type = @a_tax_type
	FROM
		wpt_goods_master
	LEFT OUTER JOIN
		wpt_goods_master_book
		on
			gds_goods_id = gdb_goods_id
	LEFT OUTER JOIN
		wpt_maker_publisher_master
		on
			gdb_publisher_cd = mpb_publisher_cd
	WHERE
		gds_goods_id = @a_goods_id


	-------------------------------
	-- 在庫マスタに価格(売価は税込み)をセット
	-------------------------------
	If @a_goods_id is not null Begin
		If Not Exists(SELECT top 1 *
			from wpt_stock_master with(nolock)
			where
			stk_goods_id = @a_goods_id
			and
			stk_shop_cd = @a_shop_cd
			and
			stk_condition_type = '0' ) Begin
				-- なければ在庫マスタInsert
				INSERT INTO wpt_stock_master (
					stk_goods_id
					,stk_shop_cd
					,stk_condition_type
					,stk_update_memo
					,stk_price
					,stk_cost_price_last
				)
				SELECT
					stk_goods_id = @a_goods_id
					,stk_shop_cd = @a_shop_cd
					,stk_condition_type = '0'
					,stk_update_memo = object_name(@@PROCID) + '[mst]' + '[' + isnull(@a_tushin_id,'') +  ']'
					,stk_price =			-- ※売価は税込み額でセットする
						case @a_tax_type
							when '0' then Floor( @a_price * ( 100 + @a_tax_rate ) / 100 ) -- 外税（切捨てで計算）
							when '1' then @a_price	-- 内税
							when '2' then @a_price	-- 非課税
						end
					,stk_cost_price_last = @a_cost_price
				-- エラーチェック
				If @rc <> 0 Begin
					-- エラー記録
					SELECT
						@a_edi_error_msg = '在庫マスタ追加エラー'
						+ ' 商品コード=[' + isnull(@a_jan,'') + ']'
						+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
						+ ',商品ＩＤ=[' + isnull(@a_goods_id,'') + ']'
						+ ',エラーコード=[' + isnull(@rc,'') + ']'
						,@a_edi_flag = '3'  -- エラー
				End
		-- ループ終了まで飛ばす
		GOTO LOOP_END_BUNGUKAKAKU_TPC
		End Else Begin
				-- あれば在庫マスタUpdate
				UPDATE wpt_stock_master
				SET
					 stk_price = 			-- ※売価は税込み額でセットする
						case @a_tax_type
							when '0' then Floor( @a_price * ( 100 + @a_tax_rate ) / 100 ) -- 外税（切捨てで計算）
							when '1' then @a_price	-- 内税
							when '2' then @a_price	-- 非課税
						end
					,stk_cost_price_last = @a_cost_price
				WHERE
					stk_goods_id = @a_goods_id
					and stk_shop_cd = @a_shop_cd
					and stk_condition_type = '0'
				-- エラーチェック
				If @rc <> 0 Begin
					-- エラー記録
					SELECT
						@a_edi_error_msg = '在庫マスタ更新エラー'
						+ ' 商品コード=[' + isnull(@a_jan,'') + ']'
						+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
						+ ',商品ＩＤ=[' + isnull(@a_goods_id,'') + ']'
						+ ',エラーコード=[' + isnull(@rc,'') + ']'
						,@a_edi_flag = '3'  -- エラー
				End
		End
	End

    LOOP_END_BUNGUKAKAKU_TPC:  -- 商品マスタ更新処理終了


	-- 処理結果記録
	Set @a_getdate = getdate()
	UPDATE wbe_edibook_dw_bgm SET
		e36_edi_flag = @a_edi_flag
		,e36_edi_error_msg = @a_edi_error_msg
		,e36_edi_update_date = @a_getdate
	where
		e36_edi_id = @a_edi_id

	-- カウント初期レコードセット
	If Not Exists(SELECT top 1 *
		from #count_tbl
		where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @a_tushin_id ) Begin
			INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
			)
			SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @a_tushin_id
			,t_count_all = 0
			,t_count_ok = 0
			,t_count_wa = 0
			,t_count_ng = 0
	End

	-- 処理カウント更新
	UPDATE #count_tbl SET
		t_count_all = t_count_all + 1
		,t_count_ok = -- 正常
			Case
			when @a_edi_flag = '1' then t_count_ok + 1
			else t_count_ok
			End
		,t_count_wa = -- 警告
			Case
			when @a_edi_flag = '2' then t_count_wa + 1
			else t_count_wa
			End
		,t_count_ng = -- エラー
			Case
			when @a_edi_flag = '3' then t_count_ng + 1
			else t_count_ng
			End
	where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @a_tushin_id

    -- 次へ
    fetch next from @rs into
		 @a_edi_id
		,@a_shop_cd
		,@a_tushin_id
		,@a_goods_code
		,@e36_bumon_cd
		,@e36_goods_name
		,@e36_goods_name_kana
		,@e36_goods_name_print
		,@e36_price
		,@e36_cost_price
		,@e36_tax_type
		,@e36_anbun_type
  End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9002,文具価格マスタ同期エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
          ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9003,銘柄ログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

DOWN_DOWN_BUNGUKAKAKU_TPC_END:


--=================================================
-- 【星光堂】下りメーカーＪＡＮ移行データ処理		-- 2012/12/27 add
--=================================================
DOWN_MAKER_JAN_IKO:
print @edi_type
print @edi_server_name
print @edi_db_name
print @server_name
print @db_name
  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9001,メーカーＪＡＮ移行データ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_iko ('
	+ '	 e37_edi_flag'
	+ '	,e37_edi_timestamp'
	+ '	,e37_edi_id'
	+ '	,e37_edi_create_date'
	+ '	,e37_edi_update_date'
	+ '	,e37_edi_file_line_no'
	+ '	,e37_edi_meisai_no'
	+ '	,e37_edi_error_msg'
	+ '	,e37_server_webpos'
	+ '	,e37_dbname_webpos'
	+ '	,e37_shop_cd_webpos'
	+ '	,e37_shop_name_webpos'
	+ '	,e37_shop_cd_primary'
	+ '	,e37_shop_cd'
	+ '	,e37_tushin_id'

	+ '	,e37_master_date'
	+ '	,e37_syohin_key'
	+ '	,e37_iko_field_kubun'
	+ '	,e37_now_maker_code'
	+ '	,e37_now_cd_kikaku_bango'
	+ '	,e37_now_goods_code'
	+ '	,e37_now_goods_code_kubun'
	+ '	,e37_iko_old_flag'
	+ '	,e37_new_maker_code'
	+ '	,e37_new_cd_kikaku_bango'
	+ '	,e37_new_goods_code'
	+ '	,e37_new_goods_code_kubun'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e37_edi_flag'
	+ '	,M.e37_edi_timestamp'
	+ '	,M.e37_edi_id'
	+ '	,M.e37_edi_create_date'
	+ '	,M.e37_edi_update_date'
	+ '	,M.e37_edi_file_line_no'
	+ '	,M.e37_edi_meisai_no'
	+ '	,M.e37_edi_error_msg'
	+ '	,M.e37_server_webpos'
	+ '	,M.e37_dbname_webpos'
	+ '	,M.e37_shop_cd_webpos'
	+ '	,M.e37_shop_name_webpos'
	+ '	,M.e37_shop_cd_primary'
	+ '	,M.e37_shop_cd'
	+ '	,M.e37_tushin_id'

	+ '	,M.e37_master_date'
	+ '	,M.e37_syohin_key'
	+ '	,M.e37_iko_field_kubun'
	+ '	,M.e37_now_maker_code'
	+ '	,M.e37_now_cd_kikaku_bango'
	+ '	,M.e37_now_goods_code'
	+ '	,M.e37_now_goods_code_kubun'
	+ '	,M.e37_iko_old_flag'
	+ '	,M.e37_new_maker_code'
	+ '	,M.e37_new_cd_kikaku_bango'
	+ '	,M.e37_new_goods_code'
	+ '	,M.e37_new_goods_code_kubun'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_iko as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_iko as C'
	+ '                on M.e37_edi_id = C.e37_edi_id'
	+ '            where'
	+ '              C.e37_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e37_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e37_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e37_dbname_webpos = ''' + @db_name + ''''
	+ '            order by '
	+ '              M.e37_edi_id'  -- ID順に取り込む
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9001,メーカーＪＡＮ移行データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e37_tushin_id char (2)
  Declare @e37_iko_field_kubun char(1)
  Declare @e37_now_goods_code varchar(13) 
  Declare @e37_new_maker_code char(3) 
  Declare @e37_new_cd_kikaku_bango varchar(20) 
  Declare @e37_new_goods_code varchar(13) 

  Declare @e37_mst_update_flag char (1)

  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		 e37_edi_id
		,e37_shop_cd_webpos
		,e37_tushin_id
		,e37_iko_field_kubun
		,e37_now_goods_code
		,e37_new_maker_code
		,e37_new_cd_kikaku_bango
		,e37_new_goods_code
	from
		wbe_edibook_dw_iko
	where
		e37_edi_flag = '0'  -- 未処理
	order by
		 e37_edi_id
		,e37_edi_file_line_no
		,e37_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_shop_cd
	,@a_tushin_id
	,@e37_iko_field_kubun
	,@e37_now_goods_code
	,@e37_new_maker_code
	,@e37_new_cd_kikaku_bango
	,@e37_new_goods_code

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	-- 初期値セット
	SELECT
		@a_edi_error_msg = null         -- エラーメッセージクリア
		,@a_edi_flag = '1'                    -- EDIフラグ実行済み
		,@a_goods_id = null
		,@a_jan = null
		,@a_jan_new = null


	-- JAN生成
	SELECT @a_jan = @e37_now_goods_code

	If isnull(@a_jan,'') = '' Begin
		-- エラー記録
		SELECT
			@a_edi_error_msg = 'JAN生成エラー'
			+ ' 商品コード=[' + isnull(@e37_now_goods_code,'') + ']'
			+ ',エラーコード=[' + isnull(@a_jan,'') + ']'
			,@a_edi_flag = '3'  -- エラー
		-- ループ終了まで飛ばす
		GOTO LOOP_END_MAKER_JAN_IKO
	End

	-- P_PLUで商品存在チェックを行なう
	SET @e37_mst_update_flag = '0'
	SET @a_exist_goods_id = null
	SET @a_exist_goods_type = null
	SET @a_exist_goods_media_id = null
	SET @a_exist_jan_cd = null

    -- JANで検索
    Exec @rc = P_PLU
           @plu_cd = @a_jan
          ,@plu_type = '0'
          ,@sp = '1'
          ,@gds_goods_id = @a_goods_id OUTPUT

    -- エラーチェック
    If @rc <> 0 Begin
       -- エラー記録
       SELECT
          @a_edi_error_msg = '商品マスタ検索エラー'
             + ' 商品コード=[' + isnull(@e37_now_goods_code,'') + ']'
             + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
         ,@a_edi_flag = '3'  -- エラー
       -- ループ終了まで飛ばす
       GOTO LOOP_END_MAKER_JAN_IKO
    End

    -- 商品マスタが既にある場合フラグセット
	If @a_goods_id is not null Begin
		SET @e37_mst_update_flag = '1'   -- 20070621 add
    End

	-----------------------------------------------
	-- メーカー、品番更新処理
	-- （移行項目区分＝1:メーカー品番、3:両方の場合）
	-----------------------------------------------
	IF @e37_iko_field_kubun = '1' OR @e37_iko_field_kubun = '3' Begin

		-- 商品マスタ UPDATE
		UPDATE wpt_goods_master SET
			 gds_update_date = getdate()
			,gds_update_memo = object_name(@@PROCID) + '[iko]' + '[' + isnull(@a_tushin_id,'') +  ']' + '[' + isnull(@e37_iko_field_kubun,'') +  ']'
		FROM
			wpt_goods_master
		WHERE
			gds_goods_id = @a_goods_id

		-- 商品マスタDISK UPDATE
		UPDATE wpt_goods_master_disk SET
			 gdd_label_cd = RTrim(LTrim(Replace(Replace(@e37_new_maker_code,'.',''),'-','')))
			,gdd_standard_number = RTrim(LTrim(Replace(Replace(@e37_new_cd_kikaku_bango,'.',''),'-','')))
		FROM
			wpt_goods_master_disk
		WHERE
			gdd_goods_id = @a_goods_id

	END

	-----------------------------------------------
	-- ＪＡＮコード更新処理
	-- （移行項目区分＝2:ＪＡＮ、3:両方の場合）
	-----------------------------------------------
	IF @e37_iko_field_kubun = '2' OR @e37_iko_field_kubun = '3' Begin

		-- 商品マスタ UPDATE
		UPDATE wpt_goods_master SET
			 gds_update_date = getdate()
			,gds_update_memo = object_name(@@PROCID) + '[iko]' + '[' + isnull(@a_tushin_id,'') +  ']' + '[' + isnull(@e37_iko_field_kubun,'') +  ']'
			,gds_jan_cd = @e37_new_goods_code
		FROM
			wpt_goods_master
		WHERE
			gds_goods_id = @a_goods_id

	END

    LOOP_END_MAKER_JAN_IKO:  -- 更新処理終了


	-- 処理結果記録
	Set @a_getdate = getdate()
	UPDATE wbe_edibook_dw_iko SET
		e37_edi_flag = @a_edi_flag
		,e37_edi_error_msg = @a_edi_error_msg
		,e37_edi_update_date = @a_getdate
	where
		e37_edi_id = @a_edi_id

	-- カウント初期レコードセット
	If Not Exists(SELECT top 1 *
		from #count_tbl
		where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @a_tushin_id ) Begin
			INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
			)
			SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @a_tushin_id
			,t_count_all = 0
			,t_count_ok = 0
			,t_count_wa = 0
			,t_count_ng = 0
	End

	-- 処理カウント更新
	UPDATE #count_tbl SET
		t_count_all = t_count_all + 1
		,t_count_ok = -- 正常
			Case
			when @a_edi_flag = '1' then t_count_ok + 1
			else t_count_ok
			End
		,t_count_wa = -- 警告
			Case
			when @a_edi_flag = '2' then t_count_wa + 1
			else t_count_wa
			End
		,t_count_ng = -- エラー
			Case
			when @a_edi_flag = '3' then t_count_ng + 1
			else t_count_ng
			End
	where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @a_tushin_id

    -- 次へ
    fetch next from @rs into
	 @a_edi_id
	,@a_shop_cd
	,@a_tushin_id
	,@e37_iko_field_kubun
	,@e37_now_goods_code
	,@e37_new_maker_code
	,@e37_new_cd_kikaku_bango
	,@e37_new_goods_code
  End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9002,メーカーＪＡＮ移行データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9003,メーカーＪＡＮ移行データログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

DOWN_MAKER_JAN_IKO_END:

--=================================================
-- 【星光堂】下り基準曲データ処理		-- 2012/12/27 add
--=================================================
DOWN_KIJUN_KYOKU:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9001,基準曲データ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_kjn ('
	+ '	 e38_edi_flag'
	+ '	,e38_edi_timestamp'
	+ '	,e38_edi_id'
	+ '	,e38_edi_create_date'
	+ '	,e38_edi_update_date'
	+ '	,e38_edi_file_line_no'
	+ '	,e38_edi_meisai_no'
	+ '	,e38_edi_error_msg'
	+ '	,e38_server_webpos'
	+ '	,e38_dbname_webpos'
	+ '	,e38_shop_cd_webpos'
	+ '	,e38_shop_name_webpos'
	+ '	,e38_shop_cd_primary'
	+ '	,e38_shop_cd'
	+ '	,e38_tushin_id'

	+ '	,e38_haishin_id'
	+ '	,e38_master_date'
	+ '	,e38_syohin_key'
	+ '	,e38_now_maker_code'
	+ '	,e38_now_cd_kikaku_bango'
	+ '	,e38_goods_code'
	+ '	,e38_goods_code_kubun'
	+ '	,e38_uri_rank'
	+ '	,e38_kijun_junni'
	+ '	,e38_kijun_kubun'
	+ '	,e38_zengetu_kijun_kubun'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e38_edi_flag'
	+ '	,M.e38_edi_timestamp'
	+ '	,M.e38_edi_id'
	+ '	,M.e38_edi_create_date'
	+ '	,M.e38_edi_update_date'
	+ '	,M.e38_edi_file_line_no'
	+ '	,M.e38_edi_meisai_no'
	+ '	,M.e38_edi_error_msg'
	+ '	,M.e38_server_webpos'
	+ '	,M.e38_dbname_webpos'
	+ '	,M.e38_shop_cd_webpos'
	+ '	,M.e38_shop_name_webpos'
	+ '	,M.e38_shop_cd_primary'
	+ '	,M.e38_shop_cd'
	+ '	,M.e38_tushin_id'

	+ '	,M.e38_haishin_id'
	+ '	,M.e38_master_date'
	+ '	,M.e38_syohin_key'
	+ '	,M.e38_now_maker_code'
	+ '	,M.e38_now_cd_kikaku_bango'
	+ '	,M.e38_goods_code'
	+ '	,M.e38_goods_code_kubun'
	+ '	,M.e38_uri_rank'
	+ '	,M.e38_kijun_junni'
	+ '	,M.e38_kijun_kubun'
	+ '	,M.e38_zengetu_kijun_kubun'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_kjn as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_kjn as C'
	+ '                on M.e38_edi_id = C.e38_edi_id'
	+ '            where'
	+ '              C.e38_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e38_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e38_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e38_dbname_webpos = ''' + @db_name + ''''
	+ '            order by '
	+ '              M.e38_edi_id'  -- ID順に取り込む
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9001,基準曲データ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e38_tushin_id char (2)
  Declare @e38_haishin_id varchar(4)
  Declare @e38_master_date varchar(8) 
  Declare @e38_goods_code varchar(13) 
  Declare @e38_uri_rank char(2)
  Declare @e38_kijun_junni int 
  Declare @e38_kijun_kubun char(2)
  Declare @e38_zengetu_kijun_kubun char(2)

  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		 e38_edi_id
		,e38_shop_cd_webpos
		,e38_tushin_id
		,e38_haishin_id
		,e38_master_date
		,e38_goods_code
		,e38_uri_rank
		,e38_kijun_junni
		,e38_kijun_kubun
		,@e38_zengetu_kijun_kubun
	from
		wbe_edibook_dw_kjn
	where
		e38_edi_flag = '0'  -- 未処理
	order by
		 e38_edi_id
		,e38_edi_file_line_no
		,e38_edi_create_date

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_shop_cd
	,@a_tushin_id
	,@e38_haishin_id
	,@e38_master_date
	,@e38_goods_code
	,@e38_uri_rank
	,@e38_kijun_junni
	,@e38_kijun_kubun
	,@e38_zengetu_kijun_kubun

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin

	-- 初期値セット
	SELECT
		@a_edi_error_msg = null         -- エラーメッセージクリア
		,@a_edi_flag = '1'                    -- EDIフラグ実行済み
		,@a_goods_id = null
		,@a_jan = null
		,@a_jan_new = null

	-- JAN生成
	SELECT @a_jan = @e38_goods_code

	-----------------------------------------------
	-- 基準曲データ更新
	-- （既に登録済みの同一店舗＋JANのデータの最新フラグを0に更新）
	-- 　※集配新種別コードは条件にしない。サイクルがあるので基本最後に取り込んだ情報が最新となる為。
	-----------------------------------------------
	UPDATE wpt_kijun_kyoku_master
	SET	kkm_new_flag = '0'
	WHERE kkm_shop_cd = @a_shop_cd
	  AND kkm_jan_cd = @e38_goods_code
--	  AND kkm_haishin_cd = @e38_haishin_id

	-----------------------------------------------
	-- 基準曲データ追加
	-----------------------------------------------
	INSERT INTO wpt_kijun_kyoku_master
	(
		 kkm_shop_cd
		,kkm_haishin_cd
		,kkm_kijun_date
		,kkm_jan_cd
		,kkm_uriage_rank
		,kkm_kijun_order
		,kkm_kijun_type
		,kkm_kijun_type_before
		,kkm_new_flag
	)
	VALUES
	(
		 @a_shop_cd
		,@e38_haishin_id
		,@e38_master_date
		,@e38_goods_code
		,@e38_uri_rank
		,@e38_kijun_junni
		,@e38_kijun_kubun
		,@e38_zengetu_kijun_kubun
		,'1'
	)

    LOOP_END_KIJUN_KYOKU:  -- 更新処理終了

	-- 処理結果記録
	Set @a_getdate = getdate()
	UPDATE wbe_edibook_dw_kjn SET
		e38_edi_flag = @a_edi_flag
		,e38_edi_error_msg = @a_edi_error_msg
		,e38_edi_update_date = @a_getdate
	where
		e38_edi_id = @a_edi_id

	-- カウント初期レコードセット
	If Not Exists(SELECT top 1 *
		from #count_tbl
		where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @a_tushin_id ) Begin
			INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
			)
			SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @a_tushin_id
			,t_count_all = 0
			,t_count_ok = 0
			,t_count_wa = 0
			,t_count_ng = 0
	End

	-- 処理カウント更新
	UPDATE #count_tbl SET
		t_count_all = t_count_all + 1
		,t_count_ok = -- 正常
			Case
			when @a_edi_flag = '1' then t_count_ok + 1
			else t_count_ok
			End
		,t_count_wa = -- 警告
			Case
			when @a_edi_flag = '2' then t_count_wa + 1
			else t_count_wa
			End
		,t_count_ng = -- エラー
			Case
			when @a_edi_flag = '3' then t_count_ng + 1
			else t_count_ng
			End
	where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @a_tushin_id

    -- 次へ
    fetch next from @rs into
	 @a_edi_id
	,@a_shop_cd
	,@a_tushin_id
	,@e38_haishin_id
	,@e38_master_date
	,@e38_goods_code
	,@e38_uri_rank
	,@e38_kijun_junni
	,@e38_kijun_kubun
	,@e38_zengetu_kijun_kubun
  End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9002,基準曲データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9003,基準曲データログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

DOWN_KIJUN_KYOKU_END:

--=================================================
-- 【JMD対応】			-- 2013/12/04 add MS103 Start
--=================================================
DOWN_JMD:

  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9001,基準曲データ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e39_sales_cd varchar(10) 
  Declare @e39_edi_id bigint
  Declare @e39_sales_name varchar(100)
  Declare @e39_label_cd varchar(20)
  Declare @e39_label_name varchar(100)
  Declare @e39_development_kubun char(1)
  Declare @e39_titleavcg_name_kana varchar(100)
  Declare @e39_cost_price money
  Declare @e39_release_date varchar(8)
  Declare @e39_haiban_date varchar(8)
  Declare @e39_genre2_cd varchar(10)
  Declare @e39_display_no varchar(20)
  Declare @e39_artist_name1 varchar(100)
  Declare @e39_artist_name_kana1 varchar(100)
  Declare @e39_tushin_id char(2)
  Declare @e39_media_keitai_cd varchar(3)
  Declare @v_jan_cd varchar(13)
  Declare @v_disk_sales_cd varchar(20)
      
  Set @a_getdate = getdate()
  Set @a_goods_type = '30'
  Set @a_tax_type = '0'
  Set @a_price_type = '0'
  
  Set @a_sql = ''
				+ ' INSERT wbe_edibook_dw_jmd ('
				+ '		 e39_edi_flag '				
				+ '		,e39_edi_id '
				+ '		,e39_edi_create_date '
				+ '		,e39_edi_update_date '
				+ '		,e39_edi_file_line_no '
				+ '		,e39_edi_meisai_no '
				+ '		,e39_edi_error_msg '
				+ '		,e39_server_webpos '
				+ '		,e39_dbname_webpos '
				+ '		,e39_shop_cd_webpos '
				+ '		,e39_shop_name_webpos '
				+ '		,e39_seq_no '
				+ '		,e39_jan '
				+ '		,e39_keyjan_ho1 '
				+ '		,e39_keyjan_ho2 '
				+ '		,e39_sales_cd '
				+ '		,e39_goods_conf_kubun '
				+ '		,e39_goods_conf_pakage '
				+ '		,e39_goods_conf_media '
				+ '		,e39_goods_conf_title '
				+ '		,e39_label_cd '
				+ '		,e39_hinmoku_no '
				+ '		,e39_titleavcg_kubun '
				+ '		,e39_titleavcg_name '
				+ '		,e39_titleavcg_name_short '
				+ '		,e39_titleavcg_name_kana '
				+ '		,e39_titleavcg_name_alphabet '
				+ '		,e39_artist_name1 '
				+ '		,e39_artist_name_kana1 '
				+ '		,e39_srtist_name_alphabet1 '
				+ '		,e39_artist_name2 '
				+ '		,e39_artist_name_kana2 '
				+ '		,e39_srtist_name_alphabet2 '
				+ '		,e39_artist_name3 '
				+ '		,e39_artist_name_kana3 '
				+ '		,e39_srtist_name_alphabet3 '
				+ '		,e39_artist_name4 '
				+ '		,e39_artist_name_kana4 '
				+ '		,e39_srtist_name_alphabet4 '
				+ '		,e39_artist_name5 '
				+ '		,e39_artist_name_kana5 '
				+ '		,e39_srtist_name_alphabet5 '
				+ '		,e39_artist_name6 '
				+ '		,e39_artist_name_kana6 '
				+ '		,e39_srtist_name_alphabet6 '
				+ '		,e39_artist_name7 '
				+ '		,e39_artist_name_kana7 '
				+ '		,e39_srtist_name_alphabet7 '
				+ '		,e39_artist_name8 '
				+ '		,e39_artist_name_kana8 '
				+ '		,e39_srtist_name_alphabet8 '
				+ '		,e39_maxisingle_kubun '
				+ '		,e39_genre1_cd '
				+ '		,e39_genre2_cd '
				+ '		,e39_display_no '
				+ '		,e39_set_num '
				+ '		,e39_all_exposure_time '
				+ '		,e39_all_work_num '
				+ '		,e39_promotion '
				+ '		,e39_open_price '
				+ '		,e39_market_cd '
				+ '		,e39_distribution_cd '
				+ '		,e39_price_without_tax '
				+ '		,e39_price_including_tax '
				+ '		,e39_price_yobi1 '
				+ '		,e39_price_yobi2 '
				+ '		,e39_cost_price '
				+ '		,e39_disclosure_date '
				+ '		,e39_disclosure_time '
				+ '		,e39_rental_kubun_A '
				+ '		,e39_rental_kubun_V '
				+ '		,e39_open_date '
				+ '		,e39_jan2 '
				+ '		,e39_goods_no_move '
				+ '		,e39_goods_grouping1 '
				+ '		,e39_goods_grouping2 '
				+ '		,e39_goods_grouping3 '
				+ '		,e39_goods_grouping4 '
				+ '		,e39_development_kubun '
				+ '		,e39_release_date '
				+ '		,e39_haiban_date '
				+ '		,e39_media_keitai_cd '
				+ '		,e39_exposure_time '
				+ '		,e39_work_num '
				+ '		,e39_sales_name '
				+ '		,e39_sales_name_kana '
				+ '		,e39_label_name '
				+ '		,e39_label_name_kana '
				+ '		,e39_keitai_name '
				+ '		,e39_keitai_name_kana '
				+ '		,e39_genre1_name '
				+ '		,e39_genre1_name_kana '
				+ '		,e39_genre2_name '
				+ '		,e39_genre2_name_kana '
				+ '		,e39_jacket_folder '
				+ '		,e39_jacket_name '
				+ '		,e39_link_cd '
				+ '		,e39_pc_jacke_fg '
				+ '		,e39_pc_audition_fg '
				+ '		,e39_viewer_fg '
				+ '		,e39_keitai_jacke_fg '
				+ '		,e39_keitai_audition_fg '
				+ '		,e39_yobi '
				+ '		,e39_shop_jacke_fg '
				+ '		,e39_shop_auditon_fg '
				+ '		,e39_copyright '
				+ '		,e39_dummy1 '
				+ '		,e39_dummy2 '
				+ '		,e39_dummy3 '
				+ '		,e39_dummy4 '
				+ '		,e39_dummy5 '
				+ '		,e39_dummy6 '
				+ '		,e39_dummy7 '
				+ '		,e39_dummy8 '
				+ '		,e39_dummy9 '
				+ '		,e39_dummy10 '
				+ '		,e39_dummy11 '
				+ '		,e39_dummy12 '
				+ '		,e39_dummy13 '
				+ '		,e39_dummy14 '
				+ '		,e39_dummy15 '
				+ '		,e39_goods_change '
				+ '		,e39_update_date '
				+ '		,e39_shop_cd_primary '
				+ '		,e39_shop_cd '
				+ '		,e39_tushin_id '
				+ '	) '
				+ '	SELECT ' 
				+ '		 M.e39_edi_flag '
				+ '		,M.e39_edi_id '
				+ '		,M.e39_edi_create_date '
				+ '		,M.e39_edi_update_date '
				+ '		,M.e39_edi_file_line_no '
				+ '		,M.e39_edi_meisai_no '
				+ '		,M.e39_edi_error_msg '
				+ '		,M.e39_server_webpos '
				+ '		,M.e39_dbname_webpos '
				+ '		,M.e39_shop_cd_webpos '
				+ '		,M.e39_shop_name_webpos '
				+ '		,M.e39_seq_no '
				+ '		,M.e39_jan '
				+ '		,M.e39_keyjan_ho1 '
				+ '		,M.e39_keyjan_ho2 '
				+ '		,M.e39_sales_cd '
				+ '		,M.e39_goods_conf_kubun '
				+ '		,M.e39_goods_conf_pakage '
				+ '		,M.e39_goods_conf_media '
				+ '		,M.e39_goods_conf_title '
				+ '		,M.e39_label_cd '
				+ '		,M.e39_hinmoku_no '
				+ '		,M.e39_titleavcg_kubun '
				+ '		,M.e39_titleavcg_name '
				+ '		,M.e39_titleavcg_name_short '
				+ '		,M.e39_titleavcg_name_kana '
				+ '		,M.e39_titleavcg_name_alphabet '
				+ '		,M.e39_artist_name1 '
				+ '		,M.e39_artist_name_kana1 '
				+ '		,M.e39_srtist_name_alphabet1 '
				+ '		,M.e39_artist_name2 '
				+ '		,M.e39_artist_name_kana2 '
				+ '		,M.e39_srtist_name_alphabet2 '
				+ '		,M.e39_artist_name3 '
				+ '		,M.e39_artist_name_kana3 '
				+ '		,M.e39_srtist_name_alphabet3 '
				+ '		,M.e39_artist_name4 '
				+ '		,M.e39_artist_name_kana4 '
				+ '		,M.e39_srtist_name_alphabet4 '
				+ '		,M.e39_artist_name5 '
				+ '		,M.e39_artist_name_kana5 '
				+ '		,M.e39_srtist_name_alphabet5 '
				+ '		,M.e39_artist_name6 '
				+ '		,M.e39_artist_name_kana6 '
				+ '		,M.e39_srtist_name_alphabet6 '
				+ '		,M.e39_artist_name7 '
				+ '		,M.e39_artist_name_kana7 '
				+ '		,M.e39_srtist_name_alphabet7 '
				+ '		,M.e39_artist_name8 '
				+ '		,M.e39_artist_name_kana8 '
				+ '		,M.e39_srtist_name_alphabet8 '
				+ '		,M.e39_maxisingle_kubun '
				+ '		,M.e39_genre1_cd '
				+ '		,M.e39_genre2_cd '
				+ '		,M.e39_display_no '
				+ '		,M.e39_set_num '
				+ '		,M.e39_all_exposure_time '
				+ '		,M.e39_all_work_num '
				+ '		,M.e39_promotion '
				+ '		,M.e39_open_price '
				+ '		,M.e39_market_cd '
				+ '		,M.e39_distribution_cd '
				+ '		,M.e39_price_without_tax '
				+ '		,M.e39_price_including_tax '
				+ '		,M.e39_price_yobi1 '
				+ '		,M.e39_price_yobi2 '
				+ '		,M.e39_cost_price '
				+ '		,M.e39_disclosure_date '
				+ '		,M.e39_disclosure_time '
				+ '		,M.e39_rental_kubun_A '
				+ '		,M.e39_rental_kubun_V '
				+ '		,M.e39_open_date '
				+ '		,M.e39_jan2 '
				+ '		,M.e39_goods_no_move '
				+ '		,M.e39_goods_grouping1 '
				+ '		,M.e39_goods_grouping2 '
				+ '		,M.e39_goods_grouping3 '
				+ '		,M.e39_goods_grouping4 '
				+ '		,M.e39_development_kubun '
				+ '		,M.e39_release_date '
				+ '		,M.e39_haiban_date '
				+ '		,M.e39_media_keitai_cd '
				+ '		,M.e39_exposure_time '
				+ '		,M.e39_work_num '
				+ '		,M.e39_sales_name '
				+ '		,M.e39_sales_name_kana '
				+ '		,M.e39_label_name '
				+ '		,M.e39_label_name_kana '
				+ '		,M.e39_keitai_name '
				+ '		,M.e39_keitai_name_kana '
				+ '		,M.e39_genre1_name '
				+ '		,M.e39_genre1_name_kana '
				+ '		,M.e39_genre2_name '
				+ '		,M.e39_genre2_name_kana '
				+ '		,M.e39_jacket_folder '
				+ '		,M.e39_jacket_name '
				+ '		,M.e39_link_cd '
				+ '		,M.e39_pc_jacke_fg '
				+ '		,M.e39_pc_audition_fg '
				+ '		,M.e39_viewer_fg '
				+ '		,M.e39_keitai_jacke_fg '
				+ '		,M.e39_keitai_audition_fg '
				+ '		,M.e39_yobi '
				+ '		,M.e39_shop_jacke_fg '
				+ '		,M.e39_shop_auditon_fg '
				+ '		,M.e39_copyright '
				+ '		,M.e39_dummy1 '
				+ '		,M.e39_dummy2 '
				+ '		,M.e39_dummy3 '
				+ '		,M.e39_dummy4 '
				+ '		,M.e39_dummy5 '
				+ '		,M.e39_dummy6 '
				+ '		,M.e39_dummy7 '
				+ '		,M.e39_dummy8 '
				+ '		,M.e39_dummy9 '
				+ '		,M.e39_dummy10 '
				+ '		,M.e39_dummy11 '
				+ '		,M.e39_dummy12 '
				+ '		,M.e39_dummy13 '
				+ '		,M.e39_dummy14 '
				+ '		,M.e39_dummy15 '
				+ '		,M.e39_goods_change '
				+ '		,M.e39_update_date '
				+ '		,M.e39_shop_cd_primary '
				+ '		,M.e39_shop_cd '
				+ '		,M.e39_tushin_id '
				+ '	FROM '
				+ ' ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_jmd as M '
				+ '		left outer join '
				+ '     wbe_edibook_dw_jmd as C'
				+ '		    on M.e39_edi_id = C.e39_edi_id'
				+ ' WHERE '
				+ '		C.e39_edi_id is null'  -- コピーしてないもののみ
				+ '     AND '
				+ '     M.e39_edi_flag = ''0'''  -- 未処理
				+ '     AND '
				+ '     M.e39_server_webpos = ''' + @server_name + ''''
				+ '     AND '
				+ '     M.e39_dbname_webpos = ''' + @db_name + ''''
				+ ' ORDER BY '
				+ '     M.e39_edi_id'  -- ID順に取り込む'		
  Exec(@a_sql)				
  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		  e39_edi_id 
		 ,e39_shop_cd_webpos
		 ,e39_sales_cd
		 ,ISNULL(e39_sales_name, '') As e39_sale_name
		 ,e39_label_cd
		 ,ISNULL(e39_label_name, '') As e39_label_name
		 ,e39_development_kubun
		 ,e39_jan 
		 ,ISNULL(e39_titleavcg_name_short, '') As e39_titleavcg_name_short
		 ,ISNULL(e39_titleavcg_name_kana , '') As e39_titleavcg_name_kana
		 ,ISNULL(e39_price_without_tax, 0) As e39_price_without_tax
		 ,ISNULL(e39_cost_price, 0) As e39_cost_price
		 ,e39_release_date
		 ,e39_haiban_date
		 ,e39_genre2_cd
		 ,e39_display_no
		 ,ISNULL(e39_artist_name1, '') As e39_artist_name1
		 ,ISNULL(e39_artist_name_kana1, '') As e39_artist_name_kana1
		 ,e39_tushin_id
		 ,e39_media_keitai_cd
	FROM
		wbe_edibook_dw_jmd
	WHERE
		e39_edi_flag = '0'
	ORDER BY
		e39_edi_id
  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @a_edi_id
	,@a_shop_cd
	,@e39_sales_cd
	,@e39_sales_name
	,@e39_label_cd
	,@e39_label_name
	,@e39_development_kubun
	,@a_jan
	,@a_goods_name
	,@e39_titleavcg_name_kana
	,@a_price
	,@e39_cost_price
	,@e39_release_date
	,@e39_haiban_date
	,@e39_genre2_cd
	,@e39_display_no
	,@e39_artist_name1
	,@e39_artist_name_kana1
	,@e39_tushin_id
	,@e39_media_keitai_cd
	
    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
    Declare @release_date datetime
    Declare @haiban_date datetime
    If @e39_release_date = '99999999' OR @e39_release_date is null
		Begin
			Set @release_date = convert(datetime, '29991231', 121)
		End
	Else
		Begin
			Set @e39_release_date = @e39_release_date + '00:00:00.000'
			Set @release_date = convert(datetime, @e39_release_date, 121)
		End	

    If @e39_haiban_date  = '00000000'  or @e39_haiban_date Is null
		Begin
			Set @haiban_date = null
		End
	ELSE if  @e39_haiban_date  = '99999999' 
		Begin
			Set @haiban_date = convert(datetime, '19000101', 121)
		End		
	Else
		Begin
			Set @e39_haiban_date = @e39_haiban_date + '00:00:00.000'
			Set @haiban_date = convert(datetime, @e39_haiban_date, 121)
		End	
		
    Set @e39_development_kubun = isnull(@e39_development_kubun,'')
    If @e39_sales_cd is not null
		Begin
			If Not Exists(SELECT top 1 *
				from wpt_maker_sales_master
				where msm_sales_cd = @e39_sales_cd)
				Begin
					-----------------------------------------------
					-- メーカー販売元マスタ追加
					-----------------------------------------------
					INSERT INTO wpt_maker_sales_master
					(
					   msm_sales_cd
					  ,msm_create_date
					  ,msm_update_date
					  ,msm_update_memo
					  ,msm_sales_name
					)
					VALUES
					(
					   @e39_sales_cd
					  ,@a_getdate
					  ,@a_getdate
					  ,object_name(@@PROCID) + '[jmd]' + '[' + isnull(@e39_tushin_id,'') +  ']'
					  ,@e39_sales_name
					)
				
				END
			Else
				Begin
					UPDATE wpt_maker_sales_master
					SET msm_update_date = @a_getdate,
						msm_sales_name = @e39_sales_name,
						msm_update_memo = object_name(@@PROCID) + '[jmd]' + '[' + isnull(@e39_tushin_id,'') +  ']'
					WHERE msm_sales_cd = @e39_sales_cd
				End
		End
	-----------------------------------------------
	-- メーカーレーベルマスタ追加
	-----------------------------------------------
	If @e39_label_cd is not null
		Begin
			If Not Exists(SELECT top 1 *
				from wpt_maker_label_master
				where mlm_label_cd = @e39_label_cd)
				Begin
					INSERT INTO wpt_maker_label_master
					(
					   mlm_label_cd
					  ,mlm_create_date
					  ,mlm_update_date
					  ,mlm_update_memo
					  ,mlm_label_name
					  ,mlm_sales_cd
					)
					VALUES
					(
					   @e39_label_cd
					  ,@a_getdate
					  ,@a_getdate
					  ,object_name(@@PROCID) + '[jmd]' + '[' + isnull(@e39_tushin_id,'') +  ']'
					  ,@e39_label_name
					  ,@e39_sales_cd
					)
				End
			Else
				Begin
					
					If (@e39_development_kubun <> 'H') AND (Not Exists(SELECT top 1 *
						from wpt_maker_label_master
						where mlm_sales_cd = @e39_sales_cd 
								AND mlm_label_cd = @e39_label_cd))
					Begin
						UPDATE wpt_maker_label_master SET
							 mlm_update_date = @a_getdate
							,mlm_update_memo = object_name(@@PROCID) + '[jmd]' + '[' + isnull(@e39_tushin_id,'') +  ']'
							,mlm_label_name = @e39_label_name
							,mlm_sales_cd = @e39_sales_cd
						where
							mlm_label_cd = @e39_label_cd
					End
				End
		End
	-----------------------------------------------
	-- 商品マスタ追加
	-----------------------------------------------
	--If Not Exists(SELECT top 1 *
	--	from wpv_goods_master_jmd
	--	where v_jan_cd = @a_jan)
		SELECT top 1 @v_jan_cd=v_jan_cd
		            ,@v_disk_sales_cd=v_disk_sales_cd
		from wpv_goods_master_jmd
		where v_jan_cd = @a_jan

	if @v_jan_cd is null
	Begin
	  -- 新規作成
	  Exec @rc = P_Goods_Create 
		   @goods_type   = @a_goods_type
		  ,@plu_cd       = @a_jan
		  ,@plu_type     = '0'
		  ,@goods_name   = @a_goods_name
		  ,@tax_type     = @a_tax_type
		  ,@price        = @a_price
		  ,@price_type   = @a_price_type
		  ,@sp           = '1'  -- SP起動
		  ,@goods_id     = @a_goods_id OUTPUT
	   -- エラーチェック
	   If @rc <> 0 or @a_goods_id is null Begin
		  -- エラー記録
		  SELECT
			 @a_edi_error_msg = '商品マスタ生成エラー'
				+ ' 商品コード=[' + isnull(@a_jan,'') + ']'
				+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
				+ ',商品ＩＤ=[' + cast(isnull(@a_goods_id,'') AS varchar(20)) + ']'
                + ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
			,@a_edi_flag = '3'  -- エラー
		  -- ループ終了まで飛ばす
		  GOTO LOOP_END_JMD
	   End
	   
	   --更新 wpt_goods_master, wpt_goods_master_disk
	   UPDATE wpt_goods_master SET
	   
					gds_create_date							= @a_getdate
				  ,gds_update_date							= @a_getdate
				  ,gds_update_memo							= object_name(@@PROCID) + '[jmd]' + '[' + isnull(@e39_tushin_id,'') +  ']'
--				  ,gds_goods_type							= '30'
--				  ,gds_jan_cd								= @a_jan
--				  ,gds_koyu_goods_cd						= null
				  ,gds_goods_name							= @a_goods_name
				  ,gds_goods_ryaku							= @a_goods_name
				  ,gds_goods_kana							= @e39_titleavcg_name_kana
				  ,gds_goods_kana2							= @e39_titleavcg_name_kana
--				  ,gds_tax_type								= '0'
--				  ,gds_price								= @a_price
--				  ,gds_price_type							= '0'
				  ,gds_cost_price							= @e39_cost_price
				  ,gds_new_reference_price					= 0
				  ,gds_new_reference_price_type				= 0
				  ,gds_new_reference_cost_price				= 0
				  ,gds_used_reference_price					= 0
				  ,gds_used_reference_price_type			= 0
				  ,gds_used_reference_purchase_price		= 0
				  ,gds_used_reference_purchase_price_type	= 0
				  ,gds_used_reference_cost_price			= 0
				  ,gds_sales_date							= @release_date
				  ,gds_text_sales_date						= null
				  ,gds_stock_control_type					= '1'
				  ,gds_stock_control_goods_id				= null
				  ,gds_set_type	  							= '0'
--				  ,gds_media_id	  							= isnull(dbo.F_Search_JMD_Media(@e39_genre2_cd),'21990')
				  ,gds_media_id	  							= dbo.F_Search_JMD_Media(@e39_genre2_cd + @e39_media_keitai_cd)
				  ,gds_genre_cd	  							= null
--				  ,gds_product_stop_flag					=	Case
--																when @e39_development_kubun = 'H' then '1'
--																else @e39_development_kubun
--																End
				  ,gds_product_stop_flag					=	Case
				     											when @e39_development_kubun = 'H' then '1'
																else '0'
																End

				  ,gds_product_stop_date					= @haiban_date
				  ,gds_purchase_stop_flag					= '0'
				  ,gds_purchase_stop_date					= null
				  ,gds_hachu_stop_flag						= '0'
				  ,gds_gross_flag							= '0'
				  ,gds_delete_flag							= '0'
				  ,gds_auto_hachu_flag						= '0'
				  ,gds_tana_media_update_flag				= '0'
				  ,gds_sales_update_flag					= '0'
				  ,gds_bookedi_cd							= 'JM'
				  ,gds_teiki_create_date					= null
		WHERE
			gds_goods_id = @a_goods_id
			
		UPDATE wpt_goods_master_disk 
				SET
				   gdd_standard_number		= @e39_display_no
				  ,gdd_maker_name			= null
				  ,gdd_lifecycle_type 		= Case @e39_development_kubun
												when 'H' then '9'
												else '1'
												End
				  ,gdd_artist_cd			= null
				  ,gdd_artist_name			= @e39_artist_name1
				  ,gdd_artist_kana			= @e39_artist_name_kana1
				  ,gdd_label_cd				= @e39_label_cd
				  ,gdd_rank					= null
		          ,gdd_cd_genre_cd = @e39_genre2_cd + @e39_media_keitai_cd
				  --,gdd_cd_genre_cd			= @e39_genre2_cd
				  ,gdd_cd_hinshu_cd 		= null
				  ,gdd_distribution_type	= '0'
				  ,gdd_important_type		= '0'
				  ,gdd_base_type			= '0'
				  ,gdd_regular_type			= '0'
				  --,gdd_b_genre				= '0'
				  --,gdd_m_genre				= '0'
				  --,gdd_s_genre				= '0'
		WHERE
			gdd_goods_id = @a_goods_id
		End
	Else
		Begin
		  ---- 更新
		  --Exec @rc = P_Goods_Create 
			 --  @goods_type   = @a_goods_type
			 -- ,@plu_cd       = @a_jan
			 -- ,@plu_type     = '0'
			 -- ,@goods_name   = @a_goods_name
			 -- ,@tax_type     = @a_tax_type
			 -- ,@price        = @a_price
			 -- ,@price_type   = @a_price_type
			 -- ,@sp           = '1'  -- SP起動
			 -- ,@goods_id     = @a_goods_id OUTPUT
		  -- -- エラーチェック
		  -- If @rc <> 0 or @a_goods_id is null Begin
			 -- -- エラー記録
			 -- SELECT
				-- @a_edi_error_msg = '商品マスタ生成エラー'
				--	+ ' 商品コード=[' + isnull(@a_jan,'') + ']'
				--	+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
				--	+ ',商品ＩＤ=[' + isnull(@a_goods_id,'') + ']'
				--	+ ',エラーコード=[' + isnull(@rc,'') + ']'
				--,@a_edi_flag = '3'  -- エラー
			 -- -- ループ終了まで飛ばす
			 -- GOTO LOOP_END_JMD
		  -- End
		   
		   
			--If (Exists(SELECT TOP 1 * 
			--		FROM wpt_goods_master 
			--			INNER JOIN wpt_goods_master_disk ON
			--				gds_goods_id = gdd_goods_id
			--			INNER JOIN wpt_maker_label_master ON
			--				gdd_label_cd = mlm_label_cd 
			--		WHERE
			--			gds_goods_id = @a_goods_id AND
			--			mlm_sales_cd = @e39_sales_cd))

			if @v_disk_sales_cd = @e39_sales_cd
			--販売元コード一致
				Begin
				  --更新
				  Exec @rc = P_Goods_Create 
					   @goods_type   = @a_goods_type
					  ,@plu_cd       = @a_jan
					  ,@plu_type     = '0'
					  ,@goods_name   = @a_goods_name
					  ,@tax_type     = @a_tax_type
					  ,@price        = @a_price
					  ,@price_type   = @a_price_type
					  ,@sp           = '1'  -- SP起動
					  ,@goods_id     = @a_goods_id OUTPUT
				   -- エラーチェック
				   If @rc <> 0 or @a_goods_id is null Begin
					  -- エラー記録
					  SELECT
						 @a_edi_error_msg = '商品マスタ生成エラー'
							+ ' 商品コード=[' + isnull(@a_jan,'') + ']'
							+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
							+ ',商品ＩＤ=[' + cast(isnull(@a_goods_id,'') AS varchar(20)) + ']'
							+ ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
						,@a_edi_flag = '3'  -- エラー
					  -- ループ終了まで飛ばす
					  GOTO LOOP_END_JMD
				   End				   
				   --商品マスタ
				   UPDATE wpt_goods_master SET
--					   gds_goods_type = '30'
				      gds_update_memo							= object_name(@@PROCID) + '[jmd]' + '[' + isnull(@e39_tushin_id,'') +  ']'
					  ,gds_goods_name = @a_goods_name
					  ,gds_goods_ryaku = @a_goods_name
					  ,gds_goods_kana = @e39_titleavcg_name_kana
					  ,gds_goods_kana2 = @e39_titleavcg_name_kana
--					  ,gds_price = @a_price
					  ,gds_cost_price = @e39_cost_price
					  ,gds_sales_date = @release_date
					  --,gds_media_id = isnull(dbo.F_Search_JMD_Media(@e39_genre2_cd),'21990')
				      ,gds_media_id = dbo.F_Search_JMD_Media(@e39_genre2_cd + @e39_media_keitai_cd)
					  --,gds_product_stop_flag = Case when @e39_development_kubun = 'H' then '1' else @e39_development_kubun End
					  ,gds_product_stop_flag = Case when @e39_development_kubun = 'H' then '1' else '0' End
					  ,gds_product_stop_date = @haiban_date
					  ,gds_bookedi_cd = 'JM'
					WHERE
						gds_goods_id = @a_goods_id
							
					-- 商品マスタDISK追加
					UPDATE wpt_goods_master_disk 
					SET
					   gdd_standard_number = @e39_display_no
					  ,gdd_lifecycle_type = Case @e39_development_kubun
											when '0' then '1'
											when '1' then '1'
											when '2' then '8'
											when '3' then '8'
											when '4' then '7'
											when 'H' then '9'
											else '1'
											End
					  ,gdd_artist_name = @e39_artist_name1
					  ,gdd_artist_kana = @e39_artist_name_kana1
					  ,gdd_label_cd = @e39_label_cd
				      ,gdd_cd_genre_cd = @e39_genre2_cd + @e39_media_keitai_cd
					WHERE
						gdd_goods_id = @a_goods_id
				End
			Else
				Begin
					If ( @e39_development_kubun <> 'H')
					Begin
					  --更新
					  Exec @rc = P_Goods_Create 
						   @goods_type   = @a_goods_type
						  ,@plu_cd       = @a_jan
						  ,@plu_type     = '0'
						  ,@goods_name   = @a_goods_name
						  ,@tax_type     = @a_tax_type
						  ,@price        = @a_price
						  ,@price_type   = @a_price_type
						  ,@sp           = '1'  -- SP起動
						  ,@goods_id     = @a_goods_id OUTPUT
					   -- エラーチェック
					   If @rc <> 0 or @a_goods_id is null Begin
						  -- エラー記録
						  SELECT
							 @a_edi_error_msg = '商品マスタ生成エラー'
								+ ' 商品コード=[' + isnull(@a_jan,'') + ']'
								+ ',商品区分=[' + isnull(@a_goods_code_kubun,'') + ']'
								+ ',商品ＩＤ=[' + cast(isnull(@a_goods_id,'') AS varchar(20)) + ']'
								+ ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
							,@a_edi_flag = '3'  -- エラー
						  -- ループ終了まで飛ばす
						  GOTO LOOP_END_JMD
					   End				   
					  -- 商品マスタ
					   UPDATE wpt_goods_master SET
--						   gds_goods_type = '30'
				           gds_update_memo							= object_name(@@PROCID) + '[jmd]' + '[' + isnull(@e39_tushin_id,'') +  ']'
						  ,gds_goods_name = @a_goods_name
						  ,gds_goods_ryaku = @a_goods_name
						  ,gds_goods_kana = @e39_titleavcg_name_kana
						  ,gds_goods_kana2 = @e39_titleavcg_name_kana
--						  ,gds_price = @a_price
						  ,gds_cost_price = @e39_cost_price
						  ,gds_sales_date = @release_date
						  --,gds_media_id = isnull(dbo.F_Search_JMD_Media(@e39_genre2_cd),'21990')
				          ,gds_media_id = dbo.F_Search_JMD_Media(@e39_genre2_cd + @e39_media_keitai_cd)
						  --,gds_product_stop_flag = Case when @e39_development_kubun = 'H' then '1' else @e39_development_kubun End
					      ,gds_product_stop_flag = Case when @e39_development_kubun = 'H' then '1' else '0' End
						  ,gds_product_stop_date = @haiban_date
						  ,gds_bookedi_cd = 'JM'
						WHERE
							gds_goods_id = @a_goods_id
							
						-- 商品マスタDISK追加
						UPDATE wpt_goods_master_disk 
						SET
						   gdd_standard_number = @e39_display_no
						  ,gdd_lifecycle_type = Case @e39_development_kubun
												when '0' then '1'
												when '1' then '1'
												when '2' then '8'
												when '3' then '8'
												when '4' then '7'
												when 'H' then '9'
												else '1'
												End
						  ,gdd_artist_name = @e39_artist_name1
						  ,gdd_artist_kana = @e39_artist_name_kana1
						  ,gdd_label_cd = @e39_label_cd
				          ,gdd_cd_genre_cd = @e39_genre2_cd + @e39_media_keitai_cd
						WHERE
							gdd_goods_id = @a_goods_id
					End
				End
			End
	
	-- ループ終了ラベル
    LOOP_END_JMD:
    
	Set @a_getdate = getdate()
	Set @a_edi_error_msg = null         -- エラーメッセージクリア
	Set @a_edi_flag = '1'
	UPDATE wbe_edibook_dw_jmd SET
		e39_edi_flag = @a_edi_flag
		,e39_edi_update_date = @a_getdate
		,e39_edi_error_msg = @a_edi_error_msg
	where
		e39_edi_id = @a_edi_id
			
	If Not Exists(SELECT top 1 *
		from #count_tbl
		where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @e39_tushin_id ) Begin
			--Select 'Insert'
			INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
			)
			SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @e39_tushin_id
			,t_count_all = 0
			,t_count_ok = 0
			,t_count_wa = 0
			,t_count_ng = 0
		End	


	--select 'update'
	UPDATE #count_tbl SET
		t_count_all = t_count_all + 1
		,t_count_ok = -- 正常
			Case
			when @a_edi_flag = '1' then t_count_ok + 1
			else t_count_ok
			End
		,t_count_wa = -- 警告
			Case
			when @a_edi_flag = '2' then t_count_wa + 1
			else t_count_wa
			End
		,t_count_ng = -- エラー
			Case
			when @a_edi_flag = '3' then t_count_ng + 1
			else t_count_ng
			End
	where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @e39_tushin_id
    -- 次へ
    fetch next from @rs into
	 @a_edi_id
	,@a_shop_cd
	,@e39_sales_cd
	,@e39_sales_name
	,@e39_label_cd
	,@e39_label_name
	,@e39_development_kubun
	,@a_jan
	,@a_goods_name
	,@e39_titleavcg_name_kana
	,@a_price
	,@e39_cost_price
	,@e39_release_date
	,@e39_haiban_date
	,@e39_genre2_cd
	,@e39_display_no
	,@e39_artist_name1
	,@e39_artist_name_kana1
	,@e39_tushin_id
	,@e39_media_keitai_cd
  End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9002,基準曲データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9003,基準曲データログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

DOWN_JMD_END:
--2013/12/04 MS103 End

--=================================================
-- 【東京エコール】下り商品定価改正データ		-- 2013/12/20 add
--=================================================
DOWN_GOODS_TEIKA_KAISEI:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9160,商品定価改正データ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_ekk ('
	+ '	 e45_edi_flag'
	+ '	,e45_edi_id'
	+ '	,e45_edi_create_date'
	+ '	,e45_edi_update_date'
	+ '	,e45_edi_file_line_no'
	+ '	,e45_edi_meisai_no'
	+ '	,e45_edi_error_msg'
	+ '	,e45_server_webpos'
	+ '	,e45_dbname_webpos'
	+ '	,e45_shop_cd_webpos'
	+ '	,e45_shop_name_webpos'
	+ '	,e45_seq_no'
	+ '	,e45_sakusei_date'
	+ '	,e45_shop_cd_primary'
	+ '	,e45_shop_cd'
	+ '	,e45_tushin_id'
	+ '	,e45_ecl_hinban'
	+ '	,e45_jan_cd'
	+ '	,e45_tekiyou_date'
	+ '	,e45_teika '
	+ '	,e45_filler'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e45_edi_flag'
	+ '	,M.e45_edi_id'
	+ '	,M.e45_edi_create_date'
	+ '	,M.e45_edi_update_date'
	+ '	,M.e45_edi_file_line_no'
	+ '	,M.e45_edi_meisai_no'
	+ '	,M.e45_edi_error_msg'
	+ '	,M.e45_server_webpos'
	+ '	,M.e45_dbname_webpos'
	+ '	,M.e45_shop_cd_webpos'
	+ '	,M.e45_shop_name_webpos'
	+ '	,M.e45_seq_no'
	+ '	,M.e45_sakusei_date'
	+ '	,M.e45_shop_cd_primary'
	+ '	,M.e45_shop_cd'
	+ '	,M.e45_tushin_id'
	+ '	,M.e45_ecl_hinban'
	+ '	,M.e45_jan_cd'
	+ '	,M.e45_tekiyou_date'
	+ '	,M.e45_teika '
	+ '	,M.e45_filler'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_ekk as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_ekk as C'
	+ '                on M.e45_edi_id = C.e45_edi_id'
	+ '            where'
	+ '              C.e45_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e45_edi_flag = ''0'''  -- 未処理
	+ '				 AND '
	+ '			     M.e45_server_webpos = ''' + @server_name + ''''	--2016/08/18 add
	+ '				 AND '
	+ '				 M.e45_dbname_webpos = ''' + @db_name + ''''		--2016/08/18 add
	+ '            order by '
	+ '              M.e45_edi_id'  -- ID順に取り込む
  Exec (@a_sql)


  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9161,商品定価改正データ取得エラー'
    GOTO SP_ERR
  End




  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e45_edi_id bigint
  Declare @e45_sakusei_date varchar(8)
  Declare @e45_ecl_hinban varchar(20)
  Declare @e45_jan_cd varchar(13) 
  Declare @e45_tekiyou_date char(8) 
  Declare @e45_teika int
  Declare @e45_tushin_id char(2)

  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		 e45_edi_id
		,e45_sakusei_date
		,e45_ecl_hinban
		,e45_jan_cd
		,e45_tekiyou_date
		,e45_teika
		,e45_tushin_id
	from
		wbe_edibook_dw_ekk
	order by
		 e45_edi_id

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @e45_edi_id
	,@e45_sakusei_date
	,@e45_ecl_hinban
	,@e45_jan_cd
	,@e45_tekiyou_date
	,@e45_teika
	,@e45_tushin_id

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
	-----------------------------------------------
	-- 基準曲データ追加
	-----------------------------------------------
	INSERT INTO wpt_goods_teika_kaisei
	(
		 gtk_create_date
		,gtk_update_date
		,gtk_hassei_date
		,gtk_ecl_hinban
		,gtk_jan_cd
		,gtk_kaisei_date
		,gtk_kaisei_kakaku
		,gtk_tekiyou_date
		,gtk_kaisei_old_kakaku
	)
	VALUES
	(
		 getdate()
		,getdate()
		,@e45_sakusei_date
		,@e45_ecl_hinban
		,@e45_jan_cd
		,@e45_tekiyou_date
		,@e45_teika
		,NULL
		,'0'
	)
	SET @a_edi_flag = '1'
	Set @a_getdate = getdate()		---2016/08/18 add 

	-- カウント初期レコードセット
	If Not Exists(SELECT top 1 *
		from #count_tbl
		where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @e45_tushin_id ) Begin
			INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
			)
			SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @e45_tushin_id
			,t_count_all = 0
			,t_count_ok = 0
			,t_count_wa = 0
			,t_count_ng = 0
	End


	
	UPDATE wbe_edibook_dw_ekk
      SET
           e45_edi_flag = @a_edi_flag,
           e45_edi_error_msg = @a_edi_error_msg,
           e45_edi_update_date = @a_getdate
      WHERE 
            e45_edi_id = @e45_edi_id

	-- 処理カウント更新
	UPDATE #count_tbl SET
		t_count_all = t_count_all + 1
		,t_count_ok = -- 正常
			Case
			when @a_edi_flag = '1' then t_count_ok + 1
			else t_count_ok
			End
		,t_count_wa = -- 警告
			Case
			when @a_edi_flag = '2' then t_count_wa + 1
			else t_count_wa
			End
		,t_count_ng = -- エラー
			Case
			when @a_edi_flag = '3' then t_count_ng + 1
			else t_count_ng
			End
	where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @e45_tushin_id

    -- 次へ
    fetch next from @rs into
	 @e45_edi_id
	,@e45_sakusei_date
	,@e45_ecl_hinban
	,@e45_jan_cd
	,@e45_tekiyou_date
	,@e45_teika
	,@e45_tushin_id
  End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9162,商品定価改正データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9163,商品定価改正データログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

DOWN_GOODS_TEIKA_KAISEI_END:

--=================================================
-- 【東京エコール】下り商品マスタのクライアント処理 		-- 2013/12/24 add
--=================================================

DOWN_ECOLE_ESH:
  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9001,基準曲データ情報セット不正'
    GOTO SP_ERR
  End
  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
				+ ' INSERT wbe_edibook_dw_esh ( '
				+ '		e40_edi_flag, '
				+ '		e40_edi_id, '
				+ '		e40_edi_create_date, '
				+ '		e40_edi_update_date, '
				+ '		e40_edi_file_line_no, '
				+ '		e40_edi_meisai_no, '
				+ '		e40_edi_error_msg, '
				+ '		e40_server_webpos, '
				+ '		e40_dbname_webpos, '
				+ '		e40_shop_cd_webpos, '
				+ '		e40_shop_name_webpos, '
				+ '		e40_seq_no, '
				+ '		e40_shop_cd_primary, '
				+ '		e40_shop_cd, '
				+ '		e40_tushin_id, '
				+ '		e40_record_kubun, '
				+ '		e40_data_syubetu, '
				+ '		e40_data_kubun, '
				+ '		e40_data_create_date, '
				+ '		e40_data_jissi_date, '
				+ '		e40_kyo_tori, '
				+ '		e40_itf_cd, '
				+ '		e40_jan_cd, '
				+ '		e40_code_kbn, '
				+ '		e40_souce_kbn, '
				+ '		e40_hinban, '
				+ '		e40_kana_name, '
				+ '		e40_zeinuki_teika, '
				+ '		e40_tani_name, '
				+ '		e40_bunrui_cd, '
				+ '		e40_min_hcu_tani, '
				+ '		e40_hako_irisu, '
				+ '		e40_itf_irisu, '
				+ '		e40_genka_tanka, '
				+ '		e40_kihon_r2umu, '
				+ '		e40_record_kbn2, '
				+ '		e40_data_syubetu2, '
				+ '		e40_kanji_name, '
				+ '		e40_pos_name, '
				+ '		e40_daigae_hbn, '
				+ '		e40_hatubai_date, '
				+ '		e40_haiban_date, '
				+ '		e40_size_tani, '
				+ '		e40_size_haba, '
				+ '		e40_size_takasa, '
				+ '		e40_size_okuyuki, '
				+ '		e40_weight_tani, '
				+ '		e40_weight_zyuryou, '
				+ '		e40_tanaka_kbn, '
				+ '		e40_nouki_kbn, '
				+ '		e40_read_time, '
				+ '		e40_uti_irisu, '
				+ '		e40_naka_irisu, '
				+ '		e40_pos_kbn, '
				+ '		e40_oem_kbn, '
				+ '		e40_open_kbn, '
				+ '		e40_filler1, '
				+ '		e40_shikibetu, '
				+ '		e40_record_kbn3, '
				+ '		e40_data_syubetu3, '
				+ '		e40_ecl_hinban, '
				+ '		e40_bland_name, '
				+ '		e40_seihin_kikaku, '
				+ '		e40_renban, '
				+ '		e40_zei_kbn, '
				+ '		e40_jicfs_bunrui, '
				+ '		e40_renban_jti, '
				+ '		e40_filler2 )'
				+ ' SELECT '
				+ '		M.e40_edi_flag, '
				+ '		M.e40_edi_id, '
				+ '		M.e40_edi_create_date, '
				+ '		M.e40_edi_update_date, '
				+ '		M.e40_edi_file_line_no, '
				+ '		M.e40_edi_meisai_no, '
				+ '		M.e40_edi_error_msg, '
				+ '		M.e40_server_webpos, '
				+ '		M.e40_dbname_webpos, '
				+ '		M.e40_shop_cd_webpos, '
				+ '		M.e40_shop_name_webpos, '
				+ '		M.e40_seq_no, '
				+ '		M.e40_shop_cd_primary, '
				+ '		M.e40_shop_cd, '
				+ '		M.e40_tushin_id, '
				+ '		M.e40_record_kubun, '
				+ '		M.e40_data_syubetu, '
				+ '		M.e40_data_kubun, '
				+ '		M.e40_data_create_date, '
				+ '		M.e40_data_jissi_date, '
				+ '		M.e40_kyo_tori, '
				+ '		M.e40_itf_cd, '
				+ '		M.e40_jan_cd, '
				+ '		M.e40_code_kbn, '
				+ '		M.e40_souce_kbn, '
				+ '		M.e40_hinban, '
				+ '		M.e40_kana_name, '
				+ '		M.e40_zeinuki_teika, '
				+ '		M.e40_tani_name, '
				+ '		M.e40_bunrui_cd, '
				+ '		M.e40_min_hcu_tani, '
				+ '		M.e40_hako_irisu, '
				+ '		M.e40_itf_irisu, '
				+ '		M.e40_genka_tanka, '
				+ '		M.e40_kihon_r2umu, '
				+ '		M.e40_record_kbn2, '
				+ '		M.e40_data_syubetu2, '
				+ '		M.e40_kanji_name, '
				+ '		M.e40_pos_name, '
				+ '		M.e40_daigae_hbn, '
				+ '		M.e40_hatubai_date, '
				+ '		M.e40_haiban_date, '
				+ '		M.e40_size_tani, '
				+ '		M.e40_size_haba, '
				+ '		M.e40_size_takasa, '
				+ '		M.e40_size_okuyuki, '
				+ '		M.e40_weight_tani, '
				+ '		M.e40_weight_zyuryou, '
				+ '		M.e40_tanaka_kbn, '
				+ '		M.e40_nouki_kbn, '
				+ '		M.e40_read_time, '
				+ '		M.e40_uti_irisu, '
				+ '		M.e40_naka_irisu, '
				+ '		M.e40_pos_kbn, '
				+ '		M.e40_oem_kbn, '
				+ '		M.e40_open_kbn, '
				+ '		M.e40_filler1, '
				+ '		M.e40_shikibetu, '
				+ '		M.e40_record_kbn3, '
				+ '		M.e40_data_syubetu3, '
				+ '		M.e40_ecl_hinban, '
				+ '		M.e40_bland_name, '
				+ '		M.e40_seihin_kikaku, '
				+ '		M.e40_renban, '
				+ '		M.e40_zei_kbn, '
				+ '		M.e40_jicfs_bunrui, '
				+ '		M.e40_renban_jti, '
				+ '		M.e40_filler2 '	 
				+ '	FROM '
				+ '		' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_esh as M '
				+ '		LEFT OUTER JOIN wbe_edibook_dw_esh AS C ON '
				+ '			M.e40_edi_id = C.e40_edi_id '
				+ ' WHERE'
				+ '		C.e40_edi_id is null AND '  -- コピーしてないもののみ
				+ '		M.e40_edi_flag = ''0'' AND '  -- 未処理
				+ '     M.e40_server_webpos = ''' + @server_name + ''' AND '
				+ '     M.e40_dbname_webpos = ''' + @db_name + ''' '
				+ '	ORDER BY '
				+ '     M.e40_edi_id'  -- ID順に取り込む
	Exec (@a_sql)
	-- エラーチェック
	If @@ERROR <> 0 Begin
		Set @err_msg = '9001,基準曲データ取得エラー'
		GOTO SP_ERR
	End
	
	------------------------------
	-- データ読み込み
	------------------------------
	Declare @e40_bunrui_cd varchar (6)
	Declare @mcb_media_cd varchar(10)
	Declare @e40_edi_id bigint
	Declare @gmg_media_group_id int
	Declare @e40_kyo_tori varchar(6)
	Declare @rs_shop cursor 
	Declare @rs_shop_goods cursor
	Declare @shop_cd int
	Declare @mpm_supplier_id int
	Declare @res_goods_id int					-- 商品ID
	Declare @e40_ecl_hinban varchar(20)
	Declare @e40_kanji_name varchar(100)
	Declare @e40_zeinuki_teika int
	Declare @obj_goods_id int
	Declare @e40_haiban_date char(8)
	Declare @e40_jan_cd varchar(13)
	Declare @gdm_media_id int
	Declare @gds_product_stop_flg char(1)
	Declare @gds_product_stop_date datetime
	Declare @e40_hinban as varchar(20)
	Declare @e40_bland_name varchar(10)
	Declare @sgd_goods_name varchar(100)
	Declare @sgd_tax_type char(1)
	Declare @sgd_price money
	Declare @sgd_price_type char(1)
	Declare @sgd_media_id int
	Declare @sgd_shop_cd int
	Declare @sgd_media_cd varchar(10)
	Declare @e40_tushin_id char(2)
    --2014-02-21 メディアマスタのカナを利用 M.Tsuruta
	Declare @gdm_media_kana varchar(100)
	--Declare @gdm_media_ryaku varchar(50)
	Declare @gdm_media_kan varchar(100)
	Declare @gdd_lifecycle_type char(1)
	Declare @e40_tani_name varchar(3)
	-- ▼▼▼ 2015/04/06 add 発売日判定用
	Declare @e40_hatubai_date datetime			--- 発売年月日（yyyy/mm/dd）
	Declare @res_purchase_stop_date datetime		--- 買取中止日付

	Declare @res_gds_price money				--- 商品マスタ標準売価（税抜）
	Declare @res_gds_price_tax money			--- 商品マスタ標準売価（税込）

	Declare @res_stk_shop_cd int				--- 在庫マスタ店舗コード
	Declare @res_stk_condition_type char(1)		--- 在庫マスタ商品区分
	Declare @res_stk_price money				--- 在庫マスタ売価（税込）

	Declare @res_zeinuki_teika_tax money		--- 商品本体価格（税込）
	Declare @tax_rate decimal(5,2)				--  消費税率

	-- ▲▲▲ 2015/04/06 add

	Set @a_goods_type = '31'
	
	
	-- データを取得する。
	Set @rs = cursor static for
	SELECT
		 e40_edi_id
		,e40_bunrui_cd
		,e40_ecl_hinban
		,e40_kanji_name
		,e40_zeinuki_teika
		-- ▼▼▼ 2015/04/06 add
		,CASE  WHEN  e40_hatubai_date IS NULL
		       THEN  NULL
			   ELSE  CASE  WHEN  CAST(e40_hatubai_date As int) > 890000 
		                   THEN  CASE  WHEN  ISDATE('19' + e40_hatubai_date)  = 1
						               THEN  CONVERT(DATETIME, '19' + e40_hatubai_date, 120)
									   ELSE  NULL
								 END
						   ELSE  CASE  WHEN  ISDATE('20' + e40_hatubai_date)  = 1
                                       THEN  CONVERT(DATETIME, '20' + e40_hatubai_date, 120)
									   ELSE  NULL
								 END
					 END
		 END
		--- ▲▲▲ 2015/04/06 add
		,e40_haiban_date
		,e40_jan_cd
		,e40_hinban
		,e40_bland_name
		,e40_kyo_tori
		,e40_tushin_id
		,e40_tani_name
	from
		wbe_edibook_dw_esh
	where
		e40_edi_flag = '0'  -- 未処理
	order by
		 e40_edi_id
		,e40_edi_file_line_no
		,e40_edi_create_date

	-- カーソルを開く
	open @rs
	-- @P_INOUT_TMPループ
	fetch next from @rs into
		 @e40_edi_id
		,@e40_bunrui_cd
		,@e40_ecl_hinban
		,@e40_kanji_name
		,@e40_zeinuki_teika
		-- ▼▼▼ 2015/04/06 add
		,@e40_hatubai_date
		-- ▲▲▲ 2015/04/06 add
		,@e40_haiban_date
		,@e40_jan_cd
		,@e40_hinban
		,@e40_bland_name
		,@e40_kyo_tori
		,@e40_tushin_id
		,@e40_tani_name

	-- レコードがなくなるまで
	While @@FETCH_STATUS = 0 Begin
		
	-- ▼▼▼ 2014/02/17 update
		---- 受信データの分類コードで、「商品メディア変換」テーブルを検索する。
		--Set @mcb_media_cd = NULL
		--Set @res_goods_id = NULL
		--SELECT @mcb_media_cd = mcb_media_cd
		--FROM wpt_goods_media_convert_book
		--WHERE mcb_convert_type = '4' AND
		--		mcb_c_code = @e40_bunrui_cd
		
		---- 「商品メディア変換」テーブルに該当レコードが存在しなかった場合はエラーとする。	
		--If @mcb_media_cd IS NULL Begin
		--	Set @a_edi_flag = '3'
		--	Set @a_edi_error_msg = '商品メディア変換未登録'
		--	GOTO DW_ESH_COUNT_RES
		--End
		SELECT @mcb_media_cd = dbo.F_Search_Ecole_Media('0',@e40_bunrui_cd,'')
	-- ▲▲▲ 2014/02/17 update

		-- 「メディアグループＩＤ」と取得する。
		SELECT @gmg_media_group_id = gmg_media_group_id 
		FROM wpt_goods_media_group_master
		WHERE gmg_media_group_cd = '8440'
		
		If Not Exists(SELECT TOP 1 gdm_media_id 
					FROM wpt_goods_media_master 
					WHERE gdm_media_cd = @mcb_media_cd ) Begin
				-- 「商品メディアマスタ」テーブルに登録。
				INSERT INTO wpt_goods_media_master (
					gdm_create_date,
					gdm_update_date,
					gdm_update_memo,
					gdm_media_cd,
					gdm_media_group_id,
					gdm_shop_cd,
					gdm_media_name,
					gdm_media_ryaku,
					gdm_media_kana,
					gdm_sort_type	
				) VALUES (
					getdate(),
					getdate(),
					NULL,
					@mcb_media_cd,
					@gmg_media_group_id,
					NULL,
					'',
					NULL,
					NULL,
					'0'
				)		
				IF @@ERROR <> 0 BEGIN
					SELECT	@a_edi_flag='3', 
							@a_edi_error_msg = '「商品メディアマスタ」テーブルで登録時にエラーが発生した。 '
											+ '「メディアコード」 = [' + isnull(@mcb_media_cd, '') + ']'
					GOTO DW_ESH_COUNT_RES
				END				
			End 
		-- 2014-02-21 分類マスタは更新処理はなし M.Tsuruta
		--Else
		--	Begin
		--	    -- 「商品メディアマスタ」テーブルで更新。
		--		UPDATE wpt_goods_media_master
		--		SET gdm_update_date = getdate(),
		--			gdm_update_memo = NULL,
		--			gdm_media_cd = @mcb_media_cd,
		--			gdm_media_group_id = @gmg_media_group_id,
		--			gdm_shop_cd = NULL,
		--			gdm_media_name = '',
		--			gdm_media_ryaku = NULL,
		--			gdm_media_kana = NULL,
		--			gdm_sort_type = '0'
		--		WHERE gdm_media_cd = @mcb_media_cd
				
		--		IF @@ERROR <> 0 Begin
		--			SELECT	@a_edi_flag='3',
		--					@a_edi_error_msg = '「商品メディアマスタ」テーブルで更新時にエラーが発生した。 '
		--									+ '[メディアコード] = [' + isnull(@mcb_media_cd, '') + ']'
		--			GOTO DW_ESH_COUNT_RES
		--		End
		--	End
		
		If Not Exists(SELECT TOP 1 gm1_media_group1_cd 
						FROM wpt_goods_media_group1_master 
						WHERE gm1_media_group1_cd = '5') Begin
				-- 「商品メディア大分類マスタ」テーブルに登録。
				INSERT INTO 
					wpt_goods_media_group1_master(
						gm1_media_group1_cd,
						gm1_create_date,
						gm1_update_date,
						gm1_update_memo,
						gm1_media_group1_name
					) VALUES (
						'5',
						getdate(),
						getdate(),
						NULL,
						'文具'
					)
				If @@ERROR <> 0 Begin
					SELECT	@a_edi_flag='3',
							@a_edi_error_msg = '「商品メディア大分類マスタ」テーブルで登録時にエラーが発生した。'
					GOTO DW_ESH_COUNT_RES
				End
			End
		If Not Exists(SELECT TOP 1 gm2_media_group1_cd 
						FROM wpt_goods_media_group2_master
						WHERE gm2_media_group1_cd = Substring(@mcb_media_cd, 1, 1) AND
							  gm2_media_group2_cd = substring(@mcb_media_cd, 2, 1)) Begin
				-- 「商品メディア中分類マスタ」テーブルに登録。
				INSERT INTO wpt_goods_media_group2_master (
					gm2_media_group1_cd,
					gm2_media_group2_cd,
					gm2_create_date,
					gm2_update_date,
					gm2_update_memo,
					gm2_media_group2_name
				) VALUES (
					substring(@mcb_media_cd, 1, 1),
					substring(@mcb_media_cd, 2, 1),
					getdate(),
					getdate(),
					NULL,
					''
				)
				If @@ERROR <> 0 Begin
					SELECT	@a_edi_flag='3',
							@a_edi_error_msg = '「商品メディア中分類マスタ」テーブルで登録時にエラーが発生した。 '
											+ '[メディアコード] = [' + isnull(@mcb_media_cd, '') + ']'
					GOTO DW_ESH_COUNT_RES
				End
			End
		-- 2014-02-21 分類マスタは更新処理はなし M.Tsuruta
		--Else
		--	Begin
		--	    -- 「商品メディア中分類マスタ」テーブルで更新。
		--		UPDATE wpt_goods_media_group2_master
		--		SET	gm2_update_memo = NULL,
		--			gm2_update_date = getdate(),
		--			gm2_media_group2_name = ''
		--		WHERE gm2_media_group1_cd = Substring(@mcb_media_cd, 1, 1) AND
		--			gm2_media_group2_cd = substring(@mcb_media_cd, 2, 1) 
				
		--		If @@ERROR <> 0 Begin
		--			SELECT	@a_edi_flag='3',
		--					@a_edi_error_msg = '「商品メディア中分類マスタ」テーブルで更新時にエラーが発生した。 '
		--									+ '[メディアコード] = [' + isnull(@mcb_media_cd, '') + ']'
		--			GOTO DW_ESH_COUNT_RES
		--		End
		--	End									
		
		If Not Exists (SELECT TOP 1 gm3_media_group1_cd 
						FROM wpt_goods_media_group3_master
						WHERE gm3_media_group1_cd = substring(@mcb_media_cd,1,1) AND
							  gm3_media_group2_cd = substring(@mcb_media_cd,2,1) AND
							  gm3_media_group3_cd = substring(@mcb_media_cd,3,2)) Begin
				-- 「商品メディア中小分類マスタ」テーブルに登録。
				INSERT INTO wpt_goods_media_group3_master(
					gm3_media_group1_cd,
					gm3_media_group2_cd,
					gm3_media_group3_cd,
					gm3_create_date,
					gm3_update_date,
					gm3_update_memo,
					gm3_media_group3_name
				) VALUES (
					substring(@mcb_media_cd,1,1),
					substring(@mcb_media_cd,2,1),
					substring(@mcb_media_cd,3,2),
					getdate(),
					getdate(),
					NULL,
					''
				)
				If @@ERROR <> 0 Begin
					SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「商品メディア中小分類マスタ」テーブルで登録新時にエラーが発生した。 '
											+ '[メディアコード] = [' + isnull(@mcb_media_cd, '') + ']'
					GOTO DW_ESH_COUNT_RES
				End
			End
		-- 2014-02-21 分類マスタは更新処理はなし M.Tsuruta
		--Else
		--	Begin
		--	    -- 「商品メディア中小分類マスタ」テーブルで更新。
		--		UPDATE wpt_goods_media_group3_master
		--		SET gm3_update_date = getdate(),
		--			gm3_update_memo = NULL,
		--			gm3_media_group3_name = ''
		--		WHERE gm3_media_group1_cd = substring(@mcb_media_cd,1,1) AND
		--			  gm3_media_group2_cd = substring(@mcb_media_cd,2,1) AND
		--			  gm3_media_group3_cd = substring(@mcb_media_cd,3,2)
		--		If @@ERROR <> 0 Begin
		--			SELECT	@a_edi_flag = '3',
		--					@a_edi_error_msg = '「商品メディア中小分類マスタ」テーブルで更新新時にエラーが発生した。 '
		--									+ '[メディアコード] = [' + isnull(@mcb_media_cd, '') + ']'
		--			GOTO DW_ESH_COUNT_RES
		--		End
		--	End
		
		IF Not Exists(SELECT TOP 1 gm4_media_group1_cd
						FROM wpt_goods_media_group4_master
						WHERE gm4_media_group1_cd = substring(@mcb_media_cd,1,1) AND
							  gm4_media_group2_cd = substring(@mcb_media_cd,2,1) AND
							  gm4_media_group3_cd = substring(@mcb_media_cd,3,2) AND
							  gm4_media_group4_cd = substring(@mcb_media_cd,5,1)) Begin
				-- 「商品メディア小分類マスタ」テーブルに登録。
				INSERT INTO wpt_goods_media_group4_master(
					gm4_media_group1_cd,
					gm4_media_group2_cd,
					gm4_media_group3_cd,
					gm4_media_group4_cd,
					gm4_create_date,
					gm4_update_date,
					gm4_update_memo,
					gm4_media_group4_name
				) VALUES (
					substring(@mcb_media_cd,1,1),
					substring(@mcb_media_cd,2,1),
					substring(@mcb_media_cd,3,2),
					substring(@mcb_media_cd,5,1),
					getdate(),
					getdate(),
					NULL,
					''
				)	
				If @@ERROR <> 0 Begin
					SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「商品メディア小分類マスタ」テーブルで登録新時にエラーが発生した。 '
											+ '[メディアコード] = [' + isnull(@mcb_media_cd, '') + ']'
					GOTO DW_ESH_COUNT_RES
				End			 
			End
		-- 2014-02-21 分類マスタは更新処理はなし M.Tsuruta
		--Else
		--	Begin
		--	    -- 「商品メディア小分類マスタ」テーブルで更新。
		--		UPDATE wpt_goods_media_group4_master 
		--		SET gm4_update_date = getdate(),
		--			gm4_update_memo = NULL,
		--			gm4_media_group4_name = ''
		--		WHERE gm4_media_group1_cd = substring(@mcb_media_cd,1,1) AND
		--			  gm4_media_group2_cd = substring(@mcb_media_cd,2,1) AND
		--			  gm4_media_group3_cd = substring(@mcb_media_cd,3,2) AND
		--			  gm4_media_group4_cd = substring(@mcb_media_cd,5,1)
		--		If @@ERROR <> 0 Begin
		--			SELECT	@a_edi_flag = '3',
		--					@a_edi_error_msg = '「商品メディア小分類マスタ」テーブルで更新時にエラーが発生した。 '
		--									+ '[メディアコード] = [' + isnull(@mcb_media_cd, '') + ']'
		--			GOTO DW_ESH_COUNT_RES
		--		End			  
		--	End
		
		IF Not Exists (SELECT TOP 1 msm_sales_cd 
						FROM wpt_maker_sales_master 
						WHERE msm_sales_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4)) Begin  --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
				-- 「メーカ販売元マスタ」テーブルに登録。
				INSERT INTO wpt_maker_sales_master (
					msm_sales_cd,
					msm_create_date,
					msm_update_date,
					msm_update_memo,
					msm_sales_name
				) VALUES(
					'ECOLE-' + substring(@e40_kyo_tori,1,4), --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
					getdate(),
					getdate(),
					NULL,
					''
				)		
				If @@ERROR <> 0 Begin
					SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「メーカ販売元マスタ」テーブルで登録時にエラーが発生した。 '
											+ '[販売元コード] = [' + 'ECOLE-' + substring(@e40_kyo_tori,1,4) + ']' --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
					GOTO DW_ESH_COUNT_RES
				End		
			End
		-- 2014-02-21 メーカー販売元マスタは更新処理はなし Naruki		
		--Else
		--	Begin
		--		-- 「メーカ販売元マスタ」テーブルで更新。
		--		UPDATE wpt_maker_sales_master
		--		SET msm_update_date = getdate(),
		--			msm_update_memo = NULL,
		--			msm_sales_name = ''
		--		WHERE msm_sales_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4) --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
		--		If @@ERROR <> 0 Begin
		--			SELECT	@a_edi_flag = '3',
		--					@a_edi_error_msg = '「メーカ販売元マスタ」テーブルで更新時にエラーが発生した。 '
		--									+ '[販売元コード] = [' + 'ECOLE-' + substring(@e40_kyo_tori,1,4) + ']' --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
		--			GOTO DW_ESH_COUNT_RES
		--		End		
		--	End
		
		If Not Exists(SELECT TOP 1 mlm_label_cd 
						FROM wpt_maker_label_master
						WHERE mlm_label_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4)) Begin  --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
				-- 「メーカレーベルマスタ」テーブルに登録。
				INSERT INTO wpt_maker_label_master(
					mlm_label_cd,
					mlm_create_date,
					mlm_update_date,
					mlm_update_memo,
					mlm_label_name,
					mlm_sales_cd
				) VALUES (
					'ECOLE-' + substring(@e40_kyo_tori,1,4), --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
					getdate(),
					getdate(),
					NULL,
					'',
					'ECOLE-' + substring(@e40_kyo_tori,1,4) --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
				)		
				If @@ERROR <> 0 Begin
					SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「メーカレーベルマスタ」テーブルで登録時にエラーが発生した。 '
											+ '[発売元コード（レーベルコード）] = [' + isnull('ECOLE-' + substring(@e40_kyo_tori,1,4), '') + ']'
					GOTO DW_ESH_COUNT_RES
				End			
			End
		-- 2014-02-21 メーカレーベルマスタは更新処理はなし Naruki		
		--Else
		--	Begin
		--	    -- 「メーカレーベルマスタ」テーブルで更新。
		--		UPDATE wpt_maker_label_master 
		--		SET mlm_update_date = getdate(),
		--			mlm_update_memo = NULL,
		--			mlm_label_name = '',
		--			mlm_sales_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4) --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
		--		WHERE mlm_label_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4) --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
		--		If @@ERROR <> 0 Begin
		--			SELECT	@a_edi_flag = '3',
		--					@a_edi_error_msg = '「メーカレーベルマスタ」テーブルで更新時にエラーが発生した。 '
		--									+ '[発売元コード（レーベルコード）] = [' + isnull('ECOLE-' + substring(@e40_kyo_tori,1,4), '') + ']'
		--			GOTO DW_ESH_COUNT_RES
		--		End			
		--	End
		
		If Not Exists(SELECT TOP 1 mss_sales_cd 
						FROM wpt_maker_sales_setting 
						WHERE mss_sales_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4) ) Begin --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
				-- 「メーカ仕入先マスタ」.「仕入先ＩＤ」を取得する。
				SELECT @mpm_supplier_id = mpm_supplier_id
				FROM wpt_maker_supplier_master
				WHERE mpm_bookedi_cd = 'EC'				
				-- 「店舗マスタ」.「店舗コード」を取得する。		
				Set @rs_shop = cursor static for
					SELECT
						shm_shop_cd
					from
						wpt_shop_master
					where
						shm_delete_flag = '0'
					order by
						shm_shop_cd
				open @rs_shop	
				fetch next from @rs_shop into
					@shop_cd
				While @@FETCH_STATUS = 0 Begin
					-- 「メーカ販売元設定」テーブルに登録。
					INSERT INTO wpt_maker_sales_setting(
						mss_sales_cd,
						mss_shop_cd,
						mss_supplier1_id,
						mss_supplier2_id,
						mss_supplier3_id,
						mss_supplier4_id,
						mss_supplier5_id						
					) VALUES (
						'ECOLE-' + substring(@e40_kyo_tori,1,4), --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
						@shop_cd,
						@mpm_supplier_id,
						0,
						0,
						0,
						0
					)
					If @@ERROR <> 0 Begin
						SELECT	@a_edi_flag = '3',
								@a_edi_error_msg = '「メーカ販売元設定」テーブルで登録時にエラーが発生した。 '
												+ '[販売元コード] = [' + isnull('ECOLE-' + substring(@e40_kyo_tori,1,4), '') + '],'
												+ '[店舗コード] = [' + isnull(cast(@shop_cd as varchar(20)),'') + ']'
						GOTO DW_ESH_COUNT_RES
					End		
					fetch next from @rs_shop into
					@shop_cd
				End
			End						
		SET @res_goods_id = NULL

		IF 	@e40_jan_cd IS NULL or @e40_jan_cd = '' Begin
			SELECT	@a_edi_flag = '3',
					@a_edi_error_msg = 'ＪＡＮコード指定なしエラーが発生した。 '
									+ '[商品コード] = [' + isnull(@e40_ecl_hinban, '') + ']'
			GOTO DW_ESH_COUNT_RES
		End 	
		-- ▼▼▼ 2015/04/06 update
		-- 固有商品コード(エコール商品コード)にて商品マスタを検索する(P_PLUにて検索)
		--EXEC @rc = P_PLU 
		--		@plu_cd = @e40_ecl_hinban,
		--		@sp = '1',
		--		@plu_type = '1',
		--		@gds_goods_id = @res_goods_id OUTPUT
		--		
		--If @rc <> 0 Begin
		--	SELECT	@a_edi_flag = '3',
		--			@a_edi_error_msg = '固有商品コード(エコール商品コード)にて商品マスタを検索にエラーが発生した。 '
		--							+ '[商品コード] = [' + isnull(@e40_ecl_hinban, '') + ']'
		--	GOTO DW_ESH_COUNT_RES
		--End
		-- ＪＡＮコード(商品コード)にて商品マスタを検索する(P_PLUにて検索)
		EXEC @rc = P_PLU 
				@plu_cd = @e40_jan_cd,
				@sp = '1',
				@plu_type = '0',
				@gds_goods_id = @res_goods_id OUTPUT,
				@gds_purchase_stop_date = @res_purchase_stop_date OUTPUT,	-- 買取中止日付
				@stk_price = @res_gds_price OUTPUT
				
		If @rc <> 0 Begin
			SELECT	@a_edi_flag = '3',
					@a_edi_error_msg = 'ＪＡＮコード(商品コード)にて商品マスタを検索にエラーが発生した。 '
									+ '[商品コード] = [' + isnull(@e40_jan_cd, '') + ']'
			GOTO DW_ESH_COUNT_RES
		End

		If @res_goods_id IS NOT NULL Begin
		-- 更新前データの退避
			If @e40_hatubai_date >= @res_purchase_stop_date OR 
			   ( @e40_hatubai_date IS NOT NULL AND @res_purchase_stop_date IS NULL )Begin
				INSERT INTO Tmp_goods_master_overlap(
                         bk_create_date
                        ,bk_gds_goods_id
      					,bk_gds_create_date
      					,bk_gds_update_date
      					,bk_gds_update_memo
      					,bk_gds_goods_type
      					,bk_gds_jan_cd
      					,bk_gds_koyu_goods_cd
      					,bk_gds_goods_name
      					,bk_gds_goods_ryaku
      					,bk_gds_goods_kana
      					,bk_gds_goods_kana2
      					,bk_gds_tax_type
      					,bk_gds_price
      					,bk_gds_price_type
      					,bk_gds_cost_price
      					,bk_gds_new_reference_price
      					,bk_gds_new_reference_price_type
      					,bk_gds_new_reference_cost_price
      					,bk_gds_used_reference_price
      					,bk_gds_used_reference_price_type
      					,bk_gds_used_reference_purchase_price
      					,bk_gds_used_reference_purchase_price_type
      					,bk_gds_used_reference_cost_price
      					,bk_gds_sales_date
      					,bk_gds_text_sales_date
      					,bk_gds_stock_control_type
      					,bk_gds_stock_control_goods_id
      					,bk_gds_set_type
      					,bk_gds_media_id
      					,bk_gds_genre_cd
      					,bk_gds_product_stop_flag
      					,bk_gds_product_stop_date
      					,bk_gds_purchase_stop_flag
      					,bk_gds_purchase_stop_date
      					,bk_gds_hachu_stop_flag
      					,bk_gds_gross_flag
      					,bk_gds_delete_flag
      					,bk_gds_auto_hachu_flag
      					,bk_gds_tana_media_update_flag
      					,bk_gds_sales_update_flag
      					,bk_gds_bookedi_cd
      					,bk_gds_teiki_create_date
				)
				SELECT   GETDATE()
				        ,gds_goods_id
      					,gds_create_date
      					,gds_update_date
      					,gds_update_memo
      					,gds_goods_type
      					,gds_jan_cd
      					,gds_koyu_goods_cd
      					,gds_goods_name
      					,gds_goods_ryaku
      					,gds_goods_kana
      					,gds_goods_kana2
      					,gds_tax_type
      					,gds_price
      					,gds_price_type
      					,gds_cost_price
      					,gds_new_reference_price
      					,gds_new_reference_price_type
      					,gds_new_reference_cost_price
      					,gds_used_reference_price
      					,gds_used_reference_price_type
      					,gds_used_reference_purchase_price
      					,gds_used_reference_purchase_price_type
      					,gds_used_reference_cost_price
      					,gds_sales_date
      					,gds_text_sales_date
      					,gds_stock_control_type
      					,gds_stock_control_goods_id
      					,gds_set_type
      					,gds_media_id
      					,gds_genre_cd
      					,gds_product_stop_flag
      					,gds_product_stop_date
      					,gds_purchase_stop_flag
      					,gds_purchase_stop_date
      					,gds_hachu_stop_flag
      					,gds_gross_flag
      					,gds_delete_flag
      					,gds_auto_hachu_flag
      					,gds_tana_media_update_flag
      					,gds_sales_update_flag
      					,gds_bookedi_cd
      					,gds_teiki_create_date
				FROM   wpt_goods_master
				WHERE  gds_goods_id = @res_goods_id
				End
			Else
				Begin
				INSERT INTO Tmp_goods_master_overlap(
                     bk_create_date
					,bk_gds_goods_id
					,bk_gds_jan_cd
					,bk_gds_koyu_goods_cd
					,bk_gds_goods_name
					,bk_gds_price
					,bk_gds_purchase_stop_date
					,bk_gds_bookedi_cd
				) VALUES (
					 GETDATE()
					,@res_goods_id
					,@e40_jan_cd
					,@e40_ecl_hinban
					,@e40_kanji_name
					,@e40_zeinuki_teika
					,@e40_hatubai_date
					,'EC'
					)
				SET @a_edi_flag = '1'
				Set @a_edi_error_msg = NULL
				GOTO DW_ESH_COUNT_RES		-- ループ終了まで飛ばす
				End
			End
		-- ▲▲▲ 2015/04/06 update
		
		-- メディアIDを取得する。			
	-- ▼▼▼ 2014/02/17 update
		--SELECT @gdm_media_id = gdm_media_id 
		--FROM wpt_goods_media_master AS MediaMaster
		--	INNER JOIN wpt_goods_media_convert_book AS MediaConvert ON
		--		MediaMaster.gdm_media_cd = MediaConvert.mcb_media_cd	
		--WHERE MediaConvert.mcb_convert_type = '4' AND
		--		MediaConvert.mcb_c_code = @e40_bunrui_cd
		SELECT @gdm_media_id = Convert(Int,dbo.F_Search_Ecole_Media('1',@e40_bunrui_cd,''))
	-- ▲▲▲ 2014/02/17 update
	
		--2014-02-21 商品マスタにセットする商品名略称は、商品メディアマスタから再取得する M.Tsuruta	
		SELECT @gdm_media_kana = gdm_media_kana 
		FROM wpt_goods_media_master 
		WHERE gdm_media_id = @gdm_media_id
							
		IF Cast(@e40_haiban_date As int) = 0 Begin
				SELECT	@gds_product_stop_flg = '0',
						@gds_product_stop_date = NULL,
						@gdd_lifecycle_type = '1'
				
			End
		Else 
			Begin					
				Set @gds_product_stop_flg = '1'
				If Cast(@e40_haiban_date As int) <= 500000 Begin
						Set @e40_haiban_date = '20' + @e40_haiban_date
					End
				Else
					Begin
						Set @e40_haiban_date = '19' + @e40_haiban_date
					End
				Set @gds_product_stop_date = convert(datetime, @e40_haiban_date, 120)
				Set @gdd_lifecycle_type = '9'
			End
		
		If @res_goods_id IS NOT NULL Begin
			IF NOT EXISTS (SELECT TOP 1 sgd_goods_id 
							FROM wpt_shop_goods_master
							WHERE sgd_jan_cd = @e40_jan_cd AND
									sgd_delete_flag = '0') Begin
									
				-- ▼▼▼ 2015/04/06 update
				--EXEC @rc = P_Goods_Create
				--			@goods_type   = @a_goods_type,
				--			@plu_cd = @e40_ecl_hinban,
				--			@plu_type = '1',
				--			@goods_name = @e40_kanji_name,
				--			@tax_type = '0',
				--			@price = @e40_zeinuki_teika,
				--			@price_type = 0,
				--			@goods_id = @obj_goods_id OUTPUT
				--If @rc <> 0 or @obj_goods_id IS NULL Begin
				--	SELECT @a_edi_error_msg = '商品マスタ生成エラー'
				--			+ ' 商品コード=[' + isnull(@e40_ecl_hinban,'') + ']'
				--			+ ',商品ＩＤ=[' + isnull(cast(@obj_goods_id as varchar(20)),'') + ']'
				--			+ ',エラーコード=[' + isnull(cast(@rc as varchar(20)),'') + ']'
				--			,@a_edi_flag = '3'  -- エラー
				--	-- ループ終了まで飛ばす
				--	GOTO DW_ESH_COUNT_RES
				--End				
				EXEC @rc = P_Goods_Create
							@goods_type   = @a_goods_type,
							@plu_cd = @e40_jan_cd,
							@plu_type = '0',
							@goods_name = @e40_kanji_name,
							@tax_type = '0',
							@price = @e40_zeinuki_teika,
							@price_type = 0,
							@goods_id = @obj_goods_id OUTPUT
				If @rc <> 0 or @obj_goods_id IS NULL Begin
					SELECT @a_edi_error_msg = '商品マスタ生成エラー 1/4 '
							+ ' 商品コード=[' + isnull(@e40_jan_cd,'') + ']'
							+ ',商品ＩＤ=[' + isnull(cast(@obj_goods_id as varchar(20)),'') + ']'
							+ ',エラーコード=[' + isnull(cast(@rc as varchar(20)),'') + ']'
							,@a_edi_flag = '3'  -- エラー
					-- ループ終了まで飛ばす
					GOTO DW_ESH_COUNT_RES
				End				
				-- ▲▲▲ 2015/04/06 update
				-- 「商品マスタ」テーブルで更新する。			
				UPDATE wpt_goods_master
				SET gds_goods_type = '31',
					gds_jan_cd = @e40_jan_cd,
					-- ▼▼▼ 2015/04/06 add
					gds_koyu_goods_cd = @e40_ecl_hinban,
					-- ▲▲▲ 2015/04/06 add
					gds_goods_name = @e40_kanji_name,
					--2014-02-21 商品メディアマスタのメディアカナをセットするように修正 M.Tsuruta
					--gds_goods_ryaku = @gdm_media_kana,
					gds_goods_kana = @gdm_media_kana,
					gds_goods_kana2 = @gdm_media_kana,
					gds_price = @e40_zeinuki_teika,
					gds_media_id = @gdm_media_id,
					gds_product_stop_flag = @gds_product_stop_flg,
					gds_product_stop_date = @gds_product_stop_date,
					-- ▼▼▼ 2015/04/06 add
					gds_purchase_stop_date = @e40_hatubai_date,
					-- ▲▲▲ 2015/04/06 add
					gds_bookedi_cd = 'EC'
				WHERE gds_goods_id = @obj_goods_id
				
				If @@Error <> 0 Begin
					SELECT	@a_edi_flag = '3',
					@a_edi_error_msg = '「商品マスタ」テーブルで更新時にエラーが発生した。 '
									+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
					GOTO DW_ESH_COUNT_RES
				End
				
				-- 「商品マスタDISK」テーブルで更新する。
				UPDATE wpt_goods_master_disk 
				SET	gdd_standard_number = @e40_hinban,
					gdd_artist_cd = @e40_bland_name,
					gdd_label_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4),  --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
					gdd_lifecycle_type = @gdd_lifecycle_type, -- 2014/02/06: 追加
					gdd_cd_genre_cd = @e40_bunrui_cd, -- 2014/02/06: 追加
					gdd_tani = @e40_tani_name -- 2014/02/06: 追加
				WHERE gdd_goods_id = @obj_goods_id
				If @@Error <> 0 Begin
					SELECT	@a_edi_flag = '3',
					@a_edi_error_msg = '「商品マスタDISK」テーブルで更新時にエラーが発生した。 '
									+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
					GOTO DW_ESH_COUNT_RES
				End
			End	--End IF NOT EXISTS
			Else BEGIN --End IF NOT EXISTS
				-- 「商品マスタ」テーブルで更新する。			
				UPDATE wpt_goods_master
				SET gds_koyu_goods_cd = NULL,
					gds_delete_flag = '1'
				WHERE gds_goods_id = @res_goods_id
				
				If @@Error <> 0 Begin
					SELECT	@a_edi_flag = '3',
					@a_edi_error_msg = '「商品マスタ」テーブルで更新時にエラーが発生した。 '
									+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
					GOTO DW_ESH_COUNT_RES
				End
				
				-- 店舗独自商品の昇格処理を行う(P_goods_createを使用)													
				Exec @rc = P_Goods_Create
					@goods_type   = @a_goods_type,
					@plu_cd = @e40_jan_cd,
					@plu_type = '0',
					@goods_id = @obj_goods_id OUTPUT
					
				If @rc <> 0 or @obj_goods_id IS NULL Begin
					SELECT @a_edi_error_msg = '商品マスタ生成エラー 2/4 '
							+ ' 商品コード=[' + isnull(@e40_jan_cd,'') + ']'
							+ ',商品ＩＤ=[' + isnull(cast(@obj_goods_id as varchar(20)),'') + ']'
							+ ',エラーコード=[' + isnull(cast(@rc as varchar(20)),'') + ']'
							,@a_edi_flag = '3'  -- エラー
					-- ループ終了まで飛ばす
					GOTO DW_ESH_COUNT_RES
				End
				
				UPDATE wpt_goods_master
				SET gds_goods_type = '31',
					gds_goods_name = @e40_kanji_name,
					gds_goods_kana = @gdm_media_kana,
					gds_goods_kana2 = @gdm_media_kana,
					gds_price = @e40_zeinuki_teika,
					gds_media_id = @gdm_media_id,
					gds_product_stop_flag = @gds_product_stop_flg,
					gds_product_stop_date = @gds_product_stop_date,					
					-- ▼▼▼ 2015/04/06 add
					gds_purchase_stop_date = @e40_hatubai_date,
					-- ▲▲▲ 2015/04/06 add
					gds_bookedi_cd = 'EC',
					gds_koyu_goods_cd = @e40_ecl_hinban
				WHERE gds_goods_id = @obj_goods_id
				
				If @@Error <> 0 Begin
					SELECT	@a_edi_flag = '3',
					@a_edi_error_msg = '「商品マスタ」テーブルで更新時にエラーが発生した。 '
									+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
					GOTO DW_ESH_COUNT_RES
				End
				
				-- 「商品マスタDISK」テーブルで更新する。
				UPDATE wpt_goods_master_disk 
				SET	gdd_standard_number = @e40_hinban,
					gdd_artist_cd = @e40_bland_name,
					gdd_label_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4), 
					gdd_lifecycle_type = @gdd_lifecycle_type, 
					gdd_cd_genre_cd = @e40_bunrui_cd, 
					gdd_tani = @e40_tani_name 
				WHERE gdd_goods_id = @obj_goods_id
				If @@Error <> 0 Begin
					SELECT	@a_edi_flag = '3',
					@a_edi_error_msg = '「商品マスタDISK」テーブルで更新時にエラーが発生した。 '
									+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
					GOTO DW_ESH_COUNT_RES
				End
			End --End IF NOT EXISTS
		End -- End IF @res_goods_id IS NOT NULL
				
		Else
			Begin
				IF Exists(SELECT TOP 1 sgd_goods_id 
							FROM wpt_shop_goods_master
							WHERE sgd_jan_cd = @e40_jan_cd AND
									sgd_delete_flag = '0') Begin

						-- 店舗独自商品の昇格処理を行う(P_goods_createを使用)													
						Exec @rc = P_Goods_Create
							@goods_type   = @a_goods_type,
							@plu_cd = @e40_jan_cd,
							@plu_type = '0',
							@goods_id = @obj_goods_id OUTPUT
							
						If @rc <> 0 or @obj_goods_id IS NULL Begin
							SELECT @a_edi_error_msg = '商品マスタ生成エラー 3/4 '
									+ ' 商品コード=[' + isnull(@e40_jan_cd,'') + ']'
									+ ',商品ＩＤ=[' + isnull(cast(@obj_goods_id as varchar(20)),'') + ']'
									+ ',エラーコード=[' + isnull(cast(@rc as varchar(20)),'') + ']'
									,@a_edi_flag = '3'  -- エラー
							-- ループ終了まで飛ばす
							GOTO DW_ESH_COUNT_RES
						End
						
						UPDATE wpt_goods_master
						SET gds_goods_type = '31',
							gds_goods_name = @e40_kanji_name,
							--2014-02-21 商品メディアマスタのメディアカナをセットするように修正 M.Tsuruta
							--gds_goods_ryaku = @gdm_media_kana,
							gds_goods_kana = @gdm_media_kana,
							gds_goods_kana2 = @gdm_media_kana,
							gds_tax_type = '0',						--追加:2018/06/21 - コア - MS470
							gds_price = @e40_zeinuki_teika,
							gds_media_id = @gdm_media_id,
							gds_product_stop_flag = @gds_product_stop_flg,
							gds_product_stop_date = @gds_product_stop_date,
							-- ▼▼▼ 2015/04/06 add
							gds_purchase_stop_date = @e40_hatubai_date,
							-- ▲▲▲ 2015/04/06 add
							gds_bookedi_cd = 'EC',
							gds_koyu_goods_cd = @e40_ecl_hinban
						WHERE gds_goods_id = @obj_goods_id
						
						If @@Error <> 0 Begin
							SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「商品マスタ」テーブルで更新時にエラーが発生した。 '
											+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
							GOTO DW_ESH_COUNT_RES
						End
						
						-- 「商品マスタDISK」テーブルで更新する。
						UPDATE wpt_goods_master_disk 
						SET	gdd_standard_number = @e40_hinban,
							gdd_artist_cd = @e40_bland_name,
							gdd_label_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4), --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
							gdd_lifecycle_type = @gdd_lifecycle_type, -- 2014/02/06: 追加
							gdd_cd_genre_cd = @e40_bunrui_cd, -- 2014/02/06: 追加
							gdd_tani = @e40_tani_name -- 2014/02/06: 追加
						WHERE gdd_goods_id = @obj_goods_id
						If @@Error <> 0 Begin
							SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「商品マスタDISK」テーブルで更新時にエラーが発生した。 '
											+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
							GOTO DW_ESH_COUNT_RES
						End
							
				End
				Else
					Begin
						-- ▼▼▼ 2015/04/06 update
						--Exec @rc = P_Goods_Create
						--			@goods_type   = @a_goods_type,
						--			@plu_cd = @e40_ecl_hinban,
						--			@plu_type = '1',
						--			@goods_name = e40_kanji_name,
						--			@tax_type = '0',
						--			@price = @e40_zeinuki_teika,
						--			@price_type = '0',
						--			@goods_id = @obj_goods_id OUTPUT
						--If @rc <> 0 or @obj_goods_id IS NULL Begin
						--	SELECT @a_edi_error_msg = '商品マスタ生成エラー'
						--			+ ' 商品コード=[' + isnull(@e40_jan_cd,'') + ']'
						--			+ ',商品ＩＤ=[' + isnull(cast(@obj_goods_id as varchar(20)),'') + ']'
						--			+ ',エラーコード=[' + isnull(@rc,'') + ']'
						--			,@a_edi_flag = '3'  -- エラー
						--	-- ループ終了まで飛ばす
						--	GOTO DW_ESH_COUNT_RES
						--End									
						Exec @rc = P_Goods_Create
									@goods_type   = @a_goods_type,
									@plu_cd = @e40_jan_cd,
									@plu_type = '0',
									@goods_name = e40_kanji_name,
									@tax_type = '0',
									@price = @e40_zeinuki_teika,
									@price_type = '0',
									@goods_id = @obj_goods_id OUTPUT
						If @rc <> 0 or @obj_goods_id IS NULL Begin
							SELECT @a_edi_error_msg = '商品マスタ生成エラー 4/4 '
									+ ' 商品コード=[' + isnull(@e40_jan_cd,'') + ']'
									+ ',商品ＩＤ=[' + isnull(cast(@obj_goods_id as varchar(20)),'') + ']'
									+ ',エラーコード=[' + cast(isnull(@rc,'') AS varchar(20)) + ']'
									,@a_edi_flag = '3'  -- エラー
							-- ループ終了まで飛ばす
							GOTO DW_ESH_COUNT_RES
						End									
						-- ▲▲▲ 2015/04/06 update
						
							
						-- 「商品マスタ」テーブルで更新する。
						UPDATE wpt_goods_master 
						SET	gds_create_date = getdate(),
							gds_update_date = getdate(),
							gds_update_memo = object_name(@@PROCID) + '[EC]' + '[' + isnull(@e40_tushin_id,'') +  ']',
							gds_goods_type = '31',
							gds_jan_cd = @e40_jan_cd,
							gds_koyu_goods_cd = @e40_ecl_hinban,
							gds_goods_name = @e40_kanji_name,
							--2014-02-21 商品メディアマスタのメディアカナをセットするように修正 M.Tsuruta
							--gds_goods_ryaku = @gdm_media_kana,
							gds_goods_kana = @gdm_media_kana,
							gds_goods_kana2 = @gdm_media_kana,
							gds_tax_type = '0',
							gds_price = @e40_zeinuki_teika,
							gds_price_type = '0',
							gds_cost_price = 0,
							gds_new_reference_price = 0,
							gds_new_reference_price_type = '0',
							gds_new_reference_cost_price = 0,
							gds_used_reference_price = 0,
							gds_used_reference_price_type = '0',
							gds_used_reference_purchase_price = 0,
							gds_used_reference_purchase_price_type = '0',
							gds_used_reference_cost_price = 0,
							gds_sales_date = NULL,
							gds_text_sales_date = NULL,
							gds_stock_control_type = '1',
							gds_stock_control_goods_id = NULL,
							gds_set_type = '0',
							gds_media_id = @gdm_media_id,
							gds_genre_cd = NULL,
							gds_product_stop_flag = @gds_product_stop_flg,
							gds_product_stop_date = @gds_product_stop_date,
							gds_purchase_stop_flag = '0',
							-- ▼▼▼ 2015/04/06 update
							--gds_purchase_stop_date = NULL,
							gds_purchase_stop_date = @e40_hatubai_date,
							-- ▲▲▲ 2015/04/06 update
							gds_hachu_stop_flag = '0',
							gds_gross_flag = '0',
							gds_delete_flag = '0',
							gds_auto_hachu_flag = '0',
							gds_tana_media_update_flag = '0',
							gds_sales_update_flag = '0',
							gds_bookedi_cd = 'EC',
							gds_teiki_create_date = NULL							
						WHERE gds_goods_id = @obj_goods_id
						
						If @@Error <> 0 Begin
							SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「商品マスタ」テーブルで更新時にエラーが発生した。 '
											+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
							GOTO DW_ESH_COUNT_RES
						End
						
						-- 「商品マスタDISK」テーブルで更新する。
						UPDATE wpt_goods_master_disk
						SET	gdd_standard_number = @e40_hinban,
							gdd_maker_name = NULL,
							gdd_lifecycle_type = @gdd_lifecycle_type,
							gdd_artist_cd = @e40_bland_name,
							gdd_artist_name = NULL,
							gdd_artist_kana = NULL,
							gdd_label_cd = 'ECOLE-' + substring(@e40_kyo_tori,1,4), --2014/01/27: @e40_kyo_tori => 'ECOLE-' + substring(@e40_kyo_tori,1,4)
							gdd_rank = NULL,
							gdd_cd_genre_cd = @e40_bunrui_cd,
							gdd_cd_hinshu_cd = NULL,
							gdd_distribution_type = '0',
							gdd_important_type = '0',
							gdd_base_type = '0',
							gdd_regular_type = '0',
							gdd_b_genre = '0',
							gdd_m_genre = '0',
							gdd_s_genre = '0',
							gdd_tani = @e40_tani_name -- 2014/02/06: 追加
						WHERE gdd_goods_id = @obj_goods_id
						If @@Error <> 0 Begin
							SELECT	@a_edi_flag = '3',
							@a_edi_error_msg = '「商品マスタDISK」テーブルで更新時にエラーが発生した。 '
											+ '[商品コード] = [' + isnull(cast(@obj_goods_id as varchar(20)), '') + ']'
							GOTO DW_ESH_COUNT_RES
						End
					End
			End	
		
		SET @a_edi_flag = '1'
		Set	@a_edi_error_msg = NULL

-- ▼▼▼ 2015/04/06 add 在庫マスタ店舗別更新
       -- 店舗情報を取得する。
	-- wpt_book_edi_setting.bes_dw_ekk_flag=1のレコードの店舗の在庫情報で、取次が商品マスタのものと一致するデータが対象　2016/09/02 add
       Set @rs2 = cursor static for
       SELECT  stk_shop_cd
              ,stk_condition_type
              ,stk_price
       FROM   wpt_stock_master C
	inner join wpt_book_edi_setting B WITH(NOLOCK)	-- 2016/09/02 add
	on C.stk_shop_cd = B.bes_shop_cd						-- 2016/09/02 add
	inner join wpt_goods_master A with(nolock)			-- 2016/09/02 add
	on A.gds_goods_id = C.stk_goods_id						-- 2016/09/02 add
	and gds_bookedi_cd = bes_bookedi_cd					-- 2016/09/02 add
	  WHERE  stk_goods_id = @obj_goods_id
	   and (bes_dw_ekk_flag =1 )								-- 2016/09/02 add	このフラグで制御
	   ORDER BY stk_shop_cd


       -- カーソルを開く
       OPEN @rs2
       -- @P_INOUT_TMPループ
       FETCH NEXT FROM @rs2 INTO
             @res_stk_shop_cd
            ,@res_stk_condition_type
            ,@res_stk_price

       -- レコードがなくなるまで
       While @@FETCH_STATUS = 0 Begin

           -- 店舗別消費税計算区分を取得
           EXEC P_POSAP_Info
                @shop_cd = @res_stk_shop_cd        
               ,@sp = '1'
               ,@sm1_tax_rate = @tax_rate OUTPUT
               ,@sm2_tax_rate_type = @tax_rate_type OUTPUT
           --- 商品マスタ旧標準売価（税込）算出
           SET @res_gds_price_tax = ( CASE  @tax_rate_type 
                                      WHEN  0
                                            THEN  Floor( @res_gds_price * ( 100 + @tax_rate ) / 100 )
                                      WHEN  1
                                            THEN  Cast( Round( @res_gds_price * ( 100 + @tax_rate ) / 100 , 0 ) AS int )
                                            ELSE  Ceiling( @res_gds_price * ( 100 + @tax_rate ) / 100 )
                                      END )
           -- 標準売価（税込）更新対象判定
           IF @res_gds_price_tax =  @res_stk_price
           BEGIN
               -- 商品マスタ新標準売価（税込）算出
               SET @res_zeinuki_teika_tax = 
                                     ( CASE  @tax_rate_type
                                       WHEN  0
                                             THEN  Floor( @e40_zeinuki_teika * ( 100 + @tax_rate ) / 100 )
                                       WHEN  1
                                             THEN  Cast( Round( @e40_zeinuki_teika * ( 100 + @tax_rate ) / 100 , 0 ) AS int )
                                             ELSE  Ceiling( @e40_zeinuki_teika * ( 100 + @tax_rate ) / 100 )
                                       END )

               -- 「在庫マスタ：wpt_stock_master」.「売価（税込）」の更新
               UPDATE wpt_stock_master
               SET    stk_price = @res_zeinuki_teika_tax
                     ,stk_update_date = GETDATE()
               WHERE  stk_shop_cd = @res_stk_shop_cd
               AND    stk_goods_id = @obj_goods_id
               AND    stk_price = @res_gds_price_tax

               -- エラーチェック
               SELECT @rc = @@ERROR
               If @rc <> 0 Begin
                  Set @err_msg = '在庫マスタ更新処理エラー（新品売価）'
                  GOTO SP_ERR
               End
           END -- IF

           FETCH NEXT FROM @rs2 INTO
                 @res_stk_shop_cd
                ,@res_stk_condition_type
                ,@res_stk_price
       END -- While
       -- カーソルを閉じる
       CLOSE @rs2
       -- 開放
       DEALLOCATE  @rs2

-- ▲▲▲ 2015/04/06 update


		DW_ESH_COUNT_RES:
		
		UPDATE wbe_edibook_dw_esh
		SET e40_edi_flag = @a_edi_flag,
			e40_edi_error_msg = @a_edi_error_msg,
			e40_edi_update_date = getdate()
		WHERE e40_edi_id = @e40_edi_id
		
		-- カウント初期レコードセット
		If Not Exists(SELECT top 1 *
			from #count_tbl
			where
			t_exec_id = substring(@edi_type,1,2)
			and
			t_tushin_id = @e40_tushin_id ) Begin
				INSERT INTO #count_tbl (
				t_exec_id
				,t_tushin_id
				,t_count_all
				,t_count_ok
				,t_count_wa
				,t_count_ng
				)
				SELECT
				t_exec_id = substring(@edi_type,1,2)
				,t_tushin_id = @e40_tushin_id
				,t_count_all = 0
				,t_count_ok = 0
				,t_count_wa = 0
				,t_count_ng = 0
		End

		-- 処理カウント更新
		UPDATE #count_tbl SET
			t_count_all = t_count_all + 1
			,t_count_ok = -- 正常
				Case
				when @a_edi_flag = '1' then t_count_ok + 1
				else t_count_ok
				End
			,t_count_wa = -- 警告
				Case
				when @a_edi_flag = '2' then t_count_wa + 1
				else t_count_wa
				End
			,t_count_ng = -- エラー
				Case
				when @a_edi_flag = '3' then t_count_ng + 1
				else t_count_ng
				End
		where
			t_exec_id = substring(@edi_type,1,2)
			and
			t_tushin_id = @e40_tushin_id
		
		fetch next from @rs into
			 @e40_edi_id
			,@e40_bunrui_cd
			,@e40_ecl_hinban
			,@e40_kanji_name
			,@e40_zeinuki_teika
			-- ▼▼▼ 2015/04/06 add
			,@e40_hatubai_date
			-- ▲▲▲ 2015/04/06 add
			,@e40_haiban_date
			,@e40_jan_cd
			,@e40_hinban
			,@e40_bland_name
			,@e40_kyo_tori
			,@e40_tushin_id
			,@e40_tani_name
	End
	-- カーソルを閉じる
	close @rs
	-- 開放
	deallocate @rs

	------------------------------
	-- データ同期
	------------------------------

	Exec @rc = P_EDI_Book_DataCommit
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
	-- エラーチェック
	If @rc <> 0 or @@ERROR <> 0 Begin
		Set @err_msg = '9002,基準曲データ同期エラー'
		GOTO SP_ERR
	End

	------------------------------
	-- ログ出力
	------------------------------
	Exec @rc = P_EDI_Book_WriteLog
		 @edi_type  = @edi_type
		,@edi_server_name = @edi_server_name
		,@edi_db_name = @edi_db_name
		,@server_name = @server_name
		,@db_name  = @db_name
		,@exec_start_time = @a_exec_start_time
	  -- エラーチェック
	If @rc <> 0 or @@ERROR <> 0 Begin
		Set @err_msg = '9003,基準曲データログ出力エラー'
		GOTO SP_ERR
	End

	  -- カウントを返す
	SELECT
		 sum(t_count_all) as count_all
		,sum(t_count_ok) as count_ok
		,sum(t_count_wa) as count_wa
		,sum(t_count_ng) as count_ng
	from
		#count_tbl


	--終了
	GOTO SP_OK

DOWN_ECOLE_ESH_END:

--=================================================
-- 【星光堂】下りブランドマスタのクライアント処理		-- 2013/12/26 add
--=================================================
DOWN_GOODS_ARTIST:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9170,商品アーチストマスタ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_ebl ('
	+ '	 e41_edi_flag'
	+ '	,e41_edi_timestamp'
	+ '	,e41_edi_id'
	+ '	,e41_edi_create_date'
	+ '	,e41_edi_update_date'
	+ '	,e41_edi_file_line_no'
	+ '	,e41_edi_meisai_no'
	+ '	,e41_edi_error_msg'
	+ '	,e41_server_webpos'
	+ '	,e41_dbname_webpos'
	+ '	,e41_shop_cd_webpos'
	+ '	,e41_shop_name_webpos'
	+ '	,e41_seq_no'
	+ '	,e41_shop_cd_primary'
	+ '	,e41_shop_cd'
	+ '	,e41_tushin_id'
	+ '	,e41_data_kbn'
	+ '	,e41_bland_cd'
	+ '	,e41_bland_name'
	+ '	,e41_filler'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e41_edi_flag'
	+ '	,M.e41_edi_timestamp'
	+ '	,M.e41_edi_id'
	+ '	,M.e41_edi_create_date'
	+ '	,M.e41_edi_update_date'
	+ '	,M.e41_edi_file_line_no'
	+ '	,M.e41_edi_meisai_no'
	+ '	,M.e41_edi_error_msg'
	+ '	,M.e41_server_webpos'
	+ '	,M.e41_dbname_webpos'
	+ '	,M.e41_shop_cd_webpos'
	+ '	,M.e41_shop_name_webpos'
	+ '	,M.e41_seq_no'
	+ '	,M.e41_shop_cd_primary'
	+ '	,M.e41_shop_cd'
	+ '	,M.e41_tushin_id'
	+ '	,M.e41_data_kbn'
	+ '	,M.e41_bland_cd'
	+ '	,M.e41_bland_name'
	+ '	,M.e41_filler'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_ebl as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_ebl as C'
	+ '                on M.e41_edi_id = C.e41_edi_id'
	+ '            where'
	+ '              C.e41_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e41_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e41_server_webpos = ''' + @server_name + ''''	--2016/08/18 add
	+ '              and'
	+ '              M.e41_dbname_webpos = ''' + @db_name + ''''	--2016/08/18 add
	+ '            order by '
	+ '              M.e41_edi_id'  -- ID順に取り込む

  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9171,商品アーチストマスタ取得エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e41_edi_id bigint
  Declare @e41_bland_cd varchar(20)
  Declare @e41_bland_name varchar(100)
  Declare @e41_tushin_id char(2)

  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		 e41_edi_id
		,e41_bland_cd
		,e41_bland_name
		,e41_tushin_id
	from
		wbe_edibook_dw_ebl
	order by
		 e41_edi_id

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @e41_edi_id
	,@e41_bland_cd
	,@e41_bland_name
	,@e41_tushin_id

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
    -- ブランドコードチェック
      If @e41_bland_cd is null or rtrim(ltrim(@e41_bland_cd)) = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = 'ブランドコードなし'
            ,@a_edi_flag = '3'  -- エラー

          -- ループ終了まで飛ばす
          GOTO LOOP_END_EBL
      End
	-----------------------------------------------
	-- 基準曲データ追加
	-----------------------------------------------
	If Exists (SELECT * FROM wpt_goods_artist_master WHERE gam_artist_cd = SUBSTRING(@e41_bland_cd,1,10))
		BEGIN
			UPDATE wpt_goods_artist_master 
			SET		gam_update_date = getdate(),
					gam_update_memo = NULL,
					gam_artist_name = @e41_bland_name,
					gam_artist_kana  =NULL
			WHERE	gam_artist_cd = SUBSTRING(@e41_bland_cd,1,10)
		END
     ELSE
		BEGIN
			INSERT INTO wpt_goods_artist_master
			(
				 gam_artist_cd
				,gam_create_date
				,gam_update_date
				,gam_update_memo
				,gam_artist_name
				,gam_artist_kana
			)
			VALUES
			(
				 SUBSTRING(@e41_bland_cd,1,10)
				,getdate()
				,getdate()
				,NULL
				,@e41_bland_name
				,NULL
			)
		END
	SET @a_edi_flag = '1'
	
	-- ループ終了ラベル
    LOOP_END_EBL:
      
	-- カウント初期レコードセット
	If Not Exists(SELECT top 1 *
		from #count_tbl
		where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @e41_tushin_id ) Begin
			INSERT INTO #count_tbl (
			t_exec_id
			,t_tushin_id
			,t_count_all
			,t_count_ok
			,t_count_wa
			,t_count_ng
			)
			SELECT
			t_exec_id = substring(@edi_type,1,2)
			,t_tushin_id = @e41_tushin_id
			,t_count_all = 0
			,t_count_ok = 0
			,t_count_wa = 0
			,t_count_ng = 0
	End
	
	UPDATE wbe_edibook_dw_ebl
      SET
           e41_edi_flag = @a_edi_flag,
           e41_edi_error_msg = @a_edi_error_msg,
           --e41_edi_update_date = @a_getdate
		   e41_edi_update_date = getdate()
      WHERE 
            e41_edi_id = @e41_edi_id

	-- 処理カウント更新
	UPDATE #count_tbl SET
		t_count_all = t_count_all + 1
		,t_count_ok = -- 正常
			Case
			when @a_edi_flag = '1' then t_count_ok + 1
			else t_count_ok
			End
		,t_count_wa = -- 警告
			Case
			when @a_edi_flag = '2' then t_count_wa + 1
			else t_count_wa
			End
		,t_count_ng = -- エラー
			Case
			when @a_edi_flag = '3' then t_count_ng + 1
			else t_count_ng
			End
	where
		t_exec_id = substring(@edi_type,1,2)
		and
		t_tushin_id = @e41_tushin_id

    -- 次へ
    fetch next from @rs into
	 @e41_edi_id
	,@e41_bland_cd
	,@e41_bland_name
	,@e41_tushin_id
  End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9172,商品アーチストマスタ同期エラー'
    GOTO SP_ERR
  End

	------------------------------
	-- ブランド名更新処理		-- 2014/02/27 add
	------------------------------
	Exec P_Brand_Name_Update @sp='1'

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9173,商品アーチストマスタログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl


  --終了
  GOTO SP_OK

DOWN_GOODS_ARTIST_END:

--=================================================
-- 【東京エコール】下りメーカーマスタのクライアント処理
--=================================================
DOWN_MAKER:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9150,メーカーマスタ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_emk ('
	+ '	 e42_edi_flag'
	+ '	,e42_edi_timestamp'
	+ '	,e42_edi_id'
	+ '	,e42_edi_create_date'
	+ '	,e42_edi_update_date'
	+ '	,e42_edi_file_line_no'
	+ '	,e42_edi_meisai_no'
	+ '	,e42_edi_error_msg'
	+ '	,e42_server_webpos'
	+ '	,e42_dbname_webpos'
	+ '	,e42_shop_cd_webpos'
	+ '	,e42_shop_name_webpos'
	+ '	,e42_seq_no'
	+ '	,e42_shop_cd_primary'
	+ '	,e42_shop_cd'
	+ '	,e42_tushin_id'
	+ '	,e42_data_kbn'
	+ '	,e42_maker_cd'
	+ '	,e42_maker_name'
	+ '	,e42_filler'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e42_edi_flag'
	+ '	,M.e42_edi_timestamp'
	+ '	,M.e42_edi_id'
	+ '	,M.e42_edi_create_date'
	+ '	,M.e42_edi_update_date'
	+ '	,M.e42_edi_file_line_no'
	+ '	,M.e42_edi_meisai_no'
	+ '	,M.e42_edi_error_msg'
	+ '	,M.e42_server_webpos'
	+ '	,M.e42_dbname_webpos'
	+ '	,M.e42_shop_cd_webpos'
	+ '	,M.e42_shop_name_webpos'
	+ '	,M.e42_seq_no'
	+ '	,M.e42_shop_cd_primary'
	+ '	,M.e42_shop_cd'
	+ '	,M.e42_tushin_id'
	+ '	,M.e42_data_kbn'
	+ '	,M.e42_maker_cd'
	+ '	,M.e42_maker_name'
	+ '	,M.e42_filler'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_emk as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_emk as C'
	+ '                on M.e42_edi_id = C.e42_edi_id'
	+ '            where'
	+ '              C.e42_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e42_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e42_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e42_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9151,メーカーマスタデータ抽出エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e42_edi_id		bigint				--ID
  Declare @e42_maker_cd		varchar (20)		--メーカーコード
  Declare @e42_maker_name	varchar (100)		--メーカー名称
  Declare @e42_filler		varchar (200)		--予備
  Declare @a_supplier1_id	int					--仕入先ＩＤ１
  Declare @e42_tushin_id	char(2)				--取次先コード
  
  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		e42_edi_id
		,e42_maker_cd
		,e42_maker_name
		,e42_filler
		,e42_tushin_id
	FROM wbe_edibook_dw_emk
	WHERE e42_edi_flag = '0' -- 未処理


  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	@e42_edi_id
	,@e42_maker_cd		
	,@e42_maker_name	
	,@e42_filler	
	,@e42_tushin_id	

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
	  Set @a_edi_flag = '1'
	  Set @a_edi_error_msg = NULL	
      -- メーカーコードチェック
      If @e42_maker_cd is null or rtrim(ltrim(@e42_maker_cd)) = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = 'メーカーコードなし'
            ,@a_edi_flag = '3'  -- エラー

          -- ループ終了まで飛ばす
          GOTO LOOP_END_EMK
      End
	 -- メーカ販売元マスタ
     If Exists (SELECT * FROM wpt_maker_sales_master WHERE msm_sales_cd =  'ECOLE-' + LEFT(@e42_maker_cd,4)) --更新：2014/01/27
		BEGIN
			UPDATE wpt_maker_sales_master 
			SET		msm_update_date = GETDATE(),
					msm_update_memo = NULL,
					msm_sales_name  = @e42_maker_name
			WHERE	msm_sales_cd = 'ECOLE-' + LEFT(@e42_maker_cd,4)	--更新：2014/01/27
		END
     ELSE
		BEGIN
			INSERT INTO wpt_maker_sales_master
			VALUES ('ECOLE-' + LEFT(@e42_maker_cd,4),				--更新：2014/01/27
					GETDATE(),
					GETDATE(),
					NULL,
					@e42_maker_name)
		END
     
     --メーカレーベルマスタ
     If Exists (SELECT * FROM wpt_maker_label_master WHERE LEFT(mlm_label_cd,10) =  'ECOLE-' + LEFT(@e42_maker_cd,4))	--更新：2014/01/27
		 BEGIN
			UPDATE wpt_maker_label_master 
			SET		mlm_update_date = GETDATE(),
					mlm_update_memo = NULL,
					mlm_label_name  = @e42_maker_name,
					mlm_sales_cd  = 'ECOLE-' + LEFT(@e42_maker_cd,4)			--更新：2014/01/27
			WHERE	LEFT(mlm_label_cd,10) =  'ECOLE-' + LEFT(@e42_maker_cd,4)	--更新：2014/01/27
		 END
     ELSE
		 BEGIN
			INSERT INTO wpt_maker_label_master
			VALUES ('ECOLE-' + LEFT(@e42_maker_cd,4),		--更新：2014/01/27
					GETDATE(),
					GETDATE(),
					NULL,
					@e42_maker_name,
					'ECOLE-' + LEFT(@e42_maker_cd,4))		--更新：2014/01/27
		 END 
		
	 --メーカ販売元設定
     If NOT Exists (SELECT * FROM wpt_maker_sales_setting WHERE mss_sales_cd =  'ECOLE-' + LEFT(@e42_maker_cd,4))	--更新：2014/01/27
	 BEGIN
	 
		SET @a_supplier1_id = (SELECT TOP 1 mpm_supplier_id FROM wpt_maker_supplier_master WHERE mpm_bookedi_cd = 'EC')
		
		INSERT INTO wpt_maker_sales_setting (mss_sales_cd, 
											mss_shop_cd, 
											mss_supplier1_id, 
											mss_supplier2_id, 
											mss_supplier3_id, 
											mss_supplier4_id, 
											mss_supplier5_id)
			SELECT	'ECOLE-' + LEFT(@e42_maker_cd,4),			--更新：2014/01/27
					shm_shop_cd,
					ISNULL(@a_supplier1_id,0),
					0,
					0,
					0,
					0
			FROM wpt_shop_master 
			WHERE shm_delete_flag = '0' 
	 END 

      -- ループ終了ラベル
      LOOP_END_EMK:

      -- 処理結果記録
      Set @a_getdate = getdate()
      
      UPDATE wbe_edibook_dw_emk 
      SET
           e42_edi_flag = @a_edi_flag,
           e42_edi_error_msg = @a_edi_error_msg,
           e42_edi_update_date = @a_getdate
      WHERE 
            e42_edi_id = @e42_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @e42_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @e42_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @e42_tushin_id

      -- 次へ
      fetch next from @rs into
		@e42_edi_id
		,@e42_maker_cd		
		,@e42_maker_name	
		,@e42_filler	
		,@e42_tushin_id
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9152,メーカーマスタデータ同期エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9153,メーカーマスタログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_MAKER_END:
--=================================================
-- 【東京エコール】EDI下り分類マスタのクライント処理
--=================================================
DOWN_BUNRUI:

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9180,分類マスタ情報セット不正'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_ebr ('
	+ '	 e43_edi_flag'
	+ '	,e43_edi_timestamp'
	+ '	,e43_edi_id'
	+ '	,e43_edi_create_date'
	+ '	,e43_edi_update_date'
	+ '	,e43_edi_file_line_no'
	+ '	,e43_edi_meisai_no'
	+ '	,e43_edi_error_msg'
	+ '	,e43_server_webpos'
	+ '	,e43_dbname_webpos'
	+ '	,e43_shop_cd_webpos'
	+ '	,e43_shop_name_webpos'
	+ '	,e43_seq_no'
	+ '	,e43_shop_cd_primary'
	+ '	,e43_shop_cd'
	+ '	,e43_tushin_id'
	+ '	,e43_data_kbn'
	+ '	,e43_bunrui_cd'
	+ '	,e43_bunrui_name'
	+ '	,e43_bunrui_kana_name'
	+ '	,e43_filler'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e43_edi_flag'
	+ '	,M.e43_edi_timestamp'
	+ '	,M.e43_edi_id'
	+ '	,M.e43_edi_create_date'
	+ '	,M.e43_edi_update_date'
	+ '	,M.e43_edi_file_line_no'
	+ '	,M.e43_edi_meisai_no'
	+ '	,M.e43_edi_error_msg'
	+ '	,M.e43_server_webpos'
	+ '	,M.e43_dbname_webpos'
	+ '	,M.e43_shop_cd_webpos'
	+ '	,M.e43_shop_name_webpos'
	+ '	,M.e43_seq_no'
	+ '	,M.e43_shop_cd_primary'
	+ '	,M.e43_shop_cd'
	+ '	,M.e43_tushin_id'
	+ '	,M.e43_data_kbn'
	+ '	,M.e43_bunrui_cd'
	+ '	,M.e43_bunrui_name'
	+ '	,M.e43_bunrui_kana_name'
	+ '	,M.e43_filler'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_ebr as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_ebr as C'
	+ '                on M.e43_edi_id = C.e43_edi_id'
	+ '            where'
	+ '              C.e43_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e43_edi_flag = ''0'''  -- 未処理
	+ '              and'
	+ '              M.e43_server_webpos = ''' + @server_name + ''''
	+ '              and'
	+ '              M.e43_dbname_webpos = ''' + @db_name + ''''
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9181,分類マスタデータ抽出エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e43_edi_id					bigint				--ID
  Declare @e43_bunrui_cd				varchar (10)		--分類コード
  Declare @e43_bunrui_name				varchar (100)		--分類名称
  Declare @e43_bunrui_kana_name			varchar (100)		--分類カナ名称
  Declare @a_mediastore_bunrui_cd		varchar (10)		--Mediastore側の分類コード
  Declare @e43_tushin_id				char(2)				--取次先コード
  Declare @a_media_group_id				int					--メディアグループＩＤ
  
  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		e43_edi_id
		,e43_bunrui_cd
		,e43_bunrui_name
		,e43_bunrui_kana_name
		,e43_tushin_id
	FROM wbe_edibook_dw_ebr
	WHERE e43_edi_flag = '0' -- 未処理


  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	@e43_edi_id
	,@e43_bunrui_cd		
	,@e43_bunrui_name	
	,@e43_bunrui_kana_name	
	,@e43_tushin_id	

    -- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
	  Set @a_edi_flag = '1'
	  Set @a_edi_error_msg = NULL	
	  Set @a_mediastore_bunrui_cd = NULL
	  Set @a_media_group_id = NULL
	  Set @rc = 0
	  
      -- Mediastore側の分類コードチェック
 	-- ▼▼▼ 2014/02/17 update
      --Set @a_mediastore_bunrui_cd = (	SELECT TOP 1 mcb_media_cd 
						--				FROM wpt_goods_media_convert_book 
						--				WHERE mcb_convert_type = '4' AND mcb_c_code =  @e43_bunrui_cd )
	  SELECT @a_mediastore_bunrui_cd = dbo.F_Search_Ecole_Media('0',@e43_bunrui_cd,'')
	-- ▲▲▲ 2014/02/17 update
	     
      If @a_mediastore_bunrui_cd is null or rtrim(ltrim(@a_mediastore_bunrui_cd)) = '' Begin
          -- エラー記録
          SELECT
             @a_edi_error_msg = '商品メディア変換未登録'
            ,@a_edi_flag = '3'  -- エラー

          -- ループ終了まで飛ばす
          GOTO LOOP_END_EBR
      End
      
      -- 商品メディアマスタ
      Set @a_media_group_id = (	SELECT TOP 1 gmg_media_group_id 
								FROM wpt_goods_media_group_master 
								WHERE gmg_media_group_cd = '8440')
								
      If Exists ( SELECT gdm_media_cd FROM wpt_goods_media_master WHERE gdm_media_cd = @a_mediastore_bunrui_cd )
		  BEGIN
			UPDATE wpt_goods_media_master									
			SET gdm_update_date = GETDATE(),					--更新日
				gdm_update_memo = NULL,							--更新区分
-- ▼▼▼ 2014/07/01 update
--				gdm_media_group_id = @a_media_group_id,			--メディアグループＩＤ
				gdm_media_group_id =
					Case 
						When gdm_media_group_id Is Null Then @a_media_group_id	-- NULL値の場合のみ、8440:文具をセット
						Else gdm_media_group_id									-- セット済みの場合は、更新しない
					End,
-- ▲▲▲ 2014/07/01 update
				gdm_shop_cd = NULL,								--店舗コード
				gdm_media_name = @e43_bunrui_name,				--メディア名
				gdm_media_ryaku = NULL,							--メディア名略称
				gdm_media_kana = @e43_bunrui_kana_name,			--メディア名カナ
				gdm_sort_type = '0'								--出力順区分
			WHERE gdm_media_cd = @a_mediastore_bunrui_cd
			Set @rc = @@ERROR
		  END											
      ELSE												
		  BEGIN
			INSERT INTO wpt_goods_media_master 
			VALUES (GETDATE(),								--作成日
					GETDATE(),								--更新日
					NULL,									--更新区分
					@a_mediastore_bunrui_cd,				--メディアコード
					@a_media_group_id,						--メディアグループＩＤ
					NULL,									--店舗コード
					@e43_bunrui_name,						--メディア名
					NULL,									--メディア名略称
					@e43_bunrui_kana_name,					--メディア名カナ
					'0')									--出力順区分
			Set @rc = @@ERROR
		  END
		  
      If @rc <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = '商品メディアマスタ更新エラー'
                  + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
             ,@a_edi_flag = '2'  -- 警告
             
             -- ループ終了まで飛ばす
			 GOTO LOOP_END_EBR
      End
      
      --商品メディア大分類マスタ
      If Not Exists ( SELECT gm1_media_group1_cd FROM wpt_goods_media_group1_master WHERE gm1_media_group1_cd = '5' )
		BEGIN
			INSERT INTO wpt_goods_media_group1_master 
			VALUES ('5',				--メディア大分類コード
					GETDATE(),			--作成日
					GETDATE(),			--更新日
					NULL,				--更新区分
					'文具')				--メディア大分類名
			Set @rc = @@ERROR
		  END
	
	  If @rc <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = '商品メディア大分類マスタ挿入エラー'
                  + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
             ,@a_edi_flag = '2'  -- 警告
             
             -- ループ終了まで飛ばす
			 GOTO LOOP_END_EBR
      End
      
      
      --商品メディア中分類マスタ
      If Exists ( SELECT * 
				  FROM wpt_goods_media_group2_master 
				  WHERE LEFT(gm2_media_group1_cd,1) = LEFT(@a_mediastore_bunrui_cd,1)
				  AND	LEFT(gm2_media_group2_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,2,1) )
		  BEGIN
			UPDATE wpt_goods_media_group2_master									
			SET gm2_update_date = GETDATE(),					--更新日
				gm2_update_memo = NULL,							--更新区分
				gm2_media_group2_name = (CASE RIGHT(@a_mediastore_bunrui_cd,3)					--メディア中分類名
										 WHEN '000' THEN @e43_bunrui_name 
										 ELSE gm2_media_group2_name
										 END)						
			WHERE	LEFT(gm2_media_group1_cd,1) = LEFT(@a_mediastore_bunrui_cd,1)				--メディア大分類コード
			AND		LEFT(gm2_media_group2_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,2,1)		--メディア中分類コード
			Set @rc = @@ERROR
		  END											
      ELSE												
		  BEGIN
			INSERT INTO wpt_goods_media_group2_master 
			VALUES (LEFT(@a_mediastore_bunrui_cd,1),		--メディア大分類コード
					SUBSTRING(@a_mediastore_bunrui_cd,2,1),	--メディア中分類コード
					GETDATE(),								--作成日
					GETDATE(),								--更新日
					NULL,									--更新区分
					CASE RIGHT(@a_mediastore_bunrui_cd,3)	--メディア中分類名
					WHEN '000' THEN @e43_bunrui_name 
					ELSE NULL
					END
					)						
			Set @rc = @@ERROR
		  END
		  
      If @rc <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = '商品メディア中分類マスタ更新エラー'
                  + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
             ,@a_edi_flag = '2'  -- 警告
             
             -- ループ終了まで飛ばす
			 GOTO LOOP_END_EBR
      End
      
      --商品メディア中小分類マスタ
      If Exists ( SELECT * 
				  FROM wpt_goods_media_group3_master 
				  WHERE LEFT(gm3_media_group1_cd,1) = LEFT(@a_mediastore_bunrui_cd,1)
				  AND	LEFT(gm3_media_group2_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,2,1) 
				  AND	LEFT(gm3_media_group3_cd,2) = SUBSTRING(@a_mediastore_bunrui_cd,3,2) )
		  BEGIN
			UPDATE wpt_goods_media_group3_master									
			SET gm3_update_date = GETDATE(),												--更新日
				gm3_update_memo = NULL,														--更新区分
				gm3_media_group3_name = (CASE 												--メディア中小分類名
										 WHEN RIGHT(@a_mediastore_bunrui_cd,3) = '000' THEN gm3_media_group3_name --更新：2014/01/28
										 WHEN RIGHT(@a_mediastore_bunrui_cd,1) = '0' THEN @e43_bunrui_name 
										 ELSE gm3_media_group3_name
										 END)						
			WHERE	LEFT(gm3_media_group1_cd,1) = LEFT(@a_mediastore_bunrui_cd,1)			--メディア大分類コード
			AND		LEFT(gm3_media_group2_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,2,1)	--メディア中分類コード
			AND		LEFT(gm3_media_group3_cd,2) = SUBSTRING(@a_mediastore_bunrui_cd,3,2)	--メディア中小分類コード
			Set @rc = @@ERROR
		  END											
      ELSE												
		  BEGIN
			INSERT INTO wpt_goods_media_group3_master 
			VALUES (LEFT(@a_mediastore_bunrui_cd,1),									--メディア大分類コード
					SUBSTRING(@a_mediastore_bunrui_cd,2,1),								--メディア中分類コード
					SUBSTRING(@a_mediastore_bunrui_cd,3,2),								--メディア中小分類コード
					GETDATE(),															--作成日
					GETDATE(),															--更新日
					NULL,																--更新区分
					CASE 	--メディア中小分類名
					WHEN RIGHT(@a_mediastore_bunrui_cd,3) = '000' THEN NULL				--更新：2014/01/28
					WHEN RIGHT(@a_mediastore_bunrui_cd,1) = '0' THEN @e43_bunrui_name 
					ELSE NULL
					END
					)						
			Set @rc = @@ERROR
		  END
		  
      If @rc <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = '商品メディア中小分類マスタ更新エラー'
                  + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
             ,@a_edi_flag = '2'  -- 警告
             
             -- ループ終了まで飛ばす
			 GOTO LOOP_END_EBR
      End
      
      --商品メディア小分類マスタ
      If Exists ( SELECT * 
				  FROM wpt_goods_media_group4_master 
				  WHERE LEFT(gm4_media_group1_cd,1) = LEFT(@a_mediastore_bunrui_cd,1)
				  AND	LEFT(gm4_media_group2_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,2,1)
				  AND	LEFT(gm4_media_group3_cd,2) = SUBSTRING(@a_mediastore_bunrui_cd,3,2)
				  AND	LEFT(gm4_media_group4_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,5,1) )
		  BEGIN
			UPDATE wpt_goods_media_group4_master									
			SET gm4_update_date = GETDATE(),					--更新日
				gm4_update_memo = NULL,							--更新区分
				gm4_media_group4_name = (CASE  					--メディア小分類名	--更新：2014/01/28
										 WHEN RIGHT(@a_mediastore_bunrui_cd,1) <> '0' THEN @e43_bunrui_name 
										 ELSE gm4_media_group4_name
										 END)			
			WHERE	LEFT(gm4_media_group1_cd,1) = LEFT(@a_mediastore_bunrui_cd,1)				--メディア大分類コード
			AND		LEFT(gm4_media_group2_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,2,1)		--メディア中分類コード
			AND		LEFT(gm4_media_group3_cd,2) = SUBSTRING(@a_mediastore_bunrui_cd,3,2)		--メディア中小分類コード
			AND		LEFT(gm4_media_group4_cd,1) = SUBSTRING(@a_mediastore_bunrui_cd,5,1)		--メディア小分類コード
			Set @rc = @@ERROR
		  END											
      ELSE												
		  BEGIN
			INSERT INTO wpt_goods_media_group4_master 
			VALUES (LEFT(@a_mediastore_bunrui_cd,1),				--メディア大分類コード
					SUBSTRING(@a_mediastore_bunrui_cd,2,1),			--メディア中分類コード
					SUBSTRING(@a_mediastore_bunrui_cd,3,2),			--メディア中小分類コード
					SUBSTRING(@a_mediastore_bunrui_cd,5,1),			--メディア小分類コード
					GETDATE(),										--作成日
					GETDATE(),										--更新日
					NULL,											--更新区分
					(CASE  											--メディア小分類名	--更新：2014/01/28
					 WHEN RIGHT(@a_mediastore_bunrui_cd,1) <> '0' THEN @e43_bunrui_name 
					 ELSE NULL
					 END)									
					)						
			Set @rc = @@ERROR
		  END
		  
      If @rc <> 0 Begin
           -- エラー記録
           SELECT
              @a_edi_error_msg = '商品メディア小分類マスタ更新エラー'
                  + ' rc = [' + isnull(convert(varchar,@rc),'') + ']'
             ,@a_edi_flag = '2'  -- 警告
             
             -- ループ終了まで飛ばす
			 GOTO LOOP_END_EBR
      End
      
      -- ループ終了ラベル
      LOOP_END_EBR:

      -- 処理結果記録
      Set @a_getdate = getdate()
      
      UPDATE wbe_edibook_dw_ebr 
      SET
           e43_edi_flag = @a_edi_flag,
           e43_edi_error_msg = @a_edi_error_msg,
           e43_edi_update_date = @a_getdate
      WHERE 
            e43_edi_id = @e43_edi_id

      -- カウント初期レコードセット
      If Not Exists(SELECT top 1 *
                    from #count_tbl
                    where
                      t_exec_id = substring(@edi_type,1,2)
                      and
                      t_tushin_id = @e43_tushin_id ) Begin
        INSERT INTO #count_tbl (
            t_exec_id
           ,t_tushin_id
           ,t_count_all
           ,t_count_ok
           ,t_count_wa
           ,t_count_ng
          )
          SELECT
            t_exec_id = substring(@edi_type,1,2)
           ,t_tushin_id = @e43_tushin_id
           ,t_count_all = 0
           ,t_count_ok = 0
           ,t_count_wa = 0
           ,t_count_ng = 0
      End

      -- 処理カウント更新
      UPDATE #count_tbl SET
         t_count_all = t_count_all + 1
        ,t_count_ok = -- 正常
             Case
               when @a_edi_flag = '1' then t_count_ok + 1
               else t_count_ok
             End
        ,t_count_wa = -- 警告
             Case
               when @a_edi_flag = '2' then t_count_wa + 1
               else t_count_wa
             End
        ,t_count_ng = -- エラー
             Case
               when @a_edi_flag = '3' then t_count_ng + 1
               else t_count_ng
             End
        where
           t_exec_id = substring(@edi_type,1,2)
           and
           t_tushin_id = @e43_tushin_id

      -- 次へ
      fetch next from @rs into
		@e43_edi_id
		,@e43_bunrui_cd		
		,@e43_bunrui_name	
		,@e43_bunrui_kana_name	
		,@e43_tushin_id
    End  -- While

  -- カーソルを閉じる
  close @rs
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9182,分類マスタ同期エラー'
    GOTO SP_ERR
  End


  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9183,分類マスタログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_BUNRUI_END:

--=================================================
-- EDI下り発注データクライアント処理				-- 追加：2014/03/31
--=================================================
DOWN_ORDER_DATA:


print 'エコール発注下り開始'
print @edi_type
print @edi_server_name
print @edi_db_name
print @server_name
print @db_name

  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    Set @err_msg = '9190,発注データ情報セット不正'
    GOTO SP_ERR
  End

print 'エコール発注下り開始２'
  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_ehc ('
	+ '	 e44_edi_flag'
	+ '	,e44_edi_timestamp'
	+ '	,e44_edi_id'
	+ '	,e44_edi_create_date'
	+ '	,e44_edi_update_date'
	+ '	,e44_edi_file_line_no'
	+ '	,e44_edi_meisai_no'
	+ '	,e44_edi_error_msg'
	+ '	,e44_server_webpos'
	+ '	,e44_dbname_webpos'
	+ '	,e44_shop_cd_webpos'
	+ '	,e44_shop_name_webpos'
	+ '	,e44_seq_no'
	+ '	,e44_shop_cd_primary'
	+ '	,e44_shop_cd'
	+ '	,e44_tushin_id'
	+ '	,e44_sakusei_date'
	+ '	,e44_den_date'
	+ '	,e44_den_no'
	+ '	,e44_den_gno'
	+ '	,e44_bikou'
	+ '	,e44_location_cd'
	+ '	,e44_hachu_date'
	+ '	,e44_ecl_hinban'
	+ '	,e44_jan_cd'
	+ '	,e44_ehc_kbn'
	+ '	,e44_ehc_su'
	+ '	,e44_filler'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e44_edi_flag'
	+ '	,M.e44_edi_timestamp'
	+ '	,M.e44_edi_id'
	+ '	,M.e44_edi_create_date'
	+ '	,M.e44_edi_update_date'
	+ '	,M.e44_edi_file_line_no'
	+ '	,M.e44_edi_meisai_no'
	+ '	,M.e44_edi_error_msg'
	+ '	,M.e44_server_webpos'
	+ '	,M.e44_dbname_webpos'
	+ '	,M.e44_shop_cd_webpos'
	+ '	,M.e44_shop_name_webpos'
	+ '	,M.e44_seq_no'
	+ '	,M.e44_shop_cd_primary'
	+ '	,M.e44_shop_cd'
	+ '	,M.e44_tushin_id'
	+ '	,M.e44_sakusei_date'
	+ '	,M.e44_den_date'
	+ '	,M.e44_den_no'
	+ '	,M.e44_den_gno'
	+ '	,M.e44_bikou'
	+ '	,M.e44_location_cd'
	+ '	,M.e44_hachu_date'
	+ '	,M.e44_ecl_hinban'
	+ '	,M.e44_jan_cd'
	+ '	,M.e44_ehc_kbn'
	+ '	,M.e44_ehc_su'
	+ '	,M.e44_filler'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_ehc as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_ehc as C'
	+ '                on M.e44_edi_id = C.e44_edi_id'
	+ '            where'
	+ '              C.e44_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e44_edi_flag = ''0'''  -- 未処理
	+ '				 and'
	+ '				 M.e44_server_webpos = ''' + @server_name + ''''
	+ '				 and'
	+ '				 M.e44_dbname_webpos = ''' + @db_name + ''''
	+ '            order by '
	+ '              M.e44_edi_id'  -- ID順に取り込む

print @a_sql

  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9191,発注データ取得エラー'
    GOTO SP_ERR
  End

print 'エコール発注下り開始３'

  ------------------------------
  -- データ読み込み
  ------------------------------
  Declare @e44_edi_id bigint
  Declare @e44_tushin_id char(2)
  Declare @e44_shop_cd varchar(10)
  Declare @e44_sakusei_date char(8)
  Declare @e44_den_date char(8)
  Declare @e44_den_no int
  Declare @e44_pre_den_no int
  Declare @e44_den_gno int
  Declare @e44_bikou varchar(100)
  Declare @e44_location_cd varchar(9)
  Declare @e44_hachu_date char(8)
  Declare @e44_ecl_hinban varchar(20)
  Declare @e44_jan_cd varchar(13)
  Declare @e44_ehc_kbn char(1)
  Declare @e44_ehc_su int
  --追加：2014/04/08 - Comment 8
  Declare @SupplierId int						--仕入先ID
  Declare @SupplierCd int						--仕入先コード
  Declare @e44_shop_cd_webpos varchar(10)		--MS店舗コード
  Declare @e44_pre_shop_cd_webpos varchar(10)	--MS店舗コード
  
  
  --Declare @MS_SHOPCD varchar(100)			--削除：2014/04/08 - Comment 8
  Declare @plu_gds_goods_id int
  -- 追加元trn_id用
  Declare @out_trn_id int
  Declare @pre_trn_id int
  -- 一時テーブル読み込み
  Set @rs = cursor static for
	SELECT
		 e44_edi_id
		,e44_tushin_id
		,e44_sakusei_date
		,e44_den_date 
		,e44_den_no 
		,e44_den_gno 
		,e44_bikou 
		,e44_location_cd 
		,e44_hachu_date 
		,e44_ecl_hinban 
		,e44_jan_cd 
		,e44_ehc_kbn 
		,e44_ehc_su 
		,e44_shop_cd
-- ★★★　e44_shop_cd_webpos　を追加（MS側の店舗コード）
		,e44_shop_cd_webpos				--MS店舗コード　追加：2014/04/08 - Comment 8
	from
		wbe_edibook_dw_ehc
-- ★★★	未処理分のみ抽出する条件を追加
	where 	e44_edi_flag = '0'			--未処理　追加：2014/04/08 - Comment 8
	order by
-- ★★★	複数の店舗で同じ伝票番号も考えられる為、店舗コード＞伝票番号＞行番号　の並び順で抽出
		 e44_shop_cd_webpos, e44_den_no, e44_den_gno		--追加：2014/04/08 - Comment 8

  -- カーソルを開く
  open @rs

  -- @P_INOUT_TMPループ
  fetch next from @rs into
	 @e44_edi_id
	,@e44_tushin_id
	,@e44_sakusei_date
	,@e44_den_date 
	,@e44_den_no 
	,@e44_den_gno 
	,@e44_bikou 
	,@e44_location_cd 
	,@e44_hachu_date 
	,@e44_ecl_hinban 
	,@e44_jan_cd 
	,@e44_ehc_kbn 
	,@e44_ehc_su 
	,@e44_shop_cd
	,@e44_shop_cd_webpos
	
    ---- レコードがなくなるまで
    While @@FETCH_STATUS = 0 Begin
		Set @a_edi_flag = '1'
		Set @a_edi_error_msg = null

print 'エコール発注下り開始 レコード処理'

-- ★★★　上記レコードセットでe44_shop_cd_webposを取得しておけば不要
--削除：2014/04/08 - Comment 8
/*
		-----------------------------------------------
		-- Get「MS店舗コード」
		-----------------------------------------------
		SET @MS_SHOPCD =  (SELECT TOP 1 bes_shop_cd
							FROM wpt_book_edi_setting
							WHERE	bes_bookedi_cd		= 'EC'
							AND		bes_book_shop_cd	= @e44_shop_cd)
*/

		-----------------------------------------------
		-- Get「商品ID」
		-----------------------------------------------
		exec P_PLU	@plu_cd = @e44_ecl_hinban, 
					@plu_type = '1',
					@sp = '1',
					@gds_goods_id = @plu_gds_goods_id   OUTPUT
		-----------------------------------------------			
		-- Get「仕入先ID」、「仕入先コード」
		-- 追加：2014/04/08 - Comment 8
		-----------------------------------------------
		Select TOP 1 @SupplierId = mpm_supplier_id , @SupplierCd = mpm_supplier_cd
		From wpt_maker_supplier_master 
		Where mpm_bookedi_cd = 'EC'
			-- mpm_shop_cd	= @e44_shop_cd_webpos
		-----------------------------------------------
		
-- ★★★　検索条件はECのみ店舗コードは不要
		--SET @SupplierId = (Select TOP 1 mpm_supplier_id 
		--					From wpt_maker_supplier_master 
		--					Where mpm_bookedi_cd = 'EC')
		--					AND mpm_shop_cd	= @MS_SHOPCD)
									
		  If @SupplierId is null or rtrim(ltrim(@SupplierId)) = '' Begin
			  -- エラー記録
			  SELECT
				 @a_edi_error_msg = '仕入先ＩＤなし'
				,@a_edi_flag = '3'  -- エラー

			  -- ループ終了まで飛ばす
			  GOTO LOOP_END_ehc
		  End		
		
-- ★★★　条件に店舗コードも追加した方が良い
		If @e44_pre_den_no IS NOT NULL AND	@e44_pre_den_no			= @e44_den_no 
									   AND	@e44_pre_shop_cd_webpos = @e44_shop_cd_webpos	Begin							   
			If exists (select Top 1 * from wpt_transaction_hachu_details
					   Where tdh_trn_id = @pre_trn_id and
							 tdh_line_no = @e44_den_gno) Begin
				SELECT
				 @a_edi_error_msg = '取引ＩＤ、明細番号の値が既に取引発注詳細テーブルで登録されています。'
				,@a_edi_flag = '3'  -- エラー	
				-- ループ終了まで飛ばす
				GOTO LOOP_END_ehc						 
			End						 
		End
		  	
		-----------------------------------------------
		-- 取引発注トランザクションデータ
		-----------------------------------------------
		-- P_Transactionパラメータ作成
		 SELECT
			 @P01 = ''
				+ '0002.0001'     														-- パラメタ受け渡しバージョン
				+ ',' + object_name(@@PROCID)           								-- アプリケーションバージョン
				--+ ',' + isnull(cast(@MS_SHOPCD as varchar),'')                   		-- MS店舗コード 削除：2014/04/08 - Comment 8
				+ ',' + isnull(cast(@e44_shop_cd_webpos as varchar),'')                 -- MS店舗コード 追加：2014/04/08 - Comment 8　
-- ▼▼▼ 2014/04/11 update
--				+ ',0201'					        									-- 業務区分
				+ ',0205'					        									-- 業務区分
-- ▲▲▲ 2014/04/11 update
				+ ',0'                                                                 	-- 伝票区分
				+ ',0'                                                                 	-- POS番号
				+ ',' + convert(varchar,
						case
						   when isdate(@e44_hachu_date) = 1 then cast(@e44_hachu_date as datetime)
						   else 0
						 end
						 ,120)                                                        	-- 取引日
				+ ',' + convert(varchar,getdate(),120)                    				-- ＰＯＳ取引日時
				+ ','                                                                  	-- レシート番号
				+ ','                                                                  	-- 担当ＩＤ
				+ ','                                                                  	-- 担当コード
				+ ','                                                                  	-- 会員ＩＤ
				+ ','                                                                  	-- 会員コード
				+ ','                                                                  	-- 会員カードコード
				--+ ',' + isnull(cast(@MS_SHOPCD as varchar),'')                   		-- 操作店舗コード 削除：2014/04/08 - Comment 8
				+ ',' + isnull(cast(@e44_shop_cd_webpos as varchar),'')     			-- 操作店舗コード 追加：2014/04/08 - Comment 8
				+ ','                                                                  	-- 紐付け元取引ＩＤ
				+ ','                                                                  	-- 紐付け元業務区分
-- ★★★店舗コードも条件に追加する
--   違う店舗で同一の伝票番号がある可能性がある為
				+ ',' + case															-- 追加処理用取引ＩＤ
							when	@e44_pre_den_no IS NOT NULL AND	@e44_pre_den_no = @e44_den_no 
							and		@e44_pre_shop_cd_webpos = @e44_shop_cd_webpos
								then isnull(cast(@pre_trn_id as varchar),'')
								else ''
						 end
				+ ',0'																	-- 再登録フラグ    
			,@P02 = ''
				+ '2'																	-- 取引区分
																						
			,@P03 = ''
				+ isnull(cast(@e44_den_gno as varchar),'')                  			-- 明細番号
				+ ',1'												       				-- 発注区分
				+ ',' + isnull(cast(@plu_gds_goods_id as varchar),'')       			-- 商品ID
				+ ',' 							       									-- 固有商品コード
				+ ',' 						         									-- JAN
				+ ',' 							      									-- 商品名
				+ ',0' 							      									-- 税区分
-- ★★★SPパラメ－タの生成するところでのselect文はせず、
--   事前に仕入先IDや仕入先コードを変数にセットしておき、その変数を使う。
--ここで２回selectするのは処理に時間がかかる
				--更新：2014/04/08 - Comment 8 - Start
				/*+ ',' + isnull(cast((Select TOP 1 mpm_supplier_id 
									From wpt_maker_supplier_master 
									Where mpm_bookedi_cd = 'EC'
									AND mpm_shop_cd	= @MS_SHOPCD)as varchar),'')		-- 仕入ＩＤ
				+ ',' + isnull(cast((Select TOP 1 mpm_supplier_cd 
									From wpt_maker_supplier_master 
									Where mpm_bookedi_cd = 'EC'
									AND mpm_shop_cd	= @MS_SHOPCD)as varchar),'')		-- 仕入コード*/
				+ ',' + isnull(cast((@SupplierId)as varchar),'')		-- 仕入ＩＤ
				+ ',' + isnull(cast((@SupplierCd)as varchar),'')		-- 仕入コード
				--更新：2014/04/08 - Comment 8 - End
				+ ',0'							        								-- 標準売価
				+ ',0' 							   										-- 標準原価
				+ ',0'																	-- 売価単価
				+ ',0' 																	-- 原価単価
				+ ',' + isnull(cast(@e44_ehc_su as varchar),'')							-- 発注数
				+ ',0'                                                                  -- 予約数
				+ ',' + isnull(cast(@e44_bikou as varchar),'')							-- 客注メモ
				+ ','                                                                  	-- 書籍取次常備コード
				+ ',' + isnull(cast(@e44_location_cd as varchar),'')					-- 棚コード
				+ ',1'                                                                  -- 電話発注区分
				+ ',0'                                                                  -- バック区分
				+ ',' + isnull(cast(@e44_den_no as varchar),'')							-- 発注番号
-- ★★★　ここで伝票単位のトランザクションになるか？
			 -- 伝票単位でトランザクション処理する
			 --BEGIN TRAN, COMMIT,ROLLBACKはp_transaction内で行っているので不要
			--BEGIN TRANSACTION 
			-- SPキック
print @P03 

			Exec @rc = P_transaction
			 @P01 = @P01
			,@P02 = @P02
			,@P03 = @P03
			,@SP  = '1'
			,@err_msg = @err_msg OUTPUT
			,@out_trn_id = @out_trn_id OUTPUT
			-- エラーチェック
			If @rc <> 0 Begin
				Set @a_edi_flag = '3'
				Set @a_edi_error_msg = '処理ＳＰエラー'
					+ ',m=[' + ISNULL(@err_msg,'') + ']'
					+ ',@P01=[' + ISNULL(@P01,'') + ']'
					+ ',@P02=[' + ISNULL(@P02,'') + ']'
					+ ',@P03=[' + ISNULL(@P03,'') + ']'
				--ROLLBACK TRANSACTION
				GOTO LOOP_END_ehc
			End
			-- 伝票単位でコミットする
			--COMMIT TRANSACTION 
			SET @pre_trn_id = @out_trn_id
			SET @e44_pre_den_no = @e44_den_no
			SET @e44_pre_shop_cd_webpos = @e44_shop_cd_webpos
		-----------------------------------------------
		-- ループ終了ラベル
		LOOP_END_ehc:
	      
		-- カウント初期レコードセット
		If Not Exists(SELECT top 1 *
			from #count_tbl
			where
			t_exec_id = substring(@edi_type,1,2)
			and
			t_tushin_id = @e44_tushin_id ) Begin
				INSERT INTO #count_tbl (
				t_exec_id
				,t_tushin_id
				,t_count_all
				,t_count_ok
				,t_count_wa
				,t_count_ng
				)
				SELECT
				t_exec_id = substring(@edi_type,1,2)
				,t_tushin_id = @e44_tushin_id
				,t_count_all = 0
				,t_count_ok = 0
				,t_count_wa = 0
				,t_count_ng = 0
		End
		
		UPDATE wbe_edibook_dw_ehc
		  SET
			   e44_edi_flag = @a_edi_flag,
			   e44_edi_error_msg = @a_edi_error_msg,
			   e44_edi_update_date = getdate()
		  WHERE 
				e44_edi_id = @e44_edi_id

		-- 処理カウント更新
		UPDATE #count_tbl SET
			t_count_all = t_count_all + 1
			,t_count_ok = -- 正常
				Case
				when @a_edi_flag = '1' then t_count_ok + 1
				else t_count_ok
				End
			,t_count_wa = -- 警告
				Case
				when @a_edi_flag = '2' then t_count_wa + 1
				else t_count_wa
				End
			,t_count_ng = -- エラー
				Case
				when @a_edi_flag = '3' then t_count_ng + 1
				else t_count_ng
				End
		where
			t_exec_id = substring(@edi_type,1,2)
			and
			t_tushin_id = @e44_tushin_id

		-- 次へ
		fetch next from @rs into
		 @e44_edi_id
		,@e44_tushin_id
		,@e44_sakusei_date
		,@e44_den_date 
		,@e44_den_no 
		,@e44_den_gno 
		,@e44_bikou 
		,@e44_location_cd 
		,@e44_hachu_date 
		,@e44_ecl_hinban 
		,@e44_jan_cd 
		,@e44_ehc_kbn 
		,@e44_ehc_su 
		,@e44_shop_cd
		,@e44_shop_cd_webpos
  End  -- While

print 'エコール発注下り開始 終わり'

  -- カーソルを閉じる
  close @rs 
  -- 開放
  deallocate @rs

  ------------------------------
  -- データ同期
  ------------------------------
  Exec @rc = P_EDI_Book_DataCommit
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9192,発注データ同期エラー'
    GOTO SP_ERR
  End

  ------------------------------
  -- ログ出力
  ------------------------------
  Exec @rc = P_EDI_Book_WriteLog
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
    ,@exec_start_time = @a_exec_start_time
  -- エラーチェック
  If @rc <> 0 or @@ERROR <> 0 Begin
    Set @err_msg = '9193,発注データログ出力エラー'
    GOTO SP_ERR
  End

  -- カウントを返す
  SELECT
     sum(t_count_all) as count_all
    ,sum(t_count_ok) as count_ok
    ,sum(t_count_wa) as count_wa
    ,sum(t_count_ng) as count_ng
     from
    #count_tbl

  --終了
  GOTO SP_OK

DOWN_ORDER_DATA_END:

--=================================================
-- MS#211: BQ発注下り（有隣堂）				-- 追加：2017/03/30
--=================================================
DOWN_BIG_QUERY:
  ------------------------------
  -- WEBPOS店舗コードセット
  ------------------------------
  Exec @rc = P_EDI_Book_SetShop
	 @edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
  -- エラーチェック
  If @rc <> 0 Begin
    --Set @err_msg = '9194,メーカーマスタ情報セット不正'	--修正：2019/10/10 - コア - 誤りコメント
    Set @err_msg = '9194,発注情報セット不正'				--修正：2019/10/10 - コア - 誤りコメント
    GOTO SP_ERR
  End
  ------------------------------
  -- データ取得
  ------------------------------
  Set @a_sql = ''
	+ '  INSERT wbe_edibook_dw_hcu ('
	+ '	 e46_edi_flag'
	+ '	,e46_edi_id'
	+ '	,e46_edi_create_date'
	+ '	,e46_edi_update_date'
	+ '	,e46_edi_file_line_no'
	+ '	,e46_edi_meisai_no'
	+ '	,e46_edi_error_msg'
	+ '	,e46_server_webpos'
	+ '	,e46_dbname_webpos'
	+ '	,e46_shop_cd_webpos'
	+ '	,e46_shop_name_webpos'
	+ '	,e46_shop_cd_primary'
	+ '	,e46_shop_cd'
	+ '	,e46_tushin_id'
	+ '	,e46_trn_id'
	+ '	,e46_create_date'
	+ '	,e46_work_type'
	+ '	,e46_denpyo_type'
	+ '	,e46_trn_date'
	+ '	,e46_pos_date'
	+ '	,e46_receipt_no'
	+ '	,e46_pos_no'
	+ '	,e46_shop_cd_bq'
	+ '	,e46_shop_name'
	+ '	,e46_sousa_shop_cd'
	+ '	,e46_sousa_shop_name'
	+ '	,e46_member_id'
	+ '	,e46_member_cd'
	+ '	,e46_member_shop_cd'
	+ '	,e46_member_name'
	+ '	,e46_member_card_cd'
	+ '	,e46_staff_id'
	+ '	,e46_staff_cd'
	+ '	,e46_staff_name'
	+ '	,e46_app_version'
	+ '	,e46_interface_version'
	+ '	,e46_exec_time'
	+ '	,e46_trn_type'
	+ '	,e46_line_no'
	+ '	,e46_hachu_type'
	+ '	,e46_hachu_no'
	+ '	,e46_goods_id'
	+ '	,e46_goods_type'
	+ '	,e46_koyu_goods_id'
	+ '	,e46_jan_cd'
	+ '	,e46_goods_name'
	+ '	,e46_tax_type'
	+ '	,e46_supplier_id'
	+ '	,e46_supplier_cd'
	+ '	,e46_price_default'
	+ '	,e46_cost_price_default'
	+ '	,e46_price'
	+ '	,e46_cost_price'
	+ '	,e46_goods_count'
	+ '	,e46_goods_yoyaku_count'
	+ '	,e46_member_order_memo'
	+ '	,e46_book_kanri_cd'
	+ '	,e46_tana_cd'
	+ '	,e46_tel_type'
	+ '	,e46_back_type'
	+ '	,e46_bansen'
	+ '	,e46_shoten_cd'
	+ '	,e46_bumon_cd'
	+ '      )'
	+ '      SELECT'
	+ '	 M.e46_edi_flag'
	+ '	,M.e46_edi_id'
	+ '	,M.e46_edi_create_date'
	+ '	,M.e46_edi_update_date'
	+ '	,M.e46_edi_file_line_no'
	+ '	,M.e46_edi_meisai_no'
	+ '	,M.e46_edi_error_msg'
	+ '	,M.e46_server_webpos'
	+ '	,M.e46_dbname_webpos'
	+ '	,M.e46_shop_cd_webpos'
	+ '	,M.e46_shop_name_webpos'
	+ '	,M.e46_shop_cd_primary'
	+ '	,M.e46_shop_cd'
	+ '	,M.e46_tushin_id'
	+ '	,M.e46_trn_id'
	+ '	,M.e46_create_date'
	+ '	,M.e46_work_type'
	+ '	,M.e46_denpyo_type'
	+ '	,M.e46_trn_date'
	+ '	,M.e46_pos_date'
	+ '	,M.e46_receipt_no'
	+ '	,M.e46_pos_no'
	+ '	,M.e46_shop_cd_bq'
	+ '	,M.e46_shop_name'
	+ '	,M.e46_sousa_shop_cd'
	+ '	,M.e46_sousa_shop_name'
	+ '	,M.e46_member_id'
	+ '	,M.e46_member_cd'
	+ '	,M.e46_member_shop_cd'
	+ '	,M.e46_member_name'
	+ '	,M.e46_member_card_cd'
	+ '	,M.e46_staff_id'
	+ '	,M.e46_staff_cd'
	+ '	,M.e46_staff_name'
	+ '	,M.e46_app_version'
	+ '	,M.e46_interface_version'
	+ '	,M.e46_exec_time'
	+ '	,M.e46_trn_type'
	+ '	,M.e46_line_no'
	+ '	,M.e46_hachu_type'
	+ '	,M.e46_hachu_no'
	+ '	,M.e46_goods_id'
	+ '	,M.e46_goods_type'
	+ '	,M.e46_koyu_goods_id'
	+ '	,M.e46_jan_cd'
	+ '	,M.e46_goods_name'
	+ '	,M.e46_tax_type'
	+ '	,M.e46_supplier_id'
	+ '	,M.e46_supplier_cd'
	+ '	,M.e46_price_default'
	+ '	,M.e46_cost_price_default'
	+ '	,M.e46_price'
	+ '	,M.e46_cost_price'
	+ '	,M.e46_goods_count'
	+ '	,M.e46_goods_yoyaku_count'
	+ '	,M.e46_member_order_memo'
	+ '	,M.e46_book_kanri_cd'
	+ '	,M.e46_tana_cd'
	+ '	,M.e46_tel_type'
	+ '	,M.e46_back_type'
	+ '	,M.e46_bansen'
	+ '	,M.e46_shoten_cd'
	+ '	,M.e46_bumon_cd'
	+ '            from'
	+ '              ' + @edi_server_name + '.' + @edi_db_name + '.dbo.wpt_edibook_dw_hcu as M'
	+ '              left outer join'
	+ '              wbe_edibook_dw_hcu as C'
	+ '                on M.e46_edi_id = C.e46_edi_id'
	+ '            where'
	+ '              C.e46_edi_id is null'  -- コピーしてないもののみ
	+ '              and'
	+ '              M.e46_edi_flag = ''0'''  -- 未処理
	+ '				 and'
	+ '				 M.e46_server_webpos = ''' + @server_name + ''''
	+ '				 and'
	+ '				 M.e46_dbname_webpos = ''' + @db_name + ''''
	+ '            order by '
	+ '              M.e46_edi_id'  -- ID順に取り込む
  Exec (@a_sql)
  -- エラーチェック
  If @@ERROR <> 0 Begin
    Set @err_msg = '9195,発注データ取得エラー'
    GOTO SP_ERR
  End
  ------------------------------
  -- データ読み込み
  ------------------------------
    DECLARE @e46_edi_id bigint
    DECLARE @e46_work_type char(4)
    DECLARE @e46_denpyo_type char(1)
    DECLARE @e46_trn_date datetime
    DECLARE @e46_receipt_no int
    DECLARE @e46_pos_no int
    DECLARE @e46_member_id int
    DECLARE @e46_trn_type char(1)
    DECLARE @e46_line_no int
    DECLARE @e46_hachu_type char(1)
    DECLARE @e46_hachu_no varchar(10)
    DECLARE @e46_goods_id int
    DECLARE @e46_koyu_goods_id varchar(20)
    DECLARE @e46_jan_cd varchar(20)
    DECLARE @e46_goods_name varchar(100)
    DECLARE @e46_tax_type char(1)
    DECLARE @e46_supplier_id int
    DECLARE @e46_supplier_cd varchar(10)
    DECLARE @e46_price_default money
    DECLARE @e46_cost_price_default money
    DECLARE @e46_price money
    DECLARE @e46_cost_price money
    DECLARE @e46_goods_count int
    DECLARE @e46_goods_yoyaku_count int
    DECLARE @e46_member_order_memo varchar(100)
    DECLARE @e46_book_kanri_cd varchar(30)
    DECLARE @e46_tana_cd varchar(10)
    DECLARE @e46_tel_type char(1)
    DECLARE @e46_back_type char(1)
    DECLARE @e46_shop_cd_primary varchar(10)				--ADD 20170330 MS#211 Comment 13
    DECLARE @out_goods_id int
    DECLARE @a_detail_count int
    DECLARE @a_supplier_cd_before varchar(10)        	    -- SP実行判定項目 
    DECLARE @a_shop_cd_before varchar(100)        	        -- SP実行判定項目
    DECLARE @e46_pos_date datetime
    DECLARE @e46_tushin_id char(2)
    DECLARE @e46_shop_cd_webpos varchar(10)					--ADD 20170330 MS#211 Comment 18
    DECLARE @e46_shop_name_webpos varchar(100)				--ADD 20170330 MS#211 Comment 18
    DECLARE @e46_app_version varchar(50)
    DECLARE @e46_interface_version varchar(20)
    DECLARE @e46_bumon_cd char(10)
    SET @rs = cursor static for
    SELECT
    e46_edi_id
    ,e46_jan_cd
    ,e46_goods_name
    ,e46_price
    ,e46_tax_type
    ,e46_supplier_id
    ,e46_supplier_cd
    ,e46_line_no
    ,e46_hachu_type
    ,e46_goods_id
    ,e46_goods_count
    ,e46_tana_cd
    ,e46_koyu_goods_id
    ,e46_price_default
    ,e46_cost_price_default
    ,e46_goods_yoyaku_count
    ,e46_cost_price
    ,e46_member_order_memo
    ,e46_book_kanri_cd
    ,e46_tel_type
    ,e46_back_type
    ,e46_hachu_no
    ,e46_tax_type
    ,e46_work_type
    ,e46_denpyo_type
    ,e46_pos_no
    ,e46_trn_date
    ,e46_receipt_no
    ,e46_member_id
    ,e46_trn_type
    ,e46_pos_date
    ,e46_shop_cd_primary	--ADD 20170330 MS#211 Comment 13 
    ,e46_tushin_id
    ,e46_shop_cd_webpos
    ,e46_shop_name_webpos
    ,e46_interface_version
    ,e46_app_version
    ,e46_bumon_cd
    FROM
	   wbe_edibook_dw_hcu
    WHERE e46_edi_flag = '0'
    ORDER BY
	   e46_tushin_id	   			--追加：2017/08/22 - Start
	   ,e46_shop_cd_webpos			--追加：2017/08/22 - End
	   ,e46_edi_id

    -- 初期設定
    Set @out_goods_id         = 0
    Set @a_detail_count       = 0
    Set @a_goods_type         = '00'			  -- 書籍対応
    Set @P01                  = ''
    Set @P02                  = ''
    Set @P03                  = ''
    open @rs
    Set @a_line_no            = 0		--追加：2017/08/22

    fetch next from @rs into
    @e46_edi_id
    ,@e46_jan_cd
    ,@e46_goods_name
    ,@e46_price
    ,@e46_tax_type
    ,@e46_supplier_id
    ,@e46_supplier_cd
    ,@e46_line_no
    ,@e46_hachu_type
    ,@e46_goods_id
    ,@e46_goods_count
    ,@e46_tana_cd
    ,@e46_koyu_goods_id
    ,@e46_price_default
    ,@e46_cost_price_default
    ,@e46_goods_yoyaku_count
    ,@e46_cost_price
    ,@e46_member_order_memo
    ,@e46_book_kanri_cd
    ,@e46_tel_type
    ,@e46_back_type
    ,@e46_hachu_no
    ,@e46_tax_type
    ,@e46_work_type
    ,@e46_denpyo_type
    ,@e46_pos_no
    ,@e46_trn_date
    ,@e46_receipt_no
    ,@e46_member_id
    ,@e46_trn_type	
    ,@e46_pos_date
    ,@e46_shop_cd_primary	--ADD 20170330 MS#211 Comment 13 
    ,@e46_tushin_id
    ,@e46_shop_cd_webpos
    ,@e46_shop_name_webpos
    ,@e46_interface_version
    ,@e46_app_version
    ,@e46_bumon_cd

    WHILE @@FETCH_STATUS = 0 BEGIN
	   --初期
	   Set @a_edi_error_msg = NULL
	   Set @a_edi_flag = '1'	
	   Set @a_supplier_cd = ''
	   -- ADD 20170330 MS#211 Comment 13 START
	   IF (Isnull(@e46_shop_cd_webpos, '') = '')
	   begin
			 Set @a_edi_flag = '3'	
			 Set @a_edi_error_msg = '店舗コード不明'
			 GOTO LOOP_HACHU_END
	   End 
	   ELSE IF (ISNULL(@a_shop_cd_before,'') = '')
	   begin
			 Set @a_shop_cd_before = @e46_shop_cd_webpos
	   End
	   -- ADD 20170330 MS#211 Comment 13 END
	
	   Set @out_goods_id = (SELECT TOP 1 gds_goods_id
					   FROM wpt_goods_master
					   WHERE gds_jan_cd = @e46_jan_cd AND
					   gds_delete_flag = '0')
	   IF (isnull(@out_goods_id,0) = 0) begin
		  EXEC @rc = P_Goods_Create
					   @goods_type  = @a_goods_type
					   ,@plu_cd     = @e46_jan_cd
					   ,@plu_type   = '0'
					   ,@goods_name = @e46_goods_name
					   ,@tax_type   = @e46_tax_type
					   ,@price      = @e46_price
					   ,@price_type = 0
					   ,@goods_id   = @out_goods_id OUTPUT
		  End				
		  --------------------------------
		  -- 発注先の決定
		  --------------------------------
		  -- ADD 20170330 MS#211 Comment 25 START
		  --▼▼ 削除 ：2017/08/22 - Start
		  --IF @e46_supplier_cd is null begin
		  --	Set @a_edi_flag = '3'	
		  --	Set @a_edi_error_msg = '発注先不明'
		  --	Set @P03 = ''
		  --	Exec P_LogMsg @log_msg
		  --	GOTO LOOP_HACHU_END
		  --end
		  --▲▲ 削除 ：2017/08/22 - End
		  SELECT TOP 1 @a_supplier_id = mpm_supplier_id
				    ,@a_supplier_cd = mpm_supplier_cd
		  FROM wpt_maker_supplier_master
		  --WHERE mpm_bookedi_cd      = @e46_supplier_cd	    --▼▼ 修正 ：2017/08/22 - Start
		  WHERE mpm_bookedi_cd        = @e46_tushin_id	    --▲▲ 修正 ：2017/08/22 - End
		  --▼▼ 追加 ：2017/08/22 - Start
		  IF ISNULL(@a_supplier_cd, '') = ''
		  BEGIN
			 SET @a_edi_flag = '3';
			 SET @a_edi_error_msg = '発注先不明';
			 EXEC P_LogMsg
				    @log_msg;
			 GOTO LOOP_HACHU_END;
		  END
		  --▲▲ 追加 ：2017/08/22 - End
		  --------------------------------
		  
		  -- 発注先が変わったら、LINE番号を1に変更
		  --EDIT 20170330 MS#211 Comment 13 START		
		  --If   ( @a_supplier_cd_before <> @e46_supplier_cd ) 
		  IF(@a_supplier_cd_before <> @a_supplier_cd) 			-- EDIT 20170330 MS#211 Comment 25
		    OR (@a_shop_cd_before <> @e46_shop_cd_webpos)
		  BEGIN
				SET @a_trn_id_add = NULL;
				SET @a_line_no = 0;
		  END;
		  Set @a_shop_cd_before 		= @e46_shop_cd_webpos						--　追加：2017/12/01
		  --EDIT 20170330 MS#211 Comment 13 END
		--------------------------------
		-- 発注トランザクション書き込み
		--------------------------------
		  -- カウント
		  Set @a_line_no = @a_line_no + 1				    -- 追加 ：2017/08/22
		  -- SP用  @P01：パラメータ作成
		  Set @P01 = ''
		  + '0002.0001'                                       -- パラメタ受け渡しバージョン
		  + ',' + object_name(@@PROCID)                       -- アプリケーションバージョン
		  + ',' + @a_shop_cd_before          			    -- 店舗コード
		  + ',' + isnull(cast(@e46_work_type as varchar),'')  -- 業務区分
		  + ',' + isnull(cast(@e46_denpyo_type as varchar),'')-- 伝票区分
		  + ',' + cast(isnull(@e46_pos_no,0) as varchar) 	    -- POS番号
		  + ',' + convert(varchar,@e46_trn_date,120)          -- 取引日
		  + ',' + convert(varchar,@e46_pos_date,120)          -- POS取引日時
		  + ',' + cast(isnull(@e46_receipt_no,0) as varchar)  -- レシート番号
		  + ','                                               -- 担当ＩＤ
		  + ','                                               -- 担当コード
		  + ',' + cast(isnull(@e46_member_id,0) as varchar)   -- 会員ＩＤ
		  + ','                                               -- 会員コード
		  + ','                                               -- 会員カードコード
		  + ',' + @a_shop_cd_before					    -- 操作店舗コード
		  + ','                                               -- 紐付け元取引ＩＤ
		  + ','                                               -- 紐付け元業務区分
		  + ',' + isnull(cast(@a_trn_id_add as varchar),'')   -- 追加処理用取引ＩＤ
		  + ',0'                                              -- 再登録フラグ
		  -- SP用  @P02：パラメータ作成
		  Set @P02 = ''
		  + isnull(cast(@e46_trn_type as varchar),'0')         -- 取引区分（1：自動発注）
		  -- SP用　@P03：パラメータ作成

		  Set @P03 = ''
		  --▼▼ 修正 ：2017/08/22 - Start
		  --+ cast(isnull(@e46_line_no,1) as varchar)                     -- 明細番号
		  + cast(@a_line_no as varchar)        					 		-- 明細番号
		  --▲▲ 修正 ：2017/08/22 - End
		  + ',' + isnull(cast(@e46_hachu_type as varchar),'')             -- 発注区分
		  + ',' + isnull(cast(@out_goods_id as varchar),'')               -- 商品ID
		  + ',' + isnull(@e46_koyu_goods_id,'')                           -- 固有商品コード 
		  + ',' + isnull(@e46_jan_cd,'')                                  -- JAN
		  + ',' + isnull(@e46_goods_name,'')                              -- 商品名
		  + ',' + isnull(cast(@e46_tax_type as varchar),'')               -- 税区分
		  --			+ ',' + isnull(cast(@e46_supplier_id as varchar),'')            -- 仕入先ID
		  --			+ ',' + isnull(cast(@e46_supplier_cd as varchar),'')            -- 仕入先コード
		  + ',' + isnull(cast(@a_supplier_id as varchar),'')            	-- 仕入先ID			-- EDIT 20170330 MS#211 Comment 25
		  + ',' + isnull(cast(@a_supplier_cd as varchar),'')            	-- 仕入先コード		-- EDIT 20170330 MS#211 Comment 25
		  + ',' + cast(isnull(@e46_price_default,0) as varchar)     	    -- 標準売価
		  + ',' + cast(isnull(@e46_cost_price_default,0) as varchar)      -- 標準原価
		  + ',' + cast(isnull(@e46_price,0) as varchar)                   -- 売価
		  + ',' + cast(isnull(@e46_cost_price,0) as varchar)		        -- 原価
		  + ',' + cast(isnull(@e46_goods_count,0) as varchar) 			-- 発注数
		  + ',' + cast(isnull(@e46_goods_yoyaku_count,0) as varchar)      -- 予約数
		  + ',' + isnull(@e46_member_order_memo,'')                       -- 客注メモ
		  + ',' + isnull(@e46_book_kanri_cd,'')                           -- 書籍取次常備コード
		  --修正：MS387 - 2017/12/12 - 部門コードを棚コードに変換する - Start
		  --			+ ',' + isnull(cast(@e46_tana_cd as varchar),'')     -- 2017/07/12 棚コード（ロケーション導入後組み込み）
		  --+ ',' + isnull(cast(@e46_bumon_cd as varchar),'')               -- 2017/07/12 暫定処理 棚コードに部門をセット
		  + ',' + isnull(cast(@e46_tana_cd as varchar),'')			   -- 2017/12/12 棚コード（ロケーション導入後組み込み）
		  --修正：MS387 - 2017/12/12 - 部門コードを棚コードに変換する - End 
		  + ',' + isnull(cast(@e46_tel_type as varchar),'')               -- 電話発注区分
		  + ',' + isnull(cast(@e46_back_type as varchar),'')              -- バック区分
		  + ',' + isnull(cast(@e46_hachu_no as varchar),'')               -- 発注番号
			-- ログ（実行内容）
			Set @log_msg = '  →【発注SP_Break】'
				+ ' Exec P_Transaction '
				+ ' @P01=[' + isnull(@P01,'') + ']'
				+ ',@P02=[' + isnull(@P02,'') + ']'
				+ ',@P03=[' + isnull(@P03,'') + ']'
			Exec P_LogMsg @log_msg
			-- 発注トランザクション実行
		    --▼▼変更：2017/08/22 - Start
			BEGIN TRY
			    BEGIN TRANSACTION;
			    Exec @rc = P_Transaction
					@P01 = @P01
				    ,@P02 = @P02
				    ,@P03 = @P03
				    ,@SP  = '1'
				    ,@err_msg = @err_msg OUTPUT
				    ,@out_trn_id = @a_trn_id_add OUTPUT
				COMMIT TRANSACTION;
		    END TRY  
		    BEGIN CATCH
				ROLLBACK TRANSACTION;
				    Set @a_edi_flag = '3'
				    Set @a_edi_error_msg = ERROR_MESSAGE()
				    -- ログ（エラー内容）
				Set @log_msg = '  →【発注SP Error】'
					+ ' Exec P_Transaction '
					+ ' @P01=[' + isnull(@P01,'') + ']'
					+ ',@P02=[' + isnull(@P02,'') + ']'
					+ ',@P03=[' + isnull(@P03,'') + ']'
					+ ',@a_edi_error_msg=[' + isnull(@a_edi_error_msg,'') + ']'
				Exec P_LogMsg @log_msg
				--GOTO SP_ERR
				GOTO LOOP_HACHU_END
		    END CATCH;
		    --▲▲変更：2017/08/22 - End
			-- エラーチェック
			If @rc <> 0 Begin
				-- ログ（エラー内容）
				Set @log_msg = '  →【発注SP Error】'
					+ ' Exec P_Transaction '
					+ ' @P01=[' + isnull(@P01,'') + ']'
					+ ',@P02=[' + isnull(@P02,'') + ']'
					+ ',@P03=[' + isnull(@P03,'') + ']'
				--▼▼追加：2017/08/22 - Start
				    Set @a_edi_flag = '3'
				    Set @a_edi_error_msg = @err_msg
				--▲▲追加：2017/08/22 - End
				Exec P_LogMsg @log_msg
				--GOTO SP_ERR			   --▼▼修正：2017/08/22 - Start
				GOTO LOOP_HACHU_END		   --▲▲修正：2017/08/22 - End
			End

			-- 明細件数を1に変更
			--Set @a_detail_count = 1		削除 ：2017/08/22

		-- 発注先が変わったら、追加元取引IDをクリア
		--▼▼ 削除 ：2017/08/22 - Start
		--If ( @a_supplier_cd_before <> @e46_supplier_cd )  Begin
		  --IF(@a_supplier_cd_before <> @a_supplier_cd)  					-- EDIT 20170330 MS#211 Comment 25
			 --BEGIN
				--SET @a_trn_id_add = NULL;
		  --END
		--▲▲ 削除 ：2017/08/22 - End

		LOOP_HACHU_END:                             							-- 商品ループ処理終了
		  -- 前回発注先をセーブ
		  --Set @a_supplier_cd_before   = @e46_supplier_cd
		  Set @a_supplier_cd_before 	= @a_supplier_cd							-- EDIT 20170330 MS#211 Comment 25
		  --Set @a_shop_cd_before 		= @e46_shop_cd_webpos						--　追加：2017/08/22  削除：2017/12/01
		  -- カウント初期レコードセット
		  IF NOT EXISTS
		  (
			 SELECT TOP 1 *
			 FROM #count_tbl
			 WHERE t_exec_id = SUBSTRING(@edi_type, 1, 2)
				    AND t_tushin_id = @e46_tushin_id
		  )
		  BEGIN
			 INSERT INTO #count_tbl
			 (t_exec_id,
				t_tushin_id,
				t_count_all,
				t_count_ok,
				t_count_wa,
				t_count_ng
			 )
			 SELECT t_exec_id = SUBSTRING(@edi_type, 1, 2),
				    t_tushin_id = @e46_tushin_id,
				    t_count_all = 0,
				    t_count_ok = 0,
				    t_count_wa = 0,
				    t_count_ng = 0;
		  END
		  UPDATE wbe_edibook_dw_hcu
		  SET
				e46_edi_flag = @a_edi_flag,
				e46_edi_update_date = getdate(),
				e46_edi_error_msg = @a_edi_error_msg
		  WHERE 
				e46_edi_id = @e46_edi_id
		  -- 処理カウント更新
		  UPDATE #count_tbl SET
			 t_count_all = t_count_all + 1
			 ,t_count_ok = -- 正常
				Case
				when @a_edi_flag = '1' then t_count_ok + 1
				else t_count_ok
				End
			 ,t_count_wa = -- 警告
				Case
				when @a_edi_flag = '2' then t_count_wa + 1
				else t_count_wa
				End
			 ,t_count_ng = -- エラー
				Case
				when @a_edi_flag = '3' then t_count_ng + 1
				else t_count_ng
				End
		  WHERE
			 t_exec_id = substring(@edi_type,1,2)
			 and
			 t_tushin_id = @e46_tushin_id

		-- [発注ワークデータ]次の商品へ
		FETCH NEXT FROM @rs INTO
						@e46_edi_id
						,@e46_jan_cd
						,@e46_goods_name
						,@e46_price
						,@e46_tax_type
						,@e46_supplier_id
						,@e46_supplier_cd
						,@e46_line_no
						,@e46_hachu_type
						,@e46_goods_id
						,@e46_goods_count
						,@e46_tana_cd
						,@e46_koyu_goods_id
						,@e46_price_default
						,@e46_cost_price_default
						,@e46_goods_yoyaku_count
						,@e46_cost_price
						,@e46_member_order_memo
						,@e46_book_kanri_cd
						,@e46_tel_type
						,@e46_back_type
						,@e46_hachu_no
						,@e46_tax_type
						,@e46_work_type
						,@e46_denpyo_type
						,@e46_pos_no
						,@e46_trn_date
						,@e46_receipt_no
						,@e46_member_id
						,@e46_trn_type	
						,@e46_pos_date
						,@e46_shop_cd_primary	--ADD 20170330 MS#211 Comment 13 
						,@e46_tushin_id
						,@e46_shop_cd_webpos
						,@e46_shop_name_webpos
						,@e46_interface_version
						,@e46_app_version
						,@e46_bumon_cd
	End -- [発注ワークデータ] While 

	-- [発注ワークデータ]カーソルを閉じる
	Close @rs
	-- [発注ワークデータ]開放
	Deallocate @rs
	--▼▼ 削除 ：2017/08/22 - Start
	--if @P03 <> '' begin
	--	-- SP用  @P01：パラメータ作成
	--		Set @P01 = ''
 --               + '0002.0001'                                       -- パラメタ受け渡しバージョン
 --               + ',' + object_name(@@PROCID)                       -- アプリケーションバージョン
	--			+ ',' + @a_shop_cd_before	          				-- 店舗コード
	--			+ ',' + isnull(cast(@e46_work_type as varchar),'')  -- 業務区分
	--			+ ',' + isnull(cast(@e46_denpyo_type as varchar),'')-- 伝票区分
	--			+ ',' + cast(isnull(@e46_pos_no,0) as varchar) 		-- POS番号
	--			+ ',' + convert(varchar,@e46_trn_date,120)          -- 取引日
	--			+ ',' + convert(varchar,@e46_pos_date,120)          -- POS取引日時
	--			+ ',' + cast(isnull(@e46_receipt_no,0) as varchar)  -- レシート番号
	--			+ ','                                               -- 担当ＩＤ
	--			+ ','                                               -- 担当コード
	--			+ ',' + cast(isnull(@e46_member_id,0) as varchar)   -- 会員ＩＤ
	--			+ ','                                               -- 会員コード
	--			+ ','                                               -- 会員カードコード
	--			+ ',' + @a_shop_cd_before					  -- 操作店舗コード
	--			+ ','                                               -- 紐付け元取引ＩＤ
	--			+ ','                                               -- 紐付け元業務区分
	--			+ ',' + isnull(cast(@a_trn_id_add as varchar),'')   -- 追加処理用取引ＩＤ
	--			+ ',0'                                              -- 再登録フラグ
	--		-- SP用  @P02：パラメータ作成
	--		Set @P02 = ''
	--			+ isnull(cast(@e46_trn_type as varchar),'0')         -- 取引区分（1：自動発注）
	--		-- ログ（実行内容）
	--		Set @log_msg = '  →【発注SP_Break】'
	--			+ ' Exec P_Transaction '
	--			+ ' @P01=[' + isnull(@P01,'') + ']'
	--			+ ',@P02=[' + isnull(@P02,'') + ']'
	--			+ ',@P03=[' + isnull(@P03,'') + ']'
	--		Exec P_LogMsg @log_msg
	--		-- 発注トランザクション実行
	--		Exec @rc = P_Transaction
	--			 @P01 = @P01
	--			,@P02 = @P02
	--			,@P03 = @P03
	--			,@SP  = '1'
	--			,@err_msg = @err_msg OUTPUT
	--			,@out_trn_id = @a_trn_id_add OUTPUT
	--		-- エラーチェック
	--		If @rc <> 0 Begin
	--			-- ログ（エラー内容）
	--			Set @log_msg = '  →【発注SP Error】'
	--				+ ' Exec P_Transaction '
	--				+ ' @P01=[' + isnull(@P01,'') + ']'
	--				+ ',@P02=[' + isnull(@P02,'') + ']'
	--				+ ',@P03=[' + isnull(@P03,'') + ']'
	--			Exec P_LogMsg @log_msg
	--			--GOTO SP_ERR
	--		End
	--END
     --▲▲ 削除 ：2017/08/22 - End

	------------------------------
	-- データ同期
	------------------------------
	Exec @rc = P_EDI_Book_DataCommit
	 @edi_type        = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name     = @edi_db_name
	,@server_name     = @server_name
	,@db_name         = @db_name
  -- エラーチェック
    If @rc <> 0 or @@ERROR <> 0 Begin
	   --Set @err_msg = '9196,メーカーマスタデータ同期エラー'	--修正：2019/10/10 - コア - 誤りコメント
	   Set @err_msg = '9196,発注データ同期エラー'				--修正：2019/10/10 - コア - 誤りコメント
	   GOTO SP_ERR
    End

	------------------------------
	-- ログ出力
	------------------------------
	Exec @rc = P_EDI_Book_WriteLog
		@edi_type  = @edi_type
	,@edi_server_name = @edi_server_name
	,@edi_db_name = @edi_db_name
	,@server_name = @server_name
	,@db_name  = @db_name
	,@exec_start_time = @a_exec_start_time
	-- エラーチェック
	If @rc <> 0 or @@ERROR <> 0 Begin
	Set @err_msg = '9197,発注ログ出力エラー'
	GOTO SP_ERR
	End

	-- カウントを返す
	SELECT
	 sum(t_count_all) as count_all
	,sum(t_count_ok) as count_ok
	,sum(t_count_wa) as count_wa
	,sum(t_count_ng) as count_ng
	 from
	#count_tbl

	GOTO SP_OK
DOWN_BIG_QUERY_END:

--=================================================
-- 正常終了
--=================================================
SP_OK:

  -- ログ
  Set @log_msg =
        'EDIクライアント処理END'

  Exec P_LogMsg @log_msg

  --終了
  Return 0


--=================================================
-- 異常終了
--=================================================

SP_ERR:

  -- エラーメッセージがセットされていたら、
  -- そのメッセージでエラーを発生させる
  If not @err_msg is null Begin
    raiserror(@err_msg,16,1)
  End

  --終了
  Return 1

--=================================================
-- SP終了
--=================================================


